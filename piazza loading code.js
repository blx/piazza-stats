/*! jQuery v1.7.1 jquery.com | jquery.org/license */
(function(a,b){function cy(a){return f.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}function cv(a){if(!ck[a]){var b=c.body,d=f("<"+a+">").appendTo(b),e=d.css("display");d.remove();if(e==="none"||e===""){cl||(cl=c.createElement("iframe"),cl.frameBorder=cl.width=cl.height=0),b.appendChild(cl);if(!cm||!cl.createElement)cm=(cl.contentWindow||cl.contentDocument).document,cm.write((c.compatMode==="CSS1Compat"?"<!doctype html>":"")+"<html><body>"),cm.close();d=cm.createElement(a),cm.body.appendChild(d),e=f.css(d,"display"),b.removeChild(cl)}ck[a]=e}return ck[a]}function cu(a,b){var c={};f.each(cq.concat.apply([],cq.slice(0,b)),function(){c[this]=a});return c}function ct(){cr=b}function cs(){setTimeout(ct,0);return cr=f.now()}function cj(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function ci(){try{return new a.XMLHttpRequest}catch(b){}}function cc(a,c){a.dataFilter&&(c=a.dataFilter(c,a.dataType));var d=a.dataTypes,e={},g,h,i=d.length,j,k=d[0],l,m,n,o,p;for(g=1;g<i;g++){if(g===1)for(h in a.converters)typeof h=="string"&&(e[h.toLowerCase()]=a.converters[h]);l=k,k=d[g];if(k==="*")k=l;else if(l!=="*"&&l!==k){m=l+" "+k,n=e[m]||e["* "+k];if(!n){p=b;for(o in e){j=o.split(" ");if(j[0]===l||j[0]==="*"){p=e[j[1]+" "+k];if(p){o=e[o],o===!0?n=p:p===!0&&(n=o);break}}}}!n&&!p&&f.error("No conversion from "+m.replace(" "," to ")),n!==!0&&(c=n?n(c):p(o(c)))}}return c}function cb(a,c,d){var e=a.contents,f=a.dataTypes,g=a.responseFields,h,i,j,k;for(i in g)i in d&&(c[g[i]]=d[i]);while(f[0]==="*")f.shift(),h===b&&(h=a.mimeType||c.getResponseHeader("content-type"));if(h)for(i in e)if(e[i]&&e[i].test(h)){f.unshift(i);break}if(f[0]in d)j=f[0];else{for(i in d){if(!f[0]||a.converters[i+" "+f[0]]){j=i;break}k||(k=i)}j=j||k}if(j){j!==f[0]&&f.unshift(j);return d[j]}}function ca(a,b,c,d){if(f.isArray(b))f.each(b,function(b,e){c||bE.test(a)?d(a,e):ca(a+"["+(typeof e=="object"||f.isArray(e)?b:"")+"]",e,c,d)});else if(!c&&b!=null&&typeof b=="object")for(var e in b)ca(a+"["+e+"]",b[e],c,d);else d(a,b)}function b_(a,c){var d,e,g=f.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&((g[d]?a:e||(e={}))[d]=c[d]);e&&f.extend(!0,a,e)}function b$(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h=a[f],i=0,j=h?h.length:0,k=a===bT,l;for(;i<j&&(k||!l);i++)l=h[i](c,d,e),typeof l=="string"&&(!k||g[l]?l=b:(c.dataTypes.unshift(l),l=b$(a,c,d,e,l,g)));(k||!l)&&!g["*"]&&(l=b$(a,c,d,e,"*",g));return l}function bZ(a){return function(b,c){typeof b!="string"&&(c=b,b="*");if(f.isFunction(c)){var d=b.toLowerCase().split(bP),e=0,g=d.length,h,i,j;for(;e<g;e++)h=d[e],j=/^\+/.test(h),j&&(h=h.substr(1)||"*"),i=a[h]=a[h]||[],i[j?"unshift":"push"](c)}}}function bC(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=b==="width"?bx:by,g=0,h=e.length;if(d>0){if(c!=="border")for(;g<h;g++)c||(d-=parseFloat(f.css(a,"padding"+e[g]))||0),c==="margin"?d+=parseFloat(f.css(a,c+e[g]))||0:d-=parseFloat(f.css(a,"border"+e[g]+"Width"))||0;return d+"px"}d=bz(a,b,b);if(d<0||d==null)d=a.style[b]||0;d=parseFloat(d)||0;if(c)for(;g<h;g++)d+=parseFloat(f.css(a,"padding"+e[g]))||0,c!=="padding"&&(d+=parseFloat(f.css(a,"border"+e[g]+"Width"))||0),c==="margin"&&(d+=parseFloat(f.css(a,c+e[g]))||0);return d+"px"}function bp(a,b){b.src?f.ajax({url:b.src,async:!1,dataType:"script"}):f.globalEval((b.text||b.textContent||b.innerHTML||"").replace(bf,"/*$0*/")),b.parentNode&&b.parentNode.removeChild(b)}function bo(a){var b=c.createElement("div");bh.appendChild(b),b.innerHTML=a.outerHTML;return b.firstChild}function bn(a){var b=(a.nodeName||"").toLowerCase();b==="input"?bm(a):b!=="script"&&typeof a.getElementsByTagName!="undefined"&&f.grep(a.getElementsByTagName("input"),bm)}function bm(a){if(a.type==="checkbox"||a.type==="radio")a.defaultChecked=a.checked}function bl(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]}function bk(a,b){var c;if(b.nodeType===1){b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase();if(c==="object")b.outerHTML=a.outerHTML;else if(c!=="input"||a.type!=="checkbox"&&a.type!=="radio"){if(c==="option")b.selected=a.defaultSelected;else if(c==="input"||c==="textarea")b.defaultValue=a.defaultValue}else a.checked&&(b.defaultChecked=b.checked=a.checked),b.value!==a.value&&(b.value=a.value);b.removeAttribute(f.expando)}}function bj(a,b){if(b.nodeType===1&&!!f.hasData(a)){var c,d,e,g=f._data(a),h=f._data(b,g),i=g.events;if(i){delete h.handle,h.events={};for(c in i)for(d=0,e=i[c].length;d<e;d++)f.event.add(b,c+(i[c][d].namespace?".":"")+i[c][d].namespace,i[c][d],i[c][d].data)}h.data&&(h.data=f.extend({},h.data))}}function bi(a,b){return f.nodeName(a,"table")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function U(a){var b=V.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}function T(a,b,c){b=b||0;if(f.isFunction(b))return f.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return f.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=f.grep(a,function(a){return a.nodeType===1});if(O.test(b))return f.filter(b,d,!c);b=f.filter(b,d)}return f.grep(a,function(a,d){return f.inArray(a,b)>=0===c})}function S(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function K(){return!0}function J(){return!1}function n(a,b,c){var d=b+"defer",e=b+"queue",g=b+"mark",h=f._data(a,d);h&&(c==="queue"||!f._data(a,e))&&(c==="mark"||!f._data(a,g))&&setTimeout(function(){!f._data(a,e)&&!f._data(a,g)&&(f.removeData(a,d,!0),h.fire())},0)}function m(a){for(var b in a){if(b==="data"&&f.isEmptyObject(a[b]))continue;if(b!=="toJSON")return!1}return!0}function l(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(k,"-$1").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:f.isNumeric(d)?parseFloat(d):j.test(d)?f.parseJSON(d):d}catch(g){}f.data(a,c,d)}else d=b}return d}function h(a){var b=g[a]={},c,d;a=a.split(/\s+/);for(c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b}var c=a.document,d=a.navigator,e=a.location,f=function(){function J(){if(!e.isReady){try{c.documentElement.doScroll("left")}catch(a){setTimeout(J,1);return}e.ready()}}var e=function(a,b){return new e.fn.init(a,b,h)},f=a.jQuery,g=a.$,h,i=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,j=/\S/,k=/^\s+/,l=/\s+$/,m=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,n=/^[\],:{}\s]*$/,o=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,p=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,q=/(?:^|:|,)(?:\s*\[)+/g,r=/(webkit)[ \/]([\w.]+)/,s=/(opera)(?:.*version)?[ \/]([\w.]+)/,t=/(msie) ([\w.]+)/,u=/(mozilla)(?:.*? rv:([\w.]+))?/,v=/-([a-z]|[0-9])/ig,w=/^-ms-/,x=function(a,b){return(b+"").toUpperCase()},y=d.userAgent,z,A,B,C=Object.prototype.toString,D=Object.prototype.hasOwnProperty,E=Array.prototype.push,F=Array.prototype.slice,G=String.prototype.trim,H=Array.prototype.indexOf,I={};e.fn=e.prototype={constructor:e,init:function(a,d,f){var g,h,j,k;if(!a)return this;if(a.nodeType){this.context=this[0]=a,this.length=1;return this}if(a==="body"&&!d&&c.body){this.context=c,this[0]=c.body,this.selector=a,this.length=1;return this}if(typeof a=="string"){a.charAt(0)!=="<"||a.charAt(a.length-1)!==">"||a.length<3?g=i.exec(a):g=[null,a,null];if(g&&(g[1]||!d)){if(g[1]){d=d instanceof e?d[0]:d,k=d?d.ownerDocument||d:c,j=m.exec(a),j?e.isPlainObject(d)?(a=[c.createElement(j[1])],e.fn.attr.call(a,d,!0)):a=[k.createElement(j[1])]:(j=e.buildFragment([g[1]],[k]),a=(j.cacheable?e.clone(j.fragment):j.fragment).childNodes);return e.merge(this,a)}h=c.getElementById(g[2]);if(h&&h.parentNode){if(h.id!==g[2])return f.find(a);this.length=1,this[0]=h}this.context=c,this.selector=a;return this}return!d||d.jquery?(d||f).find(a):this.constructor(d).find(a)}if(e.isFunction(a))return f.ready(a);a.selector!==b&&(this.selector=a.selector,this.context=a.context);return e.makeArray(a,this)},selector:"",jquery:"1.7.1",length:0,size:function(){return this.length},toArray:function(){return F.call(this,0)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=this.constructor();e.isArray(a)?E.apply(d,a):e.merge(d,a),d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")");return d},each:function(a,b){return e.each(this,a,b)},ready:function(a){e.bindReady(),A.add(a);return this},eq:function(a){a=+a;return a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(F.apply(this,arguments),"slice",F.call(arguments).join(","))},map:function(a){return this.pushStack(e.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:E,sort:[].sort,splice:[].splice},e.fn.init.prototype=e.fn,e.extend=e.fn.extend=function(){var a,c,d,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;typeof i=="boolean"&&(l=i,i=arguments[1]||{},j=2),typeof i!="object"&&!e.isFunction(i)&&(i={}),k===j&&(i=this,--j);for(;j<k;j++)if((a=arguments[j])!=null)for(c in a){d=i[c],f=a[c];if(i===f)continue;l&&f&&(e.isPlainObject(f)||(g=e.isArray(f)))?(g?(g=!1,h=d&&e.isArray(d)?d:[]):h=d&&e.isPlainObject(d)?d:{},i[c]=e.extend(l,h,f)):f!==b&&(i[c]=f)}return i},e.extend({noConflict:function(b){a.$===e&&(a.$=g),b&&a.jQuery===e&&(a.jQuery=f);return e},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){if(a===!0&&!--e.readyWait||a!==!0&&!e.isReady){if(!c.body)return setTimeout(e.ready,1);e.isReady=!0;if(a!==!0&&--e.readyWait>0)return;A.fireWith(c,[e]),e.fn.trigger&&e(c).trigger("ready").off("ready")}},bindReady:function(){if(!A){A=e.Callbacks("once memory");if(c.readyState==="complete")return setTimeout(e.ready,1);if(c.addEventListener)c.addEventListener("DOMContentLoaded",B,!1),a.addEventListener("load",e.ready,!1);else if(c.attachEvent){c.attachEvent("onreadystatechange",B),a.attachEvent("onload",e.ready);var b=!1;try{b=a.frameElement==null}catch(d){}c.documentElement.doScroll&&b&&J()}}},isFunction:function(a){return e.type(a)==="function"},isArray:Array.isArray||function(a){return e.type(a)==="array"},isWindow:function(a){return a&&typeof a=="object"&&"setInterval"in a},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):I[C.call(a)]||"object"},isPlainObject:function(a){if(!a||e.type(a)!=="object"||a.nodeType||e.isWindow(a))return!1;try{if(a.constructor&&!D.call(a,"constructor")&&!D.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var d;for(d in a);return d===b||D.call(a,d)},isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw new Error(a)},parseJSON:function(b){if(typeof b!="string"||!b)return null;b=e.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(n.test(b.replace(o,"@").replace(p,"]").replace(q,"")))return(new Function("return "+b))();e.error("Invalid JSON: "+b)},parseXML:function(c){var d,f;try{a.DOMParser?(f=new DOMParser,d=f.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))}catch(g){d=b}(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&e.error("Invalid XML: "+c);return d},noop:function(){},globalEval:function(b){b&&j.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(w,"ms-").replace(v,x)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var f,g=0,h=a.length,i=h===b||e.isFunction(a);if(d){if(i){for(f in a)if(c.apply(a[f],d)===!1)break}else for(;g<h;)if(c.apply(a[g++],d)===!1)break}else if(i){for(f in a)if(c.call(a[f],f,a[f])===!1)break}else for(;g<h;)if(c.call(a[g],g,a[g++])===!1)break;return a},trim:G?function(a){return a==null?"":G.call(a)}:function(a){return a==null?"":(a+"").replace(k,"").replace(l,"")},makeArray:function(a,b){var c=b||[];if(a!=null){var d=e.type(a);a.length==null||d==="string"||d==="function"||d==="regexp"||e.isWindow(a)?E.call(c,a):e.merge(c,a)}return c},inArray:function(a,b,c){var d;if(b){if(H)return H.call(b,a,c);d=b.length,c=c?c<0?Math.max(0,d+c):c:0;for(;c<d;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,c){var d=a.length,e=0;if(typeof c.length=="number")for(var f=c.length;e<f;e++)a[d++]=c[e];else while(c[e]!==b)a[d++]=c[e++];a.length=d;return a},grep:function(a,b,c){var d=[],e;c=!!c;for(var f=0,g=a.length;f<g;f++)e=!!b(a[f],f),c!==e&&d.push(a[f]);return d},map:function(a,c,d){var f,g,h=[],i=0,j=a.length,k=a instanceof e||j!==b&&typeof j=="number"&&(j>0&&a[0]&&a[j-1]||j===0||e.isArray(a));if(k)for(;i<j;i++)f=c(a[i],i,d),f!=null&&(h[h.length]=f);else for(g in a)f=c(a[g],g,d),f!=null&&(h[h.length]=f);return h.concat.apply([],h)},guid:1,proxy:function(a,c){if(typeof c=="string"){var d=a[c];c=a,a=d}if(!e.isFunction(a))return b;var f=F.call(arguments,2),g=function(){return a.apply(c,f.concat(F.call(arguments)))};g.guid=a.guid=a.guid||g.guid||e.guid++;return g},access:function(a,c,d,f,g,h){var i=a.length;if(typeof c=="object"){for(var j in c)e.access(a,j,c[j],f,g,d);return a}if(d!==b){f=!h&&f&&e.isFunction(d);for(var k=0;k<i;k++)g(a[k],c,f?d.call(a[k],k,g(a[k],c)):d,h);return a}return i?g(a[0],c):b},now:function(){return(new Date).getTime()},uaMatch:function(a){a=a.toLowerCase();var b=r.exec(a)||s.exec(a)||t.exec(a)||a.indexOf("compatible")<0&&u.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},sub:function(){function a(b,c){return new a.fn.init(b,c)}e.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function(d,f){f&&f instanceof e&&!(f instanceof a)&&(f=a(f));return e.fn.init.call(this,d,f,b)},a.fn.init.prototype=a.fn;var b=a(c);return a},browser:{}}),e.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){I["[object "+b+"]"]=b.toLowerCase()}),z=e.uaMatch(y),z.browser&&(e.browser[z.browser]=!0,e.browser.version=z.version),e.browser.webkit&&(e.browser.safari=!0),j.test(" ")&&(k=/^[\s\xA0]+/,l=/[\s\xA0]+$/),h=e(c),c.addEventListener?B=function(){c.removeEventListener("DOMContentLoaded",B,!1),e.ready()}:c.attachEvent&&(B=function(){c.readyState==="complete"&&(c.detachEvent("onreadystatechange",B),e.ready())});return e}(),g={};f.Callbacks=function(a){a=a?g[a]||h(a):{};var c=[],d=[],e,i,j,k,l,m=function(b){var d,e,g,h,i;for(d=0,e=b.length;d<e;d++)g=b[d],h=f.type(g),h==="array"?m(g):h==="function"&&(!a.unique||!o.has(g))&&c.push(g)},n=function(b,f){f=f||[],e=!a.memory||[b,f],i=!0,l=j||0,j=0,k=c.length;for(;c&&l<k;l++)if(c[l].apply(b,f)===!1&&a.stopOnFalse){e=!0;break}i=!1,c&&(a.once?e===!0?o.disable():c=[]:d&&d.length&&(e=d.shift(),o.fireWith(e[0],e[1])))},o={add:function(){if(c){var a=c.length;m(arguments),i?k=c.length:e&&e!==!0&&(j=a,n(e[0],e[1]))}return this},remove:function(){if(c){var b=arguments,d=0,e=b.length;for(;d<e;d++)for(var f=0;f<c.length;f++)if(b[d]===c[f]){i&&f<=k&&(k--,f<=l&&l--),c.splice(f--,1);if(a.unique)break}}return this},has:function(a){if(c){var b=0,d=c.length;for(;b<d;b++)if(a===c[b])return!0}return!1},empty:function(){c=[];return this},disable:function(){c=d=e=b;return this},disabled:function(){return!c},lock:function(){d=b,(!e||e===!0)&&o.disable();return this},locked:function(){return!d},fireWith:function(b,c){d&&(i?a.once||d.push([b,c]):(!a.once||!e)&&n(b,c));return this},fire:function(){o.fireWith(this,arguments);return this},fired:function(){return!!e}};return o};var i=[].slice;f.extend({Deferred:function(a){var b=f.Callbacks("once memory"),c=f.Callbacks("once memory"),d=f.Callbacks("memory"),e="pending",g={resolve:b,reject:c,notify:d},h={done:b.add,fail:c.add,progress:d.add,state:function(){return e},isResolved:b.fired,isRejected:c.fired,then:function(a,b,c){i.done(a).fail(b).progress(c);return this},always:function(){i.done.apply(i,arguments).fail.apply(i,arguments);return this},pipe:function(a,b,c){return f.Deferred(function(d){f.each({done:[a,"resolve"],fail:[b,"reject"],progress:[c,"notify"]},function(a,b){var c=b[0],e=b[1],g;f.isFunction(c)?i[a](function(){g=c.apply(this,arguments),g&&f.isFunction(g.promise)?g.promise().then(d.resolve,d.reject,d.notify):d[e+"With"](this===i?d:this,[g])}):i[a](d[e])})}).promise()},promise:function(a){if(a==null)a=h;else for(var b in h)a[b]=h[b];return a}},i=h.promise({}),j;for(j in g)i[j]=g[j].fire,i[j+"With"]=g[j].fireWith;i.done(function(){e="resolved"},c.disable,d.lock).fail(function(){e="rejected"},b.disable,d.lock),a&&a.call(i,i);return i},when:function(a){function m(a){return function(b){e[a]=arguments.length>1?i.call(arguments,0):b,j.notifyWith(k,e)}}function l(a){return function(c){b[a]=arguments.length>1?i.call(arguments,0):c,--g||j.resolveWith(j,b)}}var b=i.call(arguments,0),c=0,d=b.length,e=Array(d),g=d,h=d,j=d<=1&&a&&f.isFunction(a.promise)?a:f.Deferred(),k=j.promise();if(d>1){for(;c<d;c++)b[c]&&b[c].promise&&f.isFunction(b[c].promise)?b[c].promise().then(l(c),j.reject,m(c)):--g;g||j.resolveWith(j,b)}else j!==a&&j.resolveWith(j,d?[a]:[]);return k}}),f.support=function(){var b,d,e,g,h,i,j,k,l,m,n,o,p,q=c.createElement("div"),r=c.documentElement;q.setAttribute("className","t"),q.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>",d=q.getElementsByTagName("*"),e=q.getElementsByTagName("a")[0];if(!d||!d.length||!e)return{};g=c.createElement("select"),h=g.appendChild(c.createElement("option")),i=q.getElementsByTagName("input")[0],b={leadingWhitespace:q.firstChild.nodeType===3,tbody:!q.getElementsByTagName("tbody").length,htmlSerialize:!!q.getElementsByTagName("link").length,style:/top/.test(e.getAttribute("style")),hrefNormalized:e.getAttribute("href")==="/a",opacity:/^0.55/.test(e.style.opacity),cssFloat:!!e.style.cssFloat,checkOn:i.value==="on",optSelected:h.selected,getSetAttribute:q.className!=="t",enctype:!!c.createElement("form").enctype,html5Clone:c.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0},i.checked=!0,b.noCloneChecked=i.cloneNode(!0).checked,g.disabled=!0,b.optDisabled=!h.disabled;try{delete q.test}catch(s){b.deleteExpando=!1}!q.addEventListener&&q.attachEvent&&q.fireEvent&&(q.attachEvent("onclick",function(){b.noCloneEvent=!1}),q.cloneNode(!0).fireEvent("onclick")),i=c.createElement("input"),i.value="t",i.setAttribute("type","radio"),b.radioValue=i.value==="t",i.setAttribute("checked","checked"),q.appendChild(i),k=c.createDocumentFragment(),k.appendChild(q.lastChild),b.checkClone=k.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=i.checked,k.removeChild(i),k.appendChild(q),q.innerHTML="",a.getComputedStyle&&(j=c.createElement("div"),j.style.width="0",j.style.marginRight="0",q.style.width="2px",q.appendChild(j),b.reliableMarginRight=(parseInt((a.getComputedStyle(j,null)||{marginRight:0}).marginRight,10)||0)===0);if(q.attachEvent)for(o in{submit:1,change:1,focusin:1})n="on"+o,p=n in q,p||(q.setAttribute(n,"return;"),p=typeof q[n]=="function"),b[o+"Bubbles"]=p;k.removeChild(q),k=g=h=j=q=i=null,f(function(){var a,d,e,g,h,i,j,k,m,n,o,r=c.getElementsByTagName("body")[0];!r||(j=1,k="position:absolute;top:0;left:0;width:1px;height:1px;margin:0;",m="visibility:hidden;border:0;",n="style='"+k+"border:5px solid #000;padding:0;'",o="<div "+n+"><div></div></div>"+"<table "+n+" cellpadding='0' cellspacing='0'>"+"<tr><td></td></tr></table>",a=c.createElement("div"),a.style.cssText=m+"width:0;height:0;position:static;top:0;margin-top:"+j+"px",r.insertBefore(a,r.firstChild),q=c.createElement("div"),a.appendChild(q),q.innerHTML="<table><tr><td style='padding:0;border:0;display:none'></td><td>t</td></tr></table>",l=q.getElementsByTagName("td"),p=l[0].offsetHeight===0,l[0].style.display="",l[1].style.display="none",b.reliableHiddenOffsets=p&&l[0].offsetHeight===0,q.innerHTML="",q.style.width=q.style.paddingLeft="1px",f.boxModel=b.boxModel=q.offsetWidth===2,typeof q.style.zoom!="undefined"&&(q.style.display="inline",q.style.zoom=1,b.inlineBlockNeedsLayout=q.offsetWidth===2,q.style.display="",q.innerHTML="<div style='width:4px;'></div>",b.shrinkWrapBlocks=q.offsetWidth!==2),q.style.cssText=k+m,q.innerHTML=o,d=q.firstChild,e=d.firstChild,h=d.nextSibling.firstChild.firstChild,i={doesNotAddBorder:e.offsetTop!==5,doesAddBorderForTableAndCells:h.offsetTop===5},e.style.position="fixed",e.style.top="20px",i.fixedPosition=e.offsetTop===20||e.offsetTop===15,e.style.position=e.style.top="",d.style.overflow="hidden",d.style.position="relative",i.subtractsBorderForOverflowNotVisible=e.offsetTop===-5,i.doesNotIncludeMarginInBodyOffset=r.offsetTop!==j,r.removeChild(a),q=a=null,f.extend(b,i))});return b}();var j=/^(?:\{.*\}|\[.*\])$/,k=/([A-Z])/g;f.extend({cache:{},uuid:0,expando:"jQuery"+(f.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?f.cache[a[f.expando]]:a[f.expando];return!!a&&!m(a)},data:function(a,c,d,e){if(!!f.acceptData(a)){var g,h,i,j=f.expando,k=typeof c=="string",l=a.nodeType,m=l?f.cache:a,n=l?a[j]:a[j]&&j,o=c==="events";if((!n||!m[n]||!o&&!e&&!m[n].data)&&k&&d===b)return;n||(l?a[j]=n=++f.uuid:n=j),m[n]||(m[n]={},l||(m[n].toJSON=f.noop));if(typeof c=="object"||typeof c=="function")e?m[n]=f.extend(m[n],c):m[n].data=f.extend(m[n].data,c);g=h=m[n],e||(h.data||(h.data={}),h=h.data),d!==b&&(h[f.camelCase(c)]=d);if(o&&!h[c])return g.events;k?(i=h[c],i==null&&(i=h[f.camelCase(c)])):i=h;return i}},removeData:function(a,b,c){if(!!f.acceptData(a)){var d,e,g,h=f.expando,i=a.nodeType,j=i?f.cache:a,k=i?a[h]:h;if(!j[k])return;if(b){d=c?j[k]:j[k].data;if(d){f.isArray(b)||(b in d?b=[b]:(b=f.camelCase(b),b in d?b=[b]:b=b.split(" ")));for(e=0,g=b.length;e<g;e++)delete d[b[e]];if(!(c?m:f.isEmptyObject)(d))return}}if(!c){delete j[k].data;if(!m(j[k]))return}f.support.deleteExpando||!j.setInterval?delete j[k]:j[k]=null,i&&(f.support.deleteExpando?delete a[h]:a.removeAttribute?a.removeAttribute(h):a[h]=null)}},_data:function(a,b,c){return f.data(a,b,c,!0)},acceptData:function(a){if(a.nodeName){var b=f.noData[a.nodeName.toLowerCase()];if(b)return b!==!0&&a.getAttribute("classid")===b}return!0}}),f.fn.extend({data:function(a,c){var d,e,g,h=null;if(typeof a=="undefined"){if(this.length){h=f.data(this[0]);if(this[0].nodeType===1&&!f._data(this[0],"parsedAttrs")){e=this[0].attributes;for(var i=0,j=e.length;i<j;i++)g=e[i].name,g.indexOf("data-")===0&&(g=f.camelCase(g.substring(5)),l(this[0],g,h[g]));f._data(this[0],"parsedAttrs",!0)}}return h}if(typeof a=="object")return this.each(function(){f.data(this,a)});d=a.split("."),d[1]=d[1]?"."+d[1]:"";if(c===b){h=this.triggerHandler("getData"+d[1]+"!",[d[0]]),h===b&&this.length&&(h=f.data(this[0],a),h=l(this[0],a,h));return h===b&&d[1]?this.data(d[0]):h}return this.each(function(){var b=f(this),e=[d[0],c];b.triggerHandler("setData"+d[1]+"!",e),f.data(this,a,c),b.triggerHandler("changeData"+d[1]+"!",e)})},removeData:function(a){return this.each(function(){f.removeData(this,a)})}}),f.extend({_mark:function(a,b){a&&(b=(b||"fx")+"mark",f._data(a,b,(f._data(a,b)||0)+1))},_unmark:function(a,b,c){a!==!0&&(c=b,b=a,a=!1);if(b){c=c||"fx";var d=c+"mark",e=a?0:(f._data(b,d)||1)-1;e?f._data(b,d,e):(f.removeData(b,d,!0),n(b,c,"mark"))}},queue:function(a,b,c){var d;if(a){b=(b||"fx")+"queue",d=f._data(a,b),c&&(!d||f.isArray(c)?d=f._data(a,b,f.makeArray(c)):d.push(c));return d||[]}},dequeue:function(a,b){b=b||"fx";var c=f.queue(a,b),d=c.shift(),e={};d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),f._data(a,b+".run",e),d.call(a,function(){f.dequeue(a,b)},e)),c.length||(f.removeData(a,b+"queue "+b+".run",!0),n(a,b,"queue"))}}),f.fn.extend({queue:function(a,c){typeof a!="string"&&(c=a,a="fx");if(c===b)return f.queue(this[0],a);return this.each(function(){var b=f.queue(this,a,c);a==="fx"&&b[0]!=="inprogress"&&f.dequeue(this,a)})},dequeue:function(a){return this.each(function(){f.dequeue(this,a)})},delay:function(a,b){a=f.fx?f.fx.speeds[a]||a:a,b=b||"fx";return this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){function m(){--h||d.resolveWith(e,[e])}typeof a!="string"&&(c=a,a=b),a=a||"fx";var d=f.Deferred(),e=this,g=e.length,h=1,i=a+"defer",j=a+"queue",k=a+"mark",l;while(g--)if(l=f.data(e[g],i,b,!0)||(f.data(e[g],j,b,!0)||f.data(e[g],k,b,!0))&&f.data(e[g],i,f.Callbacks("once memory"),!0))h++,l.add(m);m();return d.promise()}});var o=/[\n\t\r]/g,p=/\s+/,q=/\r/g,r=/^(?:button|input)$/i,s=/^(?:button|input|object|select|textarea)$/i,t=/^a(?:rea)?$/i,u=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,v=f.support.getSetAttribute,w,x,y;f.fn.extend({attr:function(a,b){return f.access(this,a,b,!0,f.attr)},removeAttr:function(a){return this.each(function(){f.removeAttr(this,a)})},prop:function(a,b){return f.access(this,a,b,!0,f.prop)},removeProp:function(a){a=f.propFix[a]||a;return this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,g,h,i;if(f.isFunction(a))return this.each(function(b){f(this).addClass(a.call(this,b,this.className))});if(a&&typeof a=="string"){b=a.split(p);for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1)if(!e.className&&b.length===1)e.className=a;else{g=" "+e.className+" ";for(h=0,i=b.length;h<i;h++)~g.indexOf(" "+b[h]+" ")||(g+=b[h]+" ");e.className=f.trim(g)}}}return this},removeClass:function(a){var c,d,e,g,h,i,j;if(f.isFunction(a))return this.each(function(b){f(this).removeClass(a.call(this,b,this.className))});if(a&&typeof a=="string"||a===b){c=(a||"").split(p);for(d=0,e=this.length;d<e;d++){g=this[d];if(g.nodeType===1&&g.className)if(a){h=(" "+g.className+" ").replace(o," ");for(i=0,j=c.length;i<j;i++)h=h.replace(" "+c[i]+" "," ");g.className=f.trim(h)}else g.className=""}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";if(f.isFunction(a))return this.each(function(c){f(this).toggleClass(a.call(this,c,this.className,b),b)});return this.each(function(){if(c==="string"){var e,g=0,h=f(this),i=b,j=a.split(p);while(e=j[g++])i=d?i:!h.hasClass(e),h[i?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&f._data(this,"__className__",this.className),this.className=this.className||a===!1?"":f._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++)if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(o," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e,g=this[0];{if(!!arguments.length){e=f.isFunction(a);return this.each(function(d){var g=f(this),h;if(this.nodeType===1){e?h=a.call(this,d,g.val()):h=a,h==null?h="":typeof h=="number"?h+="":f.isArray(h)&&(h=f.map(h,function(a){return a==null?"":a+""})),c=f.valHooks[this.nodeName.toLowerCase()]||f.valHooks[this.type];if(!c||!("set"in c)||c.set(this,h,"value")===b)this.value=h}})}if(g){c=f.valHooks[g.nodeName.toLowerCase()]||f.valHooks[g.type];if(c&&"get"in c&&(d=c.get(g,"value"))!==b)return d;d=g.value;return typeof d=="string"?d.replace(q,""):d==null?"":d}}}}),f.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,g=a.selectedIndex,h=[],i=a.options,j=a.type==="select-one";if(g<0)return null;c=j?g:0,d=j?g+1:i.length;for(;c<d;c++){e=i[c];if(e.selected&&(f.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!f.nodeName(e.parentNode,"optgroup"))){b=f(e).val();if(j)return b;h.push(b)}}if(j&&!h.length&&i.length)return f(i[g]).val();return h},set:function(a,b){var c=f.makeArray(b);f(a).find("option").each(function(){this.selected=f.inArray(f(this).val(),c)>=0}),c.length||(a.selectedIndex=-1);return c}}},attrFn:{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0},attr:function(a,c,d,e){var g,h,i,j=a.nodeType;if(!!a&&j!==3&&j!==8&&j!==2){if(e&&c in f.attrFn)return f(a)[c](d);if(typeof a.getAttribute=="undefined")return f.prop(a,c,d);i=j!==1||!f.isXMLDoc(a),i&&(c=c.toLowerCase(),h=f.attrHooks[c]||(u.test(c)?x:w));if(d!==b){if(d===null){f.removeAttr(a,c);return}if(h&&"set"in h&&i&&(g=h.set(a,d,c))!==b)return g;a.setAttribute(c,""+d);return d}if(h&&"get"in h&&i&&(g=h.get(a,c))!==null)return g;g=a.getAttribute(c);return g===null?b:g}},removeAttr:function(a,b){var c,d,e,g,h=0;if(b&&a.nodeType===1){d=b.toLowerCase().split(p),g=d.length;for(;h<g;h++)e=d[h],e&&(c=f.propFix[e]||e,f.attr(a,e,""),a.removeAttribute(v?e:c),u.test(e)&&c in a&&(a[c]=!1))}},attrHooks:{type:{set:function(a,b){if(r.test(a.nodeName)&&a.parentNode)f.error("type property can't be changed");else if(!f.support.radioValue&&b==="radio"&&f.nodeName(a,"input")){var c=a.value;a.setAttribute("type",b),c&&(a.value=c);return b}}},value:{get:function(a,b){if(w&&f.nodeName(a,"button"))return w.get(a,b);return b in a?a.value:null},set:function(a,b,c){if(w&&f.nodeName(a,"button"))return w.set(a,b,c);a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,g,h,i=a.nodeType;if(!!a&&i!==3&&i!==8&&i!==2){h=i!==1||!f.isXMLDoc(a),h&&(c=f.propFix[c]||c,g=f.propHooks[c]);return d!==b?g&&"set"in g&&(e=g.set(a,d,c))!==b?e:a[c]=d:g&&"get"in g&&(e=g.get(a,c))!==null?e:a[c]}},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):s.test(a.nodeName)||t.test(a.nodeName)&&a.href?0:b}}}}),f.attrHooks.tabindex=f.propHooks.tabIndex,x={get:function(a,c){var d,e=f.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b},set:function(a,b,c){var d;b===!1?f.removeAttr(a,c):(d=f.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase()));return c}},v||(y={name:!0,id:!0},w=f.valHooks.button={get:function(a,c){var d;d=a.getAttributeNode(c);return d&&(y[c]?d.nodeValue!=="":d.specified)?d.nodeValue:b},set:function(a,b,d){var e=a.getAttributeNode(d);e||(e=c.createAttribute(d),a.setAttributeNode(e));return e.nodeValue=b+""}},f.attrHooks.tabindex.set=w.set,f.each(["width","height"],function(a,b){f.attrHooks[b]=f.extend(f.attrHooks[b],{set:function(a,c){if(c===""){a.setAttribute(b,"auto");return c}}})}),f.attrHooks.contenteditable={get:w.get,set:function(a,b,c){b===""&&(b="false"),w.set(a,b,c)}}),f.support.hrefNormalized||f.each(["href","src","width","height"],function(a,c){f.attrHooks[c]=f.extend(f.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),f.support.style||(f.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),f.support.optSelected||(f.propHooks.selected=f.extend(f.propHooks.selected,{get:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex);return null}})),f.support.enctype||(f.propFix.enctype="encoding"),f.support.checkOn||f.each(["radio","checkbox"],function(){f.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),f.each(["radio","checkbox"],function(){f.valHooks[this]=f.extend(f.valHooks[this],{set:function(a,b){if(f.isArray(b))return a.checked=f.inArray(f(a).val(),b)>=0}})});var z=/^(?:textarea|input|select)$/i,A=/^([^\.]*)?(?:\.(.+))?$/,B=/\bhover(\.\S+)?\b/,C=/^key/,D=/^(?:mouse|contextmenu)|click/,E=/^(?:focusinfocus|focusoutblur)$/,F=/^(\w*)(?:#([\w\-]+))?(?:\.([\w\-]+))?$/,G=function(a){var b=F.exec(a);b&&(b[1]=(b[1]||"").toLowerCase(),b[3]=b[3]&&new RegExp("(?:^|\\s)"+b[3]+"(?:\\s|$)"));return b},H=function(a,b){var c=a.attributes||{};return(!b[1]||a.nodeName.toLowerCase()===b[1])&&(!b[2]||(c.id||{}).value===b[2])&&(!b[3]||b[3].test((c["class"]||{}).value))},I=function(a){return f.event.special.hover?a:a.replace(B,"mouseenter$1 mouseleave$1")};
f.event={add:function(a,c,d,e,g){var h,i,j,k,l,m,n,o,p,q,r,s;if(!(a.nodeType===3||a.nodeType===8||!c||!d||!(h=f._data(a)))){d.handler&&(p=d,d=p.handler),d.guid||(d.guid=f.guid++),j=h.events,j||(h.events=j={}),i=h.handle,i||(h.handle=i=function(a){return typeof f!="undefined"&&(!a||f.event.triggered!==a.type)?f.event.dispatch.apply(i.elem,arguments):b},i.elem=a),c=f.trim(I(c)).split(" ");for(k=0;k<c.length;k++){l=A.exec(c[k])||[],m=l[1],n=(l[2]||"").split(".").sort(),s=f.event.special[m]||{},m=(g?s.delegateType:s.bindType)||m,s=f.event.special[m]||{},o=f.extend({type:m,origType:l[1],data:e,handler:d,guid:d.guid,selector:g,quick:G(g),namespace:n.join(".")},p),r=j[m];if(!r){r=j[m]=[],r.delegateCount=0;if(!s.setup||s.setup.call(a,e,n,i)===!1)a.addEventListener?a.addEventListener(m,i,!1):a.attachEvent&&a.attachEvent("on"+m,i)}s.add&&(s.add.call(a,o),o.handler.guid||(o.handler.guid=d.guid)),g?r.splice(r.delegateCount++,0,o):r.push(o),f.event.global[m]=!0}a=null}},global:{},remove:function(a,b,c,d,e){var g=f.hasData(a)&&f._data(a),h,i,j,k,l,m,n,o,p,q,r,s;if(!!g&&!!(o=g.events)){b=f.trim(I(b||"")).split(" ");for(h=0;h<b.length;h++){i=A.exec(b[h])||[],j=k=i[1],l=i[2];if(!j){for(j in o)f.event.remove(a,j+b[h],c,d,!0);continue}p=f.event.special[j]||{},j=(d?p.delegateType:p.bindType)||j,r=o[j]||[],m=r.length,l=l?new RegExp("(^|\\.)"+l.split(".").sort().join("\\.(?:.*\\.)?")+"(\\.|$)"):null;for(n=0;n<r.length;n++)s=r[n],(e||k===s.origType)&&(!c||c.guid===s.guid)&&(!l||l.test(s.namespace))&&(!d||d===s.selector||d==="**"&&s.selector)&&(r.splice(n--,1),s.selector&&r.delegateCount--,p.remove&&p.remove.call(a,s));r.length===0&&m!==r.length&&((!p.teardown||p.teardown.call(a,l)===!1)&&f.removeEvent(a,j,g.handle),delete o[j])}f.isEmptyObject(o)&&(q=g.handle,q&&(q.elem=null),f.removeData(a,["events","handle"],!0))}},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,e,g){if(!e||e.nodeType!==3&&e.nodeType!==8){var h=c.type||c,i=[],j,k,l,m,n,o,p,q,r,s;if(E.test(h+f.event.triggered))return;h.indexOf("!")>=0&&(h=h.slice(0,-1),k=!0),h.indexOf(".")>=0&&(i=h.split("."),h=i.shift(),i.sort());if((!e||f.event.customEvent[h])&&!f.event.global[h])return;c=typeof c=="object"?c[f.expando]?c:new f.Event(h,c):new f.Event(h),c.type=h,c.isTrigger=!0,c.exclusive=k,c.namespace=i.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+i.join("\\.(?:.*\\.)?")+"(\\.|$)"):null,o=h.indexOf(":")<0?"on"+h:"";if(!e){j=f.cache;for(l in j)j[l].events&&j[l].events[h]&&f.event.trigger(c,d,j[l].handle.elem,!0);return}c.result=b,c.target||(c.target=e),d=d!=null?f.makeArray(d):[],d.unshift(c),p=f.event.special[h]||{};if(p.trigger&&p.trigger.apply(e,d)===!1)return;r=[[e,p.bindType||h]];if(!g&&!p.noBubble&&!f.isWindow(e)){s=p.delegateType||h,m=E.test(s+h)?e:e.parentNode,n=null;for(;m;m=m.parentNode)r.push([m,s]),n=m;n&&n===e.ownerDocument&&r.push([n.defaultView||n.parentWindow||a,s])}for(l=0;l<r.length&&!c.isPropagationStopped();l++)m=r[l][0],c.type=r[l][1],q=(f._data(m,"events")||{})[c.type]&&f._data(m,"handle"),q&&q.apply(m,d),q=o&&m[o],q&&f.acceptData(m)&&q.apply(m,d)===!1&&c.preventDefault();c.type=h,!g&&!c.isDefaultPrevented()&&(!p._default||p._default.apply(e.ownerDocument,d)===!1)&&(h!=="click"||!f.nodeName(e,"a"))&&f.acceptData(e)&&o&&e[h]&&(h!=="focus"&&h!=="blur"||c.target.offsetWidth!==0)&&!f.isWindow(e)&&(n=e[o],n&&(e[o]=null),f.event.triggered=h,e[h](),f.event.triggered=b,n&&(e[o]=n));return c.result}},dispatch:function(c){c=f.event.fix(c||a.event);var d=(f._data(this,"events")||{})[c.type]||[],e=d.delegateCount,g=[].slice.call(arguments,0),h=!c.exclusive&&!c.namespace,i=[],j,k,l,m,n,o,p,q,r,s,t;g[0]=c,c.delegateTarget=this;if(e&&!c.target.disabled&&(!c.button||c.type!=="click")){m=f(this),m.context=this.ownerDocument||this;for(l=c.target;l!=this;l=l.parentNode||this){o={},q=[],m[0]=l;for(j=0;j<e;j++)r=d[j],s=r.selector,o[s]===b&&(o[s]=r.quick?H(l,r.quick):m.is(s)),o[s]&&q.push(r);q.length&&i.push({elem:l,matches:q})}}d.length>e&&i.push({elem:this,matches:d.slice(e)});for(j=0;j<i.length&&!c.isPropagationStopped();j++){p=i[j],c.currentTarget=p.elem;for(k=0;k<p.matches.length&&!c.isImmediatePropagationStopped();k++){r=p.matches[k];if(h||!c.namespace&&!r.namespace||c.namespace_re&&c.namespace_re.test(r.namespace))c.data=r.data,c.handleObj=r,n=((f.event.special[r.origType]||{}).handle||r.handler).apply(p.elem,g),n!==b&&(c.result=n,n===!1&&(c.preventDefault(),c.stopPropagation()))}}return c.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode);return a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,d){var e,f,g,h=d.button,i=d.fromElement;a.pageX==null&&d.clientX!=null&&(e=a.target.ownerDocument||c,f=e.documentElement,g=e.body,a.pageX=d.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=d.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?d.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0);return a}},fix:function(a){if(a[f.expando])return a;var d,e,g=a,h=f.event.fixHooks[a.type]||{},i=h.props?this.props.concat(h.props):this.props;a=f.Event(g);for(d=i.length;d;)e=i[--d],a[e]=g[e];a.target||(a.target=g.srcElement||c),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey===b&&(a.metaKey=a.ctrlKey);return h.filter?h.filter(a,g):a},special:{ready:{setup:f.bindReady},load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){f.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=f.extend(new f.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?f.event.trigger(e,null,b):f.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},f.event.handle=f.event.dispatch,f.removeEvent=c.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){a.detachEvent&&a.detachEvent("on"+b,c)},f.Event=function(a,b){if(!(this instanceof f.Event))return new f.Event(a,b);a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?K:J):this.type=a,b&&f.extend(this,b),this.timeStamp=a&&a.timeStamp||f.now(),this[f.expando]=!0},f.Event.prototype={preventDefault:function(){this.isDefaultPrevented=K;var a=this.originalEvent;!a||(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){this.isPropagationStopped=K;var a=this.originalEvent;!a||(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=K,this.stopPropagation()},isDefaultPrevented:J,isPropagationStopped:J,isImmediatePropagationStopped:J},f.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){f.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c=this,d=a.relatedTarget,e=a.handleObj,g=e.selector,h;if(!d||d!==c&&!f.contains(c,d))a.type=e.origType,h=e.handler.apply(this,arguments),a.type=b;return h}}}),f.support.submitBubbles||(f.event.special.submit={setup:function(){if(f.nodeName(this,"form"))return!1;f.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=f.nodeName(c,"input")||f.nodeName(c,"button")?c.form:b;d&&!d._submit_attached&&(f.event.add(d,"submit._submit",function(a){this.parentNode&&!a.isTrigger&&f.event.simulate("submit",this.parentNode,a,!0)}),d._submit_attached=!0)})},teardown:function(){if(f.nodeName(this,"form"))return!1;f.event.remove(this,"._submit")}}),f.support.changeBubbles||(f.event.special.change={setup:function(){if(z.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")f.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),f.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1,f.event.simulate("change",this,a,!0))});return!1}f.event.add(this,"beforeactivate._change",function(a){var b=a.target;z.test(b.nodeName)&&!b._change_attached&&(f.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&f.event.simulate("change",this.parentNode,a,!0)}),b._change_attached=!0)})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox")return a.handleObj.handler.apply(this,arguments)},teardown:function(){f.event.remove(this,"._change");return z.test(this.nodeName)}}),f.support.focusinBubbles||f.each({focus:"focusin",blur:"focusout"},function(a,b){var d=0,e=function(a){f.event.simulate(b,a.target,f.event.fix(a),!0)};f.event.special[b]={setup:function(){d++===0&&c.addEventListener(a,e,!0)},teardown:function(){--d===0&&c.removeEventListener(a,e,!0)}}}),f.fn.extend({on:function(a,c,d,e,g){var h,i;if(typeof a=="object"){typeof c!="string"&&(d=c,c=b);for(i in a)this.on(i,c,d,a[i],g);return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));if(e===!1)e=J;else if(!e)return this;g===1&&(h=e,e=function(a){f().off(a);return h.apply(this,arguments)},e.guid=h.guid||(h.guid=f.guid++));return this.each(function(){f.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on.call(this,a,b,c,d,1)},off:function(a,c,d){if(a&&a.preventDefault&&a.handleObj){var e=a.handleObj;f(a.delegateTarget).off(e.namespace?e.type+"."+e.namespace:e.type,e.selector,e.handler);return this}if(typeof a=="object"){for(var g in a)this.off(g,c,a[g]);return this}if(c===!1||typeof c=="function")d=c,c=b;d===!1&&(d=J);return this.each(function(){f.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){f(this.context).on(a,this.selector,b,c);return this},die:function(a,b){f(this.context).off(a,this.selector||"**",b);return this},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a,c)},trigger:function(a,b){return this.each(function(){f.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return f.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||f.guid++,d=0,e=function(c){var e=(f._data(this,"lastToggle"+a.guid)||0)%d;f._data(this,"lastToggle"+a.guid,e+1),c.preventDefault();return b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),f.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){f.fn[b]=function(a,c){c==null&&(c=a,a=null);return arguments.length>0?this.on(b,null,a,c):this.trigger(b)},f.attrFn&&(f.attrFn[b]=!0),C.test(b)&&(f.event.fixHooks[b]=f.event.keyHooks),D.test(b)&&(f.event.fixHooks[b]=f.event.mouseHooks)}),function(){function x(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}if(j.nodeType===1){g||(j[d]=c,j.sizset=h);if(typeof b!="string"){if(j===b){k=!0;break}}else if(m.filter(b,[j]).length>0){k=j;break}}j=j[a]}e[h]=k}}}function w(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}j.nodeType===1&&!g&&(j[d]=c,j.sizset=h);if(j.nodeName.toLowerCase()===b){k=j;break}j=j[a]}e[h]=k}}}var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,d="sizcache"+(Math.random()+"").replace(".",""),e=0,g=Object.prototype.toString,h=!1,i=!0,j=/\\/g,k=/\r\n/g,l=/\W/;[0,0].sort(function(){i=!1;return 0});var m=function(b,d,e,f){e=e||[],d=d||c;var h=d;if(d.nodeType!==1&&d.nodeType!==9)return[];if(!b||typeof b!="string")return e;var i,j,k,l,n,q,r,t,u=!0,v=m.isXML(d),w=[],x=b;do{a.exec(""),i=a.exec(x);if(i){x=i[3],w.push(i[1]);if(i[2]){l=i[3];break}}}while(i);if(w.length>1&&p.exec(b))if(w.length===2&&o.relative[w[0]])j=y(w[0]+w[1],d,f);else{j=o.relative[w[0]]?[d]:m(w.shift(),d);while(w.length)b=w.shift(),o.relative[b]&&(b+=w.shift()),j=y(b,j,f)}else{!f&&w.length>1&&d.nodeType===9&&!v&&o.match.ID.test(w[0])&&!o.match.ID.test(w[w.length-1])&&(n=m.find(w.shift(),d,v),d=n.expr?m.filter(n.expr,n.set)[0]:n.set[0]);if(d){n=f?{expr:w.pop(),set:s(f)}:m.find(w.pop(),w.length===1&&(w[0]==="~"||w[0]==="+")&&d.parentNode?d.parentNode:d,v),j=n.expr?m.filter(n.expr,n.set):n.set,w.length>0?k=s(j):u=!1;while(w.length)q=w.pop(),r=q,o.relative[q]?r=w.pop():q="",r==null&&(r=d),o.relative[q](k,r,v)}else k=w=[]}k||(k=j),k||m.error(q||b);if(g.call(k)==="[object Array]")if(!u)e.push.apply(e,k);else if(d&&d.nodeType===1)for(t=0;k[t]!=null;t++)k[t]&&(k[t]===!0||k[t].nodeType===1&&m.contains(d,k[t]))&&e.push(j[t]);else for(t=0;k[t]!=null;t++)k[t]&&k[t].nodeType===1&&e.push(j[t]);else s(k,e);l&&(m(l,h,e,f),m.uniqueSort(e));return e};m.uniqueSort=function(a){if(u){h=i,a.sort(u);if(h)for(var b=1;b<a.length;b++)a[b]===a[b-1]&&a.splice(b--,1)}return a},m.matches=function(a,b){return m(a,null,null,b)},m.matchesSelector=function(a,b){return m(b,null,null,[a]).length>0},m.find=function(a,b,c){var d,e,f,g,h,i;if(!a)return[];for(e=0,f=o.order.length;e<f;e++){h=o.order[e];if(g=o.leftMatch[h].exec(a)){i=g[1],g.splice(1,1);if(i.substr(i.length-1)!=="\\"){g[1]=(g[1]||"").replace(j,""),d=o.find[h](g,b,c);if(d!=null){a=a.replace(o.match[h],"");break}}}}d||(d=typeof b.getElementsByTagName!="undefined"?b.getElementsByTagName("*"):[]);return{set:d,expr:a}},m.filter=function(a,c,d,e){var f,g,h,i,j,k,l,n,p,q=a,r=[],s=c,t=c&&c[0]&&m.isXML(c[0]);while(a&&c.length){for(h in o.filter)if((f=o.leftMatch[h].exec(a))!=null&&f[2]){k=o.filter[h],l=f[1],g=!1,f.splice(1,1);if(l.substr(l.length-1)==="\\")continue;s===r&&(r=[]);if(o.preFilter[h]){f=o.preFilter[h](f,s,d,r,e,t);if(!f)g=i=!0;else if(f===!0)continue}if(f)for(n=0;(j=s[n])!=null;n++)j&&(i=k(j,f,n,s),p=e^i,d&&i!=null?p?g=!0:s[n]=!1:p&&(r.push(j),g=!0));if(i!==b){d||(s=r),a=a.replace(o.match[h],"");if(!g)return[];break}}if(a===q)if(g==null)m.error(a);else break;q=a}return s},m.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)};var n=m.getText=function(a){var b,c,d=a.nodeType,e="";if(d){if(d===1||d===9){if(typeof a.textContent=="string")return a.textContent;if(typeof a.innerText=="string")return a.innerText.replace(k,"");for(a=a.firstChild;a;a=a.nextSibling)e+=n(a)}else if(d===3||d===4)return a.nodeValue}else for(b=0;c=a[b];b++)c.nodeType!==8&&(e+=n(c));return e},o=m.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b=="string",d=c&&!l.test(b),e=c&&!d;d&&(b=b.toLowerCase());for(var f=0,g=a.length,h;f<g;f++)if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1);a[f]=e||h&&h.nodeName.toLowerCase()===b?h||!1:h===b}e&&m.filter(b,a,!0)},">":function(a,b){var c,d=typeof b=="string",e=0,f=a.length;if(d&&!l.test(b)){b=b.toLowerCase();for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:!1}}}else{for(;e<f;e++)c=a[e],c&&(a[e]=d?c.parentNode:c.parentNode===b);d&&m.filter(b,a,!0)}},"":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("parentNode",b,f,a,d,c)},"~":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("previousSibling",b,f,a,d,c)}},find:{ID:function(a,b,c){if(typeof b.getElementById!="undefined"&&!c){var d=b.getElementById(a[1]);return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!="undefined"){var c=[],d=b.getElementsByName(a[1]);for(var e=0,f=d.length;e<f;e++)d[e].getAttribute("name")===a[1]&&c.push(d[e]);return c.length===0?null:c}},TAG:function(a,b){if(typeof b.getElementsByTagName!="undefined")return b.getElementsByTagName(a[1])}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(j,"")+" ";if(f)return a;for(var g=0,h;(h=b[g])!=null;g++)h&&(e^(h.className&&(" "+h.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)?c||d.push(h):c&&(b[g]=!1));return!1},ID:function(a){return a[1].replace(j,"")},TAG:function(a,b){return a[1].replace(j,"").toLowerCase()},CHILD:function(a){if(a[1]==="nth"){a[2]||m.error(a[0]),a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);a[2]=b[1]+(b[2]||1)-0,a[3]=b[3]-0}else a[2]&&m.error(a[0]);a[0]=e++;return a},ATTR:function(a,b,c,d,e,f){var g=a[1]=a[1].replace(j,"");!f&&o.attrMap[g]&&(a[1]=o.attrMap[g]),a[4]=(a[4]||a[5]||"").replace(j,""),a[2]==="~="&&(a[4]=" "+a[4]+" ");return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not")if((a.exec(b[3])||"").length>1||/^\w/.test(b[3]))b[3]=m(b[3],null,null,c);else{var g=m.filter(b[3],c,d,!0^f);d||e.push.apply(e,g);return!1}else if(o.match.POS.test(b[0])||o.match.CHILD.test(b[0]))return!0;return b},POS:function(a){a.unshift(!0);return a}},filters:{enabled:function(a){return a.disabled===!1&&a.type!=="hidden"},disabled:function(a){return a.disabled===!0},checked:function(a){return a.checked===!0},selected:function(a){a.parentNode&&a.parentNode.selectedIndex;return a.selected===!0},parent:function(a){return!!a.firstChild},empty:function(a){return!a.firstChild},has:function(a,b,c){return!!m(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=o.filters[e];if(f)return f(a,c,b,d);if(e==="contains")return(a.textContent||a.innerText||n([a])||"").indexOf(b[3])>=0;if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++)if(g[h]===a)return!1;return!0}m.error(e)},CHILD:function(a,b){var c,e,f,g,h,i,j,k=b[1],l=a;switch(k){case"only":case"first":while(l=l.previousSibling)if(l.nodeType===1)return!1;if(k==="first")return!0;l=a;case"last":while(l=l.nextSibling)if(l.nodeType===1)return!1;return!0;case"nth":c=b[2],e=b[3];if(c===1&&e===0)return!0;f=b[0],g=a.parentNode;if(g&&(g[d]!==f||!a.nodeIndex)){i=0;for(l=g.firstChild;l;l=l.nextSibling)l.nodeType===1&&(l.nodeIndex=++i);g[d]=f}j=a.nodeIndex-e;return c===0?j===0:j%c===0&&j/c>=0}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||!!a.nodeName&&a.nodeName.toLowerCase()===b},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=m.attr?m.attr(a,c):o.attrHandle[c]?o.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];return d==null?f==="!=":!f&&m.attr?d!=null:f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:g?f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":!1:e&&d!==!1},POS:function(a,b,c,d){var e=b[2],f=o.setFilters[e];if(f)return f(a,c,b,d)}}},p=o.match.POS,q=function(a,b){return"\\"+(b-0+1)};for(var r in o.match)o.match[r]=new RegExp(o.match[r].source+/(?![^\[]*\])(?![^\(]*\))/.source),o.leftMatch[r]=new RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[r].source.replace(/\\(\d+)/g,q));var s=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b}return a};try{Array.prototype.slice.call(c.documentElement.childNodes,0)[0].nodeType}catch(t){s=function(a,b){var c=0,d=b||[];if(g.call(a)==="[object Array]")Array.prototype.push.apply(d,a);else if(typeof a.length=="number")for(var e=a.length;c<e;c++)d.push(a[c]);else for(;a[c];c++)d.push(a[c]);return d}}var u,v;c.documentElement.compareDocumentPosition?u=function(a,b){if(a===b){h=!0;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition)return a.compareDocumentPosition?-1:1;return a.compareDocumentPosition(b)&4?-1:1}:(u=function(a,b){if(a===b){h=!0;return 0}if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],f=[],g=a.parentNode,i=b.parentNode,j=g;if(g===i)return v(a,b);if(!g)return-1;if(!i)return 1;while(j)e.unshift(j),j=j.parentNode;j=i;while(j)f.unshift(j),j=j.parentNode;c=e.length,d=f.length;for(var k=0;k<c&&k<d;k++)if(e[k]!==f[k])return v(e[k],f[k]);return k===c?v(a,f[k],-1):v(e[k],b,1)},v=function(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}),function(){var a=c.createElement("div"),d="script"+(new Date).getTime(),e=c.documentElement;a.innerHTML="<a name='"+d+"'/>",e.insertBefore(a,e.firstChild),c.getElementById(d)&&(o.find.ID=function(a,c,d){if(typeof c.getElementById!="undefined"&&!d){var e=c.getElementById(a[1]);return e?e.id===a[1]||typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id").nodeValue===a[1]?[e]:b:[]}},o.filter.ID=function(a,b){var c=typeof a.getAttributeNode!="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b}),e.removeChild(a),e=a=null}(),function(){var a=c.createElement("div");a.appendChild(c.createComment("")),a.getElementsByTagName("*").length>0&&(o.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);if(a[1]==="*"){var d=[];for(var e=0;c[e];e++)c[e].nodeType===1&&d.push(c[e]);c=d}return c}),a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!="undefined"&&a.firstChild.getAttribute("href")!=="#"&&(o.attrHandle.href=function(a){return a.getAttribute("href",2)}),a=null}(),c.querySelectorAll&&function(){var a=m,b=c.createElement("div"),d="__sizzle__";b.innerHTML="<p class='TEST'></p>";if(!b.querySelectorAll||b.querySelectorAll(".TEST").length!==0){m=function(b,e,f,g){e=e||c;if(!g&&!m.isXML(e)){var h=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);if(h&&(e.nodeType===1||e.nodeType===9)){if(h[1])return s(e.getElementsByTagName(b),f);if(h[2]&&o.find.CLASS&&e.getElementsByClassName)return s(e.getElementsByClassName(h[2]),f)}if(e.nodeType===9){if(b==="body"&&e.body)return s([e.body],f);if(h&&h[3]){var i=e.getElementById(h[3]);if(!i||!i.parentNode)return s([],f);if(i.id===h[3])return s([i],f)}try{return s(e.querySelectorAll(b),f)}catch(j){}}else if(e.nodeType===1&&e.nodeName.toLowerCase()!=="object"){var k=e,l=e.getAttribute("id"),n=l||d,p=e.parentNode,q=/^\s*[+~]/.test(b);l?n=n.replace(/'/g,"\\$&"):e.setAttribute("id",n),q&&p&&(e=e.parentNode);try{if(!q||p)return s(e.querySelectorAll("[id='"+n+"'] "+b),f)}catch(r){}finally{l||k.removeAttribute("id")}}}return a(b,e,f,g)};for(var e in a)m[e]=a[e];b=null}}(),function(){var a=c.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;if(b){var d=!b.call(c.createElement("div"),"div"),e=!1;try{b.call(c.documentElement,"[test!='']:sizzle")}catch(f){e=!0}m.matchesSelector=function(a,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!m.isXML(a))try{if(e||!o.match.PSEUDO.test(c)&&!/!=/.test(c)){var f=b.call(a,c);if(f||!d||a.document&&a.document.nodeType!==11)return f}}catch(g){}return m(c,null,null,[a]).length>0}}}(),function(){var a=c.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";if(!!a.getElementsByClassName&&a.getElementsByClassName("e").length!==0){a.lastChild.className="e";if(a.getElementsByClassName("e").length===1)return;o.order.splice(1,0,"CLASS"),o.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!="undefined"&&!c)return b.getElementsByClassName(a[1])},a=null}}(),c.documentElement.contains?m.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):!0)}:c.documentElement.compareDocumentPosition?m.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)}:m.contains=function(){return!1},m.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1};var y=function(a,b,c){var d,e=[],f="",g=b.nodeType?[b]:b;while(d=o.match.PSEUDO.exec(a))f+=d[0],a=a.replace(o.match.PSEUDO,"");a=o.relative[a]?a+"*":a;for(var h=0,i=g.length;h<i;h++)m(a,g[h],e,c);return m.filter(f,e)};m.attr=f.attr,m.selectors.attrMap={},f.find=m,f.expr=m.selectors,f.expr[":"]=f.expr.filters,f.unique=m.uniqueSort,f.text=m.getText,f.isXMLDoc=m.isXML,f.contains=m.contains}();var L=/Until$/,M=/^(?:parents|prevUntil|prevAll)/,N=/,/,O=/^.[^:#\[\.,]*$/,P=Array.prototype.slice,Q=f.expr.match.POS,R={children:!0,contents:!0,next:!0,prev:!0};f.fn.extend({find:function(a){var b=this,c,d;if(typeof a!="string")return f(a).filter(function(){for(c=0,d=b.length;c<d;c++)if(f.contains(b[c],this))return!0});var e=this.pushStack("","find",a),g,h,i;for(c=0,d=this.length;c<d;c++){g=e.length,f.find(a,this[c],e);if(c>0)for(h=g;h<e.length;h++)for(i=0;i<g;i++)if(e[i]===e[h]){e.splice(h--,1);break}}return e},has:function(a){var b=f(a);return this.filter(function(){for(var a=0,c=b.length;a<c;a++)if(f.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(T(this,a,!1),"not",a)},filter:function(a){return this.pushStack(T(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?Q.test(a)?f(a,this.context).index(this[0])>=0:f.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c=[],d,e,g=this[0];if(f.isArray(a)){var h=1;while(g&&g.ownerDocument&&g!==b){for(d=0;d<a.length;d++)f(g).is(a[d])&&c.push({selector:a[d],elem:g,level:h});g=g.parentNode,h++}return c}var i=Q.test(a)||typeof a!="string"?f(a,b||this.context):0;for(d=0,e=this.length;d<e;d++){g=this[d];while(g){if(i?i.index(g)>-1:f.find.matchesSelector(g,a)){c.push(g);break}g=g.parentNode;if(!g||!g.ownerDocument||g===b||g.nodeType===11)break}}c=c.length>1?f.unique(c):c;return this.pushStack(c,"closest",a)},index:function(a){if(!a)return this[0]&&this[0].parentNode?this.prevAll().length:-1;if(typeof a=="string")return f.inArray(this[0],f(a));return f.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var c=typeof a=="string"?f(a,b):f.makeArray(a&&a.nodeType?[a]:a),d=f.merge(this.get(),c);return this.pushStack(S(c[0])||S(d[0])?d:f.unique(d))},andSelf:function(){return this.add(this.prevObject)}}),f.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return f.dir(a,"parentNode")},parentsUntil:function(a,b,c){return f.dir(a,"parentNode",c)},next:function(a){return f.nth(a,2,"nextSibling")},prev:function(a){return f.nth(a,2,"previousSibling")},nextAll:function(a){return f.dir(a,"nextSibling")},prevAll:function(a){return f.dir(a,"previousSibling")},nextUntil:function(a,b,c){return f.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return f.dir(a,"previousSibling",c)},siblings:function(a){return f.sibling(a.parentNode.firstChild,a)},children:function(a){return f.sibling(a.firstChild)},contents:function(a){return f.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:f.makeArray(a.childNodes)}},function(a,b){f.fn[a]=function(c,d){var e=f.map(this,b,c);L.test(a)||(d=c),d&&typeof d=="string"&&(e=f.filter(d,e)),e=this.length>1&&!R[a]?f.unique(e):e,(this.length>1||N.test(d))&&M.test(a)&&(e=e.reverse());return this.pushStack(e,a,P.call(arguments).join(","))}}),f.extend({filter:function(a,b,c){c&&(a=":not("+a+")");return b.length===1?f.find.matchesSelector(b[0],a)?[b[0]]:[]:f.find.matches(a,b)},dir:function(a,c,d){var e=[],g=a[c];while(g&&g.nodeType!==9&&(d===b||g.nodeType!==1||!f(g).is(d)))g.nodeType===1&&e.push(g),g=g[c];return e},nth:function(a,b,c,d){b=b||1;var e=0;for(;a;a=a[c])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var V="abbr|article|aside|audio|canvas|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",W=/ jQuery\d+="(?:\d+|null)"/g,X=/^\s+/,Y=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,Z=/<([\w:]+)/,$=/<tbody/i,_=/<|&#?\w+;/,ba=/<(?:script|style)/i,bb=/<(?:script|object|embed|option|style)/i,bc=new RegExp("<(?:"+V+")","i"),bd=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/\/(java|ecma)script/i,bf=/^\s*<!(?:\[CDATA\[|\-\-)/,bg={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bh=U(c);bg.optgroup=bg.option,bg.tbody=bg.tfoot=bg.colgroup=bg.caption=bg.thead,bg.th=bg.td,f.support.htmlSerialize||(bg._default=[1,"div<div>","</div>"]),f.fn.extend({text:function(a){if(f.isFunction(a))return this.each(function(b){var c=f(this);c.text(a.call(this,b,c.text()))});if(typeof a!="object"&&a!==b)return this.empty().append((this[0]&&this[0].ownerDocument||c).createTextNode(a));return f.text(this)},wrapAll:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapAll(a.call(this,b))});if(this[0]){var b=f(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapInner(a.call(this,b))});return this.each(function(){var b=f(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=f.isFunction(a);return this.each(function(c){f(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){f.nodeName(this,"body")||f(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=f.clean(arguments);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,f.clean(arguments));return a}},remove:function(a,b){for(var c=0,d;(d=this[c])!=null;c++)if(!a||f.filter(a,[d]).length)!b&&d.nodeType===1&&(f.cleanData(d.getElementsByTagName("*")),f.cleanData([d])),d.parentNode&&d.parentNode.removeChild(d);return this},empty:function()
{for(var a=0,b;(b=this[a])!=null;a++){b.nodeType===1&&f.cleanData(b.getElementsByTagName("*"));while(b.firstChild)b.removeChild(b.firstChild)}return this},clone:function(a,b){a=a==null?!1:a,b=b==null?a:b;return this.map(function(){return f.clone(this,a,b)})},html:function(a){if(a===b)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(W,""):null;if(typeof a=="string"&&!ba.test(a)&&(f.support.leadingWhitespace||!X.test(a))&&!bg[(Z.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Y,"<$1></$2>");try{for(var c=0,d=this.length;c<d;c++)this[c].nodeType===1&&(f.cleanData(this[c].getElementsByTagName("*")),this[c].innerHTML=a)}catch(e){this.empty().append(a)}}else f.isFunction(a)?this.each(function(b){var c=f(this);c.html(a.call(this,b,c.html()))}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(f.isFunction(a))return this.each(function(b){var c=f(this),d=c.html();c.replaceWith(a.call(this,b,d))});typeof a!="string"&&(a=f(a).detach());return this.each(function(){var b=this.nextSibling,c=this.parentNode;f(this).remove(),b?f(b).before(a):f(c).append(a)})}return this.length?this.pushStack(f(f.isFunction(a)?a():a),"replaceWith",a):this},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){var e,g,h,i,j=a[0],k=[];if(!f.support.checkClone&&arguments.length===3&&typeof j=="string"&&bd.test(j))return this.each(function(){f(this).domManip(a,c,d,!0)});if(f.isFunction(j))return this.each(function(e){var g=f(this);a[0]=j.call(this,e,c?g.html():b),g.domManip(a,c,d)});if(this[0]){i=j&&j.parentNode,f.support.parentNode&&i&&i.nodeType===11&&i.childNodes.length===this.length?e={fragment:i}:e=f.buildFragment(a,this,k),h=e.fragment,h.childNodes.length===1?g=h=h.firstChild:g=h.firstChild;if(g){c=c&&f.nodeName(g,"tr");for(var l=0,m=this.length,n=m-1;l<m;l++)d.call(c?bi(this[l],g):this[l],e.cacheable||m>1&&l<n?f.clone(h,!0,!0):h)}k.length&&f.each(k,bp)}return this}}),f.buildFragment=function(a,b,d){var e,g,h,i,j=a[0];b&&b[0]&&(i=b[0].ownerDocument||b[0]),i.createDocumentFragment||(i=c),a.length===1&&typeof j=="string"&&j.length<512&&i===c&&j.charAt(0)==="<"&&!bb.test(j)&&(f.support.checkClone||!bd.test(j))&&(f.support.html5Clone||!bc.test(j))&&(g=!0,h=f.fragments[j],h&&h!==1&&(e=h)),e||(e=i.createDocumentFragment(),f.clean(a,i,e,d)),g&&(f.fragments[j]=h?e:1);return{fragment:e,cacheable:g}},f.fragments={},f.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){f.fn[a]=function(c){var d=[],e=f(c),g=this.length===1&&this[0].parentNode;if(g&&g.nodeType===11&&g.childNodes.length===1&&e.length===1){e[b](this[0]);return this}for(var h=0,i=e.length;h<i;h++){var j=(h>0?this.clone(!0):this).get();f(e[h])[b](j),d=d.concat(j)}return this.pushStack(d,a,e.selector)}}),f.extend({clone:function(a,b,c){var d,e,g,h=f.support.html5Clone||!bc.test("<"+a.nodeName)?a.cloneNode(!0):bo(a);if((!f.support.noCloneEvent||!f.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!f.isXMLDoc(a)){bk(a,h),d=bl(a),e=bl(h);for(g=0;d[g];++g)e[g]&&bk(d[g],e[g])}if(b){bj(a,h);if(c){d=bl(a),e=bl(h);for(g=0;d[g];++g)bj(d[g],e[g])}}d=e=null;return h},clean:function(a,b,d,e){var g;b=b||c,typeof b.createElement=="undefined"&&(b=b.ownerDocument||b[0]&&b[0].ownerDocument||c);var h=[],i;for(var j=0,k;(k=a[j])!=null;j++){typeof k=="number"&&(k+="");if(!k)continue;if(typeof k=="string")if(!_.test(k))k=b.createTextNode(k);else{k=k.replace(Y,"<$1></$2>");var l=(Z.exec(k)||["",""])[1].toLowerCase(),m=bg[l]||bg._default,n=m[0],o=b.createElement("div");b===c?bh.appendChild(o):U(b).appendChild(o),o.innerHTML=m[1]+k+m[2];while(n--)o=o.lastChild;if(!f.support.tbody){var p=$.test(k),q=l==="table"&&!p?o.firstChild&&o.firstChild.childNodes:m[1]==="<table>"&&!p?o.childNodes:[];for(i=q.length-1;i>=0;--i)f.nodeName(q[i],"tbody")&&!q[i].childNodes.length&&q[i].parentNode.removeChild(q[i])}!f.support.leadingWhitespace&&X.test(k)&&o.insertBefore(b.createTextNode(X.exec(k)[0]),o.firstChild),k=o.childNodes}var r;if(!f.support.appendChecked)if(k[0]&&typeof (r=k.length)=="number")for(i=0;i<r;i++)bn(k[i]);else bn(k);k.nodeType?h.push(k):h=f.merge(h,k)}if(d){g=function(a){return!a.type||be.test(a.type)};for(j=0;h[j];j++)if(e&&f.nodeName(h[j],"script")&&(!h[j].type||h[j].type.toLowerCase()==="text/javascript"))e.push(h[j].parentNode?h[j].parentNode.removeChild(h[j]):h[j]);else{if(h[j].nodeType===1){var s=f.grep(h[j].getElementsByTagName("script"),g);h.splice.apply(h,[j+1,0].concat(s))}d.appendChild(h[j])}}return h},cleanData:function(a){var b,c,d=f.cache,e=f.event.special,g=f.support.deleteExpando;for(var h=0,i;(i=a[h])!=null;h++){if(i.nodeName&&f.noData[i.nodeName.toLowerCase()])continue;c=i[f.expando];if(c){b=d[c];if(b&&b.events){for(var j in b.events)e[j]?f.event.remove(i,j):f.removeEvent(i,j,b.handle);b.handle&&(b.handle.elem=null)}g?delete i[f.expando]:i.removeAttribute&&i.removeAttribute(f.expando),delete d[c]}}}});var bq=/alpha\([^)]*\)/i,br=/opacity=([^)]*)/,bs=/([A-Z]|^ms)/g,bt=/^-?\d+(?:px)?$/i,bu=/^-?\d/,bv=/^([\-+])=([\-+.\de]+)/,bw={position:"absolute",visibility:"hidden",display:"block"},bx=["Left","Right"],by=["Top","Bottom"],bz,bA,bB;f.fn.css=function(a,c){if(arguments.length===2&&c===b)return this;return f.access(this,a,c,!0,function(a,c,d){return d!==b?f.style(a,c,d):f.css(a,c)})},f.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=bz(a,"opacity","opacity");return c===""?"1":c}return a.style.opacity}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":f.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!!a&&a.nodeType!==3&&a.nodeType!==8&&!!a.style){var g,h,i=f.camelCase(c),j=a.style,k=f.cssHooks[i];c=f.cssProps[i]||i;if(d===b){if(k&&"get"in k&&(g=k.get(a,!1,e))!==b)return g;return j[c]}h=typeof d,h==="string"&&(g=bv.exec(d))&&(d=+(g[1]+1)*+g[2]+parseFloat(f.css(a,c)),h="number");if(d==null||h==="number"&&isNaN(d))return;h==="number"&&!f.cssNumber[i]&&(d+="px");if(!k||!("set"in k)||(d=k.set(a,d))!==b)try{j[c]=d}catch(l){}}},css:function(a,c,d){var e,g;c=f.camelCase(c),g=f.cssHooks[c],c=f.cssProps[c]||c,c==="cssFloat"&&(c="float");if(g&&"get"in g&&(e=g.get(a,!0,d))!==b)return e;if(bz)return bz(a,c)},swap:function(a,b,c){var d={};for(var e in b)d[e]=a.style[e],a.style[e]=b[e];c.call(a);for(e in b)a.style[e]=d[e]}}),f.curCSS=f.css,f.each(["height","width"],function(a,b){f.cssHooks[b]={get:function(a,c,d){var e;if(c){if(a.offsetWidth!==0)return bC(a,b,d);f.swap(a,bw,function(){e=bC(a,b,d)});return e}},set:function(a,b){if(!bt.test(b))return b;b=parseFloat(b);if(b>=0)return b+"px"}}}),f.support.opacity||(f.cssHooks.opacity={get:function(a,b){return br.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=f.isNumeric(b)?"alpha(opacity="+b*100+")":"",g=d&&d.filter||c.filter||"";c.zoom=1;if(b>=1&&f.trim(g.replace(bq,""))===""){c.removeAttribute("filter");if(d&&!d.filter)return}c.filter=bq.test(g)?g.replace(bq,e):g+" "+e}}),f(function(){f.support.reliableMarginRight||(f.cssHooks.marginRight={get:function(a,b){var c;f.swap(a,{display:"inline-block"},function(){b?c=bz(a,"margin-right","marginRight"):c=a.style.marginRight});return c}})}),c.defaultView&&c.defaultView.getComputedStyle&&(bA=function(a,b){var c,d,e;b=b.replace(bs,"-$1").toLowerCase(),(d=a.ownerDocument.defaultView)&&(e=d.getComputedStyle(a,null))&&(c=e.getPropertyValue(b),c===""&&!f.contains(a.ownerDocument.documentElement,a)&&(c=f.style(a,b)));return c}),c.documentElement.currentStyle&&(bB=function(a,b){var c,d,e,f=a.currentStyle&&a.currentStyle[b],g=a.style;f===null&&g&&(e=g[b])&&(f=e),!bt.test(f)&&bu.test(f)&&(c=g.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),g.left=b==="fontSize"?"1em":f||0,f=g.pixelLeft+"px",g.left=c,d&&(a.runtimeStyle.left=d));return f===""?"auto":f}),bz=bA||bB,f.expr&&f.expr.filters&&(f.expr.filters.hidden=function(a){var b=a.offsetWidth,c=a.offsetHeight;return b===0&&c===0||!f.support.reliableHiddenOffsets&&(a.style&&a.style.display||f.css(a,"display"))==="none"},f.expr.filters.visible=function(a){return!f.expr.filters.hidden(a)});var bD=/%20/g,bE=/\[\]$/,bF=/\r?\n/g,bG=/#.*$/,bH=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,bI=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,bJ=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,bK=/^(?:GET|HEAD)$/,bL=/^\/\//,bM=/\?/,bN=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bO=/^(?:select|textarea)/i,bP=/\s+/,bQ=/([?&])_=[^&]*/,bR=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,bS=f.fn.load,bT={},bU={},bV,bW,bX=["*/"]+["*"];try{bV=e.href}catch(bY){bV=c.createElement("a"),bV.href="",bV=bV.href}bW=bR.exec(bV.toLowerCase())||[],f.fn.extend({load:function(a,c,d){if(typeof a!="string"&&bS)return bS.apply(this,arguments);if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var g=a.slice(e,a.length);a=a.slice(0,e)}var h="GET";c&&(f.isFunction(c)?(d=c,c=b):typeof c=="object"&&(c=f.param(c,f.ajaxSettings.traditional),h="POST"));var i=this;f.ajax({url:a,type:h,dataType:"html",data:c,complete:function(a,b,c){c=a.responseText,a.isResolved()&&(a.done(function(a){c=a}),i.html(g?f("<div>").append(c.replace(bN,"")).find(g):c)),d&&i.each(d,[c,b,a])}});return this},serialize:function(){return f.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?f.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||bO.test(this.nodeName)||bI.test(this.type))}).map(function(a,b){var c=f(this).val();return c==null?null:f.isArray(c)?f.map(c,function(a,c){return{name:b.name,value:a.replace(bF,"\r\n")}}):{name:b.name,value:c.replace(bF,"\r\n")}}).get()}}),f.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){f.fn[b]=function(a){return this.on(b,a)}}),f.each(["get","post"],function(a,c){f[c]=function(a,d,e,g){f.isFunction(d)&&(g=g||e,e=d,d=b);return f.ajax({type:c,url:a,data:d,success:e,dataType:g})}}),f.extend({getScript:function(a,c){return f.get(a,b,c,"script")},getJSON:function(a,b,c){return f.get(a,b,c,"json")},ajaxSetup:function(a,b){b?b_(a,f.ajaxSettings):(b=a,a=f.ajaxSettings),b_(a,b);return a},ajaxSettings:{url:bV,isLocal:bJ.test(bW[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":bX},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":f.parseJSON,"text xml":f.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:bZ(bT),ajaxTransport:bZ(bU),ajax:function(a,c){function w(a,c,l,m){if(s!==2){s=2,q&&clearTimeout(q),p=b,n=m||"",v.readyState=a>0?4:0;var o,r,u,w=c,x=l?cb(d,v,l):b,y,z;if(a>=200&&a<300||a===304){if(d.ifModified){if(y=v.getResponseHeader("Last-Modified"))f.lastModified[k]=y;if(z=v.getResponseHeader("Etag"))f.etag[k]=z}if(a===304)w="notmodified",o=!0;else try{r=cc(d,x),w="success",o=!0}catch(A){w="parsererror",u=A}}else{u=w;if(!w||a)w="error",a<0&&(a=0)}v.status=a,v.statusText=""+(c||w),o?h.resolveWith(e,[r,w,v]):h.rejectWith(e,[v,w,u]),v.statusCode(j),j=b,t&&g.trigger("ajax"+(o?"Success":"Error"),[v,d,o?r:u]),i.fireWith(e,[v,w]),t&&(g.trigger("ajaxComplete",[v,d]),--f.active||f.event.trigger("ajaxStop"))}}typeof a=="object"&&(c=a,a=b),c=c||{};var d=f.ajaxSetup({},c),e=d.context||d,g=e!==d&&(e.nodeType||e instanceof f)?f(e):f.event,h=f.Deferred(),i=f.Callbacks("once memory"),j=d.statusCode||{},k,l={},m={},n,o,p,q,r,s=0,t,u,v={readyState:0,setRequestHeader:function(a,b){if(!s){var c=a.toLowerCase();a=m[c]=m[c]||a,l[a]=b}return this},getAllResponseHeaders:function(){return s===2?n:null},getResponseHeader:function(a){var c;if(s===2){if(!o){o={};while(c=bH.exec(n))o[c[1].toLowerCase()]=c[2]}c=o[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){s||(d.mimeType=a);return this},abort:function(a){a=a||"abort",p&&p.abort(a),w(0,a);return this}};h.promise(v),v.success=v.done,v.error=v.fail,v.complete=i.add,v.statusCode=function(a){if(a){var b;if(s<2)for(b in a)j[b]=[j[b],a[b]];else b=a[v.status],v.then(b,b)}return this},d.url=((a||d.url)+"").replace(bG,"").replace(bL,bW[1]+"//"),d.dataTypes=f.trim(d.dataType||"*").toLowerCase().split(bP),d.crossDomain==null&&(r=bR.exec(d.url.toLowerCase()),d.crossDomain=!(!r||r[1]==bW[1]&&r[2]==bW[2]&&(r[3]||(r[1]==="http:"?80:443))==(bW[3]||(bW[1]==="http:"?80:443)))),d.data&&d.processData&&typeof d.data!="string"&&(d.data=f.param(d.data,d.traditional)),b$(bT,d,c,v);if(s===2)return!1;t=d.global,d.type=d.type.toUpperCase(),d.hasContent=!bK.test(d.type),t&&f.active++===0&&f.event.trigger("ajaxStart");if(!d.hasContent){d.data&&(d.url+=(bM.test(d.url)?"&":"?")+d.data,delete d.data),k=d.url;if(d.cache===!1){var x=f.now(),y=d.url.replace(bQ,"$1_="+x);d.url=y+(y===d.url?(bM.test(d.url)?"&":"?")+"_="+x:"")}}(d.data&&d.hasContent&&d.contentType!==!1||c.contentType)&&v.setRequestHeader("Content-Type",d.contentType),d.ifModified&&(k=k||d.url,f.lastModified[k]&&v.setRequestHeader("If-Modified-Since",f.lastModified[k]),f.etag[k]&&v.setRequestHeader("If-None-Match",f.etag[k])),v.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+(d.dataTypes[0]!=="*"?", "+bX+"; q=0.01":""):d.accepts["*"]);for(u in d.headers)v.setRequestHeader(u,d.headers[u]);if(d.beforeSend&&(d.beforeSend.call(e,v,d)===!1||s===2)){v.abort();return!1}for(u in{success:1,error:1,complete:1})v[u](d[u]);p=b$(bU,d,c,v);if(!p)w(-1,"No Transport");else{v.readyState=1,t&&g.trigger("ajaxSend",[v,d]),d.async&&d.timeout>0&&(q=setTimeout(function(){v.abort("timeout")},d.timeout));try{s=1,p.send(l,w)}catch(z){if(s<2)w(-1,z);else throw z}}return v},param:function(a,c){var d=[],e=function(a,b){b=f.isFunction(b)?b():b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=f.ajaxSettings.traditional);if(f.isArray(a)||a.jquery&&!f.isPlainObject(a))f.each(a,function(){e(this.name,this.value)});else for(var g in a)ca(g,a[g],c,e);return d.join("&").replace(bD,"+")}}),f.extend({active:0,lastModified:{},etag:{}});var cd=f.now(),ce=/(\=)\?(&|$)|\?\?/i;f.ajaxSetup({jsonp:"callback",jsonpCallback:function(){return f.expando+"_"+cd++}}),f.ajaxPrefilter("json jsonp",function(b,c,d){var e=b.contentType==="application/x-www-form-urlencoded"&&typeof b.data=="string";if(b.dataTypes[0]==="jsonp"||b.jsonp!==!1&&(ce.test(b.url)||e&&ce.test(b.data))){var g,h=b.jsonpCallback=f.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,i=a[h],j=b.url,k=b.data,l="$1"+h+"$2";b.jsonp!==!1&&(j=j.replace(ce,l),b.url===j&&(e&&(k=k.replace(ce,l)),b.data===k&&(j+=(/\?/.test(j)?"&":"?")+b.jsonp+"="+h))),b.url=j,b.data=k,a[h]=function(a){g=[a]},d.always(function(){a[h]=i,g&&f.isFunction(i)&&a[h](g[0])}),b.converters["script json"]=function(){g||f.error(h+" was not called");return g[0]},b.dataTypes[0]="json";return"script"}}),f.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){f.globalEval(a);return a}}}),f.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),f.ajaxTransport("script",function(a){if(a.crossDomain){var d,e=c.head||c.getElementsByTagName("head")[0]||c.documentElement;return{send:function(f,g){d=c.createElement("script"),d.async="async",a.scriptCharset&&(d.charset=a.scriptCharset),d.src=a.url,d.onload=d.onreadystatechange=function(a,c){if(c||!d.readyState||/loaded|complete/.test(d.readyState))d.onload=d.onreadystatechange=null,e&&d.parentNode&&e.removeChild(d),d=b,c||g(200,"success")},e.insertBefore(d,e.firstChild)},abort:function(){d&&d.onload(0,1)}}}});var cf=a.ActiveXObject?function(){for(var a in ch)ch[a](0,1)}:!1,cg=0,ch;f.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&ci()||cj()}:ci,function(a){f.extend(f.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(f.ajaxSettings.xhr()),f.support.ajax&&f.ajaxTransport(function(c){if(!c.crossDomain||f.support.cors){var d;return{send:function(e,g){var h=c.xhr(),i,j;c.username?h.open(c.type,c.url,c.async,c.username,c.password):h.open(c.type,c.url,c.async);if(c.xhrFields)for(j in c.xhrFields)h[j]=c.xhrFields[j];c.mimeType&&h.overrideMimeType&&h.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(j in e)h.setRequestHeader(j,e[j])}catch(k){}h.send(c.hasContent&&c.data||null),d=function(a,e){var j,k,l,m,n;try{if(d&&(e||h.readyState===4)){d=b,i&&(h.onreadystatechange=f.noop,cf&&delete ch[i]);if(e)h.readyState!==4&&h.abort();else{j=h.status,l=h.getAllResponseHeaders(),m={},n=h.responseXML,n&&n.documentElement&&(m.xml=n),m.text=h.responseText;try{k=h.statusText}catch(o){k=""}!j&&c.isLocal&&!c.crossDomain?j=m.text?200:404:j===1223&&(j=204)}}}catch(p){e||g(-1,p)}m&&g(j,k,m,l)},!c.async||h.readyState===4?d():(i=++cg,cf&&(ch||(ch={},f(a).unload(cf)),ch[i]=d),h.onreadystatechange=d)},abort:function(){d&&d(0,1)}}}});var ck={},cl,cm,cn=/^(?:toggle|show|hide)$/,co=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,cp,cq=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]],cr;f.fn.extend({show:function(a,b,c){var d,e;if(a||a===0)return this.animate(cu("show",3),a,b,c);for(var g=0,h=this.length;g<h;g++)d=this[g],d.style&&(e=d.style.display,!f._data(d,"olddisplay")&&e==="none"&&(e=d.style.display=""),e===""&&f.css(d,"display")==="none"&&f._data(d,"olddisplay",cv(d.nodeName)));for(g=0;g<h;g++){d=this[g];if(d.style){e=d.style.display;if(e===""||e==="none")d.style.display=f._data(d,"olddisplay")||""}}return this},hide:function(a,b,c){if(a||a===0)return this.animate(cu("hide",3),a,b,c);var d,e,g=0,h=this.length;for(;g<h;g++)d=this[g],d.style&&(e=f.css(d,"display"),e!=="none"&&!f._data(d,"olddisplay")&&f._data(d,"olddisplay",e));for(g=0;g<h;g++)this[g].style&&(this[g].style.display="none");return this},_toggle:f.fn.toggle,toggle:function(a,b,c){var d=typeof a=="boolean";f.isFunction(a)&&f.isFunction(b)?this._toggle.apply(this,arguments):a==null||d?this.each(function(){var b=d?a:f(this).is(":hidden");f(this)[b?"show":"hide"]()}):this.animate(cu("toggle",3),a,b,c);return this},fadeTo:function(a,b,c,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){function g(){e.queue===!1&&f._mark(this);var b=f.extend({},e),c=this.nodeType===1,d=c&&f(this).is(":hidden"),g,h,i,j,k,l,m,n,o;b.animatedProperties={};for(i in a){g=f.camelCase(i),i!==g&&(a[g]=a[i],delete a[i]),h=a[g],f.isArray(h)?(b.animatedProperties[g]=h[1],h=a[g]=h[0]):b.animatedProperties[g]=b.specialEasing&&b.specialEasing[g]||b.easing||"swing";if(h==="hide"&&d||h==="show"&&!d)return b.complete.call(this);c&&(g==="height"||g==="width")&&(b.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY],f.css(this,"display")==="inline"&&f.css(this,"float")==="none"&&(!f.support.inlineBlockNeedsLayout||cv(this.nodeName)==="inline"?this.style.display="inline-block":this.style.zoom=1))}b.overflow!=null&&(this.style.overflow="hidden");for(i in a)j=new f.fx(this,b,i),h=a[i],cn.test(h)?(o=f._data(this,"toggle"+i)||(h==="toggle"?d?"show":"hide":0),o?(f._data(this,"toggle"+i,o==="show"?"hide":"show"),j[o]()):j[h]()):(k=co.exec(h),l=j.cur(),k?(m=parseFloat(k[2]),n=k[3]||(f.cssNumber[i]?"":"px"),n!=="px"&&(f.style(this,i,(m||1)+n),l=(m||1)/j.cur()*l,f.style(this,i,l+n)),k[1]&&(m=(k[1]==="-="?-1:1)*m+l),j.custom(l,m,n)):j.custom(l,h,""));return!0}var e=f.speed(b,c,d);if(f.isEmptyObject(a))return this.each(e.complete,[!1]);a=f.extend({},a);return e.queue===!1?this.each(g):this.queue(e.queue,g)},stop:function(a,c,d){typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]);return this.each(function(){function h(a,b,c){var e=b[c];f.removeData(a,c,!0),e.stop(d)}var b,c=!1,e=f.timers,g=f._data(this);d||f._unmark(!0,this);if(a==null)for(b in g)g[b]&&g[b].stop&&b.indexOf(".run")===b.length-4&&h(this,g,b);else g[b=a+".run"]&&g[b].stop&&h(this,g,b);for(b=e.length;b--;)e[b].elem===this&&(a==null||e[b].queue===a)&&(d?e[b](!0):e[b].saveState(),c=!0,e.splice(b,1));(!d||!c)&&f.dequeue(this,a)})}}),f.each({slideDown:cu("show",1),slideUp:cu("hide",1),slideToggle:cu("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){f.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),f.extend({speed:function(a,b,c){var d=a&&typeof a=="object"?f.extend({},a):{complete:c||!c&&b||f.isFunction(a)&&a,duration:a,easing:c&&b||b&&!f.isFunction(b)&&b};d.duration=f.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in f.fx.speeds?f.fx.speeds[d.duration]:f.fx.speeds._default;if(d.queue==null||d.queue===!0)d.queue="fx";d.old=d.complete,d.complete=function(a){f.isFunction(d.old)&&d.old.call(this),d.queue?f.dequeue(this,d.queue):a!==!1&&f._unmark(this)};return d},easing:{linear:function(a,b,c,d){return c+d*a},swing:function(a,b,c,d){return(-Math.cos(a*Math.PI)/2+.5)*d+c}},timers:[],fx:function(a,b,c){this.options=b,this.elem=a,this.prop=c,b.orig=b.orig||{}}}),f.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this),(f.fx.step[this.prop]||f.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a,b=f.css(this.elem,this.prop);return isNaN(a=parseFloat(b))?!b||b==="auto"?0:b:a},custom:function(a,c,d){function h(a){return e.step(a)}var e=this,g=f.fx;this.startTime=cr||cs(),this.end=c,this.now=this.start=a,this.pos=this.state=0,this.unit=d||this.unit||(f.cssNumber[this.prop]?"":"px"),h.queue=this.options.queue,h.elem=this.elem,h.saveState=function(){e.options.hide&&f._data(e.elem,"fxshow"+e.prop)===b&&f._data(e.elem,"fxshow"+e.prop,e.start)},h()&&f.timers.push(h)&&!cp&&(cp=setInterval(g.tick,g.interval))},show:function(){var a=f._data(this.elem,"fxshow"+this.prop);this.options.orig[this.prop]=a||f.style(this.elem,this.prop),this.options.show=!0,a!==b?this.custom(this.cur(),a):this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur()),f(this.elem).show()},hide:function(){this.options.orig[this.prop]=f._data(this.elem,"fxshow"+this.prop)||f.style(this.elem,this.prop),this.options.hide=!0,this.custom(this.cur(),0)},step:function(a){var b,c,d,e=cr||cs(),g=!0,h=this.elem,i=this.options;if(a||e>=i.duration+this.startTime){this.now=this.end,this.pos=this.state=1,this.update(),i.animatedProperties[this.prop]=!0;for(b in i.animatedProperties)i.animatedProperties[b]!==!0&&(g=!1);if(g){i.overflow!=null&&!f.support.shrinkWrapBlocks&&f.each(["","X","Y"],function(a,b){h.style["overflow"+b]=i.overflow[a]}),i.hide&&f(h).hide();if(i.hide||i.show)for(b in i.animatedProperties)f.style(h,b,i.orig[b]),f.removeData(h,"fxshow"+b,!0),f.removeData(h,"toggle"+b,!0);d=i.complete,d&&(i.complete=!1,d.call(h))}return!1}i.duration==Infinity?this.now=e:(c=e-this.startTime,this.state=c/i.duration,this.pos=f.easing[i.animatedProperties[this.prop]](this.state,c,0,1,i.duration),this.now=this.start+(this.end-this.start)*this.pos),this.update();return!0}},f.extend(f.fx,{tick:function(){var a,b=f.timers,c=0;for(;c<b.length;c++)a=b[c],!a()&&b[c]===a&&b.splice(c--,1);b.length||f.fx.stop()},interval:13,stop:function(){clearInterval(cp),cp=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){f.style(a.elem,"opacity",a.now)},_default:function(a){a.elem.style&&a.elem.style[a.prop]!=null?a.elem.style[a.prop]=a.now+a.unit:a.elem[a.prop]=a.now}}}),f.each(["width","height"],function(a,b){f.fx.step[b]=function(a){f.style(a.elem,b,Math.max(0,a.now)+a.unit)}}),f.expr&&f.expr.filters&&(f.expr.filters.animated=function(a){return f.grep(f.timers,function(b){return a===b.elem}).length});var cw=/^t(?:able|d|h)$/i,cx=/^(?:body|html)$/i;"getBoundingClientRect"in c.documentElement?f.fn.offset=function(a){var b=this[0],c;if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);try{c=b.getBoundingClientRect()}catch(d){}var e=b.ownerDocument,g=e.documentElement;if(!c||!f.contains(g,b))return c?{top:c.top,left:c.left}:{top:0,left:0};var h=e.body,i=cy(e),j=g.clientTop||h.clientTop||0,k=g.clientLeft||h.clientLeft||0,l=i.pageYOffset||f.support.boxModel&&g.scrollTop||h.scrollTop,m=i.pageXOffset||f.support.boxModel&&g.scrollLeft||h.scrollLeft,n=c.top+l-j,o=c.left+m-k;return{top:n,left:o}}:f.fn.offset=function(a){var b=this[0];if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);var c,d=b.offsetParent,e=b,g=b.ownerDocument,h=g.documentElement,i=g.body,j=g.defaultView,k=j?j.getComputedStyle(b,null):b.currentStyle,l=b.offsetTop,m=b.offsetLeft;while((b=b.parentNode)&&b!==i&&b!==h){if(f.support.fixedPosition&&k.position==="fixed")break;c=j?j.getComputedStyle(b,null):b.currentStyle,l-=b.scrollTop,m-=b.scrollLeft,b===d&&(l+=b.offsetTop,m+=b.offsetLeft,f.support.doesNotAddBorder&&(!f.support.doesAddBorderForTableAndCells||!cw.test(b.nodeName))&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),e=d,d=b.offsetParent),f.support.subtractsBorderForOverflowNotVisible&&c.overflow!=="visible"&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),k=c}if(k.position==="relative"||k.position==="static")l+=i.offsetTop,m+=i.offsetLeft;f.support.fixedPosition&&k.position==="fixed"&&(l+=Math.max(h.scrollTop,i.scrollTop),m+=Math.max(h.scrollLeft,i.scrollLeft));return{top:l,left:m}},f.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;f.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(f.css(a,"marginTop"))||0,c+=parseFloat(f.css(a,"marginLeft"))||0);return{top:b,left:c}},setOffset:function(a,b,c){var d=f.css(a,"position");d==="static"&&(a.style.position="relative");var e=f(a),g=e.offset(),h=f.css(a,"top"),i=f.css(a,"left"),j=(d==="absolute"||d==="fixed")&&f.inArray("auto",[h,i])>-1,k={},l={},m,n;j?(l=e.position(),m=l.top,n=l.left):(m=parseFloat(h)||0,n=parseFloat(i)||0),f.isFunction(b)&&(b=b.call(a,c,g)),b.top!=null&&(k.top=b.top-g.top+m),b.left!=null&&(k.left=b.left-g.left+n),"using"in b?b.using.call(a,k):e.css(k)}},f.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),c=this.offset(),d=cx.test(b[0].nodeName)?{top:0,left:0}:b.offset();c.top-=parseFloat(f.css(a,"marginTop"))||0,c.left-=parseFloat(f.css(a,"marginLeft"))||0,d.top+=parseFloat(f.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(f.css(b[0],"borderLeftWidth"))||0;return{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||c.body;while(a&&!cx.test(a.nodeName)&&f.css(a,"position")==="static")a=a.offsetParent;return a})}}),f.each(["Left","Top"],function(a,c){var d="scroll"+c;f.fn[d]=function(c){var e,g;if(c===b){e=this[0];if(!e)return null;g=cy(e);return g?"pageXOffset"in g?g[a?"pageYOffset":"pageXOffset"]:f.support.boxModel&&g.document.documentElement[d]||g.document.body[d]:e[d]}return this.each(function(){g=cy(this),g?g.scrollTo(a?f(g).scrollLeft():c,a?c:f(g).scrollTop()):this[d]=c})}}),f.each(["Height","Width"],function(a,c){var d=c.toLowerCase();f.fn["inner"+c]=function(){var a=this[0];return a?a.style?parseFloat(f.css(a,d,"padding")):this[d]():null},f.fn["outer"+c]=function(a){var b=this[0];return b?b.style?parseFloat(f.css(b,d,a?"margin":"border")):this[d]():null},f.fn[d]=function(a){var e=this[0];if(!e)return a==null?null:this;if(f.isFunction(a))return this.each(function(b){var c=f(this);c[d](a.call(this,b,c[d]()))});if(f.isWindow(e)){var g=e.document.documentElement["client"+c],h=e.document.body;return e.document.compatMode==="CSS1Compat"&&g||h&&h["client"+c]||g}if(e.nodeType===9)return Math.max(e.documentElement["client"+c],e.body["scroll"+c],e.documentElement["scroll"+c],e.body["offset"+c],e.documentElement["offset"+c]);if(a===b){var i=f.css(e,d),j=parseFloat(i);return f.isNumeric(j)?j:i}return this.css(d,typeof a=="string"?a:a+"px")}}),a.jQuery=a.$=f,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return f})})(window);
(function($){$.extend({tablesorter:new
function(){var parsers=[],widgets=[];this.defaults={cssHeader:"header",cssAsc:"headerSortUp",cssDesc:"headerSortDown",cssChildRow:"expand-child",sortInitialOrder:"asc",sortMultiSortKey:"shiftKey",sortForce:null,sortAppend:null,sortLocaleCompare:true,textExtraction:"simple",parsers:{},widgets:[],widgetZebra:{css:["even","odd"]},headers:{},widthFixed:false,cancelSelection:true,sortList:[],headerList:[],dateFormat:"us",decimal:'/\.|\,/g',onRenderHeader:null,selectorHeaders:'thead th',debug:false};function benchmark(s,d){log(s+","+(new Date().getTime()-d.getTime())+"ms");}this.benchmark=benchmark;function log(s){if(typeof console!="undefined"&&typeof console.debug!="undefined"){console.log(s);}else{alert(s);}}function buildParserCache(table,$headers){if(table.config.debug){var parsersDebug="";}if(table.tBodies.length==0)return;var rows=table.tBodies[0].rows;if(rows[0]){var list=[],cells=rows[0].cells,l=cells.length;for(var i=0;i<l;i++){var p=false;if($.metadata&&($($headers[i]).metadata()&&$($headers[i]).metadata().sorter)){p=getParserById($($headers[i]).metadata().sorter);}else if((table.config.headers[i]&&table.config.headers[i].sorter)){p=getParserById(table.config.headers[i].sorter);}if(!p){p=detectParserForColumn(table,rows,-1,i);}if(table.config.debug){parsersDebug+="column:"+i+" parser:"+p.id+"\n";}list.push(p);}}if(table.config.debug){log(parsersDebug);}return list;};function detectParserForColumn(table,rows,rowIndex,cellIndex){var l=parsers.length,node=false,nodeValue=false,keepLooking=true;while(nodeValue==''&&keepLooking){rowIndex++;if(rows[rowIndex]){node=getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex);nodeValue=trimAndGetNodeText(table.config,node);if(table.config.debug){log('Checking if value was empty on row:'+rowIndex);}}else{keepLooking=false;}}for(var i=1;i<l;i++){if(parsers[i].is(nodeValue,table,node)){return parsers[i];}}return parsers[0];}function getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex){return rows[rowIndex].cells[cellIndex];}function trimAndGetNodeText(config,node){return $.trim(getElementText(config,node));}function getParserById(name){var l=parsers.length;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==name.toLowerCase()){return parsers[i];}}return false;}function buildCache(table){if(table.config.debug){var cacheTime=new Date();}var totalRows=(table.tBodies[0]&&table.tBodies[0].rows.length)||0,totalCells=(table.tBodies[0].rows[0]&&table.tBodies[0].rows[0].cells.length)||0,parsers=table.config.parsers,cache={row:[],normalized:[]};for(var i=0;i<totalRows;++i){var c=$(table.tBodies[0].rows[i]),cols=[];if(c.hasClass(table.config.cssChildRow)){cache.row[cache.row.length-1]=cache.row[cache.row.length-1].add(c);continue;}cache.row.push(c);for(var j=0;j<totalCells;++j){cols.push(parsers[j].format(getElementText(table.config,c[0].cells[j]),table,c[0].cells[j]));}cols.push(cache.normalized.length);cache.normalized.push(cols);cols=null;};if(table.config.debug){benchmark("Building cache for "+totalRows+" rows:",cacheTime);}return cache;};function getElementText(config,node){var text="";if(!node)return"";if(!config.supportsTextContent)config.supportsTextContent=node.textContent||false;if(config.textExtraction=="simple"){if(config.supportsTextContent){text=node.textContent;}else{if(node.childNodes[0]&&node.childNodes[0].hasChildNodes()){text=node.childNodes[0].innerHTML;}else{text=node.innerHTML;}}}else{if(typeof(config.textExtraction)=="function"){text=config.textExtraction(node);}else{text=$(node).text();}}return text;}function appendToTable(table,cache){if(table.config.debug){var appendTime=new Date()}var c=cache,r=c.row,n=c.normalized,totalRows=n.length,checkCell=(n[0].length-1),tableBody=$(table.tBodies[0]),rows=[];for(var i=0;i<totalRows;i++){var pos=n[i][checkCell];rows.push(r[pos]);if(!table.config.appender){var l=r[pos].length;for(var j=0;j<l;j++){tableBody[0].appendChild(r[pos][j]);}}}if(table.config.appender){table.config.appender(table,rows);}rows=null;if(table.config.debug){benchmark("Rebuilt table:",appendTime);}applyWidget(table);setTimeout(function(){$(table).trigger("sortEnd");},0);};function buildHeaders(table){if(table.config.debug){var time=new Date();}var meta=($.metadata)?true:false;var header_index=computeTableHeaderCellIndexes(table);$tableHeaders=$(table.config.selectorHeaders,table).each(function(index){this.column=header_index[this.parentNode.rowIndex+"-"+this.cellIndex];this.order=formatSortingOrder(table.config.sortInitialOrder);this.count=this.order;if(checkHeaderMetadata(this)||checkHeaderOptions(table,index))this.sortDisabled=true;if(checkHeaderOptionsSortingLocked(table,index))this.order=this.lockedOrder=checkHeaderOptionsSortingLocked(table,index);if(!this.sortDisabled){var $th=$(this).addClass(table.config.cssHeader);if(table.config.onRenderHeader)table.config.onRenderHeader.apply($th);}table.config.headerList[index]=this;});if(table.config.debug){benchmark("Built headers:",time);log($tableHeaders);}return $tableHeaders;};function computeTableHeaderCellIndexes(t){var matrix=[];var lookup={};var thead=t.getElementsByTagName('THEAD')[0];var trs=thead.getElementsByTagName('TR');for(var i=0;i<trs.length;i++){var cells=trs[i].cells;for(var j=0;j<cells.length;j++){var c=cells[j];var rowIndex=c.parentNode.rowIndex;var cellId=rowIndex+"-"+c.cellIndex;var rowSpan=c.rowSpan||1;var colSpan=c.colSpan||1
var firstAvailCol;if(typeof(matrix[rowIndex])=="undefined"){matrix[rowIndex]=[];}for(var k=0;k<matrix[rowIndex].length+1;k++){if(typeof(matrix[rowIndex][k])=="undefined"){firstAvailCol=k;break;}}lookup[cellId]=firstAvailCol;for(var k=rowIndex;k<rowIndex+rowSpan;k++){if(typeof(matrix[k])=="undefined"){matrix[k]=[];}var matrixrow=matrix[k];for(var l=firstAvailCol;l<firstAvailCol+colSpan;l++){matrixrow[l]="x";}}}}return lookup;}function checkCellColSpan(table,rows,row){var arr=[],r=table.tHead.rows,c=r[row].cells;for(var i=0;i<c.length;i++){var cell=c[i];if(cell.colSpan>1){arr=arr.concat(checkCellColSpan(table,headerArr,row++));}else{if(table.tHead.length==1||(cell.rowSpan>1||!r[row+1])){arr.push(cell);}}}return arr;};function checkHeaderMetadata(cell){if(($.metadata)&&($(cell).metadata().sorter===false)){return true;};return false;}function checkHeaderOptions(table,i){if((table.config.headers[i])&&(table.config.headers[i].sorter===false)){return true;};return false;}function checkHeaderOptionsSortingLocked(table,i){if((table.config.headers[i])&&(table.config.headers[i].lockedOrder))return table.config.headers[i].lockedOrder;return false;}function applyWidget(table){var c=table.config.widgets;var l=c.length;for(var i=0;i<l;i++){getWidgetById(c[i]).format(table);}}function getWidgetById(name){var l=widgets.length;for(var i=0;i<l;i++){if(widgets[i].id.toLowerCase()==name.toLowerCase()){return widgets[i];}}};function formatSortingOrder(v){if(typeof(v)!="Number"){return(v.toLowerCase()=="desc")?1:0;}else{return(v==1)?1:0;}}function isValueInArray(v,a){var l=a.length;for(var i=0;i<l;i++){if(a[i][0]==v){return true;}}return false;}function setHeadersCss(table,$headers,list,css){$headers.removeClass(css[0]).removeClass(css[1]);var h=[];$headers.each(function(offset){if(!this.sortDisabled){h[this.column]=$(this);}});var l=list.length;for(var i=0;i<l;i++){h[list[i][0]].addClass(css[list[i][1]]);}}function fixColumnWidth(table,$headers){var c=table.config;if(c.widthFixed){var colgroup=$('<colgroup>');$("tr:first td",table.tBodies[0]).each(function(){colgroup.append($('<col>').css('width',$(this).width()));});$(table).prepend(colgroup);};}function updateHeaderSortCount(table,sortList){var c=table.config,l=sortList.length;for(var i=0;i<l;i++){var s=sortList[i],o=c.headerList[s[0]];o.count=s[1];o.count++;}}function multisort(table,sortList,cache){if(table.config.debug){var sortTime=new Date();}var dynamicExp="var sortWrapper = function(a,b) {",l=sortList.length;for(var i=0;i<l;i++){var c=sortList[i][0];var order=sortList[i][1];var s=(table.config.parsers[c].type=="text")?((order==0)?makeSortFunction("text","asc",c):makeSortFunction("text","desc",c)):((order==0)?makeSortFunction("numeric","asc",c):makeSortFunction("numeric","desc",c));var e="e"+i;dynamicExp+="var "+e+" = "+s;dynamicExp+="if("+e+") { return "+e+"; } ";dynamicExp+="else { ";}var orgOrderCol=cache.normalized[0].length-1;dynamicExp+="return a["+orgOrderCol+"]-b["+orgOrderCol+"];";for(var i=0;i<l;i++){dynamicExp+="}; ";}dynamicExp+="return 0; ";dynamicExp+="}; ";if(table.config.debug){benchmark("Evaling expression:"+dynamicExp,new Date());}eval(dynamicExp);cache.normalized.sort(sortWrapper);if(table.config.debug){benchmark("Sorting on "+sortList.toString()+" and dir "+order+" time:",sortTime);}return cache;};function makeSortFunction(type,direction,index){var a="a["+index+"]",b="b["+index+"]";if(type=='text'&&direction=='asc'){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+a+" < "+b+") ? -1 : 1 )));";}else if(type=='text'&&direction=='desc'){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+b+" < "+a+") ? -1 : 1 )));";}else if(type=='numeric'&&direction=='asc'){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+a+" - "+b+"));";}else if(type=='numeric'&&direction=='desc'){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+b+" - "+a+"));";}};function makeSortText(i){return"((a["+i+"] < b["+i+"]) ? -1 : ((a["+i+"] > b["+i+"]) ? 1 : 0));";};function makeSortTextDesc(i){return"((b["+i+"] < a["+i+"]) ? -1 : ((b["+i+"] > a["+i+"]) ? 1 : 0));";};function makeSortNumeric(i){return"a["+i+"]-b["+i+"];";};function makeSortNumericDesc(i){return"b["+i+"]-a["+i+"];";};function sortText(a,b){if(table.config.sortLocaleCompare)return a.localeCompare(b);return((a<b)?-1:((a>b)?1:0));};function sortTextDesc(a,b){if(table.config.sortLocaleCompare)return b.localeCompare(a);return((b<a)?-1:((b>a)?1:0));};function sortNumeric(a,b){return a-b;};function sortNumericDesc(a,b){return b-a;};function getCachedSortType(parsers,i){return parsers[i].type;};this.construct=function(settings){return this.each(function(){if(!this.tHead||!this.tBodies)return;var $this,$document,$headers,cache,config,shiftDown=0,sortOrder;this.config={};config=$.extend(this.config,$.tablesorter.defaults,settings);$this=$(this);$.data(this,"tablesorter",config);$headers=buildHeaders(this);this.config.parsers=buildParserCache(this,$headers);cache=buildCache(this);var sortCSS=[config.cssDesc,config.cssAsc];fixColumnWidth(this);$headers.click(function(e){var totalRows=($this[0].tBodies[0]&&$this[0].tBodies[0].rows.length)||0;if(!this.sortDisabled&&totalRows>0){$this.trigger("sortStart");var $cell=$(this);var i=this.column;this.order=this.count++%2;if(this.lockedOrder)this.order=this.lockedOrder;if(!e[config.sortMultiSortKey]){config.sortList=[];if(config.sortForce!=null){var a=config.sortForce;for(var j=0;j<a.length;j++){if(a[j][0]!=i){config.sortList.push(a[j]);}}}config.sortList.push([i,this.order]);}else{if(isValueInArray(i,config.sortList)){for(var j=0;j<config.sortList.length;j++){var s=config.sortList[j],o=config.headerList[s[0]];if(s[0]==i){o.count=s[1];o.count++;s[1]=o.count%2;}}}else{config.sortList.push([i,this.order]);}};setTimeout(function(){setHeadersCss($this[0],$headers,config.sortList,sortCSS);appendToTable($this[0],multisort($this[0],config.sortList,cache));},1);return false;}}).mousedown(function(){if(config.cancelSelection){this.onselectstart=function(){return false};return false;}});$this.bind("update",function(){var me=this;setTimeout(function(){me.config.parsers=buildParserCache(me,$headers);cache=buildCache(me);},1);}).bind("updateCell",function(e,cell){var config=this.config;var pos=[(cell.parentNode.rowIndex-1),cell.cellIndex];cache.normalized[pos[0]][pos[1]]=config.parsers[pos[1]].format(getElementText(config,cell),cell);}).bind("sorton",function(e,list){$(this).trigger("sortStart");config.sortList=list;var sortList=config.sortList;updateHeaderSortCount(this,sortList);setHeadersCss(this,$headers,sortList,sortCSS);appendToTable(this,multisort(this,sortList,cache));}).bind("appendCache",function(){appendToTable(this,cache);}).bind("applyWidgetId",function(e,id){getWidgetById(id).format(this);}).bind("applyWidgets",function(){applyWidget(this);});if($.metadata&&($(this).metadata()&&$(this).metadata().sortlist)){config.sortList=$(this).metadata().sortlist;}if(config.sortList.length>0){$this.trigger("sorton",[config.sortList]);}applyWidget(this);});};this.addParser=function(parser){var l=parsers.length,a=true;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==parser.id.toLowerCase()){a=false;}}if(a){parsers.push(parser);};};this.addWidget=function(widget){widgets.push(widget);};this.formatFloat=function(s){var i=parseFloat(s);return(isNaN(i))?0:i;};this.formatInt=function(s){var i=parseInt(s);return(isNaN(i))?0:i;};this.isDigit=function(s,config){return/^[-+]?\d*$/.test($.trim(s.replace(/[,.']/g,'')));};this.clearTableBody=function(table){if($.browser.msie){function empty(){while(this.firstChild)this.removeChild(this.firstChild);}empty.apply(table.tBodies[0]);}else{table.tBodies[0].innerHTML="";}};}});$.fn.extend({tablesorter:$.tablesorter.construct});var ts=$.tablesorter;ts.addParser({id:"text",is:function(s){return true;},format:function(s){return $.trim(s.toLocaleLowerCase());},type:"text"});ts.addParser({id:"digit",is:function(s,table){var c=table.config;return $.tablesorter.isDigit(s,c);},format:function(s){return $.tablesorter.formatFloat(s);},type:"numeric"});ts.addParser({id:"currency",is:function(s){return/^[£$€?.]/.test(s);},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/[£$€]/g),""));},type:"numeric"});ts.addParser({id:"ipAddress",is:function(s){return/^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(s);},format:function(s){var a=s.split("."),r="",l=a.length;for(var i=0;i<l;i++){var item=a[i];if(item.length==2){r+="0"+item;}else{r+=item;}}return $.tablesorter.formatFloat(r);},type:"numeric"});ts.addParser({id:"url",is:function(s){return/^(https?|ftp|file):\/\/$/.test(s);},format:function(s){return jQuery.trim(s.replace(new RegExp(/(https?|ftp|file):\/\//),''));},type:"text"});ts.addParser({id:"isoDate",is:function(s){return/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(s);},format:function(s){return $.tablesorter.formatFloat((s!="")?new Date(s.replace(new RegExp(/-/g),"/")).getTime():"0");},type:"numeric"});ts.addParser({id:"percent",is:function(s){return/\%$/.test($.trim(s));},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g),""));},type:"numeric"});ts.addParser({id:"usLongDate",is:function(s){return s.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/));},format:function(s){return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"shortDate",is:function(s){return/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s);},format:function(s,table){var c=table.config;s=s.replace(/\-/g,"/");if(c.dateFormat=="us"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$1/$2");}else if(c.dateFormat=="uk"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1");}else if(c.dateFormat=="dd/mm/yy"||c.dateFormat=="dd-mm-yy"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,"$1/$2/$3");}return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"time",is:function(s){return/^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(s);},format:function(s){return $.tablesorter.formatFloat(new Date("2000/01/01 "+s).getTime());},type:"numeric"});ts.addParser({id:"metadata",is:function(s){return false;},format:function(s,table,cell){var c=table.config,p=(!c.parserMetadataName)?'sortValue':c.parserMetadataName;return $(cell).metadata()[p];},type:"numeric"});ts.addWidget({id:"zebra",format:function(table){if(table.config.debug){var time=new Date();}var $tr,row=-1,odd;$("tr:visible",table.tBodies[0]).each(function(i){$tr=$(this);if(!$tr.hasClass(table.config.cssChildRow))row++;odd=(row%2==0);$tr.removeClass(table.config.widgetZebra.css[odd?0:1]).addClass(table.config.widgetZebra.css[odd?1:0])});if(table.config.debug){$.tablesorter.benchmark("Applying Zebra widget",time);}}});})(jQuery);/*!
* Bootstrap.js by @fat & @mdo
* Copyright 2012 Twitter, Inc.
* http://www.apache.org/licenses/LICENSE-2.0.txt
*/
!function(e){"use strict";e(function(){e.support.transition=function(){var e=function(){var e=document.createElement("bootstrap"),t={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"},n;for(n in t)if(e.style[n]!==undefined)return t[n]}();return e&&{end:e}}()})}(window.jQuery),!function(e){"use strict";var t='[data-dismiss="alert"]',n=function(n){e(n).on("click",t,this.close)};n.prototype.close=function(t){function s(){i.trigger("closed").remove()}var n=e(this),r=n.attr("data-target"),i;r||(r=n.attr("href"),r=r&&r.replace(/.*(?=#[^\s]*$)/,"")),i=e(r),t&&t.preventDefault(),i.length||(i=n.hasClass("alert")?n:n.parent()),i.trigger(t=e.Event("close"));if(t.isDefaultPrevented())return;i.removeClass("in"),e.support.transition&&i.hasClass("fade")?i.on(e.support.transition.end,s):s()};var r=e.fn.alert;e.fn.alert=function(t){return this.each(function(){var r=e(this),i=r.data("alert");i||r.data("alert",i=new n(this)),typeof t=="string"&&i[t].call(r)})},e.fn.alert.Constructor=n,e.fn.alert.noConflict=function(){return e.fn.alert=r,this},e(document).on("click.alert.data-api",t,n.prototype.close)}(window.jQuery),!function(e){"use strict";var t=function(t,n){this.$element=e(t),this.options=e.extend({},e.fn.button.defaults,n)};t.prototype.setState=function(e){var t="disabled",n=this.$element,r=n.data(),i=n.is("input")?"val":"html";e+="Text",r.resetText||n.data("resetText",n[i]()),n[i](r[e]||this.options[e]),setTimeout(function(){e=="loadingText"?n.addClass(t).attr(t,t):n.removeClass(t).removeAttr(t)},0)},t.prototype.toggle=function(){var e=this.$element.closest('[data-toggle="buttons-radio"]');e&&e.find(".active").removeClass("active"),this.$element.toggleClass("active")};var n=e.fn.button;e.fn.button=function(n){return this.each(function(){var r=e(this),i=r.data("button"),s=typeof n=="object"&&n;i||r.data("button",i=new t(this,s)),n=="toggle"?i.toggle():n&&i.setState(n)})},e.fn.button.defaults={loadingText:"loading..."},e.fn.button.Constructor=t,e.fn.button.noConflict=function(){return e.fn.button=n,this},e(document).on("click.button.data-api","[data-toggle^=button]",function(t){var n=e(t.target);n.hasClass("btn")||(n=n.closest(".btn")),n.button("toggle")})}(window.jQuery),!function(e){"use strict";var t=function(t,n){this.$element=e(t),this.$indicators=this.$element.find(".carousel-indicators"),this.options=n,this.options.pause=="hover"&&this.$element.on("mouseenter",e.proxy(this.pause,this)).on("mouseleave",e.proxy(this.cycle,this))};t.prototype={cycle:function(t){return t||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(e.proxy(this.next,this),this.options.interval)),this},getActiveIndex:function(){return this.$active=this.$element.find(".item.active"),this.$items=this.$active.parent().children(),this.$items.index(this.$active)},to:function(t){var n=this.getActiveIndex(),r=this;if(t>this.$items.length-1||t<0)return;return this.sliding?this.$element.one("slid",function(){r.to(t)}):n==t?this.pause().cycle():this.slide(t>n?"next":"prev",e(this.$items[t]))},pause:function(t){return t||(this.paused=!0),this.$element.find(".next, .prev").length&&e.support.transition.end&&(this.$element.trigger(e.support.transition.end),this.cycle(!0)),clearInterval(this.interval),this.interval=null,this},next:function(){if(this.sliding)return;return this.slide("next")},prev:function(){if(this.sliding)return;return this.slide("prev")},slide:function(t,n){var r=this.$element.find(".item.active"),i=n||r[t](),s=this.interval,o=t=="next"?"left":"right",u=t=="next"?"first":"last",a=this,f;this.sliding=!0,s&&this.pause(),i=i.length?i:this.$element.find(".item")[u](),f=e.Event("slide",{relatedTarget:i[0],direction:o});if(i.hasClass("active"))return;this.$indicators.length&&(this.$indicators.find(".active").removeClass("active"),this.$element.one("slid",function(){var t=e(a.$indicators.children()[a.getActiveIndex()]);t&&t.addClass("active")}));if(e.support.transition&&this.$element.hasClass("slide")){this.$element.trigger(f);if(f.isDefaultPrevented())return;i.addClass(t),i[0].offsetWidth,r.addClass(o),i.addClass(o),this.$element.one(e.support.transition.end,function(){i.removeClass([t,o].join(" ")).addClass("active"),r.removeClass(["active",o].join(" ")),a.sliding=!1,setTimeout(function(){a.$element.trigger("slid")},0)})}else{this.$element.trigger(f);if(f.isDefaultPrevented())return;r.removeClass("active"),i.addClass("active"),this.sliding=!1,this.$element.trigger("slid")}return s&&this.cycle(),this}};var n=e.fn.carousel;e.fn.carousel=function(n){return this.each(function(){var r=e(this),i=r.data("carousel"),s=e.extend({},e.fn.carousel.defaults,typeof n=="object"&&n),o=typeof n=="string"?n:s.slide;i||r.data("carousel",i=new t(this,s)),typeof n=="number"?i.to(n):o?i[o]():s.interval&&i.pause().cycle()})},e.fn.carousel.defaults={interval:5e3,pause:"hover"},e.fn.carousel.Constructor=t,e.fn.carousel.noConflict=function(){return e.fn.carousel=n,this},e(document).on("click.carousel.data-api","[data-slide], [data-slide-to]",function(t){var n=e(this),r,i=e(n.attr("data-target")||(r=n.attr("href"))&&r.replace(/.*(?=#[^\s]+$)/,"")),s=e.extend({},i.data(),n.data()),o;i.carousel(s),(o=n.attr("data-slide-to"))&&i.data("carousel").pause().to(o).cycle(),t.preventDefault()})}(window.jQuery),!function(e){"use strict";var t=function(t,n){this.$element=e(t),this.options=e.extend({},e.fn.collapse.defaults,n),this.options.parent&&(this.$parent=e(this.options.parent)),this.options.toggle&&this.toggle()};t.prototype={constructor:t,dimension:function(){var e=this.$element.hasClass("width");return e?"width":"height"},show:function(){var t,n,r,i;if(this.transitioning||this.$element.hasClass("in"))return;t=this.dimension(),n=e.camelCase(["scroll",t].join("-")),r=this.$parent&&this.$parent.find("> .accordion-group > .in");if(r&&r.length){i=r.data("collapse");if(i&&i.transitioning)return;r.collapse("hide"),i||r.data("collapse",null)}this.$element[t](0),this.transition("addClass",e.Event("show"),"shown"),e.support.transition&&this.$element[t](this.$element[0][n])},hide:function(){var t;if(this.transitioning||!this.$element.hasClass("in"))return;t=this.dimension(),this.reset(this.$element[t]()),this.transition("removeClass",e.Event("hide"),"hidden"),this.$element[t](0)},reset:function(e){var t=this.dimension();return this.$element.removeClass("collapse")[t](e||"auto")[0].offsetWidth,this.$element[e!==null?"addClass":"removeClass"]("collapse"),this},transition:function(t,n,r){var i=this,s=function(){n.type=="show"&&i.reset(),i.transitioning=0,i.$element.trigger(r)};this.$element.trigger(n);if(n.isDefaultPrevented())return;this.transitioning=1,this.$element[t]("in"),e.support.transition&&this.$element.hasClass("collapse")?this.$element.one(e.support.transition.end,s):s()},toggle:function(){this[this.$element.hasClass("in")?"hide":"show"]()}};var n=e.fn.collapse;e.fn.collapse=function(n){return this.each(function(){var r=e(this),i=r.data("collapse"),s=e.extend({},e.fn.collapse.defaults,r.data(),typeof n=="object"&&n);i||r.data("collapse",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.collapse.defaults={toggle:!0},e.fn.collapse.Constructor=t,e.fn.collapse.noConflict=function(){return e.fn.collapse=n,this},e(document).on("click.collapse.data-api","[data-toggle=collapse]",function(t){var n=e(this),r,i=n.attr("data-target")||t.preventDefault()||(r=n.attr("href"))&&r.replace(/.*(?=#[^\s]+$)/,""),s=e(i).data("collapse")?"toggle":n.data();n[e(i).hasClass("in")?"addClass":"removeClass"]("collapsed"),e(i).collapse(s)})}(window.jQuery),!function(e){"use strict";function r(){e(".dropdown-backdrop").remove(),e(t).each(function(){i(e(this)).removeClass("open")})}function i(t){var n=t.attr("data-target"),r;n||(n=t.attr("href"),n=n&&/#/.test(n)&&n.replace(/.*(?=#[^\s]*$)/,"")),r=n&&e(n);if(!r||!r.length)r=t.parent();return r}var t="[data-toggle=dropdown]",n=function(t){var n=e(t).on("click.dropdown.data-api",this.toggle);e("html").on("click.dropdown.data-api",function(){n.parent().removeClass("open")})};n.prototype={constructor:n,toggle:function(t){var n=e(this),s,o;if(n.is(".disabled, :disabled"))return;return s=i(n),o=s.hasClass("open"),r(),o||("ontouchstart"in document.documentElement&&e('<div class="dropdown-backdrop"/>').insertBefore(e(this)).on("click",r),s.toggleClass("open")),n.focus(),!1},keydown:function(n){var r,s,o,u,a,f;if(!/(38|40|27)/.test(n.keyCode))return;r=e(this),n.preventDefault(),n.stopPropagation();if(r.is(".disabled, :disabled"))return;u=i(r),a=u.hasClass("open");if(!a||a&&n.keyCode==27)return n.which==27&&u.find(t).focus(),r.click();s=e("[role=menu] li:not(.divider):visible a",u);if(!s.length)return;f=s.index(s.filter(":focus")),n.keyCode==38&&f>0&&f--,n.keyCode==40&&f<s.length-1&&f++,~f||(f=0),s.eq(f).focus()}};var s=e.fn.dropdown;e.fn.dropdown=function(t){return this.each(function(){var r=e(this),i=r.data("dropdown");i||r.data("dropdown",i=new n(this)),typeof t=="string"&&i[t].call(r)})},e.fn.dropdown.Constructor=n,e.fn.dropdown.noConflict=function(){return e.fn.dropdown=s,this},e(document).on("click.dropdown.data-api",r).on("click.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.dropdown.data-api",t,n.prototype.toggle).on("keydown.dropdown.data-api",t+", [role=menu]",n.prototype.keydown)}(window.jQuery),!function(e){"use strict";var t=function(t,n){this.options=n,this.$element=e(t).delegate('[data-dismiss="modal"]',"click.dismiss.modal",e.proxy(this.hide,this)),this.options.remote&&this.$element.find(".modal-body").load(this.options.remote)};t.prototype={constructor:t,toggle:function(){return this[this.isShown?"hide":"show"]()},show:function(){var t=this,n=e.Event("show");this.$element.trigger(n);if(this.isShown||n.isDefaultPrevented())return;this.isShown=!0,this.escape(),this.backdrop(function(){var n=e.support.transition&&t.$element.hasClass("fade");t.$element.parent().length||t.$element.appendTo(document.body),t.$element.show(),n&&t.$element[0].offsetWidth,t.$element.addClass("in").attr("aria-hidden",!1),t.enforceFocus(),n?t.$element.one(e.support.transition.end,function(){t.$element.focus().trigger("shown")}):t.$element.focus().trigger("shown")})},hide:function(t){t&&t.preventDefault();var n=this;t=e.Event("hide"),this.$element.trigger(t);if(!this.isShown||t.isDefaultPrevented())return;this.isShown=!1,this.escape(),e(document).off("focusin.modal"),this.$element.removeClass("in").attr("aria-hidden",!0),e.support.transition&&this.$element.hasClass("fade")?this.hideWithTransition():this.hideModal()},enforceFocus:function(){var t=this;e(document).on("focusin.modal",function(e){t.$element[0]!==e.target&&!t.$element.has(e.target).length&&t.$element.focus()})},escape:function(){var e=this;this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.modal",function(t){t.which==27&&e.hide()}):this.isShown||this.$element.off("keyup.dismiss.modal")},hideWithTransition:function(){var t=this,n=setTimeout(function(){t.$element.off(e.support.transition.end),t.hideModal()},500);this.$element.one(e.support.transition.end,function(){clearTimeout(n),t.hideModal()})},hideModal:function(){var e=this;this.$element.hide(),this.backdrop(function(){e.removeBackdrop(),e.$element.trigger("hidden")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(t){var n=this,r=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var i=e.support.transition&&r;this.$backdrop=e('<div class="modal-backdrop '+r+'" />').appendTo(document.body),this.$backdrop.click(this.options.backdrop=="static"?e.proxy(this.$element[0].focus,this.$element[0]):e.proxy(this.hide,this)),i&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in");if(!t)return;i?this.$backdrop.one(e.support.transition.end,t):t()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),e.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(e.support.transition.end,t):t()):t&&t()}};var n=e.fn.modal;e.fn.modal=function(n){return this.each(function(){var r=e(this),i=r.data("modal"),s=e.extend({},e.fn.modal.defaults,r.data(),typeof n=="object"&&n);i||r.data("modal",i=new t(this,s)),typeof n=="string"?i[n]():s.show&&i.show()})},e.fn.modal.defaults={backdrop:!0,keyboard:!0,show:!0},e.fn.modal.Constructor=t,e.fn.modal.noConflict=function(){return e.fn.modal=n,this},e(document).on("click.modal.data-api",'[data-toggle="modal"]',function(t){var n=e(this),r=n.attr("href"),i=e(n.attr("data-target")||r&&r.replace(/.*(?=#[^\s]+$)/,"")),s=i.data("modal")?"toggle":e.extend({remote:!/#/.test(r)&&r},i.data(),n.data());t.preventDefault(),i.modal(s).one("hide",function(){n.focus()})})}(window.jQuery),!function(e){"use strict";var t=function(e,t){this.init("tooltip",e,t)};t.prototype={constructor:t,init:function(t,n,r){var i,s,o,u,a;this.type=t,this.$element=e(n),this.options=this.getOptions(r),this.enabled=!0,o=this.options.trigger.split(" ");for(a=o.length;a--;)u=o[a],u=="click"?this.$element.on("click."+this.type,this.options.selector,e.proxy(this.toggle,this)):u!="manual"&&(i=u=="hover"?"mouseenter":"focus",s=u=="hover"?"mouseleave":"blur",this.$element.on(i+"."+this.type,this.options.selector,e.proxy(this.enter,this)),this.$element.on(s+"."+this.type,this.options.selector,e.proxy(this.leave,this)));this.options.selector?this._options=e.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},getOptions:function(t){return t=e.extend({},e.fn[this.type].defaults,this.$element.data(),t),t.delay&&typeof t.delay=="number"&&(t.delay={show:t.delay,hide:t.delay}),t},enter:function(t){var n=e.fn[this.type].defaults,r={},i;this._options&&e.each(this._options,function(e,t){n[e]!=t&&(r[e]=t)},this),i=e(t.currentTarget)[this.type](r).data(this.type);if(!i.options.delay||!i.options.delay.show)return i.show();clearTimeout(this.timeout),i.hoverState="in",this.timeout=setTimeout(function(){i.hoverState=="in"&&i.show()},i.options.delay.show)},leave:function(t){var n=e(t.currentTarget)[this.type](this._options).data(this.type);this.timeout&&clearTimeout(this.timeout);if(!n.options.delay||!n.options.delay.hide)return n.hide();n.hoverState="out",this.timeout=setTimeout(function(){n.hoverState=="out"&&n.hide()},n.options.delay.hide)},show:function(){var t,n,r,i,s,o,u=e.Event("show");if(this.hasContent()&&this.enabled){this.$element.trigger(u);if(u.isDefaultPrevented())return;t=this.tip(),this.setContent(),this.options.animation&&t.addClass("fade"),s=typeof this.options.placement=="function"?this.options.placement.call(this,t[0],this.$element[0]):this.options.placement,t.detach().css({top:0,left:0,display:"block"}),this.options.container?t.appendTo(this.options.container):t.insertAfter(this.$element),n=this.getPosition(),r=t[0].offsetWidth,i=t[0].offsetHeight;switch(s){case"bottom":o={top:n.top+n.height,left:n.left+n.width/2-r/2};break;case"top":o={top:n.top-i,left:n.left+n.width/2-r/2};break;case"left":o={top:n.top+n.height/2-i/2,left:n.left-r};break;case"right":o={top:n.top+n.height/2-i/2,left:n.left+n.width}}this.applyPlacement(o,s),this.$element.trigger("shown")}},applyPlacement:function(e,t){var n=this.tip(),r=n[0].offsetWidth,i=n[0].offsetHeight,s,o,u,a;n.offset(e).addClass(t).addClass("in"),s=n[0].offsetWidth,o=n[0].offsetHeight,t=="top"&&o!=i&&(e.top=e.top+i-o,a=!0),t=="bottom"||t=="top"?(u=0,e.left<0&&(u=e.left*-2,e.left=0,n.offset(e),s=n[0].offsetWidth,o=n[0].offsetHeight),this.replaceArrow(u-r+s,s,"left")):this.replaceArrow(o-i,o,"top"),a&&n.offset(e)},replaceArrow:function(e,t,n){this.arrow().css(n,e?50*(1-e/t)+"%":"")},setContent:function(){var e=this.tip(),t=this.getTitle();e.find(".tooltip-inner")[this.options.html?"html":"text"](t),e.removeClass("fade in top bottom left right")},hide:function(){function i(){var t=setTimeout(function(){n.off(e.support.transition.end).detach()},500);n.one(e.support.transition.end,function(){clearTimeout(t),n.detach()})}var t=this,n=this.tip(),r=e.Event("hide");this.$element.trigger(r);if(r.isDefaultPrevented())return;return n.removeClass("in"),e.support.transition&&this.$tip.hasClass("fade")?i():n.detach(),this.$element.trigger("hidden"),this},fixTitle:function(){var e=this.$element;(e.attr("title")||typeof e.attr("data-original-title")!="string")&&e.attr("data-original-title",e.attr("title")||"").attr("title","")},hasContent:function(){return this.getTitle()},getPosition:function(){var t=this.$element[0];return e.extend({},typeof t.getBoundingClientRect=="function"?t.getBoundingClientRect():{width:t.offsetWidth,height:t.offsetHeight},this.$element.offset())},getTitle:function(){var e,t=this.$element,n=this.options;return e=t.attr("data-original-title")||(typeof n.title=="function"?n.title.call(t[0]):n.title),e},tip:function(){return this.$tip=this.$tip||e(this.options.template)},arrow:function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled},toggle:function(t){var n=t?e(t.currentTarget)[this.type](this._options).data(this.type):this;n.tip().hasClass("in")?n.hide():n.show()},destroy:function(){this.hide().$element.off("."+this.type).removeData(this.type)}};var n=e.fn.tooltip;e.fn.tooltip=function(n){return this.each(function(){var r=e(this),i=r.data("tooltip"),s=typeof n=="object"&&n;i||r.data("tooltip",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.tooltip.Constructor=t,e.fn.tooltip.defaults={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1},e.fn.tooltip.noConflict=function(){return e.fn.tooltip=n,this}}(window.jQuery),!function(e){"use strict";var t=function(e,t){this.init("popover",e,t)};t.prototype=e.extend({},e.fn.tooltip.Constructor.prototype,{constructor:t,setContent:function(){var e=this.tip(),t=this.getTitle(),n=this.getContent();e.find(".popover-title")[this.options.html?"html":"text"](t),e.find(".popover-content")[this.options.html?"html":"text"](n),e.removeClass("fade top bottom left right in")},hasContent:function(){return this.getTitle()||this.getContent()},getContent:function(){var e,t=this.$element,n=this.options;return e=(typeof n.content=="function"?n.content.call(t[0]):n.content)||t.attr("data-content"),e},tip:function(){return this.$tip||(this.$tip=e(this.options.template)),this.$tip},destroy:function(){this.hide().$element.off("."+this.type).removeData(this.type)}});var n=e.fn.popover;e.fn.popover=function(n){return this.each(function(){var r=e(this),i=r.data("popover"),s=typeof n=="object"&&n;i||r.data("popover",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.popover.Constructor=t,e.fn.popover.defaults=e.extend({},e.fn.tooltip.defaults,{placement:"right",trigger:"click",content:"",template:'<div class="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),e.fn.popover.noConflict=function(){return e.fn.popover=n,this}}(window.jQuery),!function(e){"use strict";function t(t,n){var r=e.proxy(this.process,this),i=e(t).is("body")?e(window):e(t),s;this.options=e.extend({},e.fn.scrollspy.defaults,n),this.$scrollElement=i.on("scroll.scroll-spy.data-api",r),this.selector=(this.options.target||(s=e(t).attr("href"))&&s.replace(/.*(?=#[^\s]+$)/,"")||"")+" .nav li > a",this.$body=e("body"),this.refresh(),this.process()}t.prototype={constructor:t,refresh:function(){var t=this,n;this.offsets=e([]),this.targets=e([]),n=this.$body.find(this.selector).map(function(){var n=e(this),r=n.data("target")||n.attr("href"),i=/^#\w/.test(r)&&e(r);return i&&i.length&&[[i.position().top+(!e.isWindow(t.$scrollElement.get(0))&&t.$scrollElement.scrollTop()),r]]||null}).sort(function(e,t){return e[0]-t[0]}).each(function(){t.offsets.push(this[0]),t.targets.push(this[1])})},process:function(){var e=this.$scrollElement.scrollTop()+this.options.offset,t=this.$scrollElement[0].scrollHeight||this.$body[0].scrollHeight,n=t-this.$scrollElement.height(),r=this.offsets,i=this.targets,s=this.activeTarget,o;if(e>=n)return s!=(o=i.last()[0])&&this.activate(o);for(o=r.length;o--;)s!=i[o]&&e>=r[o]&&(!r[o+1]||e<=r[o+1])&&this.activate(i[o])},activate:function(t){var n,r;this.activeTarget=t,e(this.selector).parent(".active").removeClass("active"),r=this.selector+'[data-target="'+t+'"],'+this.selector+'[href="'+t+'"]',n=e(r).parent("li").addClass("active"),n.parent(".dropdown-menu").length&&(n=n.closest("li.dropdown").addClass("active")),n.trigger("activate")}};var n=e.fn.scrollspy;e.fn.scrollspy=function(n){return this.each(function(){var r=e(this),i=r.data("scrollspy"),s=typeof n=="object"&&n;i||r.data("scrollspy",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.scrollspy.Constructor=t,e.fn.scrollspy.defaults={offset:10},e.fn.scrollspy.noConflict=function(){return e.fn.scrollspy=n,this},e(window).on("load",function(){e('[data-spy="scroll"]').each(function(){var t=e(this);t.scrollspy(t.data())})})}(window.jQuery),!function(e){"use strict";var t=function(t){this.element=e(t)};t.prototype={constructor:t,show:function(){var t=this.element,n=t.closest("ul:not(.dropdown-menu)"),r=t.attr("data-target"),i,s,o;r||(r=t.attr("href"),r=r&&r.replace(/.*(?=#[^\s]*$)/,""));if(t.parent("li").hasClass("active"))return;i=n.find(".active:last a")[0],o=e.Event("show",{relatedTarget:i}),t.trigger(o);if(o.isDefaultPrevented())return;s=e(r),this.activate(t.parent("li"),n),this.activate(s,s.parent(),function(){t.trigger({type:"shown",relatedTarget:i})})},activate:function(t,n,r){function o(){i.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),t.addClass("active"),s?(t[0].offsetWidth,t.addClass("in")):t.removeClass("fade"),t.parent(".dropdown-menu")&&t.closest("li.dropdown").addClass("active"),r&&r()}var i=n.find("> .active"),s=r&&e.support.transition&&i.hasClass("fade");s?i.one(e.support.transition.end,o):o(),i.removeClass("in")}};var n=e.fn.tab;e.fn.tab=function(n){return this.each(function(){var r=e(this),i=r.data("tab");i||r.data("tab",i=new t(this)),typeof n=="string"&&i[n]()})},e.fn.tab.Constructor=t,e.fn.tab.noConflict=function(){return e.fn.tab=n,this},e(document).on("click.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(t){t.preventDefault(),e(this).tab("show")})}(window.jQuery),!function(e){"use strict";var t=function(t,n){this.$element=e(t),this.options=e.extend({},e.fn.typeahead.defaults,n),this.matcher=this.options.matcher||this.matcher,this.sorter=this.options.sorter||this.sorter,this.highlighter=this.options.highlighter||this.highlighter,this.updater=this.options.updater||this.updater,this.source=this.options.source,this.$menu=e(this.options.menu),this.shown=!1,this.listen()};t.prototype={constructor:t,select:function(){var e=this.$menu.find(".active").attr("data-value");return this.$element.val(this.updater(e)).change(),this.hide()},updater:function(e){return e},show:function(){var t=e.extend({},this.$element.position(),{height:this.$element[0].offsetHeight});return this.$menu.insertAfter(this.$element).css({top:t.top+t.height,left:t.left}).show(),this.shown=!0,this},hide:function(){return this.$menu.hide(),this.shown=!1,this},lookup:function(t){var n;return this.query=this.$element.val(),!this.query||this.query.length<this.options.minLength?this.shown?this.hide():this:(n=e.isFunction(this.source)?this.source(this.query,e.proxy(this.process,this)):this.source,n?this.process(n):this)},process:function(t){var n=this;return t=e.grep(t,function(e){return n.matcher(e)}),t=this.sorter(t),t.length?this.render(t.slice(0,this.options.items)).show():this.shown?this.hide():this},matcher:function(e){return~e.toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(e){var t=[],n=[],r=[],i;while(i=e.shift())i.toLowerCase().indexOf(this.query.toLowerCase())?~i.indexOf(this.query)?n.push(i):r.push(i):t.push(i);return t.concat(n,r)},highlighter:function(e){var t=this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");return e.replace(new RegExp("("+t+")","ig"),function(e,t){return"<strong>"+t+"</strong>"})},render:function(t){var n=this;return t=e(t).map(function(t,r){return t=e(n.options.item).attr("data-value",r),t.find("a").html(n.highlighter(r)),t[0]}),t.first().addClass("active"),this.$menu.html(t),this},next:function(t){var n=this.$menu.find(".active").removeClass("active"),r=n.next();r.length||(r=e(this.$menu.find("li")[0])),r.addClass("active")},prev:function(e){var t=this.$menu.find(".active").removeClass("active"),n=t.prev();n.length||(n=this.$menu.find("li").last()),n.addClass("active")},listen:function(){this.$element.on("focus",e.proxy(this.focus,this)).on("blur",e.proxy(this.blur,this)).on("keypress",e.proxy(this.keypress,this)).on("keyup",e.proxy(this.keyup,this)),this.eventSupported("keydown")&&this.$element.on("keydown",e.proxy(this.keydown,this)),this.$menu.on("click",e.proxy(this.click,this)).on("mouseenter","li",e.proxy(this.mouseenter,this)).on("mouseleave","li",e.proxy(this.mouseleave,this))},eventSupported:function(e){var t=e in this.$element;return t||(this.$element.setAttribute(e,"return;"),t=typeof this.$element[e]=="function"),t},move:function(e){if(!this.shown)return;switch(e.keyCode){case 9:case 13:case 27:e.preventDefault();break;case 38:e.preventDefault(),this.prev();break;case 40:e.preventDefault(),this.next()}e.stopPropagation()},keydown:function(t){this.suppressKeyPressRepeat=~e.inArray(t.keyCode,[40,38,9,13,27]),this.move(t)},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.move(e)},keyup:function(e){switch(e.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown)return;this.select();break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},focus:function(e){this.focused=!0},blur:function(e){this.focused=!1,!this.mousedover&&this.shown&&this.hide()},click:function(e){e.stopPropagation(),e.preventDefault(),this.select(),this.$element.focus()},mouseenter:function(t){this.mousedover=!0,this.$menu.find(".active").removeClass("active"),e(t.currentTarget).addClass("active")},mouseleave:function(e){this.mousedover=!1,!this.focused&&this.shown&&this.hide()}};var n=e.fn.typeahead;e.fn.typeahead=function(n){return this.each(function(){var r=e(this),i=r.data("typeahead"),s=typeof n=="object"&&n;i||r.data("typeahead",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.typeahead.defaults={source:[],items:8,menu:'<ul class="typeahead dropdown-menu"></ul>',item:'<li><a href="#"></a></li>',minLength:1},e.fn.typeahead.Constructor=t,e.fn.typeahead.noConflict=function(){return e.fn.typeahead=n,this},e(document).on("focus.typeahead.data-api",'[data-provide="typeahead"]',function(t){var n=e(this);if(n.data("typeahead"))return;n.typeahead(n.data())})}(window.jQuery),!function(e){"use strict";var t=function(t,n){this.options=e.extend({},e.fn.affix.defaults,n),this.$window=e(window).on("scroll.affix.data-api",e.proxy(this.checkPosition,this)).on("click.affix.data-api",e.proxy(function(){setTimeout(e.proxy(this.checkPosition,this),1)},this)),this.$element=e(t),this.checkPosition()};t.prototype.checkPosition=function(){if(!this.$element.is(":visible"))return;var t=e(document).height(),n=this.$window.scrollTop(),r=this.$element.offset(),i=this.options.offset,s=i.bottom,o=i.top,u="affix affix-top affix-bottom",a;typeof i!="object"&&(s=o=i),typeof o=="function"&&(o=i.top()),typeof s=="function"&&(s=i.bottom()),a=this.unpin!=null&&n+this.unpin<=r.top?!1:s!=null&&r.top+this.$element.height()>=t-s?"bottom":o!=null&&n<=o?"top":!1;if(this.affixed===a)return;this.affixed=a,this.unpin=a=="bottom"?r.top-n:null,this.$element.removeClass(u).addClass("affix"+(a?"-"+a:""))};var n=e.fn.affix;e.fn.affix=function(n){return this.each(function(){var r=e(this),i=r.data("affix"),s=typeof n=="object"&&n;i||r.data("affix",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.affix.Constructor=t,e.fn.affix.defaults={offset:0},e.fn.affix.noConflict=function(){return e.fn.affix=n,this},e(window).on("load",function(){e('[data-spy="affix"]').each(function(){var t=e(this),n=t.data();n.offset=n.offset||{},n.offsetBottom&&(n.offset.bottom=n.offsetBottom),n.offsetTop&&(n.offset.top=n.offsetTop),t.affix(n)})})}(window.jQuery);// lib/handlebars/base.js
/*jshint eqnull:true*/this.Handlebars={},function(e){e.VERSION="1.0.rc.1",e.helpers={},e.partials={},e.registerHelper=function(e,t,n){n&&(t.not=n),this.helpers[e]=t},e.registerPartial=function(e,t){this.partials[e]=t},e.registerHelper("helperMissing",function(e){if(arguments.length===2)return undefined;throw new Error("Could not find property '"+e+"'")});var t=Object.prototype.toString,n="[object Function]";e.registerHelper("blockHelperMissing",function(r,i){var s=i.inverse||function(){},o=i.fn,u="",a=t.call(r);return a===n&&(r=r.call(this)),r===!0?o(this):r===!1||r==null?s(this):a==="[object Array]"?r.length>0?e.helpers.each(r,i):s(this):o(r)}),e.K=function(){},e.createFrame=Object.create||function(t){e.K.prototype=t;var n=new e.K;return e.K.prototype=null,n},e.registerHelper("each",function(t,n){var r=n.fn,i=n.inverse,s=0,o="",u;n.data&&(u=e.createFrame(n.data));if(t&&typeof t=="object")if(t instanceof Array)for(var a=t.length;s<a;s++)u&&(u.index=s),o+=r(t[s],{data:u});else for(var f in t)t.hasOwnProperty(f)&&(u&&(u.key=f),o+=r(t[f],{data:u}),s++);return s===0&&(o=i(this)),o}),e.registerHelper("if",function(r,i){var s=t.call(r);return s===n&&(r=r.call(this)),!r||e.Utils.isEmpty(r)?i.inverse(this):i.fn(this)}),e.registerHelper("unless",function(t,n){var r=n.fn,i=n.inverse;return n.fn=i,n.inverse=r,e.helpers["if"].call(this,t,n)}),e.registerHelper("with",function(e,t){return t.fn(e)}),e.registerHelper("log",function(t){e.log(t)})}(this.Handlebars);var handlebars=function(){function n(){this.yy={}}var e={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,statements:6,simpleInverse:7,statement:8,openInverse:9,closeBlock:10,openBlock:11,mustache:12,partial:13,CONTENT:14,COMMENT:15,OPEN_BLOCK:16,inMustache:17,CLOSE:18,OPEN_INVERSE:19,OPEN_ENDBLOCK:20,path:21,OPEN:22,OPEN_UNESCAPED:23,OPEN_PARTIAL:24,params:25,hash:26,DATA:27,param:28,STRING:29,INTEGER:30,BOOLEAN:31,hashSegments:32,hashSegment:33,ID:34,EQUALS:35,pathSegments:36,SEP:37,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"CONTENT",15:"COMMENT",16:"OPEN_BLOCK",18:"CLOSE",19:"OPEN_INVERSE",20:"OPEN_ENDBLOCK",22:"OPEN",23:"OPEN_UNESCAPED",24:"OPEN_PARTIAL",27:"DATA",29:"STRING",30:"INTEGER",31:"BOOLEAN",34:"ID",35:"EQUALS",37:"SEP"},productions_:[0,[3,2],[4,3],[4,1],[4,0],[6,1],[6,2],[8,3],[8,3],[8,1],[8,1],[8,1],[8,1],[11,3],[9,3],[10,3],[12,3],[12,3],[13,3],[13,4],[7,2],[17,3],[17,2],[17,2],[17,1],[17,1],[25,2],[25,1],[28,1],[28,1],[28,1],[28,1],[28,1],[26,1],[32,2],[32,1],[33,3],[33,3],[33,3],[33,3],[33,3],[21,1],[36,3],[36,1]],performAction:function(t,n,r,i,s,o,u){var a=o.length-1;switch(s){case 1:return o[a-1];case 2:this.$=new i.ProgramNode(o[a-2],o[a]);break;case 3:this.$=new i.ProgramNode(o[a]);break;case 4:this.$=new i.ProgramNode([]);break;case 5:this.$=[o[a]];break;case 6:o[a-1].push(o[a]),this.$=o[a-1];break;case 7:this.$=new i.BlockNode(o[a-2],o[a-1].inverse,o[a-1],o[a]);break;case 8:this.$=new i.BlockNode(o[a-2],o[a-1],o[a-1].inverse,o[a]);break;case 9:this.$=o[a];break;case 10:this.$=o[a];break;case 11:this.$=new i.ContentNode(o[a]);break;case 12:this.$=new i.CommentNode(o[a]);break;case 13:this.$=new i.MustacheNode(o[a-1][0],o[a-1][1]);break;case 14:this.$=new i.MustacheNode(o[a-1][0],o[a-1][1]);break;case 15:this.$=o[a-1];break;case 16:this.$=new i.MustacheNode(o[a-1][0],o[a-1][1]);break;case 17:this.$=new i.MustacheNode(o[a-1][0],o[a-1][1],!0);break;case 18:this.$=new i.PartialNode(o[a-1]);break;case 19:this.$=new i.PartialNode(o[a-2],o[a-1]);break;case 20:break;case 21:this.$=[[o[a-2]].concat(o[a-1]),o[a]];break;case 22:this.$=[[o[a-1]].concat(o[a]),null];break;case 23:this.$=[[o[a-1]],o[a]];break;case 24:this.$=[[o[a]],null];break;case 25:this.$=[[new i.DataNode(o[a])],null];break;case 26:o[a-1].push(o[a]),this.$=o[a-1];break;case 27:this.$=[o[a]];break;case 28:this.$=o[a];break;case 29:this.$=new i.StringNode(o[a]);break;case 30:this.$=new i.IntegerNode(o[a]);break;case 31:this.$=new i.BooleanNode(o[a]);break;case 32:this.$=new i.DataNode(o[a]);break;case 33:this.$=new i.HashNode(o[a]);break;case 34:o[a-1].push(o[a]),this.$=o[a-1];break;case 35:this.$=[o[a]];break;case 36:this.$=[o[a-2],o[a]];break;case 37:this.$=[o[a-2],new i.StringNode(o[a])];break;case 38:this.$=[o[a-2],new i.IntegerNode(o[a])];break;case 39:this.$=[o[a-2],new i.BooleanNode(o[a])];break;case 40:this.$=[o[a-2],new i.DataNode(o[a])];break;case 41:this.$=new i.IdNode(o[a]);break;case 42:o[a-2].push(o[a]),this.$=o[a-2];break;case 43:this.$=[o[a]]}},table:[{3:1,4:2,5:[2,4],6:3,8:4,9:5,11:6,12:7,13:8,14:[1,9],15:[1,10],16:[1,12],19:[1,11],22:[1,13],23:[1,14],24:[1,15]},{1:[3]},{5:[1,16]},{5:[2,3],7:17,8:18,9:5,11:6,12:7,13:8,14:[1,9],15:[1,10],16:[1,12],19:[1,19],20:[2,3],22:[1,13],23:[1,14],24:[1,15]},{5:[2,5],14:[2,5],15:[2,5],16:[2,5],19:[2,5],20:[2,5],22:[2,5],23:[2,5],24:[2,5]},{4:20,6:3,8:4,9:5,11:6,12:7,13:8,14:[1,9],15:[1,10],16:[1,12],19:[1,11],20:[2,4],22:[1,13],23:[1,14],24:[1,15]},{4:21,6:3,8:4,9:5,11:6,12:7,13:8,14:[1,9],15:[1,10],16:[1,12],19:[1,11],20:[2,4],22:[1,13],23:[1,14],24:[1,15]},{5:[2,9],14:[2,9],15:[2,9],16:[2,9],19:[2,9],20:[2,9],22:[2,9],23:[2,9],24:[2,9]},{5:[2,10],14:[2,10],15:[2,10],16:[2,10],19:[2,10],20:[2,10],22:[2,10],23:[2,10],24:[2,10]},{5:[2,11],14:[2,11],15:[2,11],16:[2,11],19:[2,11],20:[2,11],22:[2,11],23:[2,11],24:[2,11]},{5:[2,12],14:[2,12],15:[2,12],16:[2,12],19:[2,12],20:[2,12],22:[2,12],23:[2,12],24:[2,12]},{17:22,21:23,27:[1,24],34:[1,26],36:25},{17:27,21:23,27:[1,24],34:[1,26],36:25},{17:28,21:23,27:[1,24],34:[1,26],36:25},{17:29,21:23,27:[1,24],34:[1,26],36:25},{21:30,34:[1,26],36:25},{1:[2,1]},{6:31,8:4,9:5,11:6,12:7,13:8,14:[1,9],15:[1,10],16:[1,12],19:[1,11],22:[1,13],23:[1,14],24:[1,15]},{5:[2,6],14:[2,6],15:[2,6],16:[2,6],19:[2,6],20:[2,6],22:[2,6],23:[2,6],24:[2,6]},{17:22,18:[1,32],21:23,27:[1,24],34:[1,26],36:25},{10:33,20:[1,34]},{10:35,20:[1,34]},{18:[1,36]},{18:[2,24],21:41,25:37,26:38,27:[1,45],28:39,29:[1,42],30:[1,43],31:[1,44],32:40,33:46,34:[1,47],36:25},{18:[2,25]},{18:[2,41],27:[2,41],29:[2,41],30:[2,41],31:[2,41],34:[2,41],37:[1,48]},{18:[2,43],27:[2,43],29:[2,43],30:[2,43],31:[2,43],34:[2,43],37:[2,43]},{18:[1,49]},{18:[1,50]},{18:[1,51]},{18:[1,52],21:53,34:[1,26],36:25},{5:[2,2],8:18,9:5,11:6,12:7,13:8,14:[1,9],15:[1,10],16:[1,12],19:[1,11],20:[2,2],22:[1,13],23:[1,14],24:[1,15]},{14:[2,20],15:[2,20],16:[2,20],19:[2,20],22:[2,20],23:[2,20],24:[2,20]},{5:[2,7],14:[2,7],15:[2,7],16:[2,7],19:[2,7],20:[2,7],22:[2,7],23:[2,7],24:[2,7]},{21:54,34:[1,26],36:25},{5:[2,8],14:[2,8],15:[2,8],16:[2,8],19:[2,8],20:[2,8],22:[2,8],23:[2,8],24:[2,8]},{14:[2,14],15:[2,14],16:[2,14],19:[2,14],20:[2,14],22:[2,14],23:[2,14],24:[2,14]},{18:[2,22],21:41,26:55,27:[1,45],28:56,29:[1,42],30:[1,43],31:[1,44],32:40,33:46,34:[1,47],36:25},{18:[2,23]},{18:[2,27],27:[2,27],29:[2,27],30:[2,27],31:[2,27],34:[2,27]},{18:[2,33],33:57,34:[1,58]},{18:[2,28],27:[2,28],29:[2,28],30:[2,28],31:[2,28],34:[2,28]},{18:[2,29],27:[2,29],29:[2,29],30:[2,29],31:[2,29],34:[2,29]},{18:[2,30],27:[2,30],29:[2,30],30:[2,30],31:[2,30],34:[2,30]},{18:[2,31],27:[2,31],29:[2,31],30:[2,31],31:[2,31],34:[2,31]},{18:[2,32],27:[2,32],29:[2,32],30:[2,32],31:[2,32],34:[2,32]},{18:[2,35],34:[2,35]},{18:[2,43],27:[2,43],29:[2,43],30:[2,43],31:[2,43],34:[2,43],35:[1,59],37:[2,43]},{34:[1,60]},{14:[2,13],15:[2,13],16:[2,13],19:[2,13],20:[2,13],22:[2,13],23:[2,13],24:[2,13]},{5:[2,16],14:[2,16],15:[2,16],16:[2,16],19:[2,16],20:[2,16],22:[2,16],23:[2,16],24:[2,16]},{5:[2,17],14:[2,17],15:[2,17],16:[2,17],19:[2,17],20:[2,17],22:[2,17],23:[2,17],24:[2,17]},{5:[2,18],14:[2,18],15:[2,18],16:[2,18],19:[2,18],20:[2,18],22:[2,18],23:[2,18],24:[2,18]},{18:[1,61]},{18:[1,62]},{18:[2,21]},{18:[2,26],27:[2,26],29:[2,26],30:[2,26],31:[2,26],34:[2,26]},{18:[2,34],34:[2,34]},{35:[1,59]},{21:63,27:[1,67],29:[1,64],30:[1,65],31:[1,66],34:[1,26],36:25},{18:[2,42],27:[2,42],29:[2,42],30:[2,42],31:[2,42],34:[2,42],37:[2,42]},{5:[2,19],14:[2,19],15:[2,19],16:[2,19],19:[2,19],20:[2,19],22:[2,19],23:[2,19],24:[2,19]},{5:[2,15],14:[2,15],15:[2,15],16:[2,15],19:[2,15],20:[2,15],22:[2,15],23:[2,15],24:[2,15]},{18:[2,36],34:[2,36]},{18:[2,37],34:[2,37]},{18:[2,38],34:[2,38]},{18:[2,39],34:[2,39]},{18:[2,40],34:[2,40]}],defaultActions:{16:[2,1],24:[2,25],38:[2,23],55:[2,21]},parseError:function(t,n){throw new Error(t)},parse:function(t){function v(e){r.length=r.length-2*e,i.length=i.length-e,s.length=s.length-e}function m(){var e;return e=n.lexer.lex()||1,typeof e!="number"&&(e=n.symbols_[e]||e),e}var n=this,r=[0],i=[null],s=[],o=this.table,u="",a=0,f=0,l=0,c=2,h=1;this.lexer.setInput(t),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,typeof this.lexer.yylloc=="undefined"&&(this.lexer.yylloc={});var p=this.lexer.yylloc;s.push(p);var d=this.lexer.options&&this.lexer.options.ranges;typeof this.yy.parseError=="function"&&(this.parseError=this.yy.parseError);var g,y,b,w,E,S,x={},T,N,C,k;for(;;){b=r[r.length-1];if(this.defaultActions[b])w=this.defaultActions[b];else{if(g===null||typeof g=="undefined")g=m();w=o[b]&&o[b][g]}if(typeof w=="undefined"||!w.length||!w[0]){var L="";if(!l){k=[];for(T in o[b])this.terminals_[T]&&T>2&&k.push("'"+this.terminals_[T]+"'");this.lexer.showPosition?L="Parse error on line "+(a+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+k.join(", ")+", got '"+(this.terminals_[g]||g)+"'":L="Parse error on line "+(a+1)+": Unexpected "+(g==1?"end of input":"'"+(this.terminals_[g]||g)+"'"),this.parseError(L,{text:this.lexer.match,token:this.terminals_[g]||g,line:this.lexer.yylineno,loc:p,expected:k})}}if(w[0]instanceof Array&&w.length>1)throw new Error("Parse Error: multiple actions possible at state: "+b+", token: "+g);switch(w[0]){case 1:r.push(g),i.push(this.lexer.yytext),s.push(this.lexer.yylloc),r.push(w[1]),g=null,y?(g=y,y=null):(f=this.lexer.yyleng,u=this.lexer.yytext,a=this.lexer.yylineno,p=this.lexer.yylloc,l>0&&l--);break;case 2:N=this.productions_[w[1]][1],x.$=i[i.length-N],x._$={first_line:s[s.length-(N||1)].first_line,last_line:s[s.length-1].last_line,first_column:s[s.length-(N||1)].first_column,last_column:s[s.length-1].last_column},d&&(x._$.range=[s[s.length-(N||1)].range[0],s[s.length-1].range[1]]),S=this.performAction.call(x,u,f,a,this.yy,w[1],i,s);if(typeof S!="undefined")return S;N&&(r=r.slice(0,-1*N*2),i=i.slice(0,-1*N),s=s.slice(0,-1*N)),r.push(this.productions_[w[1]][0]),i.push(x.$),s.push(x._$),C=o[r[r.length-2]][r[r.length-1]],r.push(C);break;case 3:return!0}}return!0}},t=function(){var e={EOF:1,parseError:function(t,n){if(!this.yy.parser)throw new Error(t);this.yy.parser.parseError(t,n)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e;var t=e.match(/(?:\r\n?|\n).*/g);return t?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t-1),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var i=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[i[0],i[0]+this.yyleng-t]),this},more:function(){return this._more=!0,this},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=(new Array(e.length+1)).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var e,t,n,r,i,s;this._more||(this.yytext="",this.match="");var o=this._currentRules();for(var u=0;u<o.length;u++){n=this._input.match(this.rules[o[u]]);if(n&&(!t||n[0].length>t[0].length)){t=n,r=u;if(!this.options.flex)break}}if(t){s=t[0].match(/(?:\r\n?|\n).*/g),s&&(this.yylineno+=s.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:s?s[s.length-1].length-s[s.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,o[r],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1);if(e)return e;return}return this._input===""?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var t=this.next();return typeof t!="undefined"?t:this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(t){this.begin(t)}};return e.options={},e.performAction=function(t,n,r,i){var s=i;switch(r){case 0:n.yytext.slice(-1)!=="\\"&&this.begin("mu"),n.yytext.slice(-1)==="\\"&&(n.yytext=n.yytext.substr(0,n.yyleng-1),this.begin("emu"));if(n.yytext)return 14;break;case 1:return 14;case 2:return n.yytext.slice(-1)!=="\\"&&this.popState(),n.yytext.slice(-1)==="\\"&&(n.yytext=n.yytext.substr(0,n.yyleng-1)),14;case 3:return n.yytext=n.yytext.substr(0,n.yyleng-4),this.popState(),15;case 4:return 24;case 5:return 16;case 6:return 20;case 7:return 19;case 8:return 19;case 9:return 23;case 10:return 23;case 11:this.popState(),this.begin("com");break;case 12:return n.yytext=n.yytext.substr(3,n.yyleng-5),this.popState(),15;case 13:return 22;case 14:return 35;case 15:return 34;case 16:return 34;case 17:return 37;case 18:break;case 19:return this.popState(),18;case 20:return this.popState(),18;case 21:return n.yytext=n.yytext.substr(1,n.yyleng-2).replace(/\\"/g,'"'),29;case 22:return n.yytext=n.yytext.substr(1,n.yyleng-2).replace(/\\'/g,"'"),29;case 23:return n.yytext=n.yytext.substr(1),27;case 24:return 31;case 25:return 31;case 26:return 30;case 27:return 34;case 28:return n.yytext=n.yytext.substr(1,n.yyleng-2),34;case 29:return"INVALID";case 30:return 5}},e.rules=[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|$)))/,/^(?:[\s\S]*?--\}\})/,/^(?:\{\{>)/,/^(?:\{\{#)/,/^(?:\{\{\/)/,/^(?:\{\{\^)/,/^(?:\{\{\s*else\b)/,/^(?:\{\{\{)/,/^(?:\{\{&)/,/^(?:\{\{!--)/,/^(?:\{\{![\s\S]*?\}\})/,/^(?:\{\{)/,/^(?:=)/,/^(?:\.(?=[} ]))/,/^(?:\.\.)/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}\}\})/,/^(?:\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@[a-zA-Z]+)/,/^(?:true(?=[}\s]))/,/^(?:false(?=[}\s]))/,/^(?:[0-9]+(?=[}\s]))/,/^(?:[a-zA-Z0-9_$-]+(?=[=}\s\/.]))/,/^(?:\[[^\]]*\])/,/^(?:.)/,/^(?:$)/],e.conditions={mu:{rules:[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[3],inclusive:!1},INITIAL:{rules:[0,1,30],inclusive:!0}},e}();return e.lexer=t,n.prototype=e,e.Parser=n,new n}();typeof require!="undefined"&&typeof exports!="undefined"&&(exports.parser=handlebars,exports.Parser=handlebars.Parser,exports.parse=function(){return handlebars.parse.apply(handlebars,arguments)},exports.main=function(t){if(!t[1])throw new Error("Usage: "+t[0]+" FILE");var n,r;return typeof process!="undefined"?n=require("fs").readFileSync(require("path").resolve(t[1]),"utf8"):n=require("file").path(require("file").cwd()).join(t[1]).read({charset:"utf-8"}),exports.parser.parse(n)},typeof module!="undefined"&&require.main===module&&exports.main(typeof process!="undefined"?process.argv.slice(1):require("system").args)),Handlebars.Parser=handlebars,Handlebars.parse=function(e){return Handlebars.Parser.yy=Handlebars.AST,Handlebars.Parser.parse(e)},Handlebars.print=function(e){return(new Handlebars.PrintVisitor).accept(e)},Handlebars.logger={DEBUG:0,INFO:1,WARN:2,ERROR:3,level:3,log:function(e,t){}},Handlebars.log=function(e,t){Handlebars.logger.log(e,t)},function(){Handlebars.AST={},Handlebars.AST.ProgramNode=function(e,t){this.type="program",this.statements=e,t&&(this.inverse=new Handlebars.AST.ProgramNode(t))},Handlebars.AST.MustacheNode=function(e,t,n){this.type="mustache",this.escaped=!n,this.hash=t;var r=this.id=e[0],i=this.params=e.slice(1),s=this.eligibleHelper=r.isSimple;this.isHelper=s&&(i.length||t)},Handlebars.AST.PartialNode=function(e,t){this.type="partial",this.id=e,this.context=t};var e=function(e,t){if(e.original!==t.original)throw new Handlebars.Exception(e.original+" doesn't match "+t.original)};Handlebars.AST.BlockNode=function(t,n,r,i){e(t.id,i),this.type="block",this.mustache=t,this.program=n,this.inverse=r,this.inverse&&!this.program&&(this.isInverse=!0)},Handlebars.AST.ContentNode=function(e){this.type="content",this.string=e},Handlebars.AST.HashNode=function(e){this.type="hash",this.pairs=e},Handlebars.AST.IdNode=function(e){this.type="ID",this.original=e.join(".");var t=[],n=0;for(var r=0,i=e.length;r<i;r++){var s=e[r];s===".."?n++:s==="."||s==="this"?this.isScoped=!0:t.push(s)}this.parts=t,this.string=t.join("."),this.depth=n,this.isSimple=e.length===1&&!this.isScoped&&n===0},Handlebars.AST.DataNode=function(e){this.type="DATA",this.id=e},Handlebars.AST.StringNode=function(e){this.type="STRING",this.string=e},Handlebars.AST.IntegerNode=function(e){this.type="INTEGER",this.integer=e},Handlebars.AST.BooleanNode=function(e){this.type="BOOLEAN",this.bool=e},Handlebars.AST.CommentNode=function(e){this.type="comment",this.comment=e}}();var errorProps=["description","fileName","lineNumber","message","name","number","stack"];Handlebars.Exception=function(e){var t=Error.prototype.constructor.apply(this,arguments);for(var n=0;n<errorProps.length;n++)this[errorProps[n]]=t[errorProps[n]]},Handlebars.Exception.prototype=new Error,Handlebars.SafeString=function(e){this.string=e},Handlebars.SafeString.prototype.toString=function(){return this.string.toString()},function(){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},t=/[&<>"'`]/g,n=/[&<>"'`]/,r=function(t){return e[t]||"&amp;"};Handlebars.Utils={escapeExpression:function(e){return e instanceof Handlebars.SafeString?e.toString():e==null||e===!1?"":n.test(e)?e.replace(t,r):e},isEmpty:function(e){return typeof e=="undefined"?!0:e===null?!0:e===!1?!0:Object.prototype.toString.call(e)==="[object Array]"&&e.length===0?!0:!1}}}(),Handlebars.Compiler=function(){},Handlebars.JavaScriptCompiler=function(){},function(e,t){e.prototype={compiler:e,disassemble:function(){var e=this.opcodes,t,n=[],r,i;for(var s=0,o=e.length;s<o;s++){t=e[s];if(t.opcode==="DECLARE")n.push("DECLARE "+t.name+"="+t.value);else{r=[];for(var u=0;u<t.args.length;u++)i=t.args[u],typeof i=="string"&&(i='"'+i.replace("\n","\\n")+'"'),r.push(i);n.push(t.opcode+" "+r.join(" "))}}return n.join("\n")},guid:0,compile:function(e,t){this.children=[],this.depths={list:[]},this.options=t;var n=this.options.knownHelpers;this.options.knownHelpers={helperMissing:!0,blockHelperMissing:!0,each:!0,"if":!0,unless:!0,"with":!0,log:!0};if(n)for(var r in n)this.options.knownHelpers[r]=n[r];return this.program(e)},accept:function(e){return this[e.type](e)},program:function(e){var t=e.statements,n;this.opcodes=[];for(var r=0,i=t.length;r<i;r++)n=t[r],this[n.type](n);return this.isSimple=i===1,this.depths.list=this.depths.list.sort(function(e,t){return e-t}),this},compileProgram:function(e){var t=(new this.compiler).compile(e,this.options),n=this.guid++,r;this.usePartial=this.usePartial||t.usePartial,this.children[n]=t;for(var i=0,s=t.depths.list.length;i<s;i++){r=t.depths.list[i];if(r<2)continue;this.addDepth(r-1)}return n},block:function(e){var t=e.mustache,n=e.program,r=e.inverse;n&&(n=this.compileProgram(n)),r&&(r=this.compileProgram(r));var i=this.classifyMustache(t);i==="helper"?this.helperMustache(t,n,r):i==="simple"?(this.simpleMustache(t),this.opcode("pushProgram",n),this.opcode("pushProgram",r),this.opcode("pushLiteral","{}"),this.opcode("blockValue")):(this.ambiguousMustache(t,n,r),this.opcode("pushProgram",n),this.opcode("pushProgram",r),this.opcode("pushLiteral","{}"),this.opcode("ambiguousBlockValue")),this.opcode("append")},hash:function(e){var t=e.pairs,n,r;this.opcode("push","{}");for(var i=0,s=t.length;i<s;i++)n=t[i],r=n[1],this.accept(r),this.opcode("assignToHash",n[0])},partial:function(e){var t=e.id;this.usePartial=!0,e.context?this.ID(e.context):this.opcode("push","depth0"),this.opcode("invokePartial",t.original),this.opcode("append")},content:function(e){this.opcode("appendContent",e.string)},mustache:function(e){var t=this.options,n=this.classifyMustache(e);n==="simple"?this.simpleMustache(e):n==="helper"?this.helperMustache(e):this.ambiguousMustache(e),e.escaped&&!t.noEscape?this.opcode("appendEscaped"):this.opcode("append")},ambiguousMustache:function(e,t,n){var r=e.id,i=r.parts[0];this.opcode("getContext",r.depth),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("invokeAmbiguous",i)},simpleMustache:function(e,t,n){var r=e.id;r.type==="DATA"?this.DATA(r):r.parts.length?this.ID(r):(this.addDepth(r.depth),this.opcode("getContext",r.depth),this.opcode("pushContext")),this.opcode("resolvePossibleLambda")},helperMustache:function(e,t,n){var r=this.setupFullMustacheParams(e,t,n),i=e.id.parts[0];if(this.options.knownHelpers[i])this.opcode("invokeKnownHelper",r.length,i);else{if(this.knownHelpersOnly)throw new Error("You specified knownHelpersOnly, but used the unknown helper "+i);this.opcode("invokeHelper",r.length,i)}},ID:function(e){this.addDepth(e.depth),this.opcode("getContext",e.depth);var t=e.parts[0];t?this.opcode("lookupOnContext",e.parts[0]):this.opcode("pushContext");for(var n=1,r=e.parts.length;n<r;n++)this.opcode("lookup",e.parts[n])},DATA:function(e){this.options.data=!0,this.opcode("lookupData",e.id)},STRING:function(e){this.opcode("pushString",e.string)},INTEGER:function(e){this.opcode("pushLiteral",e.integer)},BOOLEAN:function(e){this.opcode("pushLiteral",e.bool)},comment:function(){},opcode:function(e){this.opcodes.push({opcode:e,args:[].slice.call(arguments,1)})},declare:function(e,t){this.opcodes.push({opcode:"DECLARE",name:e,value:t})},addDepth:function(e){if(isNaN(e))throw new Error("EWOT");if(e===0)return;this.depths[e]||(this.depths[e]=!0,this.depths.list.push(e))},classifyMustache:function(e){var t=e.isHelper,n=e.eligibleHelper,r=this.options;if(n&&!t){var i=e.id.parts[0];r.knownHelpers[i]?t=!0:r.knownHelpersOnly&&(n=!1)}return t?"helper":n?"ambiguous":"simple"},pushParams:function(e){var t=e.length,n;while(t--)n=e[t],this.options.stringParams?(n.depth&&this.addDepth(n.depth),this.opcode("getContext",n.depth||0),this.opcode("pushStringParam",n.string)):this[n.type](n)},setupMustacheParams:function(e){var t=e.params;return this.pushParams(t),e.hash?this.hash(e.hash):this.opcode("pushLiteral","{}"),t},setupFullMustacheParams:function(e,t,n){var r=e.params;return this.pushParams(r),this.opcode("pushProgram",t),this.opcode("pushProgram",n),e.hash?this.hash(e.hash):this.opcode("pushLiteral","{}"),r}};var n=function(e){this.value=e};t.prototype={nameLookup:function(e,n,r){return/^[0-9]+$/.test(n)?e+"["+n+"]":t.isValidJavaScriptVariableName(n)?e+"."+n:e+"['"+n+"']"},appendToBuffer:function(e){return this.environment.isSimple?"return "+e+";":"buffer += "+e+";"},initializeBuffer:function(){return this.quotedString("")},namespace:"Handlebars",compile:function(e,t,n,r){this.environment=e,this.options=t||{},Handlebars.log(Handlebars.logger.DEBUG,this.environment.disassemble()+"\n\n"),this.name=this.environment.name,this.isChild=!!n,this.context=n||{programs:[],aliases:{}},this.preamble(),this.stackSlot=0,this.stackVars=[],this.registers={list:[]},this.compileStack=[],this.compileChildren(e,t);var i=e.opcodes,s;this.i=0;for(o=i.length;this.i<o;this.i++)s=i[this.i],s.opcode==="DECLARE"?this[s.name]=s.value:this[s.opcode].apply(this,s.args);return this.createFunctionContext(r)},nextOpcode:function(){var e=this.environment.opcodes,t=e[this.i+1];return e[this.i+1]},eat:function(e){this.i=this.i+1},preamble:function(){var e=[];if(!this.isChild){var t=this.namespace,n="helpers = helpers || "+t+".helpers;";this.environment.usePartial&&(n=n+" partials = partials || "+t+".partials;"),this.options.data&&(n+=" data = data || {};"),e.push(n)}else e.push("");this.environment.isSimple?e.push(""):e.push(", buffer = "+this.initializeBuffer()),this.lastContext=0,this.source=e},createFunctionContext:function(e){var t=this.stackVars.concat(this.registers.list);t.length>0&&(this.source[1]=this.source[1]+", "+t.join(", "));if(!this.isChild){var n=[];for(var r in this.context.aliases)this.source[1]=this.source[1]+", "+r+"="+this.context.aliases[r]}this.source[1]&&(this.source[1]="var "+this.source[1].substring(2)+";"),this.isChild||(this.source[1]+="\n"+this.context.programs.join("\n")+"\n"),this.environment.isSimple||this.source.push("return buffer;");var i=this.isChild?["depth0","data"]:["Handlebars","depth0","helpers","partials","data"];for(var s=0,o=this.environment.depths.list.length;s<o;s++)i.push("depth"+this.environment.depths.list[s]);if(e)return i.push(this.source.join("\n  ")),Function.apply(this,i);var u="function "+(this.name||"")+"("+i.join(",")+") {\n  "+this.source.join("\n  ")+"}";return Handlebars.log(Handlebars.logger.DEBUG,u+"\n\n"),u},blockValue:function(){this.context.aliases.blockHelperMissing="helpers.blockHelperMissing";var e=["depth0"];this.setupParams(0,e),this.replaceStack(function(t){return e.splice(1,0,t),t+" = blockHelperMissing.call("+e.join(", ")+")"})},ambiguousBlockValue:function(){this.context.aliases.blockHelperMissing="helpers.blockHelperMissing";var e=["depth0"];this.setupParams(0,e);var t=this.topStack();e.splice(1,0,t),this.source.push("if (!"+this.lastHelper+") { "+t+" = blockHelperMissing.call("+e.join(", ")+"); }")},appendContent:function(e){this.source.push(this.appendToBuffer(this.quotedString(e)))},append:function(){var e=this.popStack();this.source.push("if("+e+" || "+e+" === 0) { "+this.appendToBuffer(e)+" }"),this.environment.isSimple&&this.source.push("else { "+this.appendToBuffer("''")+" }")},appendEscaped:function(){var e=this.nextOpcode(),t="";this.context.aliases.escapeExpression="this.escapeExpression",e&&e.opcode==="appendContent"&&(t=" + "+this.quotedString(e.args[0]),this.eat(e)),this.source.push(this.appendToBuffer("escapeExpression("+this.popStack()+")"+t))},getContext:function(e){this.lastContext!==e&&(this.lastContext=e)},lookupOnContext:function(e){this.pushStack(this.nameLookup("depth"+this.lastContext,e,"context"))},pushContext:function(){this.pushStackLiteral("depth"+this.lastContext)},resolvePossibleLambda:function(){this.context.aliases.functionType='"function"',this.replaceStack(function(e){return"typeof "+e+" === functionType ? "+e+".apply(depth0) : "+e})},lookup:function(e){this.replaceStack(function(t){return t+" == null || "+t+" === false ? "+t+" : "+this.nameLookup(t,e,"context")})},lookupData:function(e){this.pushStack(this.nameLookup("data",e,"data"))},pushStringParam:function(e){this.pushStackLiteral("depth"+this.lastContext),this.pushString(e)},pushString:function(e){this.pushStackLiteral(this.quotedString(e))},push:function(e){this.pushStack(e)},pushLiteral:function(e){this.pushStackLiteral(e)},pushProgram:function(e){e!=null?this.pushStackLiteral(this.programExpression(e)):this.pushStackLiteral(null)},invokeHelper:function(e,t){this.context.aliases.helperMissing="helpers.helperMissing";var n=this.lastHelper=this.setupHelper(e,t);this.register("foundHelper",n.name),this.pushStack("foundHelper ? foundHelper.call("+n.callParams+") "+": helperMissing.call("+n.helperMissingParams+")")},invokeKnownHelper:function(e,t){var n=this.setupHelper(e,t);this.pushStack(n.name+".call("+n.callParams+")")},invokeAmbiguous:function(e){this.context.aliases.functionType='"function"',this.pushStackLiteral("{}");var t=this.setupHelper(0,e),n=this.lastHelper=this.nameLookup("helpers",e,"helper");this.register("foundHelper",n);var r=this.nameLookup("depth"+this.lastContext,e,"context"),i=this.nextStack();this.source.push("if (foundHelper) { "+i+" = foundHelper.call("+t.callParams+"); }"),this.source.push("else { "+i+" = "+r+"; "+i+" = typeof "+i+" === functionType ? "+i+".apply(depth0) : "+i+"; }")},invokePartial:function(e){var t=[this.nameLookup("partials",e,"partial"),"'"+e+"'",this.popStack(),"helpers","partials"];this.options.data&&t.push("data"),this.context.aliases.self="this",this.pushStack("self.invokePartial("+t.join(", ")+");")},assignToHash:function(e){var t=this.popStack(),n=this.topStack();this.source.push(n+"['"+e+"'] = "+t+";")},compiler:t,compileChildren:function(e,t){var n=e.children,r,i;for(var s=0,o=n.length;s<o;s++){r=n[s],i=new this.compiler,this.context.programs.push("");var u=this.context.programs.length;r.index=u,r.name="program"+u,this.context.programs[u]=i.compile(r,t,this.context)}},programExpression:function(e){this.context.aliases.self="this";if(e==null)return"self.noop";var t=this.environment.children[e],n=t.depths.list,r,i=[t.index,t.name,"data"];for(var s=0,o=n.length;s<o;s++)r=n[s],r===1?i.push("depth0"):i.push("depth"+(r-1));return n.length===0?"self.program("+i.join(", ")+")":(i.shift(),"self.programWithDepth("+i.join(", ")+")")},register:function(e,t){this.useRegister(e),this.source.push(e+" = "+t+";")},useRegister:function(e){this.registers[e]||(this.registers[e]=!0,this.registers.list.push(e))},pushStackLiteral:function(e){return this.compileStack.push(new n(e)),e},pushStack:function(e){return this.source.push(this.incrStack()+" = "+e+";"),this.compileStack.push("stack"+this.stackSlot),"stack"+this.stackSlot},replaceStack:function(e){var t=e.call(this,this.topStack());return this.source.push(this.topStack()+" = "+t+";"),"stack"+this.stackSlot},nextStack:function(e){var t=this.incrStack();return this.compileStack.push("stack"+this.stackSlot),t},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),"stack"+this.stackSlot},popStack:function(){var e=this.compileStack.pop();return e instanceof n?e.value:(this.stackSlot--,e)},topStack:function(){var e=this.compileStack[this.compileStack.length-1];return e instanceof n?e.value:e},quotedString:function(e){if(!e)return '""';return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r")+'"'},setupHelper:function(e,t){var n=[];this.setupParams(e,n);var r=this.nameLookup("helpers",t,"helper");return{params:n,name:r,callParams:["depth0"].concat(n).join(", "),helperMissingParams:["depth0",this.quotedString(t)].concat(n).join(", ")}},setupParams:function(e,t){var n=[],r=[],i,s,o;n.push("hash:"+this.popStack()),s=this.popStack(),o=this.popStack();if(o||s)o||(this.context.aliases.self="this",o="self.noop"),s||(this.context.aliases.self="this",s="self.noop"),n.push("inverse:"+s),n.push("fn:"+o);for(var u=0;u<e;u++)i=this.popStack(),t.push(i),this.options.stringParams&&r.push(this.popStack());return this.options.stringParams&&n.push("contexts:["+r.join(",")+"]"),this.options.data&&n.push("data:data"),t.push("{"+n.join(",")+"}"),t.join(", ")}};var r="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield".split(" "),i=t.RESERVED_WORDS={};for(var s=0,o=r.length;s<o;s++)i[r[s]]=!0;t.isValidJavaScriptVariableName=function(e){return!t.RESERVED_WORDS[e]&&/^[a-zA-Z_$][0-9a-zA-Z_$]+$/.test(e)?!0:!1}}(Handlebars
.Compiler,Handlebars.JavaScriptCompiler),Handlebars.precompile=function(e,t){t=t||{};var n=Handlebars.parse(e),r=(new Handlebars.Compiler).compile(n,t);return(new Handlebars.JavaScriptCompiler).compile(r,t)},Handlebars.compile=function(e,t){function r(){var n=Handlebars.parse(e),r=(new Handlebars.Compiler).compile(n,t),i=(new Handlebars.JavaScriptCompiler).compile(r,t,undefined,!0);return Handlebars.template(i)}t=t||{};var n;return function(e,t){return n||(n=r()),n.call(this,e,t)}},Handlebars.VM={template:function(e){var t={escapeExpression:Handlebars.Utils.escapeExpression,invokePartial:Handlebars.VM.invokePartial,programs:[],program:function(e,t,n){var r=this.programs[e];return n?Handlebars.VM.program(t,n):r?r:(r=this.programs[e]=Handlebars.VM.program(t),r)},programWithDepth:Handlebars.VM.programWithDepth,noop:Handlebars.VM.noop};return function(n,r){return r=r||{},e.call(t,Handlebars,n,r.helpers,r.partials,r.data)}},programWithDepth:function(e,t,n){var r=Array.prototype.slice.call(arguments,2);return function(n,i){return i=i||{},e.apply(this,[n,i.data||t].concat(r))}},program:function(e,t){return function(n,r){return r=r||{},e(n,r.data||t)}},noop:function(){return""},invokePartial:function(e,t,n,r,i,s){var o={helpers:r,partials:i,data:s};if(e===undefined)throw new Handlebars.Exception("The partial "+t+" could not be found");if(e instanceof Function)return e(n,o);if(!Handlebars.compile)throw new Handlebars.Exception("The partial "+t+" could not be compiled when running in runtime-only mode");return i[t]=Handlebars.compile(e,{data:s!==undefined}),i[t](n,o)}},Handlebars.template=Handlebars.VM.template;/*
 * FancyBox - jQuery Plugin
 * Simple and fancy lightbox alternative
 *
 * Examples and documentation at: http://fancybox.net
 *
 * Copyright (c) 2008 - 2010 Janis Skarnelis
 * That said, it is hardly a one-person project. Many people have submitted bugs, code, and offered their advice freely. Their support is greatly appreciated.
 *
 * Version: 1.3.4 (11/11/2010)
 * Requires: jQuery v1.3+
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */

;(function($) {
	var tmp, loading, overlay, wrap, outer, content, close, title, nav_left, nav_right,

		selectedIndex = 0, selectedOpts = {}, selectedArray = [], currentIndex = 0, currentOpts = {}, currentArray = [],

		ajaxLoader = null, imgPreloader = new Image(), imgRegExp = /\.(jpg|gif|png|bmp|jpeg)(.*)?$/i, swfRegExp = /[^\.]\.(swf)\s*$/i,

		loadingTimer, loadingFrame = 1,

		titleHeight = 0, titleStr = '', start_pos, final_pos, busy = false, fx = $.extend($('<div/>')[0], { prop: 0 }),

		isIE6 = $.browser.msie && $.browser.version < 7 && !window.XMLHttpRequest,

		/*
		 * Private methods 
		 */

		_abort = function() {
			loading.hide();

			imgPreloader.onerror = imgPreloader.onload = null;

			if (ajaxLoader) {
				ajaxLoader.abort();
			}

			tmp.empty();
		},

		_error = function() {
			if (false === selectedOpts.onError(selectedArray, selectedIndex, selectedOpts)) {
				loading.hide();
				busy = false;
				return;
			}

			selectedOpts.titleShow = false;

			selectedOpts.width = 'auto';
			selectedOpts.height = 'auto';

			tmp.html( '<p id="fancybox-error">The requested content cannot be loaded.<br />Please try again later.</p>' );

			_process_inline();
		},

		_start = function() {
			var obj = selectedArray[ selectedIndex ],
				href, 
				type, 
				title,
				str,
				emb,
				ret;

			_abort();

			selectedOpts = $.extend({}, $.fn.fancybox.defaults, (typeof $(obj).data('fancybox') == 'undefined' ? selectedOpts : $(obj).data('fancybox')));

			ret = selectedOpts.onStart(selectedArray, selectedIndex, selectedOpts);

			if (ret === false) {
				busy = false;
				return;
			} else if (typeof ret == 'object') {
				selectedOpts = $.extend(selectedOpts, ret);
			}

			title = selectedOpts.title || (obj.nodeName ? $(obj).attr('title') : obj.title) || '';

			if (obj.nodeName && !selectedOpts.orig) {
				selectedOpts.orig = $(obj).children("img:first").length ? $(obj).children("img:first") : $(obj);
			}

			if (title === '' && selectedOpts.orig && selectedOpts.titleFromAlt) {
				title = selectedOpts.orig.attr('alt');
			}

			href = selectedOpts.href || (obj.nodeName ? $(obj).attr('href') : obj.href) || null;

			if ((/^(?:javascript)/i).test(href) || href == '#') {
				href = null;
			}

			if (selectedOpts.type) {
				type = selectedOpts.type;

				if (!href) {
					href = selectedOpts.content;
				}

			} else if (selectedOpts.content) {
				type = 'html';

			} else if (href) {
				if (href.match(imgRegExp)) {
					type = 'image';

				} else if (href.match(swfRegExp)) {
					type = 'swf';

				} else if ($(obj).hasClass("iframe")) {
					type = 'iframe';

				} else if (href.indexOf("#") === 0) {
					type = 'inline';

				} else {
					type = 'ajax';
				}
			}

			if (!type) {
				_error();
				return;
			}

			if (type == 'inline') {
				obj	= href.substr(href.indexOf("#"));
				type = $(obj).length > 0 ? 'inline' : 'ajax';
			}

			selectedOpts.type = type;
			selectedOpts.href = href;
			selectedOpts.title = title;

			if (selectedOpts.autoDimensions) {
				if (selectedOpts.type == 'html' || selectedOpts.type == 'inline' || selectedOpts.type == 'ajax') {
					selectedOpts.width = 'auto';
					selectedOpts.height = 'auto';
				} else {
					selectedOpts.autoDimensions = false;	
				}
			}

			if (selectedOpts.modal) {
				selectedOpts.overlayShow = true;
				selectedOpts.hideOnOverlayClick = false;
				selectedOpts.hideOnContentClick = false;
				selectedOpts.enableEscapeButton = false;
				selectedOpts.showCloseButton = false;
			}

			selectedOpts.padding = parseInt(selectedOpts.padding, 10);
			selectedOpts.margin = parseInt(selectedOpts.margin, 10);

			tmp.css('padding', (selectedOpts.padding + selectedOpts.margin));

			$('.fancybox-inline-tmp').unbind('fancybox-cancel').bind('fancybox-change', function() {
				$(this).replaceWith(content.children());				
			});

			switch (type) {
				case 'html' :
					tmp.html( selectedOpts.content );
					_process_inline();
				break;

				case 'inline' :
					if ( $(obj).parent().is('#fancybox-content') === true) {
						busy = false;
						return;
					}

					$('<div class="fancybox-inline-tmp" />')
						.hide()
						.insertBefore( $(obj) )
						.bind('fancybox-cleanup', function() {
							$(this).replaceWith(content.children());
						}).bind('fancybox-cancel', function() {
							$(this).replaceWith(tmp.children());
						});

					$(obj).appendTo(tmp);

					_process_inline();
				break;

				case 'image':
					busy = false;

					$.fancybox.showActivity();

					imgPreloader = new Image();

					imgPreloader.onerror = function() {
						_error();
					};

					imgPreloader.onload = function() {
						busy = true;

						imgPreloader.onerror = imgPreloader.onload = null;

						_process_image();
					};

					imgPreloader.src = href;
				break;

				case 'swf':
					selectedOpts.scrolling = 'no';

					str = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="' + selectedOpts.width + '" height="' + selectedOpts.height + '"><param name="movie" value="' + href + '"></param>';
					emb = '';

					$.each(selectedOpts.swf, function(name, val) {
						str += '<param name="' + name + '" value="' + val + '"></param>';
						emb += ' ' + name + '="' + val + '"';
					});

					str += '<embed src="' + href + '" type="application/x-shockwave-flash" width="' + selectedOpts.width + '" height="' + selectedOpts.height + '"' + emb + '></embed></object>';

					tmp.html(str);

					_process_inline();
				break;

				case 'ajax':
					busy = false;

					$.fancybox.showActivity();

					selectedOpts.ajax.win = selectedOpts.ajax.success;

					ajaxLoader = $.ajax($.extend({}, selectedOpts.ajax, {
						url	: href,
						data : selectedOpts.ajax.data || {},
						error : function(XMLHttpRequest, textStatus, errorThrown) {
							if ( XMLHttpRequest.status > 0 ) {
								_error();
							}
						},
						success : function(data, textStatus, XMLHttpRequest) {
							var o = typeof XMLHttpRequest == 'object' ? XMLHttpRequest : ajaxLoader;
							if (o.status == 200) {
								if ( typeof selectedOpts.ajax.win == 'function' ) {
									ret = selectedOpts.ajax.win(href, data, textStatus, XMLHttpRequest);

									if (ret === false) {
										loading.hide();
										return;
									} else if (typeof ret == 'string' || typeof ret == 'object') {
										data = ret;
									}
								}

								tmp.html( data );
								_process_inline();
							}
						}
					}));

				break;

				case 'iframe':
					_show();
				break;
			}
		},

		_process_inline = function() {
			var
				w = selectedOpts.width,
				h = selectedOpts.height;

			if (w.toString().indexOf('%') > -1) {
				w = parseInt( ($(window).width() - (selectedOpts.margin * 2)) * parseFloat(w) / 100, 10) + 'px';

			} else {
				w = w == 'auto' ? 'auto' : w + 'px';	
			}

			if (h.toString().indexOf('%') > -1) {
				h = parseInt( ($(window).height() - (selectedOpts.margin * 2)) * parseFloat(h) / 100, 10) + 'px';

			} else {
				h = h == 'auto' ? 'auto' : h + 'px';	
			}

			tmp.wrapInner('<div style="width:' + w + ';height:' + h + ';overflow: ' + (selectedOpts.scrolling == 'auto' ? 'auto' : (selectedOpts.scrolling == 'yes' ? 'scroll' : 'hidden')) + ';position:relative;"></div>');

			selectedOpts.width = tmp.width();
			selectedOpts.height = tmp.height();

			_show();
		},

		_process_image = function() {
			selectedOpts.width = imgPreloader.width;
			selectedOpts.height = imgPreloader.height;

			$("<img />").attr({
				'id' : 'fancybox-img',
				'src' : imgPreloader.src,
				'alt' : selectedOpts.title
			}).appendTo( tmp );

			_show();
		},

		_show = function() {
			var pos, equal;

			loading.hide();

			if (wrap.is(":visible") && false === currentOpts.onCleanup(currentArray, currentIndex, currentOpts)) {
				$.event.trigger('fancybox-cancel');

				busy = false;
				return;
			}

			busy = true;

			$(content.add( overlay )).unbind();

			$(window).unbind("resize.fb scroll.fb");
			$(document).unbind('keydown.fb');

			if (wrap.is(":visible") && currentOpts.titlePosition !== 'outside') {
				wrap.css('height', wrap.height());
			}

			currentArray = selectedArray;
			currentIndex = selectedIndex;
			currentOpts = selectedOpts;

			if (currentOpts.overlayShow) {
				overlay.css({
					'background-color' : currentOpts.overlayColor,
					'opacity' : currentOpts.overlayOpacity,
					'cursor' : currentOpts.hideOnOverlayClick ? 'pointer' : 'auto',
					'height' : $(document).height()
				});

				if (!overlay.is(':visible')) {
					if (isIE6) {
						$('select:not(#fancybox-tmp select)').filter(function() {
							return this.style.visibility !== 'hidden';
						}).css({'visibility' : 'hidden'}).one('fancybox-cleanup', function() {
							this.style.visibility = 'inherit';
						});
					}

					overlay.show();
				}
			} else {
				overlay.hide();
			}

			final_pos = _get_zoom_to();

			_process_title();

			if (wrap.is(":visible")) {
				$( close.add( nav_left ).add( nav_right ) ).hide();

				pos = wrap.position(),

				start_pos = {
					top	 : pos.top,
					left : pos.left,
					width : wrap.width(),
					height : wrap.height()
				};

				equal = (start_pos.width == final_pos.width && start_pos.height == final_pos.height);

				content.fadeTo(currentOpts.changeFade, 0.3, function() {
					var finish_resizing = function() {
						content.html( tmp.contents() ).fadeTo(currentOpts.changeFade, 1, _finish);
					};

					$.event.trigger('fancybox-change');

					content
						.empty()
						.removeAttr('filter')
						.css({
							'border-width' : currentOpts.padding,
							'width'	: final_pos.width - currentOpts.padding * 2,
							'height' : selectedOpts.autoDimensions ? 'auto' : final_pos.height - titleHeight - currentOpts.padding * 2
						});

					if (equal) {
						finish_resizing();

					} else {
						fx.prop = 0;

						$(fx).animate({prop: 1}, {
							 duration : currentOpts.changeSpeed,
							 easing : currentOpts.easingChange,
							 step : _draw,
							 complete : finish_resizing
						});
					}
				});

				return;
			}

			wrap.removeAttr("style");

			content.css('border-width', currentOpts.padding);

			if (currentOpts.transitionIn == 'elastic') {
				start_pos = _get_zoom_from();

				content.html( tmp.contents() );

				wrap.show();

				if (currentOpts.opacity) {
					final_pos.opacity = 0;
				}

				fx.prop = 0;

				$(fx).animate({prop: 1}, {
					 duration : currentOpts.speedIn,
					 easing : currentOpts.easingIn,
					 step : _draw,
					 complete : _finish
				});

				return;
			}

			if (currentOpts.titlePosition == 'inside' && titleHeight > 0) {	
				title.show();	
			}

			content
				.css({
					'width' : final_pos.width - currentOpts.padding * 2,
					'height' : selectedOpts.autoDimensions ? 'auto' : final_pos.height - titleHeight - currentOpts.padding * 2
				})
				.html( tmp.contents() );

			wrap
				.css(final_pos)
				.fadeIn( currentOpts.transitionIn == 'none' ? 0 : currentOpts.speedIn, _finish );
		},

		_format_title = function(title) {
			if (title && title.length) {
				if (currentOpts.titlePosition == 'float') {
					return '<table id="fancybox-title-float-wrap" cellpadding="0" cellspacing="0"><tr><td id="fancybox-title-float-left"></td><td id="fancybox-title-float-main">' + title + '</td><td id="fancybox-title-float-right"></td></tr></table>';
				}

				return '<div id="fancybox-title-' + currentOpts.titlePosition + '">' + title + '</div>';
			}

			return false;
		},

		_process_title = function() {
			titleStr = currentOpts.title || '';
			titleHeight = 0;

			title
				.empty()
				.removeAttr('style')
				.removeClass();

			if (currentOpts.titleShow === false) {
				title.hide();
				return;
			}

			titleStr = $.isFunction(currentOpts.titleFormat) ? currentOpts.titleFormat(titleStr, currentArray, currentIndex, currentOpts) : _format_title(titleStr);

			if (!titleStr || titleStr === '') {
				title.hide();
				return;
			}

			title
				.addClass('fancybox-title-' + currentOpts.titlePosition)
				.html( titleStr )
				.appendTo( 'body' )
				.show();

			switch (currentOpts.titlePosition) {
				case 'inside':
					title
						.css({
							'width' : final_pos.width - (currentOpts.padding * 2),
							'marginLeft' : currentOpts.padding,
							'marginRight' : currentOpts.padding
						});

					titleHeight = title.outerHeight(true);

					title.appendTo( outer );

					final_pos.height += titleHeight;
				break;

				case 'over':
					title
						.css({
							'marginLeft' : currentOpts.padding,
							'width'	: final_pos.width - (currentOpts.padding * 2),
							'bottom' : currentOpts.padding
						})
						.appendTo( outer );
				break;

				case 'float':
					title
						.css('left', parseInt((title.width() - final_pos.width - 40)/ 2, 10) * -1)
						.appendTo( wrap );
				break;

				default:
					title
						.css({
							'width' : final_pos.width - (currentOpts.padding * 2),
							'paddingLeft' : currentOpts.padding,
							'paddingRight' : currentOpts.padding
						})
						.appendTo( wrap );
				break;
			}

			title.hide();
		},

		_set_navigation = function() {
			if (currentOpts.enableEscapeButton || currentOpts.enableKeyboardNav) {
				$(document).bind('keydown.fb', function(e) {
					if (e.keyCode == 27 && currentOpts.enableEscapeButton) {
						e.preventDefault();
						$.fancybox.close();

					} else if ((e.keyCode == 37 || e.keyCode == 39) && currentOpts.enableKeyboardNav && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
						e.preventDefault();
						$.fancybox[ e.keyCode == 37 ? 'prev' : 'next']();
					}
				});
			}

			if (!currentOpts.showNavArrows) { 
				nav_left.hide();
				nav_right.hide();
				return;
			}

			if ((currentOpts.cyclic && currentArray.length > 1) || currentIndex !== 0) {
				nav_left.show();
			}

			if ((currentOpts.cyclic && currentArray.length > 1) || currentIndex != (currentArray.length -1)) {
				nav_right.show();
			}
		},

		_finish = function () {
			if (!$.support.opacity) {
				content.get(0).style.removeAttribute('filter');
				wrap.get(0).style.removeAttribute('filter');
			}

			if (selectedOpts.autoDimensions) {
				content.css('height', 'auto');
			}

			wrap.css('height', 'auto');

			if (titleStr && titleStr.length) {
				title.show();
			}

			if (currentOpts.showCloseButton) {
				close.show();
			}

			_set_navigation();
	
			if (currentOpts.hideOnContentClick)	{
				content.bind('click', $.fancybox.close);
			}

			if (currentOpts.hideOnOverlayClick)	{
				overlay.bind('click', $.fancybox.close);
			}

			$(window).bind("resize.fb", $.fancybox.resize);

			if (currentOpts.centerOnScroll) {
				$(window).bind("scroll.fb", $.fancybox.center);
			}

			if (currentOpts.type == 'iframe') {
				$('<iframe id="fancybox-frame" name="fancybox-frame' + new Date().getTime() + '" frameborder="0" hspace="0" ' + ($.browser.msie ? 'allowtransparency="true""' : '') + ' scrolling="' + selectedOpts.scrolling + '" src="' + currentOpts.href + '"></iframe>').appendTo(content);
			}

			wrap.show();

			busy = false;

			$.fancybox.center();

			currentOpts.onComplete(currentArray, currentIndex, currentOpts);

			_preload_images();
		},

		_preload_images = function() {
			var href, 
				objNext;

			if ((currentArray.length -1) > currentIndex) {
				href = currentArray[ currentIndex + 1 ].href;

				if (typeof href !== 'undefined' && href.match(imgRegExp)) {
					objNext = new Image();
					objNext.src = href;
				}
			}

			if (currentIndex > 0) {
				href = currentArray[ currentIndex - 1 ].href;

				if (typeof href !== 'undefined' && href.match(imgRegExp)) {
					objNext = new Image();
					objNext.src = href;
				}
			}
		},

		_draw = function(pos) {
			var dim = {
				width : parseInt(start_pos.width + (final_pos.width - start_pos.width) * pos, 10),
				height : parseInt(start_pos.height + (final_pos.height - start_pos.height) * pos, 10),

				top : parseInt(start_pos.top + (final_pos.top - start_pos.top) * pos, 10),
				left : parseInt(start_pos.left + (final_pos.left - start_pos.left) * pos, 10)
			};

			if (typeof final_pos.opacity !== 'undefined') {
				dim.opacity = pos < 0.5 ? 0.5 : pos;
			}

			wrap.css(dim);

			content.css({
				'width' : dim.width - currentOpts.padding * 2,
				'height' : dim.height - (titleHeight * pos) - currentOpts.padding * 2
			});
		},

		_get_viewport = function() {
			var isFixed = wrap.css('position') === 'fixed';
			return [
				$(window).width() - (currentOpts.margin * 2),
				$(window).height() - (currentOpts.margin * 2),
				(isFixed ? 0 : $(document).scrollLeft()) + currentOpts.margin,
				(isFixed ? 0 : $(document).scrollTop()) + currentOpts.margin
			];
		},

		_get_zoom_to = function () {
			var view = _get_viewport(),
				to = {},
				resize = currentOpts.autoScale,
				double_padding = currentOpts.padding * 2,
				ratio;

			if (currentOpts.width.toString().indexOf('%') > -1) {
				to.width = parseInt((view[0] * parseFloat(currentOpts.width)) / 100, 10);
			} else {
				to.width = currentOpts.width + double_padding;
			}

			if (currentOpts.height.toString().indexOf('%') > -1) {
				to.height = parseInt((view[1] * parseFloat(currentOpts.height)) / 100, 10);
			} else {
				to.height = currentOpts.height + double_padding;
			}

			if (resize && (to.width > view[0] || to.height > view[1])) {
				if (selectedOpts.type == 'image' || selectedOpts.type == 'swf') {
					ratio = (currentOpts.width ) / (currentOpts.height );

					if ((to.width ) > view[0]) {
						to.width = view[0];
						to.height = parseInt(((to.width - double_padding) / ratio) + double_padding, 10);
					}

					if ((to.height) > view[1]) {
						to.height = view[1];
						to.width = parseInt(((to.height - double_padding) * ratio) + double_padding, 10);
					}

				} else {
					to.width = Math.min(to.width, view[0]);
					to.height = Math.min(to.height, view[1]);
				}
			}

			to.top = parseInt(Math.max(view[3] - 20, view[3] + ((view[1] - to.height - 40) * 0.5)), 10);
			to.left = parseInt(Math.max(view[2] - 20, view[2] + ((view[0] - to.width - 40) * 0.5)), 10);

			return to;
		},

		_get_obj_pos = function(obj) {
			var pos = obj.offset();

			pos.top += parseInt( obj.css('paddingTop'), 10 ) || 0;
			pos.left += parseInt( obj.css('paddingLeft'), 10 ) || 0;

			pos.top += parseInt( obj.css('border-top-width'), 10 ) || 0;
			pos.left += parseInt( obj.css('border-left-width'), 10 ) || 0;

			pos.width = obj.width();
			pos.height = obj.height();

			return pos;
		},

		_get_zoom_from = function() {
			var orig = selectedOpts.orig ? $(selectedOpts.orig) : false,
				from = {},
				pos,
				view;

			if (orig && orig.length) {
				pos = _get_obj_pos(orig);

				from = {
					width : pos.width + (currentOpts.padding * 2),
					height : pos.height + (currentOpts.padding * 2),
					top	: pos.top - currentOpts.padding - 20,
					left : pos.left - currentOpts.padding - 20
				};

			} else {
				view = _get_viewport();

				from = {
					width : currentOpts.padding * 2,
					height : currentOpts.padding * 2,
					top	: parseInt(view[3] + view[1] * 0.5, 10),
					left : parseInt(view[2] + view[0] * 0.5, 10)
				};
			}

			return from;
		},

		_animate_loading = function() {
			if (!loading.is(':visible')){
				clearInterval(loadingTimer);
				return;
			}

			$('div', loading).css('top', (loadingFrame * -40) + 'px');

			loadingFrame = (loadingFrame + 1) % 12;
		};

	/*
	 * Public methods 
	 */

	$.fn.fancybox = function(options) {
		if (!$(this).length) {
			return this;
		}

		$(this)
			.data('fancybox', $.extend({}, options, ($.metadata ? $(this).metadata() : {})))
			.unbind('click.fb')
			.bind('click.fb', function(e) {
				e.preventDefault();

				if (busy) {
					return;
				}

				busy = true;

				$(this).blur();

				selectedArray = [];
				selectedIndex = 0;

				var rel = $(this).attr('rel') || '';

				if (!rel || rel == '' || rel === 'nofollow') {
					selectedArray.push(this);

				} else {
					selectedArray = $("a[rel=" + rel + "], area[rel=" + rel + "]");
					selectedIndex = selectedArray.index( this );
				}

				_start();

				return;
			});

		return this;
	};

	$.fancybox = function(obj) {
		var opts;

		if (busy) {
			return;
		}

		busy = true;
		opts = typeof arguments[1] !== 'undefined' ? arguments[1] : {};

		selectedArray = [];
		selectedIndex = parseInt(opts.index, 10) || 0;

		if ($.isArray(obj)) {
			for (var i = 0, j = obj.length; i < j; i++) {
				if (typeof obj[i] == 'object') {
					$(obj[i]).data('fancybox', $.extend({}, opts, obj[i]));
				} else {
					obj[i] = $({}).data('fancybox', $.extend({content : obj[i]}, opts));
				}
			}

			selectedArray = jQuery.merge(selectedArray, obj);

		} else {
			if (typeof obj == 'object') {
				$(obj).data('fancybox', $.extend({}, opts, obj));
			} else {
				obj = $({}).data('fancybox', $.extend({content : obj}, opts));
			}

			selectedArray.push(obj);
		}

		if (selectedIndex > selectedArray.length || selectedIndex < 0) {
			selectedIndex = 0;
		}

		_start();
	};

	$.fancybox.showActivity = function() {
		clearInterval(loadingTimer);

		loading.show();
		loadingTimer = setInterval(_animate_loading, 66);
	};

	$.fancybox.hideActivity = function() {
		loading.hide();
	};

	$.fancybox.next = function() {
		return $.fancybox.pos( currentIndex + 1);
	};

	$.fancybox.prev = function() {
		return $.fancybox.pos( currentIndex - 1);
	};

	$.fancybox.pos = function(pos) {
		if (busy) {
			return;
		}

		pos = parseInt(pos);

		selectedArray = currentArray;

		if (pos > -1 && pos < currentArray.length) {
			selectedIndex = pos;
			_start();

		} else if (currentOpts.cyclic && currentArray.length > 1) {
			selectedIndex = pos >= currentArray.length ? 0 : currentArray.length - 1;
			_start();
		}

		return;
	};

	$.fancybox.cancel = function() {
		if (busy) {
			return;
		}

		busy = true;

		$.event.trigger('fancybox-cancel');

		_abort();

		selectedOpts.onCancel(selectedArray, selectedIndex, selectedOpts);

		busy = false;
	};

	// Note: within an iframe use - parent.$.fancybox.close();
	$.fancybox.close = function() {
		if (busy || wrap.is(':hidden')) {
			return;
		}

		busy = true;

		if (currentOpts && false === currentOpts.onCleanup(currentArray, currentIndex, currentOpts)) {
			busy = false;
			return;
		}

		_abort();

		$(close.add( nav_left ).add( nav_right )).hide();

		$(content.add( overlay )).unbind();

		$(window).unbind("resize.fb scroll.fb");
		$(document).unbind('keydown.fb');

		content.find('iframe').attr('src', isIE6 && /^https/i.test(window.location.href || '') ? 'javascript:void(false)' : 'about:blank');

		if (currentOpts.titlePosition !== 'inside') {
			title.empty();
		}

		wrap.stop();

		function _cleanup() {
			overlay.fadeOut('fast');

			title.empty().hide();
			wrap.hide();

			$.event.trigger('fancybox-cleanup');

			content.empty();

			currentOpts.onClosed(currentArray, currentIndex, currentOpts);

			currentArray = selectedOpts	= [];
			currentIndex = selectedIndex = 0;
			currentOpts = selectedOpts	= {};

			busy = false;
		}

		if (currentOpts.transitionOut == 'elastic') {
			start_pos = _get_zoom_from();

			var pos = wrap.position();

			final_pos = {
				top	 : pos.top ,
				left : pos.left,
				width :	wrap.width(),
				height : wrap.height()
			};

			if (currentOpts.opacity) {
				final_pos.opacity = 1;
			}

			title.empty().hide();

			fx.prop = 1;

			$(fx).animate({ prop: 0 }, {
				 duration : currentOpts.speedOut,
				 easing : currentOpts.easingOut,
				 step : _draw,
				 complete : _cleanup
			});

		} else {
			wrap.fadeOut( currentOpts.transitionOut == 'none' ? 0 : currentOpts.speedOut, _cleanup);
		}
	};

	$.fancybox.resize = function() {
		if (overlay.is(':visible')) {
			overlay.css('height', $(document).height());
		}

		$.fancybox.center(true);
	};

	$.fancybox.center = function() {
		var view, align;

		if (busy) {
			return;	
		}

		align = arguments[0] === true ? 1 : 0;
		view = _get_viewport();

		if (!align && (wrap.width() > view[0] || wrap.height() > view[1])) {
			return;	
		}

		wrap
			.stop()
			.animate({
				'top' : parseInt(Math.max(view[3] - 20, view[3] + ((view[1] - content.height() - 40) * 0.5) - currentOpts.padding)),
				'left' : parseInt(Math.max(view[2] - 20, view[2] + ((view[0] - content.width() - 40) * 0.5) - currentOpts.padding))
			}, typeof arguments[0] == 'number' ? arguments[0] : 200);
	};

	$.fancybox.init = function() {
		if ($("#fancybox-wrap").length) {
			return;
		}

		$('body').append(
			tmp	= $('<div id="fancybox-tmp"></div>'),
			loading	= $('<div id="fancybox-loading"><div></div></div>'),
			overlay	= $('<div id="fancybox-overlay"></div>'),
			wrap = $('<div id="fancybox-wrap"></div>')
		);

		outer = $('<div id="fancybox-outer"></div>')
			.append('<div class="fancybox-bg" id="fancybox-bg-n"></div><div class="fancybox-bg" id="fancybox-bg-ne"></div><div class="fancybox-bg" id="fancybox-bg-e"></div><div class="fancybox-bg" id="fancybox-bg-se"></div><div class="fancybox-bg" id="fancybox-bg-s"></div><div class="fancybox-bg" id="fancybox-bg-sw"></div><div class="fancybox-bg" id="fancybox-bg-w"></div><div class="fancybox-bg" id="fancybox-bg-nw"></div>')
			.appendTo( wrap );

		outer.append(
			content = $('<div id="fancybox-content"></div>'),
			close = $('<a id="fancybox-close"></a>'),
			title = $('<div id="fancybox-title"></div>'),

			nav_left = $('<a href="javascript:;" id="fancybox-left"><span class="fancy-ico" id="fancybox-left-ico"></span></a>'),
			nav_right = $('<a href="javascript:;" id="fancybox-right"><span class="fancy-ico" id="fancybox-right-ico"></span></a>')
		);

		close.click($.fancybox.close);
		loading.click($.fancybox.cancel);

		nav_left.click(function(e) {
			e.preventDefault();
			$.fancybox.prev();
		});

		nav_right.click(function(e) {
			e.preventDefault();
			$.fancybox.next();
		});

		if ($.fn.mousewheel) {
			wrap.bind('mousewheel.fb', function(e, delta) {
				if (busy) {
					e.preventDefault();

				} else if ($(e.target).get(0).clientHeight == 0 || $(e.target).get(0).scrollHeight === $(e.target).get(0).clientHeight) {
					e.preventDefault();
					$.fancybox[ delta > 0 ? 'prev' : 'next']();
				}
			});
		}

		if (!$.support.opacity) {
			wrap.addClass('fancybox-ie');
		}

		if (isIE6) {
			loading.addClass('fancybox-ie6');
			wrap.addClass('fancybox-ie6');

			$('<iframe id="fancybox-hide-sel-frame" src="' + (/^https/i.test(window.location.href || '') ? 'javascript:void(false)' : 'about:blank' ) + '" scrolling="no" border="0" frameborder="0" tabindex="-1"></iframe>').prependTo(outer);
		}
	};

	$.fn.fancybox.defaults = {
		padding : 10,
		margin : 40,
		opacity : false,
		modal : false,
		cyclic : false,
		scrolling : 'auto',	// 'auto', 'yes' or 'no'

		width : 560,
		height : 340,

		autoScale : true,
		autoDimensions : true,
		centerOnScroll : false,

		ajax : {},
		swf : { wmode: 'transparent' },

		hideOnOverlayClick : true,
		hideOnContentClick : false,

		overlayShow : true,
		overlayOpacity : 0.7,
		overlayColor : '#777',

		titleShow : true,
		titlePosition : 'float', // 'float', 'outside', 'inside' or 'over'
		titleFormat : null,
		titleFromAlt : false,

		transitionIn : 'fade', // 'elastic', 'fade' or 'none'
		transitionOut : 'fade', // 'elastic', 'fade' or 'none'

		speedIn : 300,
		speedOut : 300,

		changeSpeed : 300,
		changeFade : 'fast',

		easingIn : 'swing',
		easingOut : 'swing',

		showCloseButton	 : true,
		showNavArrows : true,
		enableEscapeButton : true,
		enableKeyboardNav : true,

		onStart : function(){},
		onCancel : function(){},
		onComplete : function(){},
		onCleanup : function(){},
		onClosed : function(){},
		onError : function(){}
	};

	$(document).ready(function() {
		$.fancybox.init();
	});

})(jQuery);var q=null;window.PR_SHOULD_USE_CONTINUATION=!0;
(function(){function L(a){function m(a){var f=a.charCodeAt(0);if(f!==92)return f;var b=a.charAt(1);return(f=r[b])?f:"0"<=b&&b<="7"?parseInt(a.substring(1),8):b==="u"||b==="x"?parseInt(a.substring(2),16):a.charCodeAt(1)}function e(a){if(a<32)return(a<16?"\\x0":"\\x")+a.toString(16);a=String.fromCharCode(a);if(a==="\\"||a==="-"||a==="["||a==="]")a="\\"+a;return a}function h(a){for(var f=a.substring(1,a.length-1).match(/\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\[0-3][0-7]{0,2}|\\[0-7]{1,2}|\\[\S\s]|[^\\]/g),a=
[],b=[],o=f[0]==="^",c=o?1:0,i=f.length;c<i;++c){var j=f[c];if(/\\[bdsw]/i.test(j))a.push(j);else{var j=m(j),d;c+2<i&&"-"===f[c+1]?(d=m(f[c+2]),c+=2):d=j;b.push([j,d]);d<65||j>122||(d<65||j>90||b.push([Math.max(65,j)|32,Math.min(d,90)|32]),d<97||j>122||b.push([Math.max(97,j)&-33,Math.min(d,122)&-33]))}}b.sort(function(a,f){return a[0]-f[0]||f[1]-a[1]});f=[];j=[NaN,NaN];for(c=0;c<b.length;++c)i=b[c],i[0]<=j[1]+1?j[1]=Math.max(j[1],i[1]):f.push(j=i);b=["["];o&&b.push("^");b.push.apply(b,a);for(c=0;c<
f.length;++c)i=f[c],b.push(e(i[0])),i[1]>i[0]&&(i[1]+1>i[0]&&b.push("-"),b.push(e(i[1])));b.push("]");return b.join("")}function y(a){for(var f=a.source.match(/\[(?:[^\\\]]|\\[\S\s])*]|\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\\d+|\\[^\dux]|\(\?[!:=]|[()^]|[^()[\\^]+/g),b=f.length,d=[],c=0,i=0;c<b;++c){var j=f[c];j==="("?++i:"\\"===j.charAt(0)&&(j=+j.substring(1))&&j<=i&&(d[j]=-1)}for(c=1;c<d.length;++c)-1===d[c]&&(d[c]=++t);for(i=c=0;c<b;++c)j=f[c],j==="("?(++i,d[i]===void 0&&(f[c]="(?:")):"\\"===j.charAt(0)&&
(j=+j.substring(1))&&j<=i&&(f[c]="\\"+d[i]);for(i=c=0;c<b;++c)"^"===f[c]&&"^"!==f[c+1]&&(f[c]="");if(a.ignoreCase&&s)for(c=0;c<b;++c)j=f[c],a=j.charAt(0),j.length>=2&&a==="["?f[c]=h(j):a!=="\\"&&(f[c]=j.replace(/[A-Za-z]/g,function(a){a=a.charCodeAt(0);return"["+String.fromCharCode(a&-33,a|32)+"]"}));return f.join("")}for(var t=0,s=!1,l=!1,p=0,d=a.length;p<d;++p){var g=a[p];if(g.ignoreCase)l=!0;else if(/[a-z]/i.test(g.source.replace(/\\u[\da-f]{4}|\\x[\da-f]{2}|\\[^UXux]/gi,""))){s=!0;l=!1;break}}for(var r=
{b:8,t:9,n:10,v:11,f:12,r:13},n=[],p=0,d=a.length;p<d;++p){g=a[p];if(g.global||g.multiline)throw Error(""+g);n.push("(?:"+y(g)+")")}return RegExp(n.join("|"),l?"gi":"g")}function M(a){function m(a){switch(a.nodeType){case 1:if(e.test(a.className))break;for(var g=a.firstChild;g;g=g.nextSibling)m(g);g=a.nodeName;if("BR"===g||"LI"===g)h[s]="\n",t[s<<1]=y++,t[s++<<1|1]=a;break;case 3:case 4:g=a.nodeValue,g.length&&(g=p?g.replace(/\r\n?/g,"\n"):g.replace(/[\t\n\r ]+/g," "),h[s]=g,t[s<<1]=y,y+=g.length,
t[s++<<1|1]=a)}}var e=/(?:^|\s)nocode(?:\s|$)/,h=[],y=0,t=[],s=0,l;a.currentStyle?l=a.currentStyle.whiteSpace:window.getComputedStyle&&(l=document.defaultView.getComputedStyle(a,q).getPropertyValue("white-space"));var p=l&&"pre"===l.substring(0,3);m(a);return{a:h.join("").replace(/\n$/,""),c:t}}function B(a,m,e,h){m&&(a={a:m,d:a},e(a),h.push.apply(h,a.e))}function x(a,m){function e(a){for(var l=a.d,p=[l,"pln"],d=0,g=a.a.match(y)||[],r={},n=0,z=g.length;n<z;++n){var f=g[n],b=r[f],o=void 0,c;if(typeof b===
"string")c=!1;else{var i=h[f.charAt(0)];if(i)o=f.match(i[1]),b=i[0];else{for(c=0;c<t;++c)if(i=m[c],o=f.match(i[1])){b=i[0];break}o||(b="pln")}if((c=b.length>=5&&"lang-"===b.substring(0,5))&&!(o&&typeof o[1]==="string"))c=!1,b="src";c||(r[f]=b)}i=d;d+=f.length;if(c){c=o[1];var j=f.indexOf(c),k=j+c.length;o[2]&&(k=f.length-o[2].length,j=k-c.length);b=b.substring(5);B(l+i,f.substring(0,j),e,p);B(l+i+j,c,C(b,c),p);B(l+i+k,f.substring(k),e,p)}else p.push(l+i,b)}a.e=p}var h={},y;(function(){for(var e=a.concat(m),
l=[],p={},d=0,g=e.length;d<g;++d){var r=e[d],n=r[3];if(n)for(var k=n.length;--k>=0;)h[n.charAt(k)]=r;r=r[1];n=""+r;p.hasOwnProperty(n)||(l.push(r),p[n]=q)}l.push(/[\S\s]/);y=L(l)})();var t=m.length;return e}function u(a){var m=[],e=[];a.tripleQuotedStrings?m.push(["str",/^(?:'''(?:[^'\\]|\\[\S\s]|''?(?=[^']))*(?:'''|$)|"""(?:[^"\\]|\\[\S\s]|""?(?=[^"]))*(?:"""|$)|'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$))/,q,"'\""]):a.multiLineStrings?m.push(["str",/^(?:'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$)|`(?:[^\\`]|\\[\S\s])*(?:`|$))/,
q,"'\"`"]):m.push(["str",/^(?:'(?:[^\n\r'\\]|\\.)*(?:'|$)|"(?:[^\n\r"\\]|\\.)*(?:"|$))/,q,"\"'"]);a.verbatimStrings&&e.push(["str",/^@"(?:[^"]|"")*(?:"|$)/,q]);var h=a.hashComments;h&&(a.cStyleComments?(h>1?m.push(["com",/^#(?:##(?:[^#]|#(?!##))*(?:###|$)|.*)/,q,"#"]):m.push(["com",/^#(?:(?:define|elif|else|endif|error|ifdef|include|ifndef|line|pragma|undef|warning)\b|[^\n\r]*)/,q,"#"]),e.push(["str",/^<(?:(?:(?:\.\.\/)*|\/?)(?:[\w-]+(?:\/[\w-]+)+)?[\w-]+\.h|[a-z]\w*)>/,q])):m.push(["com",/^#[^\n\r]*/,
q,"#"]));a.cStyleComments&&(e.push(["com",/^\/\/[^\n\r]*/,q]),e.push(["com",/^\/\*[\S\s]*?(?:\*\/|$)/,q]));a.regexLiterals&&e.push(["lang-regex",/^(?:^^\.?|[!+-]|!=|!==|#|%|%=|&|&&|&&=|&=|\(|\*|\*=|\+=|,|-=|->|\/|\/=|:|::|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|[?@[^]|\^=|\^\^|\^\^=|{|\||\|=|\|\||\|\|=|~|break|case|continue|delete|do|else|finally|instanceof|return|throw|try|typeof)\s*(\/(?=[^*/])(?:[^/[\\]|\\[\S\s]|\[(?:[^\\\]]|\\[\S\s])*(?:]|$))+\/)/]);(h=a.types)&&e.push(["typ",h]);a=(""+a.keywords).replace(/^ | $/g,
"");a.length&&e.push(["kwd",RegExp("^(?:"+a.replace(/[\s,]+/g,"|")+")\\b"),q]);m.push(["pln",/^\s+/,q," \r\n\t\xa0"]);e.push(["lit",/^@[$_a-z][\w$@]*/i,q],["typ",/^(?:[@_]?[A-Z]+[a-z][\w$@]*|\w+_t\b)/,q],["pln",/^[$_a-z][\w$@]*/i,q],["lit",/^(?:0x[\da-f]+|(?:\d(?:_\d+)*\d*(?:\.\d*)?|\.\d\+)(?:e[+-]?\d+)?)[a-z]*/i,q,"0123456789"],["pln",/^\\[\S\s]?/,q],["pun",/^.[^\s\w"-$'./@\\`]*/,q]);return x(m,e)}function D(a,m){function e(a){switch(a.nodeType){case 1:if(k.test(a.className))break;if("BR"===a.nodeName)h(a),
a.parentNode&&a.parentNode.removeChild(a);else for(a=a.firstChild;a;a=a.nextSibling)e(a);break;case 3:case 4:if(p){var b=a.nodeValue,d=b.match(t);if(d){var c=b.substring(0,d.index);a.nodeValue=c;(b=b.substring(d.index+d[0].length))&&a.parentNode.insertBefore(s.createTextNode(b),a.nextSibling);h(a);c||a.parentNode.removeChild(a)}}}}function h(a){function b(a,d){var e=d?a.cloneNode(!1):a,f=a.parentNode;if(f){var f=b(f,1),g=a.nextSibling;f.appendChild(e);for(var h=g;h;h=g)g=h.nextSibling,f.appendChild(h)}return e}
for(;!a.nextSibling;)if(a=a.parentNode,!a)return;for(var a=b(a.nextSibling,0),e;(e=a.parentNode)&&e.nodeType===1;)a=e;d.push(a)}var k=/(?:^|\s)nocode(?:\s|$)/,t=/\r\n?|\n/,s=a.ownerDocument,l;a.currentStyle?l=a.currentStyle.whiteSpace:window.getComputedStyle&&(l=s.defaultView.getComputedStyle(a,q).getPropertyValue("white-space"));var p=l&&"pre"===l.substring(0,3);for(l=s.createElement("LI");a.firstChild;)l.appendChild(a.firstChild);for(var d=[l],g=0;g<d.length;++g)e(d[g]);m===(m|0)&&d[0].setAttribute("value",
m);var r=s.createElement("OL");r.className="linenums";for(var n=Math.max(0,m-1|0)||0,g=0,z=d.length;g<z;++g)l=d[g],l.className="L"+(g+n)%10,l.firstChild||l.appendChild(s.createTextNode("\xa0")),r.appendChild(l);a.appendChild(r)}function k(a,m){for(var e=m.length;--e>=0;){var h=m[e];A.hasOwnProperty(h)?window.console&&console.warn("cannot override language handler %s",h):A[h]=a}}function C(a,m){if(!a||!A.hasOwnProperty(a))a=/^\s*</.test(m)?"default-markup":"default-code";return A[a]}function E(a){var m=
a.g;try{var e=M(a.h),h=e.a;a.a=h;a.c=e.c;a.d=0;C(m,h)(a);var k=/\bMSIE\b/.test(navigator.userAgent),m=/\n/g,t=a.a,s=t.length,e=0,l=a.c,p=l.length,h=0,d=a.e,g=d.length,a=0;d[g]=s;var r,n;for(n=r=0;n<g;)d[n]!==d[n+2]?(d[r++]=d[n++],d[r++]=d[n++]):n+=2;g=r;for(n=r=0;n<g;){for(var z=d[n],f=d[n+1],b=n+2;b+2<=g&&d[b+1]===f;)b+=2;d[r++]=z;d[r++]=f;n=b}for(d.length=r;h<p;){var o=l[h+2]||s,c=d[a+2]||s,b=Math.min(o,c),i=l[h+1],j;if(i.nodeType!==1&&(j=t.substring(e,b))){k&&(j=j.replace(m,"\r"));i.nodeValue=
j;var u=i.ownerDocument,v=u.createElement("SPAN");v.className=d[a+1];var x=i.parentNode;x.replaceChild(v,i);v.appendChild(i);e<o&&(l[h+1]=i=u.createTextNode(t.substring(b,o)),x.insertBefore(i,v.nextSibling))}e=b;e>=o&&(h+=2);e>=c&&(a+=2)}}catch(w){"console"in window&&console.log(w&&w.stack?w.stack:w)}}var v=["break,continue,do,else,for,if,return,while"],w=[[v,"auto,case,char,const,default,double,enum,extern,float,goto,int,long,register,short,signed,sizeof,static,struct,switch,typedef,union,unsigned,void,volatile"],
"catch,class,delete,false,import,new,operator,private,protected,public,this,throw,true,try,typeof"],F=[w,"alignof,align_union,asm,axiom,bool,concept,concept_map,const_cast,constexpr,decltype,dynamic_cast,explicit,export,friend,inline,late_check,mutable,namespace,nullptr,reinterpret_cast,static_assert,static_cast,template,typeid,typename,using,virtual,where"],G=[w,"abstract,boolean,byte,extends,final,finally,implements,import,instanceof,null,native,package,strictfp,super,synchronized,throws,transient"],
H=[G,"as,base,by,checked,decimal,delegate,descending,dynamic,event,fixed,foreach,from,group,implicit,in,interface,internal,into,is,lock,object,out,override,orderby,params,partial,readonly,ref,sbyte,sealed,stackalloc,string,select,uint,ulong,unchecked,unsafe,ushort,var"],w=[w,"debugger,eval,export,function,get,null,set,undefined,var,with,Infinity,NaN"],I=[v,"and,as,assert,class,def,del,elif,except,exec,finally,from,global,import,in,is,lambda,nonlocal,not,or,pass,print,raise,try,with,yield,False,True,None"],
J=[v,"alias,and,begin,case,class,def,defined,elsif,end,ensure,false,in,module,next,nil,not,or,redo,rescue,retry,self,super,then,true,undef,unless,until,when,yield,BEGIN,END"],v=[v,"case,done,elif,esac,eval,fi,function,in,local,set,then,until"],K=/^(DIR|FILE|vector|(de|priority_)?queue|list|stack|(const_)?iterator|(multi)?(set|map)|bitset|u?(int|float)\d*)/,N=/\S/,O=u({keywords:[F,H,w,"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END"+
I,J,v],hashComments:!0,cStyleComments:!0,multiLineStrings:!0,regexLiterals:!0}),A={};k(O,["default-code"]);k(x([],[["pln",/^[^<?]+/],["dec",/^<!\w[^>]*(?:>|$)/],["com",/^<\!--[\S\s]*?(?:--\>|$)/],["lang-",/^<\?([\S\s]+?)(?:\?>|$)/],["lang-",/^<%([\S\s]+?)(?:%>|$)/],["pun",/^(?:<[%?]|[%?]>)/],["lang-",/^<xmp\b[^>]*>([\S\s]+?)<\/xmp\b[^>]*>/i],["lang-js",/^<script\b[^>]*>([\S\s]*?)(<\/script\b[^>]*>)/i],["lang-css",/^<style\b[^>]*>([\S\s]*?)(<\/style\b[^>]*>)/i],["lang-in.tag",/^(<\/?[a-z][^<>]*>)/i]]),
["default-markup","htm","html","mxml","xhtml","xml","xsl"]);k(x([["pln",/^\s+/,q," \t\r\n"],["atv",/^(?:"[^"]*"?|'[^']*'?)/,q,"\"'"]],[["tag",/^^<\/?[a-z](?:[\w-.:]*\w)?|\/?>$/i],["atn",/^(?!style[\s=]|on)[a-z](?:[\w:-]*\w)?/i],["lang-uq.val",/^=\s*([^\s"'>]*(?:[^\s"'/>]|\/(?=\s)))/],["pun",/^[/<->]+/],["lang-js",/^on\w+\s*=\s*"([^"]+)"/i],["lang-js",/^on\w+\s*=\s*'([^']+)'/i],["lang-js",/^on\w+\s*=\s*([^\s"'>]+)/i],["lang-css",/^style\s*=\s*"([^"]+)"/i],["lang-css",/^style\s*=\s*'([^']+)'/i],["lang-css",
/^style\s*=\s*([^\s"'>]+)/i]]),["in.tag"]);k(x([],[["atv",/^[\S\s]+/]]),["uq.val"]);k(u({keywords:F,hashComments:!0,cStyleComments:!0,types:K}),["c","cc","cpp","cxx","cyc","m"]);k(u({keywords:"null,true,false"}),["json"]);k(u({keywords:H,hashComments:!0,cStyleComments:!0,verbatimStrings:!0,types:K}),["cs"]);k(u({keywords:G,cStyleComments:!0}),["java"]);k(u({keywords:v,hashComments:!0,multiLineStrings:!0}),["bsh","csh","sh"]);k(u({keywords:I,hashComments:!0,multiLineStrings:!0,tripleQuotedStrings:!0}),
["cv","py"]);k(u({keywords:"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["perl","pl","pm"]);k(u({keywords:J,hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["rb"]);k(u({keywords:w,cStyleComments:!0,regexLiterals:!0}),["js"]);k(u({keywords:"all,and,by,catch,class,else,extends,false,finally,for,if,in,is,isnt,loop,new,no,not,null,of,off,on,or,return,super,then,true,try,unless,until,when,while,yes",
hashComments:3,cStyleComments:!0,multilineStrings:!0,tripleQuotedStrings:!0,regexLiterals:!0}),["coffee"]);k(x([],[["str",/^[\S\s]+/]]),["regex"]);window.prettyPrintOne=function(a,m,e){var h=document.createElement("PRE");h.innerHTML=a;e&&D(h,e);E({g:m,i:e,h:h});return h.innerHTML};window.prettyPrint=function(a){function m(){for(var e=window.PR_SHOULD_USE_CONTINUATION?l.now()+250:Infinity;p<h.length&&l.now()<e;p++){var n=h[p],k=n.className;if(k.indexOf("prettyprint")>=0){var k=k.match(g),f,b;if(b=
!k){b=n;for(var o=void 0,c=b.firstChild;c;c=c.nextSibling)var i=c.nodeType,o=i===1?o?b:c:i===3?N.test(c.nodeValue)?b:o:o;b=(f=o===b?void 0:o)&&"CODE"===f.tagName}b&&(k=f.className.match(g));k&&(k=k[1]);b=!1;for(o=n.parentNode;o;o=o.parentNode)if((o.tagName==="pre"||o.tagName==="code"||o.tagName==="xmp")&&o.className&&o.className.indexOf("prettyprint")>=0){b=!0;break}b||((b=(b=n.className.match(/\blinenums\b(?::(\d+))?/))?b[1]&&b[1].length?+b[1]:!0:!1)&&D(n,b),d={g:k,h:n,i:b},E(d))}}p<h.length?setTimeout(m,
250):a&&a()}for(var e=[document.getElementsByTagName("pre"),document.getElementsByTagName("code"),document.getElementsByTagName("xmp")],h=[],k=0;k<e.length;++k)for(var t=0,s=e[k].length;t<s;++t)h.push(e[k][t]);var e=q,l=Date;l.now||(l={now:function(){return+new Date}});var p=0,d,g=/\blang(?:uage)?-([\w.]+)(?!\S)/;m()};window.PR={createSimpleLexer:x,registerLangHandler:k,sourceDecorator:u,PR_ATTRIB_NAME:"atn",PR_ATTRIB_VALUE:"atv",PR_COMMENT:"com",PR_DECLARATION:"dec",PR_KEYWORD:"kwd",PR_LITERAL:"lit",
PR_NOCODE:"nocode",PR_PLAIN:"pln",PR_PUNCTUATION:"pun",PR_SOURCE:"src",PR_STRING:"str",PR_TAG:"tag",PR_TYPE:"typ"}})();
var EventManager = function() {
  this.init();
}

EventManager.prototype = {

  addListener: function(event, callback) {
    if (!this.listeners[event]) {
      this.listeners[event] = [];
    }
    if (callback instanceof Function) {
      this.listeners[event].push(callback);
    }
    return this;
  },
  addLastListener: function(event, callback) {
    if (!this.lastListeners[event]) {
      this.lastListeners[event] = [];
    }
    if (callback instanceof Function) {
      this.lastListeners[event].push(callback);
    }
    return this;
  },

  removeListener: function(event, callback) {
    if (this.listeners[event]) {
      var keepers = [];
      for (var i = 0; i < this.listeners[event].length; i++) {
        if (this.listeners[event][i] !== callback) {
          keepers.push(this.listeners[event][i]);
        }
        this.listeners[event] = keepers;
      }
    }
  },

  fire: function(event, params) {
    if (this.listeners[event]) {
      for (var i = 0; i < this.listeners[event].length; i++) {
        this.listeners[event][i].call(window, params);
      }
    }
    if (this.lastListeners[event]) {
      for (var i = 0; i < this.lastListeners[event].length; i++) {
        this.lastListeners[event][i].call(window, params);
      }
    }
    return false;
  },

  callFirst: function(event, params) {
    if (this.listeners[event])
      return this.listeners[event][0].call(window, params);
    return "";
  },

  callFirstTrue: function(event, params) {
    if (this.listeners[event]) {
      for (var i = 0; i < this.listeners[event].length; i++) {
        var ret = this.listeners[event][i].call(window, params);
        if (ret !== false) return ret;
      }
    }
    return false;
  },

  init: function() {
    this.listeners = {};
    this.lastListeners = {};
  }
}

var PEM = new EventManager();

function defaultVerify(callback) {
  callback.call(window);
}
PEM.addListener("verifyAnyCancel", defaultVerify);var P = {};

P.modules = {
  user: false,
  network: false,
  modules: {}, // this is a hashmap of all loaded modules
  cacheBuster: 0, // this should be initialized to current version for cache busting
  data: {}, // for managing data
  dataLoading: {},
  dataCallbacks: {},
  /*
   *  This funciton loads module, if module is not yet loaded.
   *  Modules are only loaded after document.ready is called
   */
  loadModule: function(moduleName, options, callback, staticHTML) {
    if (P.modules.modules[moduleName]) {
      if (callback) {
        if (P.modules.modules[moduleName].isLoaded) {
          callback.call(window);
        } else {
          P.modules.modules[moduleName].callbacks.push(callback);
        }
      }
      return;
    }
    P.modules.modules[moduleName] = {
      name: moduleName,
      callbacks: [],
      options: {},
      isLoaded: false
    };
    if (callback)
      P.modules.modules[moduleName].callbacks.push(callback);
    if (options)
      P.modules.modules[moduleName].options = options;
    if (!$.isReady) {
      if (staticHTML)
        P.modules.modules[moduleName].template = PTM.createModuleTemplate(moduleName, moduleName, staticHTML);
    } else {
      P.modules._loadModule(P.modules.modules[moduleName]);
    }
  },

  _loadModule: function(module) {
    // inject CSS
    // inject JS
    // load HTML template
    // call module init
    var moduleName = module.name;
    if (!module.template) {
      P.modules.load("/modules/" + moduleName + "/" + moduleName + ".css", 1, function(css) {
        $('head').append('<style>' + css + '</style>');
      });
      P.modules.load("/modules/" + moduleName + "/" + moduleName + ".js", 1, function(js) {
        $('head').append('<script type="text/javascript">' + js + '</script>');
        module.js = js;
        if (module.js && module.template) {
          // both JS and template are loaded. Init module
          P.modules._loadModuleDone(module);
          // call all
        }
      });
      PTM.getModuleTemplate(moduleName, moduleName, function(template){
        module.template = template;
        if (module.js && module.template) {
          // both JS and template are loaded. Init module
          P.modules._loadModuleDone(module);
        }
      });
    } else {
      // template is set, it means that this is a static include. No need to load anything.
      P.modules._loadModuleDone(module);
    }
  },
  loadJS: function(js, callback) {
    P.modules.load(js, 1, function(js) {
      $('head').append('<script type="text/javascript">' + js + '</script>');
      if (callback) callback.call();
    });
  },
  _loadModuleDone: function(module) {
    module.isLoaded = true;
    module.options.user = P.modules.user;
    module.options.network = P.modules.network;
    //try {
      eval("P." + module.name + ".init(P.modules.modules['" + module.name + "'])");
    //} catch (err) {}
    for (var i = 0; i < module.callbacks.length; i++) {
      if (module.callbacks[i])
        module.callbacks[i].call(window);
    }
  },

  initQueuedModules: function() {
    for (var name in P.modules.modules) {
      var module = P.modules.modules[name];
      if (!module.isLoaded)
        P.modules._loadModule(module);
    }
  },

  load: function(path, blockObject, callback, error) {
    if (!path) return;
    if (blockObject) {
      if (blockObject != 1) blockObject.block();
    } else
      $.blockUI();
    if (path.indexOf('?') < 0)
      path += "?t=" + P.modules.cacheBuster;
    else
      path += "&t=" + P.modules.cacheBuster;
    $.ajax({
      url: path,
      type: 'GET',
      dataType: 'html',
      success: function(data) {
        if (blockObject) {
          if (blockObject != 1) blockObject.unblock();
        } else
          $.unblockUI();
        if (data && callback)
          callback.call(window, data);
      },
      error: function(req, status, err) {
        if (blockObject)
          if (blockObject != 1) blockObject.unblock();
        else
          $.unblockUI();
        if (error)
          error.call(window, err);
      }
    });
  },
  setUser: function(u) {
    P.modules.user = u;
    PA.user = u;
    if (!P.modules.doneInitUser)
      P.modules.initUser();
    // go through all modules and set user
  },
  setNetwork: function(net) {
    P.modules.network = net;
  },
  initUser: function() {
    if (!P.modules.documentReady) return;
    if (P.modules.doneInitUser) return;
    P.modules.doneInitUser = true;
    for (var name in P.modules.modules) {
      try {
        eval("P." + name + ".setUser(P.modules.user)");
        eval("P." + name + ".setNetwork(P.modules.network)");
      } catch (err) {}
    }
  },
  // specific functions to load and access important data
  getData: function(type, block, callback, param) {
    if (P.modules.data[type]) {
      callback.call(window, P.modules.data[type]);
      return;
    }
    if (!P.modules.dataCallbacks[type]) P.modules.dataCallbacks[type] = [];
    P.modules.dataCallbacks[type].push(callback);
    if (P.modules.dataLoading[type]) return; // we are already loding this data. Callback will be triggered
    // based on type, load this data
    P.modules.dataLoading[type] = true;
    if (type == "user") {
      PA.call_pj("user.status", {}, block, function(data) {
        P.modules.getDataLoaded(type, data);
      });
    }
    if (type == "user_profile") {
      PA.call_pj("user_profile.get_profile", {}, block, function(data) {
        P.modules.getDataLoaded(type, data);
      }, function(err){alert(err);});
    }
    if (type == "career_stories") {
      PA.call_pj("careers_story.get_user_stories", {}, block, function(data){
        P.modules.getDataLoaded(type, data);
      }, function(err){alert(err);});
    }
    if (type == "company_list") {
      PA.call_pj("careers_company.company_list", {}, block, function(data){
        P.modules.getDataLoaded(type, data);
      }, function(err){alert(err);});
    }
    if (type == "careers_feed_stories") {
      PA.call_pj("user_profile.get_careers_feed_stories", {}, block, function(data){
        P.modules.getDataLoaded(type, data);
      }, function(err){alert(err);});
    }
    if (type.indexOf("company_profile_") == 0) {
      var internalId = type.replace("company_profile_", "");
      PA.call_pj("careers_company.get_profile", {internal_id: internalId}, block, function(data){
        P.modules.getDataLoaded(type, data);
      }, function(err){alert(err);});
    }
  },
  getDataLoaded: function(type, data) {
    P.modules.data[type] = data;
    P.modules.dataLoading[type] = false;
    if (P.modules.dataCallbacks[type]) {
      for (var i = 0; i < P.modules.dataCallbacks[type].length; i++)
        P.modules.dataCallbacks[type][i].call(window, data);
    }
  }
};

$(document).ready(function() {
  P.modules.initQueuedModules();
  P.modules.documentReady = true;
  if (P.modules.user) {
    P.modules.initUser();
  }
});/*
 * Piazza Template Manager
 *
 */
var PTM = {
  templates: {},

  getTemplate: function(name, callback, options) {
    if (PTM.templates[name]) {
      if (callback)
        callback.call(window, PTM.templates[name], options);
      return PTM.templates[name];
    }
    else {
      P.modules.load("/modules/shared_templates/" + name + ".html", 1, function(html) {
        PTM.templates[name] = Handlebars.compile(html);
        if (callback)
          callback.call(window, PTM.templates[name], options);
      }, function(err) {alert(err)});
    }
    return null;
  },
  createTemplate: function(name, html) {
    PTM.templates[name] = Handlebars.compile(html);
    return PTM.templates[name];
  },
  getModuleTemplate: function(moduleName, name, callback, options) {
    if (PTM.templates[moduleName + ":" + name]) {
      if (callback)
        callback.call(window, PTM.templates[moduleName + ":" + name], options);
      return PTM.templates[moduleName + ":" + name];
    }
    else {
      P.modules.load("/modules/" + moduleName + "/" + name + ".html", 1, function(html) {
        if (!options) options = {};
        options.html = html;
        PTM.templates[moduleName + ":" + name] = Handlebars.compile(html);
        if (callback)
          callback.call(window, PTM.templates[moduleName + ":" + name], options);
      }, function(err) {alert(err)});
    }
    return null;
  },
  createModuleTemplate: function(moduleName, name, html) {
    PTM.templates[moduleName + ":" + name] = Handlebars.compile(html);
    return PTM.templates[moduleName + ":" + name];
  },

  init: function() {
    Handlebars.registerHelper('toRelativeTime', function(time) {
      if (!time) return "";
      return time.toRelativeTime();
    });
    Handlebars.registerHelper('limitChars', function(msg) {
      if (!msg) return "";
      if (msg.length < 50) return msg;
      return msg.substring(0, 48) + "...";
    });
    Handlebars.registerHelper('toUserName', function(uid, anon) {
      if (typeof(anon) != "string") anon = "no";
      return PA.getUserName(uid, anon);
    });
    Handlebars.registerHelper('toUserPic', function(uid) {
      return PA.getUserPic(uid);
    });
    // ifContains <array> <element> -> render if array contains given element
    Handlebars.registerHelper('ifContains', function(array, element, options) {
      if (!array) return options.inverse(this);
      if (array.exist(element)) return options.fn(this);
      return options.inverse(this);
    });
    Handlebars.registerHelper('ifEquals', function(str1, str2, options) {
      if (str1 == str2)
        return options.fn(this);
      return options.inverse(this);
    });
    Handlebars.registerHelper('ifNotEquals', function(str1, str2, options) {
      if (str1 != str2)
        return options.fn(this);
      return options.inverse(this);
    });
    Handlebars.registerHelper('ifGreater', function(str1, str2, options) {
      if (str1 > str2)
        return options.fn(this);
      return options.inverse(this);
    });
    Handlebars.registerHelper('ifOr', function(v1, v2, options) {
      if(v1 || v2) {
        return options.fn(this);
      }
      return options.inverse(this);
    });
    Handlebars.registerHelper('pluralizator', function(element, singular, plural) {
      if (parseInt(element) > 1) return plural;
      return singular;
    });
    Handlebars.registerHelper('processText', function(element, type) {
      return PEM.callFirst("makeHtml", {text:element, type:type});
    });
    Handlebars.registerHelper('extensionIcon', function(element) {
      return getFileTypeIcon(element);
    });
    Handlebars.registerHelper('isImage', function(element, options) {
      if (isFileTypeImage(element))
        return options.fn(this);
      return "";
    });
    Handlebars.registerHelper('networkName', function(nid) {
      var name = "-unknown-";
      if (P.modules.user) {
        for (var i = 0; i < P.modules.user.networks.length; i++)
          if (P.modules.user.networks[i].id == nid) {
            name = P.modules.user.networks[i].name;
            break;
          }
      }
      return name;
    });
    Handlebars.registerHelper('attachment', function(attach, content, network) {
      if (PTM.templates["attachment"]) {
        ATTACHMENTS[attach.id] = attach;
        return PTM.templates["attachment"]({attach:attach, content:content, network:network});
      }
      return "";
    });
    Handlebars.registerHelper('folderlist', function(folders) {
      var html = "";
      if (!folders) return html;
      for (var i = 0; i < folders.length; i++) {
        html += '<a href="#" class="tag folder" onclick="PEM.fire(\'filterFeed\', {filter:\'folder\',folder:\'' + folders[i] + '\'});return false;">' + folders[i] + '</a>';
      }
      return html;
    });
    Handlebars.registerHelper('showOthers', function(others) {
      if (!others) return "";
      if (others.length == 0) return "";
      if (others.length == 1) {
        return "and " + PA.getUserName(others[0]);
      } else {
        return "and " + PA.getOthersList(others);
      }
      return "";
    });
    Handlebars.registerHelper('ifIsOdd', function(num, options) {
      if (num % 2 == 1) return options.fn(this);
      return "";
    });
    Handlebars.registerHelper('ifIsEmpty', function(arr, options) {
      if (!arr || arr.length == 0) return options.fn(this);
      return "";
    });
    Handlebars.registerHelper('showCompanyUsers', function(arr, options) {
      var names = [];
      if (typeof(COMPANY_USERS) != 'undefined' && COMPANY_USERS && arr && arr.length > 0) {
        for (var i = 0; i < arr.length; i++) {
          if (COMPANY_USERS[arr[i]]) names.push(COMPANY_USERS[arr[i]].name);
        }
      }
      if (names.length > 0)
        return "<span class='company_user_list' tipsy='" + names.join("<br/>") + "'>" + options.fn(this) + "</span>";
      return "<span class='company_user_list'>" + options.fn(this) + "</span>";
    });
    Handlebars.registerHelper('showCompanyUserName', function(id, options) {
      if (typeof(COMPANY_USERS) != 'undefined' && COMPANY_USERS && id) {
        if (COMPANY_USERS[id]) return COMPANY_USERS[id].name;
      }
      return "";
    });
    Handlebars.registerHelper('timestampFormat', function(time, format, options) {
      var date = new Date();
      date.setTime(time);
      return date.format(format);
    });
    var companyActions = {
      "view_profile":"Viewed profile",
      "request_resume":"Requested resume",
      "note":"Added a note",
      "tag":"Tagged student with ",
      "status":"Changed Status ",
      "send_message":"Messaged student "
    };
    Handlebars.registerHelper('showCompanyAction', function(action, options) {
      return companyActions[action];
    });
  }
};

PTM.init();
var ATTACHMENTS = {};String.prototype.toRelativeTime = function(now_threshold) {
  var dt = new Date();
  dt.setISO8601(this);
  return dt.toRelativeTime(now_threshold);
};
String.prototype.toDate = function() {
  var dt = new Date();
  dt.setISO8601(this);
  return dt;
};
String.prototype.usDateToDB = function() {
  var arr = this.split('/');
  if (arr.length == 3) {
    if(arr[0].length == 1) arr[0] = "0" + arr[0];
    if(arr[1].length == 1) arr[1] = "0" + arr[1];
    return arr[2] + '-' + arr[0] + '-' + arr[1];
  }
};
String.prototype.trim = function() {
  return this.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
};
Array.prototype.forEach = function(func) {
  for (var i = 0; i < this.length; i++)
    func(this[i]);
};
Array.prototype.remove = function(val) {
    for (var i in this) {
        if (this[i] === val) {
          this.splice(i, 1);
        }
    }
};
Array.prototype.removeF = function(func) {
    for (var i in this) {
        if (func(this[i])) {
          this.splice(i, 1);
        }
    }
};
Array.prototype.findAll = function(func) {
    var items = [];
    this.forEach(function(i) {
    	if (!isFunction(i)) {
    		if (func(i)) {
    			items.push(i);
    		}
    	}
    });
    return items;
};
function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}
function isFunction(obj) {
	return Object.prototype.toString.call(obj) === "[object Function]";
};
function showSecs(secs) {
  if (secs == 0) return "1 sec";
  if (!secs) return "-";
  if (secs < 60) return "" + secs + " sec";
  if (secs < 60*60) return "" + Math.round(secs / 60) + " min";
  return "" + Math.round(secs / 60 / 6) / 10 + " hr";
}
Date.prototype.toRelativeTime = function(now_threshold) {
  var delta = new Date() - this;

  now_threshold = parseInt(now_threshold, 10);

  if (isNaN(now_threshold)) {
    now_threshold = 10000;
  }

  if (delta <= now_threshold) {
    return '<span title="' + this + '">Just now</span>';
  }

  var units = null;
  var conversions = {
    millisecond: 1, // ms    -> ms
    second: 1000,   // ms    -> sec
    minute: 60,     // sec   -> min
    hour:   60,     // min   -> hour
    day:    24,     // hour  -> day
    month:  30,     // day   -> month (roughly)
    year:   12      // month -> year
  };

  for (var key in conversions) {
    if (delta < conversions[key]) {
      break;
    } else {
      units = key; // keeps track of the selected key over the iteration
      delta = delta / conversions[key];
    }
  }

  // pluralize a unit when the difference is greater than 1.
  delta = Math.floor(delta);
  if (delta !== 1) { units += "s"; }
  return '<span title="' + this + '">' + [delta, units, "ago"].join(" ") + '</span>';
};

Date.prototype.get12 = function() {
  var hour = this.getHours();
  var mins = this.getMinutes();
  var ap = "AM";
  if (hour   > 11) { ap = "PM";         }
  if (hour   > 12) { hour = hour - 12;  }
  if (hour   == 0) { hour = 12;         }
  if (mins   < 10) { mins = "0" + mins; }
  return "" + hour + ":" + mins + ap;
};

Date.prototype.getWDay = function() {
  return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][this.getDay()];
};

Date.prototype.getFullDate = function() {
  return "" + (this.getMonth() + 1) + "/" + this.getDate() + "/" + (this.getFullYear() % 100);
};

Date.prototype.toISOString = Date.prototype.toISOString || function() {
  return this.getUTCFullYear() + "-"
    + ("0" + (this.getUTCMonth() + 1) + "-").slice(-3)
    + ("0" + this.getUTCDate() + "T").slice(-3)
    + ("0" + this.getUTCHours() + ":").slice(-3)
    + ("0" + this.getUTCMinutes() + ":").slice(-3)
    + ("0" + this.getUTCSeconds() + ".").slice(-3)
    + ("00" + this.getUTCMilliseconds() + "Z").slice(-4);
};
Array.prototype.exist = function(val) {
  for (var i in this)
    if (this[i] == val) return true;
  return false;
};

/*
 * Wraps up a common pattern used with this plugin whereby you take a String
 * representation of a Date, and want back a date object.
 */
Date.fromString = function(str) {
  return new Date(Date.parse(str));
};

Date.prototype.setISO8601 = function(dString) {
  var regexp = /(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;
  if (!dString) return this;
  if (dString.toString().match(new RegExp(regexp))) {
    var d = dString.match(new RegExp(regexp));
    var offset = 0;
    this.setUTCDate(1);
    this.setUTCFullYear(parseInt(d[1],10));
    this.setUTCMonth(parseInt(d[3],10) - 1);
    this.setUTCDate(parseInt(d[5],10));
    this.setUTCHours(parseInt(d[7],10));
    this.setUTCMinutes(parseInt(d[9],10));
    this.setUTCSeconds(parseInt(d[11],10));
    if (d[12])
    this.setUTCMilliseconds(parseFloat(d[12]) * 1000);
    else
    this.setUTCMilliseconds(0);
    if (d[13] != 'Z') {
      offset = (d[15] * 60) + parseInt(d[17],10);
      offset *= ((d[14] == '-') ? -1 : 1);
      this.setTime(this.getTime() - offset * 60 * 1000);
    }
  } else {
    this.setTime(Date.parse(dString));
  }
  return this;
};
Date.prototype.getFullDate = function() {
  return "" + (this.getMonth() + 1) + "/" + this.getDate() + "/" + (this.getFullYear() % 100);
}

var dateFormat = function () {
  var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
    timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
    timezoneClip = /[^-+\dA-Z]/g,
    pad = function (val, len) {
      val = String(val);
      len = len || 2;
      while (val.length < len) val = "0" + val;
      return val;
    };

  // Regexes and supporting functions are cached through closure
  return function (date, mask, utc) {
    var dF = dateFormat;

    // You can't provide utc if you skip other args (use the "UTC:" mask prefix)
    if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
      mask = date;
      date = undefined;
    }

    // Passing date through Date applies Date.parse, if necessary
    date = date ? new Date(date) : new Date;
    if (isNaN(date)) throw SyntaxError("invalid date");

    mask = String(dF.masks[mask] || mask || dF.masks["default"]);

    // Allow setting the utc argument via the mask
    if (mask.slice(0, 4) == "UTC:") {
      mask = mask.slice(4);
      utc = true;
    }

    var _ = utc ? "getUTC" : "get",
      d = date[_ + "Date"](),
      D = date[_ + "Day"](),
      m = date[_ + "Month"](),
      y = date[_ + "FullYear"](),
      H = date[_ + "Hours"](),
      M = date[_ + "Minutes"](),
      s = date[_ + "Seconds"](),
      L = date[_ + "Milliseconds"](),
      o = utc ? 0 : date.getTimezoneOffset(),
      flags = {
        d:    d,
        dd:   pad(d),
        ddd:  dF.i18n.dayNames[D],
        dddd: dF.i18n.dayNames[D + 7],
        m:    m + 1,
        mm:   pad(m + 1),
        mmm:  dF.i18n.monthNames[m],
        mmmm: dF.i18n.monthNames[m + 12],
        yy:   String(y).slice(2),
        yyyy: y,
        h:    H % 12 || 12,
        hh:   pad(H % 12 || 12),
        H:    H,
        HH:   pad(H),
        M:    M,
        MM:   pad(M),
        s:    s,
        ss:   pad(s),
        l:    pad(L, 3),
        L:    pad(L > 99 ? Math.round(L / 10) : L),
        t:    H < 12 ? "a"  : "p",
        tt:   H < 12 ? "am" : "pm",
        T:    H < 12 ? "A"  : "P",
        TT:   H < 12 ? "AM" : "PM",
        Z:    utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
        o:    (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
        S:    ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
      };

    return mask.replace(token, function ($0) {
      return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
    });
  };
}();
dateFormat.masks = {
  "default":      "ddd mmm dd yyyy HH:MM:ss",
  shortDate:      "m/d/yy",
  mediumDate:     "mmm d, yyyy",
  longDate:       "mmmm d, yyyy",
  fullDate:       "dddd, mmmm d, yyyy",
  shortTime:      "h:MM TT",
  mediumTime:     "h:MM:ss TT",
  longTime:       "h:MM:ss TT Z",
  isoDate:        "yyyy-mm-dd",
  isoTime:        "HH:MM:ss",
  isoDateTime:    "yyyy-mm-dd'T'HH:MM:ss",
  isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};
// Internationalization strings
dateFormat.i18n = {
  dayNames: [
    "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
    "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
  ],
  monthNames: [
    "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
    "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
  ]
};
Date.prototype.format = function (mask, utc) {
  return dateFormat(this, mask, utc);
};


function openDropdown(selector, event) {
  closeDropDown();
  $(selector).show();
  if (event.preventDefault) event.preventDefault();
  if (event.stop) event.stop();
  if (event.stopPropagation) event.stopPropagation();
  return false;
}
function closeDropDown() {
    $('.top_bar_dropdown_wrapper').hide();
    $('.general_dropdown').hide();
    $('.topbar_arrow').removeClass('settings_active');
    $('.topbar_account_wrapper').removeClass('active');
    $('.topBar_button_left').removeClass('active');
    $('.topBar_button_left').removeClass('highlighted');
    $('.topBar_button_right').removeClass('active');
    $('#user_button').removeClass('active');
    //P.top_bar.populateTopbarButtons(currentNetworkId); // in case this was removed
}

var DID_REPLACE_LATEST = false;
var POLL_OPTS = [];
function ProcessText(text, noReplace, contentType) {
  // do latex logic
  DID_REPLACE_LATEST = false;
  if (!text) return "";
  if (text.indexOf("<") >= 0) DID_REPLACE_LATEST = true;
  if (noReplace) {
    text = text.replace(/</g, "&lt;");
    text = text.replace(/>/g, "&gt;");
  }
  //text = text.replace(/([^>]|<br>)\n/g, "$1<br>");
  //text = text.replace(/([^>]|<br>)\n/g, "$1<br>");
  text = text.replace(/\n/g, "<br>");
  text = text.replace(/<br><br><ul>/g, "<br><ul>");
  text = text.replace(/<br><br><ol>/g, "<br><ol>");
  text = text.replace(/<\/ul><br>/g, "</ul>");
  text = text.replace(/<\/ol><br>/g, "</ol>");
  text = text.replace(/<br><li>/g, "<li>");
  text = text.replace(/<\/li><br>/g, "</li>");
  text = text.replace(/<br><br><pre>/g, "<br><pre>");
  text = text.replace(/<\/pre><br>/g, "</pre>");
  if (noReplace) return text;
  text = text.replace(/&amp;/g, "&");
  text = text.replace(/&quot;/g, '"');
  var pres = text.match(/<pre>[\s\S]*?<\/pre>/g);
  var tts = text.match(/<tt>[\s\S]*?<\/tt>/g);
  if (pres) {
    for (var i = 0; i < pres.length; i++) {
      text = text.replace(pres[i], "<|_p_" + i + "_p_|>");
    }
  }
  if (tts) {
    for (var i = 0; i < tts.length; i++) {
      text = text.replace(tts[i], "<|_tt_" + i + "_tt_|>");
    }
  }
  var arr = text.split('$$');
  if (arr.length > 2) {
    // potential latex
    for (var i = 1; i <= arr.length - 1; i+=2) {
      var str = arr[i]
      if (str.length >= 1) {
        // look for special chars: \, _, ^
        //if ((!str.match(/[\s]/) || str.match(/[\\_^]/)) && str.indexOf("<br>") == -1) {
          var content_text = str;
          content_text = content_text.replace(/&lt;/g, "<");
          content_text = content_text.replace(/&gt;/g, ">");
          content_text = content_text.replace(/&amp;/g, "&");
          content_text = content_text.replace(/&quot;/g, '"');
          content_text = content_text.replace(/<br>/g, "\n");
          var replaced = "<img style='width: auto;vertical-align: text-bottom;' src='/main/show_latex?" + escape(content_text) + "'/>"
          DID_REPLACE_LATEST = true;
          text = text.replace("$$" + str + "$$", replaced);
          //text = text.replace("$" + replaced, replaced);
          //text = text.replace("$" + replaced, replaced);
          //text = text.replace(replaced + "$", replaced);
          //text = text.replace(replaced + "$", replaced);
        //}
      }
    }
  }
  // replace URLs with links, except directly following a quote character
  // URLs are defined as http or https, followed by ://, followed by a sequence of non-whitespace, non-bracket, non-double quote characters, followed by one word character or certain punctuation
  // the text immediately after a URL must be whitespace; a newline; end of input; a comma, period, or colon followed by one of the first three; or a closing parenthesis or HTML-escaped > followed by an optional period, comma, colon or semicolon followed by one of the first three
  text = text.replace(/(^|[^"'])(https?:\/\/(\([^\s<\[\]"\)]*\)|[^ \t\n<\[\]"()])+?(\([^\s<\[\]"\)]*\)|[\w\/?=)}#&]))(?=$|<br|<\/|\s|([\]\)]|&gt;)[\.,:;?!"'\-]*(\s|<br|<\/|$)|[\.,:;!"'\-]+(\s|<br|<\/|$))/g, '$1<a href="$2" target="_blank">$2</a>');
  // don't make links on Piazza.com go to a new tab
  text = text.replace(/target="_blank">https?:\/\/(www\.)?piazzz?a\.com\/class/g, '>https://piazza.com/class');
  if (typeof PD != 'undefined') {
    //text = text.replace(/([^\w\/])#(\w[\w-]*(-&gt;){0,1}[\w-]+)/g, "$1" + PD.makeTag("$2"));
    //text = text.replace(/^#(\w[\w-]*(-&gt;){0,1}[\w-]+)/g, PD.makeTag("$1"));
    //if (PD.tags) {
    //  var regex = new RegExp('(#' + PD.tags.instructor.join("|#").replace(/\+/g, "\\+").replace(/\*/g, "\\*").replace(/\./g, "\\.") + ')', "g");
    //  text = text.replace(regex, '');
    //}
    text = text.replace(/([^\w\/])#(\w[\w\-.+]*[\w\-+]+)/g, "$1" + PD.makeTag("$2"));
    text = text.replace(/^#(\w[\w\-.+]*[\w\-+]+)/g, PD.makeTag("$1"));
    text = text.replace(/([^\w\/])#(\w)([^\w\/<\-.+])/g, "$1" + PD.makeTag("$2") + "$3");
    text = text.replace(/([^\w\/])#(\w)$/g, "$1" + PD.makeTag("$2"));
    text = text.replace(/^@(\d+)/g, '<a href="#' + PD.term + "/" + PD.selectedNetwork.short_number + '/$1">@$1</a>');
    text = text.replace(/([^\w])@(\d+)/g, '$1<a href="#' + PD.term + "/" + PD.selectedNetwork.short_number + '/$2">@$2</a>');
  }
  if (pres) {
    for (var i = 0; i < pres.length; i++) {
      text = text.replace("<|_p_" + i + "_p_|>", "<pre style='white-space: -moz-pre-wrap;white-space: -o-pre-wrap;white-space: pre-wrap;word-wrap: break-word;'>" +
        pres[i].substr(5, pres[i].length - 11).replace(/[$]/g, "$$$$").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br&gt;/g, "<br>") + "</pre>");
    }
  }
  if (tts) {
    for (var i = 0; i < tts.length; i++) {
      text = text.replace("<|_tt_" + i + "_tt_|>", "<tt>" + tts[i].substr(4, tts[i].length - 9).replace(/[$]/g, "$$$$").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br&gt;/g, "<br>") + "</tt>");
    }
  }
  if (contentType == "poll") {
    var allToReplace = text.match(/\[[o*]]/g);
    POLL_OPTS = [];
    if (allToReplace) {
      for (var i = 0; i < allToReplace.length; i++) {
        var toReplace = allToReplace[i];
        var checked = "";
        if ($('#pollButton' + i).attr('checked')) checked = " checked";
        var replaceWith = "<input type='radio' class='pollButton' name='pollRadioButton' id='pollButton" + i + "'" + checked + "/>";
        if (toReplace == "[*]")
          replaceWith = "<input type='checkbox' class='pollButton' name='pollRadioButton' id='pollButton" + i + "'" + checked + "/>";
        var at = text.indexOf(toReplace);
        var enter = text.indexOf("<br", at);
        if (enter < 0) enter = text.length;
        var label = text.substr(at + 3, (enter - at - 3));
        var goodLabel = label.replace(/<[^>]*>/g, "");
        POLL_OPTS.push(goodLabel);
        var before = text.substr(0, at + 3);
        var after = text.substr(enter);
        text = before + goodLabel + after;
        text = text.replace(toReplace, replaceWith);
      }
      text += "<br/><br/><span id='pollAnonymityPlaceholder' class='subregionMetadata'></span><br/><button onclick='PD.doVote();' class='pollButton'>Submit</button>";
    }
  }
  // get back pre and cc
  return text;
}

function getFileTypeIcon(name) {
  var fileTypes = {
    avi:'avi.png', css:'css.png', xls:'excel.png', xlsx:'excel.png', doc:'word.png', docx:'word.png',
    zip:'zip.png', gz:'zip.png', tar:'zip.png', gif:'gif.png', html:'html.png', htm:'html.png',
    jpg:'jpg.png', jepg:'jpg.png', jpeg:'jpg.png', js:'js.png', mov:'mov.png', mp3:'mp3.png', mpg:'mpg.png', mpeg:'mpg.png',
    pdf:'pdf.png', png:'png.png', ppt:'powerpoint.png', pptx:'powerpoint.png', txt:'text.png', wma:'wma.png',
    wmv:'wmv.png', doc:'word.png', docx:'word.png', xml:'xml.png'
  }
  var folder = "https://dvngeac8rg9mb.cloudfront.net/images/dashboard/qa-panel/types/"
  var parts = name.split('.');
  if (parts.length == 0) return folder + "default.png";
  var ext = parts[parts.length - 1].toLowerCase();
  if (fileTypes[ext]) return folder + fileTypes[ext];
  return folder + "default.png";
}
function isFileTypeImage(name) {
  var parts = name.split('.');
  if (parts.length == 0) return false;
  var ext = parts[parts.length - 1].toLowerCase();
  return ["jpg", "jpeg", "png", "gif"].exist(ext);
}

/* from http://selbie.wordpress.com/2011/01/23/scale-crop-and-center-an-image-with-correct-aspect-ratio-in-html-and-javascript/ */
function scaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox) {

    var result = { width: 0, height: 0, fScaleToTargetWidth: true };

    if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
        return result;
    }

    // scale to the target width
    var scaleX1 = targetwidth;
    var scaleY1 = (srcheight * targetwidth) / srcwidth;

    // scale to the target height
    var scaleX2 = (srcwidth * targetheight) / srcheight;
    var scaleY2 = targetheight;

    // now figure out which one we should use
    var fScaleOnWidth = (scaleX2 > targetwidth);
    if (fScaleOnWidth) {
        fScaleOnWidth = fLetterBox;
    }
    else {
       fScaleOnWidth = !fLetterBox;
    }

    if (fScaleOnWidth) {
        result.width = Math.floor(scaleX1);
        result.height = Math.floor(scaleY1);
        result.fScaleToTargetWidth = true;
    }
    else {
        result.width = Math.floor(scaleX2);
        result.height = Math.floor(scaleY2);
        result.fScaleToTargetWidth = false;
    }
    result.targetleft = Math.floor((targetwidth - result.width) / 2);
    result.targettop = Math.floor((targetheight - result.height) / 2);

    return result;
}

/* from http://selbie.wordpress.com/2011/01/23/scale-crop-and-center-an-image-with-correct-aspect-ratio-in-html-and-javascript/ */
function onImageLoad(evt, takeTwo) {
  var img;
  try {
    img = evt.currentTarget;
    img = (evt.currentTarget) ? evt.currentTarget : evt.srcElement;
  } catch (err) {
    return;
  }
    if (takeTwo) {
      img = takeTwo;
      $(img).show();
      $(img).css({
        width: 'auto',
        height: 'auto',
        left: '0px'
      });
    }
    if (!img) return;
    // what's the size of this image and it's parent
    var w = img.naturalWidth;
    var h = img.naturalHeight;
    var parent = $(img).parent();
    if (parent.hasClass("white_border"))
      parent = parent.parent();
    var tw = parent.width();
    var th = parent.height();

    // compute the new size and offsets
    var result = scaleImage(w, h, tw, th, false);

    if ((result.width == 0 || result.height == 0) && !takeTwo) {
      // if zero, allow DOM to render first
      var rememberEvent = evt;
      setTimeout(function(){ onImageLoad(rememberEvent, img);}, 500);
      $(img).hide();
      return;
    }
    // adjust the image coordinates and size
    img.width = result.width;
    img.height = result.height;
    $(img).css("width", result.width + "px");
    $(img).css("height", result.height + "px");
    $(img).css("left", result.targetleft);
    $(img).css("top", result.targettop);
}

/* When we have the directly dom element */
function onImageChange(img) {
  var w = $(img).width();
  var h = $(img).height();
  var tw = $(img).parent().width();
  var th = $(img).parent().height();

  //console.log(w, h, tw, th);

  // compute the new size and offsets
  var result = scaleImage(w, h, tw, th, false);

  //console.log(result);

  // adjust the image coordinates and size
  img.width = result.width;
  img.height = result.height;
  $(img).css("width", result.width + "px");
  $(img).css("height", result.height + "px");
  $(img).css("left", result.targetleft);
  $(img).css("top", result.targettop);
}

function getDeepParams() {
  return window.location.hash.substring(1).split('/');
}
function resizeFontToHeight(elContainer, elText, maxHeight, minTextSize) {
  var textSize = elText.css('font-size');
  textSize = textSize.replace('px', '');
  while (elContainer.height() > maxHeight && textSize > minTextSize) {
    textSize--;
    elText.css('font-size', textSize + 'px');
  }
}
function networkToUrl(network) {
  if (!network) return "/class";
  return "/class/" + network.id;
}
function isValidEmailAddress(emailAddress) {
  var pattern = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
  return pattern.test(emailAddress);
}

function compare2Objects (x, y) {
  var p;

  // remember that NaN === NaN returns false
  // and isNaN(undefined) returns true
  if (isNaN(x) && isNaN(y) && typeof x === 'number' && typeof y === 'number') {
       return true;
  }

  // Compare primitives and functions.
  // Check if both arguments link to the same object.
  // Especially useful on step when comparing prototypes
  if (x === y) {
      return true;
  }

  // At last checking prototypes as good a we can
  if (!(x instanceof Object && y instanceof Object)) {
      return false;
  }

  // Quick checking of one object beeing a subset of another.
  // todo: cache the structure of arguments[0] for performance
  for (p in y) {
      if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {
          return false;
      }
      else if (typeof y[p] !== typeof x[p]) {
          return false;
      }
  }

  for (p in x) {
      if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {
          return false;
      }
      else if (typeof y[p] !== typeof x[p]) {
          return false;
      }

      switch (typeof (x[p])) {
          case 'object':
          case 'function':
              if (!compare2Objects (x[p], y[p])) {
                  return false;
              }
              break;

          default:
              if (x[p] !== y[p]) {
                  return false;
              }
              break;
      }
  }
  return true;
}
/*global PushStream WebSocketWrapper EventSourceWrapper EventSource*/
/*jshint evil: true */
/**
 * Copyright (C) 2010-2012 Wandenberg Peixoto <wandenberg@gmail.com>, Rog�rio Carvalho Schneider <stockrt@gmail.com>
 *
 * This file is part of Nginx Push Stream Module.
 *
 * Nginx Push Stream Module is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Nginx Push Stream Module is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Nginx Push Stream Module.  If not, see <http://www.gnu.org/licenses/>.
 *
 *
 * pushstream.js
 *
 * Created: Nov 01, 2011
 * Authors: Wandenberg Peixoto <wandenberg@gmail.com>, Rog�rio Carvalho Schneider <stockrt@gmail.com>
 */
(function (window, undefined) {
  /* prevent duplicate declaration */
  if (window.PushStream) { return; }

  var extend = function () {
    var object = arguments[0] || {};
    for ( var i = 0; i < arguments.length; i++) {
      var settings = arguments[i];
      for (var attr in settings) {
        if (!settings.hasOwnProperty || settings.hasOwnProperty(attr)) {
          object[attr] = settings[attr];
        }
      }
    }
    return object;
  };

  var validChars  = /^[\],:{}\s]*$/,
      validEscape = /\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,
      validTokens = /"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
      validBraces = /(?:^|:|,)(?:\s*\[)+/g;

  var trim = function(value) {
      return value.replace(/^\s*/, "").replace(/\s*$/, "");
  };

  var parseJSON = function(data) {
    if (typeof data !== "string" || !data) {
      return null;
    }

    // Make sure leading/trailing whitespace is removed (IE can't handle it)
    data = trim(data).replace('"text":}', '"text":{}}');

    // Attempt to parse using the native JSON parser first
    if (window.JSON && window.JSON.parse) {
      try {
        return window.JSON.parse( data );
      } catch(e) {
        throw "Invalid JSON: " + data;
      }
    }

    // Make sure the incoming data is actual JSON
    // Logic borrowed from http://json.org/json2.js
    if (validChars.test(data.replace(validEscape, "@").replace( validTokens, "]").replace( validBraces, "")) ) {
      return (new Function("return " + data))();
    }

    throw "Invalid JSON: " + data;
  };

  var currentTimestampParam = function() {
    return {};
  };

  var objectToUrlParams = function(settings) {
    var params = settings;
    if (typeof(settings) === 'object') {
      params = '';
      for (var attr in settings) {
        if (!settings.hasOwnProperty || settings.hasOwnProperty(attr)) {
          params += '&' + attr + '=' + window.escape(settings[attr]);
        }
      }
      params = params.substring(1);
    }

    return params || '';
  };

  var addParamsToUrl = function(url, params) {
    return url + ((url.indexOf('?') < 0) ? '?' : '&') + objectToUrlParams(params);
  };

  var isArray = Array.isArray || function(obj) {
    return Object.prototype.toString.call(obj) == '[object Array]';
  };

  var isString = function(obj) {
    return Object.prototype.toString.call(obj) == '[object String]';
  };

  var Log4js = {
    logger: null,
    debug : function() { if  (PushStream.LOG_LEVEL === 'debug')                                         Log4js._log.apply(Log4js._log, arguments); },
    info  : function() { if ((PushStream.LOG_LEVEL === 'info')  || (PushStream.LOG_LEVEL === 'debug'))  Log4js._log.apply(Log4js._log, arguments); },
    error : function() {                                                                                Log4js._log.apply(Log4js._log, arguments); },
    _log  : function() {
      if (!Log4js.logger) {
        var console = window.console;
        if (console && console.log) {
          if (console.log.apply) {
            Log4js.logger = console.log;
          } else if ((typeof console.log == "object") && Function.prototype.bind) {
            Log4js.logger = Function.prototype.bind.call(console.log, console);
          } else if ((typeof console.log == "object") && Function.prototype.call) {
            Log4js.logger = function() {
              Function.prototype.call.call(console.log, console, Array.prototype.slice.call(arguments));
            }
          }
        }
      }

      if (Log4js.logger) {
        Log4js.logger.apply(window.console, arguments);
      }

      var logElement = document.getElementById(PushStream.LOG_OUTPUT_ELEMENT_ID);
      if (logElement) {
        var str = '';
        for (var i = 0; i < arguments.length; i++) {
          str += arguments[i] + " ";
        }
        logElement.innerHTML += str + '\n';

        var lines = logElement.innerHTML.split('\n');
        if (lines.length > 100) {
          logElement.innerHTML = lines.slice(-100).join('\n');
        }
      }
    }
  };

  var Ajax = {
    _getXHRObject : function() {
      var xhr = false;
      try { xhr = new window.XMLHttpRequest(); }
      catch (e1) {
        try { xhr = new window.XDomainRequest(); }
        catch (e2) {
          try { xhr = new window.ActiveXObject("Msxml2.XMLHTTP"); }
          catch (e3) {
            try { xhr = new window.ActiveXObject("Microsoft.XMLHTTP"); }
            catch (e4) {
              xhr = false;
            }
          }
        }
      }
      return xhr;
    },

    _send : function(settings, post) {
      settings = settings || {};
      settings.timeout = settings.timeout || 60000;
      var xhr = Ajax._getXHRObject();
      if (!xhr||!settings.url) return;

      Ajax.clear(settings);

      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          Ajax.clear(settings);
          if (settings.afterReceive) settings.afterReceive(xhr);
          try {
            if(xhr.status == 200) {
              if (settings.success) settings.success(xhr.responseText);
            } else {
              if (settings.error) settings.error(xhr.status || 403);
            }
          } catch (e) {
            if (settings.error) settings.error(403);
          }
        }
      }

      if (settings.beforeOpen) settings.beforeOpen(xhr);

      var params = {};
      var body = null;
      var method = "GET";
      if (post) {
        body = objectToUrlParams(settings.data);
        method = "POST";
      } else {
        params = settings.data || {};
      }
      if (settings.tag)
        params.tag = settings.tag;
      params.t = (new Date()).getTime();
      xhr.open(method, addParamsToUrl(settings.url, extend({}, params, currentTimestampParam())), true);

      if (settings.beforeSend) settings.beforeSend(xhr);

      var onerror = function() {
        try { xhr.abort(); } catch (e) { /* ignore error on closing */ }
        Ajax.clear(settings);
        settings.error(304);
      };

      if (post) {
        xhr.setRequestHeader("Accept", "application/json");
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      } else {
        settings.timeoutId = window.setTimeout(onerror, settings.timeout + 2000);
      }

      xhr.send(body);
      return xhr;
    },

    _clear_script : function(script) {
      // Handling memory leak in IE, removing and dereference the script
      if (script) {
        script.onerror = script.onload = script.onreadystatechange = null;
        if (script.parentNode) script.parentNode.removeChild(script);
      }
    },

    _clear_timeout : function(settings) {
      if (settings.timeoutId) {
        settings.timeoutId = window.clearTimeout(settings.timeoutId);
      }
    },

    clear : function(settings) {
      Ajax._clear_timeout(settings);
      Ajax._clear_script(document.getElementById(settings.scriptId));
    },

    jsonp : function(settings) {
      settings.timeout = settings.timeout || 60000;
      Ajax.clear(settings);

      var head = document.head || document.getElementsByTagName("head")[0];
      var script = document.createElement("script");

      var onerror = function() {
        Ajax.clear(settings);
        settings.error(304);
      };

      var onload = function() {
        Ajax.clear(settings);
        settings.load();
      };

      script.onerror = onerror;
      script.onload = script.onreadystatechange = function(eventLoad) {
        if (!script.readyState || /loaded|complete/.test(script.readyState)) {
          onload();
        }
      };

      if (settings.beforeOpen) settings.beforeOpen({});
      if (settings.beforeSend) settings.beforeSend({});

      settings.timeoutId = window.setTimeout(onerror, settings.timeout + 2000);
      settings.scriptId = settings.scriptId || new Date().getTime();

      script.setAttribute("src", addParamsToUrl(settings.url, extend({}, settings.data, currentTimestampParam())));
      script.setAttribute("async", "async");
      script.setAttribute("id", settings.scriptId);

      // Use insertBefore instead of appendChild to circumvent an IE6 bug.
      head.insertBefore(script, head.firstChild);
    },

    load : function(settings) {
      return Ajax._send(settings, false);
    },

    post : function(settings) {
      return Ajax._send(settings, true);
    }
  };

  var escapeText = function(text) {
    return (text) ? window.escape(text) : '';
  };

  var unescapeText = function(text) {
    return (text) ? window.unescape(text) : '';
  };

  var parseMessage = function(messageText, keys) {
    var msg = messageText;
    if (isString(messageText)) {
      msg = parseJSON(messageText);
    }

    var message = {
        id     : msg[keys.jsonIdKey],
        channel: msg[keys.jsonChannelKey],
        data   : msg[keys.jsonDataKey],
        tag    : msg[keys.jsonTagKey],
        time   : msg[keys.jsonTimeKey],
        eventid: msg[keys.jsonEventIdKey] || ""
    };

    return message;
  }

  var getBacktrack = function(options) {
    return (options.backtrack) ? ".b" + Number(options.backtrack) : "";
  };

  var getChannelsPath = function(channels) {
    var path = '';
    for (var channelName in channels) {
      if (!channels.hasOwnProperty || channels.hasOwnProperty(channelName)) {
        path += (path.length > 0 ? "/" : "") + channelName;// + getBacktrack(channels[channelName]);
      }
    }
    return path;
  };

  var getSubscriberUrl = function(pushstream, prefix, extraParams) {
    var websocket = pushstream.wrapper.type === WebSocketWrapper.TYPE;
    var useSSL = pushstream.useSSL;
    var url = (websocket) ? ((useSSL) ? "wss://" : "ws://") : ((useSSL) ? "https://" : "http://");
    url += pushstream.host;
    url += ((!useSSL && pushstream.port == 80) || (useSSL && pushstream.port == 443)) ? "" : (":" + pushstream.port);
    url += prefix;

    var channels = getChannelsPath(pushstream.channels);
    if (pushstream.channelsByArgument) {
      var channelParam = {};
      channelParam[pushstream.channelsArgument] = channels.substring(1);
      extraParams = extend({}, extraParams, channelParam);
    } else {
      url += "?channels=" + channels;
    }
    if (extraParams)
      return addParamsToUrl(url, extraParams);
    return url;
  };

  var getPublisherUrl = function(pushstream) {
    var channel = "";
    var url = (pushstream.useSSL) ? "https://" : "http://";
    url += pushstream.host;
    url += ((pushstream.port != 80) && (pushstream.port != 443)) ? (":" + pushstream.port) : "";
    url += pushstream.urlPrefixPublisher;
    for (var channelName in pushstream.channels) {
      if (!pushstream.channels.hasOwnProperty || pushstream.channels.hasOwnProperty(channelName)) {
        channel = channelName;
        break;
      }
    }
    url += "?id=" + channel;
    return url;
  };

  var extract_xss_domain = function(domain) {
    // if domain is a ip address return it, else return the last two parts of it
    return (domain.match(/^(\d{1,3}\.){3}\d{1,3}$/)) ? domain : domain.split('.').slice(-2).join('.');
  };

  var linker = function(method, instance) {
    return function() {
      return method.apply(instance, arguments);
    };
  };

  var clearTimer = function(timer) {
    if (timer) {
      clearTimeout(timer);
    }
    return null;
  };

  /* common callbacks */
  var onmessageCallback = function(event) {
    Log4js.info("[" + this.type + "] message received", arguments);
    var message = parseMessage(event.data, this.pushstream);
    this.pushstream._onmessage(message.data, message.id, message.channel, message.eventid, true);
  };

  var onopenCallback = function() {
    this.pushstream._onopen();
    Log4js.info("[" + this.type + "] connection opened");
  };

  var onerrorCallback = function(event) {
    Log4js.info("[" + this.type + "] error (disconnected by server):", event);
    //if ((this.pushstream.readyState === PushStream.OPEN) &&
    //    (this.type === EventSourceWrapper.TYPE) &&
    //    (event.type === 'error') &&
    //    (this.connection.readyState === EventSource.CONNECTING)) {
      // EventSource already has a reconection function using the last-event-id header
    //  return;
    //}
    this._closeCurrentConnection();
    if ((this.pushstream.readyState === PushStream.CONNECTING) && (this.type === WebSocketWrapper.TYPE)) {
      this.pushstream._setState(PushStream.CLOSED);
      this.pushstream._reconnect(1000);
      return;
    }
    this.pushstream._onerror({type: ((event && (event.type === "load")) || (this.pushstream.readyState === PushStream.CONNECTING)) ? "load" : "timeout"});
  }

  /* wrappers */

  var WebSocketWrapper = function(pushstream) {
    if (!window.WebSocket && !window.MozWebSocket) throw "WebSocket not supported";
    this.type = WebSocketWrapper.TYPE;
    this.pushstream = pushstream;
    this.connection = null;
  };

  WebSocketWrapper.TYPE = "WebSocket";

  WebSocketWrapper.prototype = {
    connect: function() {
      this._closeCurrentConnection();
      var params = extend({}, this.pushstream.extraParams(), currentTimestampParam());
      var url = getSubscriberUrl(this.pushstream, this.pushstream.urlPrefixWebsocket, params);
      this.connection = (window.WebSocket) ? new window.WebSocket(url) : new window.MozWebSocket(url);
      this.connection.onerror   = linker(onerrorCallback, this);
      this.connection.onclose   = linker(onerrorCallback, this);
      this.connection.onopen    = linker(onopenCallback, this);
      this.connection.onmessage = linker(onmessageCallback, this);
      Log4js.info("[WebSocket] connecting to:", url);
    },

    disconnect: function() {
      if (this.connection) {
        Log4js.debug("[WebSocket] closing connection to:", this.connection.URL);
        this.connection.onclose = null;
        this._closeCurrentConnection();
        this.pushstream._onclose();
      }
    },

    _closeCurrentConnection: function() {
      if (this.connection) {
        try { this.connection.close(); } catch (e) { /* ignore error on closing */ }
        this.connection = null;
      }
    },

    sendMessage: function(message) {
      if (this.connection) { this.connection.send(message); }
    }
  };

  var EventSourceWrapper = function(pushstream) {
    if (!window.EventSource) throw "EventSource not supported";
    this.type = EventSourceWrapper.TYPE;
    this.pushstream = pushstream;
    this.connection = null;
  };

  EventSourceWrapper.TYPE = "EventSource";

  EventSourceWrapper.prototype = {
    connect: function() {
      this._closeCurrentConnection();
      var params = extend({}, this.pushstream.extraParams(), currentTimestampParam());
      var url = getSubscriberUrl(this.pushstream, this.pushstream.urlPrefixEventsource, params);
      this.connection = new window.EventSource(url);
      this.connection.onerror   = linker(onerrorCallback, this);
      this.connection.onopen    = linker(onopenCallback, this);
      this.connection.onmessage = linker(onmessageCallback, this);
      Log4js.info("[EventSource] connecting to:", url);
    },

    disconnect: function() {
      if (this.connection) {
        Log4js.debug("[EventSource] closing connection to:", this.connection.URL);
        this._closeCurrentConnection();
        this.pushstream._onclose();
      }
    },

    _closeCurrentConnection: function() {
      if (this.connection) {
        try { this.connection.close(); } catch (e) { /* ignore error on closing */ }
        this.connection = null;
      }
    }
  };

  var StreamWrapper = function(pushstream) {
    this.type = StreamWrapper.TYPE;
    this.pushstream = pushstream;
    this.connection = null;
    this.url = null;
    this.frameloadtimer = null;
    this.pingtimer = null;
    this.iframeId = "PushStreamManager_" + pushstream.id;
  };

  StreamWrapper.TYPE = "Stream";

  StreamWrapper.prototype = {
    connect: function() {
      this._closeCurrentConnection();
      var domain = extract_xss_domain(this.pushstream.host);
      try {
        document.domain = domain;
      } catch(e) {
        Log4js.error("[Stream] (warning) problem setting document.domain = " + domain + " (OBS: IE8 does not support set IP numbers as domain)");
      }
      var params = extend({}, this.pushstream.extraParams(), currentTimestampParam(), {"streamid": this.pushstream.id});
      this.url = getSubscriberUrl(this.pushstream, this.pushstream.urlPrefixStream, params);
      Log4js.debug("[Stream] connecting to:", this.url);
      this.loadFrame(this.url);
    },

    disconnect: function() {
      if (this.connection) {
        Log4js.debug("[Stream] closing connection to:", this.url);
        this._closeCurrentConnection();
        this.pushstream._onclose();
      }
    },

    _clear_iframe: function() {
      var oldIframe = document.getElementById(this.iframeId);
      if (oldIframe) {
        oldIframe.onload = null;
        if (oldIframe.parentNode) oldIframe.parentNode.removeChild(oldIframe);
      }
    },

    _closeCurrentConnection: function() {
      this._clear_iframe();
      if (this.connection) {
        this.pingtimer = clearTimer(this.pingtimer);
        this.frameloadtimer = clearTimer(this.frameloadtimer);
        this.connection = null;
        this.transferDoc = null;
        if (typeof window.CollectGarbage === 'function') window.CollectGarbage();
      }
    },

    loadFrame: function(url) {
      this._clear_iframe();
      try {
        var transferDoc = new window.ActiveXObject("htmlfile");
        transferDoc.open();
        transferDoc.write("<html><script>document.domain=\""+(document.domain)+"\";</script></html>");
        transferDoc.parentWindow.PushStream = PushStream;
        transferDoc.close();
        var ifrDiv = transferDoc.createElement("div");
        transferDoc.appendChild(ifrDiv);
        ifrDiv.innerHTML = "<iframe src=\""+url+"\"></iframe>";
        this.connection = ifrDiv.getElementsByTagName("IFRAME")[0];
        this.connection.onload = linker(onerrorCallback, this);
        this.transferDoc = transferDoc;
      } catch (e) {
        var ifr = document.createElement("IFRAME");
        ifr.style.width = "1px";
        ifr.style.height = "1px";
        ifr.style.border = "none";
        ifr.style.position = "absolute";
        ifr.style.top = "-10px";
        ifr.style.marginTop = "-10px";
        ifr.style.zIndex = "-20";
        ifr.PushStream = PushStream;
        document.body.appendChild(ifr);
        ifr.setAttribute("src", url);
        ifr.onload = linker(onerrorCallback, this);
        this.connection = ifr;
      }
      this.connection.setAttribute("id", this.iframeId);
      this.frameloadtimer = window.setTimeout(linker(onerrorCallback, this), this.pushstream.timeout);
    },

    register: function(iframeWindow) {
      this.frameloadtimer = clearTimer(this.frameloadtimer);
      iframeWindow.p = linker(this.process, this);
      this.connection.onload = linker(this._onframeloaded, this);
      this.pushstream._onopen();
      this.setPingTimer();
      Log4js.info("[Stream] frame registered");
    },

    process: function(id, channel, data, eventid) {
      this.pingtimer = clearTimer(this.pingtimer);
      Log4js.info("[Stream] message received", arguments);
      this.pushstream._onmessage(unescapeText(data), id, channel, eventid, true);
      this.setPingTimer();
    },

    _onframeloaded: function() {
      Log4js.info("[Stream] frame loaded (disconnected by server)");
      this.connection.onload = null;
      this.disconnect();
    },

    setPingTimer: function() {
      if (this.pingtimer) clearTimer(this.pingtimer);
      this.pingtimer = window.setTimeout(linker(onerrorCallback, this), this.pushstream.pingtimeout);
    }
  };

  var LongPollingWrapper = function(pushstream) {
    this.type = LongPollingWrapper.TYPE;
    this.pushstream = pushstream;
    this.connection = null;
    this.lastModified = null;
    this.etag = 0;
    this.allTags = [];
    this.connectionEnabled = false;
    this.opentimer = null;
    this.messagesQueue = [];
    this._linkedInternalListen = linker(this._internalListen, this);
    this.xhrSettings = {
        timeout: this.pushstream.longPollingTimeout,
        data: {},
        url: null,
        success: linker(this.onmessage, this),
        error: linker(this.onerror, this),
        load: linker(this.onload, this),
        beforeOpen: linker(this.beforeOpen, this),
        beforeSend: linker(this.beforeSend, this),
        afterReceive: linker(this.afterReceive, this)
    }
  };

  LongPollingWrapper.TYPE = "LongPolling";

  LongPollingWrapper.prototype = {
    connect: function() {
      this.messagesQueue = [];
      this._closeCurrentConnection();
      this.connectionEnabled = true;
      this.xhrSettings.url = getSubscriberUrl(this.pushstream, this.pushstream.urlPrefixLongpolling);
      var domain = extract_xss_domain(this.pushstream.host);
      var currentDomain = extract_xss_domain(window.location.hostname);
      this.useJSONP = (domain != currentDomain) || this.pushstream.longPollingUseJSONP;
      this.xhrSettings.scriptId = "PushStreamManager_" + this.pushstream.id;
      if (this.useJSONP) {
        this.pushstream.longPollingByHeaders = false;
        this.xhrSettings.data.callback = "PushStreamManager[" + this.pushstream.id + "].wrapper.onmessage";
      }
      this._internalListen();
      this.opentimer = window.setTimeout(linker(onopenCallback, this), 5000);
      Log4js.info("[LongPolling] connecting to:", this.xhrSettings.url);
    },

    _listen: function() {
      if (this._internalListenTimeout) clearTimer(this._internalListenTimeout);
      this._internalListenTimeout = window.setTimeout(this._linkedInternalListen, this.pushstream.longPollingInterval);
    },

    _internalListen: function() {
      if (this.connectionEnabled) {
        this.xhrSettings.data = extend({}, this.pushstream.extraParams(), this.xhrSettings.data);
        if (this.useJSONP) {
          Ajax.jsonp(this.xhrSettings);
        } else if (!this.connection) {
          this.connection = Ajax.load(this.xhrSettings);
        }
      }
    },

    disconnect: function() {
      this.connectionEnabled = false;
      if (this.connection) {
        Log4js.debug("[LongPolling] closing connection to:", this.xhrSettings.url);
        this._closeCurrentConnection();
        this.pushstream._onclose();
      }
    },

    _closeCurrentConnection: function() {
      this.opentimer = clearTimer(this.opentimer);
      if (this.connection) {
        try { this.connection.abort(); } catch (e) { /* ignore error on closing */ }
        this.connection = null;
        this.lastModified = null;
        this.xhrSettings.url = null;
      }
    },

    beforeOpen: function(xhr) {
      if (this.lastModified == null) {
        var date = new Date();
        if (this.pushstream.secondsAgo) { date.setTime(date.getTime() - (this.pushstream.secondsAgo * 1000)); }
        this.lastModified = date.toUTCString();
      }
      if (this.allTags.length > 0)
        this.xhrSettings.tag = this.allTags.join(",");
    },

    beforeSend: function(xhr) {
    },

    afterReceive: function(xhr) {
      this.connection = null;
    },

    onerror: function(status) {
      if (this.connectionEnabled) { /* abort(), called by disconnect(), call this callback, but should be ignored */
        if (status === 304) {
          this._listen();
        } else {
          Log4js.info("[LongPolling] error (disconnected by server):", status);
          this._closeCurrentConnection();
          this.pushstream._onerror({type: (status === 403) ? "load" : "timeout"});
        }
      }
    },

    onload: function() {
      this._listen();
    },

    onmessage: function(responseText) {
      Log4js.info("[LongPolling] message received", responseText);
      var lastMessage = null;
      var messages = isArray(responseText) ? responseText : responseText.split("\r\n");
      for (var i = 0; i < messages.length; i++) {
        if (messages[i]) {
          lastMessage = parseMessage(messages[i], this.pushstream);
          this.messagesQueue.push(lastMessage);
          if (lastMessage.tag) {// && lastMessage.tag > this.etag)
            //this.etag = lastMessage.tag;
            this.allTags.push(lastMessage.tag);
            if (this.allTags.length > 10) this.allTags.shift();
          }
        }
      }

      this._listen();
      if (this.messagesQueue.length == 0)
        this.pushstream._onmessage({}, -1, "ping", "", true);
      while (this.messagesQueue.length > 0) {
        var message = this.messagesQueue.shift();
        this.pushstream._onmessage(message.data, message.id, message.channel, message.eventid, (this.messagesQueue.length === 0));
      }
    }
  };

  /* mains class */

  var PushStreamManager = [];

  var PushStream = function(settings) {
    settings = settings || {};

    this.id = PushStreamManager.push(this) - 1;

    this.useSSL = (window.location.href.indexOf("https://") === 0);
    this.host = settings.host || window.location.hostname;
    this.port = settings.port || (this.useSSL ? 443 : 80);

    this.timeout = settings.timeout || 15000;
    this.pingtimeout = settings.pingtimeout || 60000;
    this.reconnecttimeout = settings.reconnecttimeout || 10000;
    this.checkChannelAvailabilityInterval = settings.checkChannelAvailabilityInterval || 30000;

    this.secondsAgo = Number(settings.secondsAgo);
    this.longPollingByHeaders     = (settings.longPollingByHeaders === undefined) ? true : settings.longPollingByHeaders;
    this.longPollingTagArgument   = settings.longPollingTagArgument  || 'tag';
    this.longPollingTimeArgument  = settings.longPollingTimeArgument || 'time';
    this.longPollingUseJSONP      = settings.longPollingUseJSONP     || false;
    this.longPollingTimeout       = settings.longPollingTimeout      || 60000;
    this.longPollingInterval      = settings.longPollingInterval     || 100;

    this.reconnecttimer = null;

    this.urlPrefixPublisher   = settings.urlPrefixPublisher   || '/pub';
    this.urlPrefixStream      = settings.urlPrefixStream      || '/push/stream';
    this.urlPrefixEventsource = settings.urlPrefixEventsource || '/push/ev';
    this.urlPrefixLongpolling = settings.urlPrefixLongpolling || '/push/longpoll';
    this.urlPrefixWebsocket   = settings.urlPrefixWebsocket   || '/push/ws';

    this.jsonIdKey      = settings.jsonIdKey      || 'id';
    this.jsonChannelKey = settings.jsonChannelKey || 'channel';
    this.jsonDataKey    = settings.jsonDataKey    || 'text';
    this.jsonTagKey     = settings.jsonTagKey     || 'tag';
    this.jsonTimeKey    = settings.jsonTimeKey    || 'time';
    this.jsonEventIdKey = settings.jsonEventIdKey || 'eventid';

    this.modes = (settings.modes || 'eventsource|websocket|stream|longpolling').split('|');
    this.wrappers = [];
    this.wrapper = null;

    this.onopen = null;
    this.onmessage = null;
    this.onerror = null;
    this.onstatuschange = null;

    this.channels = {};
    this.channelsCount = 0;
    this.channelsByArgument   = settings.channelsByArgument   || false;
    this.channelsArgument     = settings.channelsArgument     || 'channels';

    this.extraParams          = settings.extraParams          || this.extraParams;

    for ( var i = 0; i < this.modes.length; i++) {
      try {
        var wrapper = null;
        switch (this.modes[i]) {
        case "websocket"  : wrapper = new WebSocketWrapper(this);   break;
        case "eventsource": wrapper = new EventSourceWrapper(this); break;
        case "longpolling": wrapper = new LongPollingWrapper(this); break;
        case "stream"     : wrapper = new StreamWrapper(this);      break;
        }
        this.wrappers[this.wrappers.length] = wrapper;
      } catch(e) { Log4js.info(e); }
    }

    this._setState(0);
  }

  /* constants */
  PushStream.LOG_LEVEL = 'error'; /* debug, info, error */
  PushStream.LOG_OUTPUT_ELEMENT_ID = 'Log4jsLogOutput';

  /* status codes */
  PushStream.CLOSED        = 0;
  PushStream.CONNECTING    = 1;
  PushStream.OPEN          = 2;

  /* main code */
  PushStream.prototype = {
    extraParams: function() {
      return {};
    },

    addChannel: function(channel, options) {
      if (escapeText(channel) != channel) {
        throw "Invalid channel name! Channel has to be a set of [a-zA-Z0-9]";
      }
      Log4js.debug("entering addChannel");
      if (typeof(this.channels[channel]) !== "undefined") throw "Cannot add channel " + channel + ": already subscribed";
      options = options || {};
      Log4js.info("adding channel", channel, options);
      this.channels[channel] = options;
      this.channelsCount++;
      if (this.readyState != PushStream.CLOSED) this.connect();
      Log4js.debug("leaving addChannel");
    },

    removeChannel: function(channel) {
      if (this.channels[channel]) {
        Log4js.info("removing channel", channel);
        delete this.channels[channel];
        this.channelsCount--;
      }
    },

    removeAllChannels: function() {
      Log4js.info("removing all channels");
      this.channels = {};
      this.channelsCount = 0;
    },

    _setState: function(state) {
      if (this.readyState != state) {
        Log4js.info("status changed", state);
        this.readyState = state;
        if (this.onstatuschange) {
          this.onstatuschange(this.readyState);
        }
      }
    },

    connect: function() {
      Log4js.debug("entering connect");
      if (!this.host)                 throw "PushStream host not specified";
      if (isNaN(this.port))           throw "PushStream port not specified";
      if (!this.channelsCount)        throw "No channels specified";
      if (this.wrappers.length === 0) throw "No available support for this browser";

      this._keepConnected = true;
      this._lastUsedMode = 0;
      this._connect();

      Log4js.debug("leaving connect");
    },

    disconnect: function() {
      Log4js.debug("entering disconnect");
      this._keepConnected = false;
      this._disconnect();
      this._setState(PushStream.CLOSED);
      Log4js.info("disconnected");
      Log4js.debug("leaving disconnect");
    },

    _connect: function() {
      this._disconnect();
      this._setState(PushStream.CONNECTING);
      this.wrapper = this.wrappers[this._lastUsedMode % this.wrappers.length];
      this._lastUsedMode += 1;

      try {
        this.wrapper.connect();
      } catch (e) {
        //each wrapper has a cleanup routine at disconnect method
        if (this.wrapper) {
          this.wrapper.disconnect();
        }
      }
    },

    _disconnect: function() {
      this.reconnecttimer = clearTimer(this.reconnecttimer);
      if (this.wrapper) {
        this.wrapper.disconnect();
      }
    },

    _onopen: function() {
      this.reconnecttimer = clearTimer(this.reconnecttimer);
      this._setState(PushStream.OPEN);
    },

    _onclose: function() {
      this.reconnecttimer = clearTimer(this.reconnecttimer);
      this._setState(PushStream.CLOSED);
      this._reconnect(this.reconnecttimeout);
    },

    _onmessage: function(data, id, channel, eventid, isLastMessageFromBatch) {
      if (this.error_count)
        this.error_count = 0;
      if (this._lastUsedMode > 0) {
        this._lastUsedMode--; //use same mode on next connection
      }
      Log4js.debug("message", data, id, channel, eventid, isLastMessageFromBatch);
      if (this.onmessage) { this.onmessage(data, id, channel, eventid, isLastMessageFromBatch); }
    },

    _onerror: function(error) {
      this._setState(PushStream.CLOSED);
      if (!this.error_count) this.error_count = 0;
      this.error_count += 1;
      var timeout = ((error.type == "timeout") ? this.reconnecttimeout : this.checkChannelAvailabilityInterval);
      if (this.error_count == 2 && typeof(PEM) != "undefined")
        PEM.fire("refreshOnlineUsers");
      if (this.error_count > 3)
        timeout = 30000;
      this._reconnect(timeout);
      if (this.onerror) { this.onerror(error); }
    },

    _reconnect: function(timeout) {
      if (this._keepConnected && !this.reconnecttimer && (this.readyState != PushStream.CONNECTING) && typeof(PEM) != "undefined") {
        PEM.fire("detectNetworkTimeout");

        Log4js.info("trying to reconnect in", timeout);
        this.reconnecttimer = window.setTimeout(linker(this._connect, this), timeout);
      }
    },

    sendMessage: function(message, successCallback, errorCallback) {
      message = escapeText(message);
      if (this.wrapper.type === WebSocketWrapper.TYPE) {
        this.wrapper.sendMessage(message);
        if (successCallback) successCallback();
      } else {
        Ajax.post({url: getPublisherUrl(this), data: message, success: successCallback, error: errorCallback});
      }
    }
  };

  PushStream.sendMessage = function(url, message, successCallback, errorCallback) {
    Ajax.post({url: url, data: escapeText(message), success: successCallback, error: errorCallback});
  };

  // to make server header template more clear, it calls register and
  // by a url parameter we find the stream wrapper instance
  PushStream.register = function(iframe) {
    var matcher = iframe.window.location.href.match(/streamid=([0-9]*)&?/);
    if (matcher[1] && PushStreamManager[matcher[1]]) {
      PushStreamManager[matcher[1]].wrapper.register(iframe);
    }
  };

  PushStream.unload = function() {
    for ( var i = 0; i < PushStreamManager.length; i++) {
      try { PushStreamManager[i].disconnect(); } catch(e){}
    }
  };

  /* make class public */
  window.PushStream = PushStream;
  window.PushStreamManager = PushStreamManager;

  if (window.attachEvent) { window.attachEvent("onunload", PushStream.unload); }
  if (window.addEventListener) { window.addEventListener.call(window, "unload", PushStream.unload, false); }

})(window);
(function(t){function e(){function e(t){"remove"===t&&this.each(function(t,e){var n=r(e);n&&n.remove()}),this.find("span.mceEditor,div.mceEditor").each(function(t,e){var n=tinymce.get(e.id.replace(/_parent$/,""));n&&n.remove()})}function i(t){var i,r=this;if(t!==n)e.call(r),r.each(function(e,n){var i;(i=tinymce.get(n.id))&&i.setContent(t)});else if(r.length>0&&(i=tinymce.get(r[0].id)))return i.getContent()}function r(t){var e=null;return t&&t.id&&a.tinymce&&(e=tinymce.get(t.id)),e}function c(t){return!!(t&&t.length&&a.tinymce&&t.is(":tinymce"))}var u={};t.each(["text","html","val"],function(e,a){var o=u[a]=t.fn[a],s="text"===a;t.fn[a]=function(e){var a=this;if(!c(a))return o.apply(a,arguments);if(e!==n)return i.call(a.filter(":tinymce"),e),o.apply(a.not(":tinymce"),arguments),a;var u="",l=arguments;return(s?a:a.eq(0)).each(function(e,n){var i=r(n);u+=i?s?i.getContent().replace(/<(?:"[^"]*"|'[^']*'|[^'">])*>/g,""):i.getContent({save:!0}):o.apply(t(n),l)}),u}}),t.each(["append","prepend"],function(e,i){var a=u[i]=t.fn[i],o="prepend"===i;t.fn[i]=function(t){var e=this;return c(e)?t!==n?(e.filter(":tinymce").each(function(e,n){var i=r(n);i&&i.setContent(o?t+i.getContent():i.getContent()+t)}),a.apply(e.not(":tinymce"),arguments),e):void 0:a.apply(e,arguments)}}),t.each(["remove","replaceWith","replaceAll","empty"],function(n,i){var r=u[i]=t.fn[i];t.fn[i]=function(){return e.call(this,i),r.apply(this,arguments)}}),u.attr=t.fn.attr,t.fn.attr=function(e,a){var o=this,s=arguments;if(!e||"value"!==e||!c(o))return a!==n?u.attr.apply(o,s):u.attr.apply(o,s);if(a!==n)return i.call(o.filter(":tinymce"),a),u.attr.apply(o.not(":tinymce"),s),o;var l=o[0],p=r(l);return p?p.getContent({save:!0}):u.attr.apply(t(l),s)}}var n,i,r=[],a=window;t.fn.tinymce=function(n){function c(){var i=[],r=0;e&&(e(),e=null),l.each(function(t,e){var a,c=e.id,u=n.oninit;c||(e.id=c=tinymce.DOM.uniqueId()),a=new tinymce.Editor(c,n,tinymce.EditorManager),i.push(a),a.on("init",function(){var t,e=u;l.css("visibility",""),u&&++r==i.length&&("string"==typeof e&&(t=-1===e.indexOf(".")?null:tinymce.resolve(e.replace(/\.\w+$/,"")),e=tinymce.resolve(e)),e.apply(t||tinymce,i))})}),t.each(i,function(t,e){e.render()})}var u,o,s,l=this,p="";if(!l.length)return l;if(!n)return tinymce.get(l[0].id);if(l.css("visibility","hidden"),a.tinymce||i||!(u=n.script_url))1===i?r.push(c):c();else{i=1,o=u.substring(0,u.lastIndexOf("/")),-1!=u.indexOf(".min")&&(p=".min"),a.tinymce=a.tinyMCEPreInit||{base:o,suffix:p},-1!=u.indexOf("gzip")&&(s=n.language||"en",u=u+(/\?/.test(u)?"&":"?")+"js=true&core=true&suffix="+escape(p)+"&themes="+escape(n.theme)+"&plugins="+escape(n.plugins)+"&languages="+s,a.tinyMCE_GZ||(a.tinyMCE_GZ={start:function(){function e(t){tinymce.ScriptLoader.markDone(tinymce.baseURI.toAbsolute(t))}e("langs/"+s+".js"),e("themes/"+n.theme+"/theme"+p+".js"),e("themes/"+n.theme+"/langs/"+s+".js"),t.each(n.plugins.split(","),function(t,n){n&&(e("plugins/"+n+"/plugin"+p+".js"),e("plugins/"+n+"/langs/"+s+".js"))})},end:function(){}}));var f=document.createElement("script");f.type="text/javascript",f.onload=f.onreadystatechange=function(e){e=e||event,("load"==e.type||/complete|loaded/.test(f.readyState))&&(tinymce.dom.Event.domLoaded=1,i=2,n.script_loaded&&n.script_loaded(),c(),t.each(r,function(t,e){e()}))},f.src=u,document.body.appendChild(f)}return l},t.extend(t.expr[":"],{tinymce:function(t){return!!(t.id&&"tinymce"in window&&tinymce.get(t.id))}})})(jQuery);var EQUATION_ENGINE='http://latex.codecogs.com';
var FAVORITE_ENGINE='http://latex.codecogs.com/json';
var EDITOR_SRC='/modules/tinymce/eqneditor';
function $$(a){return document.getElementById(a)}function $onchange(d,c){var b=$$(d);if(b){b.onchange=c}}function $onclick(d,c){var b=$$(d);if(b){b.onclick=c}}function setadvert(){var b=$$("latex_formula");var a=b.offsetLeft;b=b.offsetParent;while(b!=null){a=parseInt(a)+parseInt(b.offsetLeft);b=b.offsetParent}$$("advert").style.display=(a<140?"none":"none")}var Cookie={set:function(b,c,a){var d=new Date();d.setDate(d.getDate()+a);document.cookie=b+"="+escape(c)+((a==null)?"":";expires="+d.toGMTString())},get:function(a){if(document.cookie.length>0){c_start=document.cookie.indexOf(a+"=");if(c_start!=-1){c_start=c_start+a.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1){c_end=document.cookie.length}return unescape(document.cookie.substring(c_start,c_end))}}return""}};var URL={get:function(a,b){if(location.href.match(a+"=")){return location.href.split(a+"=")[1].split("&")[0]}return b}};var Opacity={set:function(c,a){var b=$$(c).style;b.opacity=(a/100);b.MozOpacity=(a/100);b.KhtmlOpacity=(a/100);b.filter="alpha(opacity="+a+")"},fade:function(d,c,a,b){speed=Math.round(b/100);sgn=(c>a)?-1:1;count=sgn*(a-c);for(i=1;i<count;i++){setTimeout("Opacity.set('"+d+"',"+(i*sgn+c)+")",(i*speed))}},fadeout:function(a){if($$(a)){this.fade(a,100,10,800);setTimeout("$$('"+a+"').style.display='none'",800)}},fadein:function(a){if($$(a)){this.set(a,20);$$(a).style.display="none";this.fade(a,20,100,800)}}};var Panel={plock:null,ctimer:null,otimer:null,oid:null,timer:Array(),open:function(b){if(b){var c=b.id;if(this.timer[c]!=""){clearTimeout(this.timer[c]);this.timer[c]=""}this.timer[c]=setTimeout("$$('"+c+"').style.overflow='visible';",200)}},close:function(b){if(b){var c=b.id;if(this.timer[c]!=""){clearTimeout(this.timer[c]);this.timer[c]=""}this.timer[c]=setTimeout("$$('"+c+"').style.overflow='hidden';",200)}},hoverdiv:null,hlock:false,hover:function(a,b){if(this.hoverdiv){this.lock=true;this.hoverdiv.innerHTML='<img src="/main/show_latex?'+encodeImageSrc(a.latex,true)+'"/>';if(document.all){this.hoverdiv.style.top=(event.clientY-10)+"px";this.hoverdiv.style.left=(event.clientX+20)+"px"}else{if(!b){b=window.event}this.hoverdiv.style.top=(b.pageY-10)+"px";this.hoverdiv.style.left=(b.pageX+20)+"px"}this.hoverdiv.style.display="block";this.lock=false;a.onmouseout=Panel.hidehover}},hidehover:function(){if(!this.hlock){$$("hover").style.display="none"}},init:function(f,c){this.hoverdiv=$$(f);var d;if(c!==undefined){d=document.getElementById(c)}else{d=document}var a=d.getElementsByTagName("area");for(i=0;i<a.length;i++){a[i].onmouseover=function(g){Panel.hover(this,g)};latex=a[i].alt;a[i].latex=latex;a[i].alt="";if(a[i].title==""){a[i].title=latex}if(a[i].onclick==undefined){a[i].onclick=function(){EqEditor.insert(this.latex)}}}if(d.getElementsByClassName==undefined){d.getElementsByClassName=function(l){var k=new RegExp("(?:^|\\s)"+l+"(?:$|\\s)");var o=d.getElementsByTagName("*");var j=[];var h;for(var g=0;(h=o[g])!=null;g++){var p=h.className;if(p&&p.indexOf(l)!=-1&&k.test(p)){j.push(h)}}return j}}var b=d.getElementsByClassName("panel");for(i=0;i<b.length;i++){if(b[i].id!=""){b[i].onmouseover=function(g){Panel.open(this)};b[i].onmouseout=function(g){Panel.close(this)}}}}};function EqTextArea(d,b,f,a,c){this.changed=false;this.orgtxt="";this.bArray_id=new Array();this.bArray_area=new Array();this.bArray_mode=new Array();this.bsize=0;this.updateExportArea=function(){for(i=0;i<this.bsize;i++){var h=this.exportEquation(this.bArray_mode[i]);var g=this.bArray_area[i].attributes;if(this.bArray_area[i].src!==undefined){this.bArray_area[i].src=h}else{if(this.bArray_area[i].value!==undefined){this.bArray_area[i].value=h}else{if(this.bArray_area[i].innerHTML!==undefined){this.bArray_area[i].innerHTML=h}}}}};this.addExportArea=function(j,h){var g=$$(j);if(g){this.bArray_id[this.bsize]=j;this.bArray_area[this.bsize]=g;this.bArray_mode[this.bsize]=h;this.bsize++}};this.changeExportArea=function(h,g){for(i=0;i<this.bsize;i++){if(h==this.bArray_id[i]){this.bArray_mode[i]=g;i=this.bsize}}};this.myUndo=0;this.myRedo=0;this.store_text=new Array();this.store_text.push("");this.addEvent=function(h,g){if(this.equation_input.addEventListener){this.equation_input.addEventListener(h,g,false)}else{this.equation_input.attachEvent("on"+h,g)}};this.set=function(k,h,l,g,j){if(k==undefined||k==""){k="equationview"}if(h==undefined||h==""){h="latex_formula"}if(l==undefined||l==""){l="equationcomment"}if(g==undefined||g==""){g="download"}if(j==undefined||j==""){j="intro"}this.equation_preview=$$(k);this.equation_input=$$(h);this.equation_comment=$$(l);this.equation_download=$$(g);this.intro_text=j;if(this.equation_input){this.addEvent("keydown",function(o){Panel.close();EqEditor.countclick();EqEditor.tabHandler(o)});this.addEvent("keyup",function(){EqEditor.textchanged();EqEditor.autorenderEqn(10)});this.addEvent("keypress",function(o){EqEditor.keyHandler(o)});if($$(this.intro_text)){$$(this.intro_text).onclick=function(o){EqEditor.targetArea.equation_input.focus();Opacity.fadeout(this.intro_text)}}}};this.cleartext=function(){this.equation_input.value="";this.equation_input.focus();this.changed=false;this.equation_preview.src=EDITOR_SRC+"/images/spacer.gif";Opacity.fadein(this.intro_text)};this.textchanged=function(){var g=this.getEquationStr();if(g.length==0){Opacity.fadein(this.intro_text)}else{Opacity.fadeout(this.intro_text)}if(g!=this.orgtxt){this.orgtxt=g;this.changed=true;return true}return false};this.auton=0;this.renderCountdown=function(){if(this.auton>0){this.auton--;var g=new Function(this.renderCountdown());setTimeout(g,100)}else{this.renderEqn(null)}};this.autorenderEqn=function(g){if(this.auton>0&&g>0){this.auton=g}else{this.auton=g;this.renderCountdown()}};this.insertText=function(r,v,l){var q="";if(v==1000){v=r.length-1}if(v==null){v=r.indexOf("{")+1;if(v<=0){r+=" ";v=r.length}else{if(r.charAt(v)!="}"){v=r.indexOf("}",v)+1}}}var w=(l==null)?v:l;var p;var x=this.equation_input;var o=(r.substring(1,5)=="left");if(document.selection){x.focus();var j=document.selection.createRange();p=this.equation_input.value.length+1;var g=j.duplicate();while(g.parentElement()==x&&g.move("character",1)==1){--p}if((o||w>=0)&&j.text.length){if(o){ins_point=7}else{ins_point=w}if(w==null){v=r.length+j.text.length+1}else{if(w<v){v+=j.text.length}}j.text=r.substring(0,ins_point)+j.text+r.substr(ins_point)}else{j.text=r}var t=x.createTextRange();t.collapse(true);v=p+v;v-=x.value.substr(0,v).split("\n").length-1;t.moveEnd("character",v);t.moveStart("character",v);t.select()}else{if(x.selectionStart||x.selectionStart=="0"){var u=x.selectionStart;var h=x.selectionEnd;var k=u+r.length;if((o||w>=0)&&h>u){if(o){ins_point=7}else{ins_point=w}if(w==null){v=r.length+h-u+1}else{if(w<v){v+=h-u}}r=r.substring(0,ins_point)+x.value.substring(u,h)+r.substr(ins_point)}x.value=x.value.substring(0,u)+r+x.value.substring(h,x.value.length);x.selectionStart=k;x.selectionEnd=k;x.focus();x.setSelectionRange(u+v,u+v)}else{x.value+=r}}this.textchanged();this.autorenderEqn(10);Panel.close(null);x.focus()};this.getEquationStr=function(){var g=this.equation_input.value;g=g.replace(/^\s+|\s+$/g,"");g=g.replace(/\s+/g," ");if(g.length>0){return EqEditor.getSize()+EqEditor.getCompressed()+EqEditor.getDPI()+EqEditor.getBG()+EqEditor.getFont()+g}return""};this.exportMessage=function(h){var g=$$("exportmessage");if(g){g.innerHTML=h}};this.exportEquation=function(g){var h=EqEditor.getFormat();switch(g){case"wp":this.exportMessage("Wordpress markup for this equation is:");text=EqEditor.getSize()+this.equation_input.value;return EqEditor.get_inline_wrap(text,"[latex]{$TEXT}[/latex]\n","$latex {$TEXT}$ ");break;case"phpBB":this.exportMessage("PHP Bulletin Board markup for this equation is:");text=this.getEquationStr();return("[tex]"+text+"[/tex]\n");break;case"tw":this.exportMessage("TiddlyWiki markup for this equation is:");text=this.getEquationStr();text=text.replace(/\[/g,"%5B");text=text.replace(/\]/g,"%5D");return("[img["+EQUATION_ENGINE+"/"+h+".latex?"+text+"]]");break;case"url":this.exportMessage("The URL link to this equation is:");text=this.getEquationStr();text=text.replace(/\s/g,"&space;");text=text.replace(/\+/g,"&plus;");return(EQUATION_ENGINE+"/"+h+".latex?"+text);break;case"urlencoded":this.exportMessage("The Encoded URL link to this equation is:");text=escape(this.getEquationStr());text=text.replace(/\+/g,"&plus;");return(EQUATION_ENGINE+"/"+h+".latex?"+text);break;case"pre":this.exportMessage("HTML code using pre-tags is:");text=EqEditor.getSize()+this.equation_input.value;return EqEditor.get_inline_wrap(text,'<pre xml:lang="latex">{$TEXT}</pre>\n','<code xml:lang="latex">{$TEXT}</code> ');break;case"doxygen":this.exportMessage("DOxygen markup for this equation is:");text=EqEditor.getSize()+this.equation_input.value;return EqEditor.get_inline_wrap(text,"\\f[{$TEXT}\\f]\n","\\f${$TEXT}\\f$ ");break;case"htmledit":this.exportMessage("HTML code to embed this equation into a web page is:");text=this.getEquationStr();if(h=="swf"){return('<a href="http://www.codecogs.com/eqnedit.php?latex='+text.replace(/\+/g,"@plus;")+'" target="_blank">'+AC_FL_RunContent("codebase","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0","width","600","height","100","src",(EQUATION_ENGINE+"/swf.latex?"+text),"quality","high","pluginspage","http://www.macromedia.com/go/getflashplayer","align","top","scale","showall","wmode","window","devicefont","false","bgcolor","#ffffff","menu","true","allowFullScreen","true","movie",(EQUATION_ENGINE+"/swf.latex?"+text))+"</a>")}else{return('<a href="http://www.codecogs.com/eqnedit.php?latex='+text.replace(/\+/g,"@plus;")+'" target="_blank"><img src="'+EQUATION_ENGINE+"/"+h+".latex?"+text+'" title="'+text+'" /></a>')}break;case"html":this.exportMessage("HTML code to embed this equation into a web page is:");text=this.getEquationStr();if(h=="swf"){return AC_FL_RunContent("codebase","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0","width","600","height","100","src",(EQUATION_ENGINE+"/swf.latex?"+text),"quality","high","pluginspage","http://www.macromedia.com/go/getflashplayer","align","top","scale","showall","wmode","window","devicefont","false","bgcolor","#ffffff","menu","true","allowFullScreen","true","movie",(EQUATION_ENGINE+"/swf.latex?"+text))}else{return('<img src="'+EQUATION_ENGINE+"/"+h+".latex?"+text+'" title="'+text+'" />')}break;default:this.exportMessage("LaTeX markup for this equation is:");text=EqEditor.getSize()+this.equation_input.value;return EqEditor.get_inline_wrap(text,"\\[{$TEXT}\\]\n","${$TEXT}$ ");break}return text};this.setdownload=function(g){if(this.equation_download){this.equation_download.innerHTML=g}};this.setcomment=function(g){if(this.equation_comment){this.equation_comment.innerHTML=g}};this.renderEqn=function(p){var l=this.equation_input.value;l=l.replace(/^\s+|\s+$/g,"");if(l.length==0){return true}var k=0;var h;for(h=0;h<l.length;h++){switch(l.charAt(h)){case"{":if(h==0||l[h-1]!="\\"){k++}break;case"}":if(h==0||l[h-1]!="\\"){k--}break}}var o;if(k==0){if($$("renderbutton")){$$("renderbutton").className="greybutton"}var g=this.equation_preview;l=this.getEquationStr();sval=l.replace(/"/g,'\\"').replace(/\s/g,"&space;");var j=EqEditor.getFormat();if(this.changed){this.setcomment("");switch(j){case"gif":case"png":case"svg":g.src=EQUATION_ENGINE+"/"+j+".latex?"+l;this.setdownload('<a href="'+EQUATION_ENGINE+"/"+j+".download?"+sval+'">Click here to Download Image ('+j.toUpperCase()+")</a>");break;case"pdf":g.src=EQUATION_ENGINE+"/gif.latex?"+l;this.setdownload('<a target="_blank" href="'+EQUATION_ENGINE+"/pdf.download?"+sval+'"><img src="images/pdf.jpg" width="30" height="30" align="middle" />Click here to Download Equation (PDF)</a>');break}this.updateExportArea()}}else{if(k<0){this.setcomment("<br/><span class=\"orange\">You have more <strong>closed '}' brackets</strong> than open '{' brackets</span>")}else{this.setcomment("<br/><span class=\"orange\">You have more <strong>open '{' brackets</strong> than closed '}' brackets</span>")}}this.changed=false};this.clickval=0;this.countclick=function(){var g=this.equation_input.value;this.clickval++;if(this.clickval>=3){this.clickval=0;if(this.myUndo==0||this.store_text[this.myUndo]!=g){if(this.myUndo>20){this.store_text.shift()}else{this.myUndo++}this.store_text[this.myUndo]=g}}this.myRedo=0};this.undo=function(h){if(this.myRedo==0){if(this.myUndo>20){this.store_text.shift()}else{this.myUndo++}this.store_text[this.myUndo]=this.equation_input.value}if(this.myRedo<this.myUndo){this.myRedo++;if(this.myRedo==this.myUndo&&$$("undobutton")){$$("undobutton").src=EDITOR_SRC+"/images/buttons/undo-x.gif"}var g=$$("redobutton");if(g){g.src=EDITOR_SRC+"/images/buttons/redo.gif"}}else{return}z=this.store_text.length-this.myRedo-1;if(this.store_text[z]){this.equation_input.value=this.store_text[z]}else{this.equation_input.value=this.store_text[0]}this.equation_input.focus()};this.redo=function(h){if(this.myRedo>0){this.myRedo--;if(this.myRedo==0&&$$("redobutton")){$$("redobutton").src=EDITOR_SRC+"/images/buttons/redo-x.gif"}var g=$$("undobutton");if(g){g.src=EDITOR_SRC+"/images/buttons/undo.gif"}}else{return}var j=this.store_text.length-this.myRedo-1;if(this.store_text[j]){this.equation_input.value=this.store_text[j]}else{this.equation_input.value=this.store_text[0]}this.equation_input.focus()};this.Export=function(g,h){g(this.exportEquation(h));Example.add_history(this.equation_input.value);Example.hide()};this.load=function(o){var l=o;if(l!==undefined){l=unescape(l);l=l.replace(/@plus;/g,"+");l=l.replace(/&plus;/g,"+");l=l.replace(/&space;/g," ");var h,g,k;do{k=0;l=l.replace(new RegExp("^[\\s]+","g"),"");h=l.indexOf(" ");var j=l.indexOf("}");if(j!=-1&&(j<h||h==-1)){h=j}if(h!=-1){g=l.substr(0,h);if(EqEditor.setSelIndx("fontsize",g)){k=1}if(g=="\\inline"){$$("inline").checked=true;$$("compressed").checked=true;k=1}if(g.substr(0,4)=="\\bg_"&&EqEditor.setSelIndx("bg",g.substr(4))){k=1}if(g.substr(0,4)=="\\fn_"&&EqEditor.setSelIndx("font",g.substr(4))){k=1}if(g.substr(0,5)=="\\dpi{"&&EqEditor.setSelIndx("dpi",g.substr(5))){k=1}if(k){l=l.substr(h+1)}}}while(k);if(l.length>0){this.equation_input.value=l;this.textchanged();this.renderEqn(null);Opacity.fadeout(this.intro_text)}}};if(d!==undefined){this.set(d,b,f,a,c)}}var gallery=null;var Example={lastbutton:null,load_json:function(f,h){var a=$$("load_json");if(a!=null){a.parentNode.removeChild(a);delete a}var g=new Date();h="rand="+g.getTime()+"&"+h;var c=document.getElementsByTagName("head")[0];var b=document.createElement("script");b.src=FAVORITE_ENGINE+"/"+f+"?"+h;b.id="load_json";c.appendChild(b)},add_fav:function(){text=EqEditor.getEquation();if(text!=""){this.load_json("favorite_json.php","sid="+EqEditor.SID+"&add&eqn="+escape(text.replace(/\+/g,"@plus;")));setTimeout("Example.show(null, 'fav')",200)}},del_fav:function(a){this.load_json("favorite_json.php","sid="+EqEditor.SID+"&delete="+a);setTimeout("Example.show(null, 'fav')",200)},add_history:function(a){if(a!=""){this.load_json("history_json.php","sid="+EqEditor.SID+"&add&eqn="+escape(a.replace(/\+/g,"@plus;")))}},show:function(a,b){$$("bar1").style.display="none";$$("bar2").style.display="none";if($$("photos")){$$("photos").innerHTML=""}if(a!==null){if(this.lastbutton!==null){this.lastbutton.className="lightbluebutton"}a.className="greybutton";this.lastbutton=a}gallery=new Scroll();if(b=="fav"||b=="history"){var c=new Date();gallery.init("photos","leftarrow","rightarrow","overview",FAVORITE_ENGINE+"/example_json.php?fn=gallery&rand="+c.getTime()+"&sid="+EqEditor.SID)}else{gallery.init("photos","leftarrow","rightarrow","overview",FAVORITE_ENGINE+"/example_json.php?fn=gallery")}gallery.visible_num=1;gallery.new_offset=5;gallery.maxpanels=1;gallery.set_width(600,100,60);gallery.set_subtext("&type="+b);gallery.add_panel();gallery.setarrow();gallery.setoverview()},hide:function(){$$("bar2").style.display="none";$$("bar1").style.display="none";if(this.lastbutton!==null){this.lastbutton.className="lightbluebutton"}this.lastbutton=null}};var ExportButton={bArray_id:new Array(),bArray_area:new Array(),bArray_mode:new Array(),bArray_fn:new Array(),bsize:0,state:function(a){for(i=0;i<this.bsize;i++){if(a){this.bArray_id[i].className="lightbluebutton"}else{this.bArray_id[i].className="greybutton"}}},add:function(c,d,g,f){var b=$$(d);if(b){this.bArray_id[this.bsize]=b;this.bArray_area[this.bsize]=c;this.bArray_mode[this.bsize]=f;this.bArray_fn[this.bsize]=g;b.onclick=function(h){var a=this.exportid;ExportButton.bArray_area[a].Export(ExportButton.bArray_fn[a],ExportButton.bArray_mode[a])};b.exportid=this.bsize;this.bsize++}}};var EqEditor={SID:0,copy_button:null,key_text:"",format:"gif",setSelIndx:function(d,a){var c=$$(d);if(c&&a){for(var b=0;b<c.options.length;b++){if(c.options[b].value==a){c.options[b].selected=true;return true}}}return false},targetArray:new Array(),targetSize:0,targetArea:null,curTarget:0,changeExportArea:function(b,a){for(i=0;i<this.targetSize;i++){this.targetArray[i].changeExportArea(b,a)}},autorenderEqn:function(a){this.targetArea.autorenderEqn(a)},change:function(a){if(a!=this.curTarget){this.curTarget=a;this.key_rext=""}this.targetArea=this.targetArray[a]},add:function(b,a){this.targetArray[this.targetSize]=b;b.equation_input.onfocus=new Function("EqEditor.change("+this.targetSize+");");if(a){if(window.addEventListener){window.addEventListener("resize",new Function("EqEditor.resize("+this.targetSize+");"),false)}else{window.attachEvent("onresize",new Function("EqEditor.resize("+this.targetSize+");"))}EqEditor.resize(this.targetSize)}if(this.targetSize==0){b.equation_input.focus()}this.targetSize++},editor_id:null,embed:function(f,c,b,d){this.editor_id=f;var a="http://latex.codecogs.com/editor_embedded_json.php?id="+f+"&SID="+c+"&design="+b;if(d!=undefined&&d!=""){a+="&lang="+d}document.write('<script src="'+a+'" type="text/javascript"><\/script>')},moveto:function(c){if(c!=this.editor_id){var a=$$(c);while($$(this.editor_id).childNodes[0]){var b=$$(this.editor_id).childNodes[0];b.parentNode.removeChild(b);a.appendChild(b)}this.editor_id=c}},targetFn:null,copyToTarget:function(a){if(this.targetFn!==null){this.targetFn(a)}},init:function(g,c,b,a){Panel.init("hover",a);if(g==""){this.SID=Cookie.get("eqeditor");if(!this.SID){var f=new Date();this.SID=f.getTime();Cookie.set("eqeditor",g,1000)}}else{this.SID=g}if(c!==undefined){this.add(c,b);this.targetArea=c}this.setSelIndx("format",Cookie.get("format"));this.setSelIndx("font",Cookie.get("font"));this.setSelIndx("fontsize",Cookie.get("fontsize"));this.setSelIndx("dpi",Cookie.get("dpi"));this.setSelIndx("bg",Cookie.get("bg"));$onclick("undobutton",function(d){EqEditor.targetArea.undo()});$onclick("redobutton",function(d){EqEditor.targetArea.redo()});$onchange("bg",function(h){var d=$$("bg");if(d){Cookie.set("bg",d.value,10)}EqEditor.update()});$onchange("dpi",function(h){var j=$$("dpi");if(j){Cookie.set("dpi",j.value,10)}EqEditor.update()});$onchange("font",function(h){var d=$$("font");if(d){Cookie.set("font",d.value,10)}EqEditor.update()});$onchange("format",function(h){var d=false;EqEditor.setFormat(EqEditor.getFormat())});$onchange("fontsize",function(){var d=$$("fontsize");if(d){Cookie.set("fontsize",d.value,10)}EqEditor.update()});$onclick("inline",function(h){var d=$$("compressed");if(d){d.checked=this.checked}EqEditor.update()});$onclick("compressed",function(d){EqEditor.update()})},textchanged:function(){if(this.targetArea.textchanged()){ExportButton.state(true)}},update:function(){this.targetArea.textchanged();this.targetArea.renderEqn(null)},load:function(a){if(this.targetArea!=null){this.targetArea.load(a)}},insert:function(a,c,b){if(this.targetArea!=null){this.targetArea.insertText(a,c,b);ExportButton.state(true)}},cleartext:function(){this.targetArea.cleartext();ExportButton.state(false)},setFormat:function(c){EqEditor.format=c;switch(c){case"gif":action=false;break;case"png":action=false;break;case"pdf":action=true;break;case"swf":action=true;break;case"emf":action=true;break}Cookie.set("format",c,10);var b=$$("dpi");if(b){b.disabled=action;b.readonly=action}b=$$("bg");if(b){b.disabled=action;b.readonly=action}EqEditor.targetArea.changed=true;EqEditor.targetArea.renderEqn(null)},getEquation:function(){if(this.targetArea!=null){return this.targetArea.getEquationStr()}},getFormat:function(){var b=$$("format");if(b){return b.value}return EqEditor.format},getFont:function(){var b=$$("font");if(b&&b.value!=""){return"\\fn_"+b.value+" "}return""},getSize:function(){var b=$$("fontsize");if(b&&b.value!=""){return b.value+" "}return""},getDPI:function(){var b=$$("dpi");if(b&&b.value!="110"){return"\\dpi{"+b.value+"} "}return""},getBG:function(){var d=$$("bg");if(d){var c=d.value.toLowerCase();if(c!="transparent"){return"\\bg_"+c+" "}}return""},getCompressed:function(){var b=$$("compressed");if(b&&b.checked){return"\\inline "}return""},get_inline_wrap:function(h,f,g){var d=$$("inline");if(d){var c=$$("compressed");if(d.checked){if(!c.checked){h="\\displaystyle "+h}return g.replace("{$TEXT}",h)}else{if(c.checked){h="\\inline "+h}return f.replace("{$TEXT}",h)}}return f.replace("{$TEXT}",h)},extendchar:null,countclick:function(){this.targetArea.countclick();var b=$$("redobutton");if(b){b.src=EDITOR_SRC+"/images/buttons/redo-x.gif"}b=$$("undobutton");if(b){b.src=EDITOR_SRC+"/images/buttons/undo.gif"}},tabHandler:function(h){var g=9;var k=this.targetArea.equation_input;if(h.keyCode==g){if(document.selection){var f=document.selection.createRange();i=k.value.length+1;var d=f.duplicate();while(d.parentElement()==k&&d.move("character",1)==1){--i}startPos=i;if(startPos==k.value.length){return true}}else{startPos=k.selectionStart;if(startPos==k.value.length){return true}}var p=k.value.indexOf("{",startPos);if(p==-1){p=k.value.length}else{p++}var o=k.value.indexOf("&",startPos);if(o==-1){o=k.value.length}else{o++}var j=k.value.indexOf("\\\\",startPos);if(j==-1){j=k.value.length}else{j+=2}var l=Math.min(Math.min(p,o),j);if(document.selection){range=k.createTextRange();range.collapse(true);l-=k.value.substr(0,l).split("\n").length-1;range.moveEnd("character",l);range.moveStart("character",l);range.select()}else{k.setSelectionRange(l,l)}if(h.preventDefault){h.preventDefault()}else{h.returnValue=false}return false}},backCursor:function(a){if(document.selection){a.focus();sel=document.selection.createRange();if(sel.text.length>0){sel.text=""}else{sel.moveEnd("character",1);sel.text=""}sel.select()}else{if(a.selectionStart||a.selectionStart=="0"){s=a.selectionStart;e=a.selectionEnd;a.value=a.value.substring(0,s)+a.value.substring(e+1,a.value.length);a.selectionStart=s;a.selectionEnd=s;a.focus()}}},extendkey:function(a){switch(this.key_text){case"\\left":this.insert(" \\right "+a,0);break;case"\\frac":case"\\tfrac":if(a=="}"){this.insert("}{}",0)}break;case"\\begin":if(a=="}"){this.insert("} \\end{}",0)}break;default:this.insert(a,0)}this.extendchar=a},keyHandler:function(c){var a;if(window.event){a=window.event.keyCode}else{if(c){a=c.which}}var b=String.fromCharCode(a);if(b==this.extendchar){this.backCursor(this.equation_input)}this.extendchar=null;switch(b){case"{":this.extendkey("}");break;case"[":this.extendkey("]");break;case"(":this.extendkey(")");break;case'"':this.extendkey('"');break}if(b!=" "){if(b=="\\"){this.key_text="\\"}else{if(!b.match(/^[a-zA-Z]$/)){this.key_text=""}else{this.key_text+=b}}}},addText:function(c,b,a){var g=c.getElementById(b);if(c.selection){g.focus();sel=c.selection.createRange();sel.text=a}else{var h=g.scrollTop;if(g.selectionStart||g.selectionStart=="0"){var f=g.selectionStart;var d=g.selectionEnd;var j=f+a.length;g.value=g.value.substring(0,f)+a+g.value.substring(d,g.value.length);pos=a.length+d-f;g.selectionStart=j;g.selectionEnd=j;g.focus();g.setSelectionRange(f+pos,f+pos)}else{g.value+=a}g.scrollTop=h}},makeEquationsMatrix:function(a,c,b){if(c===undefined){c=false}if(b===undefined){c=false}eqns="\\begin{"+a+((c)?"":"*")+"}";eqi="\n &"+((c)?" ":"= ")+((b)?"\\text{ if } x= ":"");eqEnd="\n\\end{"+a+((c)?"":"*")+"}";i=0;dim=prompt("Enter the number of lines:","");if(dim!=""&&dim!==null){n=parseInt(dim);if(!isNaN(n)){for(i=1;i<=n-1;i++){eqns=eqns+(eqi+"\\\\ ")}eqns=(eqns+eqi)+eqEnd;this.insert(eqns,a.length+((c)?0:1)+9)}}},makeArrayMatrix:function(d,j,a){var f=j+"\\begin{"+d+"matrix}";var h="\n";var c="\n\\end{"+d+"matrix}"+a;var b=0;var g=prompt('Enter the array dimensions separated by a comma (e.g. "2,3" for 2 rows and 3 columns):',"");if(g!==""&&g!==null){g=g.split(",");m=parseInt(g[0]);n=parseInt(g[1]);if(!isNaN(m)&&!isNaN(n)){for(b=2;b<=n;b++){h=h+" & "}for(b=1;b<=m-1;b++){f=f+h+"\\\\ "}f=f+h+c;this.insert(f,d.length+j.length+15)}}},resize:function(b){var a,c;if(self.innerHeight){c=self.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){c=document.documentElement.clientHeight}else{if(document.body){c=document.body.clientHeight}}}this.targetArray[b].equation_input.style.height=parseInt(Math.max((c-200)/3,40))+"px"}};var oDiv=document.createElement("div");var oImg=document.createElement("img");var Scroll=function(){};Scroll.prototype={init:function(d,a,c,g,b){this.panels=0;this.maxpanels=0;this.speed=10;this.pause=2;this.visible=0;this.visible_num=2;this.layers=new Array();this.layers_offset=new Array();this.new_offset=0;this.subtext="";this.vertical=false;this.left_arrow=document.getElementById(a);this.right_arrow=document.getElementById(c);this.maindiv=document.getElementById(d);if(g!==""){this.overview=document.getElementById(g)}else{this.overview=null}if(b.indexOf("_json")>-1){this.ajax_php=null;this.json_php=b;this.ajax_response_fn=null}else{this.ajax_php=b;this.json_php=null;var f=this;this.ajax_response_fn=function(){f.add_panel_response()}}},set_subtext:function(a){this.subtext=a},set_width:function(b,a,c){this.width=b;this.height=a;this.speed=c;if(this.vertical){this.step=this.step_total=this.height/this.speed}else{this.step=this.step_total=this.width/this.speed}},add:function(a){var b=this.new_offset;if(this.vertical){this.new_offset+=this.height}else{this.new_offset+=this.width}this.layers[this.panels]=a;this.layers_offset[this.panels]=b;this.panels++;if(this.panels>this.maxpanels){this.maxpanels=this.panels}a.style.position="absolute";if(this.vertical){a.style.top=b+"px"}else{a.style.left=b+"px"}},add_id:function(b){var a=document.getElementById(b);if(a){this.add(a)}},add_panel_div:function(a){this.add(a);this.maindiv.appendChild(a);if(this.visible+this.visible_num>=this.panels){this.add_panel()}},add_panel_response:function(){if(req.readyState==4){if(req.status==200&&req.responseText.length>0){var a=oDiv.cloneNode(false);a.innerHTML=req.responseText;this.add_panel_div(a)}this.setarrow();this.setoverview()}},add_panel_json:function(b){if(b.length>0){var a=oDiv.cloneNode(false);a.innerHTML=b;this.add_panel_div(a)}this.setarrow();this.setoverview()},add_panel:function(){if(this.ajax_php&&this.ajax_response_fn){if(this.ajax_php.indexOf("?")==-1){loadXMLDoc(this.ajax_php+"?panel="+this.panels+this.subtext,this.ajax_response_fn)}else{loadXMLDoc(this.ajax_php+"&panel="+this.panels+this.subtext,this.ajax_response_fn)}}else{if(this.json_php){var b=this.panels;var d=document.getElementsByTagName("head")[0];var c=document.createElement("script");if(this.json_php.indexOf("?")==-1){c.src=this.json_php+"?panel="+b+this.subtext}else{c.src=this.json_php+"&panel="+b+this.subtext}d.appendChild(c)}}},redraw:function(){if(this.json_php||(this.ajax_php&&this.ajax_response_fn)){this.panels=0;this.visible=0;this.new_offset=0;while(this.maindiv.firstChild){this.maindiv.removeChild(this.maindiv.firstChild)}}if(this.ajax_php&&this.ajax_response_fn){var f=this;if(this.ajax_php.indexOf("?")==-1){loadXMLDoc(f.ajax_php+"?panel="+this.panels+this.subtext,f.ajax_response_fn)}else{loadXMLDoc(f.ajax_php+"&panel="+this.panels+this.subtext,f.ajax_response_fn)}}else{if(this.json_php){var b=this.panels;var d=document.getElementsByTagName("head")[0];var c=document.createElement("script");if(this.json_php.indexOf("?")==-1){c.src=this.json_php+"?panel="+b+this.subtext}else{c.src=this.json_php+"&panel="+b+this.subtext}d.appendChild(c)}}},move:function(a){this.new_offset+=a;for(var c=0;c<this.panels;c++){this.layers_offset[c]+=a;if(this.vertical){this.layers[c].style.top=this.layers_offset[c]+"px"}else{this.layers[c].style.left=this.layers_offset[c]+"px"}}this.step++;if(this.step<this.step_total){var b=this;window.setTimeout(function(){b.move(a)},this.pause)}},setoverview:function(){if(this.overview!==null){this.overview.innerHTML="";var a="";var b=this;for(i=0;i<this.maxpanels;i++){newimg=oImg.cloneNode(false);newimg.className="overview";if(i>=this.visible&&i<(this.visible+this.visible_num)){newimg.src="http://www.codecogs.com/images/scroll/soliddot.gif"}else{newimg.src="http://www.codecogs.com/images/scroll/emptydot.gif";newimg.i=i;newimg.onclick=function(){b.jump(this)}}this.overview.appendChild(newimg)}}},setarrow:function(){this.left_arrow.src="http://www.codecogs.com/images/scroll/"+(this.visible<=0?"leftarrow_grey.gif":"leftarrow.gif");this.right_arrow.src="http://www.codecogs.com/images/scroll/"+(this.visible>=(this.panels-1)?"rightarrow_grey.gif":"rightarrow.gif")},jump:function(a){if(this.step==this.step_total){panel=a.i;var b=panel-this.visible;this.step=this.step_total-Math.abs(b)*this.step_total;if(this.visible>panel){this.move(this.speed)}else{this.move(-this.speed)}this.visible+=b;if(this.visible+this.visible_num>=this.panels){this.add_panel()}else{this.setarrow();this.setoverview()}}},left:function(){if(this.step==this.step_total){if(this.visible<(this.panels-1)){this.visible++;this.step=0;this.move(-this.speed);if(this.visible+this.visible_num>=this.panels){this.add_panel()}else{this.setarrow();this.setoverview()}}}},right:function(){if(this.step==this.step_total){if(this.visible>0){this.step=0;this.move(this.speed);this.visible--;this.setarrow();this.setoverview()}}},subsearch:function(a){if(a!==""){this.subtext=("&subtext="+a)}else{this.subtext=""}this.redraw()}};
function refreshLatexPreview(n){var t=$("#latexTextArea").val();return!n&&tinymce.latexSearchCache==t?!1:t.trim().length==0?($("#latexRenderWrapper").html(""),!1):(tinymce.latexSearchCache=t,$("#latexPreviewRender").text("$$"+t+"$$"),MathJax.Hub.Queue(["Typeset",MathJax.Hub,$("#latexPreviewRender")[0]]),!0)}function encodeImageSrc(n,t){return(n=n.replace(/&lt;/g,"<"),n=n.replace(/&gt;/g,">"),n=n.replace(/&amp;/g,"&"),n=n.replace(/&quot;/g,'"'),n=n.replace(/<br\s*[\/]?>>/gi,"\n"),t)?encodeURIComponent(n):n}function editSelectedLatex(){var n=tinyMCE.activeEditor;n.execCommand("equationCommand")}function addLatexToEditor(){var n=$("#latexTextArea").val(),r=n,t,i;return n.length==0?!1:(n=n.replace(/&lt;/g,"<"),n=n.replace(/&gt;/g,">"),n=n.replace(/&amp;/g,"&"),n=n.replace(/&quot;/g,'"'),n=n.replace(/\n$/,"<br/>&nbsp;"),n=n.replace(/\n/g,"<br/>"),t=r.replace(/>/g,"&#62;"),t=t.replace(/</g,"&#60;"),t=t.replace(/"/g,"&#34;"),t=t.replace(/'/g,"&#39;"),i="<latex class='piazza-latex-edit' ondblclick='window.parent.editSelectedLatex()'>"+n+"<\/latex>",$("#latexTextArea").val(""),$.fancybox.close(),tinymce.activeEditor.focus(),typeof actualCaretPositionBookmark!="undefined"&&actualCaretPositionBookmark&&tinymce.activeEditor.selection.moveToBookmark(actualCaretPositionBookmark),curSelectedLaTeX?curSelectedLaTeX.remove():i="$$"+i+"$$",tinyMCE.activeEditor.execCommand("mceInsertContent",!1,i),!1)}function cancelLatex(){return $("#latexTextArea").val(""),$.fancybox.close(),!1}function doPostPreview(n,t,i,r){var u=null,o="",s,e,f;if(n?(u=n.getContent(),r="note",n.id=="rich_old_new_post"&&P.old_new_post.type=="poll"&&(r="poll")):(u=$("#rich_"+i).val(),i=="old_new_post"&&P.old_new_post.type=="poll"&&(r="poll")),r=="poll")for(s="[o]",$("#selections_allowed_more").is(":checked")&&(s="[*]"),e=P.old_new_post.pollChoices,f=0;f<e.length;f++)e[f].length>0&&(u+="<br/>"+s+" "+e[f]);return u=PEM.callFirst("convertToLatex",u),o=n?PEM.callFirst("makeHtml",{text:u,isNew:!0,isEditorPreview:!0,type:r}):PEM.callFirst("makeHtml",{text:u,type:r}),o&&(u=o),$("#preview_post_modal_body").html(u),$("#preview_post_modal").modal("show"),typeof MathJax!="undefined"&&MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,$("#preview_post_modal_body")[0]]),!1}(function(n,t){"use strict";function u(n,t){for(var u,e=[],i=0;i<n.length;++i){if(u=r[n[i]]||f(n[i]),!u)throw"module definition dependecy not found: "+n[i];e.push(u)}t.apply(null,e)}function i(n,i,f){if(typeof n!="string")throw"invalid module definition, module id must be defined and be a string";if(i===t)throw"invalid module definition, dependencies must be specified";if(f===t)throw"invalid module definition, definition function must be specified";u(i,function(){r[n]=f.apply(null,arguments)})}function f(t){for(var r=n,u=t.split(/[.\/]/),i=0;i<u.length;++i){if(!r[u[i]])return;r=r[u[i]]}return r}function e(i){for(var f,o=0;o<i.length;o++){var e=n,s=i[o],u=s.split(/[.\/]/);for(f=0;f<u.length-1;++f)e[u[f]]===t&&(e[u[f]]={}),e=e[u[f]];e[u[u.length-1]]=r[s]}}var r={};i("tinymce/dom/EventUtils",[],function(){function t(n,t,i,r){n.addEventListener?n.addEventListener(t,i,r||!1):n.attachEvent&&n.attachEvent("on"+t,i)}function r(n,t,i,r){n.removeEventListener?n.removeEventListener(t,i,r||!1):n.detachEvent&&n.detachEvent("on"+t,i)}function n(n,t){function s(){return!1}function h(){return!0}var o,i=t||{},c;for(o in n)e[o]||(i[o]=n[o]);if(i.target||(i.target=i.srcElement||document),n&&f.test(n.type)&&n.pageX===c&&n.clientX!==c){var l=i.target.ownerDocument||document,r=l.documentElement,u=l.body;i.pageX=n.clientX+(r&&r.scrollLeft||u&&u.scrollLeft||0)-(r&&r.clientLeft||u&&u.clientLeft||0),i.pageY=n.clientY+(r&&r.scrollTop||u&&u.scrollTop||0)-(r&&r.clientTop||u&&u.clientTop||0)}return i.preventDefault=function(){i.isDefaultPrevented=h,n&&(n.preventDefault?n.preventDefault():n.returnValue=!1)},i.stopPropagation=function(){i.isPropagationStopped=h,n&&(n.stopPropagation?n.stopPropagation():n.cancelBubble=!0)},i.stopImmediatePropagation=function(){i.isImmediatePropagationStopped=h,i.stopPropagation()},i.isDefaultPrevented||(i.isDefaultPrevented=s,i.isPropagationStopped=s,i.isImmediatePropagationStopped=s),i}function o(n,i,u){function e(){u.domLoaded||(u.domLoaded=!0,i(o))}function s(){(f.readyState==="complete"||f.readyState==="interactive")&&(r(f,"readystatechange",s),e())}function h(){try{f.documentElement.doScroll("left")}catch(n){setTimeout(h,0);return}e()}var f=n.document,o={type:"ready"};if(u.domLoaded){i(o);return}f.addEventListener?f.readyState==="complete"?e():t(n,"DOMContentLoaded",e):(t(f,"readystatechange",s),f.documentElement.doScroll&&n.self===n.top&&h()),t(n,"load",e)}function i(){function s(n,t){var i,r,f,u,o=e[t];if(i=o&&o[n.type],i)for(r=0,f=i.length;r<f;r++)if(u=i[r],u&&u.func.call(u.scope,n)===!1&&n.preventDefault(),n.isImmediatePropagationStopped())return}var i=this,e={},h,f,c,l,a;f=u+(+new Date).toString(32),l="onmouseenter"in document.documentElement,c="onfocusin"in document.documentElement,a={mouseenter:"mouseover",mouseleave:"mouseout"},h=1,i.domLoaded=!1,i.events=e,i.bind=function(r,u,v,y){function it(t){s(n(t||tt.event),w)}var w,b,nt,p,k,d,g,tt=window;if(r&&r.nodeType!==3&&r.nodeType!==8){for(r[f]?w=r[f]:(w=h++,r[f]=w,e[w]={}),y=y||r,u=u.split(" "),nt=u.length;nt--;){if(p=u[nt],d=it,k=g=!1,p==="DOMContentLoaded"&&(p="ready"),i.domLoaded&&p==="ready"&&r.readyState=="complete"){v.call(y,n({type:p}));continue}l||(k=a[p],k&&(d=function(t){var r,i;if(r=t.currentTarget,i=t.relatedTarget,i&&r.contains)i=r.contains(i);else while(i&&i!==r)i=i.parentNode;i||(t=n(t||tt.event),t.type=t.type==="mouseout"?"mouseleave":"mouseenter",t.target=r,s(t,w))})),c||p!=="focusin"&&p!=="focusout"||(g=!0,k=p==="focusin"?"focus":"blur",d=function(t){t=n(t||tt.event),t.type=t.type==="focus"?"focusin":"focusout",s(t,w)}),b=e[w][p],b?p==="ready"&&i.domLoaded?v({type:p}):b.push({func:v,scope:y}):(e[w][p]=b=[{func:v,scope:y}],b.fakeName=k,b.capture=g,b.nativeHandler=d,p==="ready"?o(r,d,i):t(r,k||p,d,g))}return r=b=0,v}},i.unbind=function(n,t,u){var l,o,a,c,s,h,v;if(!n||n.nodeType===3||n.nodeType===8)return i;if(l=n[f],l){if(h=e[l],t){for(t=t.split(" "),a=t.length;a--;)if(s=t[a],o=h[s],o){if(u)for(c=o.length;c--;)o[c].func===u&&(v=o.nativeHandler,o=o.slice(0,c).concat(o.slice(c+1)),o.nativeHandler=v,h[s]=o);u&&o.length!==0||(delete h[s],r(n,o.fakeName||s,o.nativeHandler,o.capture))}}else{for(s in h)o=h[s],r(n,o.fakeName||s,o.nativeHandler,o.capture);h={}}for(s in h)return i;delete e[l];try{delete n[f]}catch(y){n[f]=null}}return i},i.fire=function(t,r,u){var e;if(!t||t.nodeType===3||t.nodeType===8)return i;u=n(null,u),u.type=r,u.target=t;do e=t[f],e&&s(u,e),t=t.parentNode||t.ownerDocument||t.defaultView||t.parentWindow;while(t&&!u.isPropagationStopped());return i},i.clean=function(n){var t,r,u=i.unbind;if(!n||n.nodeType===3||n.nodeType===8)return i;if(n[f]&&u(n),n.getElementsByTagName||(n=n.document),n&&n.getElementsByTagName)for(u(n),r=n.getElementsByTagName("*"),t=r.length;t--;)n=r[t],n[f]&&u(n);return i},i.destroy=function(){e={}},i.cancel=function(n){return n&&(n.preventDefault(),n.stopImmediatePropagation()),!1}}var u="mce-data-",f=/^(?:mouse|contextmenu)|click/,e={keyLocation:1,layerX:1,layerY:1,returnValue:1};return i.Event=new i,i.Event.bind(window,"ready",function(){}),i}),i("tinymce/dom/Sizzle",[],function(){function gt(n){return ir.test(n+"")}function ni(){var t,i=[];return t=function(r,u){return i.push(r+=" ")>n.cacheLength&&delete t[i.shift()],t[r]=u,u}}function h(n){return n[i]=!0,n}function y(n){var t=e.createElement("div");try{return!!n(t)}catch(i){return!1}finally{t=null}}function r(n,t,r,f){var p,o,h,v,b,y,k,a,g,d;if((t?t.ownerDocument||t:l)!==e&&it(t),t=t||e,r=r||[],!n||typeof n!="string")return r;if((v=t.nodeType)!==1&&v!==9)return[];if(s&&!f){if(p=rr.exec(n))if(h=p[1]){if(v===9)if(o=t.getElementById(h),o&&o.parentNode){if(o.id===h)return r.push(o),r}else return r;else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(h))&&rt(t,o)&&o.id===h)return r.push(o),r}else{if(p[2])return w.apply(r,t.getElementsByTagName(n)),r;if((h=p[3])&&u.getElementsByClassName&&t.getElementsByClassName)return w.apply(r,t.getElementsByClassName(h)),r}if(u.qsa&&!c.test(n)){if(k=!0,a=i,g=t,d=v===9&&n,v===1&&t.nodeName.toLowerCase()!=="object"){for(y=yt(n),(k=t.getAttribute("id"))?a=k.replace(er,"\\$&"):t.setAttribute("id",a),a="[id='"+a+"'] ",b=y.length;b--;)y[b]=a+pt(y[b]);g=dt.test(n)&&t.parentNode||t,d=y.join(",")}if(d)try{return w.apply(r,g.querySelectorAll(d)),r}catch(nt){}finally{k||t.removeAttribute("id")}}}return ar(n.replace(at,"$1"),t,r,f)}function yi(n,t){var i=t&&n,r=i&&(~t.sourceIndex||ci)-(~n.sourceIndex||ci);if(r)return r;if(i)while(i=i.nextSibling)if(i===t)return-1;return n?1:-1}function sr(n){return function(t){var i=t.nodeName.toLowerCase();return i==="input"&&t.type===n}}function hr(n){return function(t){var i=t.nodeName.toLowerCase();return(i==="input"||i==="button")&&t.type===n}}function nt(n){return h(function(t){return t=+t,h(function(i,r){for(var u,f=n([],i.length,t),e=f.length;e--;)i[u=f[e]]&&(i[u]=!(r[u]=i[u]))})})}function yt(t,i){var e,f,s,o,u,h,c,l=si[t+" "];if(l)return i?0:l.slice(0);for(u=t,h=[],c=n.preFilter;u;){(!e||(f=di.exec(u)))&&(f&&(u=u.slice(f[0].length)||u),h.push(s=[])),e=!1,(f=gi.exec(u))&&(e=f.shift(),s.push({value:e,type:f[0].replace(at," ")}),u=u.slice(e.length));for(o in n.filter)(f=vt[o].exec(u))&&(!c[o]||(f=c[o](f)))&&(e=f.shift(),s.push({value:e,type:o,matches:f}),u=u.slice(e.length));if(!e)break}return i?u.length:u?r.error(t):si(t,h).slice(0)}function pt(n){for(var t=0,r=n.length,i="";t<r;t++)i+=n[t].value;return i}function ti(n,t,r){var u=t.dir,f=r&&u==="parentNode",e=wi++;return t.first?function(t,i,r){while(t=t[u])if(t.nodeType===1||f)return n(t,i,r)}:function(t,r,o){var h,s,c,l=a+" "+e;if(o){while(t=t[u])if((t.nodeType===1||f)&&n(t,r,o))return!0}else while(t=t[u])if(t.nodeType===1||f)if(c=t[i]||(t[i]={}),(s=c[u])&&s[0]===l){if((h=s[1])===!0||h===et)return h===!0}else if(s=c[u]=[l],s[1]=n(t,r,o)||et,s[1]===!0)return!0}}function ii(n){return n.length>1?function(t,i,r){for(var u=n.length;u--;)if(!n[u](t,i,r))return!1;return!0}:n[0]}function wt(n,t,i,r,u){for(var e,o=[],f=0,s=n.length,h=t!=null;f<s;f++)(e=n[f])&&(!i||i(e,r,u))&&(o.push(e),h&&t.push(f));return o}function ri(n,t,r,u,f,e){return u&&!u[i]&&(u=ri(u)),f&&!f[i]&&(f=ri(f,e)),h(function(i,e,o,s){var l,c,a,p=[],y=[],b=e.length,k=i||lr(t||"*",o.nodeType?[o]:o,[]),v=n&&(i||!t)?wt(k,p,n,o,s):k,h=r?f||(i?n:b||u)?[]:e:v;if(r&&r(v,h,o,s),u)for(l=wt(h,y),u(l,[],o,s),c=l.length;c--;)(a=l[c])&&(h[y[c]]=!(v[y[c]]=a));if(i){if(f||n){if(f){for(l=[],c=h.length;c--;)(a=h[c])&&l.push(v[c]=a);f(null,h=[],l,s)}for(c=h.length;c--;)(a=h[c])&&(l=f?ft.call(i,a):p[c])>-1&&(i[l]=!(e[l]=a))}}else h=wt(h===e?h.splice(b,h.length):h),f?f(null,e,h,s):w.apply(e,h)})}function ui(t){for(var s,f,u,o=t.length,h=n.relative[t[0].type],c=h||n.relative[" "],r=h?1:0,l=ti(function(n){return n===s},c,!0),a=ti(function(n){return ft.call(s,n)>-1},c,!0),e=[function(n,t,i){return!h&&(i||t!==st)||((s=t).nodeType?l(n,t,i):a(n,t,i))}];r<o;r++)if(f=n.relative[t[r].type])e=[ti(ii(e),f)];else{if(f=n.filter[t[r].type].apply(null,t[r].matches),f[i]){for(u=++r;u<o;u++)if(n.relative[t[u].type])break;return ri(r>1&&ii(e),r>1&&pt(t.slice(0,r-1)).replace(at,"$1"),f,r<u&&ui(t.slice(r,u)),u<o&&ui(t=t.slice(u)),u<o&&pt(t))}e.push(f)}return ii(e)}function cr(t,i){var f=0,u=i.length>0,o=t.length>0,s=function(s,h,c,l,v){var p,g,k,b=[],d=0,y="0",nt=s&&[],tt=v!=null,it=st,ut=s||o&&n.find.TAG("*",v&&h.parentNode||h),rt=a+=it==null?1:Math.random()||.1;for(tt&&(st=h!==e&&h,et=f);(p=ut[y])!=null;y++){if(o&&p){for(g=0;k=t[g++];)if(k(p,h,c)){l.push(p);break}tt&&(a=rt,et=++f)}u&&((p=!k&&p)&&d--,s&&nt.push(p))}if(d+=y,u&&y!==d){for(g=0;k=i[g++];)k(nt,b,h,c);if(s){if(d>0)while(y--)nt[y]||b[y]||(b[y]=bi.call(l));b=wt(b)}w.apply(l,b),tt&&!s&&b.length>0&&d+i.length>1&&r.uniqueSort(l)}return tt&&(a=rt,st=it),nt};return u?h(s):s}function lr(n,t,i){for(var u=0,f=t.length;u<f;u++)r(n,t[u],i);return i}function ar(t,i,r,u){var o,f,e,c,l,h=yt(t);if(!u&&h.length===1){if(f=h[0]=h[0].slice(0),f.length>2&&(e=f[0]).type==="ID"&&i.nodeType===9&&s&&n.relative[f[1].type]){if(i=(n.find.ID(e.matches[0].replace(b,k),i)||[])[0],!i)return r;t=t.slice(f.shift().value.length)}for(o=vt.needsContext.test(t)?0:f.length;o--;){if(e=f[o],n.relative[c=e.type])break;if((l=n.find[c])&&(u=l(e.matches[0].replace(b,k),dt.test(f[0].type)&&i.parentNode||i))){if(f.splice(o,1),t=u.length&&pt(f),!t)return w.apply(r,u),r;break}}}return bt(t,h)(u,i,!s,r,dt.test(t)),r}function pi(){}var tt,et,n,ot,fi,bt,st,ei,ht,it,e,o,s,c,d,ct,rt,i="sizzle"+-new Date,l=window.document,u={},a=0,wi=0,oi=ni(),si=ni(),hi=ni(),ut=!1,lt=function(){return 0},v=typeof t,ci=-2147483648,p=[],bi=p.pop,ki=p.push,w=p.push,li=p.slice,ft=p.indexOf||function(n){for(var t=0,i=this.length;t<i;t++)if(this[t]===n)return t;return-1},f="[\\x20\\t\\r\\n\\f]",g="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",ai=g.replace("w","w#"),vi="\\["+f+"*("+g+")"+f+"*(?:([*^$|!~]?=)"+f+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+ai+")|)|)"+f+"*\\]",kt=":("+g+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+vi.replace(3,8)+")*)|.*)\\)|)",at=new RegExp("^"+f+"+|((?:^|[^\\\\])(?:\\\\.)*)"+f+"+$","g"),di=new RegExp("^"+f+"*,"+f+"*"),gi=new RegExp("^"+f+"*([\\x20\\t\\r\\n\\f>+~])"+f+"*"),nr=new RegExp(kt),tr=new RegExp("^"+ai+"$"),vt={ID:new RegExp("^#("+g+")"),CLASS:new RegExp("^\\.("+g+")"),NAME:new RegExp("^\\[name=['\"]?("+g+")['\"]?\\]"),TAG:new RegExp("^("+g.replace("w","w*")+")"),ATTR:new RegExp("^"+vi),PSEUDO:new RegExp("^"+kt),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+f+"*(even|odd|(([+-]|)(\\d*)n|)"+f+"*(?:([+-]|)"+f+"*(\\d+)|))"+f+"*\\)|)","i"),needsContext:new RegExp("^"+f+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+f+"*((?:-\\d)?\\d*)"+f+"*\\)|)(?=[^-]|$)","i")},dt=/[\x20\t\r\n\f]*[+~]/,ir=/^[^{]+\{\s*\[native code/,rr=/^(?:#([\w\-]+)|(\w+)|\.([\w\-]+))$/,ur=/^(?:input|select|textarea|button)$/i,fr=/^h\d$/i,er=/'|\\/g,or=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,b=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,k=function(n,t){var i="0x"+t-65536;return i!==i?t:i<0?String.fromCharCode(i+65536):String.fromCharCode(i>>10|55296,i&1023|56320)};try{w.apply(p=li.call(l.childNodes),l.childNodes),p[l.childNodes.length].nodeType}catch(vr){w={apply:p.length?function(n,t){ki.apply(n,li.call(t))}:function(n,t){for(var i=n.length,r=0;n[i++]=t[r++];);n.length=i-1}}}fi=r.isXML=function(n){var t=n&&(n.ownerDocument||n).documentElement;return t?t.nodeName!=="HTML":!1},it=r.setDocument=function(r){var h=r?r.ownerDocument||r:l;return h===e||h.nodeType!==9||!h.documentElement?e:(e=h,o=h.documentElement,s=!fi(h),u.getElementsByTagName=y(function(n){return n.appendChild(h.createComment("")),!n.getElementsByTagName("*").length}),u.attributes=y(function(n){n.innerHTML="<select><\/select>";var t=typeof n.lastChild.getAttribute("multiple");return t!=="boolean"&&t!=="string"}),u.getElementsByClassName=y(function(n){return(n.innerHTML="<div class='hidden e'><\/div><div class='hidden'><\/div>",!n.getElementsByClassName||!n.getElementsByClassName("e").length)?!1:(n.lastChild.className="e",n.getElementsByClassName("e").length===2)}),u.getByName=y(function(n){n.id=i+0,n.appendChild(e.createElement("a")).setAttribute("name",i),n.appendChild(e.createElement("i")).setAttribute("name",i),o.appendChild(n);var t=h.getElementsByName&&h.getElementsByName(i).length===2+h.getElementsByName(i+0).length;return o.removeChild(n),t}),u.sortDetached=y(function(n){return n.compareDocumentPosition&&n.compareDocumentPosition(e.createElement("div"))&1}),n.attrHandle=y(function(n){return n.innerHTML="<a href='#'><\/a>",n.firstChild&&typeof n.firstChild.getAttribute!==v&&n.firstChild.getAttribute("href")==="#"})?{}:{href:function(n){return n.getAttribute("href",2)},type:function(n){return n.getAttribute("type")}},u.getByName?(n.find.ID=function(n,t){if(typeof t.getElementById!==v&&s){var i=t.getElementById(n);return i&&i.parentNode?[i]:[]}},n.filter.ID=function(n){var t=n.replace(b,k);return function(n){return n.getAttribute("id")===t}}):(n.find.ID=function(n,i){if(typeof i.getElementById!==v&&s){var r=i.getElementById(n);return r?r.id===n||typeof r.getAttributeNode!==v&&r.getAttributeNode("id").value===n?[r]:t:[]}},n.filter.ID=function(n){var t=n.replace(b,k);return function(n){var i=typeof n.getAttributeNode!==v&&n.getAttributeNode("id");return i&&i.value===t}}),n.find.TAG=u.getElementsByTagName?function(n,t){if(typeof t.getElementsByTagName!==v)return t.getElementsByTagName(n)}:function(n,t){var i,r=[],f=0,u=t.getElementsByTagName(n);if(n==="*"){while(i=u[f++])i.nodeType===1&&r.push(i);return r}return u},n.find.NAME=u.getByName&&function(n,t){if(typeof t.getElementsByName!==v)return t.getElementsByName(name)},n.find.CLASS=u.getElementsByClassName&&function(n,t){if(typeof t.getElementsByClassName!==v&&s)return t.getElementsByClassName(n)},d=[],c=[":focus"],(u.qsa=gt(h.querySelectorAll))&&(y(function(n){n.innerHTML="<select><option selected=''><\/option><\/select>",n.querySelectorAll("[selected]").length||c.push("\\["+f+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),n.querySelectorAll(":checked").length||c.push(":checked")}),y(function(n){n.innerHTML="<input type='hidden' i=''/>",n.querySelectorAll("[i^='']").length&&c.push("[*^$]="+f+"*(?:\"\"|'')"),n.querySelectorAll(":enabled").length||c.push(":enabled",":disabled"),n.querySelectorAll("*,:x"),c.push(",.*:")})),(u.matchesSelector=gt(ct=o.matchesSelector||o.mozMatchesSelector||o.webkitMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&y(function(n){u.disconnectedMatch=ct.call(n,"div"),ct.call(n,"[s!='']:x"),d.push("!=",kt)}),c=new RegExp(c.join("|")),d=d.length&&new RegExp(d.join("|")),rt=gt(o.contains)||o.compareDocumentPosition?function(n,t){var r=n.nodeType===9?n.documentElement:n,i=t&&t.parentNode;return n===i||!!(i&&i.nodeType===1&&(r.contains?r.contains(i):n.compareDocumentPosition&&n.compareDocumentPosition(i)&16))}:function(n,t){if(t)while(t=t.parentNode)if(t===n)return!0;return!1},lt=o.compareDocumentPosition?function(n,t){if(n===t)return ut=!0,0;var i=t.compareDocumentPosition&&n.compareDocumentPosition&&n.compareDocumentPosition(t);return i?i&1||ei&&t.compareDocumentPosition(n)===i?n===h||rt(l,n)?-1:t===h||rt(l,t)?1:ht?ft.call(ht,n)-ft.call(ht,t):0:i&4?-1:1:n.compareDocumentPosition?-1:1}:function(n,t){var i,r=0,e=n.parentNode,o=t.parentNode,u=[n],f=[t];if(n===t)return ut=!0,0;if(e&&o){if(e===o)return yi(n,t)}else return n===h?-1:t===h?1:e?-1:o?1:0;for(i=n;i=i.parentNode;)u.unshift(i);for(i=t;i=i.parentNode;)f.unshift(i);while(u[r]===f[r])r++;return r?yi(u[r],f[r]):u[r]===l?-1:f[r]===l?1:0},e)},r.matches=function(n,t){return r(n,null,null,t)},r.matchesSelector=function(n,t){if((n.ownerDocument||n)!==e&&it(n),t=t.replace(or,"='$1']"),u.matchesSelector&&s&&(!d||!d.test(t))&&!c.test(t))try{var i=ct.call(n,t);if(i||u.disconnectedMatch||n.document&&n.document.nodeType!==11)return i}catch(f){}return r(t,e,null,[n]).length>0},r.contains=function(n,t){return(n.ownerDocument||n)!==e&&it(n),rt(n,t)},r.attr=function(t,i){var r;return((t.ownerDocument||t)!==e&&it(t),s&&(i=i.toLowerCase()),r=n.attrHandle[i])?r(t):!s||u.attributes?t.getAttribute(i):((r=t.getAttributeNode(i))||t.getAttribute(i))&&t[i]===!0?i:r&&r.specified?r.value:null},r.error=function(n){throw new Error("Syntax error, unrecognized expression: "+n);},r.uniqueSort=function(n){var r,f=[],t=0,i=0;if(ut=!u.detectDuplicates,ei=!u.sortDetached,ht=!u.sortStable&&n.slice(0),n.sort(lt),ut){while(r=n[i++])r===n[i]&&(t=f.push(i));while(t--)n.splice(f[t],1)}return n},ot=r.getText=function(n){var r,i="",u=0,t=n.nodeType;if(t){if(t===1||t===9||t===11){if(typeof n.textContent=="string")return n.textContent;for(n=n.firstChild;n;n=n.nextSibling)i+=ot(n)}else if(t===3||t===4)return n.nodeValue}else for(;r=n[u];u++)i+=ot(r);return i},n=r.selectors={cacheLength:50,createPseudo:h,match:vt,find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(n){return n[1]=n[1].replace(b,k),n[3]=(n[4]||n[5]||"").replace(b,k),n[2]==="~="&&(n[3]=" "+n[3]+" "),n.slice(0,4)},CHILD:function(n){return n[1]=n[1].toLowerCase(),n[1].slice(0,3)==="nth"?(n[3]||r.error(n[0]),n[4]=+(n[4]?n[5]+(n[6]||1):2*(n[3]==="even"||n[3]==="odd")),n[5]=+(n[7]+n[8]||n[3]==="odd")):n[3]&&r.error(n[0]),n},PSEUDO:function(n){var i,t=!n[5]&&n[2];return vt.CHILD.test(n[0])?null:(n[4]?n[2]=n[4]:t&&nr.test(t)&&(i=yt(t,!0))&&(i=t.indexOf(")",t.length-i)-t.length)&&(n[0]=n[0].slice(0,i),n[2]=t.slice(0,i)),n.slice(0,3))}},filter:{TAG:function(n){return n==="*"?function(){return!0}:(n=n.replace(b,k).toLowerCase(),function(t){return t.nodeName&&t.nodeName.toLowerCase()===n})},CLASS:function(n){var t=oi[n+" "];return t||(t=new RegExp("(^|"+f+")"+n+"("+f+"|$)"))&&oi(n,function(n){return t.test(n.className||typeof n.getAttribute!==v&&n.getAttribute("class")||"")})},ATTR:function(n,t,i){return function(u){var f=r.attr(u,n);return f==null?t==="!=":t?(f+="",t==="="?f===i:t==="!="?f!==i:t==="^="?i&&f.indexOf(i)===0:t==="*="?i&&f.indexOf(i)>-1:t==="$="?i&&f.slice(-i.length)===i:t==="~="?(" "+f+" ").indexOf(i)>-1:t==="|="?f===i||f.slice(0,i.length+1)===i+"-":!1):!0}},CHILD:function(n,t,r,u,f){var s=n.slice(0,3)!=="nth",o=n.slice(-4)!=="last",e=t==="of-type";return u===1&&f===0?function(n){return!!n.parentNode}:function(t,r,h){var v,k,c,l,y,w,b=s!==o?"nextSibling":"previousSibling",p=t.parentNode,g=e&&t.nodeName.toLowerCase(),d=!h&&!e;if(p){if(s){while(b){for(c=t;c=c[b];)if(e?c.nodeName.toLowerCase()===g:c.nodeType===1)return!1;w=b=n==="only"&&!w&&"nextSibling"}return!0}if(w=[o?p.firstChild:p.lastChild],o&&d){for(k=p[i]||(p[i]={}),v=k[n]||[],y=v[0]===a&&v[1],l=v[0]===a&&v[2],c=y&&p.childNodes[y];c=++y&&c&&c[b]||(l=y=0)||w.pop();)if(c.nodeType===1&&++l&&c===t){k[n]=[a,y,l];break}}else if(d&&(v=(t[i]||(t[i]={}))[n])&&v[0]===a)l=v[1];else while(c=++y&&c&&c[b]||(l=y=0)||w.pop())if((e?c.nodeName.toLowerCase()===g:c.nodeType===1)&&++l&&(d&&((c[i]||(c[i]={}))[n]=[a,l]),c===t))break;return l-=f,l===u||l%u==0&&l/u>=0}}},PSEUDO:function(t,u){var e,f=n.pseudos[t]||n.setFilters[t.toLowerCase()]||r.error("unsupported pseudo: "+t);return f[i]?f(u):f.length>1?(e=[t,t,"",u],n.setFilters.hasOwnProperty(t.toLowerCase())?h(function(n,t){for(var i,r=f(n,u),e=r.length;e--;)i=ft.call(n,r[e]),n[i]=!(t[i]=r[e])}):function(n){return f(n,0,e)}):f}},pseudos:{not:h(function(n){var r=[],u=[],t=bt(n.replace(at,"$1"));return t[i]?h(function(n,i,r,u){for(var e,o=t(n,null,u,[]),f=n.length;f--;)(e=o[f])&&(n[f]=!(i[f]=e))}):function(n,i,f){return r[0]=n,t(r,null,f,u),!u.pop()}}),has:h(function(n){return function(t){return r(n,t).length>0}}),contains:h(function(n){return function(t){return(t.textContent||t.innerText||ot(t)).indexOf(n)>-1}}),lang:h(function(n){return tr.test(n||"")||r.error("unsupported lang: "+n),n=n.replace(b,k).toLowerCase(),function(t){var i;do if(i=s?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return i=i.toLowerCase(),i===n||i.indexOf(n+"-")===0;while((t=t.parentNode)&&t.nodeType===1);return!1}}),target:function(n){var t=window.location&&window.location.hash;return t&&t.slice(1)===n.id},root:function(n){return n===o},focus:function(n){return n===e.activeElement&&(!e.hasFocus||e.hasFocus())&&!!(n.type||n.href||~n.tabIndex)},enabled:function(n){return n.disabled===!1},disabled:function(n){return n.disabled===!0},checked:function(n){var t=n.nodeName.toLowerCase();return t==="input"&&!!n.checked||t==="option"&&!!n.selected},selected:function(n){return n.parentNode&&n.parentNode.selectedIndex,n.selected===!0},empty:function(n){for(n=n.firstChild;n;n=n.nextSibling)if(n.nodeName>"@"||n.nodeType===3||n.nodeType===4)return!1;return!0},parent:function(t){return!n.pseudos.empty(t)},header:function(n){return fr.test(n.nodeName)},input:function(n){return ur.test(n.nodeName)},button:function(n){var t=n.nodeName.toLowerCase();return t==="input"&&n.type==="button"||t==="button"},text:function(n){var t;return n.nodeName.toLowerCase()==="input"&&n.type==="text"&&((t=n.getAttribute("type"))==null||t.toLowerCase()===n.type)},first:nt(function(){return[0]}),last:nt(function(n,t){return[t-1]}),eq:nt(function(n,t,i){return[i<0?i+t:i]}),even:nt(function(n,t){for(var i=0;i<t;i+=2)n.push(i);return n}),odd:nt(function(n,t){for(var i=1;i<t;i+=2)n.push(i);return n}),lt:nt(function(n,t,i){for(var r=i<0?i+t:i;--r>=0;)n.push(r);return n}),gt:nt(function(n,t,i){for(var r=i<0?i+t:i;++r<t;)n.push(r);return n})}};for(tt in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})n.pseudos[tt]=sr(tt);for(tt in{submit:!0,reset:!0})n.pseudos[tt]=hr(tt);return bt=r.compile=function(n,t){var u,f=[],e=[],r=hi[n+" "];if(!r){for(t||(t=yt(n)),u=t.length;u--;)r=ui(t[u]),r[i]?f.push(r):e.push(r);r=hi(n,cr(e,f))}return r},n.pseudos.nth=n.pseudos.eq,pi.prototype=n.filters=n.pseudos,n.setFilters=new pi,u.sortStable=i.split("").sort(lt).join("")===i,it(),[0,0].sort(lt),u.detectDuplicates=ut,r}),i("tinymce/dom/DomQuery",["tinymce/dom/EventUtils","tinymce/dom/Sizzle"],function(n,i){function o(n){return typeof n!="undefined"}function nt(n){return typeof n=="string"}function a(n){var t,r,i;for(i=s.createElement("div"),t=s.createDocumentFragment(),i.innerHTML=n;r=i.firstChild;)t.appendChild(r);return t}function f(n,t,i){var r;if(typeof t=="string")t=a(t);else if(t.length){for(r=0;r<t.length;r++)f(n,t[r],i);return n}for(r=n.length;r--;)i.call(n[r],t.parentNode?t:t);return n}function v(n,t){return n&&t&&(" "+n.className+" ").indexOf(" "+t+" ")!==-1}function y(n,t){var i;for(n=n||[],typeof n=="string"&&(n=n.split(" ")),t=t||{},i=n.length;i--;)t[n[i]]={};return t}function r(n,t){return new r.fn.init(n,t)}function p(n){for(var u=arguments,i,r,t=1;t<u.length;t++){i=u[t];for(r in i)n[r]=i[r]}return n}function l(n){for(var i=[],t=0,r=n.length;t<r;t++)i[t]=n[t];return i}function it(n,t){var i;if(t.indexOf)return t.indexOf(n);for(i=t.length;i--;)if(t[i]===n)return i;return-1}function u(n,t){var f,r,u,e,i;if(n)if(f=n.length,f===e){for(r in n)if(n.hasOwnProperty(r)&&(i=n[r],t.call(i,i,r)===!1))break}else for(u=0;u<f;u++)if(i=n[u],t.call(i,i,r)===!1)break;return n}function k(n,i,u){for(var e=[],f=n[i];f&&f.nodeType!==9&&(u===t||f.nodeType!==1||!r(f).is(u));)f.nodeType===1&&e.push(f),f=f[i];return e}function e(n,t,i,r){for(var u=[];n;n=n[i])r&&n.nodeType!==r||n===t||u.push(n);return u}var s=document,h=Array.prototype.push,d=Array.prototype.slice,g=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,c=n.Event,tt=y("fillOpacity fontWeight lineHeight opacity orphans widows zIndex zoom"),w=Array.isArray||function(n){return Object.prototype.toString.call(n)==="[object Array]"},rt=/^\s*|\s*$/g,b=function(n){return n===null||n===t?"":(""+n).replace(rt,"")};return r.fn=r.prototype={constructor:r,selector:"",length:0,init:function(n,t){var i=this,f,u;if(!n)return i;if(n.nodeType)return i.context=i[0]=n,i.length=1,i;if(nt(n))if(f=n.charAt(0)==="<"&&n.charAt(n.length-1)===">"&&n.length>=3?[null,n,null]:g.exec(n),f)if(f[1])for(u=a(n).firstChild;u;)this.add(u),u=u.nextSibling;else{if(u=s.getElementById(f[2]),u.id!==f[2])return i.find(n);i.length=1,i[0]=u}else return r(t||document).find(n);else this.add(n);return i},toArray:function(){return l(this)},add:function(n){var t=this;return w(n)?h.apply(t,n):n instanceof r?t.add(n.toArray()):h.call(t,n),t},attr:function(n,i){var r=this;if(typeof n=="object")u(n,function(n,t){r.attr(t,n)});else if(o(i))this.each(function(){this.nodeType===1&&this.setAttribute(n,i)});else return r[0]&&r[0].nodeType===1?r[0].getAttribute(n):t;return r},css:function(n,i){var r=this;if(typeof n=="object")u(n,function(n,t){r.css(t,n)});else if(n=n.replace(/-(\D)/g,function(n,t){return t.toUpperCase()}),o(i))typeof i!="number"||tt[n]||(i+="px"),r.each(function(){var t=this.style;n==="opacity"&&this.runtimeStyle&&typeof this.runtimeStyle.opacity=="undefined"&&(t.filter=i===""?"":"alpha(opacity="+i*100+")");try{t[n]=i}catch(r){}});else return r[0]?r[0].style[n]:t;return r},remove:function(){for(var i=this,n,t=this.length;t--;)n=i[t],c.clean(n),n.parentNode&&n.parentNode.removeChild(n);return this},empty:function(){for(var i=this,n,t=this.length;t--;)for(n=i[t];n.firstChild;)n.removeChild(n.firstChild);return this},html:function(n){var t=this,i;if(o(n)){for(i=t.length;i--;)t[i].innerHTML=n;return t}return t[0]?t[0].innerHTML:""},text:function(n){var t=this,i;if(o(n)){for(i=t.length;i--;)t[i].innerText=t[0].textContent=n;return t}return t[0]?t[0].innerText||t[0].textContent:""},append:function(){return f(this,arguments,function(n){this.nodeType===1&&this.appendChild(n)})},prepend:function(){return f(this,arguments,function(n){this.nodeType===1&&this.insertBefore(n,this.firstChild)})},before:function(){var n=this;return n[0]&&n[0].parentNode?f(n,arguments,function(n){this.parentNode.insertBefore(n,this.nextSibling)}):n},after:function(){var n=this;return n[0]&&n[0].parentNode?f(n,arguments,function(n){this.parentNode.insertBefore(n,this)}):n},appendTo:function(n){return r(n).append(this),this},addClass:function(n){return this.toggleClass(n,!0)},removeClass:function(n){return this.toggleClass(n,!1)},toggleClass:function(n,t){var i=this;return n.indexOf(" ")!==-1?u(n.split(" "),function(){i.toggleClass(this,t)}):i.each(function(){var i=this,r;v(i,n)!==t&&(r=i.className,t?i.className+=r?" "+n:n:i.className=b((" "+r+" ").replace(" "+n+" "," ")))}),i},hasClass:function(n){return v(this[0],n)},each:function(n){return u(this,n)},on:function(n,t){return this.each(function(){c.bind(this,n,t)})},off:function(n,t){return this.each(function(){c.unbind(this,n,t)})},show:function(){return this.css("display","")},hide:function(){return this.css("display","none")},slice:function(){return new r(d.apply(this,arguments))},eq:function(n){return n===-1?this.slice(n):this.slice(n,+n+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},replaceWith:function(n){var t=this;return t[0]&&t[0].parentNode.replaceChild(r(n)[0],t[0]),t},wrap:function(n){return n=r(n)[0],this.each(function(){var t=this,i=n.cloneNode(!1);t.parentNode.insertBefore(i,t),i.appendChild(t)})},unwrap:function(){return this.each(function(){for(var t=this,n=t.firstChild,i;n;)i=n,n=n.nextSibling,t.parentNode.insertBefore(i,t)})},clone:function(){var n=[];return this.each(function(){n.push(this.cloneNode(!0))}),r(n)},find:function(n){for(var u=[],t=0,i=this.length;t<i;t++)r.find(n,this[t],u);return r(u)},push:h,sort:[].sort,splice:[].splice},p(r,{extend:p,toArray:l,inArray:it,isArray:w,each:u,trim:b,makeMap:y,find:i,expr:i.selectors,unique:i.uniqueSort,text:i.getText,isXMLDoc:i.isXML,contains:i.contains,filter:function(n,t,i){return i&&(n=":not("+n+")"),t.length===1?r.find.matchesSelector(t[0],n)?[t[0]]:[]:r.find.matches(n,t)}}),u({parent:function(n){var t=n.parentNode;return t&&t.nodeType!==11?t:null},parents:function(n){return k(n,"parentNode")},parentsUntil:function(n,t){return k(n,"parentNode",t)},next:function(n){return e(n,"nextSibling",1)},prev:function(n){return e(n,"previousSibling",1)},nextNodes:function(n){return e(n,"nextSibling")},prevNodes:function(n){return e(n,"previousSibling")},children:function(n){return e(n.firstChild,"nextSibling",1)},contents:function(n){return l((n.nodeName==="iframe"?n.contentDocument||n.contentWindow.document:n).childNodes)}},function(n,t){r.fn[n]=function(i){var f=this,u;if(f.length>1)throw new Error("DomQuery only supports traverse functions on a single node.");return(f[0]&&(u=t(f[0],i)),u=r(u),i&&n!=="parentsUntil")?u.filter(i):u}}),r.fn.filter=function(n){return r.filter(n)},r.fn.is=function(n){return!!n&&this.filter(n).length>0},r.fn.init.prototype=r.fn,r}),i("tinymce/html/Styles",[],function(){return function(n,t){function c(n,t,i,r){function u(n){return n=parseInt(n,10).toString(16),n.length>1?n:"0"+n}return"#"+u(t)+u(i)+u(r)}var e=/rgb\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*\)/gi,l=/(?:url(?:(?:\(\s*\"([^\"]+)\"\s*\))|(?:\(\s*\'([^\']+)\'\s*\))|(?:\(\s*([^)\s]+)\s*\))))|(?:\'([^\']+)\')|(?:\"([^\"]+)\")/gi,o=/\s*([^:]+):\s*([^;]+);?/g,s=/\s+$/,h,i,r={},u,f="\ufeff";for(n=n||{},u=("\\\" \\' \\; \\: ; : "+f).split(" "),i=0;i<u.length;i++)r[u[i]]=f+i,r[f+i]=u[i];return{toHex:function(n){return n.replace(e,c)},parse:function(t){function a(n,t,r){var e,o,s,h,f;if((e=u[n+"-top"+t],e)&&(o=u[n+"-right"+t],o)&&(s=u[n+"-bottom"+t],s)&&(h=u[n+"-left"+t],h)){for(f=[e,o,s,h],i=f.length-1;i--;)if(f[i]!==f[i+1])break;i>-1&&r||(u[n+t]=i==-1?f[0]:f.join(" "),delete u[n+"-top"+t],delete u[n+"-right"+t],delete u[n+"-bottom"+t],delete u[n+"-left"+t])}}function p(n){var t=u[n],i;if(t){for(t=t.split(" "),i=t.length;i--;)if(t[i]!==t[0])return!1;return u[n]=t[0],!0}}function g(n,t,i,r){p(t)&&p(i)&&p(r)&&(u[n]=u[t]+" "+u[i]+" "+u[r],delete u[t],delete u[i],delete u[r])}function k(n){return y=!0,r[n]}function w(n,t){return y&&(n=n.replace(/\uFEFF[0-9]/g,function(n){return r[n]})),t||(n=n.replace(/\\([\'\";:])/g,"$1")),n}function nt(t,i,r,u,f,e){return(f=f||e,f)?(f=w(f),"'"+f.replace(/\'/g,"\\'")+"'"):(i=w(i||r||u),!n.allow_script_urls&&/(java|vb)script:/i.test(i.replace(/[\s\r\n]+/,"")))?"":(b&&(i=b.call(d,i,"style")),"url('"+i.replace(/\'/g,"\\'")+"')")}var u={},v,h,f,y,b=n.url_converter,d=n.url_converter_scope||this;if(t){for(t=t.replace(/[\u0000-\u001F]/g,""),t=t.replace(/\\[\"\';:\uFEFF]/g,k).replace(/\"[^\"]+\"|\'[^\']+\'/g,function(n){return n.replace(/[;:]/g,k)});v=o.exec(t);){if(h=v[1].replace(s,"").toLowerCase(),f=v[2].replace(s,""),h&&f.length>0){if(!n.allow_script_urls&&(h=="behavior"||/expression\s*\(/.test(f)))continue;h==="font-weight"&&f==="700"?f="bold":(h==="color"||h==="background-color")&&(f=f.toLowerCase()),f=f.replace(e,c),f=f.replace(l,nt),u[h]=y?w(f,!0):f}o.lastIndex=v.index+v[0].length}a("border","",!0),a("border","-width"),a("border","-color"),a("border","-style"),a("padding",""),a("margin",""),g("border","border-width","border-style","border-color"),u.border==="medium none"&&delete u.border,u["border-image"]==="none"&&delete u["border-image"]}return u},serialize:function(n,i){function e(i){var u,f,o,e;if(u=t.styles[i],u)for(f=0,o=u.length;f<o;f++)i=u[f],e=n[i],e!==h&&e.length>0&&(r+=(r.length>0?" ":"")+i+": "+e+";")}var r="",f,u;if(i&&t&&t.styles)e("*"),e(i);else for(f in n)u=n[f],u!==h&&u.length>0&&(r+=(r.length>0?" ":"")+f+": "+u+";");return r}}}}),i("tinymce/dom/TreeWalker",[],function(){return function(n,t){function r(n,i,r,u){var f,e;if(n){if(!u&&n[i])return n[i];if(n!=t){if(f=n[r],f)return f;for(e=n.parentNode;e&&e!=t;e=e.parentNode)if(f=e[r],f)return f}}}var i=n;this.current=function(){return i},this.next=function(n){return i=r(i,"firstChild","nextSibling",n)},this.prev=function(n){return i=r(i,"lastChild","previousSibling",n)}}}),i("tinymce/util/Tools",[],function(){function u(n,i){return i?i=="array"&&r(n)?!0:typeof n==i:n!==t}function s(n){for(var i=[],t=0,r=n.length;t<r;t++)i[t]=n[t];return i}function h(n,t,i){var r;for(n=n||[],t=t||",",typeof n=="string"&&(n=n.split(t)),i=i||{},r=n.length;r--;)i[n[r]]={};return i}function n(n,i,r){var u,f;if(!n)return 0;if(r=r||n,n.length!==t){for(u=0,f=n.length;u<f;u++)if(i.call(r,n[u],u,n)===!1)return 0}else for(u in n)if(n.hasOwnProperty(u)&&i.call(r,n[u],u,n)===!1)return 0;return 1}function f(t,i){var r=[];return n(t,function(n){r.push(i(n))}),r}function c(t,i){var r=[];return n(t,function(n){(!i||i(n))&&r.push(n)}),r}function l(n,t,i){var e=this,f,u,r,o,s,h=0;if(n=/^((static) )?([\w.]+)(:([\w.]+))?/.exec(n),r=n[3].match(/(^|\.)(\w+)$/i)[2],u=e.createNS(n[3].replace(/\.\w+$/,""),i),!u[r]){if(n[2]=="static"){if(u[r]=t,this.onCreate)this.onCreate(n[2],n[3],u[r]);return}t[r]||(t[r]=function(){},h=1),u[r]=t[r],e.extend(u[r].prototype,t),n[5]&&(f=e.resolve(n[5]).prototype,o=n[5].match(/\.(\w+)$/i)[1],s=u[r],u[r]=h?function(){return f[o].apply(this,arguments)}:function(){return this.parent=f[o],s.apply(this,arguments)},u[r].prototype[r]=u[r],e.each(f,function(n,t){u[r].prototype[t]=f[t]}),e.each(t,function(n,t){f[t]?u[r].prototype[t]=function(){return this.parent=f[t],n.apply(this,arguments)}:t!=r&&(u[r].prototype[t]=n)})),e.each(t["static"],function(n,t){u[r][t]=n})}}function a(n,t){var i,r;if(n)for(i=0,r=n.length;i<r;i++)if(n[i]===t)return i;return-1}function v(n,i){for(var u,o=arguments,f,r=1,e=o.length;r<e;r++){i=o[r];for(u in i)i.hasOwnProperty(u)&&(f=i[u],f!==t&&(n[u]=f))}return n}function e(t,i,r,u){u=u||this,t&&(r&&(t=t[r]),n(t,function(n,t){if(i.call(u,n,t,r)===!1)return!1;e(n,i,r,u)}))}function y(n,t){var i,r;for(t=t||window,n=n.split("."),i=0;i<n.length;i++)r=n[i],t[r]||(t[r]={}),t=t[r];return t}function p(n,t){var i,r;for(t=t||window,n=n.split("."),i=0,r=n.length;i<r;i++)if(t=t[n[i]],!t)break;return t}function w(n,t){return!n||u(n,"array")?n:f(n.split(t||","),i)}var o=/^\s*|\s*$/g,i=function(n){return n===null||n===t?"":(""+n).replace(o,"")},r=Array.isArray||function(n){return Object.prototype.toString.call(n)==="[object Array]"};return{trim:i,isArray:r,is:u,toArray:s,makeMap:h,each:n,map:f,grep:c,inArray:a,extend:v,create:l,walk:e,createNS:y,resolve:p,explode:w}}),i("tinymce/dom/Range",["tinymce/util/Tools"],function(n){function t(i){function b(){return y.createDocumentFragment()}function k(n,t){ft(o,n,t)}function d(n,t){ft(c,n,t)}function it(n){k(n.parentNode,a(n))}function ht(n){k(n.parentNode,a(n)+1)}function ct(n){d(n.parentNode,a(n))}function rt(n){d(n.parentNode,a(n)+1)}function lt(n){n?(r[e]=r[u],r[s]=r[f]):(r[u]=r[e],r[f]=r[s]),r.collapsed=o}function at(n){it(n),rt(n)}function vt(n){k(n,0),d(n,n.nodeType===1?n.childNodes.length:n.nodeValue.length)}function yt(n,t){var i=r[u],o=r[f],h=r[e],c=r[s],l=t.startContainer,a=t.startOffset,v=t.endContainer,y=t.endOffset;return n===0?p(i,o,l,a):n===1?p(h,c,l,a):n===2?p(h,c,v,y):n===3?p(i,o,v,y):void 0}function pt(){nt(h)}function wt(){return nt(st)}function ut(){return nt(l)}function bt(n){var t=this[u],r=this[f],o,e;(t.nodeType===3||t.nodeType===4)&&t.nodeValue?r?r>=t.nodeValue.length?i.insertAfter(n,t):(o=t.splitText(r),t.parentNode.insertBefore(n,o)):t.parentNode.insertBefore(n,t):(t.childNodes.length>0&&(e=t.childNodes[r]),e?t.insertBefore(n,e):t.nodeType==3?i.insertAfter(n,t):t.appendChild(n))}function kt(n){var t=r.extractContents();r.insertNode(n),n.appendChild(t),r.selectNode(n)}function dt(){return tt(new t(i),{startContainer:r[u],startOffset:r[f],endContainer:r[e],endOffset:r[s],collapsed:r.collapsed,commonAncestorContainer:r.commonAncestorContainer})}function g(n,t){var i;if(n.nodeType==3||t<0)return n;for(i=n.firstChild;i&&t>0;)--t,i=i.nextSibling;return i?i:n}function gt(){return r[u]==r[e]&&r[f]==r[s]}function p(n,t,r,u){var f,h,e,c,o,s;if(n==r)return t==u?0:t<u?-1:1;for(f=r;f&&f.parentNode!=n;)f=f.parentNode;if(f){for(h=0,e=n.firstChild;e!=f&&h<t;)h++,e=e.nextSibling;return t<=h?-1:1}for(f=n;f&&f.parentNode!=r;)f=f.parentNode;if(f){for(h=0,e=r.firstChild;e!=f&&h<u;)h++,e=e.nextSibling;return h<u?-1:1}for(c=i.findCommonAncestor(n,r),o=n;o&&o.parentNode!=c;)o=o.parentNode;for(o||(o=c),s=r;s&&s.parentNode!=c;)s=s.parentNode;if(s||(s=c),o==s)return 0;for(e=c.firstChild;e;){if(e==o)return-1;if(e==s)return 1;e=e.nextSibling}}function ft(n,t,o){var h,c;for(n?(r[u]=t,r[f]=o):(r[e]=t,r[s]=o),h=r[e];h.parentNode;)h=h.parentNode;for(c=r[u];c.parentNode;)c=c.parentNode;c==h?p(r[u],r[f],r[e],r[s])>0&&r.collapse(n):r.collapse(n),r.collapsed=gt(),r.commonAncestorContainer=i.findCommonAncestor(r[u],r[e])}function nt(n){var i,l=0,a=0,t,s,f,o,h,c;if(r[u]==r[e])return ni(n);for(i=r[e],t=i.parentNode;t;i=t,t=t.parentNode){if(t==r[u])return ti(i,n);++l}for(i=r[u],t=i.parentNode;t;i=t,t=t.parentNode){if(t==r[e])return ii(i,n);++a}for(s=a-l,f=r[u];s>0;)f=f.parentNode,s--;for(o=r[e];s<0;)o=o.parentNode,s++;for(h=f.parentNode,c=o.parentNode;h!=c;h=h.parentNode,c=c.parentNode)f=h,o=c;return ri(f,o,n)}function ni(n){var i,p,e,t,c,k,d,a,v;if(n!=h&&(i=b()),r[f]==r[s])return i;if(r[u].nodeType==3)return(p=r[u].nodeValue,e=p.substring(r[f],r[s]),n!=l&&(t=r[u],a=r[f],v=r[s]-r[f],a===0&&v>=t.nodeValue.length-1?t.parentNode.removeChild(t):t.deleteData(a,v),r.collapse(o)),n==h)?void 0:(e.length>0&&i.appendChild(y.createTextNode(e)),i);for(t=g(r[u],r[f]),c=r[s]-r[f];t&&c>0;)k=t.nextSibling,d=w(t,n),i&&i.appendChild(d),--c,t=k;return n!=l&&r.collapse(o),i}function ti(n,t){var i,u,o,e,s,v;if(t!=h&&(i=b()),u=et(n,t),i&&i.appendChild(u),o=a(n),e=o-r[f],e<=0)return t!=l&&(r.setEndBefore(n),r.collapse(c)),i;for(u=n.previousSibling;e>0;)s=u.previousSibling,v=w(u,t),i&&i.insertBefore(v,i.firstChild),--e,u=s;return t!=l&&(r.setEndBefore(n),r.collapse(c)),i}function ii(n,t){var u,f,i,e,c,v;for(t!=h&&(u=b()),i=ot(n,t),u&&u.appendChild(i),f=a(n),++f,e=r[s]-f,i=n.nextSibling;i&&e>0;)c=i.nextSibling,v=w(i,t),u&&u.appendChild(v),--e,i=c;return t!=l&&(r.setStartAfter(n),r.collapse(o)),u}function ri(n,t,i){var f,u,p,s,v,c,e,y;for(i!=h&&(u=b()),f=ot(n,i),u&&u.appendChild(f),p=n.parentNode,s=a(n),v=a(t),++s,c=v-s,e=n.nextSibling;c>0;)y=e.nextSibling,f=w(e,i),u&&u.appendChild(f),e=y,--c;return f=et(t,i),u&&u.appendChild(f),i!=l&&(r.setStartAfter(n),r.collapse(o)),u}function et(n,t){var i=g(r[e],r[s]-1),u,f,y,p,l,a=i!=r[e];if(i==n)return v(i,a,c,t);for(u=i.parentNode,f=v(u,c,c,t);u;){while(i)y=i.previousSibling,p=v(i,a,c,t),t!=h&&f.insertBefore(p,f.firstChild),a=o,i=y;if(u==n)return f;i=u.previousSibling,u=u.parentNode,l=v(u,c,c,t),t!=h&&l.appendChild(f),f=l}}function ot(n,t){var i=g(r[u],r[f]),l=i!=r[u],e,s,y,p,a;if(i==n)return v(i,l,o,t);for(e=i.parentNode,s=v(e,c,o,t);e;){while(i)y=i.nextSibling,p=v(i,l,o,t),t!=h&&s.appendChild(p),l=o,i=y;if(e==n)return s;i=e.nextSibling,e=e.parentNode,a=v(e,c,o,t),t!=h&&a.appendChild(s),s=a}}function v(n,t,u,e){var a,v,y,o,p;return t?w(n,e):n.nodeType==3?(a=n.nodeValue,u?(o=r[f],v=a.substring(o),y=a.substring(0,o)):(o=r[s],v=a.substring(0,o),y=a.substring(o)),e!=l&&(n.nodeValue=y),e==h)?void 0:(p=i.clone(n,c),p.nodeValue=v,p):e==h?void 0:i.clone(n,c)}function w(n,t){if(t!=h)return t==l?i.clone(n,o):n;n.parentNode.removeChild(n)}function ui(){return i.create("body",null,ut()).outerText}var r=this,y=i.doc,st=0,l=1,h=2,o=!0,c=!1,f="startOffset",u="startContainer",e="endContainer",s="endOffset",tt=n.extend,a=i.nodeIndex;return tt(r,{startContainer:y,startOffset:0,endContainer:y,endOffset:0,collapsed:o,commonAncestorContainer:y,START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3,setStart:k,setEnd:d,setStartBefore:it,setStartAfter:ht,setEndBefore:ct,setEndAfter:rt,collapse:lt,selectNode:at,selectNodeContents:vt,compareBoundaryPoints:yt,deleteContents:pt,extractContents:wt,cloneContents:ut,insertNode:bt,surroundContents:kt,cloneRange:dt,toStringIE:ui}),r}return t.prototype.toString=function(){return this.toStringIE()},t}),i("tinymce/html/Entities",["tinymce/util/Tools"],function(n){function a(n){var t;return t=document.createElement("div"),t.innerHTML=n,t.textContent||t.innerText||n}function o(n,i){var r,u,f,e={};if(n){for(n=n.split(","),i=i||10,r=0;r<n.length;r+=2)u=String.fromCharCode(parseInt(n[r],i)),t[u]||(f="&"+n[r+1]+";",e[u]=f,e[f]=u);return e}}var s=n.makeMap,r,t,e,u=/[&<>\"\u007E-\uD7FF\uE000-\uFFEF]|[\uD800-\uDBFF][\uDC00-\uDFFF]/g,f=/[<>&\u007E-\uD7FF\uE000-\uFFEF]|[\uD800-\uDBFF][\uDC00-\uDFFF]/g,h=/[<>&\"\']/g,c=/&(#x|#)?([\w]+);/g,l={128:"\u20ac",130:"\u201a",131:"\u0192",132:"\u201e",133:"\u2026",134:"\u2020",135:"\u2021",136:"\u02c6",137:"\u2030",138:"\u0160",139:"\u2039",140:"\u0152",142:"\u017d",145:"\u2018",146:"\u2019",147:"\u201c",148:"\u201d",149:"\u2022",150:"\u2013",151:"\u2014",152:"\u02dc",153:"\u2122",154:"\u0161",155:"\u203a",156:"\u0153",158:"\u017e",159:"\u0178"},i;return t={'"':"&quot;","'":"&#39;","<":"&lt;",">":"&gt;","&":"&amp;"},e={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&apos;":"'"},r=o("50,nbsp,51,iexcl,52,cent,53,pound,54,curren,55,yen,56,brvbar,57,sect,58,uml,59,copy,5a,ordf,5b,laquo,5c,not,5d,shy,5e,reg,5f,macr,5g,deg,5h,plusmn,5i,sup2,5j,sup3,5k,acute,5l,micro,5m,para,5n,middot,5o,cedil,5p,sup1,5q,ordm,5r,raquo,5s,frac14,5t,frac12,5u,frac34,5v,iquest,60,Agrave,61,Aacute,62,Acirc,63,Atilde,64,Auml,65,Aring,66,AElig,67,Ccedil,68,Egrave,69,Eacute,6a,Ecirc,6b,Euml,6c,Igrave,6d,Iacute,6e,Icirc,6f,Iuml,6g,ETH,6h,Ntilde,6i,Ograve,6j,Oacute,6k,Ocirc,6l,Otilde,6m,Ouml,6n,times,6o,Oslash,6p,Ugrave,6q,Uacute,6r,Ucirc,6s,Uuml,6t,Yacute,6u,THORN,6v,szlig,70,agrave,71,aacute,72,acirc,73,atilde,74,auml,75,aring,76,aelig,77,ccedil,78,egrave,79,eacute,7a,ecirc,7b,euml,7c,igrave,7d,iacute,7e,icirc,7f,iuml,7g,eth,7h,ntilde,7i,ograve,7j,oacute,7k,ocirc,7l,otilde,7m,ouml,7n,divide,7o,oslash,7p,ugrave,7q,uacute,7r,ucirc,7s,uuml,7t,yacute,7u,thorn,7v,yuml,ci,fnof,sh,Alpha,si,Beta,sj,Gamma,sk,Delta,sl,Epsilon,sm,Zeta,sn,Eta,so,Theta,sp,Iota,sq,Kappa,sr,Lambda,ss,Mu,st,Nu,su,Xi,sv,Omicron,t0,Pi,t1,Rho,t3,Sigma,t4,Tau,t5,Upsilon,t6,Phi,t7,Chi,t8,Psi,t9,Omega,th,alpha,ti,beta,tj,gamma,tk,delta,tl,epsilon,tm,zeta,tn,eta,to,theta,tp,iota,tq,kappa,tr,lambda,ts,mu,tt,nu,tu,xi,tv,omicron,u0,pi,u1,rho,u2,sigmaf,u3,sigma,u4,tau,u5,upsilon,u6,phi,u7,chi,u8,psi,u9,omega,uh,thetasym,ui,upsih,um,piv,812,bull,816,hellip,81i,prime,81j,Prime,81u,oline,824,frasl,88o,weierp,88h,image,88s,real,892,trade,89l,alefsym,8cg,larr,8ch,uarr,8ci,rarr,8cj,darr,8ck,harr,8dl,crarr,8eg,lArr,8eh,uArr,8ei,rArr,8ej,dArr,8ek,hArr,8g0,forall,8g2,part,8g3,exist,8g5,empty,8g7,nabla,8g8,isin,8g9,notin,8gb,ni,8gf,prod,8gh,sum,8gi,minus,8gn,lowast,8gq,radic,8gt,prop,8gu,infin,8h0,ang,8h7,and,8h8,or,8h9,cap,8ha,cup,8hb,int,8hk,there4,8hs,sim,8i5,cong,8i8,asymp,8j0,ne,8j1,equiv,8j4,le,8j5,ge,8k2,sub,8k3,sup,8k4,nsub,8k6,sube,8k7,supe,8kl,oplus,8kn,otimes,8l5,perp,8m5,sdot,8o8,lceil,8o9,rceil,8oa,lfloor,8ob,rfloor,8p9,lang,8pa,rang,9ea,loz,9j0,spades,9j3,clubs,9j5,hearts,9j6,diams,ai,OElig,aj,oelig,b0,Scaron,b1,scaron,bo,Yuml,m6,circ,ms,tilde,802,ensp,803,emsp,809,thinsp,80c,zwnj,80d,zwj,80e,lrm,80f,rlm,80j,ndash,80k,mdash,80o,lsquo,80p,rsquo,80q,sbquo,80s,ldquo,80t,rdquo,80u,bdquo,810,dagger,811,Dagger,81g,permil,81p,lsaquo,81q,rsaquo,85c,euro",32),i={encodeRaw:function(n,i){return n.replace(i?u:f,function(n){return t[n]||n})},encodeAllRaw:function(n){return(""+n).replace(h,function(n){return t[n]||n})},encodeNumeric:function(n,i){return n.replace(i?u:f,function(n){return n.length>1?"&#"+((n.charCodeAt(0)-55296)*1024+(n.charCodeAt(1)-56320)+65536)+";":t[n]||"&#"+n.charCodeAt(0)+";"})},encodeNamed:function(n,i,e){return e=e||r,n.replace(i?u:f,function(n){return t[n]||e[n]||n})},getEncodeFunc:function(n,e){function h(n,i){return n.replace(i?u:f,function(n){return t[n]||e[n]||"&#"+n.charCodeAt(0)+";"||n})}function c(n,t){return i.encodeNamed(n,t,e)}return(e=o(e)||r,n=s(n.replace(/\+/g,",")),n.named&&n.numeric)?h:n.named?e?c:i.encodeNamed:n.numeric?i.encodeNumeric:i.encodeRaw},decode:function(n){return n.replace(c,function(n,t,i){return t?(i=parseInt(i,t.length===2?16:10),i>65535?(i-=65536,String.fromCharCode(55296+(i>>10),56320+(i&1023))):l[i]||String.fromCharCode(i)):e[n]||r[n]||a(n)})}}}),i("tinymce/Env",[],function(){var r=navigator,n=r.userAgent,u,i,t,f,o,s,e,h;return u=window.opera&&window.opera.buildNumber,i=/WebKit/.test(n),t=!i&&!u&&/MSIE/gi.test(n)&&/Explorer/gi.test(r.appName),t=t&&/MSIE (\w+)\./.exec(n)[1],f=n.indexOf("Trident/")!=-1&&(n.indexOf("rv:")!=-1||r.appName.indexOf("Netscape")!=-1)?11:!1,t=t||f,o=!i&&!f&&/Gecko/.test(n),s=n.indexOf("Mac")!=-1,e=/(iPad|iPhone)/.test(n),h=!e||n.match(/AppleWebKit\/(\d*)/)[1]>=534,{opera:u,webkit:i,ie:t,gecko:o,mac:s,iOS:e,contentEditable:h,transparentSrc:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",caretAfter:t!=8,range:window.getSelection&&"Range"in window,documentMode:t?document.documentMode||7:10}}),i("tinymce/dom/StyleSheetLoader",[],function(){return function(n,t){function u(t){n.getElementsByTagName("head")[0].appendChild(t)}function e(t,e,o){function l(){for(var n=s.passed,t=n.length;t--;)n[t]();s.status=2,s.passed=[],s.failed=[]}function a(){for(var n=s.failed,t=n.length;t--;)n[t]();s.status=3,s.passed=[],s.failed=[]}function b(){var n=navigator.userAgent.match(/WebKit\/(\d*)/);return!!(n&&n[1]<536)}function p(n,t){n()||((new Date).getTime()-y<r?window.setTimeout(t,0):a())}function v(){p(function(){for(var r=n.styleSheets,t,u=r.length,i;u--;)if(t=r[u],i=t.ownerNode?t.ownerNode:t.owningElement,i&&i.id===h.id)return l(),!0},v)}function w(){p(function(){try{var n=c.sheet.cssRules;return l(),!!n}catch(t){}},w)}var h,c,y,s;if(i[t]?s=i[t]:(s={passed:[],failed:[]},i[t]=s),e&&s.passed.push(e),o&&s.failed.push(o),s.status!=1){if(s.status==2){l();return}if(s.status==3){a();return}if(s.status=1,h=n.createElement("link"),h.rel="stylesheet",h.type="text/css",h.id="u"+f++,h.async=!1,h.defer=!1,y=(new Date).getTime(),"onload"in h&&!b())h.onload=v,h.onerror=a;else{if(navigator.userAgent.indexOf("Firefox")>0){c=n.createElement("style"),c.textContent='@import "'+t+'"',w(),u(c);return}v()}u(h),h.href=t}}var f=0,i={},r;t=t||{},r=t.maxLoadTime||5e3,this.load=e}}),i("tinymce/dom/DOMUtils",["tinymce/dom/Sizzle","tinymce/html/Styles","tinymce/dom/EventUtils","tinymce/dom/TreeWalker","tinymce/dom/Range","tinymce/html/Entities","tinymce/Env","tinymce/util/Tools","tinymce/dom/StyleSheetLoader"],function(n,i,r,u,f,e,o,s,h){function l(n,t){var u=this,f;u.doc=n,u.win=window,u.files={},u.counter=0,u.stdMode=!c||n.documentMode>=8,u.boxModel=!c||n.compatMode=="CSS1Compat"||u.stdMode,u.hasOuterHTML="outerHTML"in n.createElement("a"),u.styleSheetLoader=new h(n),this.boundEvents=[],u.settings=t=w({keep_values:!1,hex_colors:1},t),u.schema=t.schema,u.styles=new i({url_converter:t.url_converter,url_converter_scope:t.url_converter_scope},t.schema),u.fixDoc(n),u.events=t.ownEvents?new r(t.proxy):r.Event,f=t.schema?t.schema.getBlockElements():{},u.isBlock=function(n){if(!n)return!1;var t=n.nodeType;return t?!!(t===1&&f[n.nodeName]):!!f[n]}}var a=s.each,v=s.is,y=s.grep,p=s.trim,w=s.extend,b=o.webkit,c=o.ie,k=/^([a-z0-9],?)+$/i,d=/^[ \t\r\n]*$/,g=s.makeMap("fillOpacity fontWeight lineHeight opacity orphans widows zIndex zoom"," ");return l.prototype={root:null,props:{"for":"htmlFor","class":"className",className:"className",checked:"checked",disabled:"disabled",maxlength:"maxLength",readonly:"readOnly",selected:"selected",value:"value",id:"id",name:"name",type:"type"},fixDoc:function(n){var t=this.settings,i;if(c&&t.schema){"abbr article aside audio canvas details figcaption figure footer header hgroup mark menu meter nav output progress section summary time video".replace(/\w+/g,function(t){n.createElement(t)});for(i in t.schema.getCustomElements())n.createElement(i)}},clone:function(n,t){var i=this,r,u;return!c||n.nodeType!==1||t?n.cloneNode(t):(u=i.doc,!t)?(r=u.createElement(n.nodeName),a(i.getAttribs(n),function(t){i.setAttrib(r,t.nodeName,i.getAttrib(n,t.nodeName))}),r):r.firstChild},getRoot:function(){var n=this;return n.get(n.settings.root_element)||n.doc.body},getViewPort:function(n){var i,t;return n=n?n:this.win,i=n.document,t=this.boxModel?i.documentElement:i.body,{x:n.pageXOffset||t.scrollLeft,y:n.pageYOffset||t.scrollTop,w:n.innerWidth||t.clientWidth,h:n.innerHeight||t.clientHeight}},getRect:function(n){var t=this,i,r;return n=t.get(n),i=t.getPos(n),r=t.getSize(n),{x:i.x,y:i.y,w:r.w,h:r.h}},getSize:function(n){var r=this,t,i;return n=r.get(n),t=r.getStyle(n,"width"),i=r.getStyle(n,"height"),t.indexOf("px")===-1&&(t=0),i.indexOf("px")===-1&&(i=0),{w:parseInt(t,10)||n.offsetWidth||n.clientWidth,h:parseInt(i,10)||n.offsetHeight||n.clientHeight}},getParent:function(n,t,i){return this.getParents(n,t,i,!1)},getParents:function(n,i,r,u){var f=this,e,o=[];for(n=f.get(n),u=u===t,r=r||(f.getRoot().nodeName!="BODY"?f.getRoot().parentNode:null),v(i,"string")&&(e=i,i=i==="*"?function(n){return n.nodeType==1}:function(n){return f.is(n,e)});n;){if(n==r||!n.nodeType||n.nodeType===9)break;if(!i||i(n))if(u)o.push(n);else return n;n=n.parentNode}return u?o:null},get:function(n){var t;return n&&this.doc&&typeof n=="string"&&(t=n,n=this.doc.getElementById(n),n&&n.id!==t)?this.doc.getElementsByName(t)[1]:n},getNext:function(n,t){return this._findSib(n,t,"nextSibling")},getPrev:function(n,t){return this._findSib(n,t,"previousSibling")},select:function(t,i){var r=this;return n(t,r.get(i)||r.get(r.settings.root_element)||r.doc,[])},is:function(i,r){var u;if(i.length===t){if(r==="*")return i.nodeType==1;if(k.test(r)){for(r=r.toLowerCase().split(/,/),i=i.nodeName.toLowerCase(),u=r.length-1;u>=0;u--)if(r[u]==i)return!0;return!1}}return i.nodeType&&i.nodeType!=1?!1:n.matches(r,i.nodeType?[i]:i).length>0},add:function(n,t,i,r,u){var f=this;return this.run(n,function(n){var e;return e=v(t,"string")?f.doc.createElement(t):t,f.setAttribs(e,i),r&&(r.nodeType?e.appendChild(r):f.setHTML(e,r)),u?e:n.appendChild(e)})},create:function(n,t,i){return this.add(this.doc.createElement(n),n,t,i,1)},createHTML:function(n,t,i){var u="",r;u+="<"+n;for(r in t)t.hasOwnProperty(r)&&t[r]!==null&&(u+=" "+r+'="'+this.encode(t[r])+'"');return typeof i!="undefined"?u+">"+i+"<\/"+n+">":u+" />"},createFragment:function(n){var t,r,u=this.doc,i;for(i=u.createElement("div"),t=u.createDocumentFragment(),n&&(i.innerHTML=n);r=i.firstChild;)t.appendChild(r);return t},remove:function(n,t){return this.run(n,function(n){var i,r=n.parentNode;if(!r)return null;if(t)while(i=n.firstChild)!c||i.nodeType!==3||i.nodeValue?r.insertBefore(i,n):n.removeChild(i);return r.removeChild(n)})},setStyle:function(n,t,i){return this.run(n,function(n){var f=this,r,u;if(t)if(typeof t=="string"){r=n.style,t=t.replace(/-(\D)/g,function(n,t){return t.toUpperCase()}),typeof i!="number"||g[t]||(i+="px"),t==="opacity"&&n.runtimeStyle&&typeof n.runtimeStyle.opacity=="undefined"&&(r.filter=i===""?"":"alpha(opacity="+i*100+")"),t=="float"&&(t="cssFloat"in n.style?"cssFloat":"styleFloat");try{r[t]=i}catch(e){}f.settings.update_styles&&n.removeAttribute("data-mce-style")}else for(u in t)f.setStyle(n,u,t[u])})},getStyle:function(n,i,r){if(n=this.get(n),n){if(this.doc.defaultView&&r){i=i.replace(/[A-Z]/g,function(n){return"-"+n});try{return this.doc.defaultView.getComputedStyle(n,null).getPropertyValue(i)}catch(u){return null}}return(i=i.replace(/-(\D)/g,function(n,t){return t.toUpperCase()}),i=="float"&&(i=c?"styleFloat":"cssFloat"),n.currentStyle&&r)?n.currentStyle[i]:n.style?n.style[i]:t}},setStyles:function(n,t){this.setStyle(n,t)},css:function(n,t,i){this.setStyle(n,t,i)},removeAllAttribs:function(n){return this.run(n,function(n){for(var i=n.attributes,t=i.length-1;t>=0;t--)n.removeAttributeNode(i.item(t))})},setAttrib:function(n,t,i){var r=this;if(n&&t)return this.run(n,function(n){var u=r.settings,f=n.getAttribute(t);if(i!==null)switch(t){case"style":if(!v(i,"string")){a(i,function(t,i){r.setStyle(n,i,t)});return}u.keep_values&&(i?n.setAttribute("data-mce-style",i,2):n.removeAttribute("data-mce-style",2)),n.style.cssText=i;break;case"class":n.className=i||"";break;case"src":case"href":u.keep_values&&(u.url_converter&&(i=u.url_converter.call(u.url_converter_scope||r,i,t,n)),r.setAttrib(n,"data-mce-"+t,i,2));break;case"shape":n.setAttribute("data-mce-style",i)}if(v(i)&&i!==null&&i.length!==0?n.setAttribute(t,""+i,2):n.removeAttribute(t,2),f!=i&&u.onSetAttrib)u.onSetAttrib({attrElm:n,attrName:t,attrValue:i})})},setAttribs:function(n,t){var i=this;return this.run(n,function(n){a(t,function(t,r){i.setAttrib(n,r,t)})})},getAttrib:function(n,t,i){var r,u=this,f;if(n=u.get(n),!n||n.nodeType!==1)return i===f?!1:i;if(v(i)||(i=""),/^(src|href|style|coords|shape)$/.test(t)&&(r=n.getAttribute("data-mce-"+t),r))return r;if(c&&u.props[t]&&(r=n[u.props[t]],r=r&&r.nodeValue?r.nodeValue:r),r||(r=n.getAttribute(t,2)),/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noshade|nowrap|readonly|selected)$/.test(t))return n[u.props[t]]===!0&&r===""?t:r?t:"";if(n.nodeName==="FORM"&&n.getAttributeNode(t))return n.getAttributeNode(t).nodeValue;if(t==="style"&&(r=r||n.style.cssText,r&&(r=u.serializeStyle(u.parseStyle(r),n.nodeName),u.settings.keep_values&&n.setAttribute("data-mce-style",r))),b&&t==="class"&&r&&(r=r.replace(/(apple|webkit)\-[a-z\-]+/gi,"")),c)switch(t){case"rowspan":case"colspan":r===1&&(r="");break;case"size":(r==="+0"||r===20||r===0)&&(r="");break;case"width":case"height":case"vspace":case"checked":case"disabled":case"readonly":r===0&&(r="");break;case"hspace":r===-1&&(r="");break;case"maxlength":case"tabindex":(r===32768||r===2147483647||r==="32768")&&(r="");break;case"multiple":case"compact":case"noshade":case"nowrap":return r===65535?t:i;case"shape":r=r.toLowerCase();break;default:t.indexOf("on")===0&&r&&(r=(""+r).replace(/^function\s+\w+\(\)\s+\{\s+(.*)\s+\}$/,"$1"))}return r!==f&&r!==null&&r!==""?""+r:i},getPos:function(n,t){var e=this,u=0,f=0,i,r=e.doc,o;if(n=e.get(n),t=t||r.body,n){if(t===r.body&&n.getBoundingClientRect)return o=n.getBoundingClientRect(),t=e.boxModel?r.documentElement:r.body,u=o.left+(r.documentElement.scrollLeft||r.body.scrollLeft)-t.clientLeft,f=o.top+(r.documentElement.scrollTop||r.body.scrollTop)-t.clientTop,{x:u,y:f};for(i=n;i&&i!=t&&i.nodeType;)u+=i.offsetLeft||0,f+=i.offsetTop||0,i=i.offsetParent;for(i=n.parentNode;i&&i!=t&&i.nodeType;)u-=i.scrollLeft||0,f-=i.scrollTop||0,i=i.parentNode}return{x:u,y:f}},parseStyle:function(n){return this.styles.parse(n)},serializeStyle:function(n,t){return this.styles.serialize(n,t)},addStyle:function(n){var f=this,r=f.doc,u,t,i;if(f!==l.DOM&&r===document){if(i=l.DOM.addedStyles,i=i||[],i[n])return;i[n]=!0,l.DOM.addedStyles=i}t=r.getElementById("mceDefaultStyles"),t||(t=r.createElement("style"),t.id="mceDefaultStyles",t.type="text/css",u=r.getElementsByTagName("head")[0],u.firstChild?u.insertBefore(t,u.firstChild):u.appendChild(t)),t.styleSheet?t.styleSheet.cssText+=n:t.appendChild(r.createTextNode(n))},loadCSS:function(n){var i=this,t=i.doc,r;if(i!==l.DOM&&t===document){l.DOM.loadCSS(n);return}n||(n=""),r=t.getElementsByTagName("head")[0],a(n.split(","),function(n){var u;i.files[n]||(i.files[n]=!0,u=i.create("link",{rel:"stylesheet",href:n}),c&&t.documentMode&&t.recalc&&(u.onload=function(){t.recalc&&t.recalc(),u.onload=null}),r.appendChild(u))})},addClass:function(n,t){return this.run(n,function(n){var i;return t?this.hasClass(n,t)?n.className:(i=this.removeClass(n,t),n.className=i=(i!==""?i+" ":"")+t,i):0})},removeClass:function(n,t){var r=this,i;return r.run(n,function(n){var u;return r.hasClass(n,t)?(i||(i=new RegExp("(^|\\s+)"+t+"(\\s+|$)","g")),u=n.className.replace(i," "),u=p(u!=" "?u:""),n.className=u,u||(n.removeAttribute("class"),n.removeAttribute("className")),u):n.className})},hasClass:function(n,t){return(n=this.get(n),!n||!t)?!1:(" "+n.className+" ").indexOf(" "+t+" ")!==-1},toggleClass:function(n,i,r){r=r===t?!this.hasClass(n,i):r,this.hasClass(n,i)!==r&&(r?this.addClass(n,i):this.removeClass(n,i))},show:function(n){return this.setStyle(n,"display","block")},hide:function(n){return this.setStyle(n,"display","none")},isHidden:function(n){return n=this.get(n),!n||n.style.display=="none"||this.getStyle(n,"display")=="none"},uniqueId:function(n){return(n?n:"mce_")+this.counter++},setHTML:function(n,t){var i=this;return i.run(n,function(n){if(c){while(n.firstChild)n.removeChild(n.firstChild);try{n.innerHTML="<br />"+t,n.removeChild(n.firstChild)}catch(u){var r=i.create("div");r.innerHTML="<br />"+t,a(y(r.childNodes),function(t,i){i&&n.canHaveHTML&&n.appendChild(t)})}}else n.innerHTML=t;return t})},getOuterHTML:function(n){var t,i=this;return(n=i.get(n),!n)?null:n.nodeType===1&&i.hasOuterHTML?n.outerHTML:(t=(n.ownerDocument||i.doc).createElement("body"),t.appendChild(n.cloneNode(!0)),t.innerHTML)},setOuterHTML:function(n,t,i){var r=this;return r.run(n,function(n){function u(){var u,f;for(f=i.createElement("body"),f.innerHTML=t,u=f.lastChild;u;)r.insertAfter(u.cloneNode(!0),n),u=u.previousSibling;r.remove(n)}if(n.nodeType==1)if(i=i||n.ownerDocument||r.doc,c)try{n.nodeType==1&&r.hasOuterHTML?n.outerHTML=t:u()}catch(f){u()}else u()})},decode:e.decode,encode:e.encodeAllRaw,insertAfter:function(n,t){return t=this.get(t),this.run(n,function(n){var i,r;return i=t.parentNode,r=t.nextSibling,r?i.insertBefore(n,r):i.appendChild(n),n})},replace:function(n,t,i){var r=this;return r.run(t,function(t){return v(t,"array")&&(n=n.cloneNode(!0)),i&&a(y(t.childNodes),function(t){n.appendChild(t)}),t.parentNode.replaceChild(n,t)})},rename:function(n,t){var i=this,r;return n.nodeName!=t.toUpperCase()&&(r=i.create(t),a(i.getAttribs(n),function(t){i.setAttrib(r,t.nodeName,i.getAttrib(n,t.nodeName))}),i.replace(r,n,1)),r||n},findCommonAncestor:function(n,t){for(var i=n,r;i;){for(r=t;r&&i!=r;)r=r.parentNode;if(i==r)break;i=i.parentNode}return!i&&n.ownerDocument?n.ownerDocument.documentElement:i},toHex:function(n){return this.styles.toHex(s.trim(n))},run:function(n,t,i){var u=this,r;return(typeof n=="string"&&(n=u.get(n)),!n)?!1:(i=i||this,!n.nodeType&&(n.length||n.length===0))?(r=[],a(n,function(n,f){n&&(typeof n=="string"&&(n=u.get(n)),r.push(t.call(i,n,f)))}),r):t.call(i,n)},getAttribs:function(n){var t,i;return(n=this.get(n),!n)?[]:c?(t=[],n.nodeName=="OBJECT")?n.attributes:(n.nodeName==="OPTION"&&this.getAttrib(n,"selected")&&t.push({specified:1,nodeName:"selected"}),i=/<\/?[\w:\-]+ ?|=[\"][^\"]+\"|=\'[^\']+\'|=[\w\-]+|>/gi,n.cloneNode(!1).outerHTML.replace(i,"").replace(/[\w:\-]+/gi,function(n){t.push({specified:1,nodeName:n})}),t):n.attributes},isEmpty:function(n,t){var f=this,e,h,r,o,i,s=0;if(n=n.firstChild,n){o=new u(n,n.parentNode),t=t||f.schema?f.schema.getNonEmptyElements():null;do{if(r=n.nodeType,r===1){if(n.getAttribute("data-mce-bogus"))continue;if(i=n.nodeName.toLowerCase(),t&&t[i]){if(i==="br"){s++;continue}return!1}for(h=f.getAttribs(n),e=n.attributes.length;e--;)if(i=n.attributes[e].nodeName,i==="name"||i==="data-mce-bookmark")return!1}if(r==8||r===3&&!d.test(n.nodeValue))return!1}while(n=o.next())}return s<=1},createRng:function(){var n=this.doc;return n.createRange?n.createRange():new f(this)},nodeIndex:function(n,t){var u=0,r,f,i;if(n)for(r=n.nodeType,n=n.previousSibling,f=n;n;n=n.previousSibling)(i=n.nodeType,!t||i!=3||i!=r&&n.nodeValue.length)&&(u++,r=i);return u},split:function(n,t,i){function e(n){function o(n){var t=n.previousSibling&&n.previousSibling.nodeName=="SPAN",i=n.nextSibling&&n.nextSibling.nodeName=="SPAN";return t&&i}var i,t=n.childNodes,u=n.nodeType,f;if(u!=1||n.getAttribute("data-mce-type")!="bookmark"){for(i=t.length-1;i>=0;i--)e(t[i]);if(u!=9){if(u==3&&n.nodeValue.length>0){if(f=p(n.nodeValue).length,!r.isBlock(n.parentNode)||f>0||f===0&&o(n))return}else if(u==1&&(t=n.childNodes,t.length==1&&t[0]&&t[0].nodeType==1&&t[0].getAttribute("data-mce-type")=="bookmark"&&n.parentNode.insertBefore(t[0],n),t.length||/^(br|hr|input|img)$/i.test(n.nodeName)))return;r.remove(n)}return n}}var r=this,u=r.createRng(),o,s,f;if(n&&t)return u.setStart(n.parentNode,r.nodeIndex(n)),u.setEnd(t.parentNode,r.nodeIndex(t)),o=u.extractContents(),u=r.createRng(),u.setStart(t.parentNode,r.nodeIndex(t)+1),u.setEnd(n.parentNode,r.nodeIndex(n)+1),s=u.extractContents(),f=n.parentNode,f.insertBefore(e(o),n),i?f.replaceChild(i,t):f.insertBefore(t,n),f.insertBefore(e(s),n),r.remove(n),i||t},bind:function(n,t,i,r){var u=this,f;if(s.isArray(n)){for(f=n.length;f--;)n[f]=u.bind(n[f],t,i,r);return n}return u.settings.collect&&(n===u.doc||n===u.win)&&u.boundEvents.push([n,t,i,r]),u.events.bind(n,t,i,r||u)},unbind:function(n,t,i){var f=this,r,u;if(s.isArray(n)){for(r=n.length;r--;)n[r]=f.unbind(n[r],t,i);return n}if(f.boundEvents&&(n===f.doc||n===f.win))for(r=f.boundEvents.length;r--;)u=f.boundEvents[r],n!=u[0]||t&&t!=u[1]||i&&i!=u[2]||this.events.unbind(u[0],u[1],u[2]);return this.events.unbind(n,t,i)},fire:function(n,t,i){return this.events.fire(n,t,i)},getContentEditable:function(n){var t;return n.nodeType!=1?null:(t=n.getAttribute("data-mce-contenteditable"),t&&t!=="inherit")?t:n.contentEditable!=="inherit"?n.contentEditable:null},destroy:function(){var t=this,r,i;if(t.boundEvents){for(r=t.boundEvents.length;r--;)i=t.boundEvents[r],this.events.unbind(i[0],i[1],i[2]);t.boundEvents=null}n.setDocument&&n.setDocument(),t.win=t.doc=t.root=t.events=t.frag=null},dumpRng:function(n){return"startContainer: "+n.startContainer.nodeName+", startOffset: "+n.startOffset+", endContainer: "+n.endContainer.nodeName+", endOffset: "+n.endOffset},_findSib:function(n,t,i){var u=this,r=t;if(n)for(typeof r=="string"&&(r=function(n){return u.is(n,t)}),n=n[i];n;n=n[i])if(r(n))return n;return null}},l.DOM=new l(document),l}),i("tinymce/dom/ScriptLoader",["tinymce/dom/DOMUtils","tinymce/util/Tools"],function(n,t){function r(){function a(n,t){function e(){f.remove(r),i&&(i.onreadystatechange=i.onload=i=null),t()}function o(){typeof console!="undefined"&&console.log&&console.log("Failed to load: "+n)}var f=u,i,r;r=f.uniqueId(),i=document.createElement("script"),i.id=r,i.type="text/javascript",i.src=n,"onreadystatechange"in i?i.onreadystatechange=function(){/loaded|complete/.test(i.readyState)&&e()}:i.onload=e,i.onerror=o,(document.getElementsByTagName("head")[0]||document.body).appendChild(i)}var l=0,s=1,r=2,n={},h=[],t={},e=[],o=0,c;this.isDone=function(t){return n[t]==r},this.markDone=function(t){n[t]=r},this.add=this.load=function(i,r,u){var f=n[i];f==c&&(h.push(i),n[i]=l),r&&(t[i]||(t[i]=[]),t[i].push({func:r,scope:u||this}))},this.loadQueue=function(n,t){this.loadScripts(h,n,t)},this.loadScripts=function(u,h,l){function y(n){i(t[n],function(n){n.func.call(n.scope)}),t[n]=c}var v;e.push({func:h,scope:l||this}),v=function(){var t=f(u);u.length=0,i(t,function(t){if(n[t]==r){y(t);return}n[t]!=s&&(n[t]=s,o++,a(t,function(){n[t]=r,o--,y(t),v()}))}),o||(i(e,function(n){n.func.call(n.scope)}),e.length=0)},v()}}var u=n.DOM,i=t.each,f=t.grep;return r.ScriptLoader=new r,r}),i("tinymce/AddOnManager",["tinymce/dom/ScriptLoader","tinymce/util/Tools"],function(n,i){function r(){var n=this;n.items=[],n.urls={},n.lookup={}}var u=i.each;return r.prototype={get:function(n){return this.lookup[n]?this.lookup[n].instance:t},dependencies:function(n){var t;return this.lookup[n]&&(t=this.lookup[n].dependencies),t||[]},requireLangPack:function(t,i){if(r.language&&r.languageLoad!==!1){if(i&&new RegExp("([, ]|\\b)"+r.language+"([, ]|\\b)").test(i)===!1)return;n.ScriptLoader.add(this.urls[t]+"/langs/"+r.language+".js")}},add:function(n,t,i){return this.items.push(t),this.lookup[n]={instance:t,dependencies:i},t},createUrl:function(n,t){return typeof t=="object"?t:{prefix:n.prefix,resource:t,suffix:n.suffix}},addComponents:function(t,i){var r=this.urls[t];u(i,function(t){n.ScriptLoader.add(r+"/"+t)})},load:function(i,f,e,o){function c(){var r=h.dependencies(i);u(r,function(n){var i=h.createUrl(f,n);h.load(i.resource,i,t,t)}),e&&(o?e.call(o):e.call(n))}var h=this,s=f;h.urls[i]||(typeof f=="object"&&(s=f.prefix+f.resource+f.suffix),s.indexOf("/")!==0&&s.indexOf("://")==-1&&(s=r.baseURL+"/"+s),h.urls[i]=s.substring(0,s.lastIndexOf("/")),h.lookup[i]?c():n.ScriptLoader.add(s,c,o))}},r.PluginManager=new r,r.ThemeManager=new r,r}),i("tinymce/html/Node",[],function(){function t(n,t,i){var r,u,f=i?"lastChild":"firstChild",e=i?"prev":"next";if(n[f])return n[f];if(n!==t){if(r=n[e],r)return r;for(u=n.parent;u&&u!==t;u=u.parent)if(r=u[e],r)return r}}function n(n,t){this.name=n,this.type=t,t===1&&(this.attributes=[],this.attributes.map={})}var i=/^[ \t\r\n]*$/,r={"#text":3,"#comment":8,"#cdata":4,"#pi":7,"#doctype":10,"#document-fragment":11};return n.prototype={replace:function(n){var t=this;return n.parent&&n.remove(),t.insert(n,t),t.remove(),t},attr:function(n,t){var u=this,i,r,f;if(typeof n!="string"){for(r in n)u.attr(r,n[r]);return u}if(i=u.attributes){if(t!==f){if(t===null){if(n in i.map)for(delete i.map[n],r=i.length;r--;)if(i[r].name===n)return i=i.splice(r,1),u;return u}if(n in i.map){for(r=i.length;r--;)if(i[r].name===n){i[r].value=t;break}}else i.push({name:n,value:t});return i.map[n]=t,u}return i.map[n]}},clone:function(){var r=this,u=new n(r.name,r.type),f,o,e,t,i;if(e=r.attributes){for(i=[],i.map={},f=0,o=e.length;f<o;f++)t=e[f],t.name!=="id"&&(i[i.length]={name:t.name,value:t.value},i.map[t.name]=t.value);u.attributes=i}return u.value=r.value,u.shortEnded=r.shortEnded,u},wrap:function(n){var t=this;return t.parent.insert(n,t),n.append(t),t},unwrap:function(){for(var t=this,i,n=t.firstChild;n;)i=n.next,t.insert(n,t,!0),n=i;t.remove()},remove:function(){var n=this,t=n.parent,i=n.next,r=n.prev;return t&&(t.firstChild===n?(t.firstChild=i,i&&(i.prev=null)):r.next=i,t.lastChild===n?(t.lastChild=r,r&&(r.next=null)):i.prev=r,n.parent=n.next=n.prev=null),n},append:function(n){var t=this,i;return n.parent&&n.remove(),i=t.lastChild,i?(i.next=n,n.prev=i,t.lastChild=n):t.lastChild=t.firstChild=n,n.parent=t,n},insert:function(n,t,i){var r;return n.parent&&n.remove(),r=t.parent||this,i?(t===r.firstChild?r.firstChild=n:t.prev.next=n,n.prev=t.prev,n.next=t,t.prev=n):(t===r.lastChild?r.lastChild=n:t.next.prev=n,n.next=t.next,n.prev=t,t.next=n),n.parent=r,n},getAll:function(n){for(var r=this,u=[],i=r.firstChild;i;i=t(i,r))i.name===n&&u.push(i);return u},empty:function(){var i=this,r,u,n;if(i.firstChild){for(r=[],n=i.firstChild;n;n=t(n,i))r.push(n);for(u=r.length;u--;)n=r[u],n.parent=n.firstChild=n.lastChild=n.next=n.prev=null}return i.firstChild=i.lastChild=null,i},isEmpty:function(n){var e=this,r=e.firstChild,u,f;if(r)do{if(r.type===1){if(r.attributes.map["data-mce-bogus"])continue;if(n[r.name])return!1;for(u=r.attributes.length;u--;)if(f=r.attributes[u].name,f==="name"||f.indexOf("data-mce-")===0)return!1}if(r.type===8||r.type===3&&!i.test(r.value))return!1}while(r=t(r,e));return!0},walk:function(n){return t(this,null,n)}},n.create=function(t,i){var u,f;if(u=new n(t,r[t]||1),i)for(f in i)u.attr(f,i[f]);return u},n}),i("tinymce/html/Schema",["tinymce/util/Tools"],function(n){function t(n,t){return n?n.split(t||" "):[]}function s(n){function u(n,i,r){function h(n){for(var i={},t=0,r=n.length;t<r;t++)i[n[t]]={};return i}var e,u,o,f=arguments;for(r=r||[],i=i||"",typeof r=="string"&&(r=t(r)),u=3;u<f.length;u++)typeof f[u]=="string"&&(f[u]=t(f[u])),r.push.apply(r,f[u]);for(n=t(n),e=n.length;e--;)o=[].concat(c,t(i)),s[n[e]]={attributes:h(o),attributesOrder:o,children:h(r)}}function f(n,i){var u,f,r,e;for(n=t(n),u=n.length,i=t(i);u--;)for(f=s[n[u]],r=0,e=i.length;r<e;r++)f.attributes[i[r]]={},f.attributesOrder.push(i[r])}var s={},c,v,h,o,e,l,a;return r[n]?r[n]:(c=t("id accesskey class dir lang style tabindex title"),v=t("onabort onblur oncancel oncanplay oncanplaythrough onchange onclick onclose oncontextmenu oncuechange ondblclick ondrag ondragend ondragenter ondragleave ondragover ondragstart ondrop ondurationchange onemptied onended onerror onfocus oninput oninvalid onkeydown onkeypress onkeyup onload onloadeddata onloadedmetadata onloadstart onmousedown onmousemove onmouseout onmouseover onmouseup onmousewheel onpause onplay onplaying onprogress onratechange onreset onscroll onseeked onseeking onseeking onselect onshow onstalled onsubmit onsuspend ontimeupdate onvolumechange onwaiting"),h=t("address blockquote div dl fieldset form h1 h2 h3 h4 h5 h6 hr menu ol p pre table ul"),o=t("a abbr b bdo br button cite code del dfn em embed i iframe img input ins kbd label map noscript object q s samp script select small span strong sub sup textarea u var #text #comment"),n!="html4"&&(c.push.apply(c,t("contenteditable contextmenu draggable dropzone hidden spellcheck translate")),h.push.apply(h,t("article aside details dialog figure header footer hgroup section nav")),o.push.apply(o,t("audio canvas command datalist mark meter output progress time wbr video ruby bdi keygen"))),n!="html5-strict"&&(c.push("xml:lang"),a=t("acronym applet basefont big font strike tt"),o.push.apply(o,a),i(a,function(n){u(n,"",o)}),l=t("center dir isindex noframes"),h.push.apply(h,l),e=[].concat(h,o),i(l,function(n){u(n,"",e)})),e=e||[].concat(h,o),u("html","manifest","head body"),u("head","","base command link meta noscript script style title"),u("title hr noscript br"),u("base","href target"),u("link","href rel media hreflang type sizes hreflang"),u("meta","name http-equiv content charset"),u("style","media type scoped"),u("script","src async defer type charset"),u("body","onafterprint onbeforeprint onbeforeunload onblur onerror onfocus onhashchange onload onmessage onoffline ononline onpagehide onpageshow onpopstate onresize onscroll onstorage onunload",e),u("address dt dd div caption","",e),u("h1 h2 h3 h4 h5 h6 pre p abbr code var samp kbd sub sup i b u bdo span legend em strong small s cite dfn","",o),u("blockquote","cite",e),u("ol","reversed start type","li"),u("ul","","li"),u("li","value",e),u("dl","","dt dd"),u("a","href target rel media hreflang type",o),u("q","cite",o),u("ins del","cite datetime",e),u("img","src alt usemap ismap width height"),u("iframe","src name width height",e),u("embed","src type width height"),u("object","data type typemustmatch name usemap form width height",e,"param"),u("param","name value"),u("map","name",e,"area"),u("area","alt coords shape href target rel media hreflang type"),u("table","border","caption colgroup thead tfoot tbody tr"+(n=="html4"?" col":"")),u("colgroup","span","col"),u("col","span"),u("tbody thead tfoot","","tr"),u("tr","","td th"),u("td","colspan rowspan headers",e),u("th","colspan rowspan headers scope abbr",e),u("form","accept-charset action autocomplete enctype method name novalidate target",e),u("fieldset","disabled form name",e,"legend"),u("label","form for",o),u("input","accept alt autocomplete checked dirname disabled form formaction formenctype formmethod formnovalidate formtarget height list max maxlength min multiple name pattern readonly required size src step type value width"),u("button","disabled form formaction formenctype formmethod formnovalidate formtarget name type value",n=="html4"?e:o),u("select","disabled form multiple name required size","option optgroup"),u("optgroup","disabled label","option"),u("option","disabled label selected value"),u("textarea","cols dirname disabled form maxlength name readonly required rows wrap"),u("menu","type label",e,"li"),u("noscript","",e),n!="html4"&&(u("wbr"),u("ruby","",o,"rt rp"),u("figcaption","",e),u("mark rt rp summary bdi","",o),u("canvas","width height",e),u("video","src crossorigin poster preload autoplay mediagroup loop muted controls width height",e,"track source"),u("audio","src crossorigin preload autoplay mediagroup loop muted controls",e,"track source"),u("source","src type media"),u("track","kind src srclang label default"),u("datalist","",o,"option"),u("article section nav aside header footer","",e),u("hgroup","","h1 h2 h3 h4 h5 h6"),u("figure","",e,"figcaption"),u("time","datetime",o),u("dialog","open",e),u("command","type label icon disabled checked radiogroup command"),u("output","for form name",o),u("progress","value max",o),u("meter","value min max low high optimum",o),u("details","open",e,"summary"),u("keygen","autofocus challenge disabled form keytype name")),n!="html5-strict"&&(f("script","language xml:space"),f("style","xml:space"),f("object","declare classid codebase codetype archive standby align border hspace vspace"),f("param","valuetype type"),f("a","charset name rev shape coords"),f("br","clear"),f("applet","codebase archive code object alt name width height align hspace vspace"),f("img","name longdesc align border hspace vspace"),f("iframe","longdesc frameborder marginwidth marginheight scrolling align"),f("font basefont","size color face"),f("input","usemap align"),f("select","onchange"),f("textarea"),f("h1 h2 h3 h4 h5 h6 div p legend caption","align"),f("ul","type compact"),f("li","type"),f("ol dl menu dir","compact"),f("pre","width xml:space"),f("hr","align noshade size width"),f("isindex","prompt"),f("table","summary width frame rules cellspacing cellpadding align bgcolor"),f("col","width align char charoff valign"),f("colgroup","width align char charoff valign"),f("thead","align char charoff valign"),f("tr","align char charoff valign bgcolor"),f("th","axis align char charoff valign nowrap bgcolor width height"),f("form","accept"),f("td","abbr axis scope align char charoff valign nowrap bgcolor width height"),f("tfoot","align char charoff valign"),f("tbody","align char charoff valign"),f("area","nohref"),f("body","background bgcolor text link vlink alink")),n!="html4"&&(f("input button select textarea","autofocus"),f("input textarea","placeholder"),f("a","download"),f("link script img","crossorigin"),f("iframe","srcdoc sandbox seamless allowfullscreen")),i(t("a form meter progress dfn"),function(n){s[n]&&delete s[n].children[n]}),delete s.caption.children.table,r[n]=s,s)}var r={},u=n.makeMap,i=n.each,f=n.extend,e=n.explode,o=n.inArray;return function(n){function a(t,i,e){var o=n[t];return o?o=u(o,",",u(o.toUpperCase()," ")):(o=r[t],o||(o=u(i," ",u(i.toUpperCase()," ")),o=f(o,e),r[t]=o)),o}function ot(n){return new RegExp("^"+n.replace(/([?+*])/g,".$1")+"$")}function p(n){var b,it,k,rt,r,i,e,a,y,f,d,l,s,c,g,p,nt,tt,w,ut=/[*?+]/;if(n)for(n=t(n,","),h["@"]&&(p=h["@"].attributes,nt=h["@"].attributesOrder),b=0,it=n.length;b<it;b++)if(r=/^([#+\-])?([^\[!\/]+)(?:\/([^\[!]+))?(?:(!?)\[([^\]]+)\])?$/.exec(n[b]),r){if(c=r[1],y=r[2],g=r[3],a=r[5],l={},s=[],i={attributes:l,attributesOrder:s},c==="#"&&(i.paddEmpty=!0),c==="-"&&(i.removeEmpty=!0),r[4]==="!"&&(i.removeEmptyAttrs=!0),p){for(tt in p)l[tt]=p[tt];s.push.apply(s,nt)}if(a)for(a=t(a,"|"),k=0,rt=a.length;k<rt;k++)if(r=/^([!\-])?(\w+::\w+|[^=:<]+)?(?:([=:<])(.*))?$/.exec(a[k]),r){if(e={},d=r[1],f=r[2].replace(/::/g,":"),c=r[3],w=r[4],d==="!"&&(i.attributesRequired=i.attributesRequired||[],i.attributesRequired.push(f),e.required=!0),d==="-"){delete l[f],s.splice(o(s,f),1);continue}c&&(c==="="&&(i.attributesDefault=i.attributesDefault||[],i.attributesDefault.push({name:f,value:w}),e.defaultValue=w),c===":"&&(i.attributesForced=i.attributesForced||[],i.attributesForced.push({name:f,value:w}),e.forcedValue=w),c==="<"&&(e.validValues=u(w,"?"))),ut.test(f)?(i.attributePatterns=i.attributePatterns||[],e.pattern=ot(f),i.attributePatterns.push(e)):(l[f]||s.push(f),l[f]=e)}p||y!="@"||(p=l,nt=s),g&&(i.outputName=y,h[g]=i),ut.test(y)?(i.pattern=ot(y),v.push(i)):h[y]=i}}function st(n){h={},v=[],p(n),i(b,function(n,t){l[t]=n.children})}function ht(n){var r=/^(~)?(.+)$/;n&&i(t(n,","),function(n){var o=r.exec(n),s=o[1]==="~",e=s?"span":"div",t=o[2],u;l[t]=l[e],ft[t]=e,s||(y[t.toUpperCase()]={},y[t]={}),h[t]||(u=h[e],u=f({},u),delete u.removeEmptyAttrs,delete u.removeEmpty,h[t]=u),i(l,function(n){n[e]&&(n[t]=n[e])})})}function g(n){var r=/^([+\-]?)(\w+)\[([^\]]+)\]$/;n&&i(t(n,","),function(n){var u=r.exec(n),f,e;u&&(e=u[1],f=e?l[u[2]]:l[u[2]]={"#comment":{}},f=l[u[2]],i(t(u[3],"|"),function(n){e==="-"?delete f[n]:f[n]={}}))})}function nt(n){var t=h[n],i;if(t)return t;for(i=v.length;i--;)if(t=v[i],t.pattern.test(n))return t}var c=this,h={},l={},v=[],w,b,tt,it,k,rt,y,ut,d,ft={},et={};n=n||{},b=s(n.schema),n.verify_html===!1&&(n.valid_elements="*[*]"),n.valid_styles&&(w={},i(n.valid_styles,function(n,t){w[t]=e(n)})),tt=a("whitespace_elements","pre script noscript style textarea video audio iframe object"),it=a("self_closing_elements","colgroup dd dt li option p td tfoot th thead tr"),k=a("short_ended_elements","area base basefont br col frame hr img input isindex link meta param embed source wbr track"),rt=a("boolean_attributes","checked compact declare defer disabled ismap multiple nohref noresize noshade nowrap readonly selected autoplay loop controls"),ut=a("non_empty_elements","td th iframe video audio object script",k),d=a("text_block_elements","h1 h2 h3 h4 h5 h6 p div address pre form blockquote center dir fieldset header footer article section hgroup aside nav figure"),y=a("block_elements","hr table tbody thead tfoot th tr td li ol ul caption dl dt dd noscript menu isindex samp option datalist select optgroup",d),i((n.special||"script noscript style textarea").split(" "),function(n){et[n]=new RegExp("<\/"+n+"[^>]*>","gi")}),n.valid_elements?st(n.valid_elements):(i(b,function(n,t){h[t]={attributes:n.attributes,attributesOrder:n.attributesOrder},l[t]=n.children}),n.schema!="html5"&&i(t("strong/b em/i"),function(n){n=t(n,"/"),h[n[1]].outputName=n[0]}),h.img.attributesDefault=[{name:"alt",value:""}],i(t("ol ul sub sup blockquote span font a table tbody tr strong em b i"),function(n){h[n]&&(h[n].removeEmpty=!0)}),i(t("p h1 h2 h3 h4 h5 h6 th td pre div address caption"),function(n){h[n].paddEmpty=!0}),i(t("span"),function(n){h[n].removeEmptyAttrs=!0})),ht(n.custom_elements),g(n.valid_children),p(n.extended_valid_elements),g("+ol[ul|ol],+ul[ul|ol]"),n.invalid_elements&&i(e(n.invalid_elements),function(n){h[n]&&delete h[n]}),nt("span")||p("span[!data-mce-type|*]"),c.children=l,c.styles=w,c.getBoolAttrs=function(){return rt},c.getBlockElements=function(){return y},c.getTextBlockElements=function(){return d},c.getShortEndedElements=function(){return k},c.getSelfClosingElements=function(){return it},c.getNonEmptyElements=function(){return ut},c.getWhiteSpaceElements=function(){return tt},c.getSpecialElements=function(){return et},c.isValidChild=function(n,t){var i=l[n];return!!(i&&i[t])},c.isValid=function(n,t){var i,r,u=nt(n);if(u)if(t){if(u.attributes[t])return!0;if(i=u.attributePatterns,i)for(r=i.length;r--;)if(i[r].pattern.test(n))return!0}else return!0;return!1},c.getElementRule=nt,c.getCustomElements=function(){return ft},c.addValidElements=p,c.setValidElements=st,c.addCustomElements=ht,c.addValidChildren=g,c.elements=h}}),i("tinymce/html/SaxParser",["tinymce/html/Schema","tinymce/html/Entities","tinymce/util/Tools"],function(n,t,i){var r=i.each;return function(u,f){var e=this,o=function(){};u=u||{},e.schema=f=f||new n,u.fix_self_closing!==!1&&(u.fix_self_closing=!0),r("comment cdata text start end pi doctype".split(" "),function(n){n&&(e[n]=u[n]||o)}),e.parse=function(n){function dt(n){for(var i,t=l.length;t--;)if(l[t].name===n)break;if(t>=0){for(i=l.length-1;i>=t;i--)n=l[i],n.valid&&c.end(n.name);l.length=t}}function ni(n,t,i,r,f){var e,h,s;if(t=t.toLowerCase(),i=t in ct?t:ot(i||r||f||""),k&&!g&&t.indexOf("data-")!==0){if(e=lt[t],!e&&nt){for(h=nt.length;h--;)if(e=nt[h],e.pattern.test(t))break;h===-1&&(e=null)}if(!e)return;if(e.validValues&&!(i in e.validValues))return}if(gt[t]&&!u.allow_script_urls){s=i.replace(/[\s\u0000-\u001F]+/g,"");try{if(s=decodeURIComponent(s),kt.test(s))return}catch(c){if(s=unescape(s),kt.test(s))return}}o.map[t]=i,o.push({name:t,value:i})}var c=this,e,h=0,r,ut,l=[],o,s,d,y,g,st,ht,ct,ft,k,p,a,w,b,lt,nt,tt,it,rt,at,vt,et,yt,pt,v,wt=0,ot=t.decode,bt,gt=i.makeMap("src,href"),kt=/(java|vb)script:/i;for(et=new RegExp("<(?:(?:!--([\\w\\W]*?)-->)|(?:!\\[CDATA\\[([\\w\\W]*?)\\]\\]>)|(?:!DOCTYPE([\\w\\W]*?)>)|(?:\\?([^\\s\\/<>]+) ?([\\w\\W]*?)[?/]>)|(?:\\/([^>]+)>)|(?:([A-Za-z0-9\\-\\:\\.]+)((?:\\s+[^\"'>]+(?:(?:\"[^\"]*\")|(?:'[^']*')|[^>]*))*|\\/|\\s+)>))","g"),yt=/([\w:\-]+)(?:\s*=\s*(?:(?:\"((?:[^\"])*)\")|(?:\'((?:[^\'])*)\')|([^>\s]+)))?/g,ht=f.getShortEndedElements(),vt=u.self_closing_elements||f.getSelfClosingElements(),ct=f.getBoolAttrs(),k=u.validate,st=u.remove_internals,bt=u.fix_self_closing,pt=f.getSpecialElements();e=et.exec(n);){if(h<e.index&&c.text(ot(n.substr(h,e.index-h))),r=e[6])r=r.toLowerCase(),r.charAt(0)===":"&&(r=r.substr(1)),dt(r);else if(r=e[7]){if(r=r.toLowerCase(),r.charAt(0)===":"&&(r=r.substr(1)),ft=r in ht,bt&&vt[r]&&l.length>0&&l[l.length-1].name===r&&dt(r),!k||(p=f.getElementRule(r))){if(a=!0,k&&(lt=p.attributes,nt=p.attributePatterns),(b=e[8])?(g=b.indexOf("data-mce-type")!==-1,g&&st&&(a=!1),o=[],o.map={},b.replace(yt,ni)):(o=[],o.map={}),k&&!g){if(tt=p.attributesRequired,it=p.attributesDefault,rt=p.attributesForced,at=p.removeEmptyAttrs,at&&!o.length&&(a=!1),rt)for(s=rt.length;s--;)w=rt[s],y=w.name,v=w.value,v==="{$uid}"&&(v="mce_"+wt++),o.map[y]=v,o.push({name:y,value:v});if(it)for(s=it.length;s--;)w=it[s],y=w.name,y in o.map||(v=w.value,v==="{$uid}"&&(v="mce_"+wt++),o.map[y]=v,o.push({name:y,value:v}));if(tt){for(s=tt.length;s--;)if(tt[s]in o.map)break;s===-1&&(a=!1)}o.map["data-mce-bogus"]&&(a=!1)}a&&c.start(r,o,ft)}else a=!1;if(ut=pt[r]){ut.lastIndex=h=e.index+e[0].length,(e=ut.exec(n))?(a&&(d=n.substr(h,e.index-h)),h=e.index+e[0].length):(d=n.substr(h),h=n.length),a&&(d.length>0&&c.text(d,!0),c.end(r)),et.lastIndex=h;continue}ft||(b&&b.indexOf("/")==b.length-1?a&&c.end(r):l.push({name:r,valid:a}))}else(r=e[1])?(r.charAt(0)===">"&&(r=" "+r),u.allow_conditional_comments||r.substr(0,3)!=="[if"||(r=" "+r),c.comment(r)):(r=e[2])?c.cdata(r):(r=e[3])?c.doctype(r):(r=e[4])&&c.pi(r,e[5]);h=e.index+e[0].length}for(h<n.length&&c.text(ot(n.substr(h))),s=l.length-1;s>=0;s--)r=l[s],r.valid&&c.end(r.name)}}}),i("tinymce/html/DomParser",["tinymce/html/Node","tinymce/html/Schema","tinymce/html/SaxParser","tinymce/util/Tools"],function(n,t,i,r){var u=r.makeMap,f=r.each,e=r.explode,o=r.extend;return function(r,s){function y(t){var v,i,f,e,y,l,a,c,o,p,b,w,r,k;for(b=u("tr,td,th,tbody,thead,tfoot,table"),p=s.getNonEmptyElements(),w=s.getTextBlockElements(),v=0;v<t.length;v++)if(i=t[v],i.parent&&!i.fixed){if(w[i.name]&&i.parent.name=="li"){for(r=i.next;r;){if(w[r.name])r.name="li",r.fixed=!0,i.parent.insert(r,i.parent);else break;r=r.next}i.unwrap(i);continue}for(e=[i],f=i.parent;f&&!s.isValidChild(f.name,i.name)&&!b[f.name];f=f.parent)e.push(f);if(f&&e.length>1){for(e.reverse(),y=l=h.filterNode(e[0].clone()),o=0;o<e.length-1;o++){for(s.isValidChild(l.name,e[o].name)?(a=h.filterNode(e[o].clone()),l.append(a)):a=l,c=e[o].firstChild;c&&c!=e[o+1];)k=c.next,a.append(c),c=k;l=a}y.isEmpty(p)?f.insert(i,e[0],!0):(f.insert(y,e[0],!0),f.insert(i,y)),f=e[0],(f.isEmpty(p)||f.firstChild===f.lastChild&&f.firstChild.name==="br")&&f.empty().remove()}else if(i.parent){if(i.name==="li"){if(r=i.prev,r&&(r.name==="ul"||r.name==="ul")){r.append(i);continue}if(r=i.next,r&&(r.name==="ul"||r.name==="ul")){r.insert(i,r.firstChild,!0);continue}i.wrap(h.filterNode(new n("ul",1)));continue}s.isValidChild(i.parent.name,"div")&&s.isValidChild("div",i.name)?i.wrap(h.filterNode(new n("div",1))):i.name==="style"||i.name==="script"?i.empty().remove():i.unwrap()}}}var h=this,v={},c=[],l={},a={};r=r||{},r.validate="validate"in r?r.validate:!0,r.root_name=r.root_name||"body",h.schema=s=s||new t,h.filterNode=function(n){var r,t,i;for((t in v)&&(i=l[t],i?i.push(n):l[t]=[n]),r=c.length;r--;)t=c[r].name,t in n.attributes.map&&(i=a[t],i?i.push(n):a[t]=[n]);return n},h.addNodeFilter=function(n,t){f(e(n),function(n){var i=v[n];i||(v[n]=i=[]),i.push(t)})},h.addAttributeFilter=function(n,t){f(e(n),function(n){for(var i=0;i<c.length;i++)if(c[i].name===n){c[i].callbacks.push(t);return}c.push({name:n,callbacks:[t]})})},h.parse=function(t,f){function wt(){function u(t){t&&(n=t.firstChild,n&&n.type==3&&(n.value=n.value.replace(ut,"")),n=t.lastChild,n&&n.type==3&&(n.value=n.value.replace(ft,"")))}var n=d.firstChild,i,t;if(s.isValidChild(d.name,et.toLowerCase())){while(n)i=n.next,n.type!=3&&(n.type!=1||n.name==="p"||tt[n.name]||n.attr("data-mce-type"))?(u(t),t=null):t?t.append(n):(t=k(et,1),t.attr(r.forced_root_block_attrs),d.insert(t,n),t.append(n)),n=i;u(t)}}function k(t,i){var r=new n(t,i),u;return t in v&&(u=l[t],u?u.push(r):l[t]=[r]),r}function lt(n){for(var i,r,t=n.prev;t&&t.type===3;)i=t.value.replace(ft,""),i.length>0?(t.value=i,t=t.prev):(r=t.prev,t.remove(),t=r)}function bt(n){var t,i={};for(t in n)t!=="li"&&t!="p"&&(i[t]=n[t]);return i}var at,d,e,w,b,it,h,vt,p,rt,nt,tt,ut,ot=[],g,ft,yt,st,ht,ct,pt,et;if(f=f||{},l={},a={},tt=o(u("script,style,head,html,body,title,meta,param"),s.getBlockElements()),pt=s.getNonEmptyElements(),ct=s.children,nt=r.validate,et="forced_root_block"in f?f.forced_root_block:r.forced_root_block,ht=s.getWhiteSpaceElements(),ut=/^[ \t\r\n]+/,ft=/[ \t\r\n]+$/,yt=/[ \t\r\n]+/g,st=/^[ \t\r\n]+$/,at=new i({validate:nt,allow_script_urls:r.allow_script_urls,allow_conditional_comments:r.allow_conditional_comments,self_closing_elements:bt(s.getSelfClosingElements()),cdata:function(n){e.append(k("#cdata",4)).value=n},text:function(n,t){var i;g||e.type==11||(n=n.replace(yt," "),e.lastChild&&tt[e.lastChild.name]&&(n=n.replace(ut,""))),n.length!==0&&(i=k("#text",3),i.raw=!!t,e.append(i).value=n)},comment:function(n){e.append(k("#comment",8)).value=n},pi:function(n,t){e.append(k(n,7)).value=t,lt(e)},doctype:function(n){var t;t=e.append(k("#doctype",10)),t.value=n,lt(e)},start:function(n,t,i){var r,f,o,u,h;if(o=nt?s.getElementRule(n):{},o){for(r=k(o.outputName||n,1),r.attributes=t,r.shortEnded=i,e.append(r),h=ct[e.name],h&&ct[r.name]&&!h[r.name]&&ot.push(r),f=c.length;f--;)u=c[f].name,u in t.map&&(p=a[u],p?p.push(r):a[u]=[r]);tt[n]&&lt(r),i||(e=r),!g&&ht[n]&&(g=!0)}},end:function(t){var i,f,r,u,o;if(f=nt?s.getElementRule(t):{},f){if(tt[t]&&!g){if(i=e.firstChild,i&&i.type===3)if(r=i.value.replace(ut,""),r.length>0)i.value=r,i=i.next;else for(u=i.next,i.remove(),i=u;i&&i.type===3;)r=i.value,u=i.next,(r.length===0||st.test(r))&&(i.remove(),i=u),i=u;if(i=e.lastChild,i&&i.type===3)if(r=i.value.replace(ft,""),r.length>0)i.value=r,i=i.prev;else for(u=i.prev,i.remove(),i=u;i&&i.type===3;)r=i.value,u=i.prev,(r.length===0||st.test(r))&&(i.remove(),i=u),i=u}if(g&&ht[t]&&(g=!1),(f.removeEmpty||f.paddEmpty)&&e.isEmpty(pt))if(f.paddEmpty)e.empty().append(new n("#text","3")).value="\u00a0";else if(!e.attributes.map.name&&!e.attributes.map.id){o=e.parent,e.empty().remove(),e=o;return}e=e.parent}}},s),d=e=new n(f.context||r.root_name,11),at.parse(t),nt&&ot.length&&(f.context?f.invalid=!0:y(ot)),et&&(d.name=="body"||f.isRootContent)&&wt(),!f.invalid){for(rt in l){for(p=v[rt],w=l[rt],h=w.length;h--;)w[h].parent||w.splice(h,1);for(b=0,it=p.length;b<it;b++)p[b](w,rt,f)}for(b=0,it=c.length;b<it;b++)if(p=c[b],p.name in a){for(w=a[p.name],h=w.length;h--;)w[h].parent||w.splice(h,1);for(h=0,vt=p.callbacks.length;h<vt;h++)p.callbacks[h](w,p.name,f)}}return d},r.remove_trailing_brs&&h.addNodeFilter("br",function(t){var e,v=t.length,r,l=o({},s.getBlockElements()),y=s.getNonEmptyElements(),i,f,u,h,c,a;for(l.body=1,e=0;e<v;e++)if(r=t[e],i=r.parent,l[r.parent.name]&&r===i.lastChild){for(u=r.prev;u;){if(h=u.name,h!=="span"||u.attr("data-mce-type")!=="bookmark"){if(h!=="br")break;if(h==="br"){r=null;break}}u=u.prev}r&&(r.remove(),i.isEmpty(y)&&(c=s.getElementRule(i.name),c&&(c.removeEmpty?i.remove():c.paddEmpty&&(i.empty().append(new n("#text",3)).value="\u00a0"))))}else{for(f=r;i&&i.firstChild===f&&i.lastChild===f;){if(f=i,l[i.name])break;i=i.parent}f===i&&(a=new n("#text",3),a.value="\u00a0",r.replace(a))}}),r.allow_html_in_named_anchor||h.addAttributeFilter("id,name",function(n){for(var r=n.length,i,u,f,t;r--;)if(t=n[r],t.name==="a"&&t.firstChild&&!t.attr("href")){f=t.parent,i=t.lastChild;do u=i.prev,f.insert(i,t),i=u;while(i)}})}}),i("tinymce/html/Writer",["tinymce/html/Entities","tinymce/util/Tools"],function(n,t){var i=t.makeMap;return function(t){var r=[],u,o,f,e,s;return t=t||{},u=t.indent,o=i(t.indent_before||""),f=i(t.indent_after||""),e=n.getEncodeFunc(t.entity_encoding||"raw",t.entities),s=t.element_format=="html",{start:function(n,t,i){var c,a,l,h;if(u&&o[n]&&r.length>0&&(h=r[r.length-1],h.length>0&&h!=="\n"&&r.push("\n")),r.push("<",n),t)for(c=0,a=t.length;c<a;c++)l=t[c],r.push(" ",l.name,'="',e(l.value,!0),'"');r[r.length]=!i||s?">":" />",i&&u&&f[n]&&r.length>0&&(h=r[r.length-1],h.length>0&&h!=="\n"&&r.push("\n"))},end:function(n){var t;r.push("<\/",n,">"),u&&f[n]&&r.length>0&&(t=r[r.length-1],t.length>0&&t!=="\n"&&r.push("\n"))},text:function(n,t){n.length>0&&(r[r.length]=t?n:e(n))},cdata:function(n){r.push("<![CDATA[",n,"]\]>")},comment:function(n){r.push("<!--",n,"-->")},pi:function(n,t){t?r.push("<?",n," ",t,"?>"):r.push("<?",n,"?>"),u&&r.push("\n")},doctype:function(n){r.push("<!DOCTYPE",n,">",u?"\n":"")},reset:function(){r.length=0},getContent:function(){return r.join("").replace(/\n$/,"")}}}}),i("tinymce/html/Serializer",["tinymce/html/Writer","tinymce/html/Schema"],function(n,t){return function(i,r){var f=this,u=new n(i);i=i||{},i.validate="validate"in i?i.validate:!0,f.schema=r=r||new t,f.writer=u,f.serialize=function(n){function f(n){var y=t[n.type],p,a,i,o,c,s,h,l,v;if(y)y(n);else{if(p=n.name,a=n.shortEnded,i=n.attributes,e&&i&&i.length>1){for(s=[],s.map={},v=r.getElementRule(n.name),h=0,l=v.attributesOrder.length;h<l;h++)o=v.attributesOrder[h],o in i.map&&(c=i.map[o],s.map[o]=c,s.push({name:o,value:c}));for(h=0,l=i.length;h<l;h++)o=i[h].name,o in s.map||(c=i.map[o],s.map[o]=c,s.push({name:o,value:c}));i=s}if(u.start(n.name,i,a),!a){if(n=n.firstChild)do f(n);while(n=n.next);u.end(p)}}}var t,e;return e=i.validate,t={3:function(n){u.text(n.value,n.raw)},8:function(n){u.comment(n.value)},7:function(n){u.pi(n.name,n.value)},10:function(n){u.doctype(n.value)},4:function(n){u.cdata(n.value)},11:function(n){if(n=n.firstChild)do f(n);while(n=n.next)}},u.reset(),n.type!=1||i.inner?t[11](n):f(n),u.getContent()}}}),i("tinymce/dom/Serializer",["tinymce/dom/DOMUtils","tinymce/html/DomParser","tinymce/html/Entities","tinymce/html/Serializer","tinymce/html/Node","tinymce/html/Schema","tinymce/Env","tinymce/util/Tools"],function(n,t,i,r,u,f,e,o){var s=o.each,h=o.trim,c=n.DOM;return function(n,u){var l,a,o;return u&&(l=u.dom,a=u.schema),l=l||c,a=a||new f(n),n.entity_encoding=n.entity_encoding||"named",n.remove_trailing_brs="remove_trailing_brs"in n?n.remove_trailing_brs:!0,o=new t(n,a),o.addAttributeFilter("src,href,style",function(t,i){for(var f=t.length,u,r,e="data-mce-"+i,o=n.url_converter,s=n.url_converter_scope,h;f--;)u=t[f],r=u.attributes.map[e],r!==h?(u.attr(i,r.length>0?r:null),u.attr(e,null)):(r=u.attributes.map[i],i==="style"?r=l.serializeStyle(l.parseStyle(r),u.name):o&&(r=o.call(s,r,i,u.name)),u.attr(i,r.length>0?r:null))}),o.addAttributeFilter("class",function(n){for(var r=n.length,t,i;r--;)t=n[r],i=t.attr("class").replace(/(?:^|\s)mce-item-\w+(?!\S)/g,""),t.attr("class",i.length>0?i:null)}),o.addAttributeFilter("data-mce-type",function(n,t,i){for(var u=n.length,r;u--;)r=n[u],r.attributes.map["data-mce-type"]!=="bookmark"||i.cleanup||r.remove()}),o.addAttributeFilter("data-mce-expando",function(n,t){for(var i=n.length;i--;)n[i].attr(t,null)}),o.addNodeFilter("noscript",function(n){for(var r=n.length,t;r--;)t=n[r].firstChild,t&&(t.value=i.decode(t.value))}),o.addNodeFilter("script,style",function(n,t){function e(n){return n.replace(/(<!--\[CDATA\[|\]\]-->)/g,"\n").replace(/^[\r\n]*|[\r\n]*$/g,"").replace(/^\s*((<!--)?(\s*\/\/)?\s*<!\[CDATA\[|(<!--\s*)?\/\*\s*<!\[CDATA\[\s*\*\/|(\/\/)?\s*<!--|\/\*\s*<!--\s*\*\/)\s*[\r\n]*/gi,"").replace(/\s*(\/\*\s*\]\]>\s*\*\/(-->)?|\s*\/\/\s*\]\]>(-->)?|\/\/\s*(-->)?|\]\]>|\/\*\s*-->\s*\*\/|\s*-->\s*)\s*$/g,"")}for(var f=n.length,i,r,u;f--;)i=n[f],r=i.firstChild?i.firstChild.value:"",t==="script"?(u=(i.attr("type")||"text/javascript").replace(/^mce\-/,""),i.attr("type",u==="text/javascript"?null:u),r.length>0&&(i.firstChild.value="// <![CDATA[\n"+e(r)+"\n// ]\]>")):r.length>0&&(i.firstChild.value="<!--\n"+e(r)+"\n-->")}),o.addNodeFilter("#comment",function(n){for(var i=n.length,t;i--;)t=n[i],t.value.indexOf("[CDATA[")===0?(t.name="#cdata",t.type=4,t.value=t.value.replace(/^\[CDATA\[|\]\]$/g,"")):t.value.indexOf("mce:protected ")===0&&(t.name="#text",t.type=3,t.raw=!0,t.value=unescape(t.value).substr(14))}),o.addNodeFilter("xml:namespace,input",function(n,t){for(var r=n.length,i;r--;)i=n[r],i.type===7?i.remove():i.type===1&&(t!=="input"||"type"in i.attributes.map||i.attr("type","text"))}),n.fix_list_elements&&o.addNodeFilter("ul,ol",function(n){for(var r=n.length,t,i;r--;)t=n[r],i=t.parent,(i.name==="ul"||i.name==="ol")&&t.prev&&t.prev.name==="li"&&t.prev.append(t)}),o.addAttributeFilter("data-mce-src,data-mce-href,data-mce-style,data-mce-selected",function(n,t){for(var i=n.length;i--;)n[i].attr(t,null)}),{schema:a,addNodeFilter:o.addNodeFilter,addAttributeFilter:o.addAttributeFilter,serialize:function(t,i){var v=this,f,u,c,y,p;if(e.ie&&l.select("script,style,select,map").length>0?(p=t.innerHTML,t=t.cloneNode(!1),l.setHTML(t,p)):t=t.cloneNode(!0),f=t.ownerDocument.implementation,f.createHTMLDocument&&(u=f.createHTMLDocument(""),s(t.nodeName=="BODY"?t.childNodes:[t],function(n){u.body.appendChild(u.importNode(n,!0))}),t=t.nodeName!="BODY"?u.body.firstChild:u.body,c=l.doc,l.doc=u),i=i||{},i.format=i.format||"html",i.selection&&(i.forced_root_block=""),!i.no_events){i.node=t;v.onPreProcess(i)}if(y=new r(n,a),i.content=y.serialize(o.parse(h(i.getInner?t.innerHTML:l.getOuterHTML(t)),i)),i.cleanup||(i.content=i.content.replace(/\uFEFF/g,"")),!i.no_events)v.onPostProcess(i);return c&&(l.doc=c),i.node=null,i.content},addRules:function(n){a.addValidElements(n)},setRules:function(n){a.setValidElements(n)},onPreProcess:function(n){u&&u.fire("PreProcess",n)},onPostProcess:function(n){u&&u.fire("PostProcess",n)}}}}),i("tinymce/dom/TridentSelection",[],function(){function n(n){function r(t,i){var r,c=0,s,a,l,f,e,h,o=-1,u;if(r=t.duplicate(),r.collapse(i),u=r.parentElement(),u.ownerDocument===n.dom.doc){while(u.contentEditable==="false")u=u.parentNode;if(!u.hasChildNodes())return{node:u,inside:1};for(l=u.children,s=l.length-1;c<=s;)if(h=Math.floor((c+s)/2),f=l[h],r.moveToElementText(f),o=r.compareEndPoints(i?"StartToStart":"EndToEnd",t),o>0)s=h-1;else if(o<0)c=h+1;else return{node:f};if(o<0)for(f?r.collapse(!1):(r.moveToElementText(u),r.collapse(!0),f=u,a=!0),e=0;r.compareEndPoints(i?"StartToStart":"StartToEnd",t)!==0;){if(r.move("character",1)===0||u!=r.parentElement())break;e++}else for(r.collapse(!0),e=0;r.compareEndPoints(i?"StartToStart":"StartToEnd",t)!==0;){if(r.move("character",-1)===0||u!=r.parentElement())break;e++}return{node:f,position:o,offset:e,inside:a}}}function f(){function h(n){var s=r(f,n),i,o,e=0,t,c,h;if(i=s.node,o=s.offset,s.inside&&!i.hasChildNodes()){u[n?"setStart":"setEnd"](i,0);return}if(o===c){u[n?"setStartBefore":"setEndAfter"](i);return}if(s.position<0){if(t=s.inside?i.firstChild:i.nextSibling,!t){u[n?"setStartAfter":"setEndAfter"](i);return}if(!o){t.nodeType==3?u[n?"setStart":"setEnd"](t,0):u[n?"setStartBefore":"setEndBefore"](t);return}while(t){if(h=t.nodeValue,e+=h.length,e>=o){i=t,e-=o,e=h.length-e;break}t=t.nextSibling}}else{if(t=i.previousSibling,!t)return u[n?"setStartBefore":"setEndBefore"](i);if(!o){i.nodeType==3?u[n?"setStart":"setEnd"](t,i.nodeValue.length):u[n?"setStartAfter":"setEndAfter"](t);return}while(t){if(e+=t.nodeValue.length,e>=o){i=t,e-=o;break}t=t.previousSibling}}u[n?"setStart":"setEnd"](i,e)}var f=n.getRng(),u=t.createRng(),e,s,o,c,l;if(e=f.item?f.item(0):f.parentElement(),e.ownerDocument!=t.doc)return u;if(s=n.isCollapsed(),f.item)return u.setStart(e.parentNode,t.nodeIndex(e)),u.setEnd(u.startContainer,u.startOffset+1),u;try{h(!0),s||h()}catch(a){if(a.number==-2147024809)l=i.getBookmark(2),o=f.duplicate(),o.collapse(!0),e=o.parentElement(),s||(o=f.duplicate(),o.collapse(!1),c=o.parentElement(),c.innerHTML=c.innerHTML),e.innerHTML=e.innerHTML,i.moveToBookmark(l),f=n.getRng(),h(!0),s||h();else throw a;}return u}var i=this,t=n.dom,u=!1;this.getBookmark=function(i){function e(n){for(var u,r,e=[],i=n.parentNode,f=t.getRoot().parentNode;i!=f&&i.nodeType!==9;){for(u=i.children,r=u.length;r--;)if(n===u[r]){e.push(r);break}n=i,i=i.parentNode}return e}function o(n){var t;return t=r(f,n),t?{position:t.position,offset:t.offset,indexes:e(t.node),inside:t.inside}:void 0}var f=n.getRng(),u={};return i===2&&(f.item?u.start={ctrl:!0,indexes:e(f.item(0))}:(u.start=o(!0),n.isCollapsed()||(u.end=o()))),u},this.moveToBookmark=function(n){function u(n){for(var u,f,i=t.getRoot(),r=n.length-1;r>=0;r--)f=i.children,u=n[r],u<=f.length-1&&(i=f[u]);return i}function f(t){var e=n[t?"start":"end"],s,f,h,o;e&&(s=e.position>0,f=r.createTextRange(),f.moveToElementText(u(e.indexes)),o=e.offset,o!==h?(f.collapse(e.inside||s),f.moveStart("character",s?-o:o)):f.collapse(t),i.setEndPoint(t?"StartToStart":"EndToStart",f),t&&i.collapse(!0))}var i,r=t.doc.body;n.start&&(n.start.ctrl?(i=r.createControlRange(),i.addElement(u(n.start.indexes)),i.select()):(i=r.createTextRange(),f(!0),f(),i.select()))},this.addRange=function(i){function p(n){var i,y,f,h,v;f=t.create("a"),i=n?r:c,y=n?o:s,h=e.duplicate(),(i==l||i==l.documentElement)&&(i=a,y=0),i.nodeType==3?(i.parentNode.insertBefore(f,i),h.moveToElementText(f),h.moveStart("character",y),t.remove(f),e.setEndPoint(n?"StartToStart":"EndToEnd",h)):(v=i.childNodes,v.length?(y>=v.length?t.insertAfter(f,v[v.length-1]):i.insertBefore(f,v[y]),h.moveToElementText(f)):i.canHaveHTML&&(i.innerHTML="<span>&#xFEFF;<\/span>",f=i.firstChild,h.moveToElementText(f),h.collapse(u)),e.setEndPoint(n?"StartToStart":"EndToEnd",h),t.remove(f))}var e,h,r,o,c,s,f,l=n.dom.doc,a=l.body,v,y;if(r=i.startContainer,o=i.startOffset,c=i.endContainer,s=i.endOffset,e=a.createTextRange(),r==c&&r.nodeType==1){if(o==s&&!r.hasChildNodes()){if(r.canHaveHTML){f=r.previousSibling,f&&!f.hasChildNodes()&&t.isBlock(f)?f.innerHTML="&#xFEFF;":f=null,r.innerHTML="<span>&#xFEFF;<\/span><span>&#xFEFF;<\/span>",e.moveToElementText(r.lastChild),e.select(),t.doc.selection.clear(),r.innerHTML="",f&&(f.innerHTML="");return}o=t.nodeIndex(r),r=r.parentNode}if(o==s-1)try{if(y=r.childNodes[o],h=a.createControlRange(),h.addElement(y),h.select(),v=n.getRng(),v.item&&y===v.item(0))return}catch(w){}}p(!0),p(),e.select()},this.getRangeAt=f}return n}),i("tinymce/util/VK",["tinymce/Env"],function(n){return{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,LEFT:37,RIGHT:39,SPACEBAR:32,TAB:9,UP:38,modifierPressed:function(n){return n.shiftKey||n.ctrlKey||n.altKey},metaKeyPressed:function(t){return(n.mac?t.metaKey:t.ctrlKey)&&!t.altKey}}}),i("tinymce/dom/ControlSelection",["tinymce/util/VK","tinymce/util/Tools","tinymce/Env"],function(n,t,i){return function(r,u){function lt(n){return u.settings.object_resizing===!1?!1:/TABLE|IMG|DIV/.test(n.nodeName)?n.getAttribute("data-mce-resize")==="false"?!1:!0:!1}function it(t){var i,r;i=t.screenX-ht,r=t.screenY-ct,s=i*c[2]+p,h=r*c[3]+w,s=s<5?5:s,h=h<5?5:h,(n.modifierPressed(t)||e.nodeName=="IMG"&&c[2]*c[3]!=0)&&(s=Math.round(h/ft),h=Math.round(s*ft)),f.setStyles(o,{width:s,height:h}),c[2]<0&&o.clientWidth<=s&&f.setStyle(o,"left",nt+(p-s)),c[3]<0&&o.clientHeight<=h&&f.setStyle(o,"top",tt+(w-h)),b||(u.fire("ObjectResizeStart",{target:e,width:p,height:w}),b=!0)}function rt(){function n(n,t){t&&(e.style[n]||!u.schema.isValid(e.nodeName.toLowerCase(),n)?f.setStyle(e,n,t):f.setAttrib(e,n,t))}b=!1,n("width",s),n("height",h),f.unbind(l,"mousemove",it),f.unbind(l,"mouseup",rt),a!=l&&(f.unbind(a,"mousemove",it),f.unbind(a,"mouseup",rt)),f.remove(o),v&&e.nodeName!="TABLE"||ut(e),u.fire("ObjectResized",{target:e,width:s,height:h}),u.nodeChanged()}function ut(n,t,i){var v,k,g,ut,r,et=u.getBody();v=f.getPos(n,et),nt=v.x,tt=v.y,r=n.getBoundingClientRect(),k=r.width||r.right-r.left,g=r.height||r.bottom-r.top,e!=n&&(ot(),e=n,s=h=0),ut=u.fire("ObjectSelected",{target:n}),lt(n)&&!ut.isDefaultPrevented()?st(y,function(n,r){function v(t){b=!0,ht=t.screenX,ct=t.screenY,p=e.clientWidth,w=e.clientHeight,ft=w/p,c=n,o=e.cloneNode(!0),f.addClass(o,"mce-clonedresizable"),o.contentEditable=!1,o.unSelectabe=!0,f.setStyles(o,{left:nt,top:tt,margin:0}),o.removeAttribute("data-mce-selected"),u.getBody().appendChild(o),f.bind(l,"mousemove",it),f.bind(l,"mouseup",rt),a!=l&&(f.bind(a,"mousemove",it),f.bind(a,"mouseup",rt))}var s,h;if(t){r==t&&v(i);return}s=f.get("mceResizeHandle"+r),s?f.show(s):(h=u.getBody(),s=f.add(h,"div",{id:"mceResizeHandle"+r,"data-mce-bogus":!0,"class":"mce-resizehandle",contentEditable:!1,unSelectabe:!0,style:"cursor:"+r+"-resize; margin:0; padding:0"}),f.bind(s,"mousedown",function(n){n.preventDefault(),v(n)})),f.setStyles(s,{left:k*n[0]+nt-s.offsetWidth/2,top:g*n[1]+tt-s.offsetHeight/2})}):d(),e.setAttribute("data-mce-selected","1")}function d(){var t,n;e&&e.removeAttribute("data-mce-selected");for(t in y)n=f.get("mceResizeHandle"+t),n&&(f.unbind(n),f.remove(n))}function et(n){function i(n,t){if(n)do if(n===t)return!0;while(n=n.parentNode)}var t;if(st(f.select("img[data-mce-selected],hr[data-mce-selected]"),function(n){n.removeAttribute("data-mce-selected")}),t=n.type=="mousedown"?n.target:r.getNode(),t=f.getParent(t,v?"table":"table,img,hr"),i(t,u.getBody())&&(wt(),i(r.getStart(),t)&&i(r.getEnd(),t)&&(!v||t!=r.getStart()&&r.getStart().nodeName!=="IMG"))){ut(t);return}d()}function at(n,t,i){n&&n.attachEvent&&n.attachEvent("on"+t,i)}function vt(n,t,i){n&&n.detachEvent&&n.detachEvent("on"+t,i)}function yt(n){var t=n.srcElement,r,f,i,e,o,s,h;r=t.getBoundingClientRect(),s=g.clientX-r.left,h=g.clientY-r.top;for(f in y)if(i=y[f],e=t.offsetWidth*i[0],o=t.offsetHeight*i[1],Math.abs(e-s)<8&&Math.abs(o-h)<8){c=i;break}b=!0,u.getDoc().selection.empty(),ut(t,f,g)}function pt(n){var t=n.srcElement;if(t!=e){if(ot(),t.id.indexOf("mceResizeHandle")===0){n.returnValue=!1;return}(t.nodeName=="IMG"||t.nodeName=="TABLE")&&(d(),e=t,at(t,"resizestart",yt))}}function ot(){vt(e,"resizestart",yt)}function wt(){try{u.getDoc().execCommand("enableObjectResizing",!1,!1)}catch(n){}}function bt(n){var t;if(v){t=l.body.createControlRange();try{return t.addElement(n),t.select(),!0}catch(i){}}}function kt(){e=o=null,v&&(ot(),vt(u.getBody(),"controlselect",pt))}var f=u.dom,st=t.each,e,o,y,c,g,ht,ct,nt,tt,p,w,ft,b,s,h,l=u.getDoc(),a=document,v=i.ie&&i.ie<11,k;y={n:[.5,0,0,-1],e:[1,.5,1,0],s:[.5,1,0,1],w:[0,.5,-1,0],nw:[0,0,-1,-1],ne:[1,0,1,-1],se:[1,1,1,1],sw:[0,1,-1,1]},k=".mce-content-body",u.contentStyles.push(k+" div.mce-resizehandle {position: absolute;border: 1px solid black;background: #FFF;width: 5px;height: 5px;z-index: 10000}"+k+" .mce-resizehandle:hover {background: #000}"+k+" img[data-mce-selected], hr[data-mce-selected] {outline: 1px solid black;resize: none}"+k+" .mce-clonedresizable {position: absolute;"+(i.gecko?"":"outline: 1px dashed black;")+"opacity: .5;filter: alpha(opacity=50);z-index: 10000}");u.on("init",function(){if(v){u.on("ObjectResized",function(n){n.target.nodeName!="TABLE"&&(d(),bt(n.target))});at(u.getBody(),"controlselect",pt);u.on("mousedown",function(n){g=n})}else if(wt(),i.ie>=11){u.on("mouseup",function(n){var t=n.target.nodeName;/^(TABLE|IMG|HR)$/.test(t)&&(u.selection.select(n.target,t=="TABLE"),u.nodeChanged())});u.dom.bind(u.getBody(),"mscontrolselect",function(n){/^(TABLE|IMG|HR)$/.test(n.target.nodeName)&&n.preventDefault()})}u.on("nodechange mousedown mouseup ResizeEditor",et);u.on("keydown keyup",function(n){e&&e.nodeName=="TABLE"&&et(n)})});return{isResizable:lt,showResizeRect:ut,hideResizeRect:d,updateResizeRect:et,controlSelect:bt,destroy:kt}}}),i("tinymce/dom/Selection",["tinymce/dom/TreeWalker","tinymce/dom/TridentSelection","tinymce/dom/ControlSelection","tinymce/Env","tinymce/util/Tools"],function(n,i,r,u,f){function s(n,t,u,f){var e=this;e.dom=n,e.win=t,e.serializer=u,e.editor=f,e.controlSelection=new r(e,f),e.win.getSelection||(e.tridentSel=new i(e))}var e=f.each,h=f.grep,c=f.trim,o=u.ie,l=u.opera;return s.prototype={setCursorLocation:function(n,t){var i=this,r=i.dom.createRng();n?(r.setStart(n,t),r.setEnd(n,t),i.setRng(r),i.collapse(!1)):(i._moveEndPoint(r,i.editor.getBody(),!0),i.setRng(r))},getContent:function(n){var r=this,i=r.getRng(),u=r.dom.create("body"),s=r.getSel(),f,e,o;return(n=n||{},f=e="",n.get=!0,n.format=n.format||"html",n.selection=!0,r.editor.fire("BeforeGetContent",n),n.format=="text")?r.isCollapsed()?"":i.text||(s.toString?s.toString():""):(i.cloneContents?(o=i.cloneContents(),o&&u.appendChild(o)):i.item!==t||i.htmlText!==t?(u.innerHTML="<br>"+(i.item?i.item(0).outerHTML:i.htmlText),u.removeChild(u.firstChild)):u.innerHTML=i.toString(),/^\s/.test(u.innerHTML)&&(f=" "),/\s+$/.test(u.innerHTML)&&(e=" "),n.getInner=!0,n.content=r.isCollapsed()?"":f+r.serializer.serialize(u,n)+e,r.editor.fire("GetContent",n),n.content)},setContent:function(n,t){var r=this,i=r.getRng(),f,u=r.win.document,e,o;if(t=t||{format:"html"},t.set=!0,t.selection=!0,n=t.content=n,t.no_events||r.editor.fire("BeforeSetContent",t),n=t.content,i.insertNode){n+='<span id="__caret">_<\/span>',i.startContainer.nodeName=="PRE"&&(n=n.replace(/<br>/g,"\n"),n=n.replace(/<br\s*\/>/g,"\n")),i.startContainer==u&&i.endContainer==u?u.body.innerHTML=n:(i.deleteContents(),u.body.childNodes.length===0?u.body.innerHTML=n:i.createContextualFragment?i.insertNode(i.createContextualFragment(n)):(e=u.createDocumentFragment(),o=u.createElement("div"),e.appendChild(o),o.outerHTML=n,i.insertNode(e))),f=r.dom.get("__caret"),i=u.createRange(),i.setStartBefore(f),i.setEndBefore(f),r.setRng(i),r.dom.remove("__caret");try{r.setRng(i)}catch(s){}}else i.item&&(u.execCommand("Delete",!1,null),i=r.getRng()),/^\s+/.test(n)?(i.pasteHTML('<span id="__mce_tmp">_<\/span>'+n),r.dom.remove("__mce_tmp")):i.pasteHTML(n);t.no_events||r.editor.fire("SetContent",t)},getStart:function(){var r=this,t=r.getRng(),n,f,u,i;if(t.duplicate||t.item){if(t.item)return t.item(0);for(u=t.duplicate(),u.collapse(1),n=u.parentElement(),n.ownerDocument!==r.dom.doc&&(n=r.dom.getRoot()),f=i=t.parentElement();i=i.parentNode;)if(i==n){n=f;break}return n}return(n=t.startContainer,n.nodeType==1&&n.hasChildNodes()&&(n=n.childNodes[Math.min(n.childNodes.length-1,t.startOffset)]),n&&n.nodeType==3)?n.parentNode:n},getEnd:function(){var r=this,t=r.getRng(),n,i;return t.duplicate||t.item?t.item?t.item(0):(t=t.duplicate(),t.collapse(0),n=t.parentElement(),n.ownerDocument!==r.dom.doc&&(n=r.dom.getRoot()),n&&n.nodeName=="BODY")?n.lastChild||n:n:(n=t.endContainer,i=t.endOffset,n.nodeType==1&&n.hasChildNodes()&&(n=n.childNodes[i>0?i-1:i]),n&&n.nodeType==3)?n.parentNode:n},getBookmark:function(n,t){function v(n,t){var i=0;return e(h.select(n),function(n,r){n==t&&(i=r)}),i}function y(n){function t(t){var i,r,u,f=t?"start":"end";i=n[f+"Container"],r=n[f+"Offset"],i.nodeType==1&&i.nodeName=="TR"&&(u=i.childNodes,i=u[Math.min(t?r:r-1,u.length-1)],i&&(r=t?0:i.childNodes.length,n["set"+(t?"Start":"End")](i,r)))}return t(!0),t(),n}function p(){function u(n,i){var u=n[i?"startContainer":"endContainer"],o=n[i?"startOffset":"endOffset"],h=[],e,s,c=0;if(u.nodeType==3){if(t)for(e=u.previousSibling;e&&e.nodeType==3;e=e.previousSibling)o+=e.nodeValue.length;h.push(o)}else s=u.childNodes,o>=s.length&&s.length&&(c=1,o=Math.max(0,s.length-1)),h.push(r.dom.nodeIndex(s[o],t)+c);for(;u&&u!=f;u=u.parentNode)h.push(r.dom.nodeIndex(u,t));return h}var i=r.getRng(!0),f=h.getRoot(),n={};return n.start=u(i,!0),r.isCollapsed()||(n.end=u(i)),n}var r=this,h=r.dom,i,o,s,a,u,f,l="&#xFEFF;",c;if(n==2)return(f=r.getNode(),u=f?f.nodeName:null,u=="IMG")?{name:u,index:v(u,f)}:r.tridentSel?r.tridentSel.getBookmark(n):p();if(n)return{rng:r.getRng()};if(i=r.getRng(),s=h.uniqueId(),a=r.isCollapsed(),c="overflow:hidden;line-height:0px",i.duplicate||i.item){if(i.item)return f=i.item(0),u=f.nodeName,{name:u,index:v(u,f)};o=i.duplicate();try{i.collapse(),i.pasteHTML('<span data-mce-type="bookmark" id="'+s+'_start" style="'+c+'">'+l+"<\/span>"),a||(o.collapse(!1),i.moveToElementText(o.parentElement()),i.compareEndPoints("StartToEnd",o)===0&&o.move("character",-1),o.pasteHTML('<span data-mce-type="bookmark" id="'+s+'_end" style="'+c+'">'+l+"<\/span>"))}catch(w){return null}}else{if(f=r.getNode(),u=f.nodeName,u=="IMG")return{name:u,index:v(u,f)};o=y(i.cloneRange()),a||(o.collapse(!1),o.insertNode(h.create("span",{"data-mce-type":"bookmark",id:s+"_end",style:c},l))),i=y(i),i.collapse(!0),i.insertNode(h.create("span",{"data-mce-type":"bookmark",id:s+"_start",style:c},l))}return r.moveToBookmark({id:s,keep:1}),{id:s}},moveToBookmark:function(n){function v(t){var u=n[t?"start":"end"],f,r,e,o;if(u){for(e=u[0],r=a,f=u.length-1;f>=1;f--){if(o=r.childNodes,u[f]>o.length-1)return;r=o[u[f]]}r.nodeType===3&&(e=Math.min(u[0],r.nodeValue.length)),r.nodeType===1&&(e=Math.min(u[0],r.childNodes.length)),t?i.setStart(r,e):i.setEnd(r,e)}return!0}function y(i){var r=t.get(n.id+"_"+i),v,o,y,a,p=n.keep;if(r&&(v=r.parentNode,i=="start"?(p?(v=r.firstChild,o=1):o=t.nodeIndex(r),s=u=v,c=f=o):(p?(v=r.firstChild,o=1):o=t.nodeIndex(r),u=v,f=o),!p)){for(a=r.previousSibling,y=r.nextSibling,e(h(r.childNodes),function(n){n.nodeType==3&&(n.nodeValue=n.nodeValue.replace(/\uFEFF/g,""))});r=t.get(n.id+"_"+i);)t.remove(r,1);a&&y&&a.nodeType==y.nodeType&&a.nodeType==3&&!l&&(o=a.nodeValue.length,a.appendData(y.nodeValue),t.remove(y),i=="start"?(s=u=a,c=f=o):(u=a,f=o))}}function p(n){return!t.isBlock(n)||n.innerHTML||o||(n.innerHTML='<br data-mce-bogus="1" />'),n}var r=this,t=r.dom,i,a,s,u,c,f;if(n)if(n.start){if(i=t.createRng(),a=t.getRoot(),r.tridentSel)return r.tridentSel.moveToBookmark(n);v(!0)&&v()&&r.setRng(i)}else n.id?(y("start"),y("end"),s&&(i=t.createRng(),i.setStart(p(s),c),i.setEnd(p(u),f),r.setRng(i))):n.name?r.select(t.select(n.name)[n.index]):n.rng&&r.setRng(n.rng)},select:function(n,t){var i=this,f=i.dom,r=f.createRng(),u;if(i.lastFocusBookmark=null,n){if(!t&&i.controlSelection.controlSelect(n))return;u=f.nodeIndex(n),r.setStart(n.parentNode,u),r.setEnd(n.parentNode,u+1),t&&(i._moveEndPoint(r,n,!0),i._moveEndPoint(r,n)),i.setRng(r)}return n},isCollapsed:function(){var t=this,n=t.getRng(),i=t.getSel();return!n||n.item?!1:n.compareEndPoints?n.compareEndPoints("StartToEnd",n)===0:!i||n.collapsed},collapse:function(n){var i=this,t=i.getRng(),r;t.item&&(r=t.item(0),t=i.win.document.body.createTextRange(),t.moveToElementText(r)),t.collapse(!!n),i.setRng(t)},getSel:function(){var n=this.win;return n.getSelection?n.getSelection():n.document.selection},getRng:function(n){var i=this,e,t,f,r=i.win.document,s,u;if(!n&&i.lastFocusBookmark)return u=i.lastFocusBookmark,u.startContainer?(t=r.createRange(),t.setStart(u.startContainer,u.startOffset),t.setEnd(u.endContainer,u.endOffset)):t=u,t;if(n&&i.tridentSel)return i.tridentSel.getRangeAt(0);try{(e=i.getSel())&&(t=e.rangeCount>0?e.getRangeAt(0):e.createRange?e.createRange():r.createRange())}catch(h){}if(o&&t&&t.setStart&&r.selection){try{s=r.selection.createRange()}catch(h){}s&&s.item&&(f=s.item(0),t=r.createRange(),t.setStartBefore(f),t.setEndAfter(f))}return t||(t=r.createRange?r.createRange():r.body.createTextRange()),t.setStart&&t.startContainer.nodeType===9&&t.collapsed&&(f=i.dom.getRoot(),t.setStart(f,0),t.setEnd(f,0)),i.selectedRange&&i.explicitRange&&(t.compareBoundaryPoints(t.START_TO_START,i.selectedRange)===0&&t.compareBoundaryPoints(t.END_TO_END,i.selectedRange)===0?t=i.explicitRange:(i.selectedRange=null,i.explicitRange=null)),t},setRng:function(n,t){var r=this,i;if(n.select){try{n.select()}catch(u){}return}if(r.tridentSel){if(n.cloneRange)try{r.tridentSel.addRange(n);return}catch(u){}}else if(i=r.getSel(),i){r.explicitRange=n;try{i.removeAllRanges(),i.addRange(n)}catch(u){}t===!1&&i.extend&&(i.collapse(n.endContainer,n.endOffset),i.extend(n.startContainer,n.startOffset)),r.selectedRange=i.rangeCount>0?i.getRangeAt(0):null}},setNode:function(n){var t=this;return t.setContent(t.dom.getOuterHTML(n)),n},getNode:function(){function s(n,t){for(var i=n;n&&n.nodeType===3&&n.length===0;)n=t?n.nextSibling:n.previousSibling;return n||i}var u=this,n=u.getRng(),i,t=n.startContainer,r=n.endContainer,f=n.startOffset,e=n.endOffset,o=u.dom.getRoot();return n?n.setStart?(i=n.commonAncestorContainer,!n.collapsed&&(t==r&&e-f<2&&t.hasChildNodes()&&(i=t.childNodes[f]),t.nodeType===3&&r.nodeType===3&&(t=t.length===f?s(t.nextSibling,!0):t.parentNode,r=e===0?s(r.previousSibling,!1):r.parentNode,t&&t===r)))?t:i&&i.nodeType==3?i.parentNode:i:(i=n.item?n.item(0):n.parentElement(),i.ownerDocument!==u.win.document&&(i=o),i):o},getSelectedBlocks:function(t,i){var o=this,r=o.dom,u,f,e=[],s;if(f=r.getRoot(),t=r.getParent(t||o.getStart(),r.isBlock),i=r.getParent(i||o.getEnd(),r.isBlock),t&&t!=f&&e.push(t),t&&i&&t!=i)for(u=t,s=new n(t,f);(u=s.next())&&u!=i;)r.isBlock(u)&&e.push(u);return i&&t!=i&&i!=f&&e.push(i),e},isForward:function(){var r=this.dom,n=this.getSel(),t,i;return!n||!n.anchorNode||!n.focusNode?!0:(t=r.createRng(),t.setStart(n.anchorNode,n.anchorOffset),t.collapse(!0),i=r.createRng(),i.setStart(n.focusNode,n.focusOffset),i.collapse(!0),t.compareBoundaryPoints(t.START_TO_START,i)<=0)},normalize:function(){function f(f){function p(t,i){for(var r=new n(t,h.getParent(t.parentNode,h.isBlock)||l);t=r[i?"prev":"next"]();)if(t.nodeName==="BR")return!0}function b(n,t){return n.previousSibling&&n.previousSibling.nodeName==t}function y(t,u){var c,f;for(u=u||o,c=new n(u,h.getParent(u.parentNode,h.isBlock)||l);e=c[t?"prev":"next"]();){if(e.nodeType===3&&e.nodeValue.length>0){o=e,s=t?e.nodeValue.length:0,i=!0;return}if(h.isBlock(e)||a[e.nodeName.toLowerCase()])return;f=e}r&&f&&(o=f,i=!0,s=0)}var o,s,v,h=u.dom,l=h.getRoot(),e,a,w,c;if(o=t[(f?"start":"end")+"Container"],s=t[(f?"start":"end")+"Offset"],a=h.schema.getNonEmptyElements(),c=f,o.nodeType==1&&s>o.childNodes.length-1&&(c=!1),o.nodeType===9&&(o=h.getRoot(),s=0),o===l){if(c&&(e=o.childNodes[s>0?s-1:0],e&&(w=e.nodeName.toLowerCase(),a[e.nodeName]||e.nodeName=="TABLE")))return;if(o.hasChildNodes()&&(s=Math.min(!c&&s>0?s-1:s,o.childNodes.length-1),o=o.childNodes[s],s=0,o.hasChildNodes()&&!/TABLE/.test(o.nodeName))){e=o,v=new n(o,l);do{if(e.nodeType===3&&e.nodeValue.length>0){s=c?0:e.nodeValue.length,o=e,i=!0;break}if(a[e.nodeName.toLowerCase()]){s=h.nodeIndex(e),o=e.parentNode,e.nodeName!="IMG"||c||s++,i=!0;break}}while(e=c?v.next():v.prev())}}r&&(o.nodeType===3&&s===0&&y(!0),o.nodeType===1&&(e=o.childNodes[s],!e||e.nodeName!=="BR"||b(e,"A")||p(e)||p(e,!0)||y(!0,o.childNodes[s]))),c&&!r&&o.nodeType===3&&s===o.nodeValue.length&&y(!1),i&&t["set"+(f?"Start":"End")](o,s)}var u=this,t,i,r;o||(t=u.getRng(),r=t.collapsed,f(!0),r||f(),i&&(r&&t.collapse(!0),u.setRng(t,u.isForward())))},selectorChanged:function(n,t){var i=this,r;if(!i.selectorChangedData){i.selectorChangedData={},r={};i.editor.on("NodeChange",function(n){var f=n.element,t=i.dom,u=t.getParents(f,null,t.getRoot()),o={};e(i.selectorChangedData,function(n,i){e(u,function(f){if(t.is(f,i))return r[i]||(e(n,function(n){n(!0,{node:f,selector:i,parents:u})}),r[i]=n),o[i]=n,!1})}),e(r,function(n,t){o[t]||(delete r[t],e(n,function(n){n(!1,{node:f,selector:t,parents:u})}))})})}return i.selectorChangedData[n]||(i.selectorChangedData[n]=[]),i.selectorChangedData[n].push(t),i},getScrollContainer:function(){for(var t,n=this.dom.getRoot();n&&n.nodeName!="BODY";){if(n.scrollHeight>n.clientHeight){t=n;break}n=n.parentNode}return t},scrollIntoView:function(n){function s(n){for(var i=0,r=0,t=n;t&&t.nodeType;)i+=t.offsetLeft||0,r+=t.offsetTop||0,t=t.offsetParent;return{x:i,y:r}}var t,f,e=this,o=e.dom,h=o.getRoot(),i,r,u;if(h.nodeName!="BODY"&&(u=e.getScrollContainer(),u)){t=s(n).y-s(u).y,r=u.clientHeight,i=u.scrollTop,(t<i||t+25>i+r)&&(u.scrollTop=t<i?t:t-r+25);return}f=o.getViewPort(e.editor.getWin()),t=o.getPos(n).y,i=f.y,r=f.h,(t<f.y||t+25>i+r)&&e.editor.getWin().scrollTo(0,t<i?t:t-r+25)},_moveEndPoint:function(t,i,r){var f=i,e=new n(i,f),o=this.dom.schema.getNonEmptyElements();do{if(i.nodeType==3&&c(i.nodeValue).length!==0){r?t.setStart(i,0):t.setEnd(i,i.nodeValue.length);return}if(o[i.nodeName]){r?t.setStartBefore(i):i.nodeName=="BR"?t.setEndBefore(i):t.setEndAfter(i);return}if(u.ie&&u.ie<11&&this.dom.isBlock(i)&&this.dom.isEmpty(i)){r?t.setStart(i,0):t.setEnd(i,0);return}}while(i=r?e.next():e.prev());f.nodeName=="BODY"&&(r?t.setStart(f,0):t.setEnd(f,f.childNodes.length))},destroy:function(){this.win=null,this.controlSelection.destroy()}},s}),i("tinymce/dom/RangeUtils",["tinymce/util/Tools"],function(n){function t(n){this.walk=function(t,r){function y(n){var t;return t=n[0],t.nodeType===3&&t===f&&p>=t.nodeValue.length&&n.splice(0,1),t=n[n.length-1],w===0&&n.length>0&&t===e&&t.nodeType===3&&n.splice(n.length-1,1),n}function b(n,t,i){for(var r=[];n&&n!=i;n=n[t])r.push(n);return r}function k(n,t){do{if(n.parentNode==t)return n;n=n.parentNode}while(n)}function l(n,t,i){var f=i?"nextSibling":"previousSibling";for(u=n,a=u.parentNode;u&&u!=t;u=a)a=u.parentNode,s=b(u==n?u:u[f],f),s.length&&(i||s.reverse(),r(y(s)))}var f=t.startContainer,p=t.startOffset,e=t.endContainer,w=t.endOffset,o,h,c,u,a,s,v;if(v=n.select("td.mce-item-selected,th.mce-item-selected"),v.length>0){i(v,function(n){r([n])});return}if(f.nodeType==1&&f.hasChildNodes()&&(f=f.childNodes[p]),e.nodeType==1&&e.hasChildNodes()&&(e=e.childNodes[Math.min(w-1,e.childNodes.length-1)]),f==e)return r(y([f]));for(o=n.findCommonAncestor(f,e),u=f;u;u=u.parentNode){if(u===e)return l(f,o,!0);if(u===o)break}for(u=e;u;u=u.parentNode){if(u===f)return l(e,o);if(u===o)break}h=k(f,o)||f,c=k(e,o)||e,l(f,h,!0),s=b(h==f?h:h.nextSibling,"nextSibling",c==e?c.nextSibling:c),s.length&&r(y(s)),l(e,c)},this.split=function(n){function f(n,t){return n.splitText(t)}var i=n.startContainer,r=n.startOffset,t=n.endContainer,u=n.endOffset;return i==t&&i.nodeType==3?r>0&&r<i.nodeValue.length&&(t=f(i,r),i=t.previousSibling,u>r?(u=u-r,i=t=f(t,u).previousSibling,u=t.nodeValue.length,r=0):u=0):(i.nodeType==3&&r>0&&r<i.nodeValue.length&&(i=f(i,r),r=0),t.nodeType==3&&u>0&&u<t.nodeValue.length&&(t=f(t,u).previousSibling,u=t.nodeValue.length)),{startContainer:i,startOffset:r,endContainer:t,endOffset:u}}}var i=n.each;return t.compareRanges=function(n,t){if(n&&t)if(n.item||n.duplicate){if(n.item&&t.item&&n.item(0)===t.item(0)||n.isEqual&&t.isEqual&&t.isEqual(n))return!0}else return n.startContainer==t.startContainer&&n.startOffset==t.startOffset;return!1},t}),i("tinymce/Formatter",["tinymce/dom/TreeWalker","tinymce/dom/RangeUtils","tinymce/util/Tools"],function(n,t,i){return function(r){function at(n){return n.nodeType&&(n=n.nodeName),!!r.schema.getTextBlockElements()[n.toLowerCase()]}function tt(n,t){return u.getParents(n,t,u.getRoot())}function vt(n){return n.nodeType===1&&n.id==="_mce_caret"}function hi(){it({alignleft:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,tr,div,ul,ol,li",styles:{textAlign:"left"},defaultBlock:"div"},{selector:"img,table",collapsed:!1,styles:{float:"left"}}],aligncenter:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,tr,div,ul,ol,li",styles:{textAlign:"center"},defaultBlock:"div"},{selector:"img",collapsed:!1,styles:{display:"block",marginLeft:"auto",marginRight:"auto"}},{selector:"table",collapsed:!1,styles:{marginLeft:"auto",marginRight:"auto"}}],alignright:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,tr,div,ul,ol,li",styles:{textAlign:"right"},defaultBlock:"div"},{selector:"img,table",collapsed:!1,styles:{float:"right"}}],alignjustify:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,tr,div,ul,ol,li",styles:{textAlign:"justify"},defaultBlock:"div"}],bold:[{inline:"strong",remove:"all"},{inline:"span",styles:{fontWeight:"bold"}},{inline:"b",remove:"all"}],italic:[{inline:"em",remove:"all"},{inline:"span",styles:{fontStyle:"italic"}},{inline:"i",remove:"all"}],underline:[{inline:"span",styles:{textDecoration:"underline"},exact:!0},{inline:"u",remove:"all"}],strikethrough:[{inline:"span",styles:{textDecoration:"line-through"},exact:!0},{inline:"strike",remove:"all"}],forecolor:{inline:"span",styles:{color:"%value"},wrap_links:!1},hilitecolor:{inline:"span",styles:{backgroundColor:"%value"},wrap_links:!1},fontname:{inline:"span",styles:{fontFamily:"%value"}},fontsize:{inline:"span",styles:{fontSize:"%value"}},fontsize_class:{inline:"span",attributes:{"class":"%value"}},blockquote:{block:"blockquote",wrapper:1,remove:"all"},subscript:{inline:"sub"},superscript:{inline:"sup"},code:{inline:"code"},tt:{inline:"tt"},link:{inline:"a",selector:"a",remove:"all",split:!0,deep:!0,onmatch:function(){return!0},onformat:function(n,t,i){f(i,function(t,i){u.setAttrib(n,i,t)})}},removeformat:[{selector:"b,strong,em,i,font,u,strike,sub,sup",remove:"all",split:!0,expand:!1,block_expand:!0,deep:!0},{selector:"span",attributes:["style","class"],remove:"empty",split:!0,expand:!1,deep:!0},{selector:"*",attributes:["style","class"],split:!1,expand:!1,deep:!0}]}),f("p h1 h2 h3 h4 h5 h6 div address pre div dt dd samp".split(/\s/),function(n){it(n,{block:n,remove:"all"})}),it(r.settings.formats)}function ci(){r.addShortcut("ctrl+b","bold_desc","Bold"),r.addShortcut("ctrl+i","italic_desc","Italic"),r.addShortcut("ctrl+u","underline_desc","Underline");for(var n=1;n<=6;n++)r.addShortcut("ctrl+"+n,"",["FormatBlock",!1,"h"+n]);r.addShortcut("ctrl+7","",["FormatBlock",!1,"p"]),r.addShortcut("ctrl+8","",["FormatBlock",!1,"div"]),r.addShortcut("ctrl+9","",["FormatBlock",!1,"address"])}function y(n){return n?ht[n]:ht}function it(n,t){n&&(typeof n!="string"?f(n,function(n,t){it(t,n)}):(t=t.length?t:[t],f(t,function(n){n.deep===k&&(n.deep=!n.selector),n.split===k&&(n.split=!n.selector||n.inline),n.remove===k&&n.selector&&!n.inline&&(n.remove="none"),n.selector&&n.inline&&(n.mixed=!0,n.block_expand=!0),typeof n.classes=="string"&&(n.classes=n.classes.split(/\s+/))}),ht[n]=t))}function ti(n){var t;return r.dom.getParent(n,function(n){return t=r.dom.getStyle(n,"text-decoration"),t&&t!=="none"}),t}function ii(n){var t;n.nodeType===1&&n.parentNode&&n.parentNode.nodeType===1&&(t=ti(n.parentNode),r.dom.getStyle(n,"color")&&t?r.dom.setStyle(n,"text-decoration",t):r.dom.getStyle(n,"textdecoration")===t&&r.dom.setStyle(n,"text-decoration",null))}function g(t,i,p){function it(n,t){if(t=t||w,n){if(t.onformat)t.onformat(n,t,i,p);f(t.styles,function(t,r){u.setStyle(n,r,b(t,i))}),f(t.attributes,function(t,r){u.setAttrib(n,r,b(t,i))}),f(t.classes,function(t){t=b(t,i),u.hasClass(n,t)||u.addClass(n,t)})}}function pt(){function o(t,i){var r=new n(i);for(p=r.current();p;p=r.prev())if(p.childNodes.length>1||p==t||p.tagName=="BR")return p}var t=r.selection.getRng(),u=t.startContainer,f=t.endContainer,i,e;return u!=f&&t.endOffset===0&&(i=o(u,f),e=i.nodeType==3?i.length:i.childNodes.length,t.setEnd(i,e)),t}function bt(n,t,i,r,e){var a=[],o=-1,l,h=-1,y=-1,c;return f(n.childNodes,function(n,t){if(n.nodeName==="UL"||n.nodeName==="OL")return o=t,l=n,!1}),f(n.childNodes,function(n,i){n.nodeName==="SPAN"&&u.getAttrib(n,"data-mce-type")=="bookmark"&&(n.id==t.id+"_start"?h=i:n.id==t.id+"_end"&&(y=i))}),o<=0||h<o&&y>o?(f(v(n.childNodes),e),0):(c=u.clone(i,s),f(v(n.childNodes),function(n,t){(h<o&&t<o||h>o&&t>o)&&(a.push(n),n.parentNode.removeChild(n))}),h<o?n.insertBefore(c,l):h>o&&n.insertBefore(c,l.nextSibling),r.push(c),f(a,function(n){c.appendChild(n)}),c)}function ct(n,r,e){var y=[],p,g,b=!0;p=w.inline||w.block,g=u.create(p),it(g),ft.walk(n,function(n){function c(n){var nt,rt,ft,tt,ut;if(ut=b,nt=n.nodeName.toLowerCase(),rt=n.parentNode.nodeName.toLowerCase(),n.nodeType===1&&d(n)&&(ut=b,b=d(n)==="true",tt=!0),a(nt,"br")){o=0,w.block&&u.remove(n);return}if(w.wrapper&&l(n,t,i)){o=0;return}if(b&&!tt&&w.block&&!w.wrapper&&at(nt)&&et(rt,p)){n=u.rename(n,p),it(n),y.push(n),o=0;return}if(w.selector&&(f(k,function(t){"collapsed"in t&&t.collapsed!==lt||u.is(n,t.selector)&&!vt(n)&&(it(n,t),ft=!0)}),!w.inline||ft)){o=0;return}!b||tt||!et(p,nt)||!et(rt,p)||!e&&n.nodeType===3&&n.nodeValue.length===1&&n.nodeValue.charCodeAt(0)===65279||vt(n)||w.inline&&h(n)?nt=="li"&&r?o=bt(n,r,g,y,c):(o=0,f(v(n.childNodes),c),tt&&(b=ut),o=0):(o||(o=u.clone(g,s),n.parentNode.insertBefore(o,n),y.push(o)),o.appendChild(n))}var o;f(n,c)}),w.wrap_links===!1&&f(y,function(n){function t(n){var i,r,e;if(n.nodeName==="A"){for(r=u.clone(g,s),y.push(r),e=v(n.childNodes),i=0;i<e.length;i++)r.appendChild(e[i]);n.appendChild(r)}f(v(n.childNodes),t)}t(n)}),f(y,function(n){function e(n){var t=0;return f(n.childNodes,function(n){rt(n)||c(n)||t++}),t}function a(n){var t,i;return f(n.childNodes,function(n){if(n.nodeType==1&&!c(n)&&!vt(n))return t=n,s}),t&&wt(t,w)&&(i=u.clone(t,s),it(i),u.replace(i,n,o),u.remove(t,1)),i||n}var r;if(r=e(n),(y.length>1||!h(n))&&r===0){u.remove(n,1);return}if(w.inline||w.wrapper){if(w.exact||r!==1||(n=a(n)),f(k,function(t){f(u.select(t.inline,n),function(n){var r;if(t.wrap_links===!1){r=n.parentNode;do if(r.nodeName==="A")return;while(r=r.parentNode)}st(t,i,n,t.exact?n:null)})}),l(n.parentNode,t,i))return u.remove(n,1),n=0,o;w.merge_with_parents&&u.getParent(n.parentNode,function(r){if(l(r,t,i))return u.remove(n,1),n=0,o}),n&&w.merge_siblings!==!1&&(n=ri(gt(n),n),n=ri(n,gt(n,o)))}})}var k=y(t),w=k[0],ht,tt,lt=!p&&e.isCollapsed(),nt,yt;w&&(p?p.nodeType?(tt=u.createRng(),tt.setStartBefore(p),tt.setEndAfter(p),ct(ut(tt,k),null,!0)):ct(p,null,!0):lt&&w.inline&&!u.select("td.mce-item-selected,th.mce-item-selected").length?fi("apply",t,i):(nt=r.selection.getNode(),yt=nt.nextSibling==null,ot||!k[0].defaultBlock||u.getParent(nt,u.isBlock)||g(k[0].defaultBlock),r.selection.setRng(pt()),ht=e.getBookmark(),ct(ut(e.getRng(o),k),ht),w.styles&&(w.styles.color||w.styles.textDecoration)&&(ni(nt,ii,"childNodes"),ii(nt)),e.moveToBookmark(ht),ei(e.getRng(o)),t=="pre"&&yt&&r.dom.add(r.getBody(),"p",{},'<br data-mce-bogus="1">'),r.nodeChanged()))}function yt(n,t,i){function rt(n){var r,i,u,e,f;if(n.nodeType===1&&d(n)&&(e=b,b=d(n)==="true",f=!0),r=v(n.childNodes),b&&!f)for(i=0,u=a.length;i<u;i++)if(st(a[i],t,n,n))break;if(p.deep&&r.length){for(i=0,u=r.length;i<u;i++)rt(r[i]);f&&(b=e)}}function ot(i){var r;return f(tt(i.parentNode).reverse(),function(i){var u;r||i.id=="_start"||i.id=="_end"||(u=l(i,n,t),u&&u.split!==!1&&(r=i))}),r}function ht(n,i,r,f){var o,e,c,v,l,y;if(n){for(y=n.parentNode,o=i.parentNode;o&&o!=y;o=o.parentNode){for(e=u.clone(o,s),l=0;l<a.length;l++)if(st(a[l],t,e,e)){e=0;break}e&&(c&&e.appendChild(c),v||(v=e),c=e)}!f||p.mixed&&h(n)||(i=u.split(n,i)),c&&(r.parentNode.insertBefore(c,r),v.appendChild(r))}return i}function k(n){return ht(ot(n),n,n,!0)}function et(n){var i=u.get(n?"_start":"_end"),t=i[n?"firstChild":"lastChild"];return c(t)&&(t=t[n?"firstChild":"lastChild"]),u.remove(i,!0),t}function g(n){var t,i,u=n.commonAncestorContainer;n=ut(n,a,o),p.split&&(t=ui(n,o),i=ui(n),t!=i?(/^(TR|TH|TD)$/.test(t.nodeName)&&t.firstChild&&(t=t.nodeName=="TR"?t.firstChild.firstChild||t:t.firstChild||t),u&&/^T(HEAD|BODY|FOOT|R)$/.test(u.nodeName)&&/^(TH|TD)$/.test(i.nodeName)&&i.firstChild&&(i=i.firstChild||i),t=dt(t,"span",{id:"_start","data-mce-type":"bookmark"}),i=dt(i,"span",{id:"_end","data-mce-type":"bookmark"}),k(t),k(i),t=et(o),i=et()):t=i=k(t),n.startContainer=t.parentNode,n.startOffset=nt(t),n.endContainer=i.parentNode,n.endOffset=nt(i)+1),ft.walk(n,function(n){f(n,function(n){rt(n),n.nodeType===1&&r.dom.getStyle(n,"text-decoration")==="underline"&&n.parentNode&&ti(n.parentNode)==="underline"&&st({deep:!1,exact:!0,inline:"span",styles:{textDecoration:"underline"}},null,n)})})}var a=y(n),p=a[0],it,w,b=!0;if(i){i.nodeType?(w=u.createRng(),w.setStartBefore(i),w.setEndAfter(i),g(w)):g(i);return}e.isCollapsed()&&p.inline&&!u.select("td.mce-item-selected,th.mce-item-selected").length?fi("remove",n,t):(it=e.getBookmark(),g(e.getRng(o)),e.moveToBookmark(it),p.inline&&pt(n,t,e.getStart())&&ei(e.getRng(!0)),r.nodeChanged())}function li(n,t,i){var r=y(n);!pt(n,t,i)||"toggle"in r[0]&&!r[0].toggle?g(n,t,i):yt(n,t,i)}function l(n,t,i,r){function h(n,t,f){var o,h,e=t[f],s;if(t.onmatch)return t.onmatch(n,t,f);if(e)if(e.length===k){for(o in e)if(e.hasOwnProperty(o)){if(h=f==="attributes"?u.getAttrib(n,o):bt(n,o),r&&!h&&!t.exact)return;if((!r||t.exact)&&!a(h,kt(b(e[o],i),o)))return}}else for(s=0;s<e.length;s++)if(f==="attributes"?u.getAttrib(n,e[s]):bt(n,e[s]))return t;return t}var o=y(t),e,f,s;if(o&&n)for(f=0;f<o.length;f++)if(e=o[f],wt(n,e)&&h(n,e,"attributes")&&h(n,e,"styles")){if(s=e.classes)for(f=0;f<s.length;f++)if(!u.hasClass(n,s[f]))return;return e}}function pt(n,t,i){function f(i){var r=u.getRoot();return i===r?!1:(i=u.getParent(i,function(i){return i.parentNode===r||!!l(i,n,t,!0)}),l(i,n,t))}var r;return i?f(i):(i=e.getNode(),f(i))?o:(r=e.getStart(),r!=i&&f(r))?o:s}function ai(n,t){var i,r=[],f={};return i=e.getStart(),u.getParent(i,function(i){for(var u,e=0;e<n.length;e++)u=n[e],!f[u]&&l(i,u,t)&&(f[u]=!0,r.push(u))},u.getRoot()),r}function vi(n){var i=y(n),c,f,r,t,h;if(i)for(c=e.getStart(),f=tt(c),t=i.length-1;t>=0;t--){if(h=i[t].selector,!h||i[t].defaultBlock)return o;for(r=f.length-1;r>=0;r--)if(u.is(f[r],h))return o}return s}function yi(n,t,i){var u;if(!w){w={},u={};r.on("NodeChange",function(n){var t=tt(n.element),i={};f(w,function(n,r){f(t,function(e){if(l(e,r,{},n.similar))return u[r]||(f(n,function(n){n(!0,{node:e,format:r,parents:t})}),u[r]=n),i[r]=n,!1})}),f(u,function(r,e){i[e]||(delete u[e],f(r,function(i){i(!1,{node:n.element,format:e,parents:t})}))})})}return f(n.split(","),function(n){w[n]||(w[n]=[],w[n].similar=i),w[n].push(t)}),this}function wt(n,t){return a(n,t.inline)?o:a(n,t.block)?o:t.selector?n.nodeType==1&&u.is(n,t.selector):void 0}function a(n,t){return n=n||"",t=t||"",n=""+(n.nodeName||n),t=""+(t.nodeName||t),n.toLowerCase()==t.toLowerCase()}function bt(n,t){return kt(u.getStyle(n,t),t)}function kt(n,t){return(t=="color"||t=="backgroundColor")&&(n=u.toHex(n)),t=="fontWeight"&&n==700&&(n="bold"),t=="fontFamily"&&(n=n.replace(/[\'\"]/g,"").replace(/,\s+/g,",")),""+n}function b(n,t){return typeof n!="string"?n=n(t):t&&(n=n.replace(/%(\w+)/g,function(n,i){return t[i]||n})),n}function rt(n){return n&&n.nodeType===3&&/^([\t \r\n]+|)$/.test(n.nodeValue)}function dt(n,t,i){var r=u.create(t,i);return n.parentNode.insertBefore(r,n),r.appendChild(n),r}function ut(t,i,f){function b(n){function a(n){return n.nodeName=="BR"&&n.getAttribute("data-mce-bogus")&&!n.nextSibling}var r,t,f,s,l;if(r=t=n?o:e,s=n?"previousSibling":"nextSibling",l=u.getRoot(),r.nodeType==3&&!rt(r)&&(n?y>0:v<r.nodeValue.length))return r;for(;;){if(!i[0].block_expand&&h(t))return t;for(f=t[s];f;f=f[s])if(!c(f)&&!rt(f)&&!a(f))return t;if(t.parentNode==l){r=t;break}t=t.parentNode}return r}function g(n,t){for(t===k&&(t=n.nodeType===3?n.length:n.childNodes.length);n&&n.hasChildNodes();)n=n.childNodes[t],n&&(t=n.nodeType===3?n.length:n.childNodes.length);return{node:n,offset:t}}function it(n){for(var t=n;t;){if(t.nodeType===1&&d(t))return d(t)==="false"?t:n;t=t.parentNode}return n}function ut(t,i,e){function a(n,t){var i,r,u=n.nodeValue;return typeof t=="undefined"&&(t=e?u.length:0),e?(i=u.lastIndexOf(" ",t),r=u.lastIndexOf("\u00a0",t),i=i>r?i:r,i===-1||f||i++):(i=u.indexOf(" ",t),r=u.indexOf("\u00a0",t),i=i!==-1&&(r===-1||i<r)?i:r),i}var l,o,s,c;if(t.nodeType===3){if(s=a(t,i),s!==-1)return{container:t,offset:s};c=t}for(l=new n(t,u.getParent(t,h)||r.getBody());o=l[e?"prev":"next"]();)if(o.nodeType===3){if(c=o,s=a(o),s!==-1)return{container:o,offset:s}}else if(h(o))break;if(c)return i=e?0:c.length,{container:c,offset:i}}function ft(n,r){var e,f,o,s;for(n.nodeType==3&&n.nodeValue.length===0&&n[r]&&(n=n[r]),e=tt(n),f=0;f<e.length;f++)for(o=0;o<i.length;o++)if((s=i[o],!("collapsed"in s)||s.collapsed===t.collapsed)&&u.is(e[f],s.selector))return e[f];return n}function et(n,t){var r,f=u.getRoot();if(i[0].wrapper||(r=u.getParent(n,i[0].block,f)),r||(r=u.getParent(n.nodeType==3?n.parentNode:n,function(n){return n!=f&&at(n)})),r&&i[0].wrapper&&(r=tt(r,"ul,ol").reverse()[0]||r),!r)for(r=n;r[t]&&!h(r[t]);)if(r=r[t],a(r,"br"))break;return r||n}var w,l,p,o=t.startContainer,y=t.startOffset,e=t.endContainer,v=t.endOffset;if(o.nodeType==1&&o.hasChildNodes()&&(w=o.childNodes.length-1,o=o.childNodes[y>w?w:y],o.nodeType==3&&(y=0)),e.nodeType==1&&e.hasChildNodes()&&(w=e.childNodes.length-1,e=e.childNodes[v>w?w:v-1],e.nodeType==3&&(v=e.nodeValue.length)),o=it(o),e=it(e),(c(o.parentNode)||c(o))&&(o=c(o)?o:o.parentNode,o=o.nextSibling||o,o.nodeType==3&&(y=0)),(c(e.parentNode)||c(e))&&(e=c(e)?e:e.parentNode,e=e.previousSibling||e,e.nodeType==3&&(v=e.length)),i[0].inline&&(t.collapsed&&(p=ut(o,y,!0),p&&(o=p.container,y=p.offset),p=ut(e,v),p&&(e=p.container,v=p.offset)),l=g(e,v),l.node)){while(l.node&&l.offset===0&&l.node.previousSibling)l=g(l.node.previousSibling);l.node&&l.offset>0&&l.node.nodeType===3&&l.node.nodeValue.charAt(l.offset-1)===" "&&l.offset>1&&(e=l.node,e.splitText(l.offset-1))}return(i[0].inline||i[0].block_expand)&&(i[0].inline&&o.nodeType==3&&y!==0||(o=b(!0)),i[0].inline&&e.nodeType==3&&v!==e.nodeValue.length||(e=b())),i[0].selector&&i[0].expand!==s&&!i[0].inline&&(o=ft(o,"previousSibling"),e=ft(e,"nextSibling")),(i[0].block||i[0].selector)&&(o=et(o,"previousSibling"),e=et(e,"nextSibling"),i[0].block&&(h(o)||(o=b(!0)),h(e)||(e=b()))),o.nodeType==1&&(y=nt(o),o=o.parentNode),e.nodeType==1&&(v=nt(e)+1,e=e.parentNode),{startContainer:o,startOffset:y,endContainer:e,endOffset:v}}function st(n,t,i,r){var e,h,c;if(!wt(i,n))return s;if(n.remove!="all")for(f(n.styles,function(n,f){n=kt(b(n,t),f),typeof f=="number"&&(f=n,r=0),(!r||a(bt(r,f),n))&&u.setStyle(i,f,""),c=1}),c&&u.getAttrib(i,"style")===""&&(i.removeAttribute("style"),i.removeAttribute("data-mce-style")),f(n.attributes,function(n,e){var o;if(n=b(n,t),typeof e=="number"&&(e=n,r=0),!r||a(u.getAttrib(r,e),n)){if(e=="class"&&(n=u.getAttrib(i,e),n&&(o="",f(n.split(/\s+/),function(n){/mce\w+/.test(n)&&(o+=(o?" ":"")+n)}),o))){u.setAttrib(i,e,o);return}e=="class"&&i.removeAttribute("className"),oi.test(e)&&i.removeAttribute("data-mce-"+e),i.removeAttribute(e)}}),f(n.classes,function(n){n=b(n,t),(!r||u.hasClass(r,n))&&u.removeClass(i,n)}),h=u.getAttribs(i),e=0;e<h.length;e++)if(h[e].nodeName.indexOf("_")!==0)return s;if(n.remove!="none")return pi(i,n),o}function pi(n,t){function e(n,t,i){return n=gt(n,t,i),!n||n.nodeName=="BR"||h(n)}var c=n.parentNode,i;(t.block&&(ot?c==u.getRoot()&&(t.list_block&&a(n,t.list_block)||f(v(n.childNodes),function(n){et(ot,n.nodeName.toLowerCase())?i?i.appendChild(n):(i=dt(n,ot),u.setAttribs(i,r.settings.forced_root_block_attrs)):i=0})):h(n)&&!h(c)&&(e(n,s)||e(n.firstChild,o,1)||n.insertBefore(u.create("br"),n.firstChild),e(n,o)||e(n.lastChild,s,1)||n.appendChild(u.create("br")))),t.selector&&t.inline&&!a(t.inline,n))||u.remove(n,1)}function gt(n,t,i){if(n)for(t=t?"nextSibling":"previousSibling",n=i?n:n[t];n;n=n[t])if(n.nodeType==1&&!rt(n))return n}function c(n){return n&&n.nodeType==1&&n.getAttribute("data-mce-type")=="bookmark"}function ri(n,t){function h(n,t){function i(n){var t={};return f(u.getAttribs(n),function(i){var r=i.nodeName.toLowerCase();r.indexOf("_")!==0&&r!=="style"&&r!=="data-mce-style"&&(t[r]=u.getAttrib(n,r))}),t}function r(n,t){var r,i;for(i in n)if(n.hasOwnProperty(i)){if((r=t[i],r===k)||n[i]!=r)return s;delete t[i]}for(i in t)if(t.hasOwnProperty(i))return s;return o}return n.nodeName!=t.nodeName?s:r(i(n),i(t))?r(u.parseStyle(u.getAttrib(n,"style")),u.parseStyle(u.getAttrib(t,"style")))?o:s:s}function e(n,t){for(i=n;i;i=i[t]){if(i.nodeType==3&&i.nodeValue.length!==0)return n;if(i.nodeType==1&&!c(i))return i}return n}var i,r;if(n&&t&&(n=e(n,"previousSibling"),t=e(t,"nextSibling"),h(n,t))){for(i=n.nextSibling;i&&i!=t;)r=i,i=i.nextSibling,n.appendChild(r);return u.remove(t),f(v(t.childNodes),function(t){n.appendChild(t)}),n}return t}function ui(t,i){var u,f,e;return u=t[i?"startContainer":"endContainer"],f=t[i?"startOffset":"endOffset"],u.nodeType==1&&(e=u.childNodes.length-1,!i&&f&&f--,u=u.childNodes[f>e?e:f]),u.nodeType===3&&i&&f>=u.nodeValue.length&&(u=new n(u,r.getBody()).next()||u),u.nodeType!==3||i||f!==0||(u=new n(u,r.getBody()).prev()||u),u}function fi(t,i,f){function c(n){var t=u.create("span",{id:s,"data-mce-bogus":!0,style:b?"color:red":""});return n&&t.appendChild(r.getDoc().createTextNode(p)),t}function a(n,t){while(n){if(n.nodeType===3&&n.nodeValue!==p||n.childNodes.length>1)return!1;t&&n.nodeType===1&&t.push(n),n=n.firstChild}return!0}function o(n){while(n){if(n.id===s)return n;n=n.parentNode}}function v(t){var i;if(t)for(i=new n(t,t),t=i.current();t;t=i.next())if(t.nodeType===3)return t}function h(n,t){var i,r;if(n)r=e.getRng(!0),a(n)?(t!==!1&&(r.setStartBefore(n),r.setEndBefore(n)),u.remove(n)):(i=v(n),i.nodeValue.charAt(0)===p&&(i=i.deleteData(0,1)),u.remove(n,1)),e.setRng(r);else if(n=o(e.getStart()),!n)while(n=u.get(s))h(n,!1)}function k(){var n,t,s,r,h,l,u;n=e.getRng(!0),r=n.startOffset,l=n.startContainer,u=l.nodeValue,t=o(e.getStart()),t&&(s=v(t)),u&&r>0&&r<u.length&&/\w/.test(u.charAt(r))&&/\w/.test(u.charAt(r-1))?(h=e.getBookmark(),n.collapse(!0),n=ut(n,y(i)),n=ft.split(n),g(i,f,n),e.moveToBookmark(h)):(t&&s.nodeValue===p?g(i,f,t):(t=c(!0),s=t.firstChild,n.insertNode(t),r=1,g(i,f,t)),e.setCursorLocation(s,r))}function d(){var t=e.getRng(!0),o,b,k,a,n,r,v=[],s,h,w;for(o=t.startContainer,b=t.startOffset,n=o,o.nodeType==3&&((b!=o.nodeValue.length||o.nodeValue===p)&&(a=!0),n=n.parentNode);n;){if(l(n,i,f)){r=n;break}n.nextSibling&&(a=!0),v.push(n),n=n.parentNode}if(r)if(a)k=e.getBookmark(),t.collapse(!0),t=ut(t,y(i),!0),t=ft.split(t),yt(i,f,t),e.moveToBookmark(k);else{for(h=c(),n=h,s=v.length-1;s>=0;s--)n.appendChild(u.clone(v[s],!1)),n=n.firstChild;n.appendChild(u.doc.createTextNode(p)),n=n.firstChild,w=u.getParent(r,at),w&&u.isEmpty(w)?r.parentNode.replaceChild(h,r):u.insertAfter(h,r),e.setCursorLocation(n,1),u.isEmpty(r)&&u.remove(r)}}function w(){var n;n=o(e.getStart()),n&&!u.isEmpty(n)&&ni(n,function(n){n.nodeType!=1||n.id===s||u.isEmpty(n)||u.setAttrib(n,"data-mce-bogus",null)},"childNodes")}var s="_mce_caret",b=r.settings.caret_debug;if(!r._hasCaretEvents){lt=function(){var n=[],t;if(a(o(e.getStart()),n))for(t=n.length;t--;)u.setAttrib(n[t],"data-mce-bogus","1")},ct=function(n){var t=n.keyCode;h(),(t==8||t==37||t==39)&&h(o(e.getStart())),w()};r.on("SetContent",function(n){n.selection&&w()});r._hasCaretEvents=!0}t=="apply"?k():d()}function ei(t){var i=t.startContainer,f=t.startOffset,c,o,r,s,h;if(i.nodeType==3&&f>=i.nodeValue.length&&(f=nt(i),i=i.parentNode,c=!0),i.nodeType==1)for(s=i.childNodes,i=s[Math.min(f,s.length-1)],o=new n(i,u.getParent(i,u.isBlock)),(f>s.length-1||c)&&o.next(),r=o.current();r;r=o.next())if(r.nodeType==3&&!rt(r)){h=u.create("a",null,p),r.parentNode.insertBefore(h,r),t.setStart(r,0),e.setRng(t),u.remove(h);return}}var ht={},u=r.dom,e=r.selection,ft=new t(u),et=r.schema.isValidChild,h=u.isBlock,ot=r.settings.forced_root_block,nt=u.nodeIndex,p="\ufeff",oi=/^(src|href|style)$/,s=!1,o=!0,w,k,d=u.getContentEditable,ct,lt,f=i.each,v=i.grep,ni=i.walk,si=i.extend;si(this,{get:y,register:it,apply:g,remove:yt,toggle:li,match:pt,matchAll:ai,matchNode:l,canApply:vi,formatChanged:yi}),hi(),ci();r.on("BeforeGetContent",function(){lt&&lt()});r.on("mouseup keydown",function(n){ct&&ct(n)})}}),i("tinymce/UndoManager",["tinymce/Env","tinymce/util/Tools"],function(n,t){var r=t.trim,i;return i=new RegExp('<span[^>]+data-mce-bogus[^>]+>[\u200b\ufeff]+<\\/span>|<div[^>]+data-mce-bogus[^>]+><\\/div>|\\s?data-mce-selected="[^"]+"',"gi"),function(t){function c(){return r(t.getContent({format:"raw",no_events:1}).replace(i,""))}function o(){f.typing=!1,f.add()}var f,e=0,u=[],l,h,s;t.on("init",function(){f.add()});t.on("BeforeExecCommand",function(n){var t=n.command;t!="Undo"&&t!="Redo"&&t!="mceRepaint"&&f.beforeChange()});t.on("ExecCommand",function(n){var t=n.command;t!="Undo"&&t!="Redo"&&t!="mceRepaint"&&f.add()});t.on("ObjectResizeStart",function(){f.beforeChange()});t.on("SaveContent ObjectResized",o);t.dom.bind(t.dom.getRoot(),"dragend",o),t.dom.bind(t.getBody(),"focusout",function(){!t.removed&&f.typing&&o()});t.on("KeyUp",function(i){var r=i.keyCode;(r>=33&&r<=36||r>=37&&r<=40||r==45||r==13||i.ctrlKey)&&(o(),t.nodeChanged()),(r==46||r==8||n.mac&&(r==91||r==93))&&t.nodeChanged(),h&&f.typing&&(t.isDirty()||(t.isNotDirty=!u[0]||c()==u[0].content,t.isNotDirty||t.fire("change",{level:u[0],lastLevel:null})),t.fire("TypingUndo"),h=!1,t.nodeChanged())});t.on("KeyDown",function(n){var t=n.keyCode;if(t>=33&&t<=36||t>=37&&t<=40||t==45){f.typing&&o();return}(t<16||t>20)&&t!=224&&t!=91&&!f.typing&&(f.beforeChange(),f.typing=!0,f.add(),h=!0)});t.on("MouseDown",function(){f.typing&&o()});t.addShortcut("ctrl+z","","Undo"),t.addShortcut("ctrl+y,ctrl+shift+z","","Redo");t.on("AddUndo Undo Redo ClearUndos MouseUp",function(n){n.isDefaultPrevented()||t.nodeChanged()});return f={data:u,typing:!1,beforeChange:function(){s||(l=t.selection.getBookmark(2,!0))},add:function(n){var i,o=t.settings,r,f;if((n=n||{},n.content=c(),s||t.fire("BeforeAddUndo",{level:n}).isDefaultPrevented())||(r=u[e],r&&r.content==n.content))return null;if(u[e]&&(u[e].beforeBookmark=l),o.custom_undo_redo_levels&&u.length>o.custom_undo_redo_levels){for(i=0;i<u.length-1;i++)u[i]=u[i+1];u.length--,e=u.length}return n.bookmark=t.selection.getBookmark(2,!0),e<u.length-1&&(u.length=e+1),u.push(n),e=u.length-1,f={level:n,lastLevel:r},t.fire("AddUndo",f),e>0&&(t.fire("change",f),t.isNotDirty=!1),n},undo:function(){var n;return f.typing&&(f.add(),f.typing=!1),e>0&&(n=u[--e],e===0&&(t.isNotDirty=!0),t.setContent(n.content,{format:"raw"}),t.selection.moveToBookmark(n.beforeBookmark),t.fire("undo",{level:n})),n},redo:function(){var n;return e<u.length-1&&(n=u[++e],t.setContent(n.content,{format:"raw"}),t.selection.moveToBookmark(n.bookmark),t.fire("redo",{level:n})),n},clear:function(){u=[],e=0,f.typing=!1,t.fire("ClearUndos")},hasUndo:function(){return e>0||f.typing&&u[0]&&c()!=u[0].content},hasRedo:function(){return e<u.length-1&&!this.typing},transact:function(n){f.beforeChange(),s=!0,n(),s=!1,f.add()}}}}),i("tinymce/EnterKey",["tinymce/dom/TreeWalker","tinymce/Env"],function(n,t){var i=t.ie&&t.ie<11;return function(r){function c(c){function ht(n){return n&&u.isBlock(n)&&!/^(TD|TH|CAPTION|FORM)$/.test(n.nodeName)&&!/^(fixed|absolute)/i.test(n.style.position)&&u.getContentEditable(n)!=="true"}function ct(n){var t;u.isBlock(n)&&(t=f.getRng(),n.appendChild(u.create("span",null,"\u00a0")),f.select(n),n.lastChild.outerHTML="",f.setRng(t))}function at(n){for(var t=n,i=[],r;t=t.firstChild;){if(u.isBlock(t))return;t.nodeType!=1||s[t.nodeName.toLowerCase()]||i.push(t)}for(r=i.length;r--;)t=i[r],t.hasChildNodes()&&(t.firstChild!=t.lastChild||t.firstChild.nodeValue!=="")?t.nodeName=="A"&&(t.innerText||t.textContent)===" "&&u.remove(t):u.remove(t)}function et(i){function v(n){while(n){if(n.nodeType==1||n.nodeType==3&&n.data&&/[\r\n\s]/.test(n.data))return n;n=n.nextSibling}}var o,e,r,h=i,c,l;if(t.ie&&t.ie<9&&a&&a.firstChild&&a.firstChild==a.lastChild&&a.firstChild.tagName=="BR"&&u.remove(a.firstChild),i.nodeName=="LI"&&(l=v(i.firstChild),l&&/^(UL|OL)$/.test(l.nodeName)&&i.insertBefore(u.doc.createTextNode("\u00a0"),i.firstChild)),r=u.createRng(),i.hasChildNodes()){for(o=new n(i,i);e=o.current();){if(e.nodeType==3){r.setStart(e,0),r.setEnd(e,0);break}if(s[e.nodeName.toLowerCase()]){r.setStartBefore(e),r.setEndBefore(e);break}h=e,e=o.next()}e||(r.setStart(h,0),r.setEnd(h,0))}else i.nodeName=="BR"?i.nextSibling&&u.isBlock(i.nextSibling)?((!it||it<9)&&(c=u.create("br"),i.parentNode.insertBefore(c,i)),r.setStartBefore(i),r.setEndBefore(i)):(r.setStartAfter(i),r.setEndAfter(i)):(r.setStart(i,0),r.setEnd(i,0));f.setRng(r),u.remove(c),f.scrollIntoView(i)}function st(n){var t=e.forced_root_block;t&&t.toLowerCase()===n.tagName.toLowerCase()&&u.setAttribs(n,e.forced_root_block_attrs)}function ot(n){var f=l,t,r,o;if(n||g=="TABLE"?(t=u.create(n||y),st(t)):t=a.cloneNode(!1),o=t,e.keep_styles!==!1)do if(/^(SPAN|STRONG|B|EM|I|FONT|STRIKE|U)$/.test(f.nodeName)){if(f.id=="_mce_caret")continue;r=f.cloneNode(!1),u.setAttrib(r,"id",""),t.hasChildNodes()?(r.appendChild(t.firstChild),t.appendChild(r)):(o=r,t.appendChild(r))}while(f=f.parentNode);return i||(o.innerHTML='<br data-mce-bogus="1">'),t}function lt(t){var i,r,u;if(l.nodeType==3&&(t?b>0:b<l.nodeValue.length))return!1;if(l.parentNode==a&&rt&&!t||t&&l.nodeType==1&&l==a.firstChild)return!0;if(l.nodeName==="TABLE"||l.previousSibling&&l.previousSibling.nodeName=="TABLE")return rt&&!t||!rt&&t;for(i=new n(l,a),l.nodeType==3&&(t&&b===0?i.prev():t||b!=l.nodeValue.length||i.next());r=i.current();){if(r.nodeType===1){if(!r.getAttribute("data-mce-bogus")&&(u=r.nodeName.toLowerCase(),s[u]&&u!=="br"))return!1}else if(r.nodeType===3&&!/^[ \t\r\n]*$/.test(r.nodeValue))return!1;t?i.prev():i.next()}return!0}function vt(n,t){var f,e,o,i,c,l,s=y||"P";if(e=u.getParent(n,u.isBlock),l=r.getBody().nodeName.toLowerCase(),!e||!ht(e)){if(e=e||tt,!e.hasChildNodes())return f=u.create(s),st(f),e.appendChild(f),w.setStart(f,0),w.setEnd(f,0),f;for(i=n;i.parentNode!=e;)i=i.parentNode;while(i&&!u.isBlock(i))o=i,i=i.previousSibling;if(o&&h.isValidChild(l,s.toLowerCase())){for(f=u.create(s),st(f),o.parentNode.insertBefore(f,o),i=o;i&&!u.isBlock(i);)c=i.nextSibling,f.appendChild(i),i=c;w.setStart(n,t),w.setEnd(n,t)}}return n}function yt(){function n(n){for(var t=p[n?"firstChild":"lastChild"];t;){if(t.nodeType==1)break;t=t[n?"nextSibling":"previousSibling"]}return t===a}function t(){var n=p.parentNode;return n.nodeName=="LI"?n:p}var i=p.parentNode.nodeName;/^(OL|UL|LI)$/.test(i)&&(y="LI"),v=y?ot(y):u.create("BR"),n(!0)&&n()?i=="LI"?u.insertAfter(v,t()):u.replace(v,p):n(!0)?i=="LI"?(u.insertAfter(v,t()),v.appendChild(u.doc.createTextNode(" ")),v.appendChild(p)):p.parentNode.insertBefore(v,p):n()?(u.insertAfter(v,t()),ct(v)):(p=t(),nt=w.cloneRange(),nt.setStartAfter(a),nt.setEndAfter(p),k=nt.extractContents(),y=="LI"&&k.firstChild.nodeName=="LI"?(v=k.firstChild,u.insertAfter(k,p)):(u.insertAfter(k,p),u.insertAfter(v,p))),u.remove(a),et(v),o.add()}function pt(){for(var i=new n(l,a),t;t=i.next();)if(s[t.nodeName.toLowerCase()]||t.length>0)return!0}function ut(){var n,r,t;l&&l.nodeType==3&&b>=l.nodeValue.length&&(i||pt()||(n=u.create("br"),w.insertNode(n),w.setStartAfter(n),w.setEndAfter(n),r=!0)),n=u.create("br"),w.insertNode(n),i&&g=="PRE"&&(!it||it<8)&&n.parentNode.insertBefore(u.doc.createTextNode("\r"),n),t=u.create("span",{},"&nbsp;"),n.parentNode.insertBefore(t,n),f.scrollIntoView(t),u.remove(t),r?(w.setStartBefore(n),w.setEndBefore(n)):(w.setStartAfter(n),w.setEndAfter(n)),f.setRng(w),o.add()}function wt(n){do n.nodeType===3&&(n.nodeValue=n.nodeValue.replace(/^[\r\n]+/,"")),n=n.firstChild;while(n)}function bt(n){for(var i=u.getRoot(),r,t=n;t!==i&&u.getContentEditable(t)!=="false";)u.getContentEditable(t)==="true"&&(r=t),t=t.parentNode;return t!==i?r:i}function kt(n){var t;i||(n.normalize(),t=n.lastChild,(!t||/^(left|right)$/gi.test(u.getStyle(t,"float",!0)))&&u.add(n,"br"))}var w=f.getRng(!0),nt,tt,l,b,a,it,d,v,k,p,g,ft,y,rt;if(!w.collapsed){r.execCommand("Delete");return}if(!c.isDefaultPrevented()&&(l=w.startContainer,b=w.startOffset,y=(e.force_p_newlines?"p":"")||e.forced_root_block,y=y?y.toUpperCase():"",it=u.doc.documentMode,d=c.shiftKey,l.nodeType==1&&l.hasChildNodes()&&(rt=b>l.childNodes.length-1,l=l.childNodes[Math.min(b,l.childNodes.length-1)]||l,b=rt&&l.nodeType==3?l.nodeValue.length:0),tt=bt(l),tt)){if(o.beforeChange(),!u.isBlock(tt)&&tt!=u.getRoot()){(!y||d)&&ut();return}if((y&&!d||!y&&d)&&(l=vt(l,b)),l.parentNode&&l.parentNode.nodeName.toUpperCase()=="LATEX"){ut();return}if(a=u.getParent(l,u.isBlock),p=a?u.getParent(a.parentNode,u.isBlock):null,g=a?a.nodeName.toUpperCase():"",ft=p?p.nodeName.toUpperCase():"",ft!="LI"||c.ctrlKey||(a=p,g=ft),g=="LI"){if(!y&&d){ut();return}if(u.isEmpty(a)){yt();return}}if(g=="PRE"&&e.br_in_pre!==!1){if(!d){ut();return}}else if(!y&&!d&&g!="LI"||y&&d){ut();return}y&&a===r.getBody()||(y=y||"P",lt()?(v=/^(H[1-6]|PRE|FIGURE)$/.test(g)&&ft!="HGROUP"?ot(y):ot(),e.end_container_on_empty_block&&ht(p)&&u.isEmpty(a)?v=u.split(p,a):u.insertAfter(v,a),et(v)):lt(!0)?(v=a.parentNode.insertBefore(ot(),a),ct(v),et(a)):(nt=w.cloneRange(),nt.setEndAfter(a),k=nt.extractContents(),wt(k),v=k.firstChild,u.insertAfter(k,a),at(v),kt(a),et(v)),u.setAttrib(v,"id",""),r.fire("NewBlock",{newBlock:v}),o.add())}}var u=r.dom,f=r.selection,e=r.settings,o=r.undoManager,h=r.schema,s=h.getNonEmptyElements();r.on("keydown",function(n){n.keyCode==13&&c(n)!==!1&&n.preventDefault()})}}),i("tinymce/ForceBlocks",[],function(){return function(n){function e(){var e=t.getStart(),h=n.getBody(),o,w,c,b,l,a,v,k=-16777215,d,p,s,g,y;if(y=i.forced_root_block,e&&e.nodeType===1&&y){while(e&&e!=h){if(f[e.nodeName])return;e=e.parentNode}if(o=t.getRng(),o.setStart){w=o.startContainer,c=o.startOffset,b=o.endContainer,l=o.endOffset;try{p=n.getDoc().activeElement===h}catch(nt){}}else o.item&&(e=o.item(0),o=n.getDoc().body.createTextRange(),o.moveToElementText(e)),p=o.parentElement().ownerDocument===n.getDoc(),s=o.duplicate(),s.collapse(!0),c=s.move("character",k)*-1,s.collapsed||(s=o.duplicate(),s.collapse(!1),l=s.move("character",k)*-1-c);for(e=h.firstChild,g=h.nodeName.toLowerCase();e;)if((e.nodeType===3||e.nodeType==1&&!f[e.nodeName])&&u.isValidChild(g,y.toLowerCase())){if(e.nodeType===3&&e.nodeValue.length===0){v=e,e=e.nextSibling,r.remove(v);continue}a||(a=r.create(y,n.settings.forced_root_block_attrs),e.parentNode.insertBefore(a,e),d=!0),v=e,e=e.nextSibling,a.appendChild(v)}else a=null,e=e.nextSibling;if(d&&p){if(o.setStart)o.setStart(w,c),o.setEnd(b,l),t.setRng(o);else try{o=n.getDoc().body.createTextRange(),o.moveToElementText(h),o.collapse(!0),o.moveStart("character",c),l>0&&o.moveEnd("character",l),o.select()}catch(nt){}n.nodeChanged()}}}var i=n.settings,r=n.dom,t=n.selection,u=n.schema,f=u.getBlockElements();if(i.forced_root_block)n.on("NodeChange",e)}}),i("tinymce/EditorCommands",["tinymce/html/Serializer","tinymce/Env","tinymce/util/Tools"],function(n,i,r){var f=r.each,s=r.extend,h=r.map,c=r.inArray,o=r.explode,l=i.gecko,a=i.ie,u=!0,e=!1;return function(r){function ut(n,t,i){var r;return(n=n.toLowerCase(),r=g.exec[n])?(r(n,t,i),u):e}function k(n){var t;return(n=n.toLowerCase(),t=g.state[n])?t(n):-1}function et(n){var t;return(n=n.toLowerCase(),t=g.value[n])?t(n):e}function d(n,t){t=t||"exec",f(n,function(n,i){f(i.toLowerCase().split(","),function(i){g[t][i]=n})})}function nt(n,i,u){return i===t&&(i=e),u===t&&(u=null),r.getDoc().execCommand(n,i,u)}function ft(n){return p.match(n)}function w(n,i){p.toggle(n,i?{value:i}:t),r.nodeChanged()}function tt(n){rt=v.getBookmark(n)}function it(){v.moveToBookmark(rt)}var y=r.dom,v=r.selection,g={state:{},exec:{},value:{}},b=r.settings,p=r.formatter,rt;s(this,{execCommand:ut,queryCommandState:k,queryCommandValue:et,addCommands:d}),d({"mceResetDesignMode,mceBeginUndoLevel":function(){},"mceEndUndoLevel,mceAddUndoLevel":function(){r.undoManager.add()},"Cut,Copy,Paste":function(n){var e=r.getDoc(),f,t;try{nt(n)}catch(o){f=u}(f||!e.queryCommandSupported(n))&&(t=r.translate("Your browser doesn't support direct access to the clipboard. Please use the Ctrl+X/C/V keyboard shortcuts instead."),i.mac&&(t=t.replace(/Ctrl\+/g,"\u2318+")),r.windowManager.alert(t))},unlink:function(){if(v.isCollapsed()){var n=v.getNode();n.tagName=="A"&&r.dom.remove(n,!0);return}p.remove("link")},"JustifyLeft,JustifyCenter,JustifyRight,JustifyFull":function(n){var t=n.substring(7);t=="full"&&(t="justify"),f("left,center,right,justify".split(","),function(n){t!=n&&p.remove("align"+n)}),w("align"+t),ut("mceRepaint")},"InsertUnorderedList,InsertOrderedList":function(n){var t,i;nt(n),t=y.getParent(v.getNode(),"ol,ul"),t&&(i=t.parentNode,/^(H[1-6]|P|ADDRESS|PRE)$/.test(i.nodeName)&&(tt(),y.split(i,t),it()))},"Bold,Italic,Underline,Strikethrough,Superscript,Subscript":function(n){w(n)},"ForeColor,HiliteColor,FontName":function(n,t,i){w(n,i)},FontSize:function(n,t,i){var r,u;i>=1&&i<=7&&(u=o(b.font_size_style_values),r=o(b.font_size_classes),i=r?r[i-1]||i:u[i-1]||i),w(n,i)},RemoveFormat:function(n){p.remove(n)},mceBlockQuote:function(){w("blockquote")},FormatBlock:function(n,t,i){return w(i||"p")},mceCleanup:function(){var n=v.getBookmark();r.setContent(r.getContent({cleanup:u}),{cleanup:u}),v.moveToBookmark(n)},mceRemoveNode:function(n,t,i){var f=i||v.getNode();f!=r.getBody()&&(tt(),r.dom.remove(f,u),it())},mceSelectNodeDepth:function(n,t,i){var u=0;y.getParent(v.getNode(),function(n){if(n.nodeType==1&&u++==i)return v.select(n),e},r.getBody())},mceSelectNode:function(n,t,i){v.select(i)},mceInsertContent:function(t,i,u){function tt(n){function u(n){return t[n]&&t[n].nodeType==3}var i,t,r;return i=v.getRng(!0),t=i.startContainer,r=i.startOffset,t.nodeType==3&&(r>0?n=n.replace(/^&nbsp;/," "):u("previousSibling")||(n=n.replace(/^ /,"&nbsp;")),r<t.length?n=n.replace(/&nbsp;(<br>|)$/," "):u("nextSibling")||(n=n.replace(/(&nbsp;| )(<br>|)$/,"&nbsp;"))),n}var k,p,e,c,w,b,s,o,f,h,d,nt,l,g;if(/^ | $/.test(u)&&(u=tt(u)),k=r.parser,p=new n({},r.schema),d='<span id="mce_marker" data-mce-type="bookmark">&#xFEFF;&#200B;<\/span>',b={content:u,format:"html",selection:!0},r.fire("BeforeSetContent",b),u=b.content,u.indexOf("{$caret}")==-1&&(u+="{$caret}"),u=u.replace(/\{\$caret\}/,d),o=v.getRng(),nt=o.startContainer||(o.parentElement?o.parentElement():null),l=r.getBody(),nt===l&&v.isCollapsed()&&y.isBlock(l.firstChild)&&y.isEmpty(l.firstChild)&&(o=y.createRng(),o.setStart(l.firstChild,0),o.setEnd(l.firstChild,0),v.setRng(o)),v.isCollapsed()||r.getDoc().execCommand("Delete",!1,null),e=v.getNode(),g={context:e.nodeName.toLowerCase()},w=k.parse(u,g),f=w.lastChild,f.attr("id")=="mce_marker")for(s=f,f=f.prev;f;f=f.walk(!0))if(f.type==3||!y.isBlock(f.name)){f.parent.insert(s,f,f.name==="br");break}if(g.invalid){for(v.setContent(d),e=v.getNode(),c=r.getBody(),e.nodeType==9?e=f=c:f=e;f!==c;)e=f,f=f.parentNode;u=e==c?c.innerHTML:y.getOuterHTML(e),u=p.serialize(k.parse(u.replace(/<span (id="mce_marker"|id=mce_marker).+?<\/span>/i,function(){return p.serialize(w)}))),e==c?y.setHTML(c,u):y.setOuterHTML(e,u)}else u=p.serialize(w),f=e.firstChild,h=e.lastChild,f&&(f!==h||f.nodeName!=="BR")?v.setContent(u):y.setHTML(e,u);s=y.get("mce_marker"),v.scrollIntoView(s),o=y.createRng(),f=s.previousSibling,f&&f.nodeType==3?(o.setStart(f,f.nodeValue.length),a||(h=s.nextSibling,h&&h.nodeType==3&&(f.appendData(h.data),h.parentNode.removeChild(h)))):(o.setStartBefore(s),o.setEndBefore(s)),y.remove(s),v.setRng(o),r.fire("SetContent",b),r.addVisual()},mceInsertRawHTML:function(n,t,i){v.setContent("tiny_mce_marker"),r.setContent(r.getContent().replace(/tiny_mce_marker/g,function(){return i}))},mceToggleFormat:function(n,t,i){w(i)},mceSetContent:function(n,t,i){r.setContent(i)},"Indent,Outdent":function(n){var t,u,i;t=b.indentation,u=/[a-z%]+$/i.exec(t),t=parseInt(t,10),k("InsertUnorderedList")||k("InsertOrderedList")?nt(n):(b.forced_root_block||y.getParent(v.getNode(),y.isBlock)||p.apply("div"),f(v.getSelectedBlocks(),function(f){if(f.nodeName!="LI"){var e=r.getParam("indent_use_margin",!1)?"margin":"padding";e+=y.getStyle(f,"direction",!0)=="rtl"?"Right":"Left",n=="outdent"?(i=Math.max(0,parseInt(f.style[e]||0,10)-t),y.setStyle(f,e,i?i+u:"")):(i=parseInt(f.style[e]||0,10)+t+u,y.setStyle(f,e,i))}}))},mceStoreSelection:function(){tt(u)},mceRestoreSelection:function(){it()},mceRepaint:function(){if(l)try{tt(u),v.getSel()&&v.getSel().selectAllChildren(r.getBody()),v.collapse(u),it()}catch(n){}},InsertHorizontalRule:function(){r.execCommand("mceInsertContent",!1,"<hr />")},mceToggleVisualAid:function(){r.hasVisual=!r.hasVisual,r.addVisual()},mceReplaceContent:function(n,t,i){r.execCommand("mceInsertContent",!1,i.replace(/\{\$selection\}/g,v.getContent({format:"text"})))},mceInsertLink:function(n,t,i){var r;typeof i=="string"&&(i={href:i}),r=y.getParent(v.getNode(),"a"),i.href=i.href.replace(" ","%20"),r&&i.href||p.remove("link"),i.href&&p.apply("link",i,r)},selectAll:function(){var t=y.getRoot(),n;v.getRng().setStart?(n=y.createRng(),n.setStart(t,0),n.setEnd(t,t.childNodes.length),v.setRng(n)):(n=v.getRng(),n.item||(n.moveToElementText(t),n.select()))},"delete":function(){nt("Delete");var n=r.getBody();y.isEmpty(n)&&(r.setContent(""),n.firstChild&&y.isBlock(n.firstChild)?r.selection.setCursorLocation(n.firstChild,0):r.selection.setCursorLocation(n,0))},mceNewDocument:function(){r.setContent("")}}),d({"JustifyLeft,JustifyCenter,JustifyRight,JustifyFull":function(n){var t="align"+n.substring(7),i=v.isCollapsed()?[y.getParent(v.getNode(),y.isBlock)]:v.getSelectedBlocks(),r=h(i,function(n){return!!p.matchNode(n,t)});return c(r,u)!==-1},"Bold,Italic,Underline,Strikethrough,Superscript,Subscript":function(n){return ft(n)},mceBlockQuote:function(){return ft("blockquote")},Outdent:function(){var n;return b.inline_styles&&((n=y.getParent(v.getStart(),y.isBlock))&&parseInt(n.style.paddingLeft,10)>0||(n=y.getParent(v.getEnd(),y.isBlock))&&parseInt(n.style.paddingLeft,10)>0)?u:k("InsertUnorderedList")||k("InsertOrderedList")||!b.inline_styles&&!!y.getParent(v.getNode(),"BLOCKQUOTE")},"InsertUnorderedList,InsertOrderedList":function(n){var t=y.getParent(v.getNode(),"ul,ol");return t&&(n==="insertunorderedlist"&&t.tagName==="UL"||n==="insertorderedlist"&&t.tagName==="OL")}},"state"),d({"FontSize,FontName":function(n){var i=0,t;return(t=y.getParent(v.getNode(),"span"))&&(i=n=="fontsize"?t.style.fontSize:t.style.fontFamily.replace(/, /g,",").replace(/[\'\"]/g,"").toLowerCase()),i}},"value"),d({Undo:function(){r.undoManager.undo()},Redo:function(){r.undoManager.redo()}})}}),i("tinymce/util/URI",["tinymce/util/Tools"],function(n){function t(n,u){var f=this,e,o,s;if(n=r(n),u=f.settings=u||{},/^([\w\-]+):([^\/]{2})/i.test(n)||/^\s*#/.test(n)){f.source=n;return}s=n.indexOf("//")===0,n.indexOf("/")!==0||s||(n=(u.base_uri?u.base_uri.protocol||"http":"http")+"://mce_host"+n),/^[\w\-]*:?\/\//.test(n)||(o=u.base_uri?u.base_uri.path:new t(location.href).directory,n=u.base_uri.protocol===""?"//mce_host"+f.toAbsPath(o,n):(u.base_uri&&u.base_uri.protocol||"http")+"://mce_host"+f.toAbsPath(o,n)),n=n.replace(/@@/g,"(mce_at)"),n=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@\/]*):?([^:@\/]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/.exec(n),i(["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],function(t,i){var r=n[i];r&&(r=r.replace(/\(mce_at\)/g,"@@")),f[t]=r}),e=u.base_uri,e&&(f.protocol||(f.protocol=e.protocol),f.userInfo||(f.userInfo=e.userInfo),f.port||f.host!=="mce_host"||(f.port=e.port),f.host&&f.host!=="mce_host"||(f.host=e.host),f.source=""),s&&(f.protocol="")}var i=n.each,r=n.trim;return t.prototype={setPath:function(n){var t=this;n=/^(.*?)\/?(\w+)?$/.exec(n),t.path=n[0],t.directory=n[1],t.file=n[2],t.source="",t.getURI()},toRelative:function(n){var i=this,u,r,f;return n==="./"?n:(n=new t(n,{base_uri:i}),n.host!="mce_host"&&i.host!=n.host&&n.host||i.port!=n.port||i.protocol!=n.protocol&&n.protocol!=="")?n.getURI():(r=i.getURI(),f=n.getURI(),r==f||r.charAt(r.length-1)=="/"&&r.substr(0,r.length-1)==f)?r:(u=i.toRelPath(i.path,n.path),n.query&&(u+="?"+n.query),n.anchor&&(u+="#"+n.anchor),u)},toAbsolute:function(n,i){return n=new t(n,{base_uri:this}),n.getURI(this.host==n.host&&this.protocol==n.protocol?i:0)},toRelPath:function(n,t){var r,f=0,e="",i,u;if(n=n.substring(0,n.lastIndexOf("/")),n=n.split("/"),r=t.split("/"),n.length>=r.length)for(i=0,u=n.length;i<u;i++)if(i>=r.length||n[i]!=r[i]){f=i+1;break}if(n.length<r.length)for(i=0,u=r.length;i<u;i++)if(i>=n.length||n[i]!=r[i]){f=i+1;break}if(f===1)return t;for(i=0,u=n.length-(f-1);i<u;i++)e+="../";for(i=f-1,u=r.length;i<u;i++)e+=i!=f-1?"/"+r[i]:r[i];return e},toAbsPath:function(n,t){var r,e=0,f=[],o,u;for(o=/\/$/.test(t)?"/":"",n=n.split("/"),t=t.split("/"),i(n,function(n){n&&f.push(n)}),n=f,r=t.length-1,f=[];r>=0;r--)if(t[r].length!==0&&t[r]!=="."){if(t[r]===".."){e++;continue}if(e>0){e--;continue}f.push(t[r])}return r=n.length-e,u=r<=0?f.reverse().join("/"):n.slice(0,r).join("/")+"/"+f.reverse().join("/"),u.indexOf("/")!==0&&(u="/"+u),o&&u.lastIndexOf("/")!==u.length-1&&(u+=o),u},getURI:function(n){var i,t=this;return(!t.source||n)&&(i="",n||(i+=t.protocol?t.protocol+"://":"//",t.userInfo&&(i+=t.userInfo+"@"),t.host&&(i+=t.host),t.port&&(i+=":"+t.port)),t.path&&(i+=t.path),t.query&&(i+="?"+t.query),t.anchor&&(i+="#"+t.anchor),t.source=i),t.source}},t}),i("tinymce/util/Class",["tinymce/util/Tools"],function(n){function u(){}var t=n.each,f=n.extend,r,i;return u.extend=r=function(n){function e(){var r,t,u,n;if(!i&&(n=this,n.init&&n.init.apply(n,arguments),t=n.Mixins,t))for(r=t.length;r--;)u=t[r],u.init&&u.init.apply(n,arguments)}function l(){return this}function a(n,t){return function(){var i=this,f=i._super,r;return i._super=u[n],r=t.apply(i,arguments),i._super=f,r}}var c=this,u=c.prototype,h,o,s;i=!0,h=new c,i=!1,n.Mixins&&(t(n.Mixins,function(t){t=t;for(var i in t)i!=="init"&&(n[i]=t[i])}),u.Mixins&&(n.Mixins=u.Mixins.concat(n.Mixins))),n.Methods&&t(n.Methods.split(","),function(t){n[t]=l}),n.Properties&&t(n.Properties.split(","),function(t){var i="_"+t;n[t]=function(n){var t=this,r;return n!==r?(t[i]=n,t):t[i]}}),n.Statics&&t(n.Statics,function(n,t){e[t]=n}),n.Defaults&&u.Defaults&&(n.Defaults=f({},u.Defaults,n.Defaults));for(o in n)s=n[o],h[o]=typeof s=="function"&&u[o]?a(o,s):s;return e.prototype=h,e.constructor=e,e.extend=r,e},u}),i("tinymce/ui/Selector",["tinymce/util/Class"],function(n){function u(n){for(var i=[],t=n.length,r;t--;)r=n[t],r.__checked||(i.push(r),r.__checked=1);for(t=i.length;t--;)delete i[t].__checked;return i}var f=/^([\w\\*]+)?(?:#([\w\\]+))?(?:\.([\w\\\.]+))?(?:\[\@?([\w\\]+)([\^\$\*!~]?=)([\w\\]+)\])?(?:\:(.+))?/i,i=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,e=/^\s*|\s*$/g,t,r=n.extend({init:function(n){function u(n){if(n)return n=n.toLowerCase(),function(t){return n==="*"||t.type===n}}function o(n){if(n)return function(t){return t._name===n}}function s(n){if(n)return n=n.split("."),function(t){for(var i=n.length;i--;)if(!t.hasClass(n[i]))return!1;return!0}}function h(n,t,i){if(n)return function(r){var u=r[n]?r[n]():"";return t?t==="="?u===i:t==="*="?u.indexOf(i)>=0:t==="~="?(" "+u+" ").indexOf(" "+i+" ")>=0:t==="!="?u!=i:t==="^="?u.indexOf(i)===0:t==="$="?u.substr(u.length-i.length)===i:!1:!!i}}function c(n){var i;if(n)return n=/(?:not\((.+)\))|(.+)/i.exec(n),n[1]?(i=t(n[1],[]),function(n){return!r(n,i)}):(n=n[2],function(t,i,r){return n==="first"?i===0:n==="last"?i===r-1:n==="even"?i%2==0:n==="odd"?i%2==1:t[n]?t[n]():!1})}function l(n,t,i){function l(n){n&&t.push(n)}var r;return r=f.exec(n.replace(e,"")),l(u(r[1])),l(o(r[2])),l(s(r[3])),l(h(r[4],r[5],r[6])),l(c(r[7])),t.psuedo=!!r[7],t.direct=i,t}function t(n,r){var e=[],o,u,f;do if(i.exec(""),u=i.exec(n),u&&(n=u[3],e.push(u[1]),u[2])){o=u[3];break}while(u);for(o&&t(o,r),n=[],f=0;f<e.length;f++)e[f]!=">"&&n.push(l(e[f],[],e[f-1]===">"));return r.push(n),r}var r=this.match;this._selectors=t(n,[])},match:function(n,t){var f,v,u,e,c,r,o,s,h,y,l,a,i;for(t=t||this._selectors,f=0,v=t.length;f<v;f++){for(c=t[f],e=c.length,i=n,a=0,u=e-1;u>=0;u--)for(s=c[u];i;){if(s.psuedo)for(l=i.parent().items(),h=y=l.length;h--;)if(l[h]===i)break;for(r=0,o=s.length;r<o;r++)if(!s[r](i,h,y)){r=o+1;break}if(r===o){a++;break}else if(u===e-1)break;i=i.parent()}if(a===e)return!0}return!1},find:function(n){function o(n,t,r){for(var f,s,u,c=t[r],e=0,h=n.length;e<h;e++){for(u=n[e],f=0,s=c.length;f<s;f++)if(!c[f](u,e,h)){f=s+1;break}if(f===s)r==t.length-1?i.push(u):u.items&&o(u.items(),t,r+1);else if(c.direct)return;u.items&&o(u.items(),t,r)}}var i=[],f,e,s=this._selectors;if(n.items){for(f=0,e=s.length;f<e;f++)o(n.items(),s[f],0);e>1&&(i=u(i))}return t||(t=r.Collection),new t(i)}});return r}),i("tinymce/ui/Collection",["tinymce/util/Tools","tinymce/ui/Selector","tinymce/util/Class"],function(n,t,i){var r,u,f=Array.prototype.push,e=Array.prototype.slice;return u={length:0,init:function(n){n&&this.add(n)},add:function(t){var i=this;return n.isArray(t)?f.apply(i,t):t instanceof r?i.add(t.toArray()):f.call(i,t),i},set:function(n){var t=this,r=t.length,i;for(t.length=0,t.add(n),i=t.length;i<r;i++)delete t[i];return t},filter:function(n){var e=this,i,o,s=[],u,f;for(typeof n=="string"?(n=new t(n),f=function(t){return n.match(t)}):f=n,i=0,o=e.length;i<o;i++)u=e[i],f(u)&&s.push(u);return new r(s)},slice:function(){return new r(e.apply(this,arguments))},eq:function(n){return n===-1?this.slice(n):this.slice(n,+n+1)},each:function(t){return n.each(this,t),this},toArray:function(){return n.toArray(this)},indexOf:function(n){for(var i=this,t=i.length;t--;)if(i[t]===n)break;return t},reverse:function(){return new r(n.toArray(this).reverse())},hasClass:function(n){return this[0]?this[0].hasClass(n):!1},prop:function(n,t){var r=this,u,i;return t!==u?(r.each(function(i){i[n]&&i[n](t)}),r):(i=r[0],i&&i[n]?i[n]():void 0)},exec:function(t){var i=this,r=n.toArray(arguments).slice(1);return i.each(function(n){n[t]&&n[t].apply(n,r)}),i},remove:function(){for(var n=this.length;n--;)this[n].remove();return this}},n.each("fire on off show hide addClass removeClass append prepend before after reflow".split(" "),function(t){u[t]=function(){var i=n.toArray(arguments);return this.each(function(n){t in n&&n[t].apply(n,i)}),this}}),n.each("text name disabled active selected checked visible parent value data".split(" "),function(n){u[n]=function(t){return this.prop(n,t)}}),r=i.extend(u),t.Collection=r,r}),i("tinymce/ui/DomUtils",["tinymce/util/Tools","tinymce/dom/DOMUtils"],function(n,t){return{id:function(){return t.DOM.uniqueId()},createFragment:function(n){return t.DOM.createFragment(n)},getWindowSize:function(){return t.DOM.getViewPort()},getSize:function(n){var i,r,t;return n.getBoundingClientRect?(t=n.getBoundingClientRect(),i=Math.max(t.width||t.right-t.left,n.offsetWidth),r=Math.max(t.height||t.bottom-t.bottom,n.offsetHeight)):(i=n.offsetWidth,r=n.offsetHeight),{width:i,height:r}},getPos:function(n,i){return t.DOM.getPos(n,i)},getViewPort:function(n){return t.DOM.getViewPort(n)},get:function(n){return document.getElementById(n)},addClass:function(n,i){return t.DOM.addClass(n,i)},removeClass:function(n,i){return t.DOM.removeClass(n,i)},hasClass:function(n,i){return t.DOM.hasClass(n,i)},toggleClass:function(n,i,r){return t.DOM.toggleClass(n,i,r)},css:function(n,i,r){return t.DOM.setStyle(n,i,r)},on:function(n,i,r,u){return t.DOM.bind(n,i,r,u)},off:function(n,i,r){return t.DOM.unbind(n,i,r)},fire:function(n,i,r){return t.DOM.fire(n,i,r)},innerHtml:function(n,i){t.DOM.setHTML(n,i)}}}),i("tinymce/ui/Control",["tinymce/util/Class","tinymce/util/Tools","tinymce/ui/Collection","tinymce/ui/DomUtils"],function(n,t,i,r){var e=t.makeMap("focusin focusout scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave wheel keydown keypress keyup contextmenu"," "),u={},o="onmousewheel"in document,s=!1,f=n.extend({Statics:{elementIdCache:u},isRtl:function(){return f.rtl},classPrefix:"mce-",init:function(n){var i=this,u,f;if(i.settings=n=t.extend({},i.Defaults,n),i._id=r.id(),i._text=i._name="",i._width=i._height=0,i._aria={role:n.role},u=n.classes,u)for(u=u.split(" "),u.map={},f=u.length;f--;)u.map[u[f]]=!0;i._classes=u||[],i.visible(!0),t.each("title text width height name classes visible disabled active value".split(" "),function(t){var r=n[t],u;r!==u?i[t](r):i["_"+t]===u&&(i["_"+t]=!1)});i.on("click",function(){if(i.disabled())return!1});n.classes&&t.each(n.classes.split(" "),function(n){i.addClass(n)}),i.settings=n,i._borderBox=i.parseBox(n.border),i._paddingBox=i.parseBox(n.padding),i._marginBox=i.parseBox(n.margin),n.hidden&&i.hide()},Properties:"parent,title,text,width,height,disabled,active,name,value",Methods:"renderHtml",getContainerElm:function(){return document.body},getParentCtrl:function(n){for(var t,i=this.getRoot().controlIdLookup;n&&i;){if(t=i[n.id],t)break;n=n.parentNode}return t},parseBox:function(n){var t,i=10;if(n)return typeof n=="number"?(n=n||0,{top:n,left:n,bottom:n,right:n}):(n=n.split(" "),t=n.length,t===1?n[1]=n[2]=n[3]=n[0]:t===2?(n[2]=n[0],n[3]=n[1]):t===3&&(n[3]=n[1]),{top:parseInt(n[0],i)||0,right:parseInt(n[1],i)||0,bottom:parseInt(n[2],i)||0,left:parseInt(n[3],i)||0})},borderBox:function(){return this._borderBox},paddingBox:function(){return this._paddingBox},marginBox:function(){return this._marginBox},measureBox:function(n,t){function r(t){var i=document.defaultView;return i?(t=t.replace(/[A-Z]/g,function(n){return"-"+n}),i.getComputedStyle(n,null).getPropertyValue(t)):n.currentStyle[t]}function i(n){var t=parseFloat(r(n),10);return isNaN(t)?0:t}return{top:i(t+"TopWidth"),right:i(t+"RightWidth"),bottom:i(t+"BottomWidth"),left:i(t+"LeftWidth")}},initLayoutRect:function(){var n=this,t=n.settings,f,p,o=n.getEl(),i,u,s,h,e,c,l,a;f=n._borderBox=n._borderBox||n.measureBox(o,"border"),n._paddingBox=n._paddingBox||n.measureBox(o,"padding"),n._marginBox=n._marginBox||n.measureBox(o,"margin"),a=r.getSize(o),c=t.minWidth,l=t.minHeight,s=c||a.width,h=l||a.height,i=t.width,u=t.height,e=t.autoResize,e=typeof e!="undefined"?e:!i&&!u,i=i||s,u=u||h;var v=f.left+f.right,y=f.top+f.bottom,w=t.maxWidth||65535,b=t.maxHeight||65535;return n._layoutRect=p={x:t.x||0,y:t.y||0,w:i,h:u,deltaW:v,deltaH:y,contentW:i-v,contentH:u-y,innerW:i-v,innerH:u-y,startMinWidth:c||0,startMinHeight:l||0,minW:Math.min(s,w),minH:Math.min(h,b),maxW:w,maxH:b,autoResize:e,scrollW:0},n._lastLayoutRect={},p},layoutRect:function(n){var e=this,t=e._layoutRect,u,i,o,s,r,h;return(t||(t=e.initLayoutRect()),n)?(o=t.deltaW,s=t.deltaH,n.x!==r&&(t.x=n.x),n.y!==r&&(t.y=n.y),n.minW!==r&&(t.minW=n.minW),n.minH!==r&&(t.minH=n.minH),i=n.w,i!==r&&(i=i<t.minW?t.minW:i,i=i>t.maxW?t.maxW:i,t.w=i,t.innerW=i-o),i=n.h,i!==r&&(i=i<t.minH?t.minH:i,i=i>t.maxH?t.maxH:i,t.h=i,t.innerH=i-s),i=n.innerW,i!==r&&(i=i<t.minW-o?t.minW-o:i,i=i>t.maxW-o?t.maxW-o:i,t.innerW=i,t.w=i+o),i=n.innerH,i!==r&&(i=i<t.minH-s?t.minH-s:i,i=i>t.maxH-s?t.maxH-s:i,t.innerH=i,t.h=i+s),n.contentW!==r&&(t.contentW=n.contentW),n.contentH!==r&&(t.contentH=n.contentH),u=e._lastLayoutRect,(u.x!==t.x||u.y!==t.y||u.w!==t.w||u.h!==t.h)&&(h=f.repaintControls,h&&h.map&&!h.map[e._id]&&(h.push(e),h.map[e._id]=!0),u.x=t.x,u.y=t.y,u.w=t.w,u.h=t.h),e):t},repaint:function(){var i=this,u,f,n,e,o=0,s=0,t,r;r=document.createRange?function(n){return n}:Math.round,u=i.getEl().style,n=i._layoutRect,t=i._lastRepaintRect||{},e=i._borderBox,o=e.left+e.right,s=e.top+e.bottom,n.x!==t.x&&(u.left=r(n.x)+"px",t.x=n.x),n.y!==t.y&&(u.top=r(n.y)+"px",t.y=n.y),n.w!==t.w&&(u.width=r(n.w-o)+"px",t.w=n.w),n.h!==t.h&&(u.height=r(n.h-s)+"px",t.h=n.h),i._hasBody&&n.innerW!==t.innerW&&(f=i.getEl("body").style,f.width=r(n.innerW)+"px",t.innerW=n.innerW),i._hasBody&&n.innerH!==t.innerH&&(f=f||i.getEl("body").style,f.height=r(n.innerH)+"px",t.innerH=n.innerH),i._lastRepaintRect=t,i.fire("repaint",{},!1)},on:function(n,t){function s(n){var t,r;return function(u){return t||i.parents().each(function(i){var u=i.settings.callbacks;if(u&&(t=u[n]))return r=i,!1}),t.call(r,u)}}var i=this,r,u,f,o;if(t)for(typeof t=="string"&&(t=s(t)),f=n.toLowerCase().split(" "),o=f.length;o--;)n=f[o],r=i._bindings,r||(r=i._bindings={}),u=r[n],u||(u=r[n]=[]),u.push(t),e[n]&&(i._nativeEvents?i._nativeEvents[n]=!0:i._nativeEvents={name:!0},i._rendered&&i.bindPendingEvents());return i},off:function(n,t){var r=this,e,u=r._bindings,i,s,o,f;if(u)if(n)for(o=n.toLowerCase().split(" "),e=o.length;e--;){if(n=o[e],i=u[n],!n){for(s in u)u[s].length=0;return r}if(i)if(t)for(f=i.length;f--;)i[f]===t&&i.splice(f,1);else i.length=0}else r._bindings=[];return r},fire:function(n,t,i){function o(){return!1}function s(){return!0}var r=this,f,h,e,u;if(n=n.toLowerCase(),t=t||{},t.type||(t.type=n),t.control||(t.control=r),t.preventDefault||(t.preventDefault=function(){t.isDefaultPrevented=s},t.stopPropagation=function(){t.isPropagationStopped=s},t.stopImmediatePropagation=function(){t.isImmediatePropagationStopped=s},t.isDefaultPrevented=o,t.isPropagationStopped=o,t.isImmediatePropagationStopped=o),r._bindings&&(e=r._bindings[n],e))for(f=0,h=e.length;f<h;f++)if(!t.isImmediatePropagationStopped()&&e[f].call(r,t)===!1)break;if(i!==!1)for(u=r.parent();u&&!t.isPropagationStopped();)u.fire(n,t,!1),u=u.parent();return t},hasEventListeners:function(n){return n in this._bindings},parents:function(n){for(var t=this,r=new i,t=t.parent();t;t=t.parent())r.add(t);return n&&(r=r.filter(n)),r},next:function(){var n=this.parent().items();return n[n.indexOf(this)+1]},prev:function(){var n=this.parent().items();return n[n.indexOf(this)-1]},findCommonAncestor:function(n,t){for(var i;n;){for(i=t;i&&n!=i;)i=i.parent();if(n==i)break;n=n.parent()}return n},hasClass:function(n,t){var i=this._classes[t||"control"];return n=this.classPrefix+n,i&&!!i.map[n]},addClass:function(n,t){var r=this,i,u;return n=this.classPrefix+n,i=r._classes[t||"control"],i||(i=[],i.map={},r._classes[t||"control"]=i),i.map[n]||(i.map[n]=n,i.push(n),r._rendered&&(u=r.getEl(t),u&&(u.className=i.join(" ")))),r},removeClass:function(n,t){var r=this,i,u,f;if(n=this.classPrefix+n,i=r._classes[t||"control"],i&&i.map[n])for(delete i.map[n],u=i.length;u--;)i[u]===n&&i.splice(u,1);return r._rendered&&(f=r.getEl(t),f&&(f.className=i.join(" "))),r},toggleClass:function(n,t,i){var r=this;return t?r.addClass(n,i):r.removeClass(n,i),r},classes:function(n){var t=this._classes[n||"control"];return t?t.join(" "):""},innerHtml:function(n){return r.innerHtml(this.getEl(),n),this},getEl:function(n,t){var i=n?this._id+"-"+n:this._id;return u[i]=(t===!0?null:u[i])||r.get(i)},visible:function(n){var t=this,i;return typeof n!="undefined"?(t._visible!==n&&(t._rendered&&(t.getEl().style.display=n?"":"none"),t._visible=n,i=t.parent(),i&&(i._lastRect=null),t.fire(n?"show":"hide")),t):t._visible},show:function(){return this.visible(!0)},hide:function(){return this.visible(!1)},focus:function(){try{this.getEl().focus()}catch(n){}return this},blur:function(){return this.getEl().blur(),this},aria:function(n,t){var i=this,r=i.getEl();return typeof t=="undefined"?i._aria[n]:(i._aria[n]=t,i._rendered&&(n=="label"&&r.setAttribute("aria-labelledby",i._id),r.setAttribute(n=="role"?n:"aria-"+n,t)),i)},encode:function(n,t){return t!==!1&&f.translate&&(n=f.translate(n)),(n||"").replace(/[&<>"]/g,function(n){return"&#"+n.charCodeAt(0)+";"})},before:function(n){var t=this,i=t.parent();return i&&i.insert(n,i.items().indexOf(t),!0),t},after:function(n){var t=this,i=t.parent();return i&&i.insert(n,i.items().indexOf(t)),t},remove:function(){var n=this,t=n.getEl(),f=n.parent(),e,i,o,s,h;if(n.items)for(o=n.items().toArray(),i=o.length;i--;)o[i].remove();if(f&&f.items&&(e=[],f.items().each(function(t){t!==n&&e.push(t)}),f.items().set(e),f._lastRect=null),n._eventsRoot&&n._eventsRoot==n&&r.off(t),s=n.getRoot().controlIdLookup,s&&delete s[n._id],delete u[n._id],t&&t.parentNode){for(h=t.getElementsByTagName("*"),i=h.length;i--;)delete u[h[i].id];t.parentNode.removeChild(t)}return n._rendered=!1,n},renderBefore:function(n){var t=this;return n.parentNode.insertBefore(r.createFragment(t.renderHtml()),n),t.postRender(),t},renderTo:function(n){var t=this;return n=n||t.getContainerElm(),n.appendChild(r.createFragment(t.renderHtml())),t.postRender(),t},postRender:function(){var n=this,i=n.settings,e,u,f,t,o,s,h;for(t in i)if(t.indexOf("on")===0)n.on(t.substr(2),i[t]);if(n._eventsRoot){for(f=n.parent();!o&&f;f=f.parent())o=f._eventsRoot;if(o)for(t in o._nativeEvents)n._nativeEvents[t]=!0}n.bindPendingEvents(),i.style&&(e=n.getEl(),e&&(e.setAttribute("style",i.style),e.style.cssText=i.style)),n._visible||r.css(n.getEl(),"display","none"),n.settings.border&&(u=n.borderBox(),r.css(n.getEl(),{"border-top-width":u.top,"border-right-width":u.right,"border-bottom-width":u.bottom,"border-left-width":u.left})),s=n.getRoot(),s.controlIdLookup||(s.controlIdLookup={}),s.controlIdLookup[n._id]=n;for(h in n._aria)n.aria(h,n._aria[h]);n.fire("postrender",{},!1)},scrollIntoView:function(n){function c(n,t){for(var u,i=n,r=u=0;i&&i!=t&&i.nodeType;)r+=i.offsetLeft||0,u+=i.offsetTop||0,i=i.offsetParent;return{x:r,y:u}}var i=this.getEl(),t=i.parentNode,r,u,f,e,o,s,h=c(i,t);return r=h.x,u=h.y,f=i.offsetWidth,e=i.offsetHeight,o=t.clientWidth,s=t.clientHeight,n=="end"?(r-=o-f,u-=s-e):n=="center"&&(r-=o/2-f/2,u-=s/2-e/2),t.scrollLeft=r,t.scrollTop=u,this},bindPendingEvents:function(){function l(n){var i=t.getParentCtrl(n.target);i&&i.fire(n.type,n)}function a(){var t=n._lastHoverCtrl;t&&(t.fire("mouseleave",{target:t.getEl()}),t.parents().each(function(n){n.fire("mouseleave",{target:n.getEl()})}),n._lastHoverCtrl=null)}function v(i){var u=t.getParentCtrl(i.target),f=n._lastHoverCtrl,e=0,r,s,o;if(u!==f){if(n._lastHoverCtrl=u,s=u.parents().toArray().reverse(),s.push(u),f){for(o=f.parents().toArray().reverse(),o.push(f),e=0;e<o.length;e++)if(s[e]!==o[e])break;for(r=o.length-1;r>=e;r--)f=o[r],f.fire("mouseleave",{target:f.getEl()})}for(r=e;r<s.length;r++)u=s[r],u.fire("mouseenter",{target:u.getEl()})}}function c(n){n.preventDefault(),n.type=="mousewheel"?(n.deltaY=-1/40*n.wheelDelta,n.wheelDeltaX&&(n.deltaX=-1/40*n.wheelDeltaX)):(n.deltaX=0,n.deltaY=n.detail),n=t.fire("wheel",n)}var t=this,i,h,f,n,e,u;if(t._rendered=!0,e=t._nativeEvents,e){for(f=t.parents().toArray(),f.unshift(t),i=0,h=f.length;!n&&i<h;i++)n=f[i]._eventsRoot;for(n||(n=f[f.length-1]||t),t._eventsRoot=n,h=i,i=0;i<h;i++)f[i]._eventsRoot=n;for(u in e){if(!e)return!1;if(u==="wheel"&&!s){if(o)r.on(t.getEl(),"mousewheel",c);else r.on(t.getEl(),"DOMMouseScroll",c);continue}if(u==="mouseenter"||u==="mouseleave"){if(!n._hasMouseEnter){r.on(n.getEl(),"mouseleave",a);r.on(n.getEl(),"mouseover",v);n._hasMouseEnter=1}}else if(!n[u]){r.on(n.getEl(),u,l);n[u]=!0}e[u]=!1}}},getRoot:function(){for(var n=this,t,i=[],r;n;){if(n.rootControl){t=n.rootControl;break}i.push(n),t=n,n=n.parent()}for(t||(t=this),r=i.length;r--;)i[r].rootControl=t;return t},reflow:function(){return this.repaint(),this}});return f}),i("tinymce/ui/Factory",[],function(){var n={},t;return{add:function(t,i){n[t.toLowerCase()]=i},has:function(t){return!!n[t.toLowerCase()]},create:function(i,r){var u,f,e;if(!t){e=tinymce.ui;for(f in e)n[f.toLowerCase()]=e[f];t=!0}if(typeof i=="string"?(r=r||{},r.type=i):(r=i,i=r.type),i=i.toLowerCase(),u=n[i],!u)throw new Error("Could not find control by type: "+i);return u=new u(r),u.type=i,u}}}),i("tinymce/ui/Container",["tinymce/ui/Control","tinymce/ui/Collection","tinymce/ui/Selector","tinymce/ui/Factory","tinymce/util/Tools","tinymce/ui/DomUtils"],function(n,t,i,r,u,f){var e={};return n.extend({layout:"",innerClass:"container-inner",init:function(n){var i=this;i._super(n),n=i.settings,i._fixed=n.fixed,i._items=new t,i.isRtl()&&i.addClass("rtl"),i.addClass("container"),i.addClass("container-body","body"),n.containerCls&&i.addClass(n.containerCls),i._layout=r.create((n.layout||i.layout)+"layout"),i.settings.items&&i.add(i.settings.items),i._hasBody=!0},items:function(){return this._items},find:function(n){return n=e[n]=e[n]||new i(n),n.find(this)},add:function(n){var t=this;return t.items().add(t.create(n)).parent(t),t},focus:function(){var n=this;return n.keyNav?n.keyNav.focusFirst():n._super(),n},replace:function(n,t){for(var i,u=this.items(),r=u.length;r--;)if(u[r]===n){u[r]=t;break}r>=0&&(i=t.getEl(),i&&i.parentNode.removeChild(i),i=n.getEl(),i&&i.parentNode.removeChild(i)),t.parent(this)},create:function(t){var f=this,i,e=[];return u.isArray(t)||(t=[t]),u.each(t,function(t){t&&(t instanceof n||(typeof t=="string"&&(t={type:t}),i=u.extend({},f.settings.defaults,t),t.type=i.type=i.type||t.type||f.settings.defaultType||(i.defaults?i.defaults.type:null),t=r.create(i)),e.push(t))}),e},renderNew:function(){var n=this;return n.items().each(function(t,i){var r,u;t.parent(n),t._rendered||(r=n.getEl("body"),u=f.createFragment(t.renderHtml()),r.hasChildNodes()&&i<=r.childNodes.length-1?r.insertBefore(u,r.childNodes[i]):r.appendChild(u),t.postRender())}),n._layout.applyClasses(n),n._lastRect=null,n},append:function(n){return this.add(n).renderNew()},prepend:function(n){var t=this;return t.items().set(t.create(n).concat(t.items().toArray())),t.renderNew()},insert:function(n,t,i){var u=this,r,f,e;return n=u.create(n),r=u.items(),!i&&t<r.length-1&&(t+=1),t>=0&&t<r.length&&(f=r.slice(0,t).toArray(),e=r.slice(t).toArray(),r.set(f.concat(n,e))),u.renderNew()},fromJSON:function(n){var i=this,t;for(t in n)i.find("#"+t).value(n[t]);return i},toJSON:function(){var t=this,n={};return t.find("*").each(function(t){var i=t.name(),r=t.value();i&&typeof r!="undefined"&&(n[i]=r)}),n},preRender:function(){},renderHtml:function(){var n=this,t=n._layout,i=this.settings.role;return n.preRender(),t.preRender(n),'<div id="'+n._id+'" class="'+n.classes()+'"'+(i?' role="'+this.settings.role+'"':"")+'><div id="'+n._id+'-body" class="'+n.classes("body")+'">'+(n.settings.html||"")+t.renderHtml(n)+"<\/div><\/div>"},postRender:function(){var n=this,t;return n.items().exec("postRender"),n._super(),n._layout.postRender(n),n._rendered=!0,n.settings.style&&f.css(n.getEl(),n.settings.style),n.settings.border&&(t=n.borderBox(),f.css(n.getEl(),{"border-top-width":t.top,"border-right-width":t.right,"border-bottom-width":t.bottom,"border-left-width":t.left})),n},initLayoutRect:function(){var n=this,t=n._super();return n._layout.recalc(n),t},recalc:function(){var t=this,n=t._layoutRect,i=t._lastRect;if(!i||i.w!=n.w||i.h!=n.h)return t._layout.recalc(t),n=t.layoutRect(),t._lastRect={x:n.x,y:n.y,w:n.w,h:n.h},!0},reflow:function(){var t,i;if(this.visible()){for(n.repaintControls=[],n.repaintControls.map={},i=this.recalc(),t=n.repaintControls.length;t--;)n.repaintControls[t].repaint();this.settings.layout!=="flow"&&this.settings.layout!=="stack"&&this.repaint(),n.repaintControls=[]}return this}})}),i("tinymce/ui/DragHelper",["tinymce/ui/DomUtils"],function(n){function t(){var f=document,n,t,r,e,o,u,s,h,i=Math.max;return n=f.documentElement,t=f.body,r=i(n.scrollWidth,t.scrollWidth),e=i(n.clientWidth,t.clientWidth),o=i(n.offsetWidth,t.offsetWidth),u=i(n.scrollHeight,t.scrollHeight),s=i(n.clientHeight,t.clientHeight),h=i(n.offsetHeight,t.offsetHeight),{width:r<o?e:r,height:u<h?s:u}}return function(i,r){function s(){return u.getElementById(r.handle||i)}var f,u=document,h,c,e,o,l,a;r=r||{},c=function(i){var v=t(),c,y;i.preventDefault(),h=i.button,c=s(),l=i.screenX,a=i.screenY,y=window.getComputedStyle?window.getComputedStyle(c,null).getPropertyValue("cursor"):c.runtimeStyle.cursor,f=u.createElement("div"),n.css(f,{position:"absolute",top:0,left:0,width:v.width,height:v.height,zIndex:2147483647,opacity:.0001,background:"red",cursor:y}),u.body.appendChild(f);n.on(u,"mousemove",o);n.on(u,"mouseup",e);r.start(i)},o=function(n){if(n.button!==h)return e(n);n.deltaX=n.screenX-l,n.deltaY=n.screenY-a,n.preventDefault(),r.drag(n)},e=function(t){n.off(u,"mousemove",o),n.off(u,"mouseup",e),f.parentNode.removeChild(f),r.stop&&r.stop(t)},this.destroy=function(){n.off(s())};n.on(s(),"mousedown",c)}}),i("tinymce/ui/Scrollable",["tinymce/ui/DomUtils","tinymce/ui/DragHelper"],function(n,t){return{init:function(){var n=this;n.on("repaint",n.renderScroll)},renderScroll:function(){function u(){function e(t,e,o,s,h,c){var v,a,k,y,d,w,l,p,b;if(a=i.getEl("scroll"+t),a){if(p=e.toLowerCase(),b=o.toLowerCase(),i.getEl("absend")&&n.css(i.getEl("absend"),p,i.layoutRect()[s]-1),!h){n.css(a,"display","none");return}n.css(a,"display","block"),v=i.getEl("body"),k=i.getEl("scroll"+t+"t"),y=v["client"+o]-r*2,y-=u&&f?a["client"+c]:0,d=v["scroll"+o],w=y/d,l={},l[p]=v["offset"+e]+r,l[b]=y,n.css(a,l),l={},l[p]=v["scroll"+e]*w,l[b]=y*w,n.css(k,l)}}var u,f,t;t=i.getEl("body"),u=t.scrollWidth>t.clientWidth,f=t.scrollHeight>t.clientHeight,e("h","Left","Width","contentW",u,"Height"),e("v","Top","Height","contentH",f,"Width")}function f(){function u(u,f,e,o,s){var l,h=i._id+"-scroll"+u,c=i.classPrefix;i.getEl().appendChild(n.createFragment('<div id="'+h+'" class="'+c+"scrollbar "+c+"scrollbar-"+u+'"><div id="'+h+'t" class="'+c+'scrollbar-thumb"><\/div><\/div>')),i.draghelper=new t(h+"t",{start:function(){l=i.getEl("body")["scroll"+f],n.addClass(n.get(h),c+"active")},drag:function(n){var c,a,v,h,t=i.layoutRect();a=t.contentW>t.innerW,v=t.contentH>t.innerH,h=i.getEl("body")["client"+e]-r*2,h-=a&&v?i.getEl("scroll"+u)["client"+s]:0,c=h/i.getEl("body")["scroll"+e],i.getEl("body")["scroll"+f]=l+n["delta"+o]/c},stop:function(){n.removeClass(n.get(h),c+"active")}})}i.addClass("scroll"),u("v","Top","Height","Y","Width"),u("h","Left","Width","X","Height")}var i=this,r=2;if(i.settings.autoScroll){if(!i._hasScroll){i._hasScroll=!0,f();i.on("wheel",function(n){var t=i.getEl("body");t.scrollLeft+=(n.deltaX||0)*10,t.scrollTop+=n.deltaY*10,u()});n.on(i.getEl("body"),"scroll",u)}u()}}}}),i("tinymce/ui/Panel",["tinymce/ui/Container","tinymce/ui/Scrollable"],function(n,t){return n.extend({Defaults:{layout:"fit",containerCls:"panel"},Mixins:[t],renderHtml:function(){var n=this,i=n._layout,t=n.settings.html;return n.preRender(),i.preRender(n),typeof t=="undefined"?t='<div id="'+n._id+'-body" class="'+n.classes("body")+'">'+i.renderHtml(n)+"<\/div>":(typeof t=="function"&&(t=t.call(n)),n._hasBody=!1),'<div id="'+n._id+'" class="'+n.classes()+'" hideFocus="1" tabIndex="-1">'+(n._preBodyHtml||"")+t+"<\/div>"}})}),i("tinymce/ui/Movable",["tinymce/ui/DomUtils"],function(n){function t(t,i,r){var v,h,u,f,o,s,c,l,a,e;return a=n.getViewPort(),h=n.getPos(i),u=h.x,f=h.y,t._fixed&&(u-=a.x,f-=a.y),v=t.getEl(),e=n.getSize(v),o=e.width,s=e.height,e=n.getSize(i),c=e.width,l=e.height,r=(r||"").split(""),r[0]==="b"&&(f+=l),r[1]==="r"&&(u+=c),r[0]==="c"&&(f+=Math.round(l/2)),r[1]==="c"&&(u+=Math.round(c/2)),r[3]==="b"&&(f-=s),r[4]==="r"&&(u-=o),r[3]==="c"&&(f-=Math.round(s/2)),r[4]==="c"&&(u-=Math.round(o/2)),{x:u,y:f,w:o,h:s}}return{testMoveRel:function(i,r){for(var f=n.getViewPort(),u,e=0;e<r.length;e++)if(u=t(this,i,r[e]),this._fixed){if(u.x>0&&u.x+u.w<f.w&&u.y>0&&u.y+u.h<f.h)return r[e]}else if(u.x>f.x&&u.x+u.w<f.w+f.x&&u.y>f.y&&u.y+u.h<f.h+f.y)return r[e];return r[0]},moveRel:function(n,i){typeof i!="string"&&(i=this.testMoveRel(n,i));var r=t(this,n,i);return this.moveTo(r.x,r.y)},moveBy:function(n,t){var i=this,r=i.layoutRect();return i.moveTo(r.x+n,r.y+t),i},moveTo:function(t,i){function e(n,t,i){return n<0?0:n+i>t?(n=t-i,n<0?0:n):n}var r=this,u,f;return r.settings.constrainToViewport&&(u=n.getViewPort(window),f=r.layoutRect(),t=e(t,u.w+u.x,f.w),i=e(i,u.h+u.y,f.h)),r._rendered?r.layoutRect({x:t,y:i}).repaint():(r.settings.x=t,r.settings.y=i),r.fire("move",{x:t,y:i}),r}}}),i("tinymce/ui/Resizable",["tinymce/ui/DomUtils"],function(n){return{resizeToContent:function(){this._layoutRect.autoResize=!0,this._lastRect=null,this.reflow()},resizeTo:function(t,i){if(t<=1||i<=1){var r=n.getWindowSize();t=t<=1?t*r.w:t,i=i<=1?i*r.h:i}return this._layoutRect.autoResize=!1,this.layoutRect({minW:t,minH:i,w:t,h:i}).reflow()},resizeBy:function(n,t){var i=this,r=i.layoutRect();return i.resizeTo(r.w+n,r.h+t)}}}),i("tinymce/ui/FloatPanel",["tinymce/ui/Panel","tinymce/ui/Movable","tinymce/ui/Resizable","tinymce/ui/DomUtils"],function(n,t,i,r){function c(n){for(var t=u.length;t--;)u[t]===n&&u.splice(t,1);for(t=f.length;t--;)f[t]===n&&f.splice(t,1)}var o,s,u=[],f=[],h,e=n.extend({Mixins:[t,i],init:function(n){function i(){var n,i=e.zIndex||65535,o,u;if(f.length)for(n=0;n<f.length;n++)f[n].modal&&(i++,o=f[n]),f[n].getEl().style.zIndex=i,f[n].zIndex=i,i++;u=document.getElementById(t.classPrefix+"modal-block"),o?r.css(u,"z-index",o.zIndex-1):u&&(u.parentNode.removeChild(u),h=!1),e.currentZIndex=i}function l(n,t){while(n){if(n==t)return!0;n=n.parent()}}function c(n){function i(t,i){for(var f,r=0;r<u.length;r++)if(u[r]!=n)for(f=u[r].parent();f&&(f=f.parent());)f==n&&u[r].fixed(t).moveBy(0,i).repaint()}var t=r.getViewPort().y;n.settings.autofix&&(n._fixed?n._autoFixY>t&&(n.fixed(!1).layoutRect({y:n._autoFixY}).repaint(),i(!1,n._autoFixY-t)):(n._autoFixY=n.layoutRect().y,n._autoFixY<t&&(n.fixed(!0).layoutRect({y:0}).repaint(),i(!0,t-n._autoFixY))))}var t=this;if(t._super(n),t._eventsRoot=t,t.addClass("floatpanel"),n.autohide){if(!o){o=function(n){for(var r=u.length,t,i;r--;)if(t=u[r],i=t.getParentCtrl(n.target),t.settings.autohide){if(i&&(l(i,t)||t.parent()===i))continue;n=t.fire("autohide",{target:n.target}),n.isDefaultPrevented()||t.hide()}};r.on(document,"click",o)}u.push(t)}if(n.autofix){if(!s){s=function(){for(var n=u.length;n--;)c(u[n])};r.on(window,"scroll",s)}t.on("move",function(){c(this)})}t.on("postrender show",function(n){if(n.control==t){var u,e=t.classPrefix;t.modal&&!h&&(u=r.createFragment('<div id="'+e+'modal-block" class="'+e+"reset "+e+'fade"><\/div>'),u=u.firstChild,t.getContainerElm().appendChild(u),setTimeout(function(){r.addClass(u,e+"in"),r.addClass(t.getEl(),e+"in")},0),h=!0),f.push(t),i()}});t.on("close hide",function(n){if(n.control==t){for(var r=f.length;r--;)f[r]===t&&f.splice(r,1);i()}});t.on("show",function(){t.parents().each(function(n){if(n._fixed)return t.fixed(!0),!1})});n.popover&&(t._preBodyHtml='<div class="'+t.classPrefix+'arrow"><\/div>',t.addClass("popover").addClass("bottom").addClass(t.isRtl()?"end":"start"))},fixed:function(n){var t=this,i;return t._fixed!=n&&(t._rendered&&(i=r.getViewPort(),n?t.layoutRect().y-=i.y:t.layoutRect().y+=i.y),t.toggleClass("fixed",n),t._fixed=n),t},show:function(){for(var t=this,i=t._super(),n=u.length;n--;)if(u[n]===t)break;return n===-1&&u.push(t),i},hide:function(){return c(this),this._super()},hideAll:function(){e.hideAll()},close:function(){var n=this;return n.fire("close"),n.remove()},remove:function(){c(this),this._super()}});return e.hideAll=function(){for(var t=u.length,n;t--;)n=u[t],n.settings.autohide&&(n.fire("cancel",{},!1),n.hide(),u.splice(t,1))},e}),i("tinymce/ui/KeyboardNavigation",["tinymce/ui/DomUtils"],function(n){return function(t){function h(){var t,n;if(!i)if(i=[],r.find)r.find("*").each(function(n){n.canFocus&&i.push(n.getEl())});else for(t=r.getEl().getElementsByTagName("*"),n=0;n<t.length;n++)t[n].id&&t[n]&&i.push(t[n])}function e(){return document.getElementById(u)}function o(n){return n=n||e(),n&&n.getAttribute("role")}function a(n){for(var i,t=n||e();t=t.parentNode;)if(i=o(t))return i}function v(n){var t=document.getElementById(u);if(t)return t.getAttribute("aria-"+n)}function s(){var i=e();if(!i||i.nodeName!="TEXTAREA"&&i.type!="text"){if(t.onAction)t.onAction(u);else n.fire(e(),"click",{keyboard:!0});return!0}}function y(){var n;t.onCancel?((n=e())&&n.blur(),t.onCancel()):t.root.fire("cancel")}function f(n){function l(n){for(var t=r?r.getEl():document.body;n&&n!=t;){if(n.style.display=="none")return!1;n=n.parentNode}return!0}var e=-1,c,f,o=[];for(h(),f=o.length,f=0;f<i.length;f++)l(i[f])&&o.push(i[f]);for(f=o.length;f--;)if(o[f].id===u){e=f;break}e+=n,e<0?e=o.length-1:e>=o.length&&(e=0),c=o[e],c.focus(),u=c.id,t.actOnFocus&&s()}function p(){var n,r;for(r=o(t.root.getEl()),h(),n=i.length;n--;)if(r=="toolbar"&&i[n].id===u){i[n].focus();return}i[0].focus()}var r=t.root,c=t.enableUpDown!==!1,l=t.enableLeftRight!==!1,i=t.items,u;r.on("keydown",function(n){var i;switch(n.keyCode){case 37:l&&(t.leftAction?t.leftAction():f(-1),i=!0);break;case 39:l&&(o()=="menuitem"&&a()=="menu"?v("haspopup")&&s():f(1),i=!0);break;case 38:c&&(f(-1),i=!0);break;case 40:c&&(o()=="menuitem"&&a()=="menubar"?s():o()=="button"&&v("haspopup")?s():f(1),i=!0);break;case 9:i=!0,n.shiftKey?f(-1):f(1);break;case 27:i=!0,y();break;case 14:case 13:case 32:i=s()}i&&(n.stopPropagation(),n.preventDefault())});r.on("focusin",function(n){h(),u=n.target.id});return{moveFocus:f,focusFirst:p,cancel:y}}}),i("tinymce/ui/Window",["tinymce/ui/FloatPanel","tinymce/ui/Panel","tinymce/ui/DomUtils","tinymce/ui/KeyboardNavigation","tinymce/ui/DragHelper"],function(n,t,i,r,u){return n.extend({modal:!0,Defaults:{border:1,layout:"flex",containerCls:"panel",role:"dialog",callbacks:{submit:function(){this.fire("submit",{data:this.toJSON()})},close:function(){this.close()}}},init:function(n){var i=this;i._super(n),i.isRtl()&&i.addClass("rtl"),i.addClass("window"),i._fixed=!0,n.buttons&&(i.statusbar=new t({layout:"flex",border:"1 0 0 0",spacing:3,padding:10,align:"center",pack:i.isRtl()?"start":"end",defaults:{type:"button"},items:n.buttons}),i.statusbar.addClass("foot"),i.statusbar.parent(i));i.on("click",function(n){n.target.className.indexOf(i.classPrefix+"close")!=-1&&i.close()});i.aria("label",n.title),i._fullscreen=!1},recalc:function(){var n=this,f=n.statusbar,t,r,u,e;n._fullscreen&&(n.layoutRect(i.getWindowSize()),n.layoutRect().contentH=n.layoutRect().innerH),n._super(),t=n.layoutRect(),n.settings.title&&!n._fullscreen&&(r=t.headerW,r>t.w&&(u=t.x-Math.max(0,r/2),n.layoutRect({w:r,x:u}),e=!0)),f&&(f.layoutRect({w:n.layoutRect().innerW}).recalc(),r=f.layoutRect().minW+t.deltaW,r>t.w&&(u=t.x-Math.max(0,r-t.w),n.layoutRect({w:r,x:u}),e=!0)),e&&n.recalc()},initLayoutRect:function(){var t=this,n=t._super(),r=0,e,u,f;return t.settings.title&&!t._fullscreen&&(e=t.getEl("head"),u=i.getSize(e),n.headerW=u.width,n.headerH=u.height,r+=n.headerH),t.statusbar&&(r+=t.statusbar.layoutRect().h),n.deltaH+=r,n.minH+=r,n.h+=r,f=i.getWindowSize(),n.x=Math.max(0,f.w/2-n.w/2),n.y=Math.max(0,f.h/2-n.h/2),n},renderHtml:function(){var n=this,f=n._layout,i=n._id,r=n.classPrefix,t=n.settings,e="",o="",u=t.html;return n.preRender(),f.preRender(n),t.title&&(e='<div id="'+i+'-head" class="'+r+'window-head"><div class="'+r+'title">'+n.encode(t.title)+'<\/div><button type="button" class="'+r+'close" aria-hidden="true">&times;<\/button><div id="'+i+'-dragh" class="'+r+'dragh"><\/div><\/div>'),t.url&&(u='<iframe src="'+t.url+'" tabindex="-1"><\/iframe>'),typeof u=="undefined"&&(u=f.renderHtml(n)),n.statusbar&&(o=n.statusbar.renderHtml()),'<div id="'+i+'" class="'+n.classes()+'" hideFocus="1" tabIndex="-1">'+e+'<div id="'+i+'-body" class="'+n.classes("body")+'">'+u+"<\/div>"+o+"<\/div>"},fullscreen:function(n){var t=this,e=document.documentElement,o,u=t.classPrefix,r,f;if(n!=t._fullscreen){i.on(window,"resize",function(){var r,n;t._fullscreen&&(o?t._timer||(t._timer=setTimeout(function(){var n=i.getWindowSize();t.moveTo(0,0).resizeTo(n.w,n.h),t._timer=0},50)):(r=(new Date).getTime(),n=i.getWindowSize(),t.moveTo(0,0).resizeTo(n.w,n.h),(new Date).getTime()-r>50&&(o=!0)))});r=t.layoutRect(),t._fullscreen=n,n?(t._initial={x:r.x,y:r.y,w:r.w,h:r.h},t._borderBox=t.parseBox("0"),t.getEl("head").style.display="none",r.deltaH-=r.headerH+2,i.addClass(e,u+"fullscreen"),i.addClass(document.body,u+"fullscreen"),t.addClass("fullscreen"),f=i.getWindowSize(),t.moveTo(0,0).resizeTo(f.w,f.h)):(t._borderBox=t.parseBox(t.settings.border),t.getEl("head").style.display="",r.deltaH+=r.headerH,i.removeClass(e,u+"fullscreen"),i.removeClass(document.body,u+"fullscreen"),t.removeClass("fullscreen"),t.moveTo(t._initial.x,t._initial.y).resizeTo(t._initial.w,t._initial.h))}return t.reflow()},postRender:function(){var n=this,i=[],t,f,e;setTimeout(function(){n.addClass("in")},0),n.keyboardNavigation=new r({root:n,enableLeftRight:!1,enableUpDown:!1,items:i,onCancel:function(){n.close()}}),n.find("*").each(function(n){n.canFocus&&(f=f||n.settings.autofocus,t=t||n,n.subinput?(i.push(n.getEl("inp")),n.getEl("open")&&i.push(n.getEl("open"))):i.push(n.getEl()))}),n.statusbar&&n.statusbar.find("*").each(function(n){n.canFocus&&(f=f||n.settings.autofocus,t=t||n,i.push(n.getEl()))}),n._super(),n.statusbar&&n.statusbar.postRender(),!f&&t&&t.focus(),this.dragHelper=new u(n._id+"-dragh",{start:function(){e={x:n.layoutRect().x,y:n.layoutRect().y}},drag:function(t){n.moveTo(e.x+t.deltaX,e.y+t.deltaY)}});n.on("submit",function(t){t.isDefaultPrevented()||n.close()})},submit:function(){return this.fire("submit",{data:this.toJSON()})},remove:function(){var n=this,t=n.classPrefix;n.dragHelper.destroy(),n._super(),n.statusbar&&this.statusbar.remove(),n._fullscreen&&(i.removeClass(document.documentElement,t+"fullscreen"),i.removeClass(document.body,t+"fullscreen"))}})}),i("tinymce/ui/MessageBox",["tinymce/ui/Window"],function(n){var t=n.extend({init:function(n){n={border:1,padding:20,layout:"flex",pack:"center",align:"center",containerCls:"panel",autoScroll:!0,buttons:{type:"button",text:"Ok",action:"ok"},items:{type:"label",multiline:!0,maxWidth:500,maxHeight:200}},this._super(n)},Statics:{OK:1,OK_CANCEL:2,YES_NO:3,YES_NO_CANCEL:4,msgBox:function(i){var r,u=i.callback||function(){};switch(i.buttons){case t.OK_CANCEL:r=[{type:"button",text:"Ok",subtype:"primary",onClick:function(n){n.control.parents()[1].close(),u(!0)}},{type:"button",text:"Cancel",onClick:function(n){n.control.parents()[1].close(),u(!1)}}];break;case t.YES_NO:r=[{type:"button",text:"Ok",subtype:"primary",onClick:function(n){n.control.parents()[1].close(),u(!0)}}];break;case t.YES_NO_CANCEL:r=[{type:"button",text:"Ok",subtype:"primary",onClick:function(n){n.control.parents()[1].close()}}];break;default:r=[{type:"button",text:"Ok",subtype:"primary",onClick:function(n){n.control.parents()[1].close(),u(!0)}}]}return new n({padding:20,x:i.x,y:i.y,minWidth:300,minHeight:100,layout:"flex",pack:"center",align:"center",buttons:r,title:i.title,items:{type:"label",multiline:!0,maxWidth:500,maxHeight:200,text:i.text},onClose:i.onClose}).renderTo(document.body).reflow()},alert:function(n,i){return typeof n=="string"&&(n={text:n}),n.callback=i,t.msgBox(n)},confirm:function(n,i){return typeof n=="string"&&(n={text:n}),n.callback=i,n.buttons=t.OK_CANCEL,t.msgBox(n)}}});return t}),i("tinymce/WindowManager",["tinymce/ui/Window","tinymce/ui/MessageBox"],function(n,t){return function(i){function f(){if(r.length)return r[r.length-1]}var u=this,r=[];u.windows=r,u.open=function(t,u){var f;i.editorManager.activeEditor=i,t.title=t.title||" ",t.url=t.url||t.file,t.url&&(t.width=parseInt(t.width||320,10),t.height=parseInt(t.height||240,10)),t.body&&(t.items={defaults:t.defaults,type:t.bodyType||"form",items:t.body}),t.url||t.buttons||(t.buttons=[{text:"Ok",subtype:"primary",onclick:function(){f.find("form")[0].submit(),f.close()}},{text:"Cancel",onclick:function(){f.close()}}]),f=new n(t),r.push(f);f.on("close",function(){for(var n=r.length;n--;)r[n]===f&&r.splice(n,1);i.focus()});if(t.data)f.on("postRender",function(){this.find("*").each(function(n){var i=n.name();i in t.data&&n.value(t.data[i])})});return f.features=t||{},f.params=u||{},i.nodeChanged(),f.renderTo(document.body).reflow()},u.alert=function(n,i,r){t.alert(n,function(){i&&i.call(r||this)})},u.confirm=function(n,i,r){t.confirm(n,function(n){i.call(r||this,n)})},u.close=function(){f()&&f().close()},u.getParams=function(){return f()?f().params:null},u.setParams=function(n){f()&&(f().params=n)}}}),i("tinymce/util/Quirks",["tinymce/util/VK","tinymce/dom/RangeUtils","tinymce/html/Node","tinymce/html/Entities","tinymce/Env","tinymce/util/Tools"],function(n,t,i,r,u,f){return function(e){function c(n,t){try{e.getDoc().execCommand(n,!1,t)}catch(i){}}function y(){var n=e.getDoc().documentMode;return n?n:6}function h(n){return n.isDefaultPrevented()}function rt(){function t(n){var i=new MutationObserver(function(){}),t,r;f.each(e.getBody().getElementsByTagName("*"),function(n){n.tagName=="SPAN"&&n.setAttribute("mce-data-marked",1),!n.hasAttribute("data-mce-style")&&n.hasAttribute("style")&&e.dom.setAttrib(n,"style",n.getAttribute("style"))}),i.observe(e.getDoc(),{childList:!0,attributes:!0,subtree:!0,attributeFilter:["style"]}),e.getDoc().execCommand(n?"ForwardDelete":"Delete",!1,null),t=e.selection.getRng(),r=t.startContainer.parentNode,f.each(i.takeRecords(),function(n){if(n.attributeName=="style"){var i=n.target.getAttribute("data-mce-style");i?n.target.setAttribute("style",i):n.target.removeAttribute("style")}f.each(n.addedNodes,function(n){if(n.nodeName=="SPAN"&&!n.getAttribute("mce-data-marked")){var u,i;n==r&&(u=t.startOffset,i=n.firstChild),o.remove(n,!0),i&&(t.setStart(i,u),t.setEnd(i,u),e.selection.setRng(t))}})}),i.disconnect(),f.each(e.dom.select("span[mce-data-marked]"),function(n){n.removeAttribute("mce-data-marked")})}var i=e.getDoc();if(window.MutationObserver){e.on("keydown",function(i){var r=i.keyCode==p,f=n.metaKeyPressed(i);if(!h(i)&&(r||i.keyCode==l)){var u=e.selection.getRng(),o=u.startContainer,s=u.startOffset;if(!f&&u.collapsed&&o.nodeType==3&&(r?s<o.data.length:s>0))return;i.preventDefault(),f&&e.selection.getSel().modify("extend",r?"forward":"backward","word"),t(r)}});e.on("keypress",function(i){h(i)||s.isCollapsed()||!i.charCode||n.metaKeyPressed(i)||(i.preventDefault(),t(!0),e.selection.setContent(String.fromCharCode(i.charCode)))});e.addCommand("Delete",function(){t()}),e.addCommand("ForwardDelete",function(){t(!0)});e.on("dragstart",function(n){n.dataTransfer.setData("mce-internal",e.selection.getContent())});e.on("drop",function(n){if(!h(n)){var r=n.dataTransfer.getData("mce-internal");r&&i.caretRangeFromPoint&&(n.preventDefault(),t(),e.selection.setRng(i.caretRangeFromPoint(n.x,n.y)),e.insertContent(r))}});e.on("cut",function(n){!h(n)&&n.clipboardData&&(n.preventDefault(),n.clipboardData.clearData(),n.clipboardData.setData("text/html",e.selection.getContent()),n.clipboardData.setData("text/plain",e.selection.getContent({format:"text"})),t(!0))})}}function ut(){function n(n){var t=o.create("body"),i=n.cloneContents();return t.appendChild(i),s.serializer.serialize(t,{format:"html"})}function i(i){var r,f,u,s;return i.setStart?(f=n(i),u=o.createRng(),u.selectNode(e.getBody()),s=n(u),f===s):i.item?!1:(r=i.duplicate(),r.moveToElementText(e.getBody()),t.compareRanges(i,r))}e.on("keydown",function(n){var u=n.keyCode,r,t;if(!h(n)&&(u==p||u==l)){if(r=e.selection.isCollapsed(),t=e.getBody(),r&&!o.isEmpty(t))return;if(!r&&!i(e.selection.getRng()))return;n.preventDefault(),e.setContent(""),t.firstChild&&o.isBlock(t.firstChild)?e.selection.setCursorLocation(t.firstChild,0):e.selection.setCursorLocation(t,0),e.nodeChanged()}})}function k(){e.on("keydown",function(t){!h(t)&&t.keyCode==65&&n.metaKeyPressed(t)&&(t.preventDefault(),e.execCommand("SelectAll"))})}function ft(){e.settings.content_editable||(o.bind(e.getDoc(),"focusin",function(){s.setRng(s.getRng())}),o.bind(e.getDoc(),"mousedown",function(n){n.target==e.getDoc().documentElement&&(e.getBody().focus(),s.setRng(s.getRng()))}))}function d(){e.on("keydown",function(n){if(!h(n)&&n.keyCode===l&&s.isCollapsed()&&s.getRng(!0).startOffset===0){var i=s.getNode(),t=i.previousSibling;if(i.nodeName=="HR"){o.remove(i),n.preventDefault();return}t&&t.nodeName&&t.nodeName.toLowerCase()==="hr"&&(o.remove(t),n.preventDefault())}})}function et(){if(!window.Range.prototype.getClientRects)e.on("mousedown",function(n){if(!h(n)&&n.target.nodeName==="HTML"){var t=e.getBody();t.blur(),setTimeout(function(){t.focus()},0)}})}function ot(){e.on("click",function(n){n=n.target,/^(IMG|HR)$/.test(n.nodeName)&&s.getSel().setBaseAndExtent(n,0,n,1),n.nodeName=="A"&&o.hasClass(n,"mce-item-anchor")&&s.select(n),e.nodeChanged()})}function st(){function n(){var n=o.getAttribs(s.getStart().cloneNode(!1));return function(){var t=s.getStart();t!==e.getBody()&&(o.setAttrib(t,"style",null),v(n,function(n){t.setAttributeNode(n.cloneNode(!0))}))}}function t(){return!s.isCollapsed()&&o.getParent(s.getStart(),o.isBlock)!=o.getParent(s.getEnd(),o.isBlock)}e.on("keypress",function(i){var r;if(!h(i)&&(i.keyCode==8||i.keyCode==46)&&t())return r=n(),e.getDoc().execCommand("delete",!1,null),r(),i.preventDefault(),!1});o.bind(e.getDoc(),"cut",function(i){var r;!h(i)&&t()&&(r=n(),setTimeout(function(){r()},0))})}function ht(){var i,n;e.on("selectionchange",function(){n&&(clearTimeout(n),n=0),n=window.setTimeout(function(){var n=s.getRng();i&&t.compareRanges(n,i)||(e.nodeChanged(),i=n)},50)})}function ct(){document.body.setAttribute("role","application")}function lt(){e.on("keydown",function(n){if(!h(n)&&n.keyCode===l&&s.isCollapsed()&&s.getRng(!0).startOffset===0){var t=s.getNode().previousSibling;if(t&&t.nodeName&&t.nodeName.toLowerCase()==="table")return n.preventDefault(),!1}})}function at(){y()>7||(c("RespectVisibilityInDesign",!0),e.contentStyles.push(".mceHideBrInPre pre br {display: none}"),o.addClass(e.getBody(),"mceHideBrInPre"),w.addNodeFilter("pre",function(n){for(var e=n.length,u,f,r,t;e--;)for(u=n[e].getAll("br"),f=u.length;f--;)r=u[f],t=r.prev,t&&t.type===3&&t.value.charAt(t.value-1)!="\n"?t.value+="\n":r.parent.insert(new i("#text",3),r,!0).value="\n"}),b.addNodeFilter("pre",function(n){for(var u=n.length,i,r,f,t;u--;)for(i=n[u].getAll("br"),r=i.length;r--;)f=i[r],t=f.prev,t&&t.type==3&&(t.value=t.value.replace(/\r?\n$/,""))}))}function vt(){o.bind(e.getBody(),"mouseup",function(){var t,n=s.getNode();n.nodeName=="IMG"&&((t=o.getStyle(n,"width"))&&(o.setAttrib(n,"width",t.replace(/[^0-9%]+/g,"")),o.setStyle(n,"width","")),(t=o.getStyle(n,"height"))&&(o.setAttrib(n,"height",t.replace(/[^0-9%]+/g,"")),o.setStyle(n,"height","")))})}function yt(){e.on("keydown",function(t){var r,u,f,c,i;if(!h(t)&&t.keyCode==n.BACKSPACE&&(r=s.getRng(),u=r.startContainer,f=r.startOffset,c=o.getRoot(),i=u,r.collapsed&&f===0)){while(i&&i.parentNode&&i.parentNode.firstChild==i&&i.parentNode!=c)i=i.parentNode;i.tagName==="BLOCKQUOTE"&&(e.formatter.toggle("blockquote",null,i),r=o.createRng(),r.setStart(u,0),r.setEnd(u,0),s.setRng(r))}})}function pt(){function n(){e._refreshContentEditable(),c("StyleWithCSS",!1),c("enableInlineTableEditing",!1),a.object_resizing||c("enableObjectResizing",!1)}if(!a.readonly)e.on("BeforeExecCommand MouseDown",n)}function wt(){function n(){v(o.select("a"),function(n){var t=n.parentNode,i=o.getRoot();if(t.lastChild===n){while(t&&!o.isBlock(t)){if(t.parentNode.lastChild!==t||t===i)return;t=t.parentNode}o.add(t,"br",{"data-mce-bogus":1})}})}e.on("SetContent ExecCommand",function(t){(t.type=="setcontent"||t.command==="mceInsertLink")&&n()})}function bt(){if(a.forced_root_block)e.on("init",function(){c("DefaultParagraphSeparator",a.forced_root_block)})}function kt(){e.on("Undo Redo SetContent",function(n){n.initial||e.execCommand("mceRepaint")})}function dt(){e.on("keydown",function(n){var t;h(n)||n.keyCode!=l||(t=e.getDoc().selection.createRange(),t&&t.item&&(n.preventDefault(),e.undoManager.beforeChange(),o.remove(t.item(0)),e.undoManager.add()))})}function gt(){var n;y()>=10&&(n="",v("p div h1 h2 h3 h4 h5 h6".split(" "),function(t,i){n+=(i>0?",":"")+t+":empty"}),e.contentStyles.push(n+"{padding-right: 1px !important}"))}function ni(){y()<9&&(w.addNodeFilter("noscript",function(n){for(var r=n.length,t,i;r--;)t=n[r],i=t.firstChild,i&&t.attr("data-mce-innertext",i.value)}),b.addNodeFilter("noscript",function(n){for(var f=n.length,u,t,e;f--;)u=n[f],t=n[f].firstChild,t?t.value=r.decode(t.value):(e=u.attributes.map["data-mce-innertext"],e&&(u.attr("data-mce-innertext",null),t=new i("#text",3),t.value=e,t.raw=!0,u.append(t)))}))}function ti(){function f(n,t){var i=s.createTextRange();try{i.moveToPoint(n,t)}catch(r){i=null}return i}function e(n){var r;n.button?(r=f(n.x,n.y),r&&(r.compareEndPoints("StartToStart",t)>0?r.setEndPoint("StartToStart",t):r.setEndPoint("EndToEnd",t),r.select())):i()}function i(){var u=n.selection.createRange();t&&!u.item&&u.compareEndPoints("StartToEnd",u)===0&&t.select(),o.unbind(n,"mouseup",i),o.unbind(n,"mousemove",e),t=r=0}var n=o.doc,s=n.body,r,t,u;n.documentElement.unselectable=!0,o.bind(n,"mousedown contextmenu",function(s){if(s.target.nodeName==="HTML"){if(r&&i(),u=n.documentElement,u.scrollHeight>u.clientHeight)return;r=1,t=f(s.x,s.y),t&&(o.bind(n,"mouseup",i),o.bind(n,"mousemove",e),o.win.focus(),t.select())}})}function ii(){e.on("keyup focusin",function(t){t.keyCode==65&&n.metaKeyPressed(t)||s.normalize()})}function ri(){e.contentStyles.push("img:-moz-broken {-moz-force-broken-image-icon:1;min-width:24px;min-height:24px}")}function ui(){if(!e.inline)e.on("keydown",function(){document.activeElement==document.body&&e.getWin().focus()})}function g(){if(!e.inline){e.contentStyles.push("body {min-height: 150px}");e.on("click",function(n){n.target.nodeName=="HTML"&&(e.execCommand("SelectAll"),e.selection.collapse(!0),e.nodeChanged())})}}function fi(){if(u.mac)e.on("keydown",function(t){n.metaKeyPressed(t)&&(t.keyCode==37||t.keyCode==39)&&(t.preventDefault(),e.selection.getSel().modify("move",t.keyCode==37?"backward":"forward","word"))})}function ei(){c("AutoUrlDetect",!1)}var v=f.each,l=n.BACKSPACE,p=n.DELETE,o=e.dom,s=e.selection,a=e.settings,w=e.parser,b=e.serializer,nt=u.gecko,tt=u.ie,it=u.webkit;lt(),yt(),ut(),ii(),it&&(rt(),ft(),ot(),bt(),u.iOS?(ht(),ui(),g()):k()),tt&&u.ie<11&&(d(),ct(),at(),vt(),dt(),gt(),ni(),ti()),u.ie>=11&&g(),u.ie&&(k(),ei()),nt&&(d(),et(),st(),pt(),wt(),kt(),ri(),fi())}}),i("tinymce/util/Observable",["tinymce/util/Tools"],function(n){function i(){return!1}function r(){return!0}var t="__bindings",u=n.makeMap("focusin focusout click dblclick mousedown mouseup mousemove mouseover beforepaste paste cut copy selectionchange mouseout mouseenter mouseleave keydown keypress keyup contextmenu dragstart dragend dragover draggesture dragdrop drop drag"," ");return{fire:function(n,u,f){var e=this,o,s,c,l,h;if(n=n.toLowerCase(),u=u||{},u.type=n,u.target||(u.target=e),u.preventDefault||(u.preventDefault=function(){u.isDefaultPrevented=r},u.stopPropagation=function(){u.isPropagationStopped=r},u.stopImmediatePropagation=function(){u.isImmediatePropagationStopped=r},u.isDefaultPrevented=i,u.isPropagationStopped=i,u.isImmediatePropagationStopped=i),e[t]&&(o=e[t][n],o))for(s=0,c=o.length;s<c;s++){if(o[s]=l=o[s],u.isImmediatePropagationStopped())break;if(l.call(e,u)===!1)return u.preventDefault(),u}if(f!==!1&&e.parent)for(h=e.parent();h&&!u.isPropagationStopped();)h.fire(n,u,!1),h=h.parent();return u},on:function(n,i){var r=this,f,e,o,s;if(i===!1&&(i=function(){return!1}),i)for(o=n.toLowerCase().split(" "),s=o.length;s--;)n=o[s],f=r[t],f||(f=r[t]={}),e=f[n],e||(e=f[n]=[],r.bindNative&&u[n]&&r.bindNative(n)),e.push(i);return r},off:function(n,i){var r=this,s,e=r[t],f,c,h,o;if(e)if(n)for(h=n.toLowerCase().split(" "),s=h.length;s--;){if(n=h[s],f=e[n],!n){for(c in e)e[n].length=0;return r}if(f){if(i)for(o=f.length;o--;)f[o]===i&&f.splice(o,1);else f.length=0;!f.length&&r.unbindNative&&u[n]&&(r.unbindNative(n),delete e[n])}}else{if(r.unbindNative)for(n in e)r.unbindNative(n);r[t]=[]}return r},hasEventListeners:function(n){var i=this[t];return n=n.toLowerCase(),!(!i||!i[n]||i[n].length===0)}}}),i("tinymce/Shortcuts",["tinymce/util/Tools","tinymce/Env"],function(n,t){var i=n.each,r=n.explode,u={f9:120,f10:121,f11:122};return function(f){var o=this,e={};f.on("keyup keypress keydown",function(n){(n.altKey||n.ctrlKey||n.metaKey)&&i(e,function(i){var r=t.mac?n.metaKey:n.ctrlKey;if(i.ctrl==r&&i.alt==n.altKey&&i.shift==n.shiftKey)return n.keyCode==i.keyCode||n.charCode&&n.charCode==i.charCode?(n.preventDefault(),n.type=="keydown"&&i.func.call(i.scope),!0):void 0})});o.add=function(t,o,s,h){var c;return c=s,typeof s=="string"?s=function(){f.execCommand(c,!1,null)}:n.isArray(c)&&(s=function(){f.execCommand(c[0],c[1],c[2])}),i(r(t.toLowerCase()),function(n){var t={func:s,scope:h||f,desc:f.translate(o),alt:!1,ctrl:!1,shift:!1};i(r(n,"+"),function(n){switch(n){case"alt":case"ctrl":case"shift":t[n]=!0;break;default:t.charCode=n.charCodeAt(0),t.keyCode=u[n]||n.toUpperCase().charCodeAt(0)}}),e[(t.ctrl?"ctrl":"")+","+(t.alt?"alt":"")+","+(t.shift?"shift":"")+","+t.keyCode]=t}),!0}}}),i("tinymce/Editor",["tinymce/dom/DOMUtils","tinymce/AddOnManager","tinymce/html/Node","tinymce/dom/Serializer","tinymce/html/Serializer","tinymce/dom/Selection","tinymce/Formatter","tinymce/UndoManager","tinymce/EnterKey","tinymce/ForceBlocks","tinymce/EditorCommands","tinymce/util/URI","tinymce/dom/ScriptLoader","tinymce/dom/EventUtils","tinymce/WindowManager","tinymce/html/Schema","tinymce/html/DomParser","tinymce/util/Quirks","tinymce/Env","tinymce/util/Tools","tinymce/util/Observable","tinymce/Shortcuts"],function(n,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt){function vt(n,t){return t=="selectionchange"?n.getDoc():!n.inline&&/^mouse|click|contextmenu|drop/.test(t)?n.getDoc():n.getBody()}function lt(n,t,r){var u=this,f,e;f=u.documentBaseUrl=r.documentBaseURL,e=r.baseURI,u.settings=t=ht({id:n,theme:"modern",delta_width:0,delta_height:0,popup_css:"",plugins:"",document_base_url:f,add_form_submit_trigger:!0,submit_patch:!0,add_unload_trigger:!0,convert_urls:!0,relative_urls:!0,remove_script_host:!0,object_resizing:!0,doctype:"<!DOCTYPE html>",visual:!0,font_size_style_values:"xx-small,x-small,small,medium,large,x-large,xx-large",font_size_legacy_values:"xx-small,small,medium,large,x-large,xx-large,300%",forced_root_block:"p",hidden_input:!0,padd_empty_editor:!0,render_ui:!0,indentation:"30px",inline_styles:!0,convert_fonts_to_spans:!0,indent:"simple",indent_before:"p,h1,h2,h3,h4,h5,h6,blockquote,div,title,style,pre,script,td,ul,li,area,table,thead,tfoot,tbody,tr,section,article,hgroup,aside,figure,option,optgroup,datalist",indent_after:"p,h1,h2,h3,h4,h5,h6,blockquote,div,title,style,pre,script,td,ul,li,area,table,thead,tfoot,tbody,tr,section,article,hgroup,aside,figure,option,optgroup,datalist",validate:!0,entity_encoding:"named",url_converter:u.convertURL,url_converter_scope:u,ie7_compat:!0},t),i.language=t.language||"en",i.languageLoad=t.language_load,i.baseURL=r.baseURL,u.id=t.id=n,u.isNotDirty=!0,u.plugins={},u.documentBaseURI=new a(t.document_base_url||f,{base_uri:e}),u.baseURI=e,u.contentCSS=[],u.contentStyles=[],u.shortcuts=new tt(u),u.execCommands={},u.queryStateCommands={},u.queryValueCommands={},u.loadedCSS={},u.suffix=r.suffix,u.editorManager=r,u.inline=t.inline,r.fire("SetupEditor",u),u.execCallback("setup",u)}var it=n.DOM,st=i.ThemeManager,ut=i.PluginManager,ht=g.extend,rt=g.each,yt=g.explode,pt=g.inArray,ft=g.trim,at=g.resolve,et=y.Event,ct=d.gecko,ot=d.ie;return lt.prototype={render:function(){function f(){it.unbind(window,"ready",f),n.render()}function e(){var r=v.ScriptLoader,i;t.language&&t.language!="en"&&!t.language_url&&(t.language_url=n.editorManager.baseURL+"/langs/"+t.language+".js"),t.language_url&&r.add(t.language_url),t.theme&&typeof t.theme!="function"&&t.theme.charAt(0)!="-"&&!st.urls[t.theme]&&(i=t.theme_url,i=i?n.documentBaseURI.toAbsolute(i):"themes/"+t.theme+"/theme"+u+".js",st.load(t.theme,i)),g.isArray(t.plugins)&&(t.plugins=t.plugins.join(" ")),rt(t.external_plugins,function(n,i){ut.load(i,n),t.plugins+=" "+i}),rt(t.plugins.split(/[ ,]/),function(n){if(n=ft(n),n&&!ut.urls[n])if(n.charAt(0)=="-"){n=n.substr(1,n.length);var t=ut.dependencies(n);rt(t,function(n){var t={prefix:"plugins/",resource:n,suffix:"/plugin"+u+".js"};n=ut.createUrl(t,n),ut.load(n.resource,n)})}else ut.load(n,{prefix:"plugins/",resource:n,suffix:"/plugin"+u+".js"})}),r.loadQueue(function(){n.removed||n.init()})}var n=this,t=n.settings,r=n.id,u=n.suffix,i;if(!et.domLoaded){it.bind(window,"ready",f);return}if(n.getElement()&&d.contentEditable){if(t.inline?n.inline=!0:(n.orgVisibility=n.getElement().style.visibility,n.getElement().style.visibility="hidden"),i=n.getElement().form||it.getParent(r,"form"),i){n.formElement=i,t.hidden_input&&!/TEXTAREA|INPUT/i.test(n.getElement().nodeName)&&(it.insertAfter(it.create("input",{type:"hidden",name:r}),r),n.hasHiddenInput=!0),n.formEventDelegate=function(t){n.fire(t.type,t)},it.bind(i,"submit reset",n.formEventDelegate);n.on("reset",function(){n.setContent(n.startContent,{format:"raw"})});!t.submit_patch||i.submit.nodeType||i.submit.length||i._mceOldSubmit||(i._mceOldSubmit=i.submit,i.submit=function(){return n.editorManager.triggerSave(),n.isNotDirty=!0,i._mceOldSubmit(i)})}if(n.windowManager=new p(n),t.encoding=="xml")n.on("GetContent",function(n){n.save&&(n.content=it.encode(n.content))});if(t.add_form_submit_trigger)n.on("submit",function(){n.initialized&&n.save()});if(t.add_unload_trigger){n._beforeUnload=function(){!n.initialized||n.destroyed||n.isHidden()||n.save({format:"raw",no_events:!0,set_dirty:!1})};n.editorManager.on("BeforeUnload",n._beforeUnload)}e()}},init:function(){function w(t){var u=ut.get(t),r,i;r=ut.urls[t]||n.documentBaseUrl.replace(/\/$/,""),t=ft(t),u&&pt(p,t)===-1&&(rt(ut.dependencies(t),function(n){w(n)}),i=new u(n,r),n.plugins[t]=i,i.init&&(i.init(n,r),p.push(t)))}var n=this,t=n.settings,u=n.getElement(),e,r,s,h,i,c,f,o,a,l,p=[],v,y;if(n.rtl=this.editorManager.i18n.rtl,n.editorManager.add(n),t.aria_label=t.aria_label||it.getAttrib(u,"aria-label",n.getLang("aria.rich_text_area")),t.theme&&(typeof t.theme!="function"?(t.theme=t.theme.replace(/-/,""),i=st.get(t.theme),n.theme=new i(n,st.urls[t.theme]),n.theme.init&&n.theme.init(n,st.urls[t.theme]||n.documentBaseUrl.replace(/\/$/,""))):n.theme=t.theme),rt(t.plugins.replace(/\-/g,"").split(/[ ,]/),w),t.render_ui&&n.theme&&(n.orgDisplay=u.style.display,typeof t.theme!="function"?(e=t.width||u.style.width||u.offsetWidth,r=t.height||u.style.height||u.offsetHeight,s=t.min_height||100,a=/^[0-9\.]+(|px)$/i,a.test(""+e)&&(e=Math.max(parseInt(e,10)+(i.deltaWidth||0),100)),a.test(""+r)&&(r=Math.max(parseInt(r,10)+(i.deltaHeight||0),s)),i=n.theme.renderUI({targetNode:u,width:e,height:r,deltaWidth:t.delta_width,deltaHeight:t.delta_height}),t.content_editable||(it.setStyles(i.sizeContainer||i.editorContainer,{wi2dth:e,h2eight:r}),r=(i.iframeHeight||r)+(typeof r=="number"?i.deltaHeight||0:""),r<s&&(r=s))):(i=t.theme(n,u),i.editorContainer.nodeType&&(i.editorContainer=i.editorContainer.id=i.editorContainer.id||n.id+"_parent"),i.iframeContainer.nodeType&&(i.iframeContainer=i.iframeContainer.id=i.iframeContainer.id||n.id+"_iframecontainer"),r=i.iframeHeight||u.offsetHeight),n.editorContainer=i.editorContainer),t.content_css&&rt(yt(t.content_css),function(t){n.contentCSS.push(n.documentBaseURI.toAbsolute(t))}),t.content_style&&n.contentStyles.push(t.content_style),t.content_editable)return u=h=i=null,n.initContentBody();for(n.iframeHTML=t.doctype+"<html><head>",t.document_base_url!=n.documentBaseUrl&&(n.iframeHTML+='<base href="'+n.documentBaseURI.getURI()+'" />'),!d.caretAfter&&t.ie7_compat&&(n.iframeHTML+='<meta http-equiv="X-UA-Compatible" content="IE=7" />'),n.iframeHTML+='<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />',l=0;l<n.contentCSS.length;l++)v=n.contentCSS[l]+"?v="+P.modules.cacheBuster,n.iframeHTML+='<link type="text/css" rel="stylesheet" href="'+v+'" />',n.loadedCSS[v]=!0;if(f=t.body_id||"tinymce",f.indexOf("=")!=-1&&(f=n.getParam("body_id","","hash"),f=f[n.id]||f),o=t.body_class||"",o.indexOf("=")!=-1&&(o=n.getParam("body_class","","hash"),o=o[n.id]||""),n.iframeHTML+='<\/head><body id="'+f+'" class="mce-content-body '+o+'" onload="window.parent.tinymce.get(\''+n.id+"').fire('load');\"><br><\/body><\/html>",y='javascript:(function(){document.open();document.domain="'+document.domain+'";var ed = window.parent.tinymce.get("'+n.id+'");document.write(ed.iframeHTML);document.close();ed.initContentBody(true);})()',document.domain!=location.hostname&&(c=y),h=it.add(i.iframeContainer,"iframe",{id:n.id+"_ifr",src:c||'javascript:""',frameBorder:"0",allowTransparency:"true",title:n.editorManager.translate("Rich Text Area. Press ALT-F9 for menu. Press ALT-F10 for toolbar. Press ALT-0 for help"),style:{width:"100%",height:r,display:"block"}}),ot)try{n.getDoc()}catch(b){h.src=c=y}n.contentAreaContainer=i.iframeContainer,i.editorContainer&&(it.get(i.editorContainer).style.display=n.orgDisplay),it.get(n.id).style.display="none",it.setAttrib(n.id,"aria-hidden",!0),c||n.initContentBody(),u=h=i=null},initContentBody:function(t){var i=this,f=i.settings,y=it.get(i.id),v=i.getDoc(),a,p;if(f.inline||(i.getElement().style.visibility=i.orgVisibility),t||f.content_editable||(v.open(),v.write(i.iframeHTML),v.close()),f.content_editable){i.on("remove",function(){var n=this.getBody();it.removeClass(n,"mce-content-body"),it.removeClass(n,"mce-edit-focus"),it.setAttrib(n,"tabIndex",null),it.setAttrib(n,"contentEditable",null)});it.addClass(y,"mce-content-body"),y.tabIndex=-1,i.contentDocument=v=f.content_document||document,i.contentWindow=f.content_window||window,i.bodyElement=y,f.content_document=f.content_window=null,f.root_name=y.nodeName.toLowerCase()}if(a=i.getBody(),a.disabled=!0,f.readonly||(i.inline&&it.getStyle(a,"position",!0)=="static"&&(a.style.position="relative"),a.contentEditable=i.getParam("content_editable_state",!0)),a.disabled=!1,i.schema=new w(f),i.dom=new n(v,{keep_values:!0,url_converter:i.convertURL,url_converter_scope:i,hex_colors:f.force_hex_style_colors,class_filter:f.class_filter,update_styles:!0,root_element:f.content_editable?i.id:null,collect:f.content_editable,schema:i.schema,onSetAttrib:function(n){i.fire("SetAttrib",n)}}),i.parser=new b(f,i.schema),i.parser.addAttributeFilter("src,href,style",function(n,t){for(var e=n.length,r,o=i.dom,f,u;e--;)r=n[e],f=r.attr(t),u="data-mce-"+t,r.attributes.map[u]||(t==="style"?r.attr(u,o.serializeStyle(o.parseStyle(f),r.name)):r.attr(u,i.convertURL(f,t,r.name)))}),i.parser.addNodeFilter("script",function(n){for(var i=n.length,t;i--;)t=n[i],t.attr("type","mce-"+(t.attr("type")||"text/javascript"))}),i.parser.addNodeFilter("#cdata",function(n){for(var i=n.length,t;i--;)t=n[i],t.type=8,t.name="#comment",t.value="[CDATA["+t.value+"]]"}),i.parser.addNodeFilter("p,h1,h2,h3,h4,h5,h6,div",function(n){for(var u=n.length,t,f=i.schema.getNonEmptyElements();u--;)t=n[u],t.isEmpty(f)&&(t.empty().append(new r("br",1)).shortEnded=!0)}),i.serializer=new u(f,i),i.selection=new e(i.dom,i.getWin(),i.serializer,i),i.formatter=new o(i),i.undoManager=new s(i),i.forceBlocks=new c(i),i.enterKey=new h(i),i.editorCommands=new l(i),i.fire("PreInit"),f.browser_spellcheck||f.gecko_spellcheck||(v.body.spellcheck=!1,it.setAttrib(a,"spellcheck","false")),i.fire("PostRender"),i.quirks=k(i),f.directionality&&(a.dir=f.directionality),f.nowrap&&(a.style.whiteSpace="nowrap"),f.protect)i.on("BeforeSetContent",function(n){rt(f.protect,function(t){n.content=n.content.replace(t,function(n){return"<!--mce:protected "+escape(n)+"-->"})})});i.on("SetContent",function(){i.addVisual(i.getBody())});if(f.padd_empty_editor)i.on("PostProcess",function(n){n.content=n.content.replace(/^(<p[^>]*>(&nbsp;|&#160;|\s|\u00a0|)<\/p>[\r\n]*|<br \/>[\r\n]*)$/,"")});i.load({initial:!0,format:"html"}),i.startContent=i.getContent({format:"raw"}),i.initialized=!0,rt(i._pendingNativeEvents,function(n){i.dom.bind(vt(i,n),n,function(n){i.fire(n.type,n)})}),i.fire("init"),i.focus(!0),i.nodeChanged({initial:!0}),i.execCallback("init_instance_callback",i),i.contentStyles.length>0&&(p="",rt(i.contentStyles,function(n){p+=n+"\r\n"}),i.dom.addStyle(p)),rt(i.contentCSS,function(n){i.loadedCSS[n]||(i.dom.loadCSS(n),i.loadedCSS[n]=!0)}),f.auto_focus&&setTimeout(function(){var n=i.editorManager.get(f.auto_focus);n.selection.select(n.getBody(),1),n.selection.collapse(1),n.getBody().focus(),n.getWin().focus()},100),y=v=a=null},focus:function(n){var f,t=this,o=t.selection,e=t.settings.content_editable,i,r,s=t.getDoc(),u;n||(i=o.getRng(),i.item&&(r=i.item(0)),t._refreshContentEditable(),e||(d.opera||t.getBody().focus(),t.getWin().focus()),(ct||e)&&(u=t.getBody(),u.setActive&&d.ie<11?u.setActive():u.focus(),e&&o.normalize()),r&&r.ownerDocument==s&&(i=s.body.createControlRange(),i.addElement(r),i.select())),t.editorManager.activeEditor!=t&&((f=t.editorManager.activeEditor)&&f.fire("deactivate",{relatedTarget:t}),t.fire("activate",{relatedTarget:f})),t.editorManager.activeEditor=t},execCallback:function(n){var r=this,i=r.settings[n],t;if(i)return r.callbackLookup&&(t=r.callbackLookup[n])&&(i=t.func,t=t.scope),typeof i=="string"&&(t=i.replace(/\.\w+$/,""),t=t?at(t):0,i=at(i),r.callbackLookup=r.callbackLookup||{},r.callbackLookup[n]={func:i,scope:t}),i.apply(t||r,Array.prototype.slice.call(arguments,1))},translate:function(n){var t=this.settings.language||"en",i=this.editorManager.i18n;return n?i.data[t+"."+n]||n.replace(/\{\#([^\}]+)\}/g,function(n,r){return i.data[t+"."+r]||"{#"+r+"}"}):""},getLang:function(n,i){return this.editorManager.i18n.data[(this.settings.language||"en")+"."+n]||(i!==t?i:"{#"+n+"}")},getParam:function(n,t,i){var r=n in this.settings?this.settings[n]:t,u;return i==="hash"?(u={},typeof r=="string"?rt(r.indexOf("=")>0?r.split(/[;,](?![^=;,]*(?:[;,]|$))/):r.split(","),function(n){n=n.split("="),u[ft(n[0])]=n.length>1?ft(n[1]):ft(n)}):u=r,u):r},nodeChanged:function(){var t=this,u=t.selection,n,i,r;t.initialized&&!t.settings.disable_nodechange&&(r=t.getBody(),n=u.getStart()||r,n=ot&&n.ownerDocument!=t.getDoc()?t.getBody():n,n.nodeName=="IMG"&&u.isCollapsed()&&(n=n.parentNode),i=[],t.dom.getParent(n,function(n){if(n===r)return!0;i.push(n)}),t.fire("NodeChange",{element:n,parents:i}))},addButton:function(n,t){var i=this;t.cmd&&t.cmd!="mceHelp"&&(t.onclick=function(){i.execCommand(t.cmd)}),t.text||t.icon||(t.icon=n),i.buttons=i.buttons||{},t.tooltip=t.tooltip||t.title,i.buttons[n]=t},addMenuItem:function(n,t){var i=this;t.cmd&&(t.onclick=function(){i.execCommand(t.cmd)}),i.menuItems=i.menuItems||{},i.menuItems[n]=t},addCommand:function(n,t,i){this.execCommands[n]={func:t,scope:i||this}},addQueryStateHandler:function(n,t,i){this.queryStateCommands[n]={func:t,scope:i||this}},addQueryValueHandler:function(n,t,i){this.queryValueCommands[n]={func:t,scope:i||this}},addShortcut:function(n,t,i,r){this.shortcuts.add(n,t,i,r)},execCommand:function(n,t,i,r){var u=this,f=0,e;if(/^(mceAddUndoLevel|mceEndUndoLevel|mceBeginUndoLevel|mceRepaint)$/.test(n)||r&&r.skip_focus||u.focus(),r=ht({},r),r=u.fire("BeforeExecCommand",{command:n,ui:t,value:i}),r.isDefaultPrevented())return!1;if((e=u.execCommands[n])&&e.func.call(e.scope,t,i)!==!0)return u.fire("ExecCommand",{command:n,ui:t,value:i}),!0;if(rt(u.plugins,function(r){if(r.execCommand&&r.execCommand(n,t,i))return u.fire("ExecCommand",{command:n,ui:t,value:i}),f=!0,!1}),f)return f;if(u.theme&&u.theme.execCommand&&u.theme.execCommand(n,t,i))return u.fire("ExecCommand",{command:n,ui:t,value:i}),!0;if(u.editorCommands.execCommand(n,t,i))return u.fire("ExecCommand",{command:n,ui:t,value:i}),!0;u.getDoc().execCommand(n,t,i),u.fire("ExecCommand",{command:n,ui:t,value:i})},queryCommandState:function(n){var i=this,r,t;if(!i._isHidden()){if((r=i.queryStateCommands[n])&&(t=r.func.call(r.scope),t!==!0)||(t=i.editorCommands.queryCommandState(n),t!==-1))return t;try{return i.getDoc().queryCommandState(n)}catch(u){}}},queryCommandValue:function(n){var r=this,u,i;if(!r._isHidden()){if((u=r.queryValueCommands[n])&&(i=u.func.call(u.scope),i!==!0)||(i=r.editorCommands.queryCommandValue(n),i!==t))return i;try{return r.getDoc().queryCommandValue(n)}catch(f){}}},show:function(){var n=this;it.show(n.getContainer()),it.hide(n.id),n.load(),n.fire("show")},hide:function(){var n=this,t=n.getDoc();ot&&t&&!n.inline&&t.execCommand("SelectAll"),n.save(),it.hide(n.getContainer()),it.setStyle(n.id,"display",n.orgDisplay),n.fire("hide")},isHidden:function(){return!it.isHidden(this.id)},setProgressState:function(n,t){this.fire("ProgressState",{state:n,time:t})},load:function(n){var r=this,i=r.getElement(),u;if(i)return n=n||{},n.load=!0,u=r.setContent(i.value!==t?i.value:i.innerHTML,n),n.element=i,n.no_events||r.fire("LoadContent",n),n.element=i=null,u},save:function(n){var t=this,i=t.getElement(),r,u;if(i&&t.initialized)return n=n||{},n.save=!0,n.element=i,r=n.content=t.getContent(n),n.no_events||t.fire("SaveContent",n),r=n.content,/TEXTAREA|INPUT/i.test(i.nodeName)?i.value=r:(i.innerHTML=r,(u=it.getParent(t.id,"form"))&&rt(u.elements,function(n){if(n.name==t.id)return n.value=r,!1})),n.element=i=null,n.set_dirty!==!1&&(t.isNotDirty=!0),r},setContent:function(n,t){var i=this,u=i.getBody(),r;return t=t||{},t.format=t.format||"html",t.set=!0,t.content=n,t.no_events||i.fire("BeforeSetContent",t),n=t.content,n.length===0||/^\s+$/.test(n)?(r=i.settings.forced_root_block,r&&i.schema.isValidChild(u.nodeName.toLowerCase(),r.toLowerCase())?(n=ot&&ot<11?"":'<br data-mce-bogus="1">',n=i.dom.createHTML(r,i.settings.forced_root_block_attrs,n)):(!ot||ot<11)&&(n='<br data-mce-bogus="1">'),u.innerHTML=n,i.fire("SetContent",t)):(t.format!=="raw"&&(n=new f({},i.schema).serialize(i.parser.parse(n,{isRootContent:!0}))),t.content=ft(n),i.dom.setHTML(u,t.content),t.no_events||i.fire("SetContent",t)),t.content},getContent:function(n){var t=this,r,i=t.getBody();return n=n||{},n.format=n.format||"html",n.get=!0,n.getInner=!0,n.no_events||t.fire("BeforeGetContent",n),r=n.format=="raw"?i.innerHTML:n.format=="text"?i.innerText||i.textContent:t.serializer.serialize(i,n),n.content=n.format!="text"?ft(r):r,n.no_events||t.fire("GetContent",n),n.content},insertContent:function(n){this.execCommand("mceInsertContent",!1,n)},isDirty:function(){return!this.isNotDirty},getContainer:function(){var n=this;return n.container||(n.container=it.get(n.editorContainer||n.id+"_parent")),n.container},getContentAreaContainer:function(){return this.contentAreaContainer},getElement:function(){return it.get(this.settings.content_element||this.id)},getWin:function(){var n=this,t;return n.contentWindow||(t=it.get(n.id+"_ifr"),t&&(n.contentWindow=t.contentWindow)),n.contentWindow},getDoc:function(){var n=this,t;return n.contentDocument||(t=n.getWin(),t&&(n.contentDocument=t.document)),n.contentDocument},getBody:function(){return this.bodyElement||this.getDoc().body},convertURL:function(n,t,i){var r=this,u=r.settings;return u.urlconverter_callback?r.execCallback("urlconverter_callback",n,i,!0,t):!u.convert_urls||i&&i.nodeName=="LINK"||n.indexOf("file:")===0||n.length===0?n:u.relative_urls?r.documentBaseURI.toRelative(n):r.documentBaseURI.toAbsolute(n,u.remove_script_host)},addVisual:function(n){var i=this,f=i.settings,r=i.dom,u;n=n||i.getBody(),i.hasVisual===t&&(i.hasVisual=f.visual),rt(r.select("table,a",n),function(n){var t;switch(n.nodeName){case"TABLE":u=f.visual_table_class||"mce-item-table",t=r.getAttrib(n,"border"),t&&t!="0"||(i.hasVisual?r.addClass(n,u):r.removeClass(n,u));return;case"A":r.getAttrib(n,"href",!1)||(t=r.getAttrib(n,"name")||n.id,u="mce-item-anchor",t&&(i.hasVisual?r.addClass(n,u):r.removeClass(n,u)));return}}),i.fire("VisualAid",{element:n,hasVisual:i.hasVisual})},remove:function(){var n=this,t,i;n.removed||(n.removed=1,n.hasHiddenInput&&it.remove(n.getElement().nextSibling),t=n.getDoc(),ot&&t&&!n.inline&&t.execCommand("SelectAll"),n.save(),it.setStyle(n.id,"display",n.orgDisplay),n.settings.content_editable||(et.unbind(n.getWin()),et.unbind(n.getDoc())),i=n.getContainer(),et.unbind(n.getBody()),et.unbind(i),n.fire("remove"),n.editorManager.remove(n),it.remove(i),n.destroy())},bindNative:function(n){var t=this;t.settings.readonly||(t.initialized?t.dom.bind(vt(t,n),n,function(i){t.fire(n,i)}):t._pendingNativeEvents?t._pendingNativeEvents.push(n):t._pendingNativeEvents=[n])},unbindNative:function(n){var t=this;t.initialized&&t.dom.unbind(n)},destroy:function(n){var t=this,i;if(!t.destroyed){if(!n&&!t.removed){t.remove();return}n&&ct&&(et.unbind(t.getDoc()),et.unbind(t.getWin()),et.unbind(t.getBody())),n||(t.editorManager.off("beforeunload",t._beforeUnload),t.theme&&t.theme.destroy&&t.theme.destroy(),t.selection.destroy(),t.dom.destroy()),i=t.formElement,i&&(i._mceOldSubmit&&(i.submit=i._mceOldSubmit,i._mceOldSubmit=null),it.unbind(i,"submit reset",t.formEventDelegate)),t.contentAreaContainer=t.formElement=t.container=null,t.settings.content_element=t.bodyElement=t.contentDocument=t.contentWindow=null,t.selection&&(t.selection=t.selection.win=t.selection.dom=t.selection.dom.doc=null),t.destroyed=1}},_refreshContentEditable:function(){var i=this,n,t;i._isHidden()&&(n=i.getBody(),t=n.parentNode,t.removeChild(n),t.appendChild(n),n.focus())},_isHidden:function(){var n;return ct?(n=this.selection.getSel(),!n||!n.rangeCount||n.rangeCount===0):0}},ht(lt.prototype,nt),lt}),i("tinymce/util/I18n",[],function(){var n={};return{rtl:!1,add:function(t,i){for(var r in i)n[r]=i[r];this.rtl=this.rtl||n._dir==="rtl"},translate:function(t){if(typeof t=="undefined")return t;if(typeof t!="string"&&t.raw)return t.raw;if(t.push){var i=t.slice(1);t=(n[t[0]]||t[0]).replace(/\{([^\}]+)\}/g,function(n,t){return i[t]})}return n[t]||t},data:n}}),i("tinymce/FocusManager",["tinymce/dom/DOMUtils","tinymce/Env"],function(n,t){function i(r){function e(){try{return document.activeElement}catch(n){return document.body}}function u(n){return n&&n.startContainer?{startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset}:n}function o(n,t){var i;return t.startContainer?(i=n.getDoc().createRange(),i.setStart(t.startContainer,t.startOffset),i.setEnd(t.endContainer,t.endOffset)):i=t,i}function f(t){return!!n.DOM.getParent(t,i.isEditorUIElement)}function s(n,t){for(var i=t.getBody();n;){if(n==i)return!0;n=n.parentNode}}function h(i){var h=i.editor,c;h.on("init",function(){if("onbeforedeactivate"in document&&t.ie<11)h.dom.bind(h.getBody(),"beforedeactivate",function(){try{h.lastRng=h.selection.getRng()}catch(n){}h.selection.lastFocusBookmark=u(h.lastRng)});else if(h.inline||t.ie>10){h.on("nodechange keyup",function(){var n=document.activeElement;n&&n.id==h.id+"_ifr"&&(n=h.getBody()),s(n,h)&&(h.lastRng=h.selection.getRng())});if(t.webkit){c=function(){var n=h.selection.getRng();n.collapsed||(h.lastRng=n)},n.DOM.bind(document,"selectionchange",c);h.on("remove",function(){n.DOM.unbind(document,"selectionchange",c)})}}});h.on("setcontent",function(){h.lastRng=null});h.on("mousedown",function(){h.selection.lastFocusBookmark=null});h.on("focusin",function(){var n=r.focusedEditor;h.selection.lastFocusBookmark&&(h.selection.setRng(o(h,h.selection.lastFocusBookmark)),h.selection.lastFocusBookmark=null),n!=h&&(n&&n.fire("blur",{focusedEditor:h}),r.activeEditor=h,r.focusedEditor=h,h.fire("focus",{blurredEditor:n}),h.focus(!1)),h.lastRng=null});h.on("focusout",function(){window.setTimeout(function(){var n=r.focusedEditor;f(e())||n!=h||(h.fire("blur",{focusedEditor:null}),r.focusedEditor=null,h.selection&&(h.selection.lastFocusBookmark=null))},0)})}n.DOM.bind(document,"focusin",function(n){var t=r.activeEditor;t&&n.target.ownerDocument==document&&(t.selection&&(t.selection.lastFocusBookmark=u(t.lastRng)),f(n.target)||r.focusedEditor!=t||(t.fire("blur",{focusedEditor:null}),r.focusedEditor=null))});r.on("AddEditor",h)}return i.isEditorUIElement=function(n){return n.className.indexOf("mce-")!==-1},i}),i("tinymce/EditorManager",["tinymce/Editor","tinymce/dom/DOMUtils","tinymce/util/URI","tinymce/Env","tinymce/util/Tools","tinymce/util/Observable","tinymce/util/I18n","tinymce/FocusManager"],function(n,i,r,u,f,e,o,s){var h=i.DOM,y=f.explode,c=f.each,v=f.extend,p=0,l,a={majorVersion:"4",minorVersion:"0.16",releaseDate:"2014-01-31",editors:[],i18n:o,activeEditor:null,setup:function(){var n=this,e,t,o="",i,h,f,u;if(t=document.location.href.replace(/[\?#].*$/,"").replace(/[\/\\][^\/]+$/,""),/[\/\\]$/.test(t)||(t+="/"),i=window.tinymce||window.tinyMCEPreInit,i)e=i.base||i.baseURL,o=i.suffix;else for(h=document.getElementsByTagName("script"),f=0;f<h.length;f++)if(u=h[f].src,/tinymce(\.full|\.jquery|)(\.min|\.dev|)\.js/.test(u)){u.indexOf(".min")!=-1&&(o=".min"),e=u.substring(0,u.lastIndexOf("/"));break}n.baseURL=new r(t).toAbsolute(e),n.documentBaseURL=t,n.baseURI=new r(n.baseURL),n.suffix=o,n.focusManager=new s(n)},init:function(t){function f(n){var t=n.id;return t||(t=n.name,t=t&&!h.get(t)?n.name:h.uniqueId(),n.setAttribute("id",t)),t}function e(n,t,i){var r=n[t];if(r)return r.apply(i||this,Array.prototype.slice.call(arguments,2))}function o(n,t){return t.constructor===RegExp?t.test(n.className):h.hasClass(n,t)}function s(){var l,a;if(h.unbind(window,"ready",s),e(t,"onpageload"),t.types){c(t.types,function(i){c(h.select(i.selector),function(e){var o=new n(f(e),v({},t,i),r);u.push(o),o.render(1)})});return}if(t.selector){c(h.select(t.selector),function(i){var e=new n(f(i),t,r);u.push(e),e.render(1)});return}switch(t.mode){case"exact":l=t.elements||"",l.length>0&&c(y(l),function(f){h.get(f)?(i=new n(f,t,r),u.push(i),i.render(!0)):c(document.forms,function(e){c(e.elements,function(e){e.name===f&&(f="mce_editor_"+p++,h.setAttrib(e,"id",f),i=new n(f,t,r),u.push(i),i.render(1))})})});break;case"textareas":case"specific_textareas":c(h.select("textarea"),function(e){t.editor_deselector&&o(e,t.editor_deselector)||(!t.editor_selector||o(e,t.editor_selector))&&(i=new n(f(e),t,r),u.push(i),i.render(!0))})}t.oninit&&(l=a=0,c(u,function(n){if(a++,n.initialized)l++;else n.on("init",function(){l++,l==a&&e(t,"oninit")});l==a&&e(t,"oninit")}))}var r=this,u=[],i;r.settings=t,h.bind(window,"ready",s)},get:function(n){return n===t?this.editors:this.editors[n]},add:function(n){var t=this,i=t.editors;return i[n.id]=n,i.push(n),t.activeEditor=n,t.fire("AddEditor",{editor:n}),l||(l=function(){t.fire("BeforeUnload")},h.bind(window,"beforeunload",l)),n},createEditor:function(t,i){return this.add(new n(t,i,this))},remove:function(n){var u=this,i,t=u.editors,r,f;if(!n){for(i=t.length-1;i>=0;i--)u.remove(t[i]);return}if(typeof n=="string"){n=n.selector||n,c(h.select(n),function(n){u.remove(t[n.id])});return}if(r=n,!t[r.id])return null;for(delete t[r.id],i=0;i<t.length;i++)if(t[i]==r){t.splice(i,1),f=!0;break}return u.activeEditor==r&&(u.activeEditor=t[0]),f&&u.fire("RemoveEditor",{editor:r}),t.length||h.unbind(window,"beforeunload",l),r.remove(),r},execCommand:function(t,i,r){var u=this,f=u.get(r);switch(t){case"mceAddEditor":return u.get(r)||new n(r,u.settings,u).render(),!0;case"mceRemoveEditor":return f&&f.remove(),!0;case"mceToggleEditor":return f?(f.isHidden()?f.show():f.hide(),!0):(u.execCommand("mceAddEditor",0,r),!0)}return u.activeEditor?u.activeEditor.execCommand(t,i,r):!1},triggerSave:function(){c(this.editors,function(n){n.save()})},addI18n:function(n,t){o.add(n,t)},translate:function(n){return o.translate(n)}};return v(a,e),a.setup(),window.tinymce=window.tinyMCE=a,a}),i("tinymce/LegacyInput",["tinymce/EditorManager","tinymce/util/Tools"],function(n,t){var i=t.each,r=t.explode;n.on("AddEditor",function(n){var t=n.editor;t.on("preInit",function(){function f(t,r){i(r,function(i,r){i&&n.setStyle(t,r,i)}),n.rename(t,"span")}function s(r){n=t.dom,u.convert_fonts_to_spans&&i(n.select("font,u,strike",r.node),function(t){e[t.nodeName.toLowerCase()](n,t)})}var e,o,n,u=t.settings;if(u.inline_styles){o=r(u.font_size_legacy_values),e={font:function(n,t){f(t,{backgroundColor:t.style.backgroundColor,color:t.color,fontFamily:t.face,fontSize:o[parseInt(t.size,10)-1]})},u:function(n,t){f(t,{textDecoration:"underline"})},strike:function(n,t){f(t,{textDecoration:"line-through"})}};t.on("PreProcess SetContent",s)}})})}),i("tinymce/util/XHR",[],function(){return{send:function(n){function r(){!n.async||t.readyState==4||i++>1e4?(n.success&&i<1e4&&t.status==200?n.success.call(n.success_scope,""+t.responseText,t,n):n.error&&n.error.call(n.error_scope,i>1e4?"TIMED_OUT":"GENERAL",t,n),t=null):setTimeout(r,10)}var t,i=0;if(n.scope=n.scope||this,n.success_scope=n.success_scope||n.scope,n.error_scope=n.error_scope||n.scope,n.async=n.async===!1?!1:!0,n.data=n.data||"",t=new XMLHttpRequest,t){if(t.overrideMimeType&&t.overrideMimeType(n.content_type),t.open(n.type||(n.data?"POST":"GET"),n.url,n.async),n.content_type&&t.setRequestHeader("Content-Type",n.content_type),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.send(n.data),!n.async)return r();setTimeout(r,10)}}}}),i("tinymce/util/JSON",[],function(){function n(t,i){var u,r,e,f;if(i=i||'"',t===null)return"null";if(e=typeof t,e=="string")return r="\bb\tt\nn\ff\rr\"\"''\\\\",i+t.replace(/([\u0080-\uFFFF\x00-\x1f\"\'\\])/g,function(n,t){return i==='"'&&n==="'"?n:(u=r.indexOf(t),u+1)?"\\"+r.charAt(u+1):(n=t.charCodeAt().toString(16),"\\u"+"0000".substring(n.length)+n)})+i;if(e=="object"){if(t.hasOwnProperty&&Object.prototype.toString.call(t)==="[object Array]"){for(u=0,r="[";u<t.length;u++)r+=(u>0?",":"")+n(t[u],i);return r+"]"}r="{";for(f in t)t.hasOwnProperty(f)&&(r+=typeof t[f]!="function"?(r.length>1?","+i:i)+f+i+":"+n(t[f],i):"");return r+"}"}return""+t}return{serialize:n,parse:function(n){try{return window[String.fromCharCode(101)+"val"]("("+n+")")}catch(t){}}}}),i("tinymce/util/JSONRequest",["tinymce/util/JSON","tinymce/util/XHR","tinymce/util/Tools"],function(n,t,i){function r(n){this.settings=u({},n),this.count=0}var u=i.extend;return r.sendRPC=function(n){return(new r).send(n)},r.prototype={send:function(i){var r=i.error,f=i.success;i=u(this.settings,i),i.success=function(t,u){t=n.parse(t),typeof t=="undefined"&&(t={error:"JSON Parse error."}),t.error?r.call(i.error_scope||i.scope,t.error,u):f.call(i.success_scope||i.scope,t.result)},i.error=function(n,t){r&&r.call(i.error_scope||i.scope,n,t)},i.data=n.serialize({id:i.id||"c"+this.count++,method:i.method,params:i.params}),i.content_type="application/json",t.send(i)}},r}),i("tinymce/util/JSONP",["tinymce/dom/DOMUtils"],function(n){return{callbacks:{},count:0,send:function(i){var r=this,u=n.DOM,f=i.count!==t?i.count:r.count,e="tinymce_jsonp_"+f;r.callbacks[f]=function(n){u.remove(e),delete r.callbacks[f],i.callback(n)},u.add(u.doc.body,"script",{id:e,src:i.url,type:"text/javascript"}),r.count++}}}),i("tinymce/util/LocalStorage",[],function(){function s(){u=[];for(var t in n)u.push(t);e.length=u.length}function h(){function c(n){var r,i;return(i=n!==t?h+n:o.indexOf(",",h),i===-1||i>o.length)?null:(r=o.substring(h,i),h=i+1,r)}var e,o,l,h=0,u;if(n={},f){i.load(r),o=i.getAttribute(r)||"";do{if(u=c(),u===null)break;if(e=c(parseInt(u,32)||0),e!==null){if(u=c(),u===null)break;l=c(parseInt(u,32)||0),e&&(n[e]=l)}}while(e!==null);s()}}function o(){var u,e="",t;if(f){for(t in n)u=n[t],e+=(e?",":"")+t.length.toString(32)+","+t+","+u.length.toString(32)+","+u;i.setAttribute(r,e);try{i.save(r)}catch(o){}s()}}var e,i,n,u,r,f;try{if(window.localStorage)return localStorage}catch(c){}return r="tinymce",i=document.documentElement,f=!!i.addBehavior,f&&i.addBehavior("#default#userData"),e={key:function(n){return u[n]},getItem:function(t){return t in n?n[t]:null},setItem:function(t,i){n[t]=""+i,o()},removeItem:function(t){delete n[t],o()},clear:function(){n={},o()}},h(),e}),i("tinymce/Compat",["tinymce/dom/DOMUtils","tinymce/dom/EventUtils","tinymce/dom/ScriptLoader","tinymce/AddOnManager","tinymce/util/Tools","tinymce/Env"],function(n,t,i,r,u,f){var e=window.tinymce;return e.DOM=n.DOM,e.ScriptLoader=i.ScriptLoader,e.PluginManager=r.PluginManager,e.ThemeManager=r.ThemeManager,e.dom=e.dom||{},e.dom.Event=t.Event,u.each(u,function(n,t){e[t]=n}),u.each("isOpera isWebKit isIE isGecko isMac".split(" "),function(n){e[n]=f[n.substr(2).toLowerCase()]}),{}}),i("tinymce/ui/Layout",["tinymce/util/Class","tinymce/util/Tools"],function(n,t){return n.extend({Defaults:{firstControlClass:"first",lastControlClass:"last"},init:function(n){this.settings=t.extend({},this.Defaults,n)},preRender:function(n){n.addClass(this.settings.containerClass,"body")},applyClasses:function(n){var f=this,t=f.settings,i,r,u;i=n.items().filter(":visible"),r=t.firstControlClass,u=t.lastControlClass,i.each(function(n){n.removeClass(r).removeClass(u),t.controlClass&&n.addClass(t.controlClass)}),i.eq(0).addClass(r),i.eq(-1).addClass(u)},renderHtml:function(n){var u=this,t=u.settings,i,r="";return i=n.items(),i.eq(0).addClass(t.firstControlClass),i.eq(-1).addClass(t.lastControlClass),i.each(function(n){t.controlClass&&n.addClass(t.controlClass),r+=n.renderHtml()}),r},recalc:function(){},postRender:function(){}})}),i("tinymce/ui/AbsoluteLayout",["tinymce/ui/Layout"],function(n){return n.extend({Defaults:{containerClass:"abs-layout",controlClass:"abs-layout-item"},recalc:function(n){n.items().filter(":visible").each(function(n){var t=n.settings;n.layoutRect({x:t.x,y:t.y,w:t.w,h:t.h}),n.recalc&&n.recalc()})},renderHtml:function(n){return'<div id="'+n._id+'-absend" class="'+n.classPrefix+'abs-end"><\/div>'+this._super(n)}})}),i("tinymce/ui/Tooltip",["tinymce/ui/Control","tinymce/ui/Movable"],function(n,t){return n.extend({Mixins:[t],Defaults:{classes:"widget tooltip tooltip-n"},text:function(n){var t=this;return typeof n!="undefined"?(t._value=n,t._rendered&&(t.getEl().lastChild.innerHTML=t.encode(n)),t):t._value},renderHtml:function(){var n=this,t=n.classPrefix;return'<div id="'+n._id+'" class="'+n.classes()+'" role="presentation"><div class="'+t+'tooltip-arrow"><\/div><div class="'+t+'tooltip-inner">'+n.encode(n._text)+"<\/div><\/div>"},repaint:function(){var i=this,n,t;n=i.getEl().style,t=i._layoutRect,n.left=t.x+"px",n.top=t.y+"px",n.zIndex=131070}})}),i("tinymce/ui/Widget",["tinymce/ui/Control","tinymce/ui/Tooltip"],function(n,t){var i,r=n.extend({init:function(n){var t=this;if(t._super(n),t.canFocus=!0,n.tooltip&&r.tooltips!==!1){t.on("mouseenter",function(i){var r=t.tooltip().moveTo(-65535),u;i.control==t?(u=r.text(n.tooltip).show().testMoveRel(t.getEl(),["bc-tc","bc-tl","bc-tr"]),r.toggleClass("tooltip-n",u=="bc-tc"),r.toggleClass("tooltip-nw",u=="bc-tl"),r.toggleClass("tooltip-ne",u=="bc-tr"),r.moveRel(t.getEl(),u)):r.hide()});t.on("mouseleave mousedown click",function(){t.tooltip().hide()})}t.aria("label",n.tooltip)},tooltip:function(){var n=this;return i||(i=new t({type:"tooltip"}),i.renderTo(n.getContainerElm())),i},active:function(n){var t=this,i;return n!==i&&(t.aria("pressed",n),t.toggleClass("active",n)),t._super(n)},disabled:function(n){var t=this,i;return n!==i&&(t.aria("disabled",n),t.toggleClass("disabled",n)),t._super(n)},postRender:function(){var n=this,t=n.settings;n._rendered=!0,n._super(),!n.parent()&&(t.width||t.height)&&(n.initLayoutRect(),n.repaint()),t.autofocus&&setTimeout(function(){n.focus()},0)},remove:function(){this._super(),i&&(i.remove(),i=null)}});return r}),i("tinymce/ui/Button",["tinymce/ui/Widget"],function(n){return n.extend({Defaults:{classes:"widget btn",role:"button"},init:function(n){var t=this,i;if(n.cmd!="mceHelp")t.on("click mousedown",function(n){n.preventDefault()});t._super(n),i=n.size,n.subtype&&t.addClass(n.subtype),i&&t.addClass("btn-"+i)},icon:function(n){var t=this,u=t.classPrefix,r,i;return typeof n=="undefined"?t.settings.icon:(t.settings.icon=n,n=n?u+"ico "+u+"i-"+t.settings.icon:"",t._rendered&&(r=t.getEl().firstChild,i=r.getElementsByTagName("i")[0],n?(i&&i==r.firstChild||(i=document.createElement("i"),r.insertBefore(i,r.firstChild)),i.className=n):i&&r.removeChild(i),t.text(t._text)),t)},repaint:function(){var n=this.getEl().firstChild.style;n.width=n.height="100%",this._super()},renderHtml:function(){var n=this,i=n._id,r=n.classPrefix,t=n.settings.icon,u="";return(n.settings.image&&(t="none",u=" style=\"background-image: url('"+n.settings.image+"')\""),t=n.settings.icon?r+"ico "+r+"i-"+t:"",n.settings.icon=="help")?'<div id="'+i+'" style="margin-left: 20px;margin-top:5px;"><a href="/help/formatting.html" target="_blank" class="help_button">Help<\/a><\/div>':'<div id="'+i+'" class="'+n.classes()+'" tabindex="-1"><button role="presentation" type="button" tabindex="-1">'+(t?'<i class="'+t+'"'+u+"><\/i>":"")+(n._text?(t?"\u00a0":"")+n.encode(n._text):"")+"<\/button><\/div>"}})}),i("tinymce/ui/ButtonGroup",["tinymce/ui/Container"],function(n){return n.extend({Defaults:{defaultType:"button",role:"toolbar"},renderHtml:function(){var n=this,t=n._layout;return n.addClass("btn-group"),n.preRender(),t.preRender(n),'<div id="'+n._id+'" class="'+n.classes()+'"><div id="'+n._id+'-body">'+(n.settings.html||"")+t.renderHtml(n)+"<\/div><\/div>"}})}),i("tinymce/ui/Checkbox",["tinymce/ui/Widget"],function(n){return n.extend({Defaults:{classes:"checkbox",role:"checkbox",checked:!1},init:function(n){var t=this;t._super(n);t.on("click mousedown",function(n){n.preventDefault()});t.on("click",function(n){n.preventDefault(),t.disabled()||t.checked(!t.checked())});t.checked(t.settings.checked)},checked:function(n){var t=this;return typeof n!="undefined"?(n?t.addClass("checked"):t.removeClass("checked"),t._checked=n,t.aria("checked",n),t):t._checked},value:function(n){return this.checked(n)},renderHtml:function(){var n=this,t=n._id,i=n.classPrefix;return'<div id="'+t+'" class="'+n.classes()+'" unselectable="on" aria-labelledby="'+t+'-al" tabindex="-1"><i class="'+i+"ico "+i+'i-checkbox"><\/i><span id="'+t+'-al" class="'+i+'label">'+n.encode(n._text)+"<\/span><\/div>"}})}),i("tinymce/ui/PanelButton",["tinymce/ui/Button","tinymce/ui/FloatPanel"],function(n,t){return n.extend({showPanel:function(){var n=this,r=n.settings,i;n.active(!0),n.panel?n.panel.show():(i=r.panel,i.type&&(i={layout:"grid",items:i}),i.popover=!0,i.autohide=!0,n.panel=new t(i).on("hide",function(){n.active(!1)}).parent(n).renderTo(n.getContainerElm()),n.panel.fire("show"),n.panel.reflow()),n.panel.moveRel(n.getEl(),r.popoverAlign||(n.isRtl()?["bc-tr","bc-tc"]:["bc-tl","bc-tc"]))},hidePanel:function(){var n=this;n.panel&&n.panel.hide()},postRender:function(){var n=this;n.on("click",function(t){t.control===n&&(n.panel&&n.panel.visible()?n.hidePanel():n.showPanel())});return n._super()}})}),i("tinymce/ui/ColorButton",["tinymce/ui/PanelButton","tinymce/dom/DOMUtils"],function(n,t){var i=t.DOM;return n.extend({init:function(n){this._super(n),this.addClass("colorbutton")},color:function(n){return n?(this._color=n,this.getEl("preview").style.backgroundColor=n,this):this._color},renderHtml:function(){var n=this,r=n._id,t=n.classPrefix,i=n.settings.icon?t+"ico "+t+"i-"+n.settings.icon:"",u=n.settings.image?" style=\"background-image: url('"+n.settings.image+"')\"":"";return'<div id="'+r+'" class="'+n.classes()+'"><button role="presentation" hidefocus type="button" tabindex="-1">'+(i?'<i class="'+i+'"'+u+"><\/i>":"")+'<span id="'+r+'-preview" class="'+t+'preview"><\/span>'+(n._text?(i?" ":"")+n._text:"")+'<\/button><button type="button" class="'+t+'open" hidefocus tabindex="-1"> <i class="'+t+'caret"><\/i><\/button><\/div>'},postRender:function(){var n=this,t=n.settings.onclick;n.on("click",function(r){r.control!=n||i.getParent(r.target,"."+n.classPrefix+"open")||(r.stopImmediatePropagation(),t.call(n,r))});return delete n.settings.onclick,n._super()}})}),i("tinymce/ui/ComboBox",["tinymce/ui/Widget","tinymce/ui/Factory","tinymce/ui/DomUtils"],function(n,t,i){return n.extend({init:function(n){var t=this;t._super(n),t.addClass("combobox"),t.subinput=!0,n=t.settings,n.menu=n.menu||n.values,n.menu&&(n.icon="caret");t.on("click",function(i){for(var r=i.target;r;)r.id&&r.id.indexOf("-open")!=-1&&(t.fire("action"),n.menu&&(t.showMenu(),i.keyboard&&t.menu.items()[0].focus())),r=r.parentNode});t.on("keydown",function(n){n.target.nodeName=="INPUT"&&n.keyCode==13&&t.parents().reverse().each(function(i){return n.preventDefault(),t.fire("change"),i.hasEventListeners("submit")&&i.toJSON?(i.fire("submit",{data:i.toJSON()}),!1):void 0})});if(n.placeholder){t.addClass("placeholder");t.on("focusin",function(){if(!t._hasOnChange){i.on(t.getEl("inp"),"change",function(){t.fire("change")});t._hasOnChange=!0}t.hasClass("placeholder")&&(t.getEl("inp").value="",t.removeClass("placeholder"))});t.on("focusout",function(){t.value().length===0&&(t.getEl("inp").value=n.placeholder,t.addClass("placeholder"))})}},showMenu:function(){var n=this,r=n.settings,i;if(!n.menu){i=r.menu||[],i.length?i={type:"menu",items:i}:i.type=i.type||"menu",n.menu=t.create(i).parent(n).renderTo(n.getContainerElm()),n.fire("createmenu"),n.menu.reflow();n.menu.on("cancel",function(t){t.control===n.menu&&n.focus()});n.menu.on("show hide",function(t){t.control.items().each(function(t){t.active(t.value()==n.value())})}).fire("show");n.menu.on("select",function(t){n.value(t.control.value())});n.on("focusin",function(t){t.target.tagName=="INPUT"&&n.menu.hide()});n.aria("expanded",!0)}n.menu.show(),n.menu.layoutRect({w:n.layoutRect().w}),n.menu.moveRel(n.getEl(),n.isRtl()?["br-tr","tr-br"]:["bl-tl","tl-bl"])},value:function(n){var t=this;return typeof n!="undefined"?(t._value=n,t.removeClass("placeholder"),t._rendered&&(t.getEl("inp").value=n),t):t._rendered?(n=t.getEl("inp").value,n!=t.settings.placeholder)?n:"":t._value},disabled:function(n){var t=this;return t._rendered&&typeof n!="undefined"&&(t.getEl("inp").disabled=n),t._super(n)},focus:function(){this.getEl("inp").focus()},repaint:function(){var n=this,o=n.getEl(),r=n.getEl("open"),u=n.layoutRect(),f,e,t;return f=r?u.w-i.getSize(r).width-10:u.w-10,t=document,t.all&&(!t.documentMode||t.documentMode<=8)&&(e=n.layoutRect().h-2+"px"),i.css(o.firstChild,{width:f,lineHeight:e}),n._super(),n},postRender:function(){var n=this;i.on(this.getEl("inp"),"change",function(){n.fire("change")});return n._super()},remove:function(){i.off(this.getEl("inp")),this._super()},renderHtml:function(){var i=this,f=i._id,n=i.settings,r=i.classPrefix,s=n.value||n.placeholder||"",t,e,o="",u="";return"spellcheck"in n&&(u+=' spellcheck="'+n.spellcheck+'"'),n.maxLength&&(u+=' maxlength="'+n.maxLength+'"'),n.size&&(u+=' size="'+n.size+'"'),n.subtype&&(u+=' type="'+n.subtype+'"'),i.disabled()&&(u+=' disabled="disabled"'),t=n.icon,t&&t!="caret"&&(t=r+"ico "+r+"i-"+n.icon),e=i._text,(t||e)&&(o='<div id="'+f+'-open" class="'+r+"btn "+r+'open" tabIndex="-1"><button id="'+f+'-action" type="button" hidefocus tabindex="-1">'+(t!="caret"?'<i class="'+t+'"><\/i>':'<i class="'+r+'caret"><\/i>')+(e?(t?" ":"")+e:"")+"<\/button><\/div>",i.addClass("has-open")),'<div id="'+f+'" class="'+i.classes()+'"><input id="'+f+'-inp" class="'+r+"textbox "+r+'placeholder" value="'+s+'" hidefocus="true"'+u+">"+o+"<\/div>"}})}),i("tinymce/ui/Path",["tinymce/ui/Widget","tinymce/ui/KeyboardNavigation"],function(n,t){return n.extend({init:function(n){var t=this;n.delimiter||(n.delimiter="\u00bb"),t._super(n),t.addClass("path"),t.canFocus=!0;t.on("click",function(n){var i,r=n.target;(i=r.getAttribute("data-index"))&&t.fire("select",{value:t.data()[i],index:i})})},focus:function(){var n=this;return n.keyNav=new t({root:n,enableLeftRight:!0}),n.keyNav.focusFirst(),n},data:function(n){var t=this;return typeof n!="undefined"?(t._data=n,t.update(),t):t._data},update:function(){this.innerHtml(this._getPathHtml())},postRender:function(){var n=this;n._super(),n.data(n.settings.data)},renderHtml:function(){var n=this;return'<div id="'+n._id+'" class="'+n.classes()+'">'+n._getPathHtml()+"<\/div>"},_getPathHtml:function(){for(var t=this,f=t._data||[],i="",r=t.classPrefix,n=0,u=f.length;n<u;n++)i+=(n>0?'<div class="'+r+'divider" aria-hidden="true"> '+t.settings.delimiter+" <\/div>":"")+'<div role="button" class="'+r+"path-item"+(n==u-1?" "+r+"last":"")+'" data-index="'+n+'" tabindex="-1" id="'+t._id+"-"+n+'">'+f[n].name+"<\/div>";return i||(i='<div class="'+r+'path-item">&nbsp;<\/div>'),i}})}),i("tinymce/ui/ElementPath",["tinymce/ui/Path","tinymce/EditorManager"],function(n,t){return n.extend({postRender:function(){function r(n){return n.nodeType===1&&(n.nodeName=="BR"||!!n.getAttribute("data-mce-bogus")||n.getAttribute("data-mce-type")==="bookmark")?!0:!1}var i=this,n=t.activeEditor;i.on("select",function(t){var u=[],i,f=n.getBody();for(n.focus(),i=n.selection.getStart();i&&i!=f;)r(i)||u.push(i),i=i.parentNode;n.selection.select(u[u.length-1-t.index]),n.nodeChanged()});n.on("nodeChange",function(t){for(var e=[],u=t.parents,f=u.length,o;f--;)u[f].nodeType!=1||r(u[f])||(o=n.fire("ResolveName",{name:u[f].nodeName.toLowerCase(),target:u[f]}),e.push({name:o.name}));i.data(e)});return i._super()}})}),i("tinymce/ui/FormItem",["tinymce/ui/Container"],function(n){return n.extend({Defaults:{layout:"flex",align:"center",defaults:{flex:1}},renderHtml:function(){var n=this,t=n._layout,i=n.classPrefix;return n.addClass("formitem"),t.preRender(n),'<div id="'+n._id+'" class="'+n.classes()+'" hideFocus="1" tabIndex="-1">'+(n.settings.title?'<div id="'+n._id+'-title" class="'+i+'title">'+n.settings.title+"<\/div>":"")+'<div id="'+n._id+'-body" class="'+n.classes("body")+'">'+(n.settings.html||"")+t.renderHtml(n)+"<\/div><\/div>"}})}),i("tinymce/ui/Form",["tinymce/ui/Container","tinymce/ui/FormItem"],function(n,t){return n.extend({Defaults:{containerCls:"form",layout:"flex",direction:"column",align:"stretch",flex:1,padding:20,labelGap:30,spacing:10,callbacks:{submit:function(){this.submit()}}},preRender:function(){var n=this,i=n.items();i.each(function(i){var r,u=i.settings.label;u&&(r=new t({layout:"flex",autoResize:"overflow",defaults:{flex:1},items:[{type:"label",text:u,flex:0,forId:i._id,disabled:i.disabled()}]}),r.type="formitem",typeof i.settings.flex=="undefined"&&(i.settings.flex=1),n.replace(i,r),r.add(i))})},recalcLabels:function(){var t=this,n=0,i=[],r,u;if(t.settings.labelGapCalc!==!1)for(t.items().filter("formitem").each(function(t){var r=t.items()[0],u=r.getEl().clientWidth;n=u>n?u:n,i.push(r)}),u=t.settings.labelGap||0,r=i.length;r--;)i[r].settings.minWidth=n+u},visible:function(n){var t=this._super(n);return n===!0&&this._rendered&&this.recalcLabels(),t},submit:function(){return this.fire("submit",{data:this.toJSON()})},postRender:function(){var n=this;n._super(),n.recalcLabels(),n.fromJSON(n.settings.data)}})}),i("tinymce/ui/FieldSet",["tinymce/ui/Form"],function(n){return n.extend({Defaults:{containerCls:"fieldset",layout:"flex",direction:"column",align:"stretch",flex:1,padding:"25 15 5 15",labelGap:30,spacing:10,border:1},renderHtml:function(){var n=this,t=n._layout,i=n.classPrefix;return n.preRender(),t.preRender(n),'<fieldset id="'+n._id+'" class="'+n.classes()+'" hideFocus="1" tabIndex="-1">'+(n.settings.title?'<legend id="'+n._id+'-title" class="'+i+'fieldset-title">'+n.settings.title+"<\/legend>":"")+'<div id="'+n._id+'-body" class="'+n.classes("body")+'">'+(n.settings.html||"")+t.renderHtml(n)+"<\/div><\/fieldset>"}})}),i("tinymce/ui/FilePicker",["tinymce/ui/ComboBox"],function(n){return n.extend({init:function(n){var t=this,r=tinymce.activeEditor,i;n.spellcheck=!1,i=r.settings.file_browser_callback,i&&(n.icon="browse",n.onaction=function(){i(t.getEl("inp").id,t.getEl("inp").value,n.filetype,window)}),t._super(n)}})}),i("tinymce/ui/FitLayout",["tinymce/ui/AbsoluteLayout"],function(n){return n.extend({recalc:function(n){var i=n.layoutRect(),t=n.paddingBox();n.items().filter(":visible").each(function(n){n.layoutRect({x:t.left,y:t.top,w:i.innerW-t.right-t.left,h:i.innerH-t.top-t.bottom}),n.recalc&&n.recalc()})}})}),i("tinymce/ui/FlexLayout",["tinymce/ui/AbsoluteLayout"],function(n){return n.extend({recalc:function(n){var f,v,s,r,u,y,ut,ft,et,w,e,b,o,i,gt,ot,at=[],h,vt,st,t,l,g,yt,a,pt,nt,c,p,ni,ht,wt,k,tt,it,rt,ti,d,ct,bt,kt,dt=Math.max,ii=Math.min,lt;for(s=n.items().filter(":visible"),r=n.layoutRect(),u=n._paddingBox,y=n.settings,b=n.isRtl()?y.direction||"row-reversed":y.direction,ut=y.align,ft=n.isRtl()?y.pack||"end":y.pack,et=y.spacing||0,(b=="row-reversed"||b=="column-reverse")&&(s=s.set(s.toArray().reverse()),b=b.split("-")[0]),b=="column"?(pt="y",yt="h",a="minH",nt="maxH",p="innerH",c="top",ni="bottom",ht="deltaH",wt="contentH",d="left",it="w",k="x",tt="innerW",rt="minW",ti="maxW",ct="right",bt="deltaW",kt="contentW"):(pt="x",yt="w",a="minW",nt="maxW",p="innerW",c="left",ni="right",ht="deltaW",wt="contentW",d="top",it="h",k="y",tt="innerH",rt="minH",ti="maxH",ct="bottom",bt="deltaH",kt="contentH"),e=r[p]-u[c]-u[c],g=w=0,f=0,v=s.length;f<v;f++)o=s[f],i=o.layoutRect(),gt=o.settings,ot=gt.flex,e-=f<v-1?et:0,ot>0&&(w+=ot,i[nt]&&at.push(o),i.flex=ot),e-=i[a],h=u[d]+i[rt]+u[ct],h>g&&(g=h);if(t={},t[a]=e<0?r[a]-e+r[ht]:r[p]-e+r[ht],t[rt]=g+r[bt],t[wt]=r[p]-e,t[kt]=g,t.minW=ii(t.minW,r.maxW),t.minH=ii(t.minH,r.maxH),t.minW=dt(t.minW,r.startMinWidth),t.minH=dt(t.minH,r.startMinHeight),r.autoResize&&(t.minW!=r.minW||t.minH!=r.minH)){t.w=t.minW,t.h=t.minH,n.layoutRect(t),this.recalc(n),n._lastRect===null&&(lt=n.parent(),lt&&(lt._lastRect=null,lt.recalc()));return}for(st=e/w,f=0,v=at.length;f<v;f++)o=at[f],i=o.layoutRect(),vt=i[nt],h=i[a]+i.flex*st,h>vt?(e-=i[nt]-i[a],w-=i.flex,i.flex=0,i.maxFlexSize=vt):i.maxFlexSize=0;for(st=e/w,l=u[c],t={},w===0&&(ft=="end"?l=e+u[c]:ft=="center"?(l=Math.round(r[p]/2-(r[p]-e)/2)+u[c],l<0&&(l=u[c])):ft=="justify"&&(l=u[c],et=Math.floor(e/(s.length-1)))),t[k]=u[d],f=0,v=s.length;f<v;f++)o=s[f],i=o.layoutRect(),h=i.maxFlexSize||i[a],ut==="center"?t[k]=Math.round(r[tt]/2-i[it]/2):ut==="stretch"?(t[it]=dt(i[rt]||0,r[tt]-u[d]-u[ct]),t[k]=u[d]):ut==="end"&&(t[k]=r[tt]-i[it]-u.top),i.flex>0&&(h+=i.flex*st),t[yt]=h,t[pt]=l,o.layoutRect(t),o.recalc&&o.recalc(),l+=h+et}})}),i("tinymce/ui/FlowLayout",["tinymce/ui/Layout"],function(n){return n.extend({Defaults:{containerClass:"flow-layout",controlClass:"flow-layout-item",endClass:"break"},recalc:function(n){n.items().filter(":visible").each(function(n){n.recalc&&n.recalc()})}})}),i("tinymce/ui/FormatControls",["tinymce/ui/Control","tinymce/ui/Widget","tinymce/ui/FloatPanel","tinymce/util/Tools","tinymce/EditorManager","tinymce/Env"],function(n,t,i,r,u,f){function o(n){function f(t){function s(n){return n.replace(/%(\w+)/g,"")}var h,r,i=n.dom,o="",u,f;return(f=n.settings.preview_styles,f===!1)?"":(f||(f="font-family font-size font-weight font-style text-decoration text-transform color background-color border border-radius outline text-shadow"),t=n.formatter.get(t),!t)?void 0:(t=t[0],h=t.block||t.inline||"span",r=i.create(h),e(t.styles,function(n,t){n=s(n),n&&i.setStyle(r,t,n)}),e(t.attributes,function(n,t){n=s(n),n&&i.setAttrib(r,t,n)}),e(t.classes,function(n){n=s(n),i.hasClass(r,n)||i.addClass(r,n)}),n.fire("PreviewFormats"),i.setStyles(r,{position:"absolute",left:-65535}),n.getBody().appendChild(r),u=i.getStyle(n.getBody(),"fontSize",!0),u=/px$/.test(u)?parseInt(u,10):0,e(f.split(" "),function(t){var f=i.getStyle(r,t,!0);if((t!="background-color"||!/transparent|rgba\s*\([^)]+,\s*0\)/.test(f)||(f=i.getStyle(n.getBody(),t,!0),i.toHex(f).toLowerCase()!="#ffffff"))&&(t!="color"||i.toHex(f).toLowerCase()!="#000000")){if(t=="font-size"&&/em|%$/.test(f)){if(u===0)return;f=parseFloat(f,10)/(/%$/.test(f)?100:1),f=f*u+"px"}t=="border"&&f&&(o+="padding:0 2px;"),o+=t+":"+f+";"}}),n.fire("AfterPreviewFormats"),i.remove(r),o)}function r(t,i){return function(){var r=this;n.on("nodeChange",function(u){var o=n.formatter,f=null;e(u.parents,function(n){return e(t,function(t){return i?o.matchNode(n,i,{value:t.value})&&(f=t.value):o.matchNode(n,t.value)&&(f=t.value),f?!1:void 0}),f?!1:void 0}),r.value(f)})}}function o(n){n=n.split(";");for(var t=n.length;t--;)n[t]=n[t].split("=");return n}function a(){function t(n){var i=[];if(n)return e(n,function(n){var u={text:n.title,icon:n.icon},f;n.items?u.menu=t(n.items):(f=n.format||"custom"+o++,n.format||(n.name=f,r.push(n)),u.format=f),i.push(u)}),i}function s(){return n.settings.style_formats_merge?n.settings.style_formats?t(i.concat(n.settings.style_formats)):t(i):t(n.settings.style_formats||i)}var o=0,r=[],i=[{title:"Inline",items:[{title:"Bold",icon:"bold",format:"bold"},{title:"Italic",icon:"italic",format:"italic"},{title:"Underline",icon:"underline",format:"underline"},{title:"Strikethrough",icon:"strikethrough",format:"strikethrough"},{title:"Superscript",icon:"superscript",format:"superscript"},{title:"Subscript",icon:"subscript",format:"subscript"},{title:"Code",icon:"code",format:"code"}]},{title:"Blocks",items:[{title:"Paragraph",format:"p"},{title:"Blockquote",format:"blockquote"},{title:"Div",format:"div"},{title:"Code",format:"pre"}]},{title:"Alignment",items:[{title:"Left",icon:"alignleft",format:"alignleft"},{title:"Center",icon:"aligncenter",format:"aligncenter"},{title:"Right",icon:"alignright",format:"alignright"},{title:"Justify",icon:"alignjustify",format:"alignjustify"}]}];n.on("init",function(){e(r,function(t){n.formatter.register(t.name,t)})});return{type:"menu",items:s(),onPostRender:function(t){n.fire("renderFormatsMenu",{control:t.control})},itemDefaults:{preview:!0,textStyle:function(){if(this.settings.format)return f(this.settings.format)},onPostRender:function(){var t=this,i=this.settings.format;if(i)t.parent().on("show",function(){t.disabled(!n.formatter.canApply(i)),t.active(n.formatter.match(i))})},onclick:function(){this.settings.format&&u(this.settings.format)}}}}function s(){return n.undoManager?n.undoManager.hasUndo():!1}function h(){return n.undoManager?n.undoManager.hasRedo():!1}function c(){var t=this;t.disabled(!s());n.on("Undo Redo AddUndo TypingUndo",function(){t.disabled(!s())})}function l(){var t=this;t.disabled(!h());n.on("Undo Redo AddUndo TypingUndo",function(){t.disabled(!h())})}function v(){var t=this;n.on("VisualAid",function(n){t.active(n.hasVisual)});t.active(n.hasVisual)}function u(t){t.control&&(t=t.control.value()),t&&n.execCommand("mceToggleFormat",!1,t)}var t;t=a(),e({bold:"Bold",italic:"Italic",underline:"Underline",strikethrough:"Strikethrough",subscript:"Subscript",superscript:"Superscript"},function(t,i){n.addButton(i,{tooltip:t,onPostRender:function(){var t=this;if(n.formatter)n.formatter.formatChanged(i,function(n){t.active(n)});else n.on("init",function(){n.formatter.formatChanged(i,function(n){t.active(n)})})},onclick:function(){u(i)}})}),e({outdent:["Decrease indent","Outdent"],indent:["Increase indent","Indent"],cut:["Cut","Cut"],copy:["Copy","Copy"],paste:["Paste","Paste"],help:["Help","mceHelp"],selectall:["Select all","SelectAll"],hr:["Insert horizontal rule","InsertHorizontalRule"],removeformat:["Clear formatting","RemoveFormat"],visualaid:["Visual aids","mceToggleVisualAid"],newdocument:["New document","mceNewDocument"]},function(t,i){n.addButton(i,{tooltip:t[0],cmd:t[1]})}),e({blockquote:["Blockquote","mceBlockQuote"],numlist:["Numbered list","InsertOrderedList"],bullist:["Bullet list","InsertUnorderedList"],subscript:["Subscript","Subscript"],superscript:["Superscript","Superscript"],alignleft:["Align left","JustifyLeft"],aligncenter:["Align center","JustifyCenter"],alignright:["Align right","JustifyRight"],alignjustify:["Justify","JustifyFull"]},function(t,i){n.addButton(i,{tooltip:t[0],cmd:t[1],onPostRender:function(){var t=this;if(n.formatter)n.formatter.formatChanged(i,function(n){t.active(n)});else n.on("init",function(){n.formatter.formatChanged(i,function(n){t.active(n)})})}})}),n.addButton("undo",{tooltip:"Undo",onPostRender:c,cmd:"undo"}),n.addButton("redo",{tooltip:"Redo",onPostRender:l,cmd:"redo"}),n.addMenuItem("undo",{text:"Undo",icon:"undo",shortcut:"Ctrl+Z",onPostRender:c,cmd:"undo"}),n.addMenuItem("redo",{text:"Redo",icon:"redo",shortcut:"Ctrl+Y",onPostRender:l,cmd:"redo"}),n.addMenuItem("visualaid",{text:"Visual aids",selectable:!0,onPostRender:v,cmd:"mceToggleVisualAid"}),e({selectall:["Select all","SelectAll","Ctrl+A"],bold:["Bold","Bold","Ctrl+B"],italic:["Italic","Italic","Ctrl+I"],underline:["Underline","Underline"],strikethrough:["Strikethrough","Strikethrough"],subscript:["Subscript","Subscript"],superscript:["Superscript","Superscript"],removeformat:["Clear formatting","RemoveFormat"]},function(t,i){n.addMenuItem(i,{text:t[0],icon:i,shortcut:t[2],cmd:t[1]})});n.on("mousedown",function(){i.hideAll()});n.addButton("styleselect",{type:"menubutton",text:"Formats",menu:t}),n.addButton("formatselect",function(){var t=[],i=o(n.settings.block_formats||"Paragraph=p;Address=address;Pre=pre;Header 1=h1;Header 2=h2;Header 3=h3;Header 4=h4;Header 5=h5;Header 6=h6");return e(i,function(n){t.push({text:n[0],value:n[1],textStyle:function(){return f(n[1])}})}),{type:"listbox",text:i[0][0],values:t,fixedWidth:!0,onselect:u,onPostRender:r(t)}}),n.addButton("fontselect",function(){var t=[],i=o(n.settings.font_formats||"Andale Mono=andale mono,times;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings,zapf dingbats");return e(i,function(n){t.push({text:{raw:n[0]},value:n[1],textStyle:n[1].indexOf("dings")==-1?"font-family:"+n[1]:""})}),{type:"listbox",text:"Font Family",tooltip:"Font Family",values:t,fixedWidth:!0,onPostRender:r(t,"fontname"),onselect:function(t){t.control.settings.value&&n.execCommand("FontName",!1,t.control.settings.value)}}}),n.addButton("fontsizeselect",function(){var t=[],i=n.settings.fontsize_formats||"8pt 10pt 12pt 14pt 18pt 24pt 36pt";return e(i.split(" "),function(n){t.push({text:n,value:n})}),{type:"listbox",text:"Font Sizes",tooltip:"Font Sizes",values:t,fixedWidth:!0,onPostRender:r(t,"fontsize"),onclick:function(t){t.control.settings.value&&n.execCommand("FontSize",!1,t.control.settings.value)}}}),n.addMenuItem("formats",{text:"Formats",menu:t})}var e=r.each;u.on("AddEditor",function(t){t.editor.rtl&&(n.rtl=!0),o(t.editor)});n.translate=function(n){return u.translate(n)},t.tooltips=!f.iOS}),i("tinymce/ui/GridLayout",["tinymce/ui/AbsoluteLayout"],function(n){return n.extend({recalc:function(n){var e=n.settings,p,s,b,u,k,d,i,f,h,t,r,g,nt,st,o,c,tt,it,l,a,rt,ut,v=[],y=[],ht,ct,yt,pt,lt,ft,et,vt,ot,w,at;for(e=n.settings,b=n.items().filter(":visible"),u=n.layoutRect(),s=e.columns||Math.ceil(Math.sqrt(b.length)),p=Math.ceil(b.length/s),tt=e.spacingH||e.spacing||0,it=e.spacingV||e.spacing||0,l=e.alignH||e.align,a=e.alignV||e.align,o=n._paddingBox,l&&typeof l=="string"&&(l=[l]),a&&typeof a=="string"&&(a=[a]),t=0;t<s;t++)v.push(0);for(r=0;r<p;r++)y.push(0);for(r=0;r<p;r++)for(t=0;t<s;t++){if(h=b[r*s+t],!h)break;f=h.layoutRect(),ht=f.minW,ct=f.minH,v[t]=ht>v[t]?ht:v[t],y[r]=ct>y[r]?ct:y[r]}for(lt=u.innerW-o.left-o.right,rt=0,t=0;t<s;t++)rt+=v[t]+(t>0?tt:0),lt-=(t>0?tt:0)+v[t];for(ft=u.innerH-o.top-o.bottom,ut=0,r=0;r<p;r++)ut+=y[r]+(r>0?it:0),ft-=(r>0?it:0)+y[r];if(rt+=o.left+o.right,ut+=o.top+o.bottom,i={},i.minW=rt+(u.w-u.innerW),i.minH=ut+(u.h-u.innerH),i.contentW=i.minW-u.deltaW,i.contentH=i.minH-u.deltaH,i.minW=Math.min(i.minW,u.maxW),i.minH=Math.min(i.minH,u.maxH),i.minW=Math.max(i.minW,u.startMinWidth),i.minH=Math.max(i.minH,u.startMinHeight),u.autoResize&&(i.minW!=u.minW||i.minH!=u.minH)){i.w=i.minW,i.h=i.minH,n.layoutRect(i),this.recalc(n),n._lastRect===null&&(et=n.parent(),et&&(et._lastRect=null,et.recalc()));return}if(u.autoResize&&(i=n.layoutRect(i),i.contentW=i.minW-u.deltaW,i.contentH=i.minH-u.deltaH),vt=e.packV=="start"?0:ft>0?Math.floor(ft/p):0,ot=0,w=e.flexWidths,w)for(t=0;t<w.length;t++)ot+=w[t];else ot=s;for(at=lt/ot,t=0;t<s;t++)v[t]+=w?w[t]*at:at;for(nt=o.top,r=0;r<p;r++){for(g=o.left,d=y[r]+vt,t=0;t<s;t++){if(h=b[r*s+t],!h)break;st=h.settings,f=h.layoutRect(),k=Math.max(v[t],f.startMinWidth),yt=pt=0,f.x=g,f.y=nt,c=st.alignH||(l?l[t]||l[0]:null),c=="center"?f.x=g+k/2-f.w/2:c=="right"?f.x=g+k-f.w:c=="stretch"&&(f.w=k),c=st.alignV||(a?a[t]||a[0]:null),c=="center"?f.y=nt+d/2-f.h/2:c=="bottom"?f.y=nt+d-f.h:c=="stretch"&&(f.h=d),h.layoutRect(f),g+=k+tt,h.recalc&&h.recalc()}nt+=d+it}}})}),i("tinymce/ui/Iframe",["tinymce/ui/Widget"],function(n){return n.extend({renderHtml:function(){var n=this;return n.addClass("iframe"),n.canFocus=!1,'<iframe id="'+n._id+'" class="'+n.classes()+'" tabindex="-1" src="'+(n.settings.url||"javascript:''")+'" frameborder="0"><\/iframe>'},src:function(n){this.getEl().src=n},html:function(n,t){var r=this,i=this.getEl().contentWindow.document.body;return i?(i.innerHTML=n,t&&t()):setTimeout(function(){r.html(n)},0),this}})}),i("tinymce/ui/Label",["tinymce/ui/Widget","tinymce/ui/DomUtils"],function(n,t){return n.extend({init:function(n){var t=this;t._super(n),t.addClass("widget"),t.addClass("label"),t.canFocus=!1,n.multiline&&t.addClass("autoscroll"),n.strong&&t.addClass("strong")},initLayoutRect:function(){var i=this,n=i._super(),r;return i.settings.multiline&&(r=t.getSize(i.getEl()),r.width>n.maxW&&(n.minW=n.maxW,i.addClass("multiline")),i.getEl().style.width=n.minW+"px",n.startMinH=n.h=n.minH=Math.min(n.maxH,t.getSize(i.getEl()).height)),n},repaint:function(){var n=this;return n.settings.multiline||(n.getEl().style.lineHeight=n.layoutRect().h+"px"),n._super()},text:function(n){var t=this;return t._rendered&&n&&this.innerHtml(t.encode(n)),t._super(n)},renderHtml:function(){var n=this,t=n.settings.forId;return'<label id="'+n._id+'" class="'+n.classes()+'"'+(t?' for="'+t+'"':"")+">"+n.encode(n._text)+"<\/label>"}})}),i("tinymce/ui/Toolbar",["tinymce/ui/Container","tinymce/ui/KeyboardNavigation"],function(n,t){return n.extend({Defaults:{role:"toolbar",layout:"flow"},init:function(n){var t=this;t._super(n),t.addClass("toolbar")},postRender:function(){var n=this;return n.items().addClass("toolbar-item"),n.keyNav=new t({root:n,enableLeftRight:!0}),n._super()}})}),i("tinymce/ui/MenuBar",["tinymce/ui/Toolbar"],function(n){return n.extend({Defaults:{role:"menubar",containerCls:"menubar",defaults:{type:"menubutton"}}})}),i("tinymce/ui/MenuButton",["tinymce/ui/Button","tinymce/ui/Factory","tinymce/ui/MenuBar"],function(n,t,i){function u(n,t){while(n){if(t===n)return!0;n=n.parentNode}return!1}var r=n.extend({init:function(n){var t=this;t._renderOpen=!0,t._super(n),t.addClass("menubtn"),n.fixedWidth&&t.addClass("fixed-width"),t.aria("haspopup",!0),t.hasPopup=!0},showMenu:function(){var n=this,r=n.settings,i;if(n.menu&&n.menu.visible())return n.hideMenu();if(!n.menu){i=r.menu||[],i.length?i={type:"menu",items:i}:i.type=i.type||"menu",n.menu=t.create(i).parent(n).renderTo(n.getContainerElm()),n.fire("createmenu"),n.menu.reflow();n.menu.on("cancel",function(t){t.control===n.menu&&n.focus()});n.menu.on("show hide",function(t){t.control==n.menu&&n.activeMenu(t.type=="show")}).fire("show"),n.aria("expanded",!0)}n.menu.show(),n.menu.layoutRect({w:n.layoutRect().w}),n.menu.moveRel(n.getEl(),n.isRtl()?["br-tr","tr-br"]:["bl-tl","tl-bl"])},hideMenu:function(){var n=this;n.menu&&(n.menu.items().each(function(n){n.hideMenu&&n.hideMenu()}),n.menu.hide(),n.aria("expanded",!1))},activeMenu:function(n){this.toggleClass("active",n)},renderHtml:function(){var n=this,u=n._id,t=n.classPrefix,r=n.settings.icon?t+"ico "+t+"i-"+n.settings.icon:"";return n.aria("role",n.parent()instanceof i?"menuitem":"button"),'<div id="'+u+'" class="'+n.classes()+'" tabindex="-1"><button id="'+u+'-open" role="presentation" type="button" tabindex="-1">'+(r?'<i class="'+r+'"><\/i>':"")+"<span>"+(n._text?(r?"\u00a0":"")+n.encode(n._text):"")+'<\/span> <i class="'+t+'caret"><\/i><\/button><\/div>'},postRender:function(){var n=this;n.on("click",function(t){t.control===n&&u(t.target,n.getEl())&&(n.showMenu(),t.keyboard&&n.menu.items()[0].focus())});n.on("mouseenter",function(t){var i=t.control,u=n.parent(),f;i&&u&&i instanceof r&&i.parent()==u&&(u.items().filter("MenuButton").each(function(n){n.hideMenu&&n!=i&&(n.menu&&n.menu.visible()&&(f=!0),n.hideMenu())}),f&&(i.focus(),i.showMenu()))});return n._super()},text:function(n){var t=this,i,r;if(t._rendered)for(r=t.getEl("open").getElementsByTagName("span"),i=0;i<r.length;i++)r[i].innerHTML=(t.settings.icon&&n?"\u00a0":"")+t.encode(n);return this._super(n)},remove:function(){this._super(),this.menu&&this.menu.remove()}});return r}),i("tinymce/ui/ListBox",["tinymce/ui/MenuButton"],function(n){return n.extend({init:function(n){var r=this,t,i,e,u,f;if(r._values=t=n.values,t){for(i=0;i<t.length;i++)e=t[i].selected||n.value===t[i].value,e&&(u=u||t[i].text,r._value=t[i].value);n.menu=t}n.text=n.text||u||t[0].text,r._super(n),r.addClass("listbox");r.on("select",function(t){var i=t.control;f&&(t.lastControl=f),n.multiple?i.active(!i.active()):r.value(t.control.settings.value),f=i})},value:function(n){function e(n,i){n.items().each(function(n){t=n.value()===i,t&&(u=u||n.text()),n.active(t),n.menu&&e(n.menu,i)})}var r=this,t,u,f,i;if(typeof n!="undefined"){if(r.menu)e(r.menu,n);else for(f=r.settings.menu,i=0;i<f.length;i++)t=f[i].value==n,t&&(u=u||f[i].text),f[i].active=t;r.text(u||this.settings.text)}return r._super(n)}})}),i("tinymce/ui/MenuItem",["tinymce/ui/Widget","tinymce/ui/Factory","tinymce/Env"],function(n,t,i){return n.extend({Defaults:{border:0,role:"menuitem"},init:function(n){var t=this;t.hasPopup=!0,t._super(n),n=t.settings,t.addClass("menu-item"),n.menu&&t.addClass("menu-item-expand"),n.preview&&t.addClass("menu-item-preview"),(t._text==="-"||t._text==="|")&&(t.addClass("menu-item-sep"),t.aria("role","separator"),t.canFocus=!1,t._text="-"),n.selectable&&(t.aria("role","menuitemcheckbox"),t.aria("checked",!0),t.addClass("menu-item-checkbox"),n.icon="selected"),n.preview||n.selectable||t.addClass("menu-item-normal");t.on("mousedown",function(n){n.preventDefault()});t.on("mouseenter click",function(i){i.control===t&&(n.menu||i.type!=="click"?(t.showMenu(),i.keyboard&&setTimeout(function(){t.menu.items()[0].focus()},0)):(t.parent().hideAll(),t.fire("cancel"),t.fire("select")))});n.menu&&t.aria("haspopup",!0)},hasMenus:function(){return!!this.settings.menu},showMenu:function(){var i=this,f=i.settings,n,u=i.parent(),r;if(u.items().each(function(n){n!==i&&n.hideMenu()}),f.menu){if(n=i.menu,n)n.show();else{n=f.menu,n.length?n={type:"menu",items:n}:n.type=n.type||"menu",u.settings.itemDefaults&&(n.itemDefaults=u.settings.itemDefaults),n=i.menu=t.create(n).parent(i).renderTo(i.getContainerElm()),n.reflow(),n.fire("show");n.on("cancel",function(){i.focus()});n.on("hide",function(t){t.control===n&&i.removeClass("selected")})}n._parentMenu=u,n.addClass("menu-sub"),r=n.testMoveRel(i.getEl(),i.isRtl()?["tl-tr","bl-br","tr-tl","br-bl"]:["tr-tl","br-bl","tl-tr","bl-br"]),n.moveRel(i.getEl(),r),n.rel=r,r="menu-sub-"+r,n.removeClass(n._lastRel),n.addClass(r),n._lastRel=r,i.addClass("selected"),i.aria("expanded",!0)}},hideMenu:function(){var n=this;return n.menu&&(n.menu.items().each(function(n){n.hideMenu&&n.hideMenu()}),n.menu.hide(),n.aria("expanded",!1)),n},renderHtml:function(){var t=this,e=t._id,u=t.settings,r=t.classPrefix,o=t.encode(t._text),f=t.settings.icon,s="",n=u.shortcut;return f&&t.parent().addClass("menu-has-icons"),u.image&&(f="none",s=" style=\"background-image: url('"+u.image+"')\""),n&&i.mac&&(n=n.replace(/ctrl\+alt\+/i,"&#x2325;&#x2318;"),n=n.replace(/ctrl\+/i,"&#x2318;"),n=n.replace(/alt\+/i,"&#x2325;"),n=n.replace(/shift\+/i,"&#x21E7;")),f=r+"ico "+r+"i-"+(t.settings.icon||"none"),'<div id="'+e+'" class="'+t.classes()+'" tabindex="-1">'+(o!=="-"?'<i class="'+f+'"'+s+"><\/i>&nbsp;":"")+(o!=="-"?'<span id="'+e+'-text" class="'+r+'text">'+o+"<\/span>":"")+(n?'<div id="'+e+'-shortcut" class="'+r+'menu-shortcut">'+n+"<\/div>":"")+(u.menu?'<div class="'+r+'caret"><\/div>':"")+"<\/div>"},postRender:function(){var t=this,r=t.settings,n=r.textStyle,i;return typeof n=="function"&&(n=n.call(this)),n&&(i=t.getEl("text"),i&&i.setAttribute("style",n)),t._super()},remove:function(){this._super(),this.menu&&this.menu.remove()}})}),i("tinymce/ui/Menu",["tinymce/ui/FloatPanel","tinymce/ui/KeyboardNavigation","tinymce/ui/MenuItem","tinymce/util/Tools"],function(n,t,i,r){return n.extend({Defaults:{defaultType:"menuitem",border:1,layout:"stack",role:"menu"},init:function(n){var u=this,f,e;if(n.autohide=!0,n.constrainToViewport=!0,n.itemDefaults)for(f=n.items,e=f.length;e--;)f[e]=r.extend({},n.itemDefaults,f[e]);u._super(n),u.addClass("menu"),u.keyNav=new t({root:u,enableUpDown:!0,enableLeftRight:!0,leftAction:function(){u.parent()instanceof i&&u.keyNav.cancel()},onCancel:function(){u.fire("cancel",{},!1),u.hide()}})},repaint:function(){return this.toggleClass("menu-align",!0),this._super(),this.getEl().style.height="",this.getEl("body").style.height="",this},cancel:function(){var n=this;n.hideAll(),n.fire("cancel"),n.fire("select")},hideAll:function(){var n=this;return this.find("menuitem").exec("hideMenu"),n._super()},preRender:function(){var n=this;return n.items().each(function(t){var i=t.settings;if(i.icon||i.selectable)return n._hasIcons=!0,!1}),n._super()}})}),i("tinymce/ui/Radio",["tinymce/ui/Checkbox"],function(n){return n.extend({Defaults:{classes:"radio",role:"radio"}})}),i("tinymce/ui/ResizeHandle",["tinymce/ui/Widget","tinymce/ui/DragHelper"],function(n,t){return n.extend({renderHtml:function(){var n=this,t=n.classPrefix;return n.addClass("resizehandle"),n.settings.direction=="both"&&n.addClass("resizehandle-both"),n.canFocus=!1,'<div id="'+n._id+'" class="'+n.classes()+'"><i class="'+t+"ico "+t+'i-resize"><\/i><\/div>'},postRender:function(){var n=this;n._super(),n.resizeDragHelper=new t(this._id,{start:function(){n.fire("ResizeStart")},drag:function(t){n.settings.direction!="both"&&(t.deltaX=0),n.fire("Resize",t)},stop:function(){n.fire("ResizeEnd")}})},remove:function(){return this.resizeDragHelper&&this.resizeDragHelper.destroy(),this._super()}})}),i("tinymce/ui/Spacer",["tinymce/ui/Widget"],function(n){return n.extend({renderHtml:function(){var n=this;return n.addClass("spacer"),n.canFocus=!1,'<div id="'+n._id+'" class="'+n.classes()+'"><\/div>'}})}),i("tinymce/ui/SplitButton",["tinymce/ui/MenuButton","tinymce/ui/DomUtils"],function(n,t){return n.extend({Defaults:{classes:"widget btn splitbtn",role:"splitbutton"},repaint:function(){var n=this,u=n.getEl(),i=n.layoutRect(),f,r;return n._super(),f=u.firstChild,r=u.lastChild,t.css(f,{width:i.w-t.getSize(r).width,height:i.h-2}),t.css(r,{height:i.h-2}),n},activeMenu:function(n){var i=this;t.toggleClass(i.getEl().lastChild,i.classPrefix+"active",n)},renderHtml:function(){var n=this,r=n._id,t=n.classPrefix,i=n.settings.icon?t+"ico "+t+"i-"+n.settings.icon:"";return'<div id="'+r+'" class="'+n.classes()+'"><button type="button" hidefocus tabindex="-1">'+(i?'<i class="'+i+'"><\/i>':"")+(n._text?(i?" ":"")+n._text:"")+'<\/button><button type="button" class="'+t+'open" hidefocus tabindex="-1">'+(n._menuBtnText?(i?"\u00a0":"")+n._menuBtnText:"")+' <i class="'+t+'caret"><\/i><\/button><\/div>'},postRender:function(){var n=this,t=n.settings.onclick;n.on("click",function(n){var i=n.target;if(n.control==this)while(i){if(i.nodeName=="BUTTON"&&i.className.indexOf("open")==-1){n.stopImmediatePropagation(),t.call(this,n);return}i=i.parentNode}});return delete n.settings.onclick,n._super()}})}),i("tinymce/ui/StackLayout",["tinymce/ui/FlowLayout"],function(n){return n.extend({Defaults:{containerClass:"stack-layout",controlClass:"stack-layout-item",endClass:"break"}})}),i("tinymce/ui/TabPanel",["tinymce/ui/Panel","tinymce/ui/DomUtils"],function(n,t){return n.extend({lastIdx:0,Defaults:{layout:"absolute",defaults:{type:"panel"}},activateTab:function(n){this.activeTabId&&t.removeClass(this.getEl(this.activeTabId),this.classPrefix+"active"),this.activeTabId="t"+n,t.addClass(this.getEl("t"+n),this.classPrefix+"active"),n!=this.lastIdx&&(this.items()[this.lastIdx].hide(),this.lastIdx=n),this.items()[n].show().fire("showtab"),this.reflow()},renderHtml:function(){var n=this,t=n._layout,i="",r=n.classPrefix;return n.preRender(),t.preRender(n),n.items().each(function(t,u){i+='<div id="'+n._id+"-t"+u+'" class="'+r+'tab" unselectable="on">'+n.encode(t.settings.title)+"<\/div>"}),'<div id="'+n._id+'" class="'+n.classes()+'" hideFocus="1" tabIndex="-1"><div id="'+n._id+'-head" class="'+r+'tabs">'+i+'<\/div><div id="'+n._id+'-body" class="'+n.classes("body")+'">'+t.renderHtml(n)+"<\/div><\/div>"},postRender:function(){var n=this;n._super(),n.settings.activeTab=n.settings.activeTab||0,n.activateTab(n.settings.activeTab);this.on("click",function(t){var r=t.target.parentNode,i;if(t.target.parentNode.id==n._id+"-head")for(i=r.childNodes.length;i--;)r.childNodes[i]==t.target&&n.activateTab(i)})},initLayoutRect:function(){var i=this,r,n,u,f;return n=t.getSize(i.getEl("head")).width,n=n<0?0:n,u=0,i.items().each(function(t,r){n=Math.max(n,t.layoutRect().minW),u=Math.max(u,t.layoutRect().minH),i.settings.activeTab!=r&&t.hide()}),i.items().each(function(t){t.settings.x=0,t.settings.y=0,t.settings.w=n,t.settings.h=u,t.layoutRect({x:0,y:0,w:n,h:u})}),f=t.getSize(i.getEl("head")).height,i.settings.minWidth=n,i.settings.minHeight=u+f,r=i._super(),r.deltaH+=f,r.innerH=r.h-r.deltaH,r}})}),i("tinymce/ui/TextBox",["tinymce/ui/Widget","tinymce/ui/DomUtils"],function(n,t){return n.extend({init:function(n){var t=this;if(t._super(n),t._value=n.value||"",t.addClass("textbox"),n.multiline)t.addClass("multiline");else t.on("keydown",function(n){n.keyCode==13&&t.parents().reverse().each(function(t){return n.preventDefault(),t.hasEventListeners("submit")&&t.toJSON?(t.fire("submit",{data:t.toJSON()}),!1):void 0})})},disabled:function(n){var t=this;return t._rendered&&typeof n!="undefined"&&(t.getEl().disabled=n),t._super(n)},value:function(n){var t=this;return typeof n!="undefined"?(t._value=n,t._rendered&&(t.getEl().value=n),t):t._rendered?t.getEl().value:t._value},repaint:function(){var i=this,r,n,u,o=0,e=0,t,f;return r=i.getEl().style,n=i._layoutRect,t=i._lastRepaintRect||{},f=document,!i.settings.multiline&&f.all&&(!f.documentMode||f.documentMode<=8)&&(r.lineHeight=n.h-e+"px"),u=i._borderBox,o=u.left+u.right+8,e=u.top+u.bottom+(i.settings.multiline?8:0),n.x!==t.x&&(r.left=n.x+"px",t.x=n.x),n.y!==t.y&&(r.top=n.y+"px",t.y=n.y),n.w!==t.w&&(r.width=n.w-o+"px",t.w=n.w),n.h!==t.h&&(r.height=n.h-e+"px",t.h=n.h),i._lastRepaintRect=t,i.fire("repaint",{},!1),i},renderHtml:function(){var t=this,r=t._id,n=t.settings,u=t.encode(t._value,!1),i="";return("spellcheck"in n&&(i+=' spellcheck="'+n.spellcheck+'"'),n.maxLength&&(i+=' maxlength="'+n.maxLength+'"'),n.size&&(i+=' size="'+n.size+'"'),n.subtype&&(i+=' type="'+n.subtype+'"'),t.disabled()&&(i+=' disabled="disabled"'),n.multiline)?'<textarea id="'+r+'" class="'+t.classes()+'" '+(n.rows?' rows="'+n.rows+'"':"")+' hidefocus="true"'+i+">"+u+"<\/textarea>":'<input id="'+r+'" class="'+t.classes()+'" value="'+u+'" hidefocus="true"'+i+">"},postRender:function(){var n=this;t.on(n.getEl(),"change",function(t){n.fire("change",t)});return n._super()},remove:function(){t.off(this.getEl()),this._super()}})}),i("tinymce/ui/Throbber",["tinymce/ui/DomUtils"],function(n){return function(t){var i=this,r;i.show=function(u){return i.hide(),r=!0,window.setTimeout(function(){r&&t.appendChild(n.createFragment('<div class="mce-throbber"><\/div>'))},u||0),i},i.hide=function(){var n=t.lastChild;return n&&n.className.indexOf("throbber")!=-1&&n.parentNode.removeChild(n),r=!1,i}}}),e(["tinymce/dom/EventUtils","tinymce/dom/Sizzle","tinymce/dom/DomQuery","tinymce/html/Styles","tinymce/dom/TreeWalker","tinymce/util/Tools","tinymce/dom/Range","tinymce/html/Entities","tinymce/Env","tinymce/dom/StyleSheetLoader","tinymce/dom/DOMUtils","tinymce/dom/ScriptLoader","tinymce/AddOnManager","tinymce/html/Node","tinymce/html/Schema","tinymce/html/SaxParser","tinymce/html/DomParser","tinymce/html/Writer","tinymce/html/Serializer","tinymce/dom/Serializer","tinymce/dom/TridentSelection","tinymce/util/VK","tinymce/dom/ControlSelection","tinymce/dom/Selection","tinymce/dom/RangeUtils","tinymce/Formatter","tinymce/UndoManager","tinymce/EnterKey","tinymce/ForceBlocks","tinymce/EditorCommands","tinymce/util/URI","tinymce/util/Class","tinymce/ui/Selector","tinymce/ui/Collection","tinymce/ui/DomUtils","tinymce/ui/Control","tinymce/ui/Factory","tinymce/ui/Container","tinymce/ui/DragHelper","tinymce/ui/Scrollable","tinymce/ui/Panel","tinymce/ui/Movable","tinymce/ui/Resizable","tinymce/ui/FloatPanel","tinymce/ui/KeyboardNavigation","tinymce/ui/Window","tinymce/ui/MessageBox","tinymce/WindowManager","tinymce/util/Quirks","tinymce/util/Observable","tinymce/Shortcuts","tinymce/Editor","tinymce/util/I18n","tinymce/FocusManager","tinymce/EditorManager","tinymce/LegacyInput","tinymce/util/XHR","tinymce/util/JSON","tinymce/util/JSONRequest","tinymce/util/JSONP","tinymce/util/LocalStorage","tinymce/Compat","tinymce/ui/Layout","tinymce/ui/AbsoluteLayout","tinymce/ui/Tooltip","tinymce/ui/Widget","tinymce/ui/Button","tinymce/ui/ButtonGroup","tinymce/ui/Checkbox","tinymce/ui/PanelButton","tinymce/ui/ColorButton","tinymce/ui/ComboBox","tinymce/ui/Path","tinymce/ui/ElementPath","tinymce/ui/FormItem","tinymce/ui/Form","tinymce/ui/FieldSet","tinymce/ui/FilePicker","tinymce/ui/FitLayout","tinymce/ui/FlexLayout","tinymce/ui/FlowLayout","tinymce/ui/FormatControls","tinymce/ui/GridLayout","tinymce/ui/Iframe","tinymce/ui/Label","tinymce/ui/Toolbar","tinymce/ui/MenuBar","tinymce/ui/MenuButton","tinymce/ui/ListBox","tinymce/ui/MenuItem","tinymce/ui/Menu","tinymce/ui/Radio","tinymce/ui/ResizeHandle","tinymce/ui/Spacer","tinymce/ui/SplitButton","tinymce/ui/StackLayout","tinymce/ui/TabPanel","tinymce/ui/TextBox","tinymce/ui/Throbber"])})(this),tinymce.PluginManager.add("autolink",function(n){function i(n){t(n,-1,"(",!0)}function r(n){t(n,0,"",!0)}function u(n){t(n,-1,"",!1)}function t(n,t,i){var r,f,s,u,a,h,e,o,c,l;if(r=n.selection.getRng(!0).cloneRange(),r.startOffset<5){if(o=r.endContainer.previousSibling,!o){if(!r.endContainer.firstChild||!r.endContainer.firstChild.nextSibling)return;o=r.endContainer.firstChild.nextSibling}if(c=o.length,r.setStart(o,c),r.setEnd(o,c),r.endOffset<5)return;f=r.endOffset,u=o}else{if(u=r.endContainer,u.nodeType!=3&&u.firstChild){while(u.nodeType!=3&&u.firstChild)u=u.firstChild;u.nodeType==3&&(r.setStart(u,0),r.setEnd(u,u.nodeValue.length))}f=r.endOffset==1?2:r.endOffset-1-t}s=f;do r.setStart(u,f>=2?f-2:0),r.setEnd(u,f>=1?f-1:0),f-=1;while(r.toString()!=" "&&r.toString()!==""&&r.toString().charCodeAt(0)!=160&&f-2>=0&&r.toString()!=i);f<0||(r.toString()==i||r.toString().charCodeAt(0)==160?(r.setStart(u,f),r.setEnd(u,s),f+=1):r.startOffset===0?(r.setStart(u,0),r.setEnd(u,s)):(r.setStart(u,f),r.setEnd(u,s)),h=r.toString(),h.charAt(h.length-1)=="."&&r.setEnd(u,s-1),h=r.toString(),e=h.match(/^(https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.|(?:mailto:)?[A-Z0-9._%+\-]+@)(.+)$/i),e&&(e[1]=="www."?e[1]="http://www.":/@$/.test(e[1])&&!/^mailto:/.test(e[1])&&(e[1]="mailto:"+e[1]),a=n.selection.getBookmark(),n.selection.setRng(r),n.execCommand("createlink",!1,e[1]+e[2]),n.selection.moveToBookmark(a),n.nodeChanged(),tinymce.Env.webkit&&(n.selection.collapse(!1),l=Math.min(u.length,s+1),r.setStart(u,l),r.setEnd(u,l),n.selection.setRng(r))))}n.on("keydown",function(t){if(t.keyCode==13)return u(n)});if(tinymce.Env.ie){n.on("init",function(){try{n.execCommand("AutoUrlDetect",!1,!0)}catch(t){}});return}n.on("keypress",function(t){if(t.which==41)return i(n)});n.on("keyup",function(t){if(t.keyCode==32)return r(n)})}),tinymce.PluginManager.add("advlist",function(n){function r(n,t){var i=[];return tinymce.each(t.split(/[ ,]/),function(n){i.push({text:n.replace(/\-/g," ").replace(/\b\w/g,function(n){return n.toUpperCase()}),data:n=="default"?"":n})}),i}function t(t,r){var u,f=n.dom,e=n.selection;u=f.getParent(e.getNode(),"ol,ul"),u&&u.nodeName==t&&r!==!1||n.execCommand(t=="UL"?"InsertUnorderedList":"InsertOrderedList"),r=r===!1?i[t]:r,i[t]=r,u=f.getParent(e.getNode(),"ol,ul"),u&&(f.setStyle(u,"listStyleType",r),u.removeAttribute("data-mce-style")),n.focus()}var u,f,i={};u=r("OL",n.getParam("advlist_number_styles","default,lower-alpha,lower-greek,lower-roman,upper-alpha,upper-roman")),f=r("UL",n.getParam("advlist_bullet_styles","default,circle,disc,square")),n.addButton("numlist",{tooltip:"Numbered list",onselect:function(n){t("OL",n.control.settings.data)},onclick:function(){t("OL",!1)}}),n.addButton("bullist",{tooltip:"Bullet list",onselect:function(n){t("UL",n.control.settings.data)},onclick:function(){t("UL",!1)}})}),tinymce.PluginManager.add("link",function(n){function t(){function s(){o||i.text.length!==0||this.parent().parent().find("#text")[0].value(this.value())}var i={},u=n.selection,r=n.dom,f,t,e,o=!1;f=u.getNode(),t=r.getParent(f,"a[href]"),t&&u.select(t),i.text=e=o=u.getContent({format:"text"}),i.href=t?r.getAttrib(t,"href"):"",i.target=t?r.getAttrib(t,"target"):"_blank",f.nodeName=="IMG"&&(i.text=e=" "),n.windowManager.open({title:"Insert link",data:i,body:[{name:"text",type:"textbox",size:40,label:"Text to display",onkeyup:function(){o=this.value()}},{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:s,onkeyup:s},{name:"target",type:"listbox",label:"Target",values:[{text:"None",value:""},{text:"New window",value:"_blank"}]}],onSubmit:function(i){var f=i.data;if(!f.href){n.execCommand("unlink");return}f.href.indexOf("http")!=0&&(f.href="http://"+f.href),f.text!=e?t?(n.focus(),t.innerHTML=f.text,r.setAttribs(t,{href:f.href,target:f.target}),u.select(t)):n.insertContent(r.createHTML("a",{href:f.href,target:f.target},f.text)):n.execCommand("mceInsertLink",!1,{href:f.href,target:f.target})}})}n.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:t,stateSelector:"a[href]"}),n.addButton("unlink",{icon:"unlink",tooltip:"Remove link(s)",cmd:"unlink",stateSelector:"a[href]"}),n.addShortcut("Ctrl+K","",t),this.showDialog=t,n.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:t,stateSelector:"a[href]",context:"insert",prependToContext:!0})}),tinymce.PluginManager.add("image",function(n){function t(){var f,e,i=n.dom,t=n.selection.getNode(),r,u;r=i.getAttrib(t,"width"),u=i.getAttrib(t,"height"),t.nodeName!="IMG"||t.getAttribute("data-mce-object")?t=null:e={src:i.getAttrib(t,"src"),alt:i.getAttrib(t,"alt"),width:r,height:u},f=n.windowManager.open({title:"Edit image",data:e,width:400,height:80,body:[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0}],onSubmit:function(r){var u=r.data;u.width===""&&delete u.width,u.height===""&&delete u.height,t?i.setAttribs(t,u):n.insertContent(i.createHTML("img",u))}})}n.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:t,stateSelector:"img:not([data-mce-object])"}),n.addMenuItem("image",{icon:"image",text:"Insert image",onclick:t,context:"insert",prependToContext:!0})}),tinymce.PluginManager.add("media",function(n,t){function o(n){return n.indexOf(".mp3")!=-1?"audio/mpeg":n.indexOf(".wav")!=-1?"audio/wav":n.indexOf(".mp4")!=-1?"video/mp4":n.indexOf(".webm")!=-1?"video/webm":n.indexOf(".ogg")!=-1?"video/ogg":""}function r(){function o(n){var e,o,i,u;e=t.find("#width")[0],o=t.find("#height")[0],i=e.value(),u=o.value(),t.find("#constrain")[0].checked()&&r&&f&&i&&u&&(n.control==e?(u=Math.round(i/r*u),o.value(u)):(i=Math.round(u/f*i),e.value(i))),r=i,f=u}var t,r,f,e;e=h(n.selection.getNode()),r=e.width,f=e.height,t=n.windowManager.open({title:"Insert media",data:e,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){this.fromJSON(i(this.next().find("#embed").value()))},items:[{name:"source1",type:"filepicker",filetype:"image",size:40,autofocus:!0,label:"Source"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:o},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:o},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}]},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(u(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:"},{type:"textbox",flex:1,name:"embed",value:s(),multiline:!0,label:"Source"}]}],onSubmit:function(){n.insertContent(u(this.toJSON()))}})}function s(){var t=n.selection.getNode();if(t.getAttribute("data-mce-object"))return n.selection.getContent()}function u(r){var u="";return!r.source1&&(tinymce.extend(r,i(r.embed)),!r.source1)?"":(r.source1=n.convertURL(r.source1,"source"),r.source2=!1,r.source1mime=o(r.source1),r.source2mime=!1,r.poster=!1,r.flashPlayerUrl=n.convertURL(t+"/moxieplayer.swf","movie"),r.embed?u=f(r.embed,r,!0):(tinymce.each(e,function(n){var u,t,i;if(u=n.regex.exec(r.source1)){for(i=n.url,t=0;u[t];t++)i=i.replace("$"+t,function(){return u[t]});r.source1=i,r.type=n.type,r.width=n.w,r.height=n.h}}),r.width=r.width||300,r.height=r.height||150,tinymce.each(r,function(t,i){r[i]=n.dom.encode(t)}),r.type=="iframe"?u+='<iframe src="'+r.source1+'" width="'+r.width+'" height="'+r.height+'"><\/iframe>':r.source1mime.indexOf("audio")!=-1?n.settings.audio_template_callback?u=n.settings.audio_template_callback(r):u+='<audio controls="controls" src="'+r.source1+'">'+(r.source2?'\n<source src="'+r.source2+'"'+(r.source2mime?' type="'+r.source2mime+'"':"")+" />\n":"")+"<\/audio>":u=n.settings.video_template_callback?n.settings.video_template_callback(r):'<video width="'+r.width+'" height="'+r.height+'"'+(r.poster?' poster="'+r.poster+'"':"")+' controls="controls">\n<source src="'+r.source1+'"'+(r.source1mime?' type="'+r.source1mime+'"':"")+" />\n"+(r.source2?'<source src="'+r.source2+'"'+(r.source2mime?' type="'+r.source2mime+'"':"")+" />\n":"")+"<\/video>"),u)}function i(n){var t={};return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",start:function(n,i){t.source1||n!="param"||(t.source1=i.map.movie),(n=="iframe"||n=="object"||n=="embed"||n=="video"||n=="audio")&&(t=tinymce.extend(i.map,t)),n=="source"&&(t.source1?t.source2||(t.source2=i.map.src):t.source1=i.map.src)}}).parse(n),t.source1=t.source1||t.src||t.data,t.source2=t.source2||"",t.poster=t.poster||"",t}function h(t){return t.getAttribute("data-mce-object")?i(n.serializer.serialize(t,{selection:!0})):{}}function f(n,t,i){function f(n,t){var i,u,r,f;for(i in t)if(r=""+t[i],n.map[i])for(u=n.length;u--;)f=n[u],f.name==i&&(r?(n.map[i]=r,f.value=r):(delete n.map[i],n.splice(u,1)));else r&&(n.push({name:i,value:r}),n.map[i]=r)}var r=new tinymce.html.Writer,u=0;return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",comment:function(n){r.comment(n)},cdata:function(n){r.cdata(n)},text:function(n,t){r.text(n,t)},start:function(n,e,o){switch(n){case"video":case"object":case"img":case"iframe":f(e,{width:t.width,height:t.height})}if(i)switch(n){case"video":f(e,{poster:t.poster,src:""}),t.source2&&f(e,{src:""});break;case"iframe":f(e,{src:t.source1});break;case"source":if(u++,u<=2&&(f(e,{src:t["source"+u],type:t["source"+u+"mime"]}),!t["source"+u]))return}r.start(n,e,o)},end:function(n){var e,o;if(n=="video"&&i)for(e=1;e<=2;e++)t["source"+e]&&(o=[],o.map={},u<e&&(f(o,{src:t["source"+e],type:t["source"+e+"mime"]}),r.start("source",o,!0)));r.end(n)}},new tinymce.html.Schema({})).parse(n),r.getContent()}var e=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];n.on("ResolveName",function(n){var t;(t=n.target.getAttribute("data-mce-object"))&&(n.name=t)});n.on("preInit",function(){var i=n.schema.getSpecialElements(),t;tinymce.each("video audio iframe object".split(" "),function(n){i[n]=new RegExp("<\/"+n+"[^>]*>","gi")}),n.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]"),t=n.schema.getBoolAttrs(),tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(n){t[n]={}}),n.parser.addNodeFilter("iframe,video,audio,object,embed",function(t,i){for(var c=t.length,e,r,f,u,o,s,h;c--;){for(r=t[c],f=new tinymce.html.Node("img",1),f.shortEnded=!0,s=r.attributes,e=s.length;e--;)u=s[e].name,o=s[e].value,u!=="width"&&u!=="height"&&u!=="style"&&((u=="data"||u=="src")&&(o=n.convertURL(o,u)),f.attr("data-mce-p-"+u,o));h=r.firstChild&&r.firstChild.value,h&&(f.attr("data-mce-html",escape(h)),f.firstChild=null),f.attr({width:r.attr("width")||"300",height:r.attr("height")||(i=="audio"?"30":"150"),style:r.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":i,"class":"mce-object mce-object-"+i}),r.replace(f)}}),n.serializer.addAttributeFilter("data-mce-object",function(n,t){for(var h=n.length,i,r,u,f,o,e,s;h--;){for(i=n[h],r=new tinymce.html.Node(i.attr(t),1),i.attr(t)!="audio"&&r.attr({width:i.attr("width"),height:i.attr("height")}),r.attr({style:i.attr("style")}),f=i.attributes,u=f.length;u--;)s=f[u].name,s.indexOf("data-mce-p-")===0&&r.attr(s.substr(11),f[u].value);o=i.attr("data-mce-html"),o&&(e=new tinymce.html.Node("#text",3),e.raw=!0,e.value=unescape(o),r.append(e)),i.replace(r)}})});n.on("ObjectSelected",function(n){n.target.getAttribute("data-mce-object")=="audio"&&n.preventDefault()});n.on("objectResized",function(n){var i=n.target,t;i.getAttribute("data-mce-object")&&(t=i.getAttribute("data-mce-html"),t&&(t=unescape(t),i.setAttribute("data-mce-html",escape(f(t,{width:n.width,height:n.height})))))});n.addButton("media",{tooltip:"Insert/edit video",onclick:r,stateSelector:"img[data-mce-object=video]"}),n.addMenuItem("media",{icon:"media",text:"Insert video",onclick:r,context:"insert",prependToContext:!0})}),function(n,t){"use strict";function u(n,t){for(var u,e=[],r=0;r<n.length;++r){if(u=i[n[r]]||f(n[r]),!u)throw"module definition dependecy not found: "+n[r];e.push(u)}t.apply(null,e)}function r(n,r,f){if(typeof n!="string")throw"invalid module definition, module id must be defined and be a string";if(r===t)throw"invalid module definition, dependencies must be specified";if(f===t)throw"invalid module definition, definition function must be specified";u(r,function(){i[n]=f.apply(null,arguments)})}function f(t){for(var r=n,u=t.split(/[.\/]/),i=0;i<u.length;++i){if(!r[u[i]])return;r=r[u[i]]}return r}function e(r){for(var f,o=0;o<r.length;o++){var e=n,s=r[o],u=s.split(/[.\/]/);for(f=0;f<u.length-1;++f)e[u[f]]===t&&(e[u[f]]={}),e=e[u[f]];e[u[u.length-1]]=i[s]}}var i={};r("tinymce/tableplugin/TableGrid",["tinymce/util/Tools","tinymce/Env"],function(n,t){function r(n,t){return parseInt(n.getAttribute(t)||1,10)}var i=n.each;return function(u,f){function nt(){var n=0;e=[],i(["thead","tbody","tfoot"],function(t){var u=o.select("> "+t+" tr",f);i(u,function(u,f){f+=n,i(o.select("> td, > th",u),function(n,i){var o,u,s,h;if(e[f])while(e[f][i])i++;for(s=r(n,"rowspan"),h=r(n,"colspan"),u=f;u<f+s;u++)for(e[u]||(e[u]=[]),o=i;o<i+h;o++)e[u][o]={part:t,real:u==f&&o==i,elm:n,rowspan:s,colspan:h}})}),n+=u.length})}function w(n,t){return n=n.cloneNode(t),n.removeAttribute("id"),n}function b(n,t){var i;return i=e[t],i?i[n]:void 0}function h(n,t,i){n&&(i=parseInt(i,10),i===1?n.removeAttribute(t,1):n.setAttribute(t,i,1))}function p(n){return n&&(o.hasClass(n.elm,"mce-item-selected")||n==y)}function k(){var n=[];return i(f.rows,function(t){i(t.cells,function(i){if(o.hasClass(i,"mce-item-selected")||i==y.elm)return n.push(t),!1})}),n}function it(){var n=o.createRng();n.setStartAfter(f),n.setEndAfter(f),l.setRng(n),o.remove(f)}function a(r){var f,e={};return u.settings.table_clone_elements!==!1&&(e=n.makeMap((u.settings.table_clone_elements||"strong em b i span font h1 h2 h3 h4 h5 h6 p div").toUpperCase(),/[ ,]/)),n.walk(r,function(n){var u;if(n.nodeType==3)return i(o.getParents(n.parentNode,null,r).reverse(),function(n){e[n.nodeName]&&(n=w(n,!1),f?u&&u.appendChild(n):f=u=n,u=n)}),u&&(u.innerHTML=t.ie?"&nbsp;":'<br data-mce-bogus="1" />'),!1},"childNodes"),r=w(r,!1),h(r,"rowSpan",1),h(r,"colSpan",1),f?r.appendChild(f):t.ie||(r.innerHTML='<br data-mce-bogus="1" />'),r}function d(){var t=o.createRng(),n;if(i(o.select("tr",f),function(n){n.cells.length===0&&o.remove(n)}),o.select("tr",f).length===0){t.setStartBefore(f),t.setEndBefore(f),l.setRng(t),o.remove(f);return}i(o.select("thead,tbody,tfoot",f),function(n){n.rows.length===0&&o.remove(n)}),nt(),n=e[Math.min(e.length-1,s.y)],n&&(l.select(n[Math.min(n.length-1,s.x)].elm,!0),l.collapse(!0))}function g(n,t,i,r){for(var s,f,c,u=e[t][n].elm.parentNode,h=1;h<=i;h++)if(u=o.getNext(u,"tr"),u){for(s=n;s>=0;s--)if(c=e[t+h][s].elm,c.parentNode==u){for(f=1;f<=r;f++)o.insertAfter(a(c),c);break}if(s==-1)for(f=1;f<=r;f++)u.insertBefore(a(u.cells[0]),u.cells[0])}}function tt(){i(e,function(n,t){i(n,function(n,i){var u,f,e;if(p(n)&&(n=n.elm,u=r(n,"colspan"),f=r(n,"rowspan"),u>1||f>1)){for(h(n,"rowSpan",1),h(n,"colSpan",1),e=0;e<u-1;e++)o.insertAfter(a(n),n);g(i,t,f-1,u)}})})}function rt(t,r,u){var rt,l,a,k,g,it,y,f,ut,w,ft;if(t?(rt=v(t),l=rt.x,a=rt.y,k=l+(r-1),g=a+(u-1)):(s=c=null,i(e,function(n,t){i(n,function(n,i){p(n)&&(s||(s={x:i,y:t}),c={x:i,y:t})})}),l=s.x,a=s.y,k=c.x,g=c.y),f=b(l,a),ut=b(k,g),f&&ut&&f.part==ut.part){for(tt(),nt(),f=b(l,a).elm,h(f,"colSpan",k-l+1),h(f,"rowSpan",g-a+1),y=a;y<=g;y++)for(it=l;it<=k;it++)e[y]&&e[y][it]&&(t=e[y][it].elm,t!=f&&(w=n.grep(t.childNodes),i(w,function(n){f.appendChild(n)}),w.length&&(w=n.grep(f.childNodes),ft=0,i(w,function(n){n.nodeName=="BR"&&o.getAttrib(n,"data-mce-bogus")&&ft++<w.length-1&&f.removeChild(n)})),o.remove(t)));d()}}function ut(n){var t,u,b,f,c,l,v,y,s;for(i(e,function(r,u){return i(r,function(i){if(p(i)&&(i=i.elm,c=i.parentNode,l=w(c,!1),t=u,n))return!1}),n?!t:void 0}),f=0;f<e[0].length;f++)if(e[t][f]&&(u=e[t][f].elm,u!=b)){if(n){if(t>0&&e[t-1][f]&&(y=e[t-1][f].elm,s=r(y,"rowSpan"),s>1)){h(y,"rowSpan",s+1);continue}}else if(s=r(u,"rowspan"),s>1){h(u,"rowSpan",s+1);continue}v=a(u),h(v,"colSpan",u.colSpan),l.appendChild(v),b=u}l.hasChildNodes()&&(n?c.parentNode.insertBefore(l,c):o.insertAfter(l,c))}function ft(n){var t,u;i(e,function(r){return i(r,function(i,r){if(p(i)&&(t=r,n))return!1}),n?!t:void 0}),i(e,function(i,f){var e,c,s;i[t]&&(e=i[t].elm,e!=u&&(s=r(e,"colspan"),c=r(e,"rowspan"),s==1?n?(e.parentNode.insertBefore(a(e),e),g(t,f,c-1,s)):(o.insertAfter(a(e),e),g(t,f,c-1,s)):h(e,"colSpan",e.colSpan+1),u=e))})}function et(){var t=[];i(e,function(u){i(u,function(u,f){p(u)&&n.inArray(t,f)===-1&&(i(e,function(n){var t=n[f].elm,i;i=r(t,"colSpan"),i>1?h(t,"colSpan",i-1):o.remove(t)}),t.push(f))})}),d()}function ot(){function t(n){var f,t,u;f=o.getNext(n,"tr"),i(n.cells,function(n){var i=r(n,"rowSpan");i>1&&(h(n,"rowSpan",i-1),t=v(n),g(t.x,t.y,1,1))}),t=v(n.cells[0]),i(e[t.y],function(n){var t;n=n.elm,n!=u&&(t=r(n,"rowSpan"),t<=1?o.remove(n):h(n,"rowSpan",t-1),u=n)})}var n;n=k(),i(n.reverse(),function(n){t(n)}),d()}function st(){var n=k();return o.remove(n),d(),n}function ht(){var n=k();return i(n,function(t,i){n[i]=w(t,!0)}),n}function ct(n,t){var f=k(),r=f[t?0:f.length-1],u=r.cells.length;n&&(i(e,function(n){var t;return u=0,i(n,function(n){n.real&&(u+=n.colspan),n.elm.parentNode==r&&(t=1)}),t?!1:void 0}),t||n.reverse(),i(n,function(n){for(var f=n.cells.length,e,i=0;i<f;i++)e=n.cells[i],h(e,"colSpan",1),h(e,"rowSpan",1);for(i=f;i<u;i++)n.appendChild(a(n.cells[f-1]));for(i=u;i<f;i++)o.remove(n.cells[i]);t?r.parentNode.insertBefore(n,r):o.insertAfter(n,r)}),o.removeClass(o.select("td.mce-item-selected,th.mce-item-selected"),"mce-item-selected"))}function v(n){var t;return i(e,function(r,u){return i(r,function(i,r){if(i.elm==n)return t={x:r,y:u},!1}),!t}),t}function lt(n){s=v(n)}function at(){var n,t;return n=t=0,i(e,function(r,u){i(r,function(i,r){var f,o;p(i)&&(i=e[u][r],r>n&&(n=r),u>t&&(t=u),i.real&&(f=i.colspan-1,o=i.rowspan-1,f&&r+f>n&&(n=r+f),o&&u+o>t&&(t=u+o)))})}),{x:n,y:t}}function vt(n){var r,u,y,p,f,h,l,a,t,i;if(c=v(n),s&&c){for(r=Math.min(s.x,c.x),u=Math.min(s.y,c.y),y=Math.max(s.x,c.x),p=Math.max(s.y,c.y),f=y,h=p,i=u;i<=h;i++)n=e[i][r],n.real||r-(n.colspan-1)<r&&(r-=n.colspan-1);for(t=r;t<=f;t++)n=e[u][t],n.real||u-(n.rowspan-1)<u&&(u-=n.rowspan-1);for(i=u;i<=p;i++)for(t=r;t<=y;t++)n=e[i][t],n.real&&(l=n.colspan-1,a=n.rowspan-1,l&&t+l>f&&(f=t+l),a&&i+a>h&&(h=i+a));for(o.removeClass(o.select("td.mce-item-selected,th.mce-item-selected"),"mce-item-selected"),i=u;i<=h;i++)for(t=r;t<=f;t++)e[i][t]&&o.addClass(e[i][t].elm,"mce-item-selected")}}var e,s,c,y,l=u.selection,o=l.dom;f=f||o.getParent(l.getStart(),"table"),nt(),y=o.getParent(l.getStart(),"th,td"),y&&(s=v(y),c=at(),y=b(s.x,s.y)),n.extend(this,{deleteTable:it,split:tt,merge:rt,insertRow:ut,insertCol:ft,deleteCols:et,deleteRows:ot,cutRows:st,copyRows:ht,pasteRows:ct,getPos:v,setStartCell:lt,setEndCell:vt})}}),r("tinymce/tableplugin/Quirks",["tinymce/util/VK","tinymce/Env","tinymce/util/Tools"],function(n,t,i){function r(n,t){return parseInt(n.getAttribute(t)||1,10)}var u=i.each;return function(i){function o(){function t(t){function h(n,r){var e=n?"previousSibling":"nextSibling",u=i.dom.getParent(r,"tr"),o=u[e],f;if(o)return c(i,r,o,n),t.preventDefault(),!0;var s=i.dom.getParent(u,"table"),h=u.parentNode,a=h.nodeName.toLowerCase();return(a==="tbody"||a===(n?"tfoot":"thead"))&&(f=l(n,s,h,"tbody"),f!==null)?v(n,f,r):y(n,u,e,s)}function l(n,t,r,u){var f=i.dom.select(">"+u,t),e=f.indexOf(r),o;return n&&e===0||!n&&e===f.length-1?a(n,t):e===-1?(o=r.tagName.toLowerCase()==="thead"?0:f.length-1,f[o]):f[e+(n?-1:1)]}function a(n,t){var u=n?"thead":"tfoot",r=i.dom.select(">"+u,t);return r.length!==0?r[0]:null}function v(n,r,u){var f=e(r,n);return f&&c(i,u,f,n),t.preventDefault(),!0}function y(n,r,u,f){var c=f[u],s,l;return c?(o(c),!0):(s=i.dom.getParent(f,"td,th"),s?h(n,s,t):(l=e(r,!n),o(l),t.preventDefault(),!1))}function e(n,t){var r=n&&n[t?"lastChild":"firstChild"];return r&&r.nodeName==="BR"?i.dom.getParent(r,"td,th"):r}function o(n){i.selection.setCursorLocation(n,0)}function p(){return f==n.UP||f==n.DOWN}function w(n){var t=n.selection.getNode(),i=n.dom.getParent(t,"tr");return i!==null}function b(n){for(var i=0,t=n;t.previousSibling;)t=t.previousSibling,i=i+r(t,"colspan");return i}function k(n,t){var i=0,f=0;return u(n.children,function(n,u){return i=i+r(n,"colspan"),f=u,i>t?!1:void 0}),f}function c(n,t,r,u){var s=b(i.dom.getParent(t,"td,th")),h=k(r,s),f=r.childNodes[h],c=e(f,u);o(c||f)}function d(n){var u=i.selection.getNode(),t=i.dom.getParent(u,"td,th"),r=i.dom.getParent(n,"td,th");return t&&t!==r&&g(t,r)}function g(n,t){return i.dom.getParent(n,"TABLE")===i.dom.getParent(t,"TABLE")}var f=t.keyCode,s;p()&&w(i)&&(s=i.selection.getNode(),setTimeout(function(){d(s)&&h(!t.shiftKey&&f===n.UP,s,t)},0))}i.on("KeyDown",function(n){t(n)})}function f(){function n(n,t){var u=t.ownerDocument,i=u.createRange(),r;return i.setStartBefore(t),i.setEnd(n.endContainer,n.endOffset),r=u.createElement("body"),r.appendChild(i.cloneContents()),r.innerHTML.replace(/<(br|img|object|embed|input|textarea)[^>]*>/gi,"-").replace(/<[^>]+>/g,"").length===0}i.on("KeyDown",function(t){var r,u,f=i.dom;(t.keyCode==37||t.keyCode==38)&&(r=i.selection.getRng(),u=f.getParent(r.startContainer,"table"),u&&i.getBody().firstChild==u&&n(r,u)&&(r=f.createRng(),r.setStartBefore(u),r.setEndBefore(u),i.selection.setRng(r),t.preventDefault()))})}function e(){i.on("KeyDown SetContent VisualAid",function(){for(var n=i.getBody().lastChild;n;n=n.previousSibling)if(n.nodeType==3){if(n.nodeValue.length>0)break}else if(n.nodeType==1&&!n.getAttribute("data-mce-bogus"))break;n&&n.nodeName=="TABLE"&&(i.settings.forced_root_block?i.dom.add(i.getBody(),i.settings.forced_root_block,i.settings.forced_root_block_attrs,t.ie&&t.ie<11?"&nbsp;":'<br data-mce-bogus="1" />'):i.dom.add(i.getBody(),"br",{"data-mce-bogus":"1"}))});i.on("PreProcess",function(n){var t=n.node.lastChild;t&&(t.nodeName=="BR"||t.childNodes.length==1&&(t.firstChild.nodeName=="BR"||t.firstChild.nodeValue=="\u00a0"))&&t.previousSibling&&t.previousSibling.nodeName=="TABLE"&&i.dom.remove(t)})}function s(){function t(n,t,i,r){var u=n.dom.getParent(t.startContainer,"TABLE"),f,e,o;return u&&(f=u.parentNode),e=t.startContainer.nodeType==3&&t.startOffset===0&&t.endOffset===0&&r&&(i.nodeName=="TR"||i==f),o=(i.nodeName=="TD"||i.nodeName=="TH")&&!r,e||o}function n(){var r=i.selection.getRng(),f=i.selection.getNode(),u=i.dom.getParent(r.startContainer,"TD,TH"),n;if(t(i,r,f,u)){for(u||(u=f),n=u.lastChild;n.lastChild;)n=n.lastChild;r.setEnd(n,n.nodeValue.length),i.selection.setRng(r)}}i.on("KeyDown",function(){n()});i.on("MouseDown",function(t){t.button!=2&&n()})}function h(){i.on("keydown",function(t){var r,u,f;if((t.keyCode==n.DELETE||t.keyCode==n.BACKSPACE)&&!t.isDefaultPrevented()&&(r=i.dom.getParent(i.selection.getStart(),"table"),r)){for(u=i.dom.select("td,th",r),f=u.length;f--;)if(!i.dom.hasClass(u[f],"mce-item-selected"))return;t.preventDefault(),i.execCommand("mceTableDelete")}})}h(),t.webkit&&(o(),s()),t.gecko&&(f(),e()),t.ie>10&&(f(),e())}}),r("tinymce/tableplugin/CellSelection",["tinymce/tableplugin/TableGrid","tinymce/dom/TreeWalker","tinymce/util/Tools"],function(n,t,i){return function(r){function h(){r.getBody().style.webkitUserSelect="",s&&(r.dom.removeClass(r.dom.select("td.mce-item-selected,th.mce-item-selected"),"mce-item-selected"),s=!1)}function c(t){var h,c,i=t.target;if(e&&(f||i!=e)&&(i.nodeName=="TD"||i.nodeName=="TH")){c=u.getParent(i,"table"),c==o&&(f||(f=new n(r,c),f.setStartCell(e),r.getBody().style.webkitUserSelect="none"),f.setEndCell(i),s=!0),h=r.selection.getSel();try{h.removeAllRanges?h.removeAllRanges():h.empty()}catch(l){}t.preventDefault()}}var u=r.dom,f,e,o,s=!0;r.on("MouseDown",function(n){n.button!=2&&(h(),e=u.getParent(n.target,"td,th"),o=u.getParent(e,"table"))});u.bind(r.getDoc(),"mouseover",c);r.on("remove",function(){u.unbind(r.getDoc(),"mouseover",c)});r.on("MouseUp",function(){function a(n,r){var u=new t(n,n);do{if(n.nodeType==3&&i.trim(n.nodeValue).length!==0){r?s.setStart(n,0):s.setEnd(n,n.nodeValue.length);return}if(n.nodeName=="BR"){r?s.setStartBefore(n):s.setEndBefore(n);return}}while(n=r?u.next():u.prev())}var s,v=r.selection,h,c,n,l,y;if(e){if(f&&(r.getBody().style.webkitUserSelect=""),h=u.select("td.mce-item-selected,th.mce-item-selected"),h.length>0){s=u.createRng(),n=h[0],y=h[h.length-1],s.setStartBefore(n),s.setEndAfter(n),a(n,1),c=new t(n,u.getParent(h[0],"table"));do if(n.nodeName=="TD"||n.nodeName=="TH"){if(!u.hasClass(n,"mce-item-selected"))break;l=n}while(n=c.next());a(l),v.setRng(s)}r.nodeChanged(),e=f=o=null}});r.on("KeyUp",function(){h()});return{clear:h}}}),r("tinymce/tableplugin/Plugin",["tinymce/tableplugin/TableGrid","tinymce/tableplugin/Quirks","tinymce/tableplugin/CellSelection","tinymce/util/Tools","tinymce/dom/TreeWalker","tinymce/Env","tinymce/PluginManager"],function(n,t,i,r,u,f,e){function s(r){function s(n){return n?n.replace(/px$/,""):""}function h(n){return/^[0-9]+$/.test(n)&&(n+="px"),n}function v(n){o("left center right".split(" "),function(t){r.formatter.remove("align"+t,{},n)})}function y(){var t=r.dom,n,i;n=t.getParent(r.selection.getStart(),"table"),i={width:s(t.getStyle(n,"width")||t.getAttrib(n,"width")),height:s(t.getStyle(n,"height")||t.getAttrib(n,"height")),cellspacing:t.getAttrib(n,"cellspacing"),cellpadding:t.getAttrib(n,"cellpadding"),border:t.getAttrib(n,"border"),caption:!!t.select("caption",n)[0]},o("left center right".split(" "),function(t){r.formatter.matchNode(n,"align"+t)&&(i.align=t)}),r.windowManager.open({title:"Table properties",items:{type:"form",layout:"grid",columns:2,data:i,defaults:{type:"textbox",maxWidth:50},items:[{label:"Width",name:"width"},{label:"Height",name:"height"},{label:"Cell spacing",name:"cellspacing"},{label:"Cell padding",name:"cellpadding"},{label:"Border",name:"border"},{label:"Caption",name:"caption",type:"checkbox"},{label:"Alignment",minWidth:90,name:"align",type:"listbox",text:"None",maxWidth:null,values:[{text:"None",value:""},{text:"Left",value:"left"},{text:"Center",value:"center"},{text:"Right",value:"right"}]}]},onsubmit:function(){var i=this.toJSON(),u;r.undoManager.transact(function(){r.dom.setAttribs(n,{cellspacing:i.cellspacing,cellpadding:i.cellpadding,border:i.border}),r.dom.setStyles(n,{width:h(i.width),height:h(i.height)}),u=t.select("caption",n)[0],u&&!i.caption&&t.remove(u),!u&&i.caption&&(u=t.create("caption"),u.innerHTML=f.ie?"\u00a0":'<br data-mce-bogus="1"/>',n.insertBefore(u,n.firstChild)),v(n),i.align&&r.formatter.apply("align"+i.align,{},n),r.focus(),r.addVisual()})}})}function k(n,t){r.windowManager.open({title:"Merge cells",body:[{label:"Cols",name:"cols",type:"textbox",size:10},{label:"Rows",name:"rows",type:"textbox",size:10}],onsubmit:function(){var i=this.toJSON();r.undoManager.transact(function(){n.merge(t,i.cols,i.rows)})}})}function d(){var t=r.dom,n,u,i=[];i=r.dom.select("td.mce-item-selected,th.mce-item-selected"),n=r.dom.getParent(r.selection.getStart(),"td,th"),!i.length&&n&&i.push(n),n=n||i[0],u={width:s(t.getStyle(n,"width")||t.getAttrib(n,"width")),height:s(t.getStyle(n,"height")||t.getAttrib(n,"height")),scope:t.getAttrib(n,"scope")},u.type=n.nodeName.toLowerCase(),o("left center right".split(" "),function(t){r.formatter.matchNode(n,"align"+t)&&(u.align=t)}),r.windowManager.open({title:"Cell properties",items:{type:"form",data:u,layout:"grid",columns:2,defaults:{type:"textbox",maxWidth:50},items:[{label:"Width",name:"width"},{label:"Height",name:"height"},{label:"Cell type",name:"type",type:"listbox",text:"None",minWidth:90,maxWidth:null,menu:[{text:"Cell",value:"td"},{text:"Header cell",value:"th"}]},{label:"Scope",name:"scope",type:"listbox",text:"None",minWidth:90,maxWidth:null,menu:[{text:"None",value:""},{text:"Row",value:"row"},{text:"Column",value:"col"},{text:"Row group",value:"rowgroup"},{text:"Column group",value:"colgroup"}]},{label:"Alignment",name:"align",type:"listbox",text:"None",minWidth:90,maxWidth:null,values:[{text:"None",value:""},{text:"Left",value:"left"},{text:"Center",value:"center"},{text:"Right",value:"right"}]}]},onsubmit:function(){var n=this.toJSON();r.undoManager.transact(function(){o(i,function(i){r.dom.setAttrib(i,"scope",n.scope),r.dom.setStyles(i,{width:h(n.width),height:h(n.height)}),n.type&&i.nodeName.toLowerCase()!=n.type&&(i=t.rename(i,n.type)),v(i),n.align&&r.formatter.apply("align"+n.align,{},i)}),r.focus()})}})}function g(){var n=r.dom,f,e,t,i,u=[];f=r.dom.getParent(r.selection.getStart(),"table"),e=r.dom.getParent(r.selection.getStart(),"td,th"),o(f.rows,function(t){o(t.cells,function(i){if(n.hasClass(i,"mce-item-selected")||i==e)return u.push(t),!1})}),t=u[0],i={height:s(n.getStyle(t,"height")||n.getAttrib(t,"height")),scope:n.getAttrib(t,"scope")},i.type=t.parentNode.nodeName.toLowerCase(),o("left center right".split(" "),function(n){r.formatter.matchNode(t,"align"+n)&&(i.align=n)}),r.windowManager.open({title:"Row properties",items:{type:"form",data:i,columns:2,defaults:{type:"textbox"},items:[{type:"listbox",name:"type",label:"Row type",text:"None",maxWidth:null,menu:[{text:"Header",value:"thead"},{text:"Body",value:"tbody"},{text:"Footer",value:"tfoot"}]},{type:"listbox",name:"align",label:"Alignment",text:"None",maxWidth:null,menu:[{text:"None",value:""},{text:"Left",value:"left"},{text:"Center",value:"center"},{text:"Right",value:"right"}]},{label:"Height",name:"height"}]},onsubmit:function(){var f=this.toJSON(),t,e,i;r.undoManager.transact(function(){var s=f.type;o(u,function(u){r.dom.setAttrib(u,"scope",f.scope),r.dom.setStyles(u,{height:h(f.height)}),s!=u.parentNode.nodeName.toLowerCase()&&(t=n.getParent(u,"table"),e=u.parentNode,i=n.select(s,t)[0],i||(i=n.create(s),t.firstChild?t.insertBefore(i,t.firstChild):t.appendChild(i)),i.appendChild(u),e.hasChildNodes()||n.remove(e)),v(u),f.align&&r.formatter.apply("align"+f.align,{},u)}),r.focus()})}})}function u(n){return function(){r.execCommand(n)}}function nt(n,t){for(var e,i='<table border="1" cellspacing="0" cellpadding="6px"><tbody>',u=0;u<t;u++){for(i+="<tr>",e=0;e<n;e++)i+="<td>"+(f.ie?" ":"<br>")+"<\/td>";i+="<\/tr>"}i+="<\/tbody><\/table>",r.insertContent(i)}function p(n,t){function i(){n.disabled(!r.dom.getParent(r.selection.getStart(),t)),r.selection.selectorChanged(t,function(t){n.disabled(!t)})}if(r.initialized)i();else r.on("init",i)}function w(){p(this,"table")}function e(){p(this,"td,th")}function tt(){for(var n="",i,n='<table role="presentation" class="mce-grid mce-grid-border">',t=0;t<10;t++){for(n+="<tr>",i=0;i<10;i++)n+='<td><a href="#" data-mce-index="'+i+","+t+'"><\/a><\/td>';n+="<\/tr>"}return n+="<\/table>",n+'<div class="mce-text-center">0 x 0<\/div>'}var b,c,a=this,l;if(r.addMenuItem("inserttable",{text:"Insert table",icon:"table",context:"table",onhide:function(){r.dom.removeClass(this.menu.items()[0].getEl().getElementsByTagName("a"),"mce-active")},menu:[{type:"container",html:tt(),onmousemove:function(n){var i,u,e=n.target;if(e.nodeName=="A"){var f=r.dom.getParent(e,"table"),t=e.getAttribute("data-mce-index"),o=n.control.parent().rel;if(t!=this.lastPos){if(t=t.split(","),t[0]=parseInt(t[0],10),t[1]=parseInt(t[1],10),n.control.isRtl()||o=="tl-tr"){for(u=9;u>=0;u--)for(i=0;i<10;i++)r.dom.toggleClass(f.rows[u].childNodes[i].firstChild,"mce-active",i>=t[0]&&u<=t[1]);t[0]=9-t[0],f.nextSibling.innerHTML=t[0]+" x "+(t[1]+1)}else{for(u=0;u<10;u++)for(i=0;i<10;i++)r.dom.toggleClass(f.rows[u].childNodes[i].firstChild,"mce-active",i<=t[0]&&u<=t[1]);f.nextSibling.innerHTML=t[0]+1+" x "+(t[1]+1)}this.lastPos=t}}},onclick:function(n){n.target.nodeName=="A"&&this.lastPos&&(n.preventDefault(),nt(this.lastPos[0]+1,this.lastPos[1]+1),this.parent().cancel())}}]}),r.addMenuItem("tableprops",{text:"Table properties",context:"table",onPostRender:w,onclick:y}),r.addMenuItem("deletetable",{text:"Delete table",context:"table",onPostRender:w,cmd:"mceTableDelete"}),r.addMenuItem("cell",{separator:"before",text:"Cell",context:"table",menu:[{text:"Cell properties",onclick:u("mceTableCellProps"),onPostRender:e},{text:"Merge cells",onclick:u("mceTableMergeCells"),onPostRender:e},{text:"Split cell",onclick:u("mceTableSplitCells"),onPostRender:e}]}),r.addMenuItem("row",{text:"Row",context:"table",menu:[{text:"Insert row before",onclick:u("mceTableInsertRowBefore"),onPostRender:e},{text:"Insert row after",onclick:u("mceTableInsertRowAfter"),onPostRender:e},{text:"Delete row",onclick:u("mceTableDeleteRow"),onPostRender:e},{text:"Row properties",onclick:u("mceTableRowProps"),onPostRender:e},{text:"-"},{text:"Cut row",onclick:u("mceTableCutRow"),onPostRender:e},{text:"Copy row",onclick:u("mceTableCopyRow"),onPostRender:e},{text:"Paste row before",onclick:u("mceTablePasteRowBefore"),onPostRender:e},{text:"Paste row after",onclick:u("mceTablePasteRowAfter"),onPostRender:e}]}),r.addMenuItem("column",{text:"Column",context:"table",menu:[{text:"Insert column before",onclick:u("mceTableInsertColBefore"),onPostRender:e},{text:"Insert column after",onclick:u("mceTableInsertColAfter"),onPostRender:e},{text:"Delete column",onclick:u("mceTableDeleteCol"),onPostRender:e}]}),l=[],o("inserttable tableprops deletetable | cell row column".split(" "),function(n){n=="|"?l.push({text:"-"}):l.push(r.menuItems[n])}),r.addButton("table",{type:"menubutton",title:"Table",menu:l}),!f.isIE)r.on("click",function(n){n=n.target,n.nodeName==="TABLE"&&(r.selection.select(n),r.nodeChanged())});a.quirks=new t(r);r.on("Init",function(){b=r.windowManager,a.cellSelection=new i(r)});o({mceTableSplitCells:function(n){n.split()},mceTableMergeCells:function(n){var i,u,t;t=r.dom.getParent(r.selection.getStart(),"th,td"),t&&(i=t.rowSpan,u=t.colSpan),r.dom.select("td.mce-item-selected,th.mce-item-selected").length?n.merge():k(n,t)},mceTableInsertRowBefore:function(n){n.insertRow(!0)},mceTableInsertRowAfter:function(n){n.insertRow()},mceTableInsertColBefore:function(n){n.insertCol(!0)},mceTableInsertColAfter:function(n){n.insertCol()},mceTableDeleteCol:function(n){n.deleteCols()},mceTableDeleteRow:function(n){n.deleteRows()},mceTableCutRow:function(n){c=n.cutRows()},mceTableCopyRow:function(n){c=n.copyRows()},mceTablePasteRowBefore:function(n){n.pasteRows(c,!0)},mceTablePasteRowAfter:function(n){n.pasteRows(c)},mceTableDelete:function(n){n.deleteTable()}},function(t,i){r.addCommand(i,function(){var i=new n(r);i&&(t(i),r.execCommand("mceRepaint"),a.cellSelection.clear())})}),o({mceInsertTable:function(){y()},mceTableRowProps:g,mceTableCellProps:d},function(n,t){r.addCommand(t,function(t,i){n(i)})})}var o=r.each;e.add("table",s)}),e(["tinymce/tableplugin/TableGrid","tinymce/tableplugin/Quirks","tinymce/tableplugin/CellSelection","tinymce/tableplugin/Plugin"])}(this),function(n,t){"use strict";function u(n,t){for(var u,e=[],i=0;i<n.length;++i){if(u=r[n[i]]||f(n[i]),!u)throw"module definition dependecy not found: "+n[i];e.push(u)}t.apply(null,e)}function i(n,i,f){if(typeof n!="string")throw"invalid module definition, module id must be defined and be a string";if(i===t)throw"invalid module definition, dependencies must be specified";if(f===t)throw"invalid module definition, definition function must be specified";u(i,function(){r[n]=f.apply(null,arguments)})}function f(t){for(var r=n,u=t.split(/[.\/]/),i=0;i<u.length;++i){if(!r[u[i]])return;r=r[u[i]]}return r}function e(i){for(var f,o=0;o<i.length;o++){var e=n,s=i[o],u=s.split(/[.\/]/);for(f=0;f<u.length-1;++f)e[u[f]]===t&&(e[u[f]]={}),e=e[u[f]];e[u[u.length-1]]=r[s]}}var r={};i("tinymce/pasteplugin/Utils",["tinymce/util/Tools","tinymce/html/DomParser","tinymce/html/Schema"],function(n,t,i){function r(t,i){return n.each(i,function(n){t=n.constructor==RegExp?t.replace(n,""):t.replace(n[0],n[1])}),t}function u(r){function e(n){var t=n.name,i=n;if(t==="br"){u+="\n";return}if(s[t]&&(u+=" "),h[t]){u+=" ";return}if(n.type==3&&(u+=n.value),!n.shortEnded&&(n=n.firstChild))do e(n);while(n=n.next);c[t]&&i.next&&(u+="\n",t=="p"&&(u+="\n"))}var f=new i,o=new t({},f),u="",s=f.getShortEndedElements(),h=n.makeMap("script noscript style textarea video audio iframe object"," "),c=f.getBlockElements();return e(o.parse(r)),u}return{filter:r,innerText:u}}),i("tinymce/pasteplugin/Clipboard",["tinymce/Env","tinymce/util/VK","tinymce/pasteplugin/Utils"],function(n,t,i){return function(r){function s(n){var t,u=r.dom,i;t=r.fire("BeforePastePreProcess",{content:n}),t=r.fire("PastePreProcess",t),n=t.content,t.isDefaultPrevented()||(r.hasEventListeners("PastePostProcess")&&!t.isDefaultPrevented()&&(i=u.add(r.getBody(),"div",{style:"display:none"},n),t=r.fire("PastePostProcess",{node:i}),u.remove(i),n=t.node.innerHTML),t.isDefaultPrevented()||r.insertContent(n))}function c(n){n=r.dom.encode(n).replace(/\r\n/g,"\n");var f=r.dom.getParent(r.selection.getStart(),r.dom.isBlock),u=r.settings.forced_root_block,t;u&&(t=r.dom.createHTML(u,r.settings.forced_root_block_attrs),t=t.substr(0,t.length-3)+">"),f&&/^(PRE|DIV)$/.test(f.nodeName)||!u?n=i.filter(n,[[/\n/g,"<br>"]]):(n=i.filter(n,[[/\n\n/g,"<\/p>"+t],[/^(.*<\/p>)(<p>)$/,t+"$1"],[/\n/g,"<br />"]]),n.indexOf("<p>")!=-1&&(n=t+n)),s(n)}function v(){var t=r.dom,s=r.getBody(),l=r.dom.getViewPort(r.getWin()),h=l.y,c=20,i,o;f=r.selection.getRng(),r.inline&&(i=r.selection.getScrollContainer(),i&&(h=i.scrollTop)),f.getClientRects&&(o=f.getClientRects(),o.length&&(c=h+(o[0].top-t.getPos(s).y))),u=t.add(r.getBody(),"div",{id:"mcepastebin",contentEditable:!0,"data-mce-bogus":"1",style:"position: absolute; top: "+c+"px;width: 10px; height: 10px; overflow: hidden; opacity: 0"},e),(n.ie||n.gecko)&&t.setStyle(u,"left",t.getStyle(s,"direction",!0)=="rtl"?65535:-65535),t.bind(u,"beforedeactivate focusin focusout",function(n){n.stopPropagation()}),u.focus(),r.selection.select(u,!0)}function l(){if(u){for(var n;n=r.dom.get("mcepastebin");)r.dom.remove(n),r.dom.unbind(n);f&&r.selection.setRng(f)}o=!1,u=f=null}function y(){for(var n=e,u,t=r.dom.select("div[id=mcepastebin]"),i=t.length;i--;)u=t[i].innerHTML,n==e&&(n=""),u.length>n.length&&(n=u);return n}function p(n){var i={},t,r;if(n&&n.types)for(i["text/plain"]=n.getData("Text"),t=0;t<n.types.length;t++)r=n.types[t],i[r]=n.getData(r);return i}function w(n){return p(n.clipboardData||r.getDoc().dataTransfer)}function b(n){var t=r.getDoc(),i,u;return t.caretPositionFromPoint?(u=t.caretPositionFromPoint(n.pageX,n.pageY),i=t.createRange(),i.setStart(u.offsetNode,u.offset),i.collapse(!0)):t.caretRangeFromPoint&&(i=t.caretRangeFromPoint(n.pageX,n.pageY)),i}function k(){r.on("keydown",function(i){if(!i.isDefaultPrevented()&&(t.metaKeyPressed(i)&&i.keyCode==86||i.shiftKey&&i.keyCode==45)){if(o=i.shiftKey&&i.keyCode==86,i.stopImmediatePropagation(),a=(new Date).getTime(),n.ie&&o){i.preventDefault(),r.fire("paste",{ieFake:!0});return}l();var u=r.selection.getNode();u&&u.nodeName=="PRE"&&(o=!0),v()}});r.on("paste",function(t){var f=w(t),p=(new Date).getTime()-a<1e3,b=h.pasteFormat=="text"||o;if(t.isDefaultPrevented()){l();return}p||t.preventDefault(),n.ie&&(!p||t.ieFake)&&(v(),r.dom.bind(u,"paste",function(n){n.stopPropagation()}),r.getDoc().execCommand("Paste",!1,null),f["text/html"]=y()),setTimeout(function(){var n=y();if(u&&u.firstChild&&u.firstChild.id==="mcepastebin"&&(b=!0),l(),(n==e||!p)&&(n=f["text/html"]||f["text/plain"]||e,n==e)){p||r.windowManager.alert("Please use Ctrl+V/Cmd+V keyboard shortcuts to paste contents.");return}b?c(f["text/plain"]||i.innerText(n)):s(n)},0)});r.on("dragstart",function(n){if(n.dataTransfer.types)try{n.dataTransfer.setData("mce-internal",r.selection.getContent())}catch(t){}});r.on("drop",function(n){var u=b(n),t,i;u&&!n.isDefaultPrevented()&&(t=p(n.dataTransfer),i=t["mce-internal"]||t["text/html"]||t["text/plain"],i&&(n.preventDefault(),r.undoManager.transact(function(){t["mce-internal"]&&r.execCommand("Delete"),r.selection.setRng(u),t["text/html"]?s(i):c(i)})))})}var h=this,u,f,a=0,e="%MCEPASTEBIN%",o;h.pasteHtml=s,h.pasteText=c;r.on("preInit",function(){k(),r.parser.addNodeFilter("img",function(t){var i,u;if(!r.settings.paste_data_images)for(i=t.length;i--;)u=t[i].attributes.map.src,u&&u.indexOf("data:image")===0&&(t[i].attr("data-mce-object")||u===n.transparentSrc||t[i].remove())})});r.on("PreProcess",function(){r.dom.remove(r.dom.get("mcepastebin"))})}}),i("tinymce/pasteplugin/WordFilter",["tinymce/util/Tools","tinymce/html/DomParser","tinymce/html/Schema","tinymce/html/Serializer","tinymce/html/Node","tinymce/pasteplugin/Utils"],function(n,t,i,r,u,f){function e(n){return/<font face="Times New Roman"|class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i.test(n)}function o(o){var s=o.settings;o.on("BeforePastePreProcess",function(h){function b(n){function c(n,i,r,o){var h=n._listLevel||e,s;h!=e&&(h<e?t&&(t=t.parent.parent):(f=t,t=null)),t&&t.name==r?t.append(n):(f=f||t,t=new u(r,1),o>1&&t.attr("start",""+o),n.wrap(t)),n.name="li",i.value="",s=i.next,s&&s.type==3&&(s.value=s.value.replace(/^\u00a0+/,"")),h>e&&f&&f.lastChild.append(t),e=h}for(var t,f,e=1,l=n.getAll("p"),r,i,s,h,o=0;o<l.length;o++)if(n=l[o],n.name=="p"&&n.firstChild){for(r="",i=n.firstChild;i;){if(r=i.value,r)break;i=i.firstChild}if(/^\s*[\u2022\u00b7\u00a7\u00d8\u25CF]\s*$/.test(r)){c(n,i,"ul");continue}if(/^\s*\w+\.$/.test(r)){s=/([0-9])\./.exec(r),h=1,s&&(h=parseInt(s[1],10)),c(n,i,"ol",h);continue}t=null}}function k(t,i){var u,r;return(t.name==="p"&&(u=/mso-list:\w+ \w+([0-9]+)/.exec(i),u&&(t._listLevel=parseInt(u[1],10))),o.getParam("paste_retain_style_properties","none")&&(r="",n.each(o.dom.parseStyle(i),function(n,t){switch(t){case"horiz-align":t="text-align";return;case"vert-align":t="vertical-align";return;case"font-color":case"mso-foreground":t="color";return;case"mso-background":case"mso-highlight":t="background"}(c=="all"||y&&y[t])&&(r+=t+":"+n+";")}),r))?r:null}var v=h.content,c,y,l,p,a,w;(c=s.paste_retain_style_properties,c&&(y=n.makeMap(c)),s.paste_enable_default_filters!==!1)&&e(h.content)&&(h.wordContent=!0,v=f.filter(v,[/<!--[\s\S]+?-->/gi,/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,[/<(\/?)s>/gi,"<$1strike>"],[/&nbsp;/gi,"\u00a0"],[/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(n,t){return t.length>0?t.replace(/./," ").slice(Math.floor(t.length/2)).split("").join("\u00a0"):""}]]),l=s.paste_word_valid_elements,l||(l="@[style],-strong/b,-em/i,-span,-p,-ol,-ul,-li,-h1,-h2,-h3,-h4,-h5,-h6,-table,-tr,-td[colspan|rowspan],-th,-thead,-tfoot,-tbody,-a[href|name],sub,sup,strike,br"),p=new i({valid_elements:l}),a=new t({},p),a.addAttributeFilter("style",function(n){for(var i=n.length,t;i--;)t=n[i],t.attr("style",k(t,t.attr("style"))),t.name!="span"||t.attributes.length||t.unwrap()}),a.addNodeFilter("a",function(n){for(var u=n.length,i,t,r;u--;)i=n[u],t=i.attr("href"),r=i.attr("name"),t&&t.indexOf("file://")===0&&(t=t.split("#")[1],t&&(t="#"+t)),t||r?i.attr({href:t,name:r}):i.unwrap()}),w=a.parse(v),b(w),h.content=new r({},p).serialize(w))})}return o.isWordContent=e,o}),i("tinymce/pasteplugin/Quirks",["tinymce/Env","tinymce/util/Tools","tinymce/pasteplugin/WordFilter","tinymce/pasteplugin/Utils"],function(n,t,i,r){return function(u){function f(n){u.on("BeforePastePreProcess",function(t){t.content=n(t.content)})}function e(n){return r.filter(n,[/^[\s\S]*<!--StartFragment-->|<!--EndFragment-->[\s\S]*$/g,[/<span class="Apple-converted-space">\u00a0<\/span>/g,"\u00a0"],/<br>$/])}function o(n){var f,e;return i.isWordContent(n)?(f=[],t.each(u.schema.getBlockElements(),function(n,t){f.push(t)}),e=new RegExp("(?:<br>&nbsp;[\\s\\r\\n]+|<br>)*(<\\/?("+f.join("|")+")[^>]*>)(?:<br>&nbsp;[\\s\\r\\n]+|<br>)*","g"),n=r.filter(n,[[e,"$1"]]),r.filter(n,[[/<br><br>/g,"<BR><BR>"],[/<br>/g," "],[/<BR><BR>/g,"<br>"]])):n}function s(n){return(u.settings.paste_remove_styles||u.settings.paste_remove_styles_if_webkit!==!1)&&(n=n.replace(/ style=\"[^\"]+\"/g,"")),n}n.webkit&&(f(s),f(e)),n.ie&&f(o)}}),i("tinymce/pasteplugin/Plugin",["tinymce/PluginManager","tinymce/pasteplugin/Clipboard","tinymce/pasteplugin/WordFilter","tinymce/pasteplugin/Quirks"],function(n,t,i,r){var u;n.add("paste",function(n){function s(){e.pasteFormat=="text"?(this.active(!1),e.pasteFormat="html"):(e.pasteFormat="text",this.active(!0),u||(n.windowManager.alert("Paste is now in plain text mode. Contents will now be pasted as plain text until you toggle this option off."),u=!0))}var f=this,e,o=n.settings;if(f.clipboard=e=new t(n),f.quirks=new r(n),f.wordFilter=new i(n),n.settings.paste_as_text&&(f.clipboard.pasteFormat="text"),o.paste_preprocess)n.on("PastePreProcess",function(n){o.paste_preprocess.call(f,f,n)});if(o.paste_postprocess)n.on("PastePostProcess",function(n){o.paste_postprocess.call(f,f,n)});if(n.addCommand("mceInsertClipboardContent",function(n,t){t.content&&f.clipboard.pasteHtml(t.content),t.text&&f.clipboard.pasteText(t.text)}),n.paste_block_drop)n.on("dragend dragover draggesture dragdrop drop drag",function(n){n.preventDefault(),n.stopPropagation()});if(!n.settings.paste_data_images)n.on("drop",function(n){var t=n.dataTransfer;t&&t.files&&t.files.length>0&&n.preventDefault()});n.addButton("pastetext",{icon:"pastetext",tooltip:"Paste as text",onclick:s,active:f.clipboard.pasteFormat=="text"}),n.addMenuItem("pastetext",{text:"Paste as text",selectable:!0,active:e.pasteFormat,onclick:s})})}),e(["tinymce/pasteplugin/Utils","tinymce/pasteplugin/Clipboard","tinymce/pasteplugin/WordFilter","tinymce/pasteplugin/Quirks","tinymce/pasteplugin/Plugin"])}(this);var popupEqnwin=null,curSelectedLaTeX=null;tinymce.PluginManager.add("equation",function(n){n.addCommand("insertfileCommand",function(){setTimeout(function(){P.modules.loadModule("upload_manager",{},function(){PEM.fire("showUploadManager",{submit:function(t,i){setTimeout(function(){n.focus(),typeof actualCaretPositionBookmark!="undefined"&&actualCaretPositionBookmark&&n.selection.moveToBookmark(actualCaretPositionBookmark),n.insertContent(n.dom.createHTML("a",{href:t,target:"_blank"},i))},500)},cancel:function(){setTimeout(function(){n.focus(),typeof actualCaretPositionBookmark!="undefined"&&actualCaretPositionBookmark&&n.selection.moveToBookmark(actualCaretPositionBookmark)},500)}})},null)},100)}),n.addCommand("mcePre",function(){var n=tinyMCE.activeEditor,i=n.dom,r=n.selection,t;t=i.getParent(r.getStart(),function(n){return n.nodeName=="PRE"}),t?n.execCommand("FormatBlock",!1,"p"):n.execCommand("FormatBlock",!1,"pre")}),n.addCommand("mceTt",function(){tinyMCE.activeEditor.execCommand("FormatBlock",!1,"tt")}),n.addCommand("equationCommand",function(t){var r,f,i,u,e,t;if(n.formatter.match("teletype")||n.formatter.match("preformatted")||n.selection.getContent().match(/.*<tt>.*<\/tt>.*/)!=null||n.selection.getContent().match(/.*<pre>.*<\/pre>.*/)!=null){alert("Cannot insert equations within teletype or preformatted text.");return}if(r="",f=n.selection.getNode(),curSelectedLaTeX=null,i=$(f).closest(".piazza-latex-edit"),i.length>0&&(curSelectedLaTeX=i,u=P.text_editor.makeLaTeX(i.html()),u&&(r=u)),$("#latex_window").html().length==0){e='             <div class="UIModalWindow" style="width:600px;">             <div class="topbar">LaTeX Equation Editor<\/div>             <div class="content">                 <div id="latexEditor"><div id="hover"><\/div>\n<div id="EqnEditor">\n<div id="bar1" class="top">\n\n<div class="toolbar_wrapper"><div class="toolbar" style="z-index:23"><div class="panel"><img id="undobutton" src="/modules/tinymce/eqneditor/images/buttons/undo-x.gif" alt="undo" title="undo"/>\n\t\t<img id="redobutton" src="/modules/tinymce/eqneditor/images/buttons/redo-x.gif" alt="redo" title="redo"/>\n\t\t<input type="button" class="lightbluebutton" onclick="EqEditor.cleartext()" value="Clear" title="Clear the editor window"/><\/div> <div class="panel"><select title="Equation Color" onchange="EqEditor.insert(this.value, this.value.length-2); this.selectedIndex=0"><option value="">Colors...<\/option><option value="{\\color{Red}{}}" style="color:Red">Red<\/option><option value="{\\color{Green}{}}" style="color:Green">Green<\/option><option value="{\\color{Blue}{}}" style="color:Blue">Blue<\/option><option value="{\\color{Yellow}{}}" style="color:Yellow">Yellow<\/option><option value="{\\color{Cyan}{}}" style="color:Cyan">Cyan<\/option><option value="{\\color{Magenta}{}}" style="color:Magenta">Magenta<\/option><option value="{\\color{Teal}{}}" style="color:Teal">Teal<\/option><option value="{\\color{Purple}{}}" style="color:Purple">Purple<\/option><option value="{\\color{DarkBlue}{}}" style="color:DarkBlue">Dark Blue<\/option><option value="{\\color{DarkRed}{}}" style="color:DarkRed">Dark Red<\/option><option value="{\\color{Orange}{}}" style="color:Orange">Orange<\/option><option value="{\\color{DarkOrange}{}}" style="color:DarkOrange">Dark Orange<\/option><option value="{\\color{Gold}{}}" style="color:Gold">Gold<\/option><option value="{\\color{Pink}{}}" style="color:Pink">Pink<\/option><option value="{\\color{DarkGreen}{}}" style="color:DarkGreen">Dark Green<\/option><option value="{\\color{Orchid}{}}" style="color:Orchid">Orchid<\/option><option value="{\\color{Emerald}{}}" style="color:Emerald">Emerald<\/option><\/select><\/div><div class="panel"><select title="Functions" onchange="EqEditor.insert(this.value); this.selectedIndex=0;">\n\t\t\t<option selected="selected" value="" style="color:#8080ff">Functions&hellip;<\/option>\n\t\t\t<option value="\\displaystyle">display style<\/option>\n\t\t\t<optgroup label="Trig">\n\t\t\t<option value="\\sin">sin<\/option>\n\t\t\t<option value="\\cos">cos<\/option>\n\t\t\t<option value="\\tan">tan<\/option>\n\t\t\t<option value="\\csc">csc<\/option>\n\t\t\t<option value="\\sec">sec<\/option>\n\t\t\t<option value="\\cot">cot<\/option>\n\t\t\t<option value="\\sinh">sinh<\/option>\n\t\t\t<option value="\\cosh">cosh<\/option>\n\t\t\t<option value="\\tanh">tanh<\/option>\n\t\t\t<option value="\\coth">coth<\/option>\n\t\t\t<\/optgroup> \n\t\t\t<optgroup label="Inverse Trig">\n\t\t\t<option value="\\arcsin">arcsin<\/option>\n\t\t\t<option value="\\arccos">arccos<\/option>\n\t\t\t<option value="\\arctan">arctan<\/option> \n\t\t\t<option value="\\sin^{-1}">sin-1<\/option>\n\t\t\t<option value="\\cos^{-1}">cos-1<\/option>\n\t\t\t<option value="\\tan^{-1}">tan-1<\/option> \n\t\t\t<option value="\\sinh^{-1}">sinh-1<\/option>\n\t\t\t<option value="\\cosh^{-1}">cosh-1<\/option>\n\t\t\t<option value="\\tanh^{-1}">tanh-1<\/option> \n\t\t\t<\/optgroup> \n\t\t\t<optgroup label="Logs">\n\t\t\t<option value="\\exp">exp<\/option>\n\t\t\t<option value="\\lg">lg<\/option>\n\t\t\t<option value="\\ln">ln<\/option>\n\t\t\t<option value="\\log">log<\/option>\n\t\t\t<option value="\\log_{e}">log e<\/option>\n\t\t\t<option value="\\log_{10}">log 10<\/option>\n\t\t\t<\/optgroup>\n\t\t\t<optgroup label="Limits">\n\t\t\t<option value="\\lim">limit<\/option>\n\t\t\t<option value="\\liminf">liminf<\/option>\n\t\t\t<option value="\\limsup">limsup<\/option>\n\t\t\t<option value="\\max">maximum<\/option>\n\t\t\t<option value="\\min">minimum<\/option>\n\t\t\t<option value="\\infty">infinite<\/option> \t\t\t\n\t\t\t<\/optgroup>  \n\t\t\t<optgroup label="Operators">\n\t\t\t<option value="\\arg">arg<\/option>\n\t\t\t<option value="\\det">det<\/option>\n\t\t\t<option value="\\dim">dim<\/option>\n\t\t\t<option value="\\gcd">gcd<\/option>\n\t\t\t<option value="\\hom">hom<\/option>\n\t\t\t<option value="\\ker">ker<\/option>\n\t\t\t<option value="\\Pr">Pr<\/option>\n\t\t\t<option value="\\sup">sup<\/option> \n\t\t\t<\/optgroup> \n\t\t<\/select><\/div> <\/div><\/div><div class="toolbar_wrapper"><div class="toolbar" style="z-index:22"><div class="panel" id="panel7" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/geometry.gif" width="62" height="136" border="0" title="Geometry" alt="Geometry Panel" usemap="#geometry_map" /><map name="geometry_map" id="geometry_map"><area shape="rect" alt="\\angle" coords="0,0,14,14"/><area shape="rect" alt="\\measuredangle" coords="0,17,14,31"/><area shape="rect" alt="\\cong" coords="0,34,14,48"/><area shape="rect" alt="\\triangle" coords="0,51,14,65"/><area shape="rect" alt="\\sim" coords="0,68,14,82"/><area shape="rect" alt="\\propto" coords="0,85,14,99"/><area shape="rect" alt="\\equiv" coords="0,102,14,116"/><area shape="rect" alt="\\bigodot" coords="0,119,14,133"/><area shape="rect" alt="\\parallel" coords="17,0,31,14"/><area shape="rect" alt="\\perp" coords="17,17,31,31"/><area shape="rect" alt="\\leftarrow" coords="17,34,31,48"/><area shape="rect" alt="\\rightarrow" coords="17,51,31,65"/><area shape="rect" alt="\\leftrightarrow" coords="17,68,31,82"/><area shape="rect" alt="\\Leftarrow" coords="17,85,31,99"/><area shape="rect" alt="\\Rightarrow" coords="17,102,31,116"/><area shape="rect" alt="\\Leftrightarrow" coords="17,119,31,133"/><area shape="rect" alt="\\stackrel\\frown{AB}" coords="34,0,59,25" onclick="EqEditor.insert(\'\\\\stackrel\\\\frown{}\')" /><area shape="rect" alt="\\overleftrightarrow{AB}" coords="34,28,59,53" onclick="EqEditor.insert(\'\\\\overleftrightarrow{}\')" /><area shape="rect" alt="\\overline{AB}" coords="34,56,59,81" onclick="EqEditor.insert(\'\\\\overline{}\')" /><area shape="rect" alt="63^{\\circ}" coords="34,84,59,109" onclick="EqEditor.insert(\'^{\\\\circ}\')" /><\/map><\/div><div class="panel" id="panel13" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/spaces.gif" width="31" height="68" border="0" title="Spaces" alt="Spaces Panel" usemap="#spaces_map" /><map name="spaces_map" id="spaces_map"><area shape="rect" alt="\\square\\underline{\\,}\\square" title="thin space" coords="0,0,28,14" onclick="EqEditor.insert(\'\\\\,\')" /><area shape="rect" alt="\\square\\underline{\\:}\\square" title="medium space" coords="0,17,28,31" onclick="EqEditor.insert(\'\\\\:\')" /><area shape="rect" alt="\\square\\underline{\\;}\\square" title="thick space" coords="0,34,28,48" onclick="EqEditor.insert(\'\\\\;\')" /><area shape="rect" alt="\\square\\!\\square" title="negative space" coords="0,51,28,65" onclick="EqEditor.insert(\'\\\\!\')" /><\/map><\/div><div class="panel" id="panel4" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/binary.gif" width="68" height="238" border="0" title="Binary" alt="Binary Panel" usemap="#binary_map" /><map name="binary_map" id="binary_map"><area shape="rect" alt="\\pm" coords="0,0,14,14"/><area shape="rect" alt="\\mp" coords="0,17,14,31"/><area shape="rect" alt="\\times" coords="0,34,14,48"/><area shape="rect" alt="\\ast" coords="0,51,14,65"/><area shape="rect" alt="\\div" coords="0,68,14,82"/><area shape="rect" alt="\\setminus" coords="0,85,14,99"/><area shape="rect" alt="\\dotplus" coords="0,102,14,116"/><area shape="rect" alt="\\amalg" coords="0,119,14,133"/><area shape="rect" alt="\\dagger" coords="0,136,14,150"/><area shape="rect" alt="\\ddagger" coords="0,153,14,167"/><area shape="rect" alt="\\wr" coords="0,170,14,184"/><area shape="rect" alt="\\diamond" coords="0,187,14,201"/><area shape="rect" alt="\\circledcirc" coords="0,204,14,218"/><area shape="rect" alt="\\circledast" coords="0,221,14,235"/><area shape="rect" alt="\\cap" coords="17,0,31,14"/><area shape="rect" alt="\\Cap" coords="17,17,31,31"/><area shape="rect" alt="\\sqcap" coords="17,34,31,48"/><area shape="rect" alt="\\wedge" coords="17,51,31,65"/><area shape="rect" alt="\\barwedge" coords="17,68,31,82"/><area shape="rect" alt="\\triangleleft" coords="17,85,31,99"/><area shape="rect" alt="\\lozenge" coords="17,102,31,116"/><area shape="rect" alt="\\circ" coords="17,119,31,133"/><area shape="rect" alt="\\square" coords="17,136,31,150"/><area shape="rect" alt="\\triangle" coords="17,153,31,167"/><area shape="rect" alt="\\triangledown" coords="17,170,31,184"/><area shape="rect" alt="\\ominus" coords="17,187,31,201"/><area shape="rect" alt="\\oslash" coords="17,204,31,218"/><area shape="rect" alt="\\circleddash" coords="17,221,31,235"/><area shape="rect" alt="\\cup" coords="34,0,48,14"/><area shape="rect" alt="\\Cup" coords="34,17,48,31"/><area shape="rect" alt="\\sqcup" coords="34,34,48,48"/><area shape="rect" alt="\\vee" coords="34,51,48,65"/><area shape="rect" alt="\\veebar" coords="34,68,48,82"/><area shape="rect" alt="\\triangleright" coords="34,85,48,99"/><area shape="rect" alt="\\blacklozenge" coords="34,102,48,116"/><area shape="rect" alt="\\bullet" coords="34,119,48,133"/><area shape="rect" alt="\\blacksquare" coords="34,136,48,150"/><area shape="rect" alt="\\blacktriangle" coords="34,153,48,167"/><area shape="rect" alt="\\blacktriangledown" coords="34,170,48,184"/><area shape="rect" alt="\\oplus" coords="34,187,48,201"/><area shape="rect" alt="\\otimes" coords="34,204,48,218"/><area shape="rect" alt="\\odot" coords="34,221,48,235"/><area shape="rect" alt="\\cdot" coords="51,0,65,14"/><area shape="rect" alt="\\uplus" coords="51,17,65,31"/><area shape="rect" alt="\\bigsqcup" coords="51,34,65,48"/><area shape="rect" alt="\\bigtriangleup" coords="51,51,65,65"/><area shape="rect" alt="\\bigtriangledown" coords="51,68,65,82"/><area shape="rect" alt="\\star" coords="51,85,65,99"/><area shape="rect" alt="\\bigstar" coords="51,102,65,116"/><area shape="rect" alt="\\bigcirc" coords="51,119,65,133"/><area shape="rect" alt="\\bigoplus" coords="51,136,65,150"/><area shape="rect" alt="\\bigotimes" coords="51,153,65,167"/><area shape="rect" alt="\\bigodot" coords="51,170,65,184"/><\/map><\/div><div class="panel" id="panel16" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/symbols.gif" width="68" height="136" border="0" title="Symbols" alt="Symbols Panel" usemap="#symbols_map" /><map name="symbols_map" id="symbols_map"><area shape="rect" alt="\\therefore" title="therefore" coords="0,0,14,14"/><area shape="rect" alt="\\because" title="because" coords="0,17,14,31"/><area shape="rect" alt="\\cdots" title="horizontal dots" coords="0,34,14,48"/><area shape="rect" alt="\\ddots" title="diagonal dots" coords="0,51,14,65"/><area shape="rect" alt="\\vdots" title="vertical dots" coords="0,68,14,82"/><area shape="rect" alt="\\S" title="section" coords="0,85,14,99"/><area shape="rect" alt="\\P" title="paragraph" coords="0,102,14,116"/><area shape="rect" alt="\\copyright" title="copyright" coords="0,119,14,133"/><area shape="rect" alt="\\partial" title="partial" coords="17,0,31,14"/><area shape="rect" alt="\\imath" coords="17,17,31,31"/><area shape="rect" alt="\\jmath" coords="17,34,31,48"/><area shape="rect" alt="\\Re" title="real" coords="17,51,31,65"/><area shape="rect" alt="\\Im" title="imaginary" coords="17,68,31,82"/><area shape="rect" alt="\\forall" coords="17,85,31,99"/><area shape="rect" alt="\\exists" coords="17,102,31,116"/><area shape="rect" alt="\\top" coords="17,119,31,133"/><area shape="rect" alt="\\mathbb{P}" title="prime" coords="34,0,48,14"/><area shape="rect" alt="\\mathbb{N}" title="natural" coords="34,17,48,31"/><area shape="rect" alt="\\mathbb{Z}" title="integers" coords="34,34,48,48"/><area shape="rect" alt="\\mathbb{I}" title="irrational" coords="34,51,48,65"/><area shape="rect" alt="\\mathbb{Q}" title="rational" coords="34,68,48,82"/><area shape="rect" alt="\\mathbb{R}" title="real" coords="34,85,48,99"/><area shape="rect" alt="\\mathbb{C}" title="complex" coords="34,102,48,116"/><area shape="rect" alt="\\angle" coords="51,0,65,14"/><area shape="rect" alt="\\measuredangle" coords="51,17,65,31"/><area shape="rect" alt="\\sphericalangle" coords="51,34,65,48"/><area shape="rect" alt="\\varnothing" coords="51,51,65,65"/><area shape="rect" alt="\\infty" coords="51,68,65,82"/><area shape="rect" alt="\\mho" coords="51,85,65,99"/><area shape="rect" alt="\\wp" coords="51,102,65,116"/><\/map><\/div><div class="panel" id="panel6" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/foreign.gif" width="34" height="136" border="0" title="Foreign" alt="Foreign Panel" usemap="#foreign_map" /><map name="foreign_map" id="foreign_map"><area shape="rect" alt="\\aa" coords="0,0,14,14"/><area shape="rect" alt="\\ae" coords="0,17,14,31"/><area shape="rect" alt="\\l" coords="0,34,14,48"/><area shape="rect" alt="\\o" coords="0,51,14,65"/><area shape="rect" alt="\\oe" coords="0,68,14,82"/><area shape="rect" alt="\\ss" coords="0,85,14,99"/><area shape="rect" alt="\\$" title="Dollar" coords="0,102,14,116"/><area shape="rect" alt="\\cent" title="Cent" coords="0,119,14,133"/><area shape="rect" alt="\\AA" coords="17,0,31,14"/><area shape="rect" alt="\\AE" coords="17,17,31,31"/><area shape="rect" alt="\\L" coords="17,34,31,48"/><area shape="rect" alt="\\O" coords="17,51,31,65"/><area shape="rect" alt="\\OE" coords="17,68,31,82"/><area shape="rect" alt="\\SS" coords="17,85,31,99"/><area shape="rect" alt="\\pounds" title="Pound" coords="17,102,31,116"/><area shape="rect" alt="\\euro" title="Euro" coords="17,119,31,133"/><\/map><\/div><div class="panel" id="panel15" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/subsupset.gif" width="34" height="153" border="0" title="Subsupset" alt="Subsupset Panel" usemap="#subsupset_map" /><map name="subsupset_map" id="subsupset_map"><area shape="rect" alt="\\sqsubset" coords="0,0,14,14"/><area shape="rect" alt="\\sqsubseteq" coords="0,17,14,31"/><area shape="rect" alt="\\subset" coords="0,34,14,48"/><area shape="rect" alt="\\subseteq" coords="0,51,14,65"/><area shape="rect" alt="\\nsubseteq" coords="0,68,14,82"/><area shape="rect" alt="\\subseteqq" coords="0,85,14,99"/><area shape="rect" alt="\\nsubseteq" coords="0,102,14,116"/><area shape="rect" alt="\\in" coords="0,119,14,133"/><area shape="rect" alt="\\notin" coords="0,136,14,150"/><area shape="rect" alt="\\sqsupset" coords="17,0,31,14"/><area shape="rect" alt="\\sqsupseteq" coords="17,17,31,31"/><area shape="rect" alt="\\supset" coords="17,34,31,48"/><area shape="rect" alt="\\supseteq" coords="17,51,31,65"/><area shape="rect" alt="\\nsupseteq" coords="17,68,31,82"/><area shape="rect" alt="\\supseteqq" coords="17,85,31,99"/><area shape="rect" alt="\\nsupseteqq" coords="17,102,31,116"/><area shape="rect" alt="\\ni" coords="17,119,31,133"/><\/map><\/div><div class="panel" id="panel1" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/accents.gif" width="34" height="119" border="0" title="Accents" alt="Accents Panel" usemap="#accents_map" /><map name="accents_map" id="accents_map"><area shape="rect" alt="a\'" coords="0,0,14,14" onclick="EqEditor.insert(\'{}\\\'\')" /><area shape="rect" alt="\\dot{a}" coords="0,17,14,31" onclick="EqEditor.insert(\'\\\\dot{}\')" /><area shape="rect" alt="\\hat{a}" coords="0,34,14,48" onclick="EqEditor.insert(\'\\\\hat{}\')" /><area shape="rect" alt="\\grave{a}" coords="0,51,14,65" onclick="EqEditor.insert(\'\\\\grave{}\')" /><area shape="rect" alt="\\tilde{a}" coords="0,68,14,82" onclick="EqEditor.insert(\'\\\\tilde{}\')" /><area shape="rect" alt="\\bar{a}" coords="0,85,14,99" onclick="EqEditor.insert(\'\\\\bar{}\')" /><area shape="rect" alt="\\not{a}" coords="0,102,14,116"/><area shape="rect" alt="a\'\'" coords="17,0,31,14" onclick="EqEditor.insert(\'{}\\\'\\\'\')" /><area shape="rect" alt="\\ddot{a}" coords="17,17,31,31" onclick="EqEditor.insert(\'\\\\ddot{}\')" /><area shape="rect" alt="\\check{a}" coords="17,34,31,48" onclick="EqEditor.insert(\'\\\\check{}\')" /><area shape="rect" alt="\\acute{a}" coords="17,51,31,65" onclick="EqEditor.insert(\'\\\\acute{}\')" /><area shape="rect" alt="\\breve{a}" coords="17,68,31,82" onclick="EqEditor.insert(\'\\\\breve{}\')" /><area shape="rect" alt="\\vec{a}" coords="17,85,31,99" onclick="EqEditor.insert(\'\\\\vec{}\')" /><area shape="rect" alt="a^{\\circ}" title="degrees" coords="17,102,31,116" onclick="EqEditor.insert(\'^{\\\\circ}\',0)" /><\/map><\/div><div class="panel" id="panel2" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/accents_ext.gif" width="25" height="170" border="0" title="Accents_ext" alt="Accents_ext Panel" usemap="#accents_ext_map" /><map name="accents_ext_map" id="accents_ext_map"><area shape="rect" alt="\\widetilde{abc}" coords="0,0,22,14" onclick="EqEditor.insert(\'\\\\widetilde{}\',11)" /><area shape="rect" alt="\\widehat{abc}" coords="0,17,22,31" onclick="EqEditor.insert(\'\\\\widehat{}\',9)" /><area shape="rect" alt="\\overleftarrow{abc}" coords="0,34,22,48" onclick="EqEditor.insert(\'\\\\overleftarrow{}\',15)" /><area shape="rect" alt="\\overrightarrow{abc}" coords="0,51,22,65" onclick="EqEditor.insert(\'\\\\overrightarrow{}\',16)" /><area shape="rect" alt="\\overline{abc}" coords="0,68,22,82" onclick="EqEditor.insert(\'\\\\overline{}\',10)" /><area shape="rect" alt="\\underline{abc}" coords="0,85,22,99" onclick="EqEditor.insert(\'\\\\underline{}\',11)" /><area shape="rect" alt="\\overbrace{abc}" coords="0,102,22,116" onclick="EqEditor.insert(\'\\\\overbrace{}\',11)" /><area shape="rect" alt="\\underbrace{abc}" coords="0,119,22,133" onclick="EqEditor.insert(\'\\\\underbrace{}\',12)" /><area shape="rect" alt="\\overset{a}{abc}" coords="0,136,22,150" onclick="EqEditor.insert(\'\\\\overset{}{}\',9,11)" /><area shape="rect" alt="\\underset{a}{abc}" coords="0,153,22,167" onclick="EqEditor.insert(\'\\\\underset{}{}\',10,12)" /><\/map><\/div><div class="panel" id="panel3" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/arrows.gif" width="56" height="170" border="0" title="Arrows" alt="Arrows Panel" usemap="#arrows_map" /><map name="arrows_map" id="arrows_map"><area shape="rect" alt="x \\mapsto x^2" title="\\mapsto" coords="0,0,25,14"/><area shape="rect" alt="\\leftarrow" coords="0,17,25,31"/><area shape="rect" alt="\\Leftarrow" coords="0,34,25,48"/><area shape="rect" alt="\\leftrightarrow" coords="0,51,25,65"/><area shape="rect" alt="\\leftharpoonup" coords="0,68,25,82"/><area shape="rect" alt="\\leftharpoondown" coords="0,85,25,99"/><area shape="rect" alt="\\leftrightharpoons" coords="0,102,25,116"/><area shape="rect" alt="\\xleftarrow[text]{long}" coords="0,119,25,133" onclick="EqEditor.insert(\'\\\\xleftarrow[]{}\',12)" /><area shape="rect" alt="\\overset{a}{\\leftarrow}" coords="0,136,25,150" onclick="EqEditor.insert(\'\\\\overset{}{\\\\leftarrow}\',9)" /><area shape="rect" alt="\\underset{a}{\\leftarrow}" coords="0,153,25,167" onclick="EqEditor.insert(\'\\\\underset{}{\\\\leftarrow}\',10)" /><area shape="rect" alt="n \\to \\infty" title="\\to" coords="28,0,53,14"/><area shape="rect" alt="\\rightarrow" coords="28,17,53,31"/><area shape="rect" alt="\\Rightarrow" coords="28,34,53,48"/><area shape="rect" alt="\\Leftrightarrow" coords="28,51,53,65"/><area shape="rect" alt="\\rightharpoonup" coords="28,68,53,82"/><area shape="rect" alt="\\rightharpoondown" coords="28,85,53,99"/><area shape="rect" alt="\\rightleftharpoons" coords="28,102,53,116"/><area shape="rect" alt="\\xrightarrow[text]{long}" coords="28,119,53,133" onclick="EqEditor.insert(\'\\\\xrightarrow[]{}\',13)" /><area shape="rect" alt="\\overset{a}{\\rightarrow}" coords="28,136,53,150" onclick="EqEditor.insert(\'\\\\overset{}{\\\\rightarrow}\',9)" /><area shape="rect" alt="\\underset{a}{\\rightarrow}" coords="28,153,53,167" onclick="EqEditor.insert(\'\\\\underset{}{\\\\rightarrow}\',10)" /><\/map><\/div><\/div><\/div><div class="toolbar_wrapper"><div class="toolbar" style="z-index:21"><div class="panel" id="panel11" style="height:28px"><img src="/modules/tinymce/eqneditor/images/panels/operators.gif" width="168" height="140" border="0" title="Operators" alt="Operators Panel" usemap="#operators_map" /><map name="operators_map" id="operators_map"><area shape="rect" alt="x^a" title="superscript" coords="0,0,25,25" onclick="EqEditor.insert(\'^{}\',2,0)" /><area shape="rect" alt="x_a" title="subscript" coords="0,28,25,53" onclick="EqEditor.insert(\'_{}\',2,0)" /><area shape="rect" alt="x_a^b" coords="0,56,25,81" onclick="EqEditor.insert(\'_{}^{}\',2,0)" /><area shape="rect" alt="{x_a}^b" coords="0,84,25,109" onclick="EqEditor.insert(\'{_{}}^{}\',1)" /><area shape="rect" alt="_a^{b}\\textrm{C}" title="_{a}^{b}\\textrm{C}" coords="0,112,25,137" onclick="EqEditor.insert(\'_{}^{}\\\\textrm{}\',2,14)" /><area shape="rect" alt="\\frac{a}{b}" title="fraction" coords="28,0,53,25" onclick="EqEditor.insert(\'\\\\frac{}{}\',6)" /><area shape="rect" alt="x\\tfrac{a}{b}" title="tiny fraction" coords="28,28,53,53" onclick="EqEditor.insert(\'\\\\tfrac{}{}\',7)" /><area shape="rect" alt="\\frac{\\partial }{\\partial x}" coords="28,56,53,81" onclick="EqEditor.insert(\'\\\\frac{\\\\partial }{\\\\partial x}\',15)" /><area shape="rect" alt="\\frac{\\partial^2 }{\\partial x^2}" coords="28,84,53,109" onclick="EqEditor.insert(\'\\\\frac{\\\\partial^2 }{\\\\partial x^2}\',17)" /><area shape="rect" alt="\\frac{\\mathrm{d} }{\\mathrm{d} x}" coords="28,112,53,137" onclick="EqEditor.insert(\'\\\\frac{\\\\mathrm{d} }{\\\\mathrm{d} x}\',17)" /><area shape="rect" alt="\\int" coords="56,0,81,25"/><area shape="rect" alt="\\int_a^b" title="\\int_{}^{}" coords="56,28,81,53" onclick="EqEditor.insert(\'\\\\int_{}^{}\',6,1000)" /><area shape="rect" alt="\\oint" coords="56,56,81,81" onclick="EqEditor.insert(\'\\\\oint\')" /><area shape="rect" alt="\\oint_a^b" title="\\oint_{}^{}" coords="56,84,81,109" onclick="EqEditor.insert(\'\\\\oint_{}^{}\',7,1000)" /><area shape="rect" alt="\\iint_a^b" title="\\iint_{}^{}" coords="56,112,81,137" onclick="EqEditor.insert(\'\\\\iint_{}^{}\',7,1000)" /><area shape="rect" alt="\\bigcap" coords="84,0,109,25"/><area shape="rect" alt="\\bigcap_a^b" title="\\bigcap_{}^{}" coords="84,28,109,53" onclick="EqEditor.insert(\'\\\\bigcap_{}^{}\',9,1000)" /><area shape="rect" alt="\\bigcup" coords="84,56,109,81" onclick="EqEditor.insert(\'\\\\bigcup\')" /><area shape="rect" alt="\\bigcup_a^b" title="\\bigcup_{}^{}" coords="84,84,109,109" onclick="EqEditor.insert(\'\\\\bigcup_{}^{}\',9,1000)" /><area shape="rect" alt="\\displaystyle \\lim_{x \\to 0}" title="\\lim_{x \\to 0}" coords="84,112,109,137" onclick="EqEditor.insert(\'\\\\lim_{}\')" /><area shape="rect" alt="\\sum" coords="112,0,137,25"/><area shape="rect" alt="\\sum_a^b" title="\\sum_{}^{}" coords="112,28,137,53" onclick="EqEditor.insert(\'\\\\sum_{}^{}\',6)" /><area shape="rect" alt="\\sqrt{x}" title="\\sqrt{}" coords="112,56,137,81" onclick="EqEditor.insert(\'\\\\sqrt{}\',6,6)" /><area shape="rect" alt="\\sqrt[n]{x}" title="\\sqrt[]{}" coords="112,84,137,109" onclick="EqEditor.insert(\'\\\\sqrt[]{}\',6,8)" /><area shape="rect" alt="\\prod" coords="140,0,165,25"/><area shape="rect" alt="\\prod_a^b" title="\\prod_{}^{}" coords="140,28,165,53" onclick="EqEditor.insert(\'\\\\prod_{}^{}\',7,1000)" /><area shape="rect" alt="\\coprod" coords="140,56,165,81"/><area shape="rect" alt="\\coprod_a^b" title="\\coprod_{}^{}" coords="140,84,165,109" onclick="EqEditor.insert(\'\\\\coprod_{}^{}\',9,1000)" /><\/map><\/div><div class="panel" id="panel5" style="height:28px"><img src="/modules/tinymce/eqneditor/images/panels/brackets.gif" width="56" height="140" border="0" title="Brackets" alt="Brackets Panel" usemap="#brackets_map" /><map name="brackets_map" id="brackets_map"><area shape="rect" alt="\\left (\\: \\right )" title="\\left ( \\right )" coords="0,0,25,25" onclick="EqEditor.insert(\'\\\\left (  \\\\right )\',8)" /><area shape="rect" alt="\\left [\\: \\right ]" title="\\left ( \\right )" coords="0,28,25,53" onclick="EqEditor.insert(\'\\\\left [  \\\\right ]\',8)" /><area shape="rect" alt="\\left\\{\\: \\right\\}" title="\\left\\{ \\right\\}" coords="0,56,25,81" onclick="EqEditor.insert(\'\\\\left \\\\{  \\\\right \\\\}\',9)" /><area shape="rect" alt="\\left |\\: \\right |" title="\\left | \\right |" coords="0,84,25,109" onclick="EqEditor.insert(\'\\\\left |  \\\\right |\',8)" /><area shape="rect" alt="\\left \\{ \\cdots \\right." title="\\left \\{ \\right." coords="0,112,25,137" onclick="EqEditor.insert(\'\\\\left \\\\{  \\\\right.\',9)" /><area shape="rect" alt="\\left \\|\\: \\right \\|" title="\\left \\| \\right \\|" coords="28,0,53,25" onclick="EqEditor.insert(\'\\\\left \\\\|  \\\\right \\\\|\',9)" /><area shape="rect" alt="\\left \\langle \\: \\right \\rangle" title="\\left \\langle \\right \\rangle" coords="28,28,53,53" onclick="EqEditor.insert(\'\\\\left \\\\langle  \\\\right \\\\rangle\',14)" /><area shape="rect" alt="\\left \\lfloor \\: \\right \\rfloor" title="\\left \\lfloor \\right \\rfloor" coords="28,56,53,81" onclick="EqEditor.insert(\'\\\\left \\\\lfloor  \\\\right \\\\rfloor\',14)" /><area shape="rect" alt="\\left \\lceil \\: \\right \\rceil" title="\\left \\lceil \\right \\rceil" coords="28,84,53,109" onclick="EqEditor.insert(\'\\\\left \\\\lceil  \\\\right \\\\rceil\',13)" /><area shape="rect" alt="\\left. \\cdots \\right \\}" title="\\left. \\right \\}" coords="28,112,53,137" onclick="EqEditor.insert(\'\\\\left.  \\\\right \\\\}\',7)" /><\/map><\/div><div class="panel" id="panel8" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/greeklower.gif" width="68" height="136" border="0" title="Greeklower" alt="Greeklower Panel" usemap="#greeklower_map" /><map name="greeklower_map" id="greeklower_map"><area shape="rect" alt="\\alpha" coords="0,0,14,14"/><area shape="rect" alt="\\epsilon" coords="0,17,14,31"/><area shape="rect" alt="\\theta" coords="0,34,14,48"/><area shape="rect" alt="\\lambda" coords="0,51,14,65"/><area shape="rect" alt="\\pi" coords="0,68,14,82"/><area shape="rect" alt="\\sigma" coords="0,85,14,99"/><area shape="rect" alt="\\phi" coords="0,102,14,116"/><area shape="rect" alt="\\omega" coords="0,119,14,133"/><area shape="rect" alt="\\beta" coords="17,0,31,14"/><area shape="rect" alt="\\varepsilon" coords="17,17,31,31"/><area shape="rect" alt="\\vartheta" coords="17,34,31,48"/><area shape="rect" alt="\\mu" coords="17,51,31,65"/><area shape="rect" alt="\\varpi" coords="17,68,31,82"/><area shape="rect" alt="\\varsigma" coords="17,85,31,99"/><area shape="rect" alt="\\varphi" coords="17,102,31,116"/><area shape="rect" alt="\\gamma" coords="34,0,48,14"/><area shape="rect" alt="\\zeta" coords="34,17,48,31"/><area shape="rect" alt="\\iota" coords="34,34,48,48"/><area shape="rect" alt="\\nu" coords="34,51,48,65"/><area shape="rect" alt="\\rho" coords="34,68,48,82"/><area shape="rect" alt="\\tau" coords="34,85,48,99"/><area shape="rect" alt="\\chi" coords="34,102,48,116"/><area shape="rect" alt="\\delta" coords="51,0,65,14"/><area shape="rect" alt="\\eta" coords="51,17,65,31"/><area shape="rect" alt="\\kappa" coords="51,34,65,48"/><area shape="rect" alt="\\xi" coords="51,51,65,65"/><area shape="rect" alt="\\varrho" coords="51,68,65,82"/><area shape="rect" alt="\\upsilon" coords="51,85,65,99"/><area shape="rect" alt="\\psi" coords="51,102,65,116"/><\/map><\/div><div class="panel" id="panel9" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/greekupper.gif" width="34" height="102" border="0" title="Greekupper" alt="Greekupper Panel" usemap="#greekupper_map" /><map name="greekupper_map" id="greekupper_map"><area shape="rect" alt="\\Gamma" coords="0,0,14,14"/><area shape="rect" alt="\\Theta" coords="0,17,14,31"/><area shape="rect" alt="\\Xi" coords="0,34,14,48"/><area shape="rect" alt="\\Sigma" coords="0,51,14,65"/><area shape="rect" alt="\\Phi" coords="0,68,14,82"/><area shape="rect" alt="\\Omega" coords="0,85,14,99"/><area shape="rect" alt="\\Delta" coords="17,0,31,14"/><area shape="rect" alt="\\Lambda" coords="17,17,31,31"/><area shape="rect" alt="\\Pi" coords="17,34,31,48"/><area shape="rect" alt="\\Upsilon" coords="17,51,31,65"/><area shape="rect" alt="\\Psi" coords="17,68,31,82"/><\/map><\/div><div class="panel" id="panel12" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/relations.gif" width="51" height="221" border="0" title="Relations" alt="Relations Panel" usemap="#relations_map" /><map name="relations_map" id="relations_map"><area shape="rect" alt="&lt;" coords="0,0,14,14"/><area shape="rect" alt="\\leq" coords="0,17,14,31"/><area shape="rect" alt="\\leqslant" coords="0,34,14,48"/><area shape="rect" alt="\\nless" coords="0,51,14,65"/><area shape="rect" alt="\\nleqslant" coords="0,68,14,82"/><area shape="rect" alt="\\prec" coords="0,85,14,99"/><area shape="rect" alt="\\preceq" coords="0,102,14,116"/><area shape="rect" alt="\\ll" coords="0,119,14,133"/><area shape="rect" alt="\\vdash" coords="0,136,14,150"/><area shape="rect" alt="\\smile" title="smile" coords="0,153,14,167"/><area shape="rect" alt="\\models" coords="0,170,14,184"/><area shape="rect" alt="\\mid" coords="0,187,14,201"/><area shape="rect" alt="\\bowtie" coords="0,204,14,218"/><area shape="rect" alt="&gt;" coords="17,0,31,14"/><area shape="rect" alt="\\geq" coords="17,17,31,31"/><area shape="rect" alt="\\geqslant" coords="17,34,31,48"/><area shape="rect" alt="\\ngtr" coords="17,51,31,65"/><area shape="rect" alt="\\ngeqslant" coords="17,68,31,82"/><area shape="rect" alt="\\succ" coords="17,85,31,99"/><area shape="rect" alt="\\succeq" coords="17,102,31,116"/><area shape="rect" alt="\\gg" coords="17,119,31,133"/><area shape="rect" alt="\\dashv" coords="17,136,31,150"/><area shape="rect" alt="\\frown" title="frown" coords="17,153,31,167"/><area shape="rect" alt="\\perp" coords="17,170,31,184"/><area shape="rect" alt="\\parallel" title="parallel" coords="17,187,31,201"/><area shape="rect" alt="\\Join" coords="17,204,31,218"/><area shape="rect" alt="=" coords="34,0,48,14"/><area shape="rect" alt="\\doteq" coords="34,17,48,31"/><area shape="rect" alt="\\equiv" title="equivalent" coords="34,34,48,48"/><area shape="rect" alt="\\neq" coords="34,51,48,65"/><area shape="rect" alt="\\not\\equiv" title="not equivalent" coords="34,68,48,82"/><area shape="rect" alt="\\overset{\\underset{\\mathrm{def}}{}}{=}" title="define" coords="34,85,48,99"/><area shape="rect" alt="\\sim" coords="34,102,48,116"/><area shape="rect" alt="\\approx" coords="34,119,48,133"/><area shape="rect" alt="\\simeq" coords="34,136,48,150"/><area shape="rect" alt="\\cong" coords="34,153,48,167"/><area shape="rect" alt="\\asymp" coords="34,170,48,184"/><area shape="rect" alt="\\propto" title="proportional to" coords="34,187,48,201"/><\/map><\/div><div class="panel" id="panel10" style="height:34px"><img src="/modules/tinymce/eqneditor/images/panels/matrix.gif" width="102" height="170" border="0" title="Matrix" alt="Matrix Panel" usemap="#matrix_map" /><map name="matrix_map" id="matrix_map"><area shape="rect" alt="\\begin{matrix}\n\\cdots \\\\\n\\cdots \\\\\n\\end{matrix}" title="\\begin{matrix} ... \\end{matrix}" coords="0,0,31,31" onclick="EqEditor.makeArrayMatrix(\'\',\'\',\'\')" /><area shape="rect" alt="\\begin{pmatrix}\n\\cdots \\\\\n\\cdots\n\\end{pmatrix}" title="\\begin{pmatrix} ... \\end{pmatrix}" coords="0,34,31,65" onclick="EqEditor.makeArrayMatrix(\'p\',\'\',\'\')" /><area shape="rect" alt="\\begin{vmatrix}\n\\cdots \\\\\n\\cdots\n\\end{vmatrix}" title="\\begin{vmatrix} ... \\end{vmatrix}" coords="0,68,31,99" onclick="EqEditor.makeArrayMatrix(\'v\',\'\',\'\')" /><area shape="rect" alt="\\begin{Vmatrix}\n\\cdots \\\\ \n\\cdots\n\\end{Vmatrix}" title="\\begin{Vmatrix} ... \\end{Vmatrix}" coords="0,102,31,133" onclick="EqEditor.makeArrayMatrix(\'V\',\'\',\'\')" /><area shape="rect" alt="\\left.\\begin{matrix}\n\\cdots \\\\ \n\\cdots\n\\end{matrix}\\right|" title="\\left.\\begin{matrix}... \\end{matrix}\\right|" coords="0,136,31,167" onclick="EqEditor.makeArrayMatrix(\'\',\'\\\\left.\',\'\\\\right|\')" /><area shape="rect" alt="\\begin{bmatrix}\n\\cdots \\\\ \n\\cdots\n\\end{bmatrix}" title="\\being{bmatrix} ... \\end{bmatrix}" coords="34,0,65,31" onclick="EqEditor.makeArrayMatrix(\'b\',\'\',\'\')" /><area shape="rect" alt="\\bigl(\\begin{smallmatrix}\n\\cdots \\\\ \n\\cdots \n\\end{smallmatrix}\\bigr)" title="\\bigl(\\begin{smallmatrix} ... \\end{smallmatrix}\\bigr)" coords="34,34,65,65" onclick="EqEditor.makeArrayMatrix(\'small\',\'\\\\bigl(\',\'\\\\bigr)\')" /><area shape="rect" alt="\\begin{Bmatrix}\n\\cdots \\\\ \n\\cdots\n\\end{Bmatrix}" title="\\begin{Bmatrix} ... \\end{Bmatrix}" coords="34,68,65,99" onclick="EqEditor.makeArrayMatrix(\'B\',\'\',\'\')" /><area shape="rect" alt="\\left\\{\\begin{matrix}\n\\cdots \\\\ \n\\cdots\n\\end{matrix}\\right." title="\\begin{Bmatrix} ... \\end{matrix}" coords="34,102,65,133" onclick="EqEditor.makeArrayMatrix(\'\',\'\\\\left\\\\{\',\'\\\\right.\')" /><area shape="rect" alt="\\left.\\begin{matrix}\n\\cdots \\\\ \n\\cdots\n\\end{matrix}\\right\\}" title="\\begin{matrix} ... \\end{Bmatrix}" coords="34,136,65,167" onclick="EqEditor.makeArrayMatrix(\'\',\'\\\\left.\',\'\\\\right\\\\}\')" /><area shape="rect" alt=" \\binom{n}{r}" coords="68,0,99,31" onclick="EqEditor.insert(\'\\\\binom{}{}\')" /><area shape="rect" alt="\\begin{cases}..,x= \\\\..,x=\\end{cases}" title="\\begin{cases} ... \\end{cases}" coords="68,34,99,65" onclick="EqEditor.makeEquationsMatrix(\'cases\', true, true)" /><area shape="rect" alt="\\begin{align*}\ny&amp;=\\cdots \\\\ \n &amp;+\\cdots \n\\end{align*}" title="\\begin{align} ... \\end{align}" coords="68,68,99,99" onclick="EqEditor.makeEquationsMatrix(\'align\', false)" /><\/map><\/div><\/div><\/div><\/div><\/div><\/div>                 <textarea id="latexTextArea" style="margin: 2px; width: 556px; height: 50px; color: black;"><\/textarea><br /><br />                     <div align="center" id="latexPreviewRender"><\/div>             <\/div>             <ul class="UIActions clearFix">             <li class="rightFloat"><a class="UIButton cancel" href="#" onclick="return cancelLatex();" id="latexCancel">Cancel<\/a><\/li>             <li class="rightFloat"><a class="UIButton submit" href="#" onclick="return addLatexToEditor();" id="latexInsert">Insert/Change<\/a><\/li>             <\/ul><\/div>',$("#latex_window").html(e),EqEditor.init("id",undefined,undefined,"latexEditor"),t=new EqTextArea("latexCancel","latexTextArea");try{EqEditor.add(t,!1)}catch(o){}$("#latexTextArea").keyup(function(){refreshLatexPreview(!1)}),$("#latexEditor").click(function(){refreshLatexPreview(!0)})}$("#latex_window").show(),$.fancybox({autoScale:!0,hideOnOverlayClick:!1,padding:0,href:"#latex_window",showCloseButton:!1,transitionIn:"none",transitionOut:"none"}),$("#latexTextArea").val(r).focus(),refreshLatexPreview(!0)}),n.addButton("equation",{title:"LaTeX Equation Editor",image:"/images/plugins/latex/equation.gif",cmd:"equationCommand",onPostRender:function(){var t=this;n.on("NodeChange",function(n){var i=$(n.element).closest(".piazza-latex-edit").length>0;t.active(i),$(n.element).closest("body").find(".piazza-latex-edit").css("background","#FFF"),i&&$(n.element).closest(".piazza-latex-edit").css("background","#FFC")})}}),n.addButton("insertfile",{title:"Insert a file",cmd:"insertfileCommand"}),n.addButton("prebutton",{title:"Code block",icon:"code",cmd:"mcePre",stateSelector:"pre"}),n.addButton("ttbutton",{title:"Teletype text",icon:"tt",cmd:"mceTt",stateSelector:"tt"}),n.addMenuItem("insertfile",{icon:"insertfile",text:"Insert file",cmd:"insertfileCommand",context:"insert",prependToContext:!0})}),tinymce.PluginManager.add("preview",function(n){var t=n.settings;n.addCommand("mcePreview",function(){doPostPreview(n,t)}),n.addButton("preview",{title:"Preview",cmd:"mcePreview"}),n.addMenuItem("preview",{text:"Preview",cmd:"mcePreview",context:"view"})})
tinymce.PluginManager.add("lists",function(e){function t(e){return e&&/^(OL|UL)$/.test(e.nodeName)}function n(e){return e.parentNode.firstChild==e}function r(e){return e.parentNode.lastChild==e}function o(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}function i(e){return e&&"SPAN"===e.nodeName&&"bookmark"===e.getAttribute("data-mce-type")}var a=this;e.on("init",function(){function d(e){function t(t){var r,o,i;o=e[t?"startContainer":"endContainer"],i=e[t?"startOffset":"endOffset"],1==o.nodeType&&(r=b.create("span",{"data-mce-type":"bookmark"}),o.hasChildNodes()?(i=Math.min(i,o.childNodes.length-1),t?o.insertBefore(r,o.childNodes[i]):b.insertAfter(r,o.childNodes[i])):o.appendChild(r),o=r,i=0),n[t?"startContainer":"endContainer"]=o,n[t?"startOffset":"endOffset"]=i}var n={};return t(!0),e.collapsed||t(),n}function s(e){function t(t){function n(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;(1!=t.nodeType||"bookmark"!=t.getAttribute("data-mce-type"))&&n++,t=t.nextSibling}return-1}var r,o,i;r=i=e[t?"startContainer":"endContainer"],o=e[t?"startOffset":"endOffset"],r&&(1==r.nodeType&&(o=n(r),r=r.parentNode,b.remove(i)),e[t?"startContainer":"endContainer"]=r,e[t?"startOffset":"endOffset"]=o)}t(!0),t();var n=b.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),L.setRng(n)}function f(t,n){var r,o,i,a=b.createFragment(),d=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&(o=b.create(n),o.tagName===e.settings.forced_root_block&&b.setAttribs(o,e.settings.forced_root_block_attrs),a.appendChild(o)),t)for(;r=t.firstChild;){var s=r.nodeName;i||"SPAN"==s&&"bookmark"==r.getAttribute("data-mce-type")||(i=!0),d[s]?(a.appendChild(r),o=null):n?(o||(o=b.create(n),a.appendChild(o)),o.appendChild(r)):a.appendChild(r)}return e.settings.forced_root_block?i||tinymce.Env.ie&&!(tinymce.Env.ie>10)||o.appendChild(b.create("br",{"data-mce-bogus":"1"})):a.appendChild(b.create("br")),a}function l(){return tinymce.grep(L.getSelectedBlocks(),function(e){return"LI"==e.nodeName})}function c(e,t,n){var r,o,i=b.select('span[data-mce-type="bookmark"]',e);n=n||f(t),r=b.createRng(),r.setStartAfter(t),r.setEndAfter(e),o=r.extractContents(),b.isEmpty(o)||b.insertAfter(o,e),b.insertAfter(n,e),b.isEmpty(t.parentNode)&&(tinymce.each(i,function(e){t.parentNode.parentNode.insertBefore(e,t.parentNode)}),b.remove(t.parentNode)),b.remove(t)}function p(e){var n,r;if(n=e.nextSibling,n&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.appendChild(r);b.remove(n)}if(n=e.previousSibling,n&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.insertBefore(r,e.firstChild);b.remove(n)}}function u(e){tinymce.each(tinymce.grep(b.select("ol,ul",e)),function(e){var n,r=e.parentNode;"LI"==r.nodeName&&r.firstChild==e&&(n=r.previousSibling,n&&"LI"==n.nodeName&&(n.appendChild(e),b.isEmpty(r)&&b.remove(r))),t(r)&&(n=r.previousSibling,n&&"LI"==n.nodeName&&n.appendChild(e))})}function m(e){function o(e){b.isEmpty(e)&&b.remove(e)}var i,a=e.parentNode,d=a.parentNode;return n(e)&&r(e)?("LI"==d.nodeName?(b.insertAfter(e,d),o(d),b.remove(a)):t(d)?b.remove(a,!0):(d.insertBefore(f(e),a),b.remove(a)),!0):n(e)?("LI"==d.nodeName?(b.insertAfter(e,d),e.appendChild(a),o(d)):t(d)?d.insertBefore(e,a):(d.insertBefore(f(e),a),b.remove(e)),!0):r(e)?("LI"==d.nodeName?b.insertAfter(e,d):t(d)?b.insertAfter(e,a):(b.insertAfter(f(e),a),b.remove(e)),!0):("LI"==d.nodeName?(a=d,i=f(e,"LI")):i=t(d)?f(e,"LI"):f(e),c(a,e,i),u(a.parentNode),!0)}function h(e){function n(n,r){var o;if(t(n)){for(;o=e.lastChild.firstChild;)r.appendChild(o);b.remove(n)}}var r,o;return r=e.previousSibling,r&&t(r)?(r.appendChild(e),!0):r&&"LI"==r.nodeName&&t(r.lastChild)?(r.lastChild.appendChild(e),n(e.lastChild,r.lastChild),!0):(r=e.nextSibling,r&&t(r)?(r.insertBefore(e,r.firstChild),!0):r&&"LI"==r.nodeName&&t(e.lastChild)?!1:(r=e.previousSibling,r&&"LI"==r.nodeName?(o=b.create(e.parentNode.nodeName),r.appendChild(o),o.appendChild(e),n(e.lastChild,o),!0):!1))}function v(){var t=l();if(t.length){for(var n=d(L.getRng(!0)),r=0;r<t.length&&(h(t[r])||0!==r);r++);return s(n),e.nodeChanged(),!0}}function C(){var t=l();if(t.length){var n,r,o=d(L.getRng(!0)),i=e.getBody();for(n=t.length;n--;)for(var a=t[n].parentNode;a&&a!=i;){for(r=t.length;r--;)if(t[r]===a){t.splice(n,1);break}a=a.parentNode}for(n=0;n<t.length&&(m(t[n])||0!==n);n++);return s(o),e.nodeChanged(),!0}}function g(n){function r(){function t(e){var t,n;for(t=a[e?"startContainer":"endContainer"],n=a[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=d;){if(o(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var n,r=[],d=e.getBody(),s=t(!0),f=t(),l=[],c=s;c&&(l.push(c),c!=f);c=c.nextSibling);return tinymce.each(l,function(e){if(o(e))return r.push(e),n=null,void 0;if(b.isBlock(e)||"BR"==e.nodeName)return"BR"==e.nodeName&&b.remove(e),n=null,void 0;var t=e.nextSibling;return i(e)&&(o(t)||!t&&e.parentNode==d)?(n=null,void 0):(n||(n=b.create("p"),e.parentNode.insertBefore(n,e),r.push(n)),n.appendChild(e),void 0)}),r}var a=L.getRng(!0),f=d(a),l=r();tinymce.each(l,function(e){var r,o;o=e.previousSibling,o&&t(o)&&o.nodeName==n?(r=o,e=b.rename(e,"LI"),o.appendChild(e)):(r=b.create(n),e.parentNode.insertBefore(r,e),r.appendChild(e),e=b.rename(e,"LI")),p(r)}),s(f)}function N(){var n=d(L.getRng(!0)),r=e.getBody();tinymce.each(l(),function(e){var n,o;if(b.isEmpty(e))return m(e),void 0;for(n=e;n&&n!=r;n=n.parentNode)t(n)&&(o=n);c(o,e)}),s(n)}function y(e){var t=b.getParent(L.getStart(),"OL,UL");if(t)if(t.nodeName==e)N(e);else{var n=d(L.getRng(!0));p(b.rename(t,e)),s(n)}else g(e)}var b=e.dom,L=e.selection;a.backspaceDelete=function(e){function n(e,t){var n=e.startContainer,r=e.startOffset;if(3==n.nodeType&&(t?r<n.data.length:r>0))return n;for(var o=new tinymce.dom.TreeWalker(e.startContainer);n=o[t?"next":"prev"]();)if(3==n.nodeType&&n.data.length>0)return n}function r(e,n){var r,o,i=e.parentNode;for(t(n.lastChild)&&(o=n.lastChild),r=n.lastChild,r&&"BR"==r.nodeName&&e.hasChildNodes()&&b.remove(r);r=e.firstChild;)n.appendChild(r);o&&n.appendChild(o),b.remove(e),b.isEmpty(i)&&b.remove(i)}if(L.isCollapsed()){var o=b.getParent(L.getStart(),"LI");if(o){var i=L.getRng(!0),a=b.getParent(n(i,e),"LI");if(a&&a!=o){var f=d(i);return e?r(a,o):r(o,a),s(f),!0}if(!a&&!e&&N(o.parentNode.nodeName))return!0}}},e.addCommand("Indent",function(){return v()?void 0:!0}),e.addCommand("Outdent",function(){return C()?void 0:!0}),e.addCommand("InsertUnorderedList",function(){y("UL")}),e.addCommand("InsertOrderedList",function(){y("OL")}),e.on("keydown",function(t){9==t.keyCode&&e.dom.getParent(e.selection.getStart(),"LI")&&(t.preventDefault(),t.shiftKey?C():v())})}),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){var r=e.dom.getParent(e.selection.getNode(),"LI,UL,OL");t.disabled(r&&("LI"!=r.nodeName||n(r)))})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?a.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&a.backspaceDelete(!0)&&e.preventDefault()})});
tinymce.PluginManager.add("charmap",function(e){function t(){function t(e){for(;e;){if("TD"==e.nodeName)return e;e=e.parentNode}}var i,a,r,o;i='<table role="presentation" cellspacing="0" class="mce-charmap"><tbody>';var s=25;for(r=0;10>r;r++){for(i+="<tr>",a=0;s>a;a++){var l=n[r*s+a],c="g"+(r*s+a);i+='<td title="'+l[1]+'"><div id="'+c+'" tabIndex="-1">'+(l?String.fromCharCode(parseInt(l[0],10)):"&nbsp;")+"</div></td>"}i+="</tr>"}i+="</tbody></table>";var u={type:"container",html:i,onclick:function(t){var n=t.target;"DIV"==n.nodeName&&e.execCommand("mceInsertContent",!1,n.firstChild.nodeValue)},onmouseover:function(e){var n=t(e.target);n&&o.find("#preview").text(n.firstChild.firstChild.data)}};o=e.windowManager.open({title:"Special character",spacing:10,padding:10,items:[u,{type:"label",name:"preview",text:" ",style:"font-size: 40px; text-align: center",border:1,minWidth:100,minHeight:80}],buttons:[{text:"Close",onclick:function(){o.close()}}]})}var n=[["160","no-break space"],["38","ampersand"],["34","quotation mark"],["162","cent sign"],["8364","euro sign"],["163","pound sign"],["165","yen sign"],["169","copyright sign"],["174","registered sign"],["8482","trade mark sign"],["8240","per mille sign"],["181","micro sign"],["183","middle dot"],["8226","bullet"],["8230","three dot leader"],["8242","minutes / feet"],["8243","seconds / inches"],["167","section sign"],["182","paragraph sign"],["223","sharp s / ess-zed"],["8249","single left-pointing angle quotation mark"],["8250","single right-pointing angle quotation mark"],["171","left pointing guillemet"],["187","right pointing guillemet"],["8216","left single quotation mark"],["8217","right single quotation mark"],["8220","left double quotation mark"],["8221","right double quotation mark"],["8218","single low-9 quotation mark"],["8222","double low-9 quotation mark"],["60","less-than sign"],["62","greater-than sign"],["8804","less-than or equal to"],["8805","greater-than or equal to"],["8211","en dash"],["8212","em dash"],["175","macron"],["8254","overline"],["164","currency sign"],["166","broken bar"],["168","diaeresis"],["161","inverted exclamation mark"],["191","turned question mark"],["710","circumflex accent"],["732","small tilde"],["176","degree sign"],["8722","minus sign"],["177","plus-minus sign"],["247","division sign"],["8260","fraction slash"],["215","multiplication sign"],["185","superscript one"],["178","superscript two"],["179","superscript three"],["188","fraction one quarter"],["189","fraction one half"],["190","fraction three quarters"],["402","function / florin"],["8747","integral"],["8721","n-ary sumation"],["8734","infinity"],["8730","square root"],["8764","similar to"],["8773","approximately equal to"],["8776","almost equal to"],["8800","not equal to"],["8801","identical to"],["8712","element of"],["8713","not an element of"],["8715","contains as member"],["8719","n-ary product"],["8743","logical and"],["8744","logical or"],["172","not sign"],["8745","intersection"],["8746","union"],["8706","partial differential"],["8704","for all"],["8707","there exists"],["8709","diameter"],["8711","backward difference"],["8727","asterisk operator"],["8733","proportional to"],["8736","angle"],["180","acute accent"],["184","cedilla"],["170","feminine ordinal indicator"],["186","masculine ordinal indicator"],["8224","dagger"],["8225","double dagger"],["192","A - grave"],["193","A - acute"],["194","A - circumflex"],["195","A - tilde"],["196","A - diaeresis"],["197","A - ring above"],["198","ligature AE"],["199","C - cedilla"],["200","E - grave"],["201","E - acute"],["202","E - circumflex"],["203","E - diaeresis"],["204","I - grave"],["205","I - acute"],["206","I - circumflex"],["207","I - diaeresis"],["208","ETH"],["209","N - tilde"],["210","O - grave"],["211","O - acute"],["212","O - circumflex"],["213","O - tilde"],["214","O - diaeresis"],["216","O - slash"],["338","ligature OE"],["352","S - caron"],["217","U - grave"],["218","U - acute"],["219","U - circumflex"],["220","U - diaeresis"],["221","Y - acute"],["376","Y - diaeresis"],["222","THORN"],["224","a - grave"],["225","a - acute"],["226","a - circumflex"],["227","a - tilde"],["228","a - diaeresis"],["229","a - ring above"],["230","ligature ae"],["231","c - cedilla"],["232","e - grave"],["233","e - acute"],["234","e - circumflex"],["235","e - diaeresis"],["236","i - grave"],["237","i - acute"],["238","i - circumflex"],["239","i - diaeresis"],["240","eth"],["241","n - tilde"],["242","o - grave"],["243","o - acute"],["244","o - circumflex"],["245","o - tilde"],["246","o - diaeresis"],["248","o slash"],["339","ligature oe"],["353","s - caron"],["249","u - grave"],["250","u - acute"],["251","u - circumflex"],["252","u - diaeresis"],["253","y - acute"],["254","thorn"],["255","y - diaeresis"],["913","Alpha"],["914","Beta"],["915","Gamma"],["916","Delta"],["917","Epsilon"],["918","Zeta"],["919","Eta"],["920","Theta"],["921","Iota"],["922","Kappa"],["923","Lambda"],["924","Mu"],["925","Nu"],["926","Xi"],["927","Omicron"],["928","Pi"],["929","Rho"],["931","Sigma"],["932","Tau"],["933","Upsilon"],["934","Phi"],["935","Chi"],["936","Psi"],["937","Omega"],["945","alpha"],["946","beta"],["947","gamma"],["948","delta"],["949","epsilon"],["950","zeta"],["951","eta"],["952","theta"],["953","iota"],["954","kappa"],["955","lambda"],["956","mu"],["957","nu"],["958","xi"],["959","omicron"],["960","pi"],["961","rho"],["962","final sigma"],["963","sigma"],["964","tau"],["965","upsilon"],["966","phi"],["967","chi"],["968","psi"],["969","omega"],["8501","alef symbol"],["982","pi symbol"],["8476","real part symbol"],["978","upsilon - hook symbol"],["8472","Weierstrass p"],["8465","imaginary part"],["8592","leftwards arrow"],["8593","upwards arrow"],["8594","rightwards arrow"],["8595","downwards arrow"],["8596","left right arrow"],["8629","carriage return"],["8656","leftwards double arrow"],["8657","upwards double arrow"],["8658","rightwards double arrow"],["8659","downwards double arrow"],["8660","left right double arrow"],["8756","therefore"],["8834","subset of"],["8835","superset of"],["8836","not a subset of"],["8838","subset of or equal to"],["8839","superset of or equal to"],["8853","circled plus"],["8855","circled times"],["8869","perpendicular"],["8901","dot operator"],["8968","left ceiling"],["8969","right ceiling"],["8970","left floor"],["8971","right floor"],["9001","left-pointing angle bracket"],["9002","right-pointing angle bracket"],["9674","lozenge"],["9824","black spade suit"],["9827","black club suit"],["9829","black heart suit"],["9830","black diamond suit"],["8194","en space"],["8195","em space"],["8201","thin space"],["8204","zero width non-joiner"],["8205","zero width joiner"],["8206","left-to-right mark"],["8207","right-to-left mark"],["173","soft hyphen"]];e.addButton("charmap",{icon:"charmap",tooltip:"Special character",onclick:t}),e.addMenuItem("charmap",{icon:"charmap",text:"Special character",onclick:t,context:"insert"})});
!function(){function e(e,t,n,a,r){function i(e,t){if(t=t||0,!e[0])throw"findAndReplaceDOMText cannot handle zero-length matches";var n=e.index;if(t>0){var a=e[t];if(!a)throw"Invalid capture group";n+=e[0].indexOf(a),e[0]=a}return[n,n+e[0].length,[e[0]]]}function d(e){var t;if(3===e.nodeType)return e.data;if(h[e.nodeName]&&!u[e.nodeName])return"";if(t="",(u[e.nodeName]||m[e.nodeName])&&(t+="\n"),e=e.firstChild)do t+=d(e);while(e=e.nextSibling);return t}function o(e,t,n){var a,r,i,d,o=[],l=0,c=e,s=t.shift(),f=0;e:for(;;){if((u[c.nodeName]||m[c.nodeName])&&l++,3===c.nodeType&&(!r&&c.length+l>=s[1]?(r=c,d=s[1]-l):a&&o.push(c),!a&&c.length+l>s[0]&&(a=c,i=s[0]-l),l+=c.length),a&&r){if(c=n({startNode:a,startNodeIndex:i,endNode:r,endNodeIndex:d,innerNodes:o,match:s[2],matchIndex:f}),l-=r.length-d,a=null,r=null,o=[],s=t.shift(),f++,!s)break}else{if((!h[c.nodeName]||u[c.nodeName])&&c.firstChild){c=c.firstChild;continue}if(c.nextSibling){c=c.nextSibling;continue}}for(;;){if(c.nextSibling){c=c.nextSibling;break}if(c.parentNode===e)break e;c=c.parentNode}}}function l(e){var t;if("function"!=typeof e){var n=e.nodeType?e:f.createElement(e);t=function(e,t){var a=n.cloneNode(!1);return a.setAttribute("data-mce-index",t),e&&a.appendChild(f.createTextNode(e)),a}}else t=e;return function(e){var n,a,r,i=e.startNode,d=e.endNode,o=e.matchIndex;if(i===d){var l=i;r=l.parentNode,e.startNodeIndex>0&&(n=f.createTextNode(l.data.substring(0,e.startNodeIndex)),r.insertBefore(n,l));var c=t(e.match[0],o);return r.insertBefore(c,l),e.endNodeIndex<l.length&&(a=f.createTextNode(l.data.substring(e.endNodeIndex)),r.insertBefore(a,l)),l.parentNode.removeChild(l),c}n=f.createTextNode(i.data.substring(0,e.startNodeIndex)),a=f.createTextNode(d.data.substring(e.endNodeIndex));for(var s=t(i.data.substring(e.startNodeIndex),o),u=[],h=0,m=e.innerNodes.length;m>h;++h){var g=e.innerNodes[h],p=t(g.data,o);g.parentNode.replaceChild(p,g),u.push(p)}var x=t(d.data.substring(0,e.endNodeIndex),o);return r=i.parentNode,r.insertBefore(n,i),r.insertBefore(s,i),r.removeChild(i),r=d.parentNode,r.insertBefore(x,d),r.insertBefore(a,d),r.removeChild(d),x}}var c,s,f,u,h,m,g=[],p=0;if(f=t.ownerDocument,u=r.getBlockElements(),h=r.getWhiteSpaceElements(),m=r.getShortEndedElements(),s=d(t)){if(e.global)for(;c=e.exec(s);)g.push(i(c,a));else c=s.match(e),g.push(i(c,a));return g.length&&(p=g.length,o(t,g,l(n))),p}}function t(t){function n(){function e(){r.statusbar.find("#next").disabled(!d(s+1).length),r.statusbar.find("#prev").disabled(!d(s-1).length)}function n(){tinymce.ui.MessageBox.alert("Could not find the specified string.",function(){r.find("#find")[0].focus()})}var a={},r=tinymce.ui.Factory.create({type:"window",layout:"flex",pack:"center",align:"center",onClose:function(){t.focus(),c.done()},onSubmit:function(t){var i,o,l,f;return t.preventDefault(),o=r.find("#case").checked(),f=r.find("#words").checked(),l=r.find("#find").value(),l.length?a.text==l&&a.caseState==o&&a.wholeWord==f?0===d(s+1).length?(n(),void 0):(c.next(),e(),void 0):(i=c.find(l,o,f),i||n(),r.statusbar.items().slice(1).disabled(0===i),e(),a={text:l,caseState:o,wholeWord:f},void 0):(c.done(!1),r.statusbar.items().slice(1).disabled(!0),void 0)},buttons:[{text:"Find",onclick:function(){r.submit()}},{text:"Replace",disabled:!0,onclick:function(){c.replace(r.find("#replace").value())||(r.statusbar.items().slice(1).disabled(!0),s=-1,a={})}},{text:"Replace all",disabled:!0,onclick:function(){c.replace(r.find("#replace").value(),!0,!0),r.statusbar.items().slice(1).disabled(!0),a={}}},{type:"spacer",flex:1},{text:"Prev",name:"prev",disabled:!0,onclick:function(){c.prev(),e()}},{text:"Next",name:"next",disabled:!0,onclick:function(){c.next(),e()}}],title:"Find and replace",items:{type:"form",padding:20,labelGap:30,spacing:10,items:[{type:"textbox",name:"find",size:40,label:"Find",value:t.selection.getNode().src},{type:"textbox",name:"replace",size:40,label:"Replace with"},{type:"checkbox",name:"case",text:"Match case",label:" "},{type:"checkbox",name:"words",text:"Whole words",label:" "}]}}).renderTo().reflow()}function a(e){var t=e.getAttribute("data-mce-index");return"number"==typeof t?""+t:t}function r(n){var a,r;return r=t.dom.create("span",{"data-mce-bogus":1}),r.className="mce-match-marker",a=t.getBody(),c.done(!1),e(n,a,r,!1,t.schema)}function i(e){var t=e.parentNode;t.insertBefore(e.firstChild,e),e.parentNode.removeChild(e)}function d(e){var n,r=[];if(n=tinymce.toArray(t.getBody().getElementsByTagName("span")),n.length)for(var i=0;i<n.length;i++){var d=a(n[i]);null!==d&&d.length&&d===e.toString()&&r.push(n[i])}return r}function o(e){var n=s,a=t.dom;e=e!==!1,e?n++:n--,a.removeClass(d(s),"mce-match-marker-selected");var r=d(n);return r.length?(a.addClass(d(n),"mce-match-marker-selected"),t.selection.scrollIntoView(r[0]),n):-1}function l(e){e.parentNode.removeChild(e)}var c=this,s=-1;c.init=function(e){e.addMenuItem("searchreplace",{text:"Find and replace",shortcut:"Ctrl+F",onclick:n,separator:"before",context:"edit"}),e.addButton("searchreplace",{tooltip:"Find and replace",shortcut:"Ctrl+F",onclick:n}),e.addCommand("SearchReplace",n),e.shortcuts.add("Ctrl+F","",n)},c.find=function(e,t,n){e=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=n?"\\b"+e+"\\b":e;var a=r(new RegExp(e,t?"g":"gi"));return a&&(s=-1,s=o(!0)),a},c.next=function(){var e=o(!0);-1!==e&&(s=e)},c.prev=function(){var e=o(!1);-1!==e&&(s=e)},c.replace=function(e,n,r){var o,f,u,h,m,g,p=s;for(n=n!==!1,u=t.getBody(),f=tinymce.toArray(u.getElementsByTagName("span")),o=0;o<f.length;o++){var x=a(f[o]);if(null!==x&&x.length)if(h=m=parseInt(x,10),r||h===s){for(e.length?(f[o].firstChild.nodeValue=e,i(f[o])):l(f[o]);f[++o];)if(h=a(f[o]),null!==x&&x.length){if(h!==m){o--;break}l(f[o])}n&&p--}else m>s&&f[o].setAttribute("data-mce-index",m-1)}return t.undoManager.add(),s=p,n?(g=d(p+1).length>0,c.next()):(g=d(p-1).length>0,c.prev()),!r&&g},c.done=function(e){var n,r,d,o;for(r=tinymce.toArray(t.getBody().getElementsByTagName("span")),n=0;n<r.length;n++){var l=a(r[n]);null!==l&&l.length&&(l===s.toString()&&(d||(d=r[n].firstChild),o=r[n].firstChild),i(r[n]))}if(d&&o){var c=t.dom.createRng();return c.setStart(d,0),c.setEnd(o,o.data.length),e!==!1&&t.selection.setRng(c),c}}}tinymce.PluginManager.add("searchreplace",t)}();
tinymce.PluginManager.add("code",function(e){function o(){e.windowManager.open({title:"Source code",body:{type:"textbox",name:"code",multiline:!0,minWidth:e.getParam("code_dialog_width",600),minHeight:e.getParam("code_dialog_height",Math.min(tinymce.DOM.getViewPort().h-200,500)),value:e.getContent({source_view:!0}),spellcheck:!1,style:"direction: ltr; text-align: left"},onSubmit:function(o){e.focus(),e.undoManager.transact(function(){e.setContent(o.data.code)}),e.selection.setCursorLocation(),e.nodeChanged()}})}e.addCommand("mceCodeEditor",o),e.addButton("code",{icon:"code",tooltip:"Source code",onclick:o}),e.addMenuItem("code",{icon:"code",text:"Source code",context:"tools",onclick:o})});
tinymce.PluginManager.add("insertdatetime",function(e){function t(t,a){function n(e,t){if(e=""+e,e.length<t)for(var a=0;a<t-e.length;a++)e="0"+e;return e}return a=a||new Date,t=t.replace("%D","%m/%d/%Y"),t=t.replace("%r","%I:%M:%S %p"),t=t.replace("%Y",""+a.getFullYear()),t=t.replace("%y",""+a.getYear()),t=t.replace("%m",n(a.getMonth()+1,2)),t=t.replace("%d",n(a.getDate(),2)),t=t.replace("%H",""+n(a.getHours(),2)),t=t.replace("%M",""+n(a.getMinutes(),2)),t=t.replace("%S",""+n(a.getSeconds(),2)),t=t.replace("%I",""+((a.getHours()+11)%12+1)),t=t.replace("%p",""+(a.getHours()<12?"AM":"PM")),t=t.replace("%B",""+e.translate(u[a.getMonth()])),t=t.replace("%b",""+e.translate(m[a.getMonth()])),t=t.replace("%A",""+e.translate(c[a.getDay()])),t=t.replace("%a",""+e.translate(i[a.getDay()])),t=t.replace("%%","%")}function a(a){var n=t(a);if(e.settings.insertdatetime_element){var r;r=/%[HMSIp]/.test(a)?t("%Y-%m-%dT%H:%M"):t("%Y-%m-%d"),n='<time datetime="'+r+'">'+n+"</time>";var i=e.dom.getParent(e.selection.getStart(),"time");if(i)return e.dom.setOuterHTML(i,n),void 0}e.insertContent(n)}var n,r,i="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),c="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),m="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),u="January February March April May June July August September October November December".split(" "),d=[];e.addCommand("mceInsertDate",function(){a(e.getParam("insertdatetime_dateformat",e.translate("%Y-%m-%d")))}),e.addCommand("mceInsertTime",function(){a(e.getParam("insertdatetime_timeformat",e.translate("%H:%M:%S")))}),e.addButton("inserttime",{type:"splitbutton",title:"Insert time",onclick:function(){a(n||r)},menu:d}),tinymce.each(e.settings.insertdatetime_formats||["%H:%M:%S","%Y-%m-%d","%I:%M:%S %p","%D"],function(e){r||(r=e),d.push({text:t(e),onclick:function(){n=e,a(e)}})}),e.addMenuItem("insertdatetime",{icon:"date",text:"Insert date/time",menu:d,context:"insert"})});
tinymce.PluginManager.add("contextmenu",function(e){var n,t=e.settings.contextmenu_never_use_native;e.on("contextmenu",function(o){var i;if(!o.ctrlKey||t){if(o.preventDefault(),i=e.settings.contextmenu||"link image inserttable | cell row column deletetable",n)n.show();else{var c=[];tinymce.each(i.split(/[ ,]/),function(n){var t=e.menuItems[n];"|"==n&&(t={text:n}),t&&(t.shortcut="",c.push(t))});for(var a=0;a<c.length;a++)"|"==c[a].text&&(0===a||a==c.length-1)&&c.splice(a,1);n=new tinymce.ui.Menu({items:c,context:"contextmenu"}),n.addClass("contextmenu"),n.renderTo(document.body),e.on("remove",function(){n.remove(),n=null})}var l={x:o.pageX,y:o.pageY};e.inline||(l=tinymce.DOM.getPos(e.getContentAreaContainer()),l.x+=o.clientX,l.y+=o.clientY),n.moveTo(l.x,l.y)}})});
tinymce.PluginManager.add("directionality",function(e){function t(t){var n,o=e.dom,i=e.selection.getSelectedBlocks();i.length&&(n=o.getAttrib(i[0],"dir"),tinymce.each(i,function(e){o.getParent(e.parentNode,"*[dir='"+t+"']",o.getRoot())||(n!=t?o.setAttrib(e,"dir",t):o.setAttrib(e,"dir",null))}),e.nodeChanged())}function n(e){var t=[];return tinymce.each("h1 h2 h3 h4 h5 h6 div p".split(" "),function(n){t.push(n+"[dir="+e+"]")}),t.join(",")}e.addCommand("mceDirectionLTR",function(){t("ltr")}),e.addCommand("mceDirectionRTL",function(){t("rtl")}),e.addButton("ltr",{title:"Left to right",cmd:"mceDirectionLTR",stateSelector:n("ltr")}),e.addButton("rtl",{title:"Right to left",cmd:"mceDirectionRTL",stateSelector:n("rtl")})});
/**
 * theme.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.ThemeManager.add('modern', function(editor) {
	var self = this, settings = editor.settings, Factory = tinymce.ui.Factory, each = tinymce.each, DOM = tinymce.DOM;

	// Default menus
	var defaultMenus = {
		file: {title: 'File', items: 'newdocument'},
		edit: {title: 'Edit', items: 'undo redo | selectall'},
		insert: {title: 'Insert', items: '|'},
		view: {title: 'View', items: 'visualaid |'},
		format: {title: 'Format', items: 'bold italic underline strikethrough superscript subscript | formats | removeformat'},
		table: {title: 'Table'},
		tools: {title: 'Tools'}
	};

	var defaultToolbar = "undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | " +
		"bullist numlist outdent indent | link image";

	/**
	 * Creates the toolbars from config and returns a toolbar array.
	 *
	 * @return {Array} Array with toolbars.
	 */
	function createToolbars() {
		var toolbars = [];

		function addToolbar(items) {
			var toolbarItems = [], buttonGroup;

			if (!items) {
				return;
			}

			each(items.split(/[ ,]/), function(item) {
				var itemName;

				function bindSelectorChanged() {
					var selection = editor.selection;

					if (itemName == "bullist") {
						selection.selectorChanged('ul > li', function(state, args) {
							var nodeName, i = args.parents.length;

							while (i--) {
								nodeName = args.parents[i].nodeName;
								if (nodeName == "OL" || nodeName == "UL") {
									break;
								}
							}

							item.active(state && nodeName == "UL");
						});
					}

					if (itemName == "numlist") {
						selection.selectorChanged('ol > li', function(state, args) {
							var nodeName, i = args.parents.length;

							while (i--) {
								nodeName = args.parents[i].nodeName;
								if (nodeName == "OL" || nodeName == "UL") {
									break;
								}
							}

							item.active(state && nodeName == "OL");
						});
					}

					if (item.settings.stateSelector) {
						selection.selectorChanged(item.settings.stateSelector, function(state) {
							item.active(state);
						}, true);
					}

					if (item.settings.disabledStateSelector) {
						selection.selectorChanged(item.settings.disabledStateSelector, function(state) {
							item.disabled(state);
						});
					}
				}

				if (item == "|") {
					buttonGroup = null;
				} else {
					if (Factory.has(item)) {
						item = {type: item};

						if (settings.toolbar_items_size) {
							item.size = settings.toolbar_items_size;
						}

						toolbarItems.push(item);
						buttonGroup = null;
					} else {
						if (!buttonGroup) {
							buttonGroup = {type: 'buttongroup', items: []};
							toolbarItems.push(buttonGroup);
						}

						if (editor.buttons[item]) {
							// TODO: Move control creation to some UI class
							itemName = item;
							item = editor.buttons[itemName];

							if (typeof(item) == "function") {
								item = item();
							}

							item.type = item.type || 'button';

							if (settings.toolbar_items_size) {
								item.size = settings.toolbar_items_size;
							}

							item = Factory.create(item);
							buttonGroup.items.push(item);

							if (editor.initialized) {
								bindSelectorChanged();
							} else {
								editor.on('init', bindSelectorChanged);
							}
						}
					}
				}
			});

			toolbars.push({type: 'toolbar', layout: 'flow', items: toolbarItems});

			return true;
		}

		// Generate toolbar<n>
		for (var i = 1; i < 10; i++) {
			if (!addToolbar(settings["toolbar" + i])) {
				break;
			}
		}

		// Generate toolbar or default toolbar
		if (!toolbars.length) {
			addToolbar(settings.toolbar || defaultToolbar);
		}

		return toolbars;
	}

	/**
	 * Creates the menu buttons based on config.
	 *
	 * @return {Array} Menu buttons array.
	 */
	function createMenuButtons() {
		var name, menuButtons = [];

		function createMenuItem(name) {
			var menuItem;

			if (name == '|') {
				return {text: '|'};
			}

			menuItem = editor.menuItems[name];

			return menuItem;
		}

		function createMenu(context) {
			var menuButton, menu, menuItems, isUserDefined, removedMenuItems;

			removedMenuItems = tinymce.makeMap((settings.removed_menuitems || '').split(/[ ,]/));

			// User defined menu
			if (settings.menu) {
				menu = settings.menu[context];
				isUserDefined = true;
			} else {
				menu = defaultMenus[context];
			}

			if (menu) {
				menuButton = {text: menu.title};
				menuItems = [];

				// Default/user defined items
				each((menu.items || '').split(/[ ,]/), function(item) {
					var menuItem = createMenuItem(item);

					if (menuItem && !removedMenuItems[item]) {
						menuItems.push(createMenuItem(item));
					}
				});

				// Added though context
				if (!isUserDefined) {
					each(editor.menuItems, function(menuItem) {
						if (menuItem.context == context) {
							if (menuItem.separator == 'before') {
								menuItems.push({text: '|'});
							}

							if (menuItem.prependToContext) {
								menuItems.unshift(menuItem);
							} else {
								menuItems.push(menuItem);
							}

							if (menuItem.separator == 'after') {
								menuItems.push({text: '|'});
							}
						}
					});
				}

				for (var i = 0; i < menuItems.length; i++) {
					if (menuItems[i].text == '|') {
						if (i === 0 || i == menuItems.length - 1) {
							menuItems.splice(i, 1);
						}
					}
				}

				menuButton.menu = menuItems;

				if (!menuButton.menu.length) {
					return null;
				}
			}

			return menuButton;
		}

		var defaultMenuBar = [];
		if (settings.menu) {
			for (name in settings.menu) {
				defaultMenuBar.push(name);
			}
		} else {
			for (name in defaultMenus) {
				defaultMenuBar.push(name);
			}
		}

		var enabledMenuNames = typeof(settings.menubar) == "string" ? settings.menubar.split(/[ ,]/) : defaultMenuBar;
		for (var i = 0; i < enabledMenuNames.length; i++) {
			var menu = enabledMenuNames[i];
			menu = createMenu(menu);

			if (menu) {
				menuButtons.push(menu);
			}
		}

		return menuButtons;
	}

	/**
	 * Adds accessibility shortcut keys to panel.
	 *
	 * @param {tinymce.ui.Panel} panel Panel to add focus to.
	 */
	function addAccessibilityKeys(panel) {
		function focus(type) {
			var item = panel.find(type)[0];

			if (item) {
				item.focus();
			}
		}

		editor.shortcuts.add('Alt+F9', '', function() {
			focus('menubar');
		});

		editor.shortcuts.add('Alt+F10', '', function() {
			focus('toolbar');
		});

		editor.shortcuts.add('Alt+F11', '', function() {
			focus('elementpath');
		});

		panel.on('cancel', function() {
			editor.focus();
		});
	}

	/**
	 * Resizes the editor to the specified width, height.
	 */
	function resizeTo(width, height) {
		var containerElm, iframeElm, containerSize, iframeSize;

		function getSize(elm) {
			return {
				width: elm.clientWidth,
				height: elm.clientHeight
			};
		}

		containerElm = editor.getContainer();
		iframeElm = editor.getContentAreaContainer().firstChild;
		containerSize = getSize(containerElm);
		iframeSize = getSize(iframeElm);

		if (width !== null) {
			width = Math.max(settings.min_width || 100, width);
			width = Math.min(settings.max_width || 0xFFFF, width);

			DOM.css(containerElm, 'width', width + (containerSize.width - iframeSize.width));
			DOM.css(iframeElm, 'width', width);
		}

		height = Math.max(settings.min_height || 100, height);
		height = Math.min(settings.max_height || 0xFFFF, height);
		DOM.css(iframeElm, 'height', height);

		editor.fire('ResizeEditor');
	}

	function resizeBy(dw, dh) {
		var elm = editor.getContentAreaContainer();
		self.resizeTo(elm.clientWidth + dw, elm.clientHeight + dh);
	}

	/**
	 * Renders the inline editor UI.
	 *
	 * @return {Object} Name/value object with theme data.
	 */
	function renderInlineUI(args) {
		var panel, inlineToolbarContainer;

		if (settings.fixed_toolbar_container) {
			inlineToolbarContainer = DOM.select(settings.fixed_toolbar_container)[0];
		}

		function reposition() {
			if (panel && panel.moveRel && panel.visible() && !panel._fixed) {
				// TODO: This is kind of ugly and doesn't handle multiple scrollable elements
				var scrollContainer = editor.selection.getScrollContainer(), body = editor.getBody();
				var deltaX = 0, deltaY = 0;

				if (scrollContainer) {
					var bodyPos = DOM.getPos(body), scrollContainerPos = DOM.getPos(scrollContainer);

					deltaX = Math.max(0, scrollContainerPos.x - bodyPos.x);
					deltaY = Math.max(0, scrollContainerPos.y - bodyPos.y);
				}

				panel.fixed(false).moveRel(body, editor.rtl ? ['tr-br', 'br-tr'] : ['tl-bl', 'bl-tl']).moveBy(deltaX, deltaY);
			}
		}

		function show() {
			if (panel) {
				panel.show();
				reposition();
				DOM.addClass(editor.getBody(), 'mce-edit-focus');
			}
		}

		function hide() {
			if (panel) {
				panel.hide();
				DOM.removeClass(editor.getBody(), 'mce-edit-focus');
			}
		}

		function render() {
			if (panel) {
				if (!panel.visible()) {
					show();
				}

				return;
			}

			// Render a plain panel inside the inlineToolbarContainer if it's defined
			panel = self.panel = Factory.create({
				type: inlineToolbarContainer ? 'panel' : 'floatpanel',
				classes: 'tinymce tinymce-inline',
				layout: 'flex',
				direction: 'column',
				align: 'stretch',
				autohide: false,
				autofix: true,
				fixed: !!inlineToolbarContainer,
				border: 1,
				items: [
					settings.menubar === false ? null : {type: 'menubar', border: '0 0 1 0', items: createMenuButtons()},
					settings.toolbar === false ? null : {
						type: 'panel', layout: 'stack', classes: "toolbar-grp", items: createToolbars()
					}
				]
			});

			// Add statusbar
			/*if (settings.statusbar !== false) {
				panel.add({type: 'panel', classes: 'statusbar', layout: 'flow', border: '1 0 0 0', items: [
					{type: 'elementpath'}
				]});
			}*/

			editor.fire('BeforeRenderUI');
			panel.renderTo(inlineToolbarContainer || document.body).reflow();

			addAccessibilityKeys(panel);
			show();

			editor.on('nodeChange', reposition);
			editor.on('activate', show);
			editor.on('deactivate', hide);

			editor.nodeChanged();
		}

		settings.content_editable = true;

		editor.on('focus', function() {
			// Render only when the CSS file has been loaded
			if (args.skinUiCss) {
				tinymce.DOM.styleSheetLoader.load(args.skinUiCss, render, render);
			} else {
				render();
			}
		});

		editor.on('blur', hide);

		// Remove the panel when the editor is removed
		editor.on('remove', function() {
			if (panel) {
				panel.remove();
				panel = null;
			}
		});

		// Preload skin css
		if (args.skinUiCss) {
			tinymce.DOM.styleSheetLoader.load(args.skinUiCss);
		}

		return {};
	}

	/**
	 * Renders the iframe editor UI.
	 *
	 * @param {Object} args Details about target element etc.
	 * @return {Object} Name/value object with theme data.
	 */
	function renderIframeUI(args) {
		var panel, resizeHandleCtrl, startSize;

		if (args.skinUiCss) {
			tinymce.DOM.loadCSS(args.skinUiCss);
		}

		// Basic UI layout
		panel = self.panel = Factory.create({
			type: 'panel',
			classes: 'tinymce',
			style: 'visibility: hidden',
			layout: 'stack',
			border: 1,
			items: [
				settings.menubar === false ? null : {type: 'menubar', border: '0 0 1 0', items: createMenuButtons()},
				settings.toolbar === false ? null : {type: 'panel', layout: 'stack', classes: "toolbar-grp", items: createToolbars()},
				{type: 'panel', name: 'iframe', layout: 'stack', classes: 'edit-area', html: '', border: '1 0 0 0'}
			]
		});

		if (settings.resize !== false) {
			resizeHandleCtrl = {
				type: 'resizehandle',
				direction: settings.resize,

				onResizeStart: function() {
					var elm = editor.getContentAreaContainer().firstChild;

					startSize = {
						width: elm.clientWidth,
						height: elm.clientHeight
					};
				},

				onResize: function(e) {
					if (settings.resize == 'both') {
						resizeTo(startSize.width + e.deltaX, startSize.height + e.deltaY);
					} else {
						resizeTo(null, startSize.height + e.deltaY);
					}
				}
			};
		}

		// Add statusbar if needed
		if (settings.statusbar !== false) {
			panel.add({type: 'panel', name: 'statusbar', classes: 'statusbar', layout: 'flow', border: '1 0 0 0', items: [
				{type: 'elementpath'},
				resizeHandleCtrl
			]});
		}

		if (settings.readonly) {
			panel.find('*').disabled(true);
		}

		editor.fire('BeforeRenderUI');
		panel.renderBefore(args.targetNode).reflow();

		if (settings.width) {
			tinymce.DOM.setStyle(panel.getEl(), 'width', settings.width);
		}

		// Remove the panel when the editor is removed
		editor.on('remove', function() {
			panel.remove();
			panel = null;
		});

		// Add accesibility shortkuts
		addAccessibilityKeys(panel);

		return {
			iframeContainer: panel.find('#iframe')[0].getEl(),
			editorContainer: panel.getEl()
		};
	}

	/**
	 * Renders the UI for the theme. This gets called by the editor.
	 *
	 * @param {Object} args Details about target element etc.
	 * @return {Object} Theme UI data items.
	 */
	self.renderUI = function(args) {
		var skin = settings.skin !== false ? settings.skin || 'lightgray' : false;

		if (skin) {
			var skinUrl = settings.skin_url;

			if (skinUrl) {
				skinUrl = editor.documentBaseURI.toAbsolute(skinUrl);
			} else {
				skinUrl = tinymce.baseURL + '/skins/' + skin;
			}

			// Load special skin for IE7
			// TODO: Remove this when we drop IE7 support
			if (tinymce.Env.documentMode <= 7) {
				args.skinUiCss = skinUrl + '/skin.ie7.min.css';
			} else {
				args.skinUiCss = skinUrl + '/skin.min.css';
			}

			// Load content.min.css or content.inline.min.css
			editor.contentCSS.push(skinUrl + '/content' + (editor.inline ? '.inline' : '') + '.min.css');
		}

		// Handle editor setProgressState change
		editor.on('ProgressState', function(e) {
			self.throbber = self.throbber || new tinymce.ui.Throbber(self.panel.getEl('body'));

			if (e.state) {
				self.throbber.show(e.time);
			} else {
				self.throbber.hide();
			}
		});

		if (settings.inline) {
			return renderInlineUI(args);
		}

		return renderIframeUI(args);
	};

	self.resizeTo = resizeTo;
	self.resizeBy = resizeBy;
});
﻿/*!
 * jQuery blockUI plugin
 * Version 2.33 (29-MAR-2010)
 * @requires jQuery v1.2.3 or later
 *
 * Examples at: http://malsup.com/jquery/block/
 * Copyright (c) 2007-2008 M. Alsup
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * Thanks to Amir-Hossein Sobhi for some excellent contributions!
 */

;(function($) {

if (/1\.(0|1|2)\.(0|1|2)/.test($.fn.jquery) || /^1.1/.test($.fn.jquery)) {
	alert('blockUI requires jQuery v1.2.3 or later!  You are using v' + $.fn.jquery);
	return;
}

$.fn._fadeIn = $.fn.fadeIn;

var noOp = function() {};

// this bit is to ensure we don't call setExpression when we shouldn't (with extra muscle to handle
// retarded userAgent strings on Vista)
var mode = document.documentMode || 0;
var setExpr = $.browser.msie && (($.browser.version < 8 && !mode) || mode < 8);
var ie6 = $.browser.msie && /MSIE 6.0/.test(navigator.userAgent) && !mode;

// global $ methods for blocking/unblocking the entire page
$.blockUI   = function(opts) { install(window, opts); };
$.unblockUI = function(opts) { remove(window, opts); };

// convenience method for quick growl-like notifications  (http://www.google.com/search?q=growl)
$.growlUI = function(title, message, timeout, onClose) {
	var $m = $('<div class="growlUI"></div>');
	if (title) $m.append('<h1>'+title+'</h1>');
	if (message) $m.append('<h2>'+message+'</h2>');
	if (timeout == undefined) timeout = 3000;
	$.blockUI({
		message: $m, fadeIn: 700, fadeOut: 1000, centerY: false,
		timeout: timeout, showOverlay: false,
		onUnblock: onClose, 
		css: $.blockUI.defaults.growlCSS
	});
};

// plugin method for blocking element content
$.fn.block = function(opts) {
	return this.unblock({ fadeOut: 0 }).each(function() {
		if ($.css(this,'position') == 'static')
			this.style.position = 'relative';
		if ($.browser.msie)
			this.style.zoom = 1; // force 'hasLayout'
		install(this, opts);
	});
};

// plugin method for unblocking element content
$.fn.unblock = function(opts) {
	return this.each(function() {
		remove(this, opts);
	});
};

$.blockUI.version = 2.33; // 2nd generation blocking at no extra cost!

// override these in your code to change the default behavior and style
$.blockUI.defaults = {
	// message displayed when blocking (use null for no message)
	message:  '<h1>Please wait...</h1>',

	title: null,	  // title string; only used when theme == true
	draggable: true,  // only used when theme == true (requires jquery-ui.js to be loaded)
	
	theme: false, // set to true to use with jQuery UI themes
	
	// styles for the message when blocking; if you wish to disable
	// these and use an external stylesheet then do this in your code:
	// $.blockUI.defaults.css = {};
	css: {
		padding:	0,
		margin:		0,
		width:		'30%',
		top:		'40%',
		left:		'35%',
		textAlign:	'center',
		color:		'#000',
		border:		'3px solid #aaa',
		backgroundColor:'#fff',
		cursor:		'wait'
	},
	
	// minimal style set used when themes are used
	themedCSS: {
		width:	'30%',
		top:	'40%',
		left:	'35%'
	},

	// styles for the overlay
	overlayCSS:  {
		background: '#fff url(/images/dashboard/common/spinner_blue.gif) center center no-repeat',
		opacity:	  	 0.8,
		cursor:		  	 'wait'
	},

	// styles applied when using $.growlUI
	growlCSS: {
		width:  	'350px',
		top:		'10px',
		left:   	'',
		right:  	'10px',
		border: 	'none',
		padding:	'5px',
		opacity:	0.6,
		cursor: 	'default',
		color:		'#fff',
		backgroundColor: '#000',
		'-webkit-border-radius': '10px',
		'-moz-border-radius':	 '10px',
		'border-radius': 		 '10px'
	},
	
	// IE issues: 'about:blank' fails on HTTPS and javascript:false is s-l-o-w
	// (hat tip to Jorge H. N. de Vasconcelos)
	iframeSrc: /^https/i.test(window.location.href || '') ? 'javascript:false' : 'about:blank',

	// force usage of iframe in non-IE browsers (handy for blocking applets)
	forceIframe: false,

	// z-index for the blocking overlay
	baseZ: 1000,

	// set these to true to have the message automatically centered
	centerX: true, // <-- only effects element blocking (page block controlled via css above)
	centerY: true,

	// allow body element to be stetched in ie6; this makes blocking look better
	// on "short" pages.  disable if you wish to prevent changes to the body height
	allowBodyStretch: true,

	// enable if you want key and mouse events to be disabled for content that is blocked
	bindEvents: true,

	// be default blockUI will supress tab navigation from leaving blocking content
	// (if bindEvents is true)
	constrainTabKey: true,

	// fadeIn time in millis; set to 0 to disable fadeIn on block
	fadeIn:  100,

	// fadeOut time in millis; set to 0 to disable fadeOut on unblock
	fadeOut:  100,

	// time in millis to wait before auto-unblocking; set to 0 to disable auto-unblock
	timeout: 0,

	// disable if you don't want to show the overlay
	showOverlay: true,

	// if true, focus will be placed in the first available input field when
	// page blocking
	focusInput: true,

	// suppresses the use of overlay styles on FF/Linux (due to performance issues with opacity)
	applyPlatformOpacityRules: true,
	
	// callback method invoked when fadeIn has completed and blocking message is visible
	onBlock: null,

	// callback method invoked when unblocking has completed; the callback is
	// passed the element that has been unblocked (which is the window object for page
	// blocks) and the options that were passed to the unblock call:
	//	 onUnblock(element, options)
	onUnblock: null,

	// don't ask; if you really must know: http://groups.google.com/group/jquery-en/browse_thread/thread/36640a8730503595/2f6a79a77a78e493#2f6a79a77a78e493
	quirksmodeOffsetHack: 4
};

// private data and functions follow...

var pageBlock = null;
var pageBlockEls = [];

function install(el, opts) {
	var full = (el == window);
	var msg = opts && opts.message !== undefined ? opts.message : undefined;
	opts = $.extend({}, $.blockUI.defaults, opts || {});
	opts.overlayCSS = $.extend({}, $.blockUI.defaults.overlayCSS, opts.overlayCSS || {});
	var css = $.extend({}, $.blockUI.defaults.css, opts.css || {});
	var themedCSS = $.extend({}, $.blockUI.defaults.themedCSS, opts.themedCSS || {});
	msg = msg === undefined ? opts.message : msg;

	// remove the current block (if there is one)
	if (full && pageBlock)
		remove(window, {fadeOut:0});

	// if an existing element is being used as the blocking content then we capture
	// its current place in the DOM (and current display style) so we can restore
	// it when we unblock
	if (msg && typeof msg != 'string' && (msg.parentNode || msg.jquery)) {
		var node = msg.jquery ? msg[0] : msg;
		var data = {};
		$(el).data('blockUI.history', data);
		data.el = node;
		data.parent = node.parentNode;
		data.display = node.style.display;
		data.position = node.style.position;
		if (data.parent)
			data.parent.removeChild(node);
	}

	var z = opts.baseZ;

	// blockUI uses 3 layers for blocking, for simplicity they are all used on every platform;
	// layer1 is the iframe layer which is used to supress bleed through of underlying content
	// layer2 is the overlay layer which has opacity and a wait cursor (by default)
	// layer3 is the message content that is displayed while blocking

	var lyr1 = ($.browser.msie || opts.forceIframe) 
		? $('<iframe class="blockUI" style="z-index:'+ (z++) +';display:none;border:none;margin:0;padding:0;position:absolute;width:100%;height:100%;top:0;left:0" src="'+opts.iframeSrc+'"></iframe>')
		: $('<div class="blockUI" style="display:none"></div>');
	var lyr2 = $('<div class="blockUI blockOverlay" style="z-index:'+ (z++) +';display:none;border:none;margin:0;padding:0;width:100%;height:100%;top:0;left:0"></div>');
	
	var lyr3, s;
	if (opts.theme && full) {
		s = '<div class="blockUI blockMsg blockPage ui-dialog ui-widget ui-corner-all" style="z-index:'+z+';display:none;position:fixed">' +
				'<div class="ui-widget-header ui-dialog-titlebar blockTitle">'+(opts.title || '&nbsp;')+'</div>' +
				'<div class="ui-widget-content ui-dialog-content"></div>' +
			'</div>';
	}
	else if (opts.theme) {
		s = '<div class="blockUI blockMsg blockElement ui-dialog ui-widget ui-corner-all" style="z-index:'+z+';display:none;position:absolute">' +
				'<div class="ui-widget-header ui-dialog-titlebar blockTitle">'+(opts.title || '&nbsp;')+'</div>' +
				'<div class="ui-widget-content ui-dialog-content"></div>' +
			'</div>';
	}
	else if (full) {
		s = '<div class="blockUI blockMsg blockPage" style="z-index:'+z+';display:none;position:fixed"></div>';
	}			
	else {
		s = '<div class="blockUI blockMsg blockElement" style="z-index:'+z+';display:none;position:absolute"></div>';
	}
	lyr3 = $(s);

	// if we have a message, style it
	if (msg) {
		if (opts.theme) {
			lyr3.css(themedCSS);
			lyr3.addClass('ui-widget-content');
		}
		else 
			lyr3.css(css);
	}

	// style the overlay
	if (!opts.applyPlatformOpacityRules || !($.browser.mozilla && /Linux/.test(navigator.platform)))
		lyr2.css(opts.overlayCSS);
	lyr2.css('position', full ? 'fixed' : 'absolute');

	// make iframe layer transparent in IE
	if ($.browser.msie || opts.forceIframe)
		lyr1.css('opacity',0.0);

	//$([lyr1[0],lyr2[0],lyr3[0]]).appendTo(full ? 'body' : el);
	var layers = [lyr1,lyr2,lyr3], $par = full ? $('body') : $(el);
	$.each(layers, function() {
		this.appendTo($par);
	});
	
	if (opts.theme && opts.draggable && $.fn.draggable) {
		lyr3.draggable({
			handle: '.ui-dialog-titlebar',
			cancel: 'li'
		});
	}

	// ie7 must use absolute positioning in quirks mode and to account for activex issues (when scrolling)
	var expr = setExpr && (!$.boxModel || $('object,embed', full ? null : el).length > 0);
	if (ie6 || expr) {
		// give body 100% height
		if (full && opts.allowBodyStretch && $.boxModel)
			$('html,body').css('height','100%');

		// fix ie6 issue when blocked element has a border width
		if ((ie6 || !$.boxModel) && !full) {
			var t = sz(el,'borderTopWidth'), l = sz(el,'borderLeftWidth');
			var fixT = t ? '(0 - '+t+')' : 0;
			var fixL = l ? '(0 - '+l+')' : 0;
		}

		// simulate fixed position
		$.each([lyr1,lyr2,lyr3], function(i,o) {
			var s = o[0].style;
			s.position = 'absolute';
			if (i < 2) {
				full ? s.setExpression('height','Math.max(document.body.scrollHeight, document.body.offsetHeight) - (jQuery.boxModel?0:'+opts.quirksmodeOffsetHack+') + "px"')
					 : s.setExpression('height','this.parentNode.offsetHeight + "px"');
				full ? s.setExpression('width','jQuery.boxModel && document.documentElement.clientWidth || document.body.clientWidth + "px"')
					 : s.setExpression('width','this.parentNode.offsetWidth + "px"');
				if (fixL) s.setExpression('left', fixL);
				if (fixT) s.setExpression('top', fixT);
			}
			else if (opts.centerY) {
				if (full) s.setExpression('top','(document.documentElement.clientHeight || document.body.clientHeight) / 2 - (this.offsetHeight / 2) + (blah = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"');
				s.marginTop = 0;
			}
			else if (!opts.centerY && full) {
				var top = (opts.css && opts.css.top) ? parseInt(opts.css.top) : 0;
				var expression = '((document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + '+top+') + "px"';
				s.setExpression('top',expression);
			}
		});
	}

	// show the message
	if (msg) {
		if (opts.theme)
			lyr3.find('.ui-widget-content').append(msg);
		else
			lyr3.append(msg);
		if (msg.jquery || msg.nodeType)
			$(msg).show();
	}

	if (($.browser.msie || opts.forceIframe) && opts.showOverlay)
		lyr1.show(); // opacity is zero
	if (opts.fadeIn) {
		var cb = opts.onBlock ? opts.onBlock : noOp;
		var cb1 = (opts.showOverlay && !msg) ? cb : noOp;
		var cb2 = msg ? cb : noOp;
		if (opts.showOverlay)
			lyr2._fadeIn(opts.fadeIn, cb1);
		if (msg)
			lyr3._fadeIn(opts.fadeIn, cb2);
	}
	else {
		if (opts.showOverlay)
			lyr2.show();
		if (msg)
			lyr3.show();
		if (opts.onBlock)
			opts.onBlock();
	}

	// bind key and mouse events
	bind(1, el, opts);

	if (full) {
		pageBlock = lyr3[0];
		pageBlockEls = $(':input:enabled:visible',pageBlock);
		if (opts.focusInput)
			setTimeout(focus, 20);
	}
	else
		center(lyr3[0], opts.centerX, opts.centerY);

	if (opts.timeout) {
		// auto-unblock
		var to = setTimeout(function() {
			full ? $.unblockUI(opts) : $(el).unblock(opts);
		}, opts.timeout);
		$(el).data('blockUI.timeout', to);
	}
};

// remove the block
function remove(el, opts) {
	var full = (el == window);
	var $el = $(el);
	var data = $el.data('blockUI.history');
	var to = $el.data('blockUI.timeout');
	if (to) {
		clearTimeout(to);
		$el.removeData('blockUI.timeout');
	}
	opts = $.extend({}, $.blockUI.defaults, opts || {});
	bind(0, el, opts); // unbind events
	
	var els;
	if (full) // crazy selector to handle odd field errors in ie6/7
		els = $('body').children().filter('.blockUI').add('body > .blockUI');
	else
		els = $('.blockUI', el);

	if (full)
		pageBlock = pageBlockEls = null;

	if (opts.fadeOut) {
		els.fadeOut(opts.fadeOut);
		setTimeout(function() { reset(els,data,opts,el); }, opts.fadeOut);
	}
	else
		reset(els, data, opts, el);
};

// move blocking element back into the DOM where it started
function reset(els,data,opts,el) {
	els.each(function(i,o) {
		// remove via DOM calls so we don't lose event handlers
		if (this.parentNode)
			this.parentNode.removeChild(this);
	});

	if (data && data.el) {
		data.el.style.display = data.display;
		data.el.style.position = data.position;
		if (data.parent)
			data.parent.appendChild(data.el);
		$(el).removeData('blockUI.history');
	}

	if (typeof opts.onUnblock == 'function')
		opts.onUnblock(el,opts);
};

// bind/unbind the handler
function bind(b, el, opts) {
	var full = el == window, $el = $(el);

	// don't bother unbinding if there is nothing to unbind
	if (!b && (full && !pageBlock || !full && !$el.data('blockUI.isBlocked')))
		return;
	if (!full)
		$el.data('blockUI.isBlocked', b);

	// don't bind events when overlay is not in use or if bindEvents is false
	if (!opts.bindEvents || (b && !opts.showOverlay)) 
		return;

	// bind anchors and inputs for mouse and key events
	var events = 'mousedown mouseup keydown keypress';
	b ? $(document).bind(events, opts, handler) : $(document).unbind(events, handler);

// former impl...
//	   var $e = $('a,:input');
//	   b ? $e.bind(events, opts, handler) : $e.unbind(events, handler);
};

// event handler to suppress keyboard/mouse events when blocking
function handler(e) {
	// allow tab navigation (conditionally)
	if (e.keyCode && e.keyCode == 9) {
		if (pageBlock && e.data.constrainTabKey) {
			var els = pageBlockEls;
			var fwd = !e.shiftKey && e.target == els[els.length-1];
			var back = e.shiftKey && e.target == els[0];
			if (fwd || back) {
				setTimeout(function(){focus(back)},10);
				return false;
			}
		}
	}
	// allow events within the message content
	if ($(e.target).parents('div.blockMsg').length > 0)
		return true;

	// allow events for content that is not being blocked
	return $(e.target).parents().children().filter('div.blockUI').length == 0;
};

function focus(back) {
	if (!pageBlockEls)
		return;
	var e = pageBlockEls[back===true ? pageBlockEls.length-1 : 0];
	if (e)
		e.focus();
};

function center(el, x, y) {
	var p = el.parentNode, s = el.style;
	var l = ((p.offsetWidth - el.offsetWidth)/2) - sz(p,'borderLeftWidth');
	var t = ((p.offsetHeight - el.offsetHeight)/2) - sz(p,'borderTopWidth');
	if (x) s.left = l > 0 ? (l+'px') : '0';
	if (y) s.top  = t > 0 ? (t+'px') : '0';
};

function sz(el, p) {
	return parseInt($.css(el,p))||0;
};

})(jQuery);
if(!this.JSON){this.JSON={};}
(function(){function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+
partial.join(',\n'+gap)+'\n'+
mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+
mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}
return str('',{'':value});};}
if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('JSON.parse');};}}());(function($){$.fn.tipsy=function(options){options=$.extend({},$.fn.tipsy.defaults,options);return this.each(function(){var opts=$.fn.tipsy.elementOptions(this,options);$(this).hover(function(){$.data(this,'cancel.tipsy',true);var tip=$.data(this,'active.tipsy');if(!tip){tip=$('<div class="tipsy"><div class="tipsy-inner"/></div>');tip.css({position:'absolute',zIndex:100000});$.data(this,'active.tipsy',tip);}
if($(this).attr('title')||typeof($(this).attr('original-title'))!='string'){$(this).attr('original-title',$(this).attr('title')||'').removeAttr('title');}
var title;if(typeof opts.title=='string'){title=$(this).attr(opts.title=='title'?'original-title':opts.title);}else if(typeof opts.title=='function'){title=opts.title.call(this);}
tip.find('.tipsy-inner')[opts.html?'html':'text'](title||opts.fallback);var pos=$.extend({},$(this).offset(),{width:this.offsetWidth,height:this.offsetHeight});tip.get(0).className='tipsy';tip.remove().css({top:0,left:0,visibility:'hidden',display:'block'}).appendTo(document.body);var actualWidth=tip[0].offsetWidth,actualHeight=tip[0].offsetHeight;var gravity=(typeof opts.gravity=='function')?opts.gravity.call(this):opts.gravity;switch(gravity.charAt(0)){case'n':tip.css({top:pos.top+pos.height,left:pos.left+pos.width/2-actualWidth/2}).addClass('tipsy-north');break;case's':tip.css({top:pos.top-actualHeight,left:pos.left+pos.width/2-actualWidth/2}).addClass('tipsy-south');break;case'e':tip.css({top:pos.top+pos.height/2-actualHeight/2,left:pos.left-actualWidth}).addClass('tipsy-east');break;case'w':tip.css({top:pos.top+pos.height/2-actualHeight/2,left:pos.left+pos.width}).addClass('tipsy-west');break;}
if(opts.fade){tip.css({opacity:0,display:'block',visibility:'visible'}).animate({opacity:0.8});}else{tip.css({visibility:'visible'});}},function(){$.data(this,'cancel.tipsy',false);var self=this;setTimeout(function(){if($.data(this,'cancel.tipsy'))return;var tip=$.data(self,'active.tipsy');if(tip){if(opts.fade){tip.stop().fadeOut(function(){$(this).remove();});}else{tip.remove();}}},100);});});};$.fn.tipsy.elementOptions=function(ele,options){return $.metadata?$.extend({},options,$(ele).metadata()):options;};$.fn.tipsy.defaults={fade:false,fallback:'',gravity:'n',html:false,title:'title'};$.fn.tipsy.autoNS=function(){return $(this).offset().top>($(document).scrollTop()+$(window).height()/2)?'s':'n';};$.fn.tipsy.autoWE=function(){return $(this).offset().left>($(document).scrollLeft()+$(window).width()/2)?'e':'w';};})(jQuery);/*
 * Catch any uncaught errors and report them to the server.
 *
 * This code is designed to have as few dependencies as possible; it now relies 
 * only on jQuery. It is placed at the top of this file in order to also catch
 * errors that occur in PA initialization.
 *
 * Everything is wrapped in a closure in order to avoid polluting the global
 * namespace and to insulate the code.
 */
var err_count = 0;
window.onerror = (function() {
  var MAX_COUNT = 2;
  var API_URL = '/logic/api?method=generic.report_js_error&aid=' +
    (new Date()).getTime().toString(36) + Math.round(Math.random() * 1679616).toString(36);

  var reportError = function(params) {
    err_count++;
    if(err_count > MAX_COUNT) {
      return;
    }
    if (params.message && typeof(params.message) == 'string' && params.message.indexOf("Error connecting to extension") >= 0) return; // we don't want these
    params.location = window.location.toString();
    if(PA && PA.user && PA.user.id) {
      params.uid = PA.user.id;
    }
    $.ajax({
      url: API_URL,
      data: JSON.stringify({
        'method': 'generic.report_js_error', 
        'params': params
      }),
      type: 'POST',
      dataType: 'json'
    });
  };

  // catch uncaught JS exceptions (the actual window.onerror)
  return function(message, url, line) {
    reportError({
      type: 'js_exception',
      message: message,
      url: url,
      line: line
    });
  };
})();

PA = {
  apiCache: {},
  eventsToLog: [],
  staticContent: false,
  cookie: false,
  users: {},
  user: {},
  othersId: 0,
  userQueue: [],         // all users I don't know, but need to get
  userCallback: [],
  logApiTimeData: [],
  cacheUser: function(user) {
    PA.users[user.id] = user;
  },

  getCached: function(method, params){
    var cacheKey = method + JSON.stringify(params);
    return PA.apiCache[cacheKey];
  },
  cache: function(method, params, result){
    var cacheKey = method + JSON.stringify(params);
    PA.apiCache[cacheKey] = result;
  },
  regularError: function(err) {
    if (err.indexOf("Session needed") >= 0 || err.indexOf("Not logged in") >= 0) {
      PEM.fire("user_logout");
    } else {
      PEM.fire("error", err);
    }
  },
  badError: function() {
    PEM.fire("timeout");
    if (typeof(console) != 'undefined') console.log("Cannot communicate with main Piazza server. Check your internet connection, or try again later.");
  },
  checkSession: function(err, method) {
    if (method === "user.check_session") return;

    /* When we get session-related errors, check that this client hasn't been logged out in another window. */
    if (err.indexOf("No permission") >= 0 || err.indexOf("Please authenticate") >= 0 || err.indexOf("Action not allowed for unknown users") >= 0) {
      PA.call_pj("user.check_session", {}, 1, function(data) {
        if (data.id !== PA.user.id) { /* Server and client do not match user IDs! */
          //PD.triggerLogoutWarning();
          PEM.fire("user_logout");
        }
      }, function(err) {
        if (err.indexOf("Please authenticate") >= 0) { /* No user logged in, trigger warning. */
          PEM.fire("user_logout");
          //PD.triggerLogoutWarning();
        }
      });
    }
  },

  call_pj: function(method, params, blockObject, callback, error, scope) {
    var start = new Date().getTime();
    //if (typeof(console) != 'undefined') console.log("PA.call_pj method:" + method + ", params:" + JSON.stringify(params));
    var cached = PA.getCached(method, params);
    if(callback && cached && !cached.error && cached.result){  //don't return cached errors
       callback.call(scope, cached.result, cached.aid);
       return;
    }
    if (PA.cookie)
      params.cookie = PA.cookie;
    var data;

    if (PA.eventsToLog.length > 0) {
      data = JSON.stringify({method:method, params:params, logdata:{logevents:PA.eventsToLog}});
      PA.eventsToLog = [];
    }
    else
      data = JSON.stringify({method:method, params:params});

    data = data.replace(/\\u000a/gi, "\\n");
    data = data.replace(/\?/gi, "%3F");
    if (blockObject) {
      if (blockObject != 1 && blockObject.block) blockObject.block();
    } else
      $.blockUI();
    if (PA.staticContent && method != "network.search" && method != "network.filter_feed") {
      var path = "/static/" + PA.staticContent + "/" + method;
      if (params.cid)
        path += "/" + params.cid;
      path += "?t=" + (new Date()).getTime();
      $.ajax({
        url: path,
        type: 'GET',
        success: function(data) {
          if (blockObject) {
            if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
          } else
            $.unblockUI();
          if (data.result && callback)
            callback.call(scope, data.result, "static");

          var end = new Date().getTime();
          var elapsedTime = end - start;
          PA.writeApiTimeData(method,elapsedTime,params);
        },
        error: function(req, status, error) {
          if (blockObject && blockObject != 1)
            if (blockObject.unblock) blockObject.unblock();
          else
            $.unblockUI();
        }
      });
    } else {
      $.ajax({
        url: '/logic/api?method=' + method + '&aid=' + (new Date()).getTime().toString(36) + Math.round(Math.random() * 1679616).toString(36),
        data: data,
        success: function(data) {
          if (blockObject) {
            if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
          } else
            $.unblockUI();
          if ((data.result || data.result === 0) && callback)
            callback.call(scope, data.result, data.aid);
          if (data.error) {
            if (error)
              error.call(scope, data.error);
            else
              PA.regularError(data.error);

            PA.checkSession(data.error, method);
          }
          var end = new Date().getTime();
          var elapsedTime = end - start;
          PA.writeApiTimeData(method,elapsedTime,params,data.aid);
        },
        error: function(req, status, error) {
          // try again first
          setTimeout(function(){
            $.ajax({
              url: '/logic/api?method=' + method + '&aid=' + (new Date()).getTime().toString(36) + Math.round(Math.random() * 1679616).toString(36),
              data: data,
              success: function(data) {
                if (blockObject) {
                  if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
                } else
                  $.unblockUI();
                if (data.result && callback)
                  callback.call(scope, data.result, data.aid);
                if (data.error) {
                  if (error)
                    error.call(scope, data.error);
                  else
                    PA.regularError(data.error);
                }
                var end = new Date().getTime();
                var elapsedTime = end - start;
                PA.writeApiTimeData(method,elapsedTime,params,data.aid);
              },
              error: function(req, status, error) {
                if (blockObject)
                  if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
                else
                  $.unblockUI();
                PA.badError(error);
              }
            });
          }, 3000);
        }
      });
    }
  },

  call: function(method, params, blockObject, callback, error, scope) {
    //XXXXXXXXXXXX
    var start = new Date().getTime();
    if (PA.cookie)
      params.cookie = PA.cookie;
    var data = JSON.stringify({method:method, params:params});
    data = data.replace(/\\u000a/gi, "\\n");
    //if (typeof(PD) != 'undefined' && PD.loading)
    //  blockObject = 1; // do not show any block objects while loading
    //if (PA.user && PA.user.config && PA.user.config.no_spinner)
    //  blockObject = 1;
    if (blockObject) {
      if (blockObject != 1 && blockObject.block) blockObject.block();
    } else
      $.blockUI();
    if (PA.staticContent && method != "network.search") {
      var path = "/static/" + PA.staticContent + "/" + method;
      if (params.cid)
        path += "/" + params.cid
      path += "?t=" + (new Date()).getTime();
      $.ajax({
        url: path,
        type: 'GET',
        success: function(data) {
          if (blockObject) {
            if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
          } else
            $.unblockUI();
          if (data.result && callback)
            callback.call(scope, data.result, "static");

          var end = new Date().getTime();
          var elapsedTime = end - start;
          PA.writeApiTimeData(method,elapsedTime,params,data.aid);
        },
        error: function(req, status, error) {
          if (blockObject && blockObject != 1)
            if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
          else
            $.unblockUI();
        }
      });
    } else {
      $.ajax({
        data: data,
        success: function(data) {
          if (blockObject) {
            if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
          } else
            $.unblockUI();
          if (data.result && callback)
            callback.call(scope, data.result, data.aid);
          if (data.error) {
            if (error)
              error.call(scope, data.error);
            else
              PA.regularError(data.error);
          }
          var end = new Date().getTime();
          var elapsedTime = end - start;
          PA.writeApiTimeData(method,elapsedTime,params,data.aid);
        },
        error: function(req, status, error) {
          if (blockObject && blockObject != 1)
            blockObject.unblock();
          else
            $.unblockUI();
        }
      });
    }
  },
  writeApiTimeData: function(method,elapsedTime,params,aid) {
    if (method == "log.write_time_data")
      return;
    if (typeof(DO_LOG_BOOMERANG_DATA) == 'undefined' || DO_LOG_BOOMERANG_DATA == 0)
      return;
    PA.logApiTimeData.push([method,elapsedTime,params,aid]);
    if (PA.logApiTimeData.length >= 5) {
      var params = { 
        timeData: PA.logApiTimeData
      };
      PA.call_pj("log.write_time_data", params, 1);
      PA.logApiTimeData = [];
    }
  },
  writeBoomrData: function(boomrObj, params) {
    if (typeof(DO_LOG_BOOMERANG_DATA) == 'undefined' || DO_LOG_BOOMERANG_DATA == 0)
      return;
    var loadJsRegex = /,t_load_js\|(\d+),/;
    var loadJsTimeMatch = boomrObj["t_other"].match(loadJsRegex);
    var loadJsTime = "";
    if (loadJsTimeMatch && loadJsTimeMatch.length > 1) {
      loadJsTime = loadJsTimeMatch[1];
    }
    var params = {
      perceivedLoadTime: boomrObj["t_done"],
      pageReady: boomrObj["t_page"],
      url: boomrObj["u"],
      aid: params["aid"],
      method: params["method"],
      http_verb: params["http_verb"],
      loadJsTime: loadJsTime
    };
    PA.call_pj("log.write_boomerang_data", params, 1);
  },
  getOthersList: function(uids, replaceId) {
    // if we have info about all users, return now. Otherwise, get info and then return.
    PA.othersId += 1;
    var title = "";
    var missing = [];
    for (var i = 0; i < uids.length; i++) {
      if (PA.users[uids[i]]) {
        title += (title.length > 0 ? "<br>" : "") + PA.users[uids[i]].name;
      } else if (uids[i] == "undefined") {
        title += (title.length > 0 ? "<br>" : "") + "Anonymous";
      } else if (uids[i] == "Instructors") {
        title += (title.length > 0 ? "<br>" : "") + "Instructors";
      }else {
        missing.push(uids[i]);
      }
    }
    if (missing.length > 0 && !replaceId) {
      // get missing users, and register callback
      var myId = PA.othersId;
      PA.loadUsers(missing, function() {
        PA.getOthersList(uids, 'others_' + myId);
      });
      return "<a href='#' onclick='return false;' class='others' title='loading...' id='others_" + myId + "'>" + uids.length + " others</a>";
    } else {
      var str = "<a href='#' onclick='return false;' class='others' id='" + replaceId + "' title='" + title + "'>" + uids.length + " others</a>";
      if (replaceId) {
        $('#' + replaceId).replaceWith(str);
        $('#' + replaceId).tooltip({placement: 'bottom', html: true});
      }
      return str;
    }
  },
  getUserName: function(id, anon, my_private_post, incognito_text) {
    if (id == "Instructors")
      return '<span class="user_name">Instructors</span>';
    var html = '';
    html += '<span anon="' + anon + '" class="user_name user_name_' + id ;
    if (anon == "me") {
      if (id == PA.user.id) {
        html += '">You</span>';
        return html;
      }
      anon = "no";
    }
    if (id && (!anon || anon != "full" || id != PA.user.id ) && id != "undefined") {
      if (PA.users[id]) {
        if (anon  == "stud"){
          html += ' user_name_anon anon_box_color">' + PA.users[id].name + '</span><span class="smallText">&nbsp;(anon. to classmates)</span>';
        } else {
          //if (P.modules.network.type != 'group' && !P.modules.network.prof_hash[id])
          //  html += '"><a class="view-profile-link" href="#" onClick="PEM.fire(\'showUserProfile\', \'' + id + '\');return false;" target="_self">' + PA.users[id].name + '</a></span>';
          //else
          html += '">' + PA.users[id].name + '</span>';
        }
      } else {
        html += ' user_loading">Loading...</span>';
        PA.loadUser(id);
      }
    } else if (my_private_post && anon == "stud") {
      if (incognito_text) {
        html += ' user_name_anon anon_box_color" notutorial="anonymous to classmates">you</span>';
      } else {
        html += ' user_name_anon anon_box_color" notutorial="anonymous to classmates">' + PA.user.name + '</span>';
      }
    } else {
      html += ' ">Anonymous </span>';
    }
    return html;
  },
  getUserPic: function(id, no_click, no_resize, no_border) {
    var resize = (no_resize) ? '' : 'onload="onImageLoad(event);"';
    var border = (no_border) ? 'no_border' : 'white_border';

    var html = '<div class="user_pic user_pic_' + id ;
    if (id && id != "0")
      if (PA.users[id]) {
        var imagePath = 'https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/default_user.png';
        if (PA.users[id].email == 'admin') imagePath = 'https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/nerd_small.png';
        if (PA.users[id].photo)
          imagePath = 'https://d1b10bmlvqabco.cloudfront.net/photos/' + id + '/' + PA.users[id].photo;
        else if (PA.users[id].facebook_id)
          imagePath = 'https://graph.facebook.com/' + PA.users[id].facebook_id + '/picture?type=square';
        html += '"><div class="' + border + '"><img title="' + PA.users[id].name.replace(/"/g, '&quot;') + '" src="' + imagePath + '" ' + resize + ' /></div>';
      } else {
        html += ' user_loading">&nbsp;';
        PA.loadUser(id);
      }
    else {
      html += '"><div class="' + border + '"><img title="Anonymous" src="https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/default_anonymous.png" ' + resize + ' /></div>';
    }
    html += "</div>";
    return html;
  },
  setUserPic: function(usr) {
    $('.user_name_' + usr.id).each(function(){
      var userHtml = usr.name;
      //if (P.modules.network.type != 'group'  && !P.modules.network.prof_hash[usr.id])
      //  userHtml = '<a class="view-profile-link" href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.id + '\');return false;" target="_self">' + usr.name + '</a>';
      $(this).html(userHtml);
      if ($(this).attr("anon") == "stud") {
        $(this).html(userHtml + " <span class=\"smallText\">(anon. to classmates)</span>");
      }
    });
    var imagePath = 'https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/default_user.png';
    if (usr.email == 'admin') imagePath = 'https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/nerd_small.png';
    if (usr.photo)
      imagePath = 'https://d1b10bmlvqabco.cloudfront.net/photos/' + usr.id + '/' + usr.photo;
    else if (usr.facebook_id)
      imagePath = 'https://graph.facebook.com/' + usr.facebook_id + '/picture?type=square';
    $('.user_pic_' + usr.id).html('<div class="white_border"><img title="'+usr.name.replace(/"/g, '&quot;')+'" src="' + imagePath + '" onload="onImageLoad(event);"/></div>');
    if (usr.id == PA.user.id)
      PA.user.photo = usr.photo;
  },
  loadUsers: function(ids, callback) {
    if (callback)
      PA.userCallback.push(callback);
    for (var i = 0; i < ids.length; i++)
      PA.loadUser(ids[i]);
  },
  loadUser: function(id) {
    if (!PA.userQueue.exist(id))
      PA.userQueue.push(id);
    if (!PA.userTimeout)
      PA.userTimeout = setTimeout('PA.getQueuedUsers()', 100);
  },
  getQueuedUsers: function() {
    var data = {ids:PA.userQueue, nid:P.modules.network.id};
    if (typeof(ANONYMIZE) != "undefined" && ANONYMIZE) { data["anonymize"] = "true"; }
    PA.call_pj("network.get_users", data, 1, function(data){
      data.forEach(function(usr){
        PA.users[usr.id] = usr;
        PA.setUserPic(usr);
      });
      if (PA.userCallback.length > 0) {
        for (var i = 0; i < PA.userCallback.length; i++)
          PA.userCallback[i].call(window);
      }
      PA.userCallback = [];
      $('div.tipsy').remove(); // remove old tipsy messages
      //if (typeof(PD) != 'undefined') $('.user_name_anon').tipsy({gravity: 'n', html: true});
    });
    PA.userQueue = [];
    PA.userTimeout = null;
  },
  hasPermission: function(name) {
    if (!PA.user.network_permissions) return false;
    return PA.user.network_permissions[name];
  },
  trackEvent: function() {
    // nothing
  },
  markSeenUnseen: function(message, unmark) {
    PA.call_pj("user." + (unmark ? "un" : "") + "mark_seen", {msg:message}, 1);
    if (!unmark) {
      if (!PA.user.config.seen_message) PA.user.config.seen_message = [];
      PA.user.config.seen_message.push(message);
    }
  },
  isSeenUser: function(msg) {
    return PA.user && PA.user.config && PA.user.config.seen_message && PA.user.config.seen_message.exist(msg);
  },
  isSeenCompany: function(msg) {
    if (typeof(MY_CONF) === 'undefined') return false;
    return MY_CONF && MY_CONF.seen && MY_CONF.seen.exist(msg);
  },
  markSeenCompany: function(message, unmark) {
    var params = {msg:message};
    if (unmark) params.unmark = 1;
    PA.call_pj("careers_company.mark_seen", params, 1);
    if (typeof(MY_CONF) === 'undefined' || !MY_CONF) MY_CONF = {};
    if (!MY_CONF.seen) MY_CONF.seen = [];
    if (!unmark) {
      MY_CONF.seen.push(message);
    }
  },
  markSeenNetwork: function(network, msg) {
    if(!network.config.seen_message) {
      network.config.seen_message = [];
    }
    // no need to mark as seen if it's already seen
    if(PA.isSeenNetwork(network, msg)) {
      return;
    }
    network.config.seen_message.push(msg);
    PA.call_pj("network.mark_seen", {
      nid: network.id,
      message: msg
    }, 1);
  },
  isSeenNetwork: function(network, msg) {
    return network.config && (network.config.seen_message instanceof Array) && network.config.seen_message.exist(msg);
  },
  load: function(path, blockObject, callback, error, scope) {
    if (PA.user && PA.user.config && PA.user.config.no_spinner)
      blockObject = 1;
    if (blockObject) {
      if (blockObject != 1 && blockObject.block) blockObject.block();
    } else
      $.blockUI();
    if (path.indexOf('?') < 0)
      path += "?t=" + (new Date()).getTime();
    else
      path += "&t=" + (new Date()).getTime();
    $.ajax({
      url: path,
      type: 'GET',
      dataType: 'html',
      success: function(data) {
        if (blockObject) {
          if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
        } else
          $.unblockUI();
        if (data && callback)
          callback.call(scope, data);
      },
      error: function(req, status, err) {
        if (blockObject)
          if (blockObject != 1 && blockObject.unblock) blockObject.unblock();
        else
          $.unblockUI();
        if (error)
          error.call(scope, err);
      }
    });
  },
  // get network with the given nid out of PA.user.networks
  getNetwork: function(nid) {
    if(PA.user === null) {
      return undefined;
    }
    return PA.user.networks.findAll(function(network) {
      return network.id === nid;
    })[0];
  }

}

PEM.addListener("user", PA.cacheUser);

$.ajaxSetup({
    url: '/main/api',
    type: 'POST',
    dataType: 'json',
    timeout: 15 * 60 * 1000 // 15 minute timeout
});

$.blockUI.defaults.overlayCSS["z-index"] = "1000000";
$.blockUI.defaults.css["z-index"] = "1000001";
$.blockUI.defaults.css.border = 'none';
$.blockUI.defaults.css.cursor = 'default';
$.blockUI.defaults.overlayCSS.cursor = 'default';
$.blockUI.defaults.message = '';
/*1.5.2*/
(function(){var f=0,l=[],n={},j={},a={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},m=/[<>&\"\']/g,b,c=window.setTimeout,d={},e;function h(){this.returnValue=false}function k(){this.cancelBubble=true}(function(o){var p=o.split(/,/),q,s,r;for(q=0;q<p.length;q+=2){r=p[q+1].split(/ /);for(s=0;s<r.length;s++){j[r[s]]=p[q]}}})("application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mpga mpega mp2 mp3,audio/x-wav,wav,audio/mp4,m4a,image/bmp,bmp,image/gif,gif,image/jpeg,jpeg jpg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/vnd.rn-realvideo,rv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe");var g={VERSION:"1.5.2",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:j,ua:(function(){var s=navigator,r=s.userAgent,t=s.vendor,p,o,q;p=/WebKit/.test(r);q=p&&t.indexOf("Apple")!==-1;o=window.opera&&window.opera.buildNumber;return{windows:navigator.platform.indexOf("Win")!==-1,ie:!p&&!o&&(/MSIE/gi).test(r)&&(/Explorer/gi).test(s.appName),webkit:p,gecko:!p&&/Gecko/.test(r),safari:q,opera:!!o}}()),typeOf:function(p){return({}).toString.call(p).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},extend:function(o){g.each(arguments,function(p,q){if(q>0){g.each(p,function(s,r){o[r]=s})}});return o},cleanName:function(o){var p,q;q=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(p=0;p<q.length;p+=2){o=o.replace(q[p],q[p+1])}o=o.replace(/\s+/g,"_");o=o.replace(/[^a-z0-9_\-\.]+/gi,"");return o},addRuntime:function(o,p){p.name=o;l[o]=p;l.push(p);return p},guid:function(){var o=new Date().getTime().toString(32),p;for(p=0;p<5;p++){o+=Math.floor(Math.random()*65535).toString(32)}return(g.guidPrefix||"p")+o+(f++).toString(32)},buildUrl:function(p,o){var q="";g.each(o,function(s,r){q+=(q?"&":"")+encodeURIComponent(r)+"="+encodeURIComponent(s)});if(q){p+=(p.indexOf("?")>0?"&":"?")+q}return p},each:function(r,s){var q,p,o;if(r){q=r.length;if(q===b){for(p in r){if(r.hasOwnProperty(p)){if(s(r[p],p)===false){return}}}}else{for(o=0;o<q;o++){if(s(r[o],o)===false){return}}}}},formatSize:function(o){if(o===b||/\D/.test(o)){return g.translate("N/A")}if(o>1073741824){return Math.round(o/1073741824,1)+" GB"}if(o>1048576){return Math.round(o/1048576,1)+" MB"}if(o>1024){return Math.round(o/1024,1)+" KB"}return o+" b"},getPos:function(p,t){var u=0,s=0,w,v=document,q,r;p=p;t=t||v.body;function o(C){var A,B,z=0,D=0;if(C){B=C.getBoundingClientRect();A=v.compatMode==="CSS1Compat"?v.documentElement:v.body;z=B.left+A.scrollLeft;D=B.top+A.scrollTop}return{x:z,y:D}}if(p&&p.getBoundingClientRect&&(navigator.userAgent.indexOf("MSIE")>0&&v.documentMode!==8)){q=o(p);r=o(t);return{x:q.x-r.x,y:q.y-r.y}}w=p;while(w&&w!=t&&w.nodeType){u+=w.offsetLeft||0;s+=w.offsetTop||0;w=w.offsetParent}w=p.parentNode;while(w&&w!=t&&w.nodeType){u-=w.scrollLeft||0;s-=w.scrollTop||0;w=w.parentNode}return{x:u,y:s}},getSize:function(o){return{w:o.offsetWidth||o.clientWidth,h:o.offsetHeight||o.clientHeight}},parseSize:function(o){var p;if(typeof(o)=="string"){o=/^([0-9]+)([mgk]?)$/.exec(o.toLowerCase().replace(/[^0-9mkg]/g,""));p=o[2];o=+o[1];if(p=="g"){o*=1073741824}if(p=="m"){o*=1048576}if(p=="k"){o*=1024}}return o},xmlEncode:function(o){return o?(""+o).replace(m,function(p){return a[p]?"&"+a[p]+";":p}):o},toArray:function(q){var p,o=[];for(p=0;p<q.length;p++){o[p]=q[p]}return o},inArray:function(q,r){if(r){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(r,q)}for(var o=0,p=r.length;o<p;o++){if(r[o]===q){return o}}}return -1},addI18n:function(o){return g.extend(n,o)},translate:function(o){return n[o]||o},isEmptyObj:function(o){if(o===b){return true}for(var p in o){return false}return true},hasClass:function(q,p){var o;if(q.className==""){return false}o=new RegExp("(^|\\s+)"+p+"(\\s+|$)");return o.test(q.className)},addClass:function(p,o){if(!g.hasClass(p,o)){p.className=p.className==""?o:p.className.replace(/\s+$/,"")+" "+o}},removeClass:function(q,p){var o=new RegExp("(^|\\s+)"+p+"(\\s+|$)");q.className=q.className.replace(o,function(s,r,t){return r===" "&&t===" "?" ":""})},getStyle:function(p,o){if(p.currentStyle){return p.currentStyle[o]}else{if(window.getComputedStyle){return window.getComputedStyle(p,null)[o]}}},addEvent:function(t,o,u){var s,r,q,p;p=arguments[3];o=o.toLowerCase();if(e===b){e="Plupload_"+g.guid()}if(t.addEventListener){s=u;t.addEventListener(o,s,false)}else{if(t.attachEvent){s=function(){var v=window.event;if(!v.target){v.target=v.srcElement}v.preventDefault=h;v.stopPropagation=k;u(v)};t.attachEvent("on"+o,s)}}if(t[e]===b){t[e]=g.guid()}if(!d.hasOwnProperty(t[e])){d[t[e]]={}}r=d[t[e]];if(!r.hasOwnProperty(o)){r[o]=[]}r[o].push({func:s,orig:u,key:p})},removeEvent:function(t,o){var r,u,q;if(typeof(arguments[2])=="function"){u=arguments[2]}else{q=arguments[2]}o=o.toLowerCase();if(t[e]&&d[t[e]]&&d[t[e]][o]){r=d[t[e]][o]}else{return}for(var p=r.length-1;p>=0;p--){if(r[p].key===q||r[p].orig===u){if(t.detachEvent){t.detachEvent("on"+o,r[p].func)}else{if(t.removeEventListener){t.removeEventListener(o,r[p].func,false)}}r[p].orig=null;r[p].func=null;r.splice(p,1);if(u!==b){break}}}if(!r.length){delete d[t[e]][o]}if(g.isEmptyObj(d[t[e]])){delete d[t[e]];try{delete t[e]}catch(s){t[e]=b}}},removeAllEvents:function(p){var o=arguments[1];if(p[e]===b||!p[e]){return}g.each(d[p[e]],function(r,q){g.removeEvent(p,q,o)})}};g.Uploader=function(s){var p={},v,u=[],r,q=false;v=new g.QueueProgress();s=g.extend({chunk_size:0,multipart:true,multi_selection:true,file_data_name:"file",filters:[]},s);function t(){var x,y=0,w;if(this.state==g.STARTED){for(w=0;w<u.length;w++){if(!x&&u[w].status==g.QUEUED){x=u[w];x.status=g.UPLOADING;if(this.trigger("BeforeUpload",x)){this.trigger("UploadFile",x)}}else{y++}}if(y==u.length){this.stop();this.trigger("UploadComplete",u)}}}function o(){var x,w;v.reset();for(x=0;x<u.length;x++){w=u[x];if(w.size!==b){v.size+=w.size;v.loaded+=w.loaded}else{v.size=b}if(w.status==g.DONE){v.uploaded++}else{if(w.status==g.FAILED){v.failed++}else{v.queued++}}}if(v.size===b){v.percent=u.length>0?Math.ceil(v.uploaded/u.length*100):0}else{v.bytesPerSec=Math.ceil(v.loaded/((+new Date()-r||1)/1000));v.percent=v.size>0?Math.ceil(v.loaded/v.size*100):0}}g.extend(this,{state:g.STOPPED,runtime:"",features:{},files:u,settings:s,total:v,id:g.guid(),init:function(){var B=this,C,y,x,A=0,z;if(typeof(s.preinit)=="function"){s.preinit(B)}else{g.each(s.preinit,function(E,D){B.bind(D,E)})}s.page_url=s.page_url||document.location.pathname.replace(/\/[^\/]+$/g,"/");if(!/^(\w+:\/\/|\/)/.test(s.url)){s.url=s.page_url+s.url}s.chunk_size=g.parseSize(s.chunk_size);s.max_file_size=g.parseSize(s.max_file_size);B.bind("FilesAdded",function(D,G){var F,E,I=0,J,H=s.filters;if(H&&H.length){J=[];g.each(H,function(K){g.each(K.extensions.split(/,/),function(L){if(/^\s*\*\s*$/.test(L)){J.push("\\.*")}else{J.push("\\."+L.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});J=new RegExp(J.join("|")+"$","i")}for(F=0;F<G.length;F++){E=G[F];E.loaded=0;E.percent=0;E.status=g.QUEUED;if(J&&!J.test(E.name)){D.trigger("Error",{code:g.FILE_EXTENSION_ERROR,message:g.translate("File extension error."),file:E});continue}if(E.size!==b&&E.size>s.max_file_size){D.trigger("Error",{code:g.FILE_SIZE_ERROR,message:g.translate("File size error."),file:E});continue}u.push(E);I++}if(I){c(function(){B.trigger("QueueChanged");B.refresh()},1)}else{return false}});if(s.unique_names){B.bind("UploadFile",function(D,E){var G=E.name.match(/\.([^.]+)$/),F="tmp";if(G){F=G[1]}E.target_name=E.id+"."+F})}B.bind("UploadProgress",function(D,E){E.percent=E.size>0?Math.ceil(E.loaded/E.size*100):100;o()});B.bind("StateChanged",function(D){if(D.state==g.STARTED){r=(+new Date())}else{if(D.state==g.STOPPED){for(C=D.files.length-1;C>=0;C--){if(D.files[C].status==g.UPLOADING){D.files[C].status=g.QUEUED;o()}}}}});B.bind("QueueChanged",o);B.bind("Error",function(D,E){if(E.file){E.file.status=g.FAILED;o();if(D.state==g.STARTED){c(function(){t.call(B)},1)}}});B.bind("FileUploaded",function(D,E){E.status=g.DONE;E.loaded=E.size;D.trigger("UploadProgress",E);c(function(){t.call(B)},1)});if(s.runtimes){y=[];z=s.runtimes.split(/\s?,\s?/);for(C=0;C<z.length;C++){if(l[z[C]]){y.push(l[z[C]])}}}else{y=l}function w(){var G=y[A++],F,D,E;if(G){F=G.getFeatures();D=B.settings.required_features;if(D){D=D.split(",");for(E=0;E<D.length;E++){if(!F[D[E]]){w();return}}}G.init(B,function(H){if(H&&H.success){B.features=F;B.runtime=G.name;B.trigger("Init",{runtime:G.name});B.trigger("PostInit");B.refresh()}else{w()}})}else{B.trigger("Error",{code:g.INIT_ERROR,message:g.translate("Init error.")})}}w();if(typeof(s.init)=="function"){s.init(B)}else{g.each(s.init,function(E,D){B.bind(D,E)})}},refresh:function(){this.trigger("Refresh")},start:function(){if(this.state!=g.STARTED){this.state=g.STARTED;this.trigger("StateChanged");t.call(this)}},stop:function(){if(this.state!=g.STOPPED){this.state=g.STOPPED;this.trigger("CancelUpload");this.trigger("StateChanged")}},disableBrowse:function(){q=arguments[0]!==b?arguments[0]:true;this.trigger("DisableBrowse",q)},getFile:function(x){var w;for(w=u.length-1;w>=0;w--){if(u[w].id===x){return u[w]}}},removeFile:function(x){var w;for(w=u.length-1;w>=0;w--){if(u[w].id===x.id){return this.splice(w,1)[0]}}},splice:function(y,w){var x;x=u.splice(y===b?0:y,w===b?u.length:w);this.trigger("FilesRemoved",x);this.trigger("QueueChanged");return x},trigger:function(x){var z=p[x.toLowerCase()],y,w;if(z){w=Array.prototype.slice.call(arguments);w[0]=this;for(y=0;y<z.length;y++){if(z[y].func.apply(z[y].scope,w)===false){return false}}}return true},hasEventListener:function(w){return !!p[w.toLowerCase()]},bind:function(w,y,x){var z;w=w.toLowerCase();z=p[w]||[];z.push({func:y,scope:x||this});p[w]=z},unbind:function(w){w=w.toLowerCase();var z=p[w],x,y=arguments[1];if(z){if(y!==b){for(x=z.length-1;x>=0;x--){if(z[x].func===y){z.splice(x,1);break}}}else{z=[]}if(!z.length){delete p[w]}}},unbindAll:function(){var w=this;g.each(p,function(y,x){w.unbind(x)})},destroy:function(){this.stop();this.trigger("Destroy");this.unbindAll()}})};g.File=function(r,p,q){var o=this;o.id=r;o.name=p;o.size=q;o.loaded=0;o.percent=0;o.status=0};g.Runtime=function(){this.getFeatures=function(){};this.init=function(o,p){}};g.QueueProgress=function(){var o=this;o.size=0;o.loaded=0;o.uploaded=0;o.failed=0;o.queued=0;o.percent=0;o.bytesPerSec=0;o.reset=function(){o.size=o.loaded=o.uploaded=o.failed=o.queued=o.percent=o.bytesPerSec=0}};g.runtimes={};window.plupload=g})();(function(){if(window.google&&google.gears){return}var a=null;if(typeof GearsFactory!="undefined"){a=new GearsFactory()}else{try{a=new ActiveXObject("Gears.Factory");if(a.getBuildInfo().indexOf("ie_mobile")!=-1){a.privateSetGlobalObject(this)}}catch(b){if((typeof navigator.mimeTypes!="undefined")&&navigator.mimeTypes["application/x-googlegears"]){a=document.createElement("object");a.style.display="none";a.width=0;a.height=0;a.type="application/x-googlegears";document.documentElement.appendChild(a)}}}if(!a){return}if(!window.google){window.google={}}if(!google.gears){google.gears={factory:a}}})();(function(e,b,c,d){var f={};function a(h,k,m){var g,j,l,o;j=google.gears.factory.create("beta.canvas");try{j.decode(h);if(!k.width){k.width=j.width}if(!k.height){k.height=j.height}o=Math.min(width/j.width,height/j.height);if(o<1||(o===1&&m==="image/jpeg")){j.resize(Math.round(j.width*o),Math.round(j.height*o));if(k.quality){return j.encode(m,{quality:k.quality/100})}return j.encode(m)}}catch(n){}return h}c.runtimes.Gears=c.addRuntime("gears",{getFeatures:function(){return{dragdrop:true,jpgresize:true,pngresize:true,chunks:true,progress:true,multipart:true,multi_selection:true}},init:function(l,n){var m,h,g=false;if(!e.google||!google.gears){return n({success:false})}try{m=google.gears.factory.create("beta.desktop")}catch(k){return n({success:false})}function j(q){var p,o,r=[],s;for(o=0;o<q.length;o++){p=q[o];s=c.guid();f[s]=p.blob;r.push(new c.File(s,p.name,p.blob.length))}l.trigger("FilesAdded",r)}l.bind("PostInit",function(){var p=l.settings,o=b.getElementById(p.drop_element);if(o){c.addEvent(o,"dragover",function(q){m.setDropEffect(q,"copy");q.preventDefault()},l.id);c.addEvent(o,"drop",function(r){var q=m.getDragData(r,"application/x-gears-files");if(q){j(q.files)}r.preventDefault()},l.id);o=0}c.addEvent(b.getElementById(p.browse_button),"click",function(u){var t=[],r,q,s;u.preventDefault();if(g){return}no_type_restriction:for(r=0;r<p.filters.length;r++){s=p.filters[r].extensions.split(",");for(q=0;q<s.length;q++){if(s[q]==="*"){t=[];break no_type_restriction}t.push("."+s[q])}}m.openFiles(j,{singleFile:!p.multi_selection,filter:t})},l.id)});l.bind("CancelUpload",function(){if(h.abort){h.abort()}});l.bind("UploadFile",function(u,r){var w=0,v,s,t=0,q=u.settings.resize,o;if(q&&/\.(png|jpg|jpeg)$/i.test(r.name)){f[r.id]=a(f[r.id],q,/\.png$/i.test(r.name)?"image/png":"image/jpeg")}r.size=f[r.id].length;s=u.settings.chunk_size;o=s>0;v=Math.ceil(r.size/s);if(!o){s=r.size;v=1}function p(){var C,y=u.settings.multipart,x=0,B={name:r.target_name||r.name},z=u.settings.url;function A(E){var D,J="----pluploadboundary"+c.guid(),G="--",I="\r\n",F,H;if(y){h.setRequestHeader("Content-Type","multipart/form-data; boundary="+J);D=google.gears.factory.create("beta.blobbuilder");c.each(c.extend(B,u.settings.multipart_params),function(L,K){D.append(G+J+I+'Content-Disposition: form-data; name="'+K+'"'+I+I);D.append(L+I)});H=c.mimeTypes[r.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream";D.append(G+J+I+'Content-Disposition: form-data; name="'+u.settings.file_data_name+'"; filename="'+r.name+'"'+I+"Content-Type: "+H+I+I);D.append(E);D.append(I+G+J+G+I);F=D.getAsBlob();x=F.length-E.length;E=F}h.send(E)}if(r.status==c.DONE||r.status==c.FAILED||u.state==c.STOPPED){return}if(o){B.chunk=w;B.chunks=v}C=Math.min(s,r.size-(w*s));if(!y){z=c.buildUrl(u.settings.url,B)}h=google.gears.factory.create("beta.httprequest");h.open("POST",z);if(!y){h.setRequestHeader("Content-Disposition",'attachment; filename="'+r.name+'"');h.setRequestHeader("Content-Type","application/octet-stream")}c.each(u.settings.headers,function(E,D){h.setRequestHeader(D,E)});h.upload.onprogress=function(D){r.loaded=t+D.loaded-x;u.trigger("UploadProgress",r)};h.onreadystatechange=function(){var D;if(h.readyState==4&&u.state!==c.STOPPED){if(h.status==200){D={chunk:w,chunks:v,response:h.responseText,status:h.status};u.trigger("ChunkUploaded",r,D);if(D.cancelled){r.status=c.FAILED;return}t+=C;if(++w>=v){r.status=c.DONE;u.trigger("FileUploaded",r,{response:h.responseText,status:h.status})}else{p()}}else{u.trigger("Error",{code:c.HTTP_ERROR,message:c.translate("HTTP Error."),file:r,chunk:w,chunks:v,status:h.status})}}};if(w<v){A(f[r.id].slice(w*s,C))}}p()});l.bind("DisableBrowse",function(o,p){g=p});l.bind("Destroy",function(o){var p,q,r={browseButton:o.settings.browse_button,dropElm:o.settings.drop_element};for(p in r){q=b.getElementById(r[p]);if(q){c.removeAllEvents(q,o.id)}}});n({success:true})}})})(window,document,plupload);(function(g,b,d,e){var a={},h={};function c(o){var n,m=typeof o,j,l,k;if(o===e||o===null){return"null"}if(m==="string"){n="\bb\tt\nn\ff\rr\"\"''\\\\";return'"'+o.replace(/([\u0080-\uFFFF\x00-\x1f\"])/g,function(r,q){var p=n.indexOf(q);if(p+1){return"\\"+n.charAt(p+1)}r=q.charCodeAt().toString(16);return"\\u"+"0000".substring(r.length)+r})+'"'}if(m=="object"){j=o.length!==e;n="";if(j){for(l=0;l<o.length;l++){if(n){n+=","}n+=c(o[l])}n="["+n+"]"}else{for(k in o){if(o.hasOwnProperty(k)){if(n){n+=","}n+=c(k)+":"+c(o[k])}}n="{"+n+"}"}return n}return""+o}function f(s){var v=false,j=null,o=null,k,l,m,u,n,q=0;try{try{o=new ActiveXObject("AgControl.AgControl");if(o.IsVersionSupported(s)){v=true}o=null}catch(r){var p=navigator.plugins["Silverlight Plug-In"];if(p){k=p.description;if(k==="1.0.30226.2"){k="2.0.30226.2"}l=k.split(".");while(l.length>3){l.pop()}while(l.length<4){l.push(0)}m=s.split(".");while(m.length>4){m.pop()}do{u=parseInt(m[q],10);n=parseInt(l[q],10);q++}while(q<m.length&&u===n);if(u<=n&&!isNaN(u)){v=true}}}}catch(t){v=false}return v}d.silverlight={trigger:function(n,k){var m=a[n],l,j;if(m){j=d.toArray(arguments).slice(1);j[0]="Silverlight:"+k;setTimeout(function(){m.trigger.apply(m,j)},0)}}};d.runtimes.Silverlight=d.addRuntime("silverlight",{getFeatures:function(){return{jpgresize:true,pngresize:true,chunks:true,progress:true,multipart:true,multi_selection:true}},init:function(p,q){var o,m="",n=p.settings.filters,l,k=b.body;if(!f("2.0.31005.0")||(g.opera&&g.opera.buildNumber)){q({success:false});return}h[p.id]=false;a[p.id]=p;o=b.createElement("div");o.id=p.id+"_silverlight_container";d.extend(o.style,{position:"absolute",top:"0px",background:p.settings.shim_bgcolor||"transparent",zIndex:99999,width:"100px",height:"100px",overflow:"hidden",opacity:p.settings.shim_bgcolor||b.documentMode>8?"":0.01});o.className="plupload silverlight";if(p.settings.container){k=b.getElementById(p.settings.container);if(d.getStyle(k,"position")==="static"){k.style.position="relative"}}k.appendChild(o);for(l=0;l<n.length;l++){m+=(m!=""?"|":"")+n[l].title+" | *."+n[l].extensions.replace(/,/g,";*.")}o.innerHTML='<object id="'+p.id+'_silverlight" data="data:application/x-silverlight," type="application/x-silverlight-2" style="outline:none;" width="1024" height="1024"><param name="source" value="'+p.settings.silverlight_xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="id='+p.id+",filter="+m+",multiselect="+p.settings.multi_selection+'"/></object>';function j(){return b.getElementById(p.id+"_silverlight").content.Upload}p.bind("Silverlight:Init",function(){var r,s={};if(h[p.id]){return}h[p.id]=true;p.bind("Silverlight:StartSelectFiles",function(t){r=[]});p.bind("Silverlight:SelectFile",function(t,w,u,v){var x;x=d.guid();s[x]=w;s[w]=x;r.push(new d.File(x,u,v))});p.bind("Silverlight:SelectSuccessful",function(){if(r.length){p.trigger("FilesAdded",r)}});p.bind("Silverlight:UploadChunkError",function(t,w,u,x,v){p.trigger("Error",{code:d.IO_ERROR,message:"IO Error.",details:v,file:t.getFile(s[w])})});p.bind("Silverlight:UploadFileProgress",function(t,x,u,w){var v=t.getFile(s[x]);if(v.status!=d.FAILED){v.size=w;v.loaded=u;t.trigger("UploadProgress",v)}});p.bind("Refresh",function(t){var u,v,w;u=b.getElementById(t.settings.browse_button);if(u){v=d.getPos(u,b.getElementById(t.settings.container));w=d.getSize(u);d.extend(b.getElementById(t.id+"_silverlight_container").style,{top:v.y+"px",left:v.x+"px",width:w.w+"px",height:w.h+"px"})}});p.bind("Silverlight:UploadChunkSuccessful",function(t,w,u,z,y){var x,v=t.getFile(s[w]);x={chunk:u,chunks:z,response:y};t.trigger("ChunkUploaded",v,x);if(v.status!=d.FAILED&&t.state!==d.STOPPED){j().UploadNextChunk()}if(u==z-1){v.status=d.DONE;t.trigger("FileUploaded",v,{response:y})}});p.bind("Silverlight:UploadSuccessful",function(t,w,u){var v=t.getFile(s[w]);v.status=d.DONE;t.trigger("FileUploaded",v,{response:u})});p.bind("FilesRemoved",function(t,v){var u;for(u=0;u<v.length;u++){j().RemoveFile(s[v[u].id])}});p.bind("UploadFile",function(t,v){var w=t.settings,u=w.resize||{};j().UploadFile(s[v.id],t.settings.url,c({name:v.target_name||v.name,mime:d.mimeTypes[v.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream",chunk_size:w.chunk_size,image_width:u.width,image_height:u.height,image_quality:u.quality||90,multipart:!!w.multipart,multipart_params:w.multipart_params||{},file_data_name:w.file_data_name,headers:w.headers}))});p.bind("CancelUpload",function(){j().CancelUpload()});p.bind("Silverlight:MouseEnter",function(t){var u,v;u=b.getElementById(p.settings.browse_button);v=t.settings.browse_button_hover;if(u&&v){d.addClass(u,v)}});p.bind("Silverlight:MouseLeave",function(t){var u,v;u=b.getElementById(p.settings.browse_button);v=t.settings.browse_button_hover;if(u&&v){d.removeClass(u,v)}});p.bind("Silverlight:MouseLeftButtonDown",function(t){var u,v;u=b.getElementById(p.settings.browse_button);v=t.settings.browse_button_active;if(u&&v){d.addClass(u,v);d.addEvent(b.body,"mouseup",function(){d.removeClass(u,v)})}});p.bind("Sliverlight:StartSelectFiles",function(t){var u,v;u=b.getElementById(p.settings.browse_button);v=t.settings.browse_button_active;if(u&&v){d.removeClass(u,v)}});p.bind("DisableBrowse",function(t,u){j().DisableBrowse(u)});p.bind("Destroy",function(t){var u;d.removeAllEvents(b.body,t.id);delete h[t.id];delete a[t.id];u=b.getElementById(t.id+"_silverlight_container");if(u){k.removeChild(u)}});q({success:true})})}})})(window,document,plupload);(function(f,b,d,e){var a={},g={};function c(){var h;try{h=navigator.plugins["Shockwave Flash"];h=h.description}catch(k){try{h=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(j){h="0.0"}}h=h.match(/\d+/g);return parseFloat(h[0]+"."+h[1])}d.flash={trigger:function(k,h,j){setTimeout(function(){var n=a[k],m,l;if(n){n.trigger("Flash:"+h,j)}},0)}};d.runtimes.Flash=d.addRuntime("flash",{getFeatures:function(){return{jpgresize:true,pngresize:true,maxWidth:8091,maxHeight:8091,chunks:true,progress:true,multipart:true,multi_selection:true}},init:function(n,p){var l,m,h=0,j=b.body;if(c()<10){p({success:false});return}g[n.id]=false;a[n.id]=n;l=b.getElementById(n.settings.browse_button);m=b.createElement("div");m.id=n.id+"_flash_container";d.extend(m.style,{position:"absolute",top:"0px",background:n.settings.shim_bgcolor||"transparent",zIndex:99999,width:"100%",height:"100%"});m.className="plupload flash";if(n.settings.container){j=b.getElementById(n.settings.container);if(d.getStyle(j,"position")==="static"){j.style.position="relative"}}j.appendChild(m);(function(){var q,r;q='<object id="'+n.id+'_flash" type="application/x-shockwave-flash" data="'+n.settings.flash_swf_url+'" ';if(d.ua.ie){q+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}q+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+n.settings.flash_swf_url+'" /><param name="flashvars" value="id='+escape(n.id)+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(d.ua.ie){r=b.createElement("div");m.appendChild(r);r.outerHTML=q;r=null}else{m.innerHTML=q}}());function o(){return b.getElementById(n.id+"_flash")}function k(){if(h++>5000){p({success:false});return}if(!g[n.id]){setTimeout(k,1)}}k();l=m=null;n.bind("Flash:Init",function(){var r={},q;o().setFileFilters(n.settings.filters,n.settings.multi_selection);if(g[n.id]){return}g[n.id]=true;n.bind("UploadFile",function(s,u){var v=s.settings,t=n.settings.resize||{};o().uploadFile(r[u.id],v.url,{name:u.target_name||u.name,mime:d.mimeTypes[u.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream",chunk_size:v.chunk_size,width:t.width,height:t.height,quality:t.quality,multipart:v.multipart,multipart_params:v.multipart_params||{},file_data_name:v.file_data_name,format:/\.(jpg|jpeg)$/i.test(u.name)?"jpg":"png",headers:v.headers,urlstream_upload:v.urlstream_upload})});n.bind("CancelUpload",function(){o().cancelUpload()});n.bind("Flash:UploadProcess",function(t,s){var u=t.getFile(r[s.id]);if(u.status!=d.FAILED){u.loaded=s.loaded;u.size=s.size;t.trigger("UploadProgress",u)}});n.bind("Flash:UploadChunkComplete",function(s,u){var v,t=s.getFile(r[u.id]);v={chunk:u.chunk,chunks:u.chunks,response:u.text};s.trigger("ChunkUploaded",t,v);if(t.status!==d.FAILED&&s.state!==d.STOPPED){o().uploadNextChunk()}if(u.chunk==u.chunks-1){t.status=d.DONE;s.trigger("FileUploaded",t,{response:u.text})}});n.bind("Flash:SelectFiles",function(s,v){var u,t,w=[],x;for(t=0;t<v.length;t++){u=v[t];x=d.guid();r[x]=u.id;r[u.id]=x;w.push(new d.File(x,u.name,u.size))}if(w.length){n.trigger("FilesAdded",w)}});n.bind("Flash:SecurityError",function(s,t){n.trigger("Error",{code:d.SECURITY_ERROR,message:d.translate("Security error."),details:t.message,file:n.getFile(r[t.id])})});n.bind("Flash:GenericError",function(s,t){n.trigger("Error",{code:d.GENERIC_ERROR,message:d.translate("Generic error."),details:t.message,file:n.getFile(r[t.id])})});n.bind("Flash:IOError",function(s,t){n.trigger("Error",{code:d.IO_ERROR,message:d.translate("IO error."),details:t.message,file:n.getFile(r[t.id])})});n.bind("Flash:ImageError",function(s,t){n.trigger("Error",{code:parseInt(t.code,10),message:d.translate("Image error."),file:n.getFile(r[t.id])})});n.bind("Flash:StageEvent:rollOver",function(s){var t,u;t=b.getElementById(n.settings.browse_button);u=s.settings.browse_button_hover;if(t&&u){d.addClass(t,u)}});n.bind("Flash:StageEvent:rollOut",function(s){var t,u;t=b.getElementById(n.settings.browse_button);u=s.settings.browse_button_hover;if(t&&u){d.removeClass(t,u)}});n.bind("Flash:StageEvent:mouseDown",function(s){var t,u;t=b.getElementById(n.settings.browse_button);u=s.settings.browse_button_active;if(t&&u){d.addClass(t,u);d.addEvent(b.body,"mouseup",function(){d.removeClass(t,u)},s.id)}});n.bind("Flash:StageEvent:mouseUp",function(s){var t,u;t=b.getElementById(n.settings.browse_button);u=s.settings.browse_button_active;if(t&&u){d.removeClass(t,u)}});n.bind("Flash:ExifData",function(s,t){n.trigger("ExifData",n.getFile(r[t.id]),t.data)});n.bind("Flash:GpsData",function(s,t){n.trigger("GpsData",n.getFile(r[t.id]),t.data)});n.bind("QueueChanged",function(s){n.refresh()});n.bind("FilesRemoved",function(s,u){var t;for(t=0;t<u.length;t++){o().removeFile(r[u[t].id])}});n.bind("StateChanged",function(s){n.refresh()});n.bind("Refresh",function(s){var t,u,v;o().setFileFilters(n.settings.filters,n.settings.multi_selection);t=b.getElementById(s.settings.browse_button);if(t){u=d.getPos(t,b.getElementById(s.settings.container));v=d.getSize(t);d.extend(b.getElementById(s.id+"_flash_container").style,{top:u.y+"px",left:u.x+"px",width:v.w+"px",height:v.h+"px"})}});n.bind("DisableBrowse",function(s,t){o().disableBrowse(t)});n.bind("Destroy",function(s){var t;d.removeAllEvents(b.body,s.id);delete g[s.id];delete a[s.id];t=b.getElementById(s.id+"_flash_container");if(t){j.removeChild(t)}});p({success:true})})}})})(window,document,plupload);(function(a){a.runtimes.BrowserPlus=a.addRuntime("browserplus",{getFeatures:function(){return{dragdrop:true,jpgresize:true,pngresize:true,chunks:true,progress:true,multipart:true,multi_selection:true}},init:function(g,j){var e=window.BrowserPlus,h={},d=g.settings,c=d.resize;function f(o){var n,m,k=[],l,p;for(m=0;m<o.length;m++){l=o[m];p=a.guid();h[p]=l;k.push(new a.File(p,l.name,l.size))}if(m){g.trigger("FilesAdded",k)}}function b(){var k=false;g.bind("PostInit",function(){var o,m=d.drop_element,q=g.id+"_droptarget",l=document.getElementById(m),n;function r(t,s){e.DragAndDrop.AddDropTarget({id:t},function(u){e.DragAndDrop.AttachCallbacks({id:t,hover:function(v){if(!v&&s){s()}},drop:function(v){if(s){s()}f(v)}},function(){})})}function p(){document.getElementById(q).style.top="-1000px"}if(l){if(document.attachEvent&&(/MSIE/gi).test(navigator.userAgent)){o=document.createElement("div");o.setAttribute("id",q);a.extend(o.style,{position:"absolute",top:"-1000px",background:"red",filter:"alpha(opacity=0)",opacity:0});document.body.appendChild(o);a.addEvent(l,"dragenter",function(t){var s,u;s=document.getElementById(m);u=a.getPos(s);a.extend(document.getElementById(q).style,{top:u.y+"px",left:u.x+"px",width:s.offsetWidth+"px",height:s.offsetHeight+"px"})});r(q,p)}else{r(m)}}a.addEvent(document.getElementById(d.browse_button),"click",function(y){var s=[],u,t,x=d.filters,w,v;y.preventDefault();if(k){return}no_type_restriction:for(u=0;u<x.length;u++){w=x[u].extensions.split(",");for(t=0;t<w.length;t++){if(w[t]==="*"){s=[];break no_type_restriction}v=a.mimeTypes[w[t]];if(v&&a.inArray(v,s)===-1){s.push(a.mimes[w[t]])}}}e.FileBrowse.OpenBrowseDialog({mimeTypes:s},function(z){if(z.success){f(z.value)}})});l=o=null});g.bind("CancelUpload",function(){e.Uploader.cancel()});g.bind("DisableBrowse",function(l,m){k=m});g.bind("UploadFile",function(o,l){var n=h[l.id],t={},m=o.settings.chunk_size,p,q=[];function s(u,w){var v;if(l.status==a.FAILED){return}t.name=l.target_name||l.name;if(m){t.chunk=""+u;t.chunks=""+w}v=q.shift();e.Uploader.upload({url:o.settings.url,files:{file:v},cookies:document.cookies,postvars:a.extend(t,o.settings.multipart_params),progressCallback:function(z){var y,x=0;p[u]=parseInt(z.filePercent*v.size/100,10);for(y=0;y<p.length;y++){x+=p[y]}l.loaded=x;o.trigger("UploadProgress",l)}},function(y){var x,z;if(y.success){x=y.value.statusCode;if(m){o.trigger("ChunkUploaded",l,{chunk:u,chunks:w,response:y.value.body,status:x})}if(q.length>0){s(++u,w)}else{l.status=a.DONE;o.trigger("FileUploaded",l,{response:y.value.body,status:x});if(x>=400){o.trigger("Error",{code:a.HTTP_ERROR,message:a.translate("HTTP Error."),file:l,status:x})}}}else{o.trigger("Error",{code:a.GENERIC_ERROR,message:a.translate("Generic Error."),file:l,details:y.error})}})}function r(u){l.size=u.size;if(m){e.FileAccess.chunk({file:u,chunkSize:m},function(x){if(x.success){var y=x.value,v=y.length;p=Array(v);for(var w=0;w<v;w++){p[w]=0;q.push(y[w])}s(0,v)}})}else{p=Array(1);q.push(u);s(0,1)}}if(c&&/\.(png|jpg|jpeg)$/i.test(l.name)){BrowserPlus.ImageAlter.transform({file:n,quality:c.quality||90,actions:[{scale:{maxwidth:c.width,maxheight:c.height}}]},function(u){if(u.success){r(u.value.file)}})}else{r(n)}});j({success:true})}if(e){e.init(function(l){var k=[{service:"Uploader",version:"3"},{service:"DragAndDrop",version:"1"},{service:"FileBrowse",version:"1"},{service:"FileAccess",version:"2"}];if(c){k.push({service:"ImageAlter",version:"4"})}if(l.success){e.require({services:k},function(m){if(m.success){b()}else{j()}})}else{j()}})}else{j()}}})})(plupload);(function(h,k,j,e){var c={},g;function m(o,p){var n;if("FileReader" in h){n=new FileReader();n.readAsDataURL(o);n.onload=function(){p(n.result)}}else{return p(o.getAsDataURL())}}function l(o,p){var n;if("FileReader" in h){n=new FileReader();n.readAsBinaryString(o);n.onload=function(){p(n.result)}}else{return p(o.getAsBinary())}}function d(r,p,n,v){var q,o,u,s,t=this;m(c[r.id],function(w){q=k.createElement("canvas");q.style.display="none";k.body.appendChild(q);o=q.getContext("2d");u=new Image();u.onerror=u.onabort=function(){v({success:false})};u.onload=function(){var B,x,z,y,A;if(!p.width){p.width=u.width}if(!p.height){p.height=u.height}s=Math.min(p.width/u.width,p.height/u.height);if(s<1||(s===1&&n==="image/jpeg")){B=Math.round(u.width*s);x=Math.round(u.height*s);q.width=B;q.height=x;o.drawImage(u,0,0,B,x);if(n==="image/jpeg"){y=new f(atob(w.substring(w.indexOf("base64,")+7)));if(y.headers&&y.headers.length){A=new a();if(A.init(y.get("exif")[0])){A.setExif("PixelXDimension",B);A.setExif("PixelYDimension",x);y.set("exif",A.getBinary());if(t.hasEventListener("ExifData")){t.trigger("ExifData",r,A.EXIF())}if(t.hasEventListener("GpsData")){t.trigger("GpsData",r,A.GPS())}}}if(p.quality){try{w=q.toDataURL(n,p.quality/100)}catch(C){w=q.toDataURL(n)}}}else{w=q.toDataURL(n)}w=w.substring(w.indexOf("base64,")+7);w=atob(w);if(y&&y.headers&&y.headers.length){w=y.restore(w);y.purge()}q.parentNode.removeChild(q);v({success:true,data:w})}else{v({success:false})}};u.src=w})}j.runtimes.Html5=j.addRuntime("html5",{getFeatures:function(){var s,o,r,q,p,n;o=r=p=n=false;if(h.XMLHttpRequest){s=new XMLHttpRequest();r=!!s.upload;o=!!(s.sendAsBinary||s.upload)}if(o){q=!!(s.sendAsBinary||(h.Uint8Array&&h.ArrayBuffer));p=!!(File&&(File.prototype.getAsDataURL||h.FileReader)&&q);n=!!(File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice))}g=j.ua.safari&&j.ua.windows;return{html5:o,dragdrop:(function(){var t=k.createElement("div");return("draggable" in t)||("ondragstart" in t&&"ondrop" in t)}()),jpgresize:p,pngresize:p,multipart:p||!!h.FileReader||!!h.FormData,canSendBinary:q,cantSendBlobInFormData:!!(j.ua.gecko&&h.FormData&&h.FileReader&&!FileReader.prototype.readAsArrayBuffer),progress:r,chunks:n,multi_selection:!(j.ua.safari&&j.ua.windows),triggerDialog:(j.ua.gecko&&h.FormData||j.ua.webkit)}},init:function(p,r){var n,q;function o(w){var u,t,v=[],x,s={};for(t=0;t<w.length;t++){u=w[t];if(s[u.name]){continue}s[u.name]=true;x=j.guid();c[x]=u;v.push(new j.File(x,u.fileName||u.name,u.fileSize||u.size))}if(v.length){p.trigger("FilesAdded",v)}}n=this.getFeatures();if(!n.html5){r({success:false});return}p.bind("Init",function(w){var G,F,C=[],v,D,t=w.settings.filters,u,B,s=k.body,E;G=k.createElement("div");G.id=w.id+"_html5_container";j.extend(G.style,{position:"absolute",background:p.settings.shim_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",zIndex:99999,opacity:p.settings.shim_bgcolor?"":0});G.className="plupload html5";if(p.settings.container){s=k.getElementById(p.settings.container);if(j.getStyle(s,"position")==="static"){s.style.position="relative"}}s.appendChild(G);no_type_restriction:for(v=0;v<t.length;v++){u=t[v].extensions.split(/,/);for(D=0;D<u.length;D++){if(u[D]==="*"){C=[];break no_type_restriction}B=j.mimeTypes[u[D]];if(B&&j.inArray(B,C)===-1){C.push(B)}}}G.innerHTML='<input id="'+p.id+'_html5"  style="font-size:999px" type="file" accept="'+C.join(",")+'" '+(p.settings.multi_selection&&p.features.multi_selection?'multiple="multiple"':"")+" />";G.scrollTop=100;E=k.getElementById(p.id+"_html5");if(w.features.triggerDialog){j.extend(E.style,{position:"absolute",width:"100%",height:"100%"})}else{j.extend(E.style,{cssFloat:"right",styleFloat:"right"})}E.onchange=function(){o(this.files);this.value=""};F=k.getElementById(w.settings.browse_button);if(F){var z=w.settings.browse_button_hover,A=w.settings.browse_button_active,x=w.features.triggerDialog?F:G;if(z){j.addEvent(x,"mouseover",function(){j.addClass(F,z)},w.id);j.addEvent(x,"mouseout",function(){j.removeClass(F,z)},w.id)}if(A){j.addEvent(x,"mousedown",function(){j.addClass(F,A)},w.id);j.addEvent(k.body,"mouseup",function(){j.removeClass(F,A)},w.id)}if(w.features.triggerDialog){j.addEvent(F,"click",function(H){var y=k.getElementById(w.id+"_html5");if(y&&!y.disabled){y.click()}H.preventDefault()},w.id)}}});p.bind("PostInit",function(){var s=k.getElementById(p.settings.drop_element);if(s){if(g){j.addEvent(s,"dragenter",function(w){var v,t,u;v=k.getElementById(p.id+"_drop");if(!v){v=k.createElement("input");v.setAttribute("type","file");v.setAttribute("id",p.id+"_drop");v.setAttribute("multiple","multiple");j.addEvent(v,"change",function(){o(this.files);j.removeEvent(v,"change",p.id);v.parentNode.removeChild(v)},p.id);s.appendChild(v)}t=j.getPos(s,k.getElementById(p.settings.container));u=j.getSize(s);if(j.getStyle(s,"position")==="static"){j.extend(s.style,{position:"relative"})}j.extend(v.style,{position:"absolute",display:"block",top:0,left:0,width:u.w+"px",height:u.h+"px",opacity:0})},p.id);return}j.addEvent(s,"dragover",function(t){t.preventDefault()},p.id);j.addEvent(s,"drop",function(u){var t=u.dataTransfer;if(t&&t.files){o(t.files)}u.preventDefault()},p.id)}});p.bind("Refresh",function(s){var t,u,v,x,w;t=k.getElementById(p.settings.browse_button);if(t){u=j.getPos(t,k.getElementById(s.settings.container));v=j.getSize(t);x=k.getElementById(p.id+"_html5_container");j.extend(x.style,{top:u.y+"px",left:u.x+"px",width:v.w+"px",height:v.h+"px"});if(p.features.triggerDialog){if(j.getStyle(t,"position")==="static"){j.extend(t.style,{position:"relative"})}w=parseInt(j.getStyle(t,"z-index"),10);if(isNaN(w)){w=0}j.extend(t.style,{zIndex:w});j.extend(x.style,{zIndex:w-1})}}});p.bind("DisableBrowse",function(s,u){var t=k.getElementById(s.id+"_html5");if(t){t.disabled=u}});p.bind("CancelUpload",function(){if(q.abort){q.abort()}});p.bind("UploadFile",function(s,u){var v=s.settings,y,t;function x(A,D,z){var B;if(File.prototype.slice){try{A.slice();return A.slice(D,z)}catch(C){return A.slice(D,z-D)}}else{if(B=File.prototype.webkitSlice||File.prototype.mozSlice){return B.call(A,D,z)}else{return null}}}function w(A){var D=0,C=0,z=("FileReader" in h)?new FileReader:null;function B(){var I,M,K,L,H,J,F,E=s.settings.url;function G(V){var T=0,N="----pluploadboundary"+j.guid(),O,P="--",U="\r\n",R="";q=new XMLHttpRequest;if(q.upload){q.upload.onprogress=function(W){u.loaded=Math.min(u.size,C+W.loaded-T);s.trigger("UploadProgress",u)}}q.onreadystatechange=function(){var W,Y;if(q.readyState==4&&s.state!==j.STOPPED){try{W=q.status}catch(X){W=0}if(W>=400){s.trigger("Error",{code:j.HTTP_ERROR,message:j.translate("HTTP Error."),file:u,status:W})}else{if(K){Y={chunk:D,chunks:K,response:q.responseText,status:W};s.trigger("ChunkUploaded",u,Y);C+=J;if(Y.cancelled){u.status=j.FAILED;return}u.loaded=Math.min(u.size,(D+1)*H)}else{u.loaded=u.size}s.trigger("UploadProgress",u);V=I=O=R=null;if(!K||++D>=K){u.status=j.DONE;s.trigger("FileUploaded",u,{response:q.responseText,status:W})}else{B()}}}};if(s.settings.multipart&&n.multipart){L.name=u.target_name||u.name;q.open("post",E,true);j.each(s.settings.headers,function(X,W){q.setRequestHeader(W,X)});if(typeof(V)!=="string"&&!!h.FormData){O=new FormData();j.each(j.extend(L,s.settings.multipart_params),function(X,W){O.append(W,X)});O.append(s.settings.file_data_name,V);q.send(O);return}if(typeof(V)==="string"){q.setRequestHeader("Content-Type","multipart/form-data; boundary="+N);j.each(j.extend(L,s.settings.multipart_params),function(X,W){R+=P+N+U+'Content-Disposition: form-data; name="'+W+'"'+U+U;R+=unescape(encodeURIComponent(X))+U});F=j.mimeTypes[u.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream";R+=P+N+U+'Content-Disposition: form-data; name="'+s.settings.file_data_name+'"; filename="'+unescape(encodeURIComponent(u.name))+'"'+U+"Content-Type: "+F+U+U+V+U+P+N+P+U;T=R.length-V.length;V=R;if(q.sendAsBinary){q.sendAsBinary(V)}else{if(n.canSendBinary){var S=new Uint8Array(V.length);for(var Q=0;Q<V.length;Q++){S[Q]=(V.charCodeAt(Q)&255)}q.send(S.buffer)}}return}}E=j.buildUrl(s.settings.url,j.extend(L,s.settings.multipart_params));q.open("post",E,true);q.setRequestHeader("Content-Type","application/octet-stream");j.each(s.settings.headers,function(X,W){q.setRequestHeader(W,X)});q.send(V)}if(u.status==j.DONE||u.status==j.FAILED||s.state==j.STOPPED){return}L={name:u.target_name||u.name};if(v.chunk_size&&u.size>v.chunk_size&&(n.chunks||typeof(A)=="string")){H=v.chunk_size;K=Math.ceil(u.size/H);J=Math.min(H,u.size-(D*H));if(typeof(A)=="string"){I=A.substring(D*H,D*H+J)}else{I=x(A,D*H,D*H+J)}L.chunk=D;L.chunks=K}else{J=u.size;I=A}if(s.settings.multipart&&n.multipart&&typeof(I)!=="string"&&z&&n.cantSendBlobInFormData&&n.chunks&&s.settings.chunk_size){z.onload=function(){G(z.result)};z.readAsBinaryString(I)}else{G(I)}}B()}y=c[u.id];if(n.jpgresize&&s.settings.resize&&/\.(png|jpg|jpeg)$/i.test(u.name)){d.call(s,u,s.settings.resize,/\.png$/i.test(u.name)?"image/png":"image/jpeg",function(z){if(z.success){u.size=z.data.length;w(z.data)}else{if(n.chunks){w(y)}else{l(y,w)}}})}else{if(!n.chunks&&n.jpgresize){l(y,w)}else{w(y)}}});p.bind("Destroy",function(s){var u,v,t=k.body,w={inputContainer:s.id+"_html5_container",inputFile:s.id+"_html5",browseButton:s.settings.browse_button,dropElm:s.settings.drop_element};for(u in w){v=k.getElementById(w[u]);if(v){j.removeAllEvents(v,s.id)}}j.removeAllEvents(k.body,s.id);if(s.settings.container){t=k.getElementById(s.settings.container)}t.removeChild(k.getElementById(w.inputContainer))});r({success:true})}});function b(){var q=false,o;function r(t,v){var s=q?0:-8*(v-1),w=0,u;for(u=0;u<v;u++){w|=(o.charCodeAt(t+u)<<Math.abs(s+u*8))}return w}function n(u,s,t){var t=arguments.length===3?t:o.length-s-1;o=o.substr(0,s)+u+o.substr(t+s)}function p(t,u,w){var x="",s=q?0:-8*(w-1),v;for(v=0;v<w;v++){x+=String.fromCharCode((u>>Math.abs(s+v*8))&255)}n(x,t,w)}return{II:function(s){if(s===e){return q}else{q=s}},init:function(s){q=false;o=s},SEGMENT:function(s,u,t){switch(arguments.length){case 1:return o.substr(s,o.length-s-1);case 2:return o.substr(s,u);case 3:n(t,s,u);break;default:return o}},BYTE:function(s){return r(s,1)},SHORT:function(s){return r(s,2)},LONG:function(s,t){if(t===e){return r(s,4)}else{p(s,t,4)}},SLONG:function(s){var t=r(s,4);return(t>2147483647?t-4294967296:t)},STRING:function(s,t){var u="";for(t+=s;s<t;s++){u+=String.fromCharCode(r(s,1))}return u}}}function f(s){var u={65505:{app:"EXIF",name:"APP1",signature:"Exif\0"},65506:{app:"ICC",name:"APP2",signature:"ICC_PROFILE\0"},65517:{app:"IPTC",name:"APP13",signature:"Photoshop 3.0\0"}},t=[],r,n,p=e,q=0,o;r=new b();r.init(s);if(r.SHORT(0)!==65496){return}n=2;o=Math.min(1048576,s.length);while(n<=o){p=r.SHORT(n);if(p>=65488&&p<=65495){n+=2;continue}if(p===65498||p===65497){break}q=r.SHORT(n+2)+2;if(u[p]&&r.STRING(n+4,u[p].signature.length)===u[p].signature){t.push({hex:p,app:u[p].app.toUpperCase(),name:u[p].name.toUpperCase(),start:n,length:q,segment:r.SEGMENT(n,q)})}n+=q}r.init(null);return{headers:t,restore:function(y){r.init(y);var w=new f(y);if(!w.headers){return false}for(var x=w.headers.length;x>0;x--){var z=w.headers[x-1];r.SEGMENT(z.start,z.length,"")}w.purge();n=r.SHORT(2)==65504?4+r.SHORT(4):2;for(var x=0,v=t.length;x<v;x++){r.SEGMENT(n,0,t[x].segment);n+=t[x].length}return r.SEGMENT()},get:function(x){var y=[];for(var w=0,v=t.length;w<v;w++){if(t[w].app===x.toUpperCase()){y.push(t[w].segment)}}return y},set:function(y,x){var z=[];if(typeof(x)==="string"){z.push(x)}else{z=x}for(var w=ii=0,v=t.length;w<v;w++){if(t[w].app===y.toUpperCase()){t[w].segment=z[ii];t[w].length=z[ii].length;ii++}if(ii>=z.length){break}}},purge:function(){t=[];r.init(null)}}}function a(){var q,n,o={},t;q=new b();n={tiff:{274:"Orientation",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};t={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function p(u,C){var w=q.SHORT(u),z,F,G,B,A,v,x,D,E=[],y={};for(z=0;z<w;z++){x=v=u+12*z+2;G=C[q.SHORT(x)];if(G===e){continue}B=q.SHORT(x+=2);A=q.LONG(x+=2);x+=4;E=[];switch(B){case 1:case 7:if(A>4){x=q.LONG(x)+o.tiffHeader}for(F=0;F<A;F++){E[F]=q.BYTE(x+F)}break;case 2:if(A>4){x=q.LONG(x)+o.tiffHeader}y[G]=q.STRING(x,A-1);continue;case 3:if(A>2){x=q.LONG(x)+o.tiffHeader}for(F=0;F<A;F++){E[F]=q.SHORT(x+F*2)}break;case 4:if(A>1){x=q.LONG(x)+o.tiffHeader}for(F=0;F<A;F++){E[F]=q.LONG(x+F*4)}break;case 5:x=q.LONG(x)+o.tiffHeader;for(F=0;F<A;F++){E[F]=q.LONG(x+F*4)/q.LONG(x+F*4+4)}break;case 9:x=q.LONG(x)+o.tiffHeader;for(F=0;F<A;F++){E[F]=q.SLONG(x+F*4)}break;case 10:x=q.LONG(x)+o.tiffHeader;for(F=0;F<A;F++){E[F]=q.SLONG(x+F*4)/q.SLONG(x+F*4+4)}break;default:continue}D=(A==1?E[0]:E);if(t.hasOwnProperty(G)&&typeof D!="object"){y[G]=t[G][D]}else{y[G]=D}}return y}function s(){var v=e,u=o.tiffHeader;q.II(q.SHORT(u)==18761);if(q.SHORT(u+=2)!==42){return false}o.IFD0=o.tiffHeader+q.LONG(u+=2);v=p(o.IFD0,n.tiff);o.exifIFD=("ExifIFDPointer" in v?o.tiffHeader+v.ExifIFDPointer:e);o.gpsIFD=("GPSInfoIFDPointer" in v?o.tiffHeader+v.GPSInfoIFDPointer:e);return true}function r(w,u,z){var B,y,x,A=0;if(typeof(u)==="string"){var v=n[w.toLowerCase()];for(hex in v){if(v[hex]===u){u=hex;break}}}B=o[w.toLowerCase()+"IFD"];y=q.SHORT(B);for(i=0;i<y;i++){x=B+12*i+2;if(q.SHORT(x)==u){A=x+8;break}}if(!A){return false}q.LONG(A,z);return true}return{init:function(u){o={tiffHeader:10};if(u===e||!u.length){return false}q.init(u);if(q.SHORT(0)===65505&&q.STRING(4,5).toUpperCase()==="EXIF\0"){return s()}return false},EXIF:function(){var v;v=p(o.exifIFD,n.exif);if(v.ExifVersion&&j.typeOf(v.ExifVersion)==="array"){for(var w=0,u="";w<v.ExifVersion.length;w++){u+=String.fromCharCode(v.ExifVersion[w])}v.ExifVersion=u}return v},GPS:function(){var u;u=p(o.gpsIFD,n.gps);if(u.GPSVersionID){u.GPSVersionID=u.GPSVersionID.join(".")}return u},setExif:function(u,v){if(u!=="PixelXDimension"&&u!=="PixelYDimension"){return false}return r("exif",u,v)},getBinary:function(){return q.SEGMENT()}}}})(window,document,plupload);(function(d,a,b,c){function e(f){return a.getElementById(f)}b.runtimes.Html4=b.addRuntime("html4",{getFeatures:function(){return{multipart:true,triggerDialog:(b.ua.gecko&&d.FormData||b.ua.webkit)}},init:function(f,g){f.bind("Init",function(p){var j=a.body,n,h="javascript",k,x,q,z=[],r=/MSIE/.test(navigator.userAgent),t=[],m=p.settings.filters,o,l,s,w;no_type_restriction:for(o=0;o<m.length;o++){l=m[o].extensions.split(/,/);for(w=0;w<l.length;w++){if(l[w]==="*"){t=[];break no_type_restriction}s=b.mimeTypes[l[w]];if(s&&b.inArray(s,t)===-1){t.push(s)}}}t=t.join(",");function v(){var C,A,y,B;q=b.guid();z.push(q);C=a.createElement("form");C.setAttribute("id","form_"+q);C.setAttribute("method","post");C.setAttribute("enctype","multipart/form-data");C.setAttribute("encoding","multipart/form-data");C.setAttribute("target",p.id+"_iframe");C.style.position="absolute";A=a.createElement("input");A.setAttribute("id","input_"+q);A.setAttribute("type","file");A.setAttribute("accept",t);A.setAttribute("size",1);B=e(p.settings.browse_button);if(p.features.triggerDialog&&B){b.addEvent(e(p.settings.browse_button),"click",function(D){if(!A.disabled){A.click()}D.preventDefault()},p.id)}b.extend(A.style,{width:"100%",height:"100%",opacity:0,fontSize:"99px"});b.extend(C.style,{overflow:"hidden"});y=p.settings.shim_bgcolor;if(y){C.style.background=y}if(r){b.extend(A.style,{filter:"alpha(opacity=0)"})}b.addEvent(A,"change",function(G){var E=G.target,D,F=[],H;if(E.value){e("form_"+q).style.top=-1048575+"px";D=E.value.replace(/\\/g,"/");D=D.substring(D.length,D.lastIndexOf("/")+1);F.push(new b.File(q,D));if(!p.features.triggerDialog){b.removeAllEvents(C,p.id)}else{b.removeEvent(B,"click",p.id)}b.removeEvent(A,"change",p.id);v();if(F.length){f.trigger("FilesAdded",F)}}},p.id);C.appendChild(A);j.appendChild(C);p.refresh()}function u(){var y=a.createElement("div");y.innerHTML='<iframe id="'+p.id+'_iframe" name="'+p.id+'_iframe" src="'+h+':&quot;&quot;" style="display:none"></iframe>';n=y.firstChild;j.appendChild(n);b.addEvent(n,"load",function(D){var E=D.target,C,A;if(!k){return}try{C=E.contentWindow.document||E.contentDocument||d.frames[E.id].document}catch(B){p.trigger("Error",{code:b.SECURITY_ERROR,message:b.translate("Security error."),file:k});return}A=C.body.innerHTML;if(A){k.status=b.DONE;k.loaded=1025;k.percent=100;p.trigger("UploadProgress",k);p.trigger("FileUploaded",k,{response:A})}},p.id)}if(p.settings.container){j=e(p.settings.container);if(b.getStyle(j,"position")==="static"){j.style.position="relative"}}p.bind("UploadFile",function(y,B){var C,A;if(B.status==b.DONE||B.status==b.FAILED||y.state==b.STOPPED){return}C=e("form_"+B.id);A=e("input_"+B.id);A.setAttribute("name",y.settings.file_data_name);C.setAttribute("action",y.settings.url);b.each(b.extend({name:B.target_name||B.name},y.settings.multipart_params),function(F,D){var E=a.createElement("input");b.extend(E,{type:"hidden",name:D,value:F});C.insertBefore(E,C.firstChild)});k=B;e("form_"+q).style.top=-1048575+"px";C.submit();C.parentNode.removeChild(C)});p.bind("FileUploaded",function(y){y.refresh()});p.bind("StateChanged",function(y){if(y.state==b.STARTED){u()}if(y.state==b.STOPPED){d.setTimeout(function(){b.removeEvent(n,"load",y.id);if(n.parentNode){n.parentNode.removeChild(n)}},0)}});p.bind("Refresh",function(A){var G,B,C,D,y,H,I,F,E;G=e(A.settings.browse_button);if(G){y=b.getPos(G,e(A.settings.container));H=b.getSize(G);I=e("form_"+q);F=e("input_"+q);b.extend(I.style,{top:y.y+"px",left:y.x+"px",width:H.w+"px",height:H.h+"px"});if(A.features.triggerDialog){if(b.getStyle(G,"position")==="static"){b.extend(G.style,{position:"relative"})}E=parseInt(G.style.zIndex,10);if(isNaN(E)){E=0}b.extend(G.style,{zIndex:E});b.extend(I.style,{zIndex:E-1})}C=A.settings.browse_button_hover;D=A.settings.browse_button_active;B=A.features.triggerDialog?G:I;if(C){b.addEvent(B,"mouseover",function(){b.addClass(G,C)},A.id);b.addEvent(B,"mouseout",function(){b.removeClass(G,C)},A.id)}if(D){b.addEvent(B,"mousedown",function(){b.addClass(G,D)},A.id);b.addEvent(a.body,"mouseup",function(){b.removeClass(G,D)},A.id)}}});f.bind("FilesRemoved",function(y,B){var A,C;for(A=0;A<B.length;A++){C=e("form_"+B[A].id);if(C){C.parentNode.removeChild(C)}}});f.bind("DisableBrowse",function(y,B){var A=a.getElementById("input_"+q);if(A){A.disabled=B}});f.bind("Destroy",function(y){var A,B,C,D={inputContainer:"form_"+q,inputFile:"input_"+q,browseButton:y.settings.browse_button};for(A in D){B=e(D[A]);if(B){b.removeAllEvents(B,y.id)}}b.removeAllEvents(a.body,y.id);b.each(z,function(F,E){C=e("form_"+F);if(C){j.removeChild(C)}})});v()});g({success:true})}})})(window,document,plupload);(function($){$.fn.jqm=function(o){var p={overlay:50,overlayClass:'jqmOverlay',closeClass:'jqmClose',trigger:'.jqModal',ajax:F,ajaxText:'',target:F,modal:true,toTop:F,onShow:F,onHide:F,onLoad:F};return this.each(function(){if(this._jqm)return H[this._jqm].c=$.extend({},H[this._jqm].c,o);s++;this._jqm=s;H[s]={c:$.extend(p,$.jqm.params,o),a:F,w:$(this).addClass('jqmID'+s),s:s};if(p.trigger)$(this).jqmAddTrigger(p.trigger);});};$.fn.jqmAddClose=function(e){return hs(this,e,'jqmHide');};$.fn.jqmAddTrigger=function(e){return hs(this,e,'jqmShow');};$.fn.jqmShow=function(t){return this.each(function(){t=t||window.event;$.jqm.open(this._jqm,t);});};$.fn.jqmHide=function(t){return this.each(function(){t=t||window.event;$.jqm.close(this._jqm,t)});};$.jqm={hash:{},open:function(s,t){var h=H[s],c=h.c,cc='.'+c.closeClass,z=(parseInt(h.w.css('z-index'))),z=(z>0)?z:3000,o=$('<div></div>').css({height:'100%',width:'100%',position:'fixed',left:0,top:0,'z-index':z-1,opacity:c.overlay/100});if(h.a)return F;h.t=t;h.a=true;h.w.css('z-index',z);if(c.modal){if(!A[0])L('bind');A.push(s);}
else if(c.overlay>0)h.w.jqmAddClose(o);else o=F;h.o=(o)?o.addClass(c.overlayClass).prependTo('body'):F;if(ie6){$('html,body').css({height:'100%',width:'100%'});if(o){o=o.css({position:'absolute'})[0];for(var y in{Top:1,Left:1})o.style.setExpression(y.toLowerCase(),"(_=(document.documentElement.scroll"+y+" || document.body.scroll"+y+"))+'px'");}}
if(c.ajax){var r=c.target||h.w,u=c.ajax,r=(typeof r=='string')?$(r,h.w):$(r),u=(u.substr(0,1)=='@')?$(t).attr(u.substring(1)):u;r.html(c.ajaxText).load(u,function(){if(c.onLoad)c.onLoad.call(this,h);if(cc)h.w.jqmAddClose($(cc,h.w));e(h);});}
else if(cc)h.w.jqmAddClose($(cc,h.w));if(c.toTop&&h.o)h.w.before('<span id="jqmP'+h.w[0]._jqm+'"></span>').insertAfter(h.o);(c.onShow)?c.onShow(h):h.w.show();e(h);return F;},close:function(s){var h=H[s];if(!h.a)return F;h.a=F;if(A[0]){A.pop();if(!A[0])L('unbind');}
if(h.c.toTop&&h.o)$('#jqmP'+h.w[0]._jqm).after(h.w).remove();if(h.c.onHide)h.c.onHide(h);else{h.w.hide();if(h.o)h.o.remove();}
return F;},params:{}};var s=0,H=$.jqm.hash,A=[],ie6=$.browser.msie&&($.browser.version=="6.0"),F=false,i=$('<iframe src="javascript:false;document.write(\'\');" class="jqm"></iframe>').css({opacity:0}),e=function(h){if(ie6)if(h.o)h.o.html('<p style="width:100%;height:100%"/>').prepend(i);else if(!$('iframe.jqm',h.w)[0])h.w.prepend(i);f(h);},f=function(h){try{$(':input:visible',h.w)[0].focus();}catch(_){}},L=function(t){$()[t]("keypress",m)[t]("keydown",m)[t]("mousedown",m);},m=function(e){var h=H[A[A.length-1]],r=(!$(e.target).parents('.jqmID'+h.s)[0]);if(r)f(h);return!r;},hs=function(w,t,c){return w.each(function(){var s=this._jqm;$(t).each(function(){if(!this[c]){this[c]=[];$(this).click(function(){for(var i in{jqmShow:1,jqmHide:1})for(var s in this[i])if(H[this[i][s]])H[this[i][s]].w[i](this);return F;});}
this[c].push(s);});});};})(jQuery);/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */

(function ($) {
// Default settings
var DEFAULT_SETTINGS = {
	// Search settings
    method: "GET",
    contentType: "json",
    queryParam: "q",
    searchDelay: 300,
    minChars: 1,
    propertyToSearch: "name",
    jsonContainer: null,

	// Display settings
    hintText: "Type in a search term",
    noResultsText: "No results",
    searchingText: "Searching...",
    deleteText: "&times;",
    animateDropdown: true,

	// Tokenization settings
    tokenLimit: null,
    tokenDelimiter: ",",
    preventDuplicates: false,

	// Output settings
    tokenValue: "id",

	// Prepopulation settings
    prePopulate: null,
    processPrePopulate: false,

	// Manipulation settings
    idPrefix: "token-input-",

	// Formatters
    resultsFormatter: function(item){ return "<li>" + item[this.propertyToSearch]+ "</li>" },
    tokenFormatter: function(item) { return "<li><p>" + item[this.propertyToSearch] + "</p></li>" },

	// Callbacks
    onResult: null,
    onAdd: null,
    onDelete: null,
    onReady: null
};

// Default classes to use when theming
var DEFAULT_CLASSES = {
    tokenList: "token-input-list",
    token: "token-input-token",
    tokenDelete: "token-input-delete-token",
    selectedToken: "token-input-selected-token",
    highlightedToken: "token-input-highlighted-token",
    dropdown: "token-input-dropdown",
    dropdownItem: "token-input-dropdown-item",
    dropdownItem2: "token-input-dropdown-item2",
    selectedDropdownItem: "token-input-selected-dropdown-item",
    inputToken: "token-input-input-token"
};

// Input box position "enum"
var POSITION = {
    BEFORE: 0,
    AFTER: 1,
    END: 2
};

// Keys "enum"
var KEY = {
    BACKSPACE: 8,
    TAB: 9,
    ENTER: 13,
    ESCAPE: 27,
    SPACE: 32,
    PAGE_UP: 33,
    PAGE_DOWN: 34,
    END: 35,
    HOME: 36,
    LEFT: 37,
    UP: 38,
    RIGHT: 39,
    DOWN: 40,
    NUMPAD_ENTER: 108,
    COMMA: 188
};

// Additional public (exposed) methods
var methods = {
    init: function(url_or_data_or_function, options) {
        var settings = $.extend({}, DEFAULT_SETTINGS, options || {});

        return this.each(function () {
            $(this).data("tokenInputObject", new $.TokenList(this, url_or_data_or_function, settings));
        });
    },
    clear: function() {
        this.data("tokenInputObject").clear();
        return this;
    },
    add: function(item) {
        this.data("tokenInputObject").add(item);
        return this;
    },
    remove: function(item) {
        this.data("tokenInputObject").remove(item);
        return this;
    },
    get: function() {
    	return this.data("tokenInputObject").getTokens();
   	}
}

// Expose the .tokenInput function to jQuery as a plugin
$.fn.tokenInput = function (method) {
    // Method calling and initialization logic
    if(methods[method]) {
        return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
    } else {
        return methods.init.apply(this, arguments);
    }
};

// TokenList class for each input
$.TokenList = function (input, url_or_data, settings) {
    //
    // Initialization
    //

    // Configure the data source
    if($.type(url_or_data) === "string" || $.type(url_or_data) === "function") {
        // Set the url to query against
        settings.url = url_or_data;

        // If the URL is a function, evaluate it here to do our initalization work
        var url = computeURL();

        // Make a smart guess about cross-domain if it wasn't explicitly specified
        if(settings.crossDomain === undefined) {
            if(url.indexOf("://") === -1) {
                settings.crossDomain = false;
            } else {
                settings.crossDomain = (location.href.split(/\/+/g)[1] !== url.split(/\/+/g)[1]);
            }
        }
    } else if(typeof(url_or_data) === "object") {
        // Set the local data to search through
        settings.local_data = url_or_data;
    }

    // Build class names
    if(settings.classes) {
        // Use custom class names
        settings.classes = $.extend({}, DEFAULT_CLASSES, settings.classes);
    } else if(settings.theme) {
        // Use theme-suffixed default class names
        settings.classes = {};
        $.each(DEFAULT_CLASSES, function(key, value) {
            settings.classes[key] = value + "-" + settings.theme;
        });
    } else {
        settings.classes = DEFAULT_CLASSES;
    }


    // Save the tokens
    var saved_tokens = [];

    // Keep track of the number of tokens in the list
    var token_count = 0;

    // Basic cache to save on db hits
    var cache = new $.TokenList.Cache();

    // Keep track of the timeout, old vals
    var timeout;
    var input_val;

    // Create a new text input an attach keyup events
    var input_box = $("<input type=\"text\"  autocomplete=\"off\">")
        .css({
            outline: "none"
        })
        .attr("id", settings.idPrefix + input.id)
        .focus(function () {
            if (settings.tokenLimit === null || settings.tokenLimit !== token_count) {
                show_dropdown_hint();
            }
        })
        .blur(function () {
            hide_dropdown();
            $(this).val("");
        })
        .bind("keyup keydown blur update", resize_input)
        .keydown(function (event) {
            var previous_token;
            var next_token;

            switch(event.keyCode) {
                case KEY.LEFT:
                case KEY.RIGHT:
                case KEY.UP:
                case KEY.DOWN:
                    if(!$(this).val()) {
                        previous_token = input_token.prev();
                        next_token = input_token.next();

                        if((previous_token.length && previous_token.get(0) === selected_token) || (next_token.length && next_token.get(0) === selected_token)) {
                            // Check if there is a previous/next token and it is selected
                            if(event.keyCode === KEY.LEFT || event.keyCode === KEY.UP) {
                                deselect_token($(selected_token), POSITION.BEFORE);
                            } else {
                                deselect_token($(selected_token), POSITION.AFTER);
                            }
                        } else if((event.keyCode === KEY.LEFT || event.keyCode === KEY.UP) && previous_token.length) {
                            // We are moving left, select the previous token if it exists
                            select_token($(previous_token.get(0)));
                        } else if((event.keyCode === KEY.RIGHT || event.keyCode === KEY.DOWN) && next_token.length) {
                            // We are moving right, select the next token if it exists
                            select_token($(next_token.get(0)));
                        }
                    } else {
                        var dropdown_item = null;

                        if(event.keyCode === KEY.DOWN || event.keyCode === KEY.RIGHT) {
                            dropdown_item = $(selected_dropdown_item).next();
                        } else {
                            dropdown_item = $(selected_dropdown_item).prev();
                        }

                        if(dropdown_item.length) {
                            select_dropdown_item(dropdown_item);
                        }
                        return false;
                    }
                    break;

                case KEY.BACKSPACE:
                    previous_token = input_token.prev();

                    if(!$(this).val().length) {
                        if(selected_token) {
                            delete_token($(selected_token));
                            hidden_input.change();
                        } else if(previous_token.length) {
                            select_token($(previous_token.get(0)));
                        }

                        return false;
                    } else if($(this).val().length === 1) {
                        hide_dropdown();
                    } else {
                        // set a timeout just long enough to let this function finish.
                        setTimeout(function(){do_search();}, 5);
                    }
                    break;

                case KEY.TAB:
                case KEY.ENTER:
                case KEY.NUMPAD_ENTER:
                case KEY.COMMA:
                  if(selected_dropdown_item) {
                    add_token($(selected_dropdown_item).data("tokeninput"));
                    hidden_input.change();
                    return false;
                  }
                  break;

                case KEY.ESCAPE:
                  hide_dropdown();
                  return true;

                default:
                    if(String.fromCharCode(event.which)) {
                        // set a timeout just long enough to let this function finish.
                        setTimeout(function(){do_search();}, 5);
                    }
                    break;
            }
        });

    // Keep a reference to the original input box
    var hidden_input = $(input)
                           .hide()
                           .val("")
                           .focus(function () {
                               input_box.focus();
                           })
                           .blur(function () {
                               input_box.blur();
                           });

    // Keep a reference to the selected token and dropdown item
    var selected_token = null;
    var selected_token_index = 0;
    var selected_dropdown_item = null;

    // The list to store the token items in
    var token_list = $("<ul />")
        .addClass(settings.classes.tokenList)
        .click(function (event) {
            var li = $(event.target).closest("li");
            if(li && li.get(0) && $.data(li.get(0), "tokeninput")) {
                toggle_select_token(li);
            } else {
                // Deselect selected token
                if(selected_token) {
                    deselect_token($(selected_token), POSITION.END);
                }

                // Focus input box
                input_box.focus();
            }
        })
        .mouseover(function (event) {
            var li = $(event.target).closest("li");
            if(li && selected_token !== this) {
                li.addClass(settings.classes.highlightedToken);
            }
        })
        .mouseout(function (event) {
            var li = $(event.target).closest("li");
            if(li && selected_token !== this) {
                li.removeClass(settings.classes.highlightedToken);
            }
        })
        .insertBefore(hidden_input);

    // The token holding the input box
    var input_token = $("<li />")
        .addClass(settings.classes.inputToken)
        .appendTo(token_list)
        .append(input_box);

    // The list to store the dropdown items in
    var dropdown = $("<div>")
        .addClass(settings.classes.dropdown)
        .appendTo("body")
        .hide();

    // Magic element to help us resize the text input
    var input_resizer = $("<tester/>")
        .insertAfter(input_box)
        .css({
            position: "absolute",
            top: -9999,
            left: -9999,
            width: "auto",
            fontSize: input_box.css("fontSize"),
            fontFamily: input_box.css("fontFamily"),
            fontWeight: input_box.css("fontWeight"),
            letterSpacing: input_box.css("letterSpacing"),
            whiteSpace: "nowrap"
        });

    // Pre-populate list if items exist
    hidden_input.val("");
    var li_data = settings.prePopulate || hidden_input.data("pre");
    if(settings.processPrePopulate && $.isFunction(settings.onResult)) {
        li_data = settings.onResult.call(hidden_input, li_data);
    }
    if(li_data && li_data.length) {
        $.each(li_data, function (index, value) {
            insert_token(value);
            checkTokenLimit();
        });
    }

    // Initialization is done
    if($.isFunction(settings.onReady)) {
        settings.onReady.call();
    }

    //
    // Public functions
    //

    this.clear = function() {
        token_list.children("li").each(function() {
            if ($(this).children("input").length === 0) {
                delete_token($(this));
            }
        });
    }

    this.add = function(item) {
        add_token(item);
    }

    this.remove = function(item) {
        token_list.children("li").each(function() {
            if ($(this).children("input").length === 0) {
                var currToken = $(this).data("tokeninput");
                var match = true;
                for (var prop in item) {
                    if (item[prop] !== currToken[prop]) {
                        match = false;
                        break;
                    }
                }
                if (match) {
                    delete_token($(this));
                }
            }
        });
    }

    this.getTokens = function() {
   		return saved_tokens;
   	}

    //
    // Private functions
    //

    function checkTokenLimit() {
        if(settings.tokenLimit !== null && token_count >= settings.tokenLimit) {
            input_box.hide();
            hide_dropdown();
            return;
        }
    }

    function resize_input() {
        if(input_val === (input_val = input_box.val())) {return;}

        // Enter new content into resizer and resize input accordingly
        var escaped = input_val.replace(/&/g, '&amp;').replace(/\s/g,' ').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        input_resizer.html(escaped);
        input_box.width(input_resizer.width() + 30);
    }

    function is_printable_character(keycode) {
        return ((keycode >= 48 && keycode <= 90) ||     // 0-1a-z
                (keycode >= 96 && keycode <= 111) ||    // numpad 0-9 + - / * .
                (keycode >= 186 && keycode <= 192) ||   // ; = , - . / ^
                (keycode >= 219 && keycode <= 222));    // ( \ ) '
    }

    // Inner function to a token to the list
    function insert_token(item) {
        var this_token = settings.tokenFormatter(item);
        this_token = $(this_token)
          .addClass(settings.classes.token)
          .insertBefore(input_token);

        // The 'delete token' button
        $("<span>" + settings.deleteText + "</span>")
            .addClass(settings.classes.tokenDelete)
            .appendTo(this_token)
            .click(function () {
                delete_token($(this).parent());
                hidden_input.change();
                return false;
            });

        // Store data on the token
        var token_data = {"id": item.id};
        token_data[settings.propertyToSearch] = item[settings.propertyToSearch];
        $.data(this_token.get(0), "tokeninput", item);

        // Save this token for duplicate checking
        saved_tokens = saved_tokens.slice(0,selected_token_index).concat([token_data]).concat(saved_tokens.slice(selected_token_index));
        selected_token_index++;

        // Update the hidden input
        update_hidden_input(saved_tokens, hidden_input);

        token_count += 1;

        // Check the token limit
        if(settings.tokenLimit !== null && token_count >= settings.tokenLimit) {
            input_box.hide();
            hide_dropdown();
        }

        return this_token;
    }

    // Add a token to the token list based on user input
    function add_token (item) {
        var callback = settings.onAdd;

        // See if the token already exists and select it if we don't want duplicates
        if(token_count > 0 && settings.preventDuplicates) {
            var found_existing_token = null;
            token_list.children().each(function () {
                var existing_token = $(this);
                var existing_data = $.data(existing_token.get(0), "tokeninput");
                if(existing_data && existing_data.id === item.id) {
                    found_existing_token = existing_token;
                    return false;
                }
            });

            if(found_existing_token) {
                select_token(found_existing_token);
                input_token.insertAfter(found_existing_token);
                input_box.focus();
                return;
            }
        }

        // Insert the new tokens
        if(settings.tokenLimit == null || token_count < settings.tokenLimit) {
            insert_token(item);
            checkTokenLimit();
        }

        // Clear input box
        input_box.val("");

        // Don't show the help dropdown, they've got the idea
        hide_dropdown();

        // Execute the onAdd callback if defined
        if($.isFunction(callback)) {
            callback.call(hidden_input,item);
        }
    }

    // Select a token in the token list
    function select_token (token) {
        token.addClass(settings.classes.selectedToken);
        selected_token = token.get(0);

        // Hide input box
        input_box.val("");

        // Hide dropdown if it is visible (eg if we clicked to select token)
        hide_dropdown();
    }

    // Deselect a token in the token list
    function deselect_token (token, position) {
        token.removeClass(settings.classes.selectedToken);
        selected_token = null;

        if(position === POSITION.BEFORE) {
            input_token.insertBefore(token);
            selected_token_index--;
        } else if(position === POSITION.AFTER) {
            input_token.insertAfter(token);
            selected_token_index++;
        } else {
            input_token.appendTo(token_list);
            selected_token_index = token_count;
        }

        // Show the input box and give it focus again
        input_box.focus();
    }

    // Toggle selection of a token in the token list
    function toggle_select_token(token) {
        var previous_selected_token = selected_token;

        if(selected_token) {
            deselect_token($(selected_token), POSITION.END);
        }

        if(previous_selected_token === token.get(0)) {
            deselect_token(token, POSITION.END);
        } else {
            select_token(token);
        }
    }

    // Delete a token from the token list
    function delete_token (token) {
        // Remove the id from the saved list
        var token_data = $.data(token.get(0), "tokeninput");
        var callback = settings.onDelete;

        var index = token.prevAll().length;
        if(index > selected_token_index) index--;

        // Delete the token
        token.remove();
        selected_token = null;

        // Show the input box and give it focus again
        input_box.focus();

        // Remove this token from the saved list
        saved_tokens = saved_tokens.slice(0,index).concat(saved_tokens.slice(index+1));
        if(index < selected_token_index) selected_token_index--;

        // Update the hidden input
        update_hidden_input(saved_tokens, hidden_input);

        token_count -= 1;

        if(settings.tokenLimit !== null) {
            input_box
                .show()
                .val("")
                .focus();
        }

        // Execute the onDelete callback if defined
        if($.isFunction(callback)) {
            callback.call(hidden_input,token_data);
        }
    }

    // Update the hidden input box value
    function update_hidden_input(saved_tokens, hidden_input) {
        var token_values = $.map(saved_tokens, function (el) {
            return el[settings.tokenValue];
        });
        hidden_input.val(token_values.join(settings.tokenDelimiter));

    }

    // Hide and clear the results dropdown
    function hide_dropdown () {
        dropdown.hide().empty();
        selected_dropdown_item = null;
    }

    function show_dropdown() {
        dropdown
            .css({
                position: "absolute",
                top: $(token_list).offset().top + $(token_list).outerHeight(),
                left: $(token_list).offset().left,
                zindex: 999
            })
            .show();
    }

    function show_dropdown_searching () {
        if(settings.searchingText) {
            dropdown.html("<p>"+settings.searchingText+"</p>");
            show_dropdown();
        }
    }

    function show_dropdown_hint () {
        if(settings.hintText) {
            dropdown.html("<p>"+settings.hintText+"</p>");
            show_dropdown();
        }
    }

    // Highlight the query part of the search term
    function highlight_term(value, term) {
        value = value.replace(/\\/g, "");
        return value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + term + ")(?![^<>]*>)(?![^&;]+;)", "gi"), "<b>$1</b>");
    }

    function find_value_and_highlight_term(template, value, term) {
        value = value.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
        return template.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + value + ")(?![^<>]*>)(?![^&;]+;)", "g"), highlight_term(value, term));
    }

    // Populate the results dropdown with some results
    function populate_dropdown (query, results) {
        if(results && results.length) {
            dropdown.empty();
            var dropdown_ul = $("<ul>")
                .appendTo(dropdown)
                .mouseover(function (event) {
                    select_dropdown_item($(event.target).closest("li"));
                })
                .mousedown(function (event) {
                    add_token($(event.target).closest("li").data("tokeninput"));
                    hidden_input.change();
                    return false;
                })
                .hide();

            $.each(results, function(index, value) {
                var this_li = settings.resultsFormatter(value);

                this_li = find_value_and_highlight_term(this_li ,value[settings.propertyToSearch], query);

                this_li = $(this_li).appendTo(dropdown_ul);

                if(index % 2) {
                    this_li.addClass(settings.classes.dropdownItem);
                } else {
                    this_li.addClass(settings.classes.dropdownItem2);
                }

                if(index === 0) {
                    select_dropdown_item(this_li);
                }

                $.data(this_li.get(0), "tokeninput", value);
            });

            show_dropdown();

            if(settings.animateDropdown) {
                dropdown_ul.slideDown("fast");
            } else {
                dropdown_ul.show();
            }
        } else {
            if(settings.noResultsText) {
                dropdown.html("<p>"+settings.noResultsText+"</p>");
                show_dropdown();
            }
        }
    }

    // Highlight an item in the results dropdown
    function select_dropdown_item (item) {
        if(item) {
            if(selected_dropdown_item) {
                deselect_dropdown_item($(selected_dropdown_item));
            }

            item.addClass(settings.classes.selectedDropdownItem);
            selected_dropdown_item = item.get(0);
        }
    }

    // Remove highlighting from an item in the results dropdown
    function deselect_dropdown_item (item) {
        item.removeClass(settings.classes.selectedDropdownItem);
        selected_dropdown_item = null;
    }

    // Do a search and show the "searching" dropdown if the input is longer
    // than settings.minChars
    function do_search() {
        var query = input_box.val().toLowerCase();

        if(query && query.length) {
            if(selected_token) {
                deselect_token($(selected_token), POSITION.AFTER);
            }

            if(query.length >= settings.minChars) {
                show_dropdown_searching();
                clearTimeout(timeout);

                timeout = setTimeout(function(){
                    run_search(query);
                }, settings.searchDelay);
            } else {
                hide_dropdown();
            }
        }
    }

    // Do the actual search
    function run_search(query) {
        var cache_key = query + computeURL();
        var cached_results = cache.get(cache_key);
        if(cached_results) {
            populate_dropdown(query, cached_results);
        } else {
            // Are we doing an ajax search or local data search?
            if(settings.url) {
                var url = computeURL();
                // Extract exisiting get params
                var ajax_params = {};
                ajax_params.data = {};
                if(url.indexOf("?") > -1) {
                    var parts = url.split("?");
                    ajax_params.url = parts[0];

                    var param_array = parts[1].split("&");
                    $.each(param_array, function (index, value) {
                        var kv = value.split("=");
                        ajax_params.data[kv[0]] = kv[1];
                    });
                } else {
                    ajax_params.url = url;
                }

                // Prepare the request
                ajax_params.data[settings.queryParam] = query;
                ajax_params.type = settings.method;
                ajax_params.dataType = settings.contentType;
                if(settings.crossDomain) {
                    ajax_params.dataType = "jsonp";
                }

                // Attach the success callback
                ajax_params.success = function(results) {
                  if($.isFunction(settings.onResult)) {
                      results = settings.onResult.call(hidden_input, results);
                  }
                  cache.add(cache_key, settings.jsonContainer ? results[settings.jsonContainer] : results);

                  // only populate the dropdown if the results are associated with the active search query
                  if(input_box.val().toLowerCase() === query) {
                      populate_dropdown(query, settings.jsonContainer ? results[settings.jsonContainer] : results);
                  }
                };

                // Make the request
                $.ajax(ajax_params);
            } else if(settings.local_data) {
                // Do the search through local data
                var results = $.grep(settings.local_data, function (row) {
                    return row[settings.propertyToSearch].toLowerCase().indexOf(query.toLowerCase()) > -1;
                });

                if($.isFunction(settings.onResult)) {
                    results = settings.onResult.call(hidden_input, results);
                }
                cache.add(cache_key, results);
                populate_dropdown(query, results);
            }
        }
    }

    // compute the dynamic URL
    function computeURL() {
        var url = settings.url;
        if(typeof settings.url == 'function') {
            url = settings.url.call();
        }
        return url;
    }
};

// Really basic cache for the results
$.TokenList.Cache = function (options) {
    var settings = $.extend({
        max_size: 500
    }, options);

    var data = {};
    var size = 0;

    var flush = function () {
        data = {};
        size = 0;
    };

    this.add = function (query, results) {
        if(size > settings.max_size) {
            flush();
        }

        if(!data[query]) {
            size += 1;
        }

        data[query] = results;
    };

    this.get = function (query) {
        return data[query];
    };
};
}(jQuery));
//! moment.js
//! version : 2.8.1
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
(function(a){function b(a,b,c){switch(arguments.length){case 2:return null!=a?a:b;case 3:return null!=a?a:null!=b?b:c;default:throw new Error("Implement me")}}function c(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function d(a){rb.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+a)}function e(a,b){var c=!0;return l(function(){return c&&(d(a),c=!1),b.apply(this,arguments)},b)}function f(a,b){nc[a]||(d(b),nc[a]=!0)}function g(a,b){return function(c){return o(a.call(this,c),b)}}function h(a,b){return function(c){return this.localeData().ordinal(a.call(this,c),b)}}function i(){}function j(a,b){b!==!1&&E(a),m(this,a),this._d=new Date(+a._d)}function k(a){var b=x(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._milliseconds=+k+1e3*j+6e4*i+36e5*h,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._locale=rb.localeData(),this._bubble()}function l(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return b.hasOwnProperty("toString")&&(a.toString=b.toString),b.hasOwnProperty("valueOf")&&(a.valueOf=b.valueOf),a}function m(a,b){var c,d,e;if("undefined"!=typeof b._isAMomentObject&&(a._isAMomentObject=b._isAMomentObject),"undefined"!=typeof b._i&&(a._i=b._i),"undefined"!=typeof b._f&&(a._f=b._f),"undefined"!=typeof b._l&&(a._l=b._l),"undefined"!=typeof b._strict&&(a._strict=b._strict),"undefined"!=typeof b._tzm&&(a._tzm=b._tzm),"undefined"!=typeof b._isUTC&&(a._isUTC=b._isUTC),"undefined"!=typeof b._offset&&(a._offset=b._offset),"undefined"!=typeof b._pf&&(a._pf=b._pf),"undefined"!=typeof b._locale&&(a._locale=b._locale),Fb.length>0)for(c in Fb)d=Fb[c],e=b[d],"undefined"!=typeof e&&(a[d]=e);return a}function n(a){return 0>a?Math.ceil(a):Math.floor(a)}function o(a,b,c){for(var d=""+Math.abs(a),e=a>=0;d.length<b;)d="0"+d;return(e?c?"+":"":"-")+d}function p(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function q(a,b){var c;return b=J(b,a),a.isBefore(b)?c=p(a,b):(c=p(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c}function r(a,b){return function(c,d){var e,g;return null===d||isNaN(+d)||(f(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period)."),g=c,c=d,d=g),c="string"==typeof c?+c:c,e=rb.duration(c,d),s(this,e,a),this}}function s(a,b,c,d){var e=b._milliseconds,f=b._days,g=b._months;d=null==d?!0:d,e&&a._d.setTime(+a._d+e*c),f&&lb(a,"Date",kb(a,"Date")+f*c),g&&jb(a,kb(a,"Month")+g*c),d&&rb.updateOffset(a,f||g)}function t(a){return"[object Array]"===Object.prototype.toString.call(a)}function u(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function v(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;e>d;d++)(c&&a[d]!==b[d]||!c&&z(a[d])!==z(b[d]))&&g++;return g+f}function w(a){if(a){var b=a.toLowerCase().replace(/(.)s$/,"$1");a=gc[a]||hc[b]||b}return a}function x(a){var b,c,d={};for(c in a)a.hasOwnProperty(c)&&(b=w(c),b&&(d[b]=a[c]));return d}function y(b){var c,d;if(0===b.indexOf("week"))c=7,d="day";else{if(0!==b.indexOf("month"))return;c=12,d="month"}rb[b]=function(e,f){var g,h,i=rb._locale[b],j=[];if("number"==typeof e&&(f=e,e=a),h=function(a){var b=rb().utc().set(d,a);return i.call(rb._locale,b,e||"")},null!=f)return h(f);for(g=0;c>g;g++)j.push(h(g));return j}}function z(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function A(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function B(a,b,c){return fb(rb([a,11,31+b-c]),b,c).week}function C(a){return D(a)?366:365}function D(a){return a%4===0&&a%100!==0||a%400===0}function E(a){var b;a._a&&-2===a._pf.overflow&&(b=a._a[yb]<0||a._a[yb]>11?yb:a._a[zb]<1||a._a[zb]>A(a._a[xb],a._a[yb])?zb:a._a[Ab]<0||a._a[Ab]>23?Ab:a._a[Bb]<0||a._a[Bb]>59?Bb:a._a[Cb]<0||a._a[Cb]>59?Cb:a._a[Db]<0||a._a[Db]>999?Db:-1,a._pf._overflowDayOfYear&&(xb>b||b>zb)&&(b=zb),a._pf.overflow=b)}function F(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length)),a._isValid}function G(a){return a?a.toLowerCase().replace("_","-"):a}function H(a){for(var b,c,d,e,f=0;f<a.length;){for(e=G(a[f]).split("-"),b=e.length,c=G(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=I(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&v(e,c,!0)>=b-1)break;b--}f++}return null}function I(a){var b=null;if(!Eb[a]&&Gb)try{b=rb.locale(),require("./locale/"+a),rb.locale(b)}catch(c){}return Eb[a]}function J(a,b){return b._isUTC?rb(a).zone(b._offset||0):rb(a).local()}function K(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function L(a){var b,c,d=a.match(Kb);for(b=0,c=d.length;c>b;b++)d[b]=mc[d[b]]?mc[d[b]]:K(d[b]);return function(e){var f="";for(b=0;c>b;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function M(a,b){return a.isValid()?(b=N(b,a.localeData()),ic[b]||(ic[b]=L(b)),ic[b](a)):a.localeData().invalidDate()}function N(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Lb.lastIndex=0;d>=0&&Lb.test(a);)a=a.replace(Lb,c),Lb.lastIndex=0,d-=1;return a}function O(a,b){var c,d=b._strict;switch(a){case"Q":return Wb;case"DDDD":return Yb;case"YYYY":case"GGGG":case"gggg":return d?Zb:Ob;case"Y":case"G":case"g":return _b;case"YYYYYY":case"YYYYY":case"GGGGG":case"ggggg":return d?$b:Pb;case"S":if(d)return Wb;case"SS":if(d)return Xb;case"SSS":if(d)return Yb;case"DDD":return Nb;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return Rb;case"a":case"A":return b._locale._meridiemParse;case"X":return Ub;case"Z":case"ZZ":return Sb;case"T":return Tb;case"SSSS":return Qb;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"ww":case"WW":return d?Xb:Mb;case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"W":case"e":case"E":return Mb;case"Do":return Vb;default:return c=new RegExp(X(W(a.replace("\\","")),"i"))}}function P(a){a=a||"";var b=a.match(Sb)||[],c=b[b.length-1]||[],d=(c+"").match(ec)||["-",0,0],e=+(60*d[1])+z(d[2]);return"+"===d[0]?-e:e}function Q(a,b,c){var d,e=c._a;switch(a){case"Q":null!=b&&(e[yb]=3*(z(b)-1));break;case"M":case"MM":null!=b&&(e[yb]=z(b)-1);break;case"MMM":case"MMMM":d=c._locale.monthsParse(b),null!=d?e[yb]=d:c._pf.invalidMonth=b;break;case"D":case"DD":null!=b&&(e[zb]=z(b));break;case"Do":null!=b&&(e[zb]=z(parseInt(b,10)));break;case"DDD":case"DDDD":null!=b&&(c._dayOfYear=z(b));break;case"YY":e[xb]=rb.parseTwoDigitYear(b);break;case"YYYY":case"YYYYY":case"YYYYYY":e[xb]=z(b);break;case"a":case"A":c._isPm=c._locale.isPM(b);break;case"H":case"HH":case"h":case"hh":e[Ab]=z(b);break;case"m":case"mm":e[Bb]=z(b);break;case"s":case"ss":e[Cb]=z(b);break;case"S":case"SS":case"SSS":case"SSSS":e[Db]=z(1e3*("0."+b));break;case"X":c._d=new Date(1e3*parseFloat(b));break;case"Z":case"ZZ":c._useUTC=!0,c._tzm=P(b);break;case"dd":case"ddd":case"dddd":d=c._locale.weekdaysParse(b),null!=d?(c._w=c._w||{},c._w.d=d):c._pf.invalidWeekday=b;break;case"w":case"ww":case"W":case"WW":case"d":case"e":case"E":a=a.substr(0,1);case"gggg":case"GGGG":case"GGGGG":a=a.substr(0,2),b&&(c._w=c._w||{},c._w[a]=z(b));break;case"gg":case"GG":c._w=c._w||{},c._w[a]=rb.parseTwoDigitYear(b)}}function R(a){var c,d,e,f,g,h,i;c=a._w,null!=c.GG||null!=c.W||null!=c.E?(g=1,h=4,d=b(c.GG,a._a[xb],fb(rb(),1,4).year),e=b(c.W,1),f=b(c.E,1)):(g=a._locale._week.dow,h=a._locale._week.doy,d=b(c.gg,a._a[xb],fb(rb(),g,h).year),e=b(c.w,1),null!=c.d?(f=c.d,g>f&&++e):f=null!=c.e?c.e+g:g),i=gb(d,e,f,h,g),a._a[xb]=i.year,a._dayOfYear=i.dayOfYear}function S(a){var c,d,e,f,g=[];if(!a._d){for(e=U(a),a._w&&null==a._a[zb]&&null==a._a[yb]&&R(a),a._dayOfYear&&(f=b(a._a[xb],e[xb]),a._dayOfYear>C(f)&&(a._pf._overflowDayOfYear=!0),d=bb(f,0,a._dayOfYear),a._a[yb]=d.getUTCMonth(),a._a[zb]=d.getUTCDate()),c=0;3>c&&null==a._a[c];++c)a._a[c]=g[c]=e[c];for(;7>c;c++)a._a[c]=g[c]=null==a._a[c]?2===c?1:0:a._a[c];a._d=(a._useUTC?bb:ab).apply(null,g),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()+a._tzm)}}function T(a){var b;a._d||(b=x(a._i),a._a=[b.year,b.month,b.day,b.hour,b.minute,b.second,b.millisecond],S(a))}function U(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function V(a){if(a._f===rb.ISO_8601)return void Z(a);a._a=[],a._pf.empty=!0;var b,c,d,e,f,g=""+a._i,h=g.length,i=0;for(d=N(a._f,a._locale).match(Kb)||[],b=0;b<d.length;b++)e=d[b],c=(g.match(O(e,a))||[])[0],c&&(f=g.substr(0,g.indexOf(c)),f.length>0&&a._pf.unusedInput.push(f),g=g.slice(g.indexOf(c)+c.length),i+=c.length),mc[e]?(c?a._pf.empty=!1:a._pf.unusedTokens.push(e),Q(e,c,a)):a._strict&&!c&&a._pf.unusedTokens.push(e);a._pf.charsLeftOver=h-i,g.length>0&&a._pf.unusedInput.push(g),a._isPm&&a._a[Ab]<12&&(a._a[Ab]+=12),a._isPm===!1&&12===a._a[Ab]&&(a._a[Ab]=0),S(a),E(a)}function W(a){return a.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e})}function X(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function Y(a){var b,d,e,f,g;if(0===a._f.length)return a._pf.invalidFormat=!0,void(a._d=new Date(0/0));for(f=0;f<a._f.length;f++)g=0,b=m({},a),b._pf=c(),b._f=a._f[f],V(b),F(b)&&(g+=b._pf.charsLeftOver,g+=10*b._pf.unusedTokens.length,b._pf.score=g,(null==e||e>g)&&(e=g,d=b));l(a,d||b)}function Z(a){var b,c,d=a._i,e=ac.exec(d);if(e){for(a._pf.iso=!0,b=0,c=cc.length;c>b;b++)if(cc[b][1].exec(d)){a._f=cc[b][0]+(e[6]||" ");break}for(b=0,c=dc.length;c>b;b++)if(dc[b][1].exec(d)){a._f+=dc[b][0];break}d.match(Sb)&&(a._f+="Z"),V(a)}else a._isValid=!1}function $(a){Z(a),a._isValid===!1&&(delete a._isValid,rb.createFromInputFallback(a))}function _(b){var c,d=b._i;d===a?b._d=new Date:u(d)?b._d=new Date(+d):null!==(c=Hb.exec(d))?b._d=new Date(+c[1]):"string"==typeof d?$(b):t(d)?(b._a=d.slice(0),S(b)):"object"==typeof d?T(b):"number"==typeof d?b._d=new Date(d):rb.createFromInputFallback(b)}function ab(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return 1970>a&&h.setFullYear(a),h}function bb(a){var b=new Date(Date.UTC.apply(null,arguments));return 1970>a&&b.setUTCFullYear(a),b}function cb(a,b){if("string"==typeof a)if(isNaN(a)){if(a=b.weekdaysParse(a),"number"!=typeof a)return null}else a=parseInt(a,10);return a}function db(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function eb(a,b,c){var d=rb.duration(a).abs(),e=wb(d.as("s")),f=wb(d.as("m")),g=wb(d.as("h")),h=wb(d.as("d")),i=wb(d.as("M")),j=wb(d.as("y")),k=e<jc.s&&["s",e]||1===f&&["m"]||f<jc.m&&["mm",f]||1===g&&["h"]||g<jc.h&&["hh",g]||1===h&&["d"]||h<jc.d&&["dd",h]||1===i&&["M"]||i<jc.M&&["MM",i]||1===j&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,db.apply({},k)}function fb(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),e-7>f&&(f+=7),d=rb(a).add(f,"d"),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function gb(a,b,c,d,e){var f,g,h=bb(a,0,1).getUTCDay();return h=0===h?7:h,c=null!=c?c:e,f=e-h+(h>d?7:0)-(e>h?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:C(a-1)+g}}function hb(b){var c=b._i,d=b._f;return b._locale=b._locale||rb.localeData(b._l),null===c||d===a&&""===c?rb.invalid({nullInput:!0}):("string"==typeof c&&(b._i=c=b._locale.preparse(c)),rb.isMoment(c)?new j(c,!0):(d?t(d)?Y(b):V(b):_(b),new j(b)))}function ib(a,b){var c,d;if(1===b.length&&t(b[0])&&(b=b[0]),!b.length)return rb();for(c=b[0],d=1;d<b.length;++d)b[d][a](c)&&(c=b[d]);return c}function jb(a,b){var c;return"string"==typeof b&&(b=a.localeData().monthsParse(b),"number"!=typeof b)?a:(c=Math.min(a.date(),A(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a)}function kb(a,b){return a._d["get"+(a._isUTC?"UTC":"")+b]()}function lb(a,b,c){return"Month"===b?jb(a,c):a._d["set"+(a._isUTC?"UTC":"")+b](c)}function mb(a,b){return function(c){return null!=c?(lb(this,a,c),rb.updateOffset(this,b),this):kb(this,a)}}function nb(a){return 400*a/146097}function ob(a){return 146097*a/400}function pb(a){rb.duration.fn[a]=function(){return this._data[a]}}function qb(a){"undefined"==typeof ender&&(sb=vb.moment,vb.moment=a?e("Accessing Moment through the global scope is deprecated, and will be removed in an upcoming release.",rb):rb)}for(var rb,sb,tb,ub="2.8.1",vb="undefined"!=typeof global?global:this,wb=Math.round,xb=0,yb=1,zb=2,Ab=3,Bb=4,Cb=5,Db=6,Eb={},Fb=[],Gb="undefined"!=typeof module&&module.exports,Hb=/^\/?Date\((\-?\d+)/i,Ib=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,Jb=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,Kb=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,Lb=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,Mb=/\d\d?/,Nb=/\d{1,3}/,Ob=/\d{1,4}/,Pb=/[+\-]?\d{1,6}/,Qb=/\d+/,Rb=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Sb=/Z|[\+\-]\d\d:?\d\d/gi,Tb=/T/i,Ub=/[\+\-]?\d+(\.\d{1,3})?/,Vb=/\d{1,2}/,Wb=/\d/,Xb=/\d\d/,Yb=/\d{3}/,Zb=/\d{4}/,$b=/[+-]?\d{6}/,_b=/[+-]?\d+/,ac=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,bc="YYYY-MM-DDTHH:mm:ssZ",cc=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],dc=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],ec=/([\+\-]|\d\d)/gi,fc=("Date|Hours|Minutes|Seconds|Milliseconds".split("|"),{Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6}),gc={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",Q:"quarter",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},hc={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},ic={},jc={s:45,m:45,h:22,d:26,M:11},kc="DDD w W M D d".split(" "),lc="M D H h m s w W".split(" "),mc={M:function(){return this.month()+1},MMM:function(a){return this.localeData().monthsShort(this,a)},MMMM:function(a){return this.localeData().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.localeData().weekdaysMin(this,a)},ddd:function(a){return this.localeData().weekdaysShort(this,a)},dddd:function(a){return this.localeData().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return o(this.year()%100,2)},YYYY:function(){return o(this.year(),4)},YYYYY:function(){return o(this.year(),5)},YYYYYY:function(){var a=this.year(),b=a>=0?"+":"-";return b+o(Math.abs(a),6)},gg:function(){return o(this.weekYear()%100,2)},gggg:function(){return o(this.weekYear(),4)},ggggg:function(){return o(this.weekYear(),5)},GG:function(){return o(this.isoWeekYear()%100,2)},GGGG:function(){return o(this.isoWeekYear(),4)},GGGGG:function(){return o(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.localeData().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.localeData().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return z(this.milliseconds()/100)},SS:function(){return o(z(this.milliseconds()/10),2)},SSS:function(){return o(this.milliseconds(),3)},SSSS:function(){return o(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+o(z(a/60),2)+":"+o(z(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+o(z(a/60),2)+o(z(a)%60,2)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()},Q:function(){return this.quarter()}},nc={},oc=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];kc.length;)tb=kc.pop(),mc[tb+"o"]=h(mc[tb],tb);for(;lc.length;)tb=lc.pop(),mc[tb+tb]=g(mc[tb],2);mc.DDDD=g(mc.DDD,3),l(i.prototype,{set:function(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(a){return this._months[a.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b,c,d;for(this._monthsParse||(this._monthsParse=[]),b=0;12>b;b++)if(this._monthsParse[b]||(c=rb.utc([2e3,b]),d="^"+this.months(c,"")+"|^"+this.monthsShort(c,""),this._monthsParse[b]=new RegExp(d.replace(".",""),"i")),this._monthsParse[b].test(a))return b},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(a){return this._weekdays[a.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},weekdaysParse:function(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;7>b;b++)if(this._weekdaysParse[b]||(c=rb([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY LT",LLLL:"dddd, MMMM D, YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b},isPM:function(a){return"p"===(a+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){var c=this._calendar[a];return"function"==typeof c?c.apply(b):c},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return fb(a,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),rb=function(b,d,e,f){var g;return"boolean"==typeof e&&(f=e,e=a),g={},g._isAMomentObject=!0,g._i=b,g._f=d,g._l=e,g._strict=f,g._isUTC=!1,g._pf=c(),hb(g)},rb.suppressDeprecationWarnings=!1,rb.createFromInputFallback=e("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(a){a._d=new Date(a._i)}),rb.min=function(){var a=[].slice.call(arguments,0);return ib("isBefore",a)},rb.max=function(){var a=[].slice.call(arguments,0);return ib("isAfter",a)},rb.utc=function(b,d,e,f){var g;return"boolean"==typeof e&&(f=e,e=a),g={},g._isAMomentObject=!0,g._useUTC=!0,g._isUTC=!0,g._l=e,g._i=b,g._f=d,g._strict=f,g._pf=c(),hb(g).utc()},rb.unix=function(a){return rb(1e3*a)},rb.duration=function(a,b){var c,d,e,f,g=a,h=null;return rb.isDuration(a)?g={ms:a._milliseconds,d:a._days,M:a._months}:"number"==typeof a?(g={},b?g[b]=a:g.milliseconds=a):(h=Ib.exec(a))?(c="-"===h[1]?-1:1,g={y:0,d:z(h[zb])*c,h:z(h[Ab])*c,m:z(h[Bb])*c,s:z(h[Cb])*c,ms:z(h[Db])*c}):(h=Jb.exec(a))?(c="-"===h[1]?-1:1,e=function(a){var b=a&&parseFloat(a.replace(",","."));return(isNaN(b)?0:b)*c},g={y:e(h[2]),M:e(h[3]),d:e(h[4]),h:e(h[5]),m:e(h[6]),s:e(h[7]),w:e(h[8])}):"object"==typeof g&&("from"in g||"to"in g)&&(f=q(rb(g.from),rb(g.to)),g={},g.ms=f.milliseconds,g.M=f.months),d=new k(g),rb.isDuration(a)&&a.hasOwnProperty("_locale")&&(d._locale=a._locale),d},rb.version=ub,rb.defaultFormat=bc,rb.ISO_8601=function(){},rb.momentProperties=Fb,rb.updateOffset=function(){},rb.relativeTimeThreshold=function(b,c){return jc[b]===a?!1:c===a?jc[b]:(jc[b]=c,!0)},rb.lang=e("moment.lang is deprecated. Use moment.locale instead.",function(a,b){return rb.locale(a,b)}),rb.locale=function(a,b){var c;return a&&(c="undefined"!=typeof b?rb.defineLocale(a,b):rb.localeData(a),c&&(rb.duration._locale=rb._locale=c)),rb._locale._abbr},rb.defineLocale=function(a,b){return null!==b?(b.abbr=a,Eb[a]||(Eb[a]=new i),Eb[a].set(b),rb.locale(a),Eb[a]):(delete Eb[a],null)},rb.langData=e("moment.langData is deprecated. Use moment.localeData instead.",function(a){return rb.localeData(a)}),rb.localeData=function(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return rb._locale;if(!t(a)){if(b=I(a))return b;a=[a]}return H(a)},rb.isMoment=function(a){return a instanceof j||null!=a&&a.hasOwnProperty("_isAMomentObject")},rb.isDuration=function(a){return a instanceof k};for(tb=oc.length-1;tb>=0;--tb)y(oc[tb]);rb.normalizeUnits=function(a){return w(a)},rb.invalid=function(a){var b=rb.utc(0/0);return null!=a?l(b._pf,a):b._pf.userInvalidated=!0,b},rb.parseZone=function(){return rb.apply(null,arguments).parseZone()},rb.parseTwoDigitYear=function(a){return z(a)+(z(a)>68?1900:2e3)},l(rb.fn=j.prototype,{clone:function(){return rb(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){var a=rb(this).utc();return 0<a.year()&&a.year()<=9999?M(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):M(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var a=this;return[a.year(),a.month(),a.date(),a.hours(),a.minutes(),a.seconds(),a.milliseconds()]},isValid:function(){return F(this)},isDSTShifted:function(){return this._a?this.isValid()&&v(this._a,(this._isUTC?rb.utc(this._a):rb(this._a)).toArray())>0:!1},parsingFlags:function(){return l({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(a){return this.zone(0,a)},local:function(a){return this._isUTC&&(this.zone(0,a),this._isUTC=!1,a&&this.add(this._d.getTimezoneOffset(),"m")),this},format:function(a){var b=M(this,a||rb.defaultFormat);return this.localeData().postformat(b)},add:r(1,"add"),subtract:r(-1,"subtract"),diff:function(a,b,c){var d,e,f=J(a,this),g=6e4*(this.zone()-f.zone());return b=w(b),"year"===b||"month"===b?(d=432e5*(this.daysInMonth()+f.daysInMonth()),e=12*(this.year()-f.year())+(this.month()-f.month()),e+=(this-rb(this).startOf("month")-(f-rb(f).startOf("month")))/d,e-=6e4*(this.zone()-rb(this).startOf("month").zone()-(f.zone()-rb(f).startOf("month").zone()))/d,"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:n(e)},from:function(a,b){return rb.duration({to:this,from:a}).locale(this.locale()).humanize(!b)},fromNow:function(a){return this.from(rb(),a)},calendar:function(a){var b=a||rb(),c=J(b,this).startOf("day"),d=this.diff(c,"days",!0),e=-6>d?"sameElse":-1>d?"lastWeek":0>d?"lastDay":1>d?"sameDay":2>d?"nextDay":7>d?"nextWeek":"sameElse";return this.format(this.localeData().calendar(e,this))},isLeapYear:function(){return D(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=cb(a,this.localeData()),this.add(a-b,"d")):b},month:mb("Month",!0),startOf:function(a){switch(a=w(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a?this.weekday(0):"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this},endOf:function(a){return a=w(a),this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms")},isAfter:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)>+rb(a).startOf(b)},isBefore:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)<+rb(a).startOf(b)},isSame:function(a,b){return b=b||"ms",+this.clone().startOf(b)===+J(a,this).startOf(b)},min:e("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(a){return a=rb.apply(null,arguments),this>a?this:a}),max:e("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(a){return a=rb.apply(null,arguments),a>this?this:a}),zone:function(a,b){var c,d=this._offset||0;return null==a?this._isUTC?d:this._d.getTimezoneOffset():("string"==typeof a&&(a=P(a)),Math.abs(a)<16&&(a=60*a),!this._isUTC&&b&&(c=this._d.getTimezoneOffset()),this._offset=a,this._isUTC=!0,null!=c&&this.subtract(c,"m"),d!==a&&(!b||this._changeInProgress?s(this,rb.duration(d-a,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,rb.updateOffset(this,!0),this._changeInProgress=null)),this)},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){return this._tzm?this.zone(this._tzm):"string"==typeof this._i&&this.zone(this._i),this},hasAlignedHourOffset:function(a){return a=a?rb(a).zone():0,(this.zone()-a)%60===0},daysInMonth:function(){return A(this.year(),this.month())},dayOfYear:function(a){var b=wb((rb(this).startOf("day")-rb(this).startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")},quarter:function(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)},weekYear:function(a){var b=fb(this,this.localeData()._week.dow,this.localeData()._week.doy).year;return null==a?b:this.add(a-b,"y")},isoWeekYear:function(a){var b=fb(this,1,4).year;return null==a?b:this.add(a-b,"y")},week:function(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")},isoWeek:function(a){var b=fb(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")},weekday:function(a){var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")},isoWeekday:function(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)},isoWeeksInYear:function(){return B(this.year(),1,4)},weeksInYear:function(){var a=this.localeData()._week;return B(this.year(),a.dow,a.doy)},get:function(a){return a=w(a),this[a]()},set:function(a,b){return a=w(a),"function"==typeof this[a]&&this[a](b),this},locale:function(b){return b===a?this._locale._abbr:(this._locale=rb.localeData(b),this)},lang:e("moment().lang() is deprecated. Use moment().localeData() instead.",function(b){return b===a?this.localeData():(this._locale=rb.localeData(b),this)}),localeData:function(){return this._locale}}),rb.fn.millisecond=rb.fn.milliseconds=mb("Milliseconds",!1),rb.fn.second=rb.fn.seconds=mb("Seconds",!1),rb.fn.minute=rb.fn.minutes=mb("Minutes",!1),rb.fn.hour=rb.fn.hours=mb("Hours",!0),rb.fn.date=mb("Date",!0),rb.fn.dates=e("dates accessor is deprecated. Use date instead.",mb("Date",!0)),rb.fn.year=mb("FullYear",!0),rb.fn.years=e("years accessor is deprecated. Use year instead.",mb("FullYear",!0)),rb.fn.days=rb.fn.day,rb.fn.months=rb.fn.month,rb.fn.weeks=rb.fn.week,rb.fn.isoWeeks=rb.fn.isoWeek,rb.fn.quarters=rb.fn.quarter,rb.fn.toJSON=rb.fn.toISOString,l(rb.duration.fn=k.prototype,{_bubble:function(){var a,b,c,d=this._milliseconds,e=this._days,f=this._months,g=this._data,h=0;g.milliseconds=d%1e3,a=n(d/1e3),g.seconds=a%60,b=n(a/60),g.minutes=b%60,c=n(b/60),g.hours=c%24,e+=n(c/24),h=n(nb(e)),e-=n(ob(h)),f+=n(e/30),e%=30,h+=n(f/12),f%=12,g.days=e,g.months=f,g.years=h},abs:function(){return this._milliseconds=Math.abs(this._milliseconds),this._days=Math.abs(this._days),this._months=Math.abs(this._months),this._data.milliseconds=Math.abs(this._data.milliseconds),this._data.seconds=Math.abs(this._data.seconds),this._data.minutes=Math.abs(this._data.minutes),this._data.hours=Math.abs(this._data.hours),this._data.months=Math.abs(this._data.months),this._data.years=Math.abs(this._data.years),this},weeks:function(){return n(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*z(this._months/12)},humanize:function(a){var b=eb(this,!a,this.localeData());return a&&(b=this.localeData().pastFuture(+this,b)),this.localeData().postformat(b)},add:function(a,b){var c=rb.duration(a,b);return this._milliseconds+=c._milliseconds,this._days+=c._days,this._months+=c._months,this._bubble(),this},subtract:function(a,b){var c=rb.duration(a,b);return this._milliseconds-=c._milliseconds,this._days-=c._days,this._months-=c._months,this._bubble(),this},get:function(a){return a=w(a),this[a.toLowerCase()+"s"]()},as:function(a){var b,c;if(a=w(a),b=this._days+this._milliseconds/864e5,"month"===a||"year"===a)return c=this._months+12*nb(b),"month"===a?c:c/12;switch(b+=ob(this._months/12),a){case"week":return b/7;case"day":return b;case"hour":return 24*b;case"minute":return 24*b*60;case"second":return 24*b*60*60;case"millisecond":return 24*b*60*60*1e3;default:throw new Error("Unknown unit "+a)}},lang:rb.fn.lang,locale:rb.fn.locale,toIsoString:e("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",function(){return this.toISOString()}),toISOString:function(){var a=Math.abs(this.years()),b=Math.abs(this.months()),c=Math.abs(this.days()),d=Math.abs(this.hours()),e=Math.abs(this.minutes()),f=Math.abs(this.seconds()+this.milliseconds()/1e3);return this.asSeconds()?(this.asSeconds()<0?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"},localeData:function(){return this._locale}});for(tb in fc)fc.hasOwnProperty(tb)&&pb(tb.toLowerCase());rb.duration.fn.asMilliseconds=function(){return this.as("ms")},rb.duration.fn.asSeconds=function(){return this.as("s")},rb.duration.fn.asMinutes=function(){return this.as("m")},rb.duration.fn.asHours=function(){return this.as("h")},rb.duration.fn.asDays=function(){return this.as("d")},rb.duration.fn.asWeeks=function(){return this.as("weeks")},rb.duration.fn.asMonths=function(){return this.as("M")},rb.duration.fn.asYears=function(){return this.as("y")},rb.locale("en",{ordinal:function(a){var b=a%10,c=1===z(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),Gb?module.exports=rb:"function"==typeof define&&define.amd?(define("moment",function(a,b,c){return c.config&&c.config()&&c.config().noGlobal===!0&&(vb.moment=sb),rb}),qb(!0)):qb()}).call(this);
P.top_bar = {
  changeUrl: false,  // if topbar should change URL of the site; only for dashboard
  nid: "",
  user: {},
  template: {},
  globalNotifications: 0,
  isDashboard: false,
  showingInactive: false,
  onWhatPage: false,

  initEventHandlers: function() {
    $("#network_button").click(function(event) {
      if (PA.staticContent) return false;
      var dropdownMenu = $("#my_class_menu");
      var menuVisible = dropdownMenu.is(":visible");
      if (!menuVisible) {
        P.top_bar.openDropDown($('#my_class_menu'));
        $(this).closest('.topbar_button').addClass('active');
      } else {
        closeDropDown();
      }
      event.stopPropagation();
      return false;
    });
    $('.top_bar_logo').click(function(){
      PEM.fire("cleanDashboard");
      PEM.fire("showHomescreen");
    });
    $('#user_button').click(function(event) {
      var dropdownMenu = $("#user_dropdown");
      var menuVisible = dropdownMenu.is(":visible");
      if (!menuVisible) {
        P.top_bar.openDropDown($('#user_dropdown'));
        $(this).addClass('active');
        $(this).find('.topbar_arrow').addClass('settings_active');
      }
      else closeDropDown();
      event.stopPropagation();
      return false;
    });
    $("html").click(function() {
      if (typeof(closeDropDown) != "undefined")
        closeDropDown();
    });
    $("#log_out").click(function() {
      PA.call("user.logout", {}, null, function() {
        window.location = '/';
      });
    });
    $('#user_dropdown_list > li').click(function() {
      P.top_bar.executeDropdownAction($(this).attr("action"));
      return true;
    });
    $(".class_report").click(function() {
      window.open("/stats/report/" + P.top_bar.network.id, "_blank");
    });
    $('.topbar_icons.stats').click(function() {
      if (P.top_bar.isDashboard) {
        PEM.fire("showClassStats");
        $('.top_bar_statistics').addClass('active');
        $('.top_bar_qa').removeClass('active');
      } else {
        window.location = "/class/" + P.top_bar.network.id + "?show_stats=1";
      }
    });
    $(".top_bar_manage").click(function() {
      P.top_bar.gotoConfigClass();
    });
    $(".top_bar_qa, #classes_brand").click(function() {
      if (P.top_bar.isDashboard) {
        $(".top_bar_tab").removeClass("active");
        $(".top_bar_qa").addClass("active");
        PEM.fire("cleanDashboard");
        PEM.fire("showHomescreen");
        PEM.fire("showFeed");
        if (!P.top_bar.user.isInst)
          PA.call_pj("generic.page_event", {type:"top_bar.qa_tab_click"}, 1, function(){});
      } else {
        window.location = "/class/" + P.top_bar.nid;
        return false;
      }
    });
    // $(".top_bar_careers_homescreen").click(function() {
    //   if ($(this).hasClass("view_all_events"))
    //     window.location = "/careers/dashboard?eid=all";
    //   else if ($(this).hasClass("view_all_messages"))
    //     window.location = "/careers/dashboard?mid=all";
    //   else
    //     window.location = "/careers/dashboard";
    //   return false;
    // });
    $('#event_notifications_button').click(function(){
      closeDropDown();
      $('#topbar_career_events_notifications_popover').show();
      P.top_bar.resetEventNotifications();
      PA.call_pj("user.set_last_saw_careers", {}, 1);

      return false;
    });
    // $('#message_notifications_button').click(function(){
    //   closeDropDown();
    //   $('#topbar_career_message_notifications_popover').show();
    //   PA.call_pj("generic.event_to_requests", {event: "careers.messages_icon"},1);
    //   return false;
    // });
    $("#careers_button_signed").click(function() {
      window.location = "/careers/student";
    });
    $("#careers_button").click(function() {
      if (P.top_bar.isDashboard) {
        PA.call_pj("user.set", {stat:"careers.ybtn", val:new Date()}, 1);
        PEM.fire("cleanDashboard");
        PEM.fire("showHomescreen");
      } else {
        window.location = "/class";
      }
    });

    $('#careers_button .icon-remove-sign').click(function(){
      if (!P.top_bar.user.config.careers) P.top_bar.user.config.careers = {};
      P.homescreen.user.config.careers.stop = new Date();
      PA.call_pj("user.set", {stat:"careers.stop", val:P.homescreen.user.config.careers.stop}, 1);
      $('#careers_button').hide();
    });
    $('.top_bar_course_page').click(function() {
      P.top_bar.gotoCoursePage();
    });
    $('.top_bar_button.login').click(function() {
      openSlidingPanel($('#LoginPanel'));
      $('#email_field').focus();
      return false;
    });
    $('.top_bar_button.enroll').click(function() {
      if (typeof(FORCE_TERM) != 'undefined') {
        var term = FORCE_TERM.toLowerCase().replace(/\s+/g, "") || "other";
        window.location = "/" + FORCE_EXT + "/" + term + "/" + FORCE_SN;
      }
      return false;
    });
    $('#create_new_class').click(function() {
      window.location = "/instructors/" + P.top_bar.network.school_ext;
    });
    $('#clone_class').click(function() {
      var term = P.top_bar.network.term.toLowerCase().replace(/\s+/g, "") || "other";
      window.location = "/clone-class/" + term + "/" + P.top_bar.network.short_number;
    });
    $('#inactive_network_toggle').click(function() {
      P.top_bar.showingInactive = !P.top_bar.showingInactive;
      if (P.top_bar.showingInactive) {
        $('.inactiveNetwork').show();
        $('#inactive_network_toggle a').html("Hide inactive classes");
      } else {
        $('.inactiveNetwork').hide();
        $('#inactive_network_toggle a').html("Show inactive classes");
      }
      return false;
    });
    $("#stats_button").click(function() {
      if (typeof(INTERNAL_ID) != 'undefined')
        window.location = "/company/" + INTERNAL_ID + "/stats";
    });
    $("#search_button").click(function() {
      if (typeof(COMPANY_STATS) != 'undefined' && COMPANY_STATS) {
        window.location = "/company/" + INTERNAL_ID + "/search";
        return;
      }
      $(this).addClass("active");
      P.modules.loadModule("careers_company_search", {}, function() {
        PEM.fire("showSearch");
      }, null);
      $(".top_bar_tab").removeClass("active");
      $(this).addClass("active");
      PA.call_pj("generic.event_to_requests", {event: "careers.search_tab"},1);
    });
    $("#interacted_button").click(function() {
      if (typeof(COMPANY_STATS) != 'undefined' && COMPANY_STATS) {
        window.location = "/company/" + INTERNAL_ID + "/interacted";
        return;
      }
      $(this).addClass("active");

      P.modules.loadModule("careers_company_students_interacted", {}, function() {
        PEM.fire("showInteracted");
      }, null);
      $(".top_bar_tab").removeClass("active");
      $(this).addClass("active");
      PA.call_pj("generic.event_to_requests", {event: "careers.interacted_tab"},1);
    });
    $("#discover_button").click(function() {
      if (typeof(COMPANY_STATS) != 'undefined' && COMPANY_STATS) {
        window.location = "/company/" + INTERNAL_ID;
        return;
      }
      $(".top_bar_tab").removeClass("active");
      $(this).addClass("active");
      P.modules.loadModule("careers_company_discover", {}, function() {
        PEM.fire("showDiscover");
      }, null);
      PA.call_pj("generic.event_to_requests", {event: "careers.discover_tab"},1);
    });
    $("#company_profile_button").click(function() {
      P.modules.loadModule("careers_company_profile", {}, function() {
        PEM.fire("showCompanyProfile", LOAD_COMPANY);
      }, null);
      $(".top_bar_tab").removeClass("active");
      $(this).addClass("active");
      PA.call_pj("generic.event_to_requests", {event: "careers.company_profile_tab"},1);
    });
    $('#signup_button').click(function(){
      window.location = "/instructors/school-search";
    });
    $('#piazza_com_button').click(function(){
      window.location = "/";
    });
    $("#company_log_out").click(function() {
      PA.call("careers_company.logout", {}, null, function() {
        window.location = '/company/login';
      }, function(err){console.log(err)});
    })
    $('.top_bar_classes').click(function() {
      window.location = '/class';
      return false;
    });
    $('.log_click').click(function(){
      var id = $(this).attr("id");
      if (id) {
        id = "company_profile." + id;
        PA.call_pj("generic.page_event", {type:id}, 1, function(){});
      }
    });
    $("#close_topbar_careers_popover").click(function(){
      $('#topbar_careers_popover').hide();
      if (PA.user) {
        PA.markSeenUnseen("career_tab_pop");
        PA.markSeenUnseen("career_tab_pop_2");
      }
    });
    $('#close_topbar_careers_popover_optout').click(function(){
      $('#topbar_careers_popover').hide();
      if (PA.user) {
        PA.call_pj("user.update", {email_prefs:{careers:{no_careers:true}}}, null, function(data){
          window.location = "/class";
        });
      }
    });
    $("#close_topbar_career_events_popover").click(function(){
      $('#topbar_career_events_popover').hide();
      if (PA.user)
        PA.markSeenUnseen("career_tab_pop_2");
    });
    $('.account_name_container').click(function(){
      if (P.top_bar.user.isInst && !P.top_bar.user.isTA)
        return false;
      if (P.top_bar.user.showCareers) {
        if (P.top_bar.isCareers) {
          $(".profile_nav").click();
          return false;
        }
        window.location = "/careers/dashboard#/my_profile";
      } else {
        window.location = "/my_profile";
      }
      return false;
    });
    if (typeof(COMPANY_STATS) != 'undefined' && COMPANY_STATS) {
      $('.top_bar_tab').removeClass('active');
      $('#stats_button').addClass('active');
    }
    if (typeof(COMPANY_SEARCH) != 'undefined')
      $('#search_button').click();
    if (typeof(COMPANY_INTERACTED) != 'undefined')
      $('#interacted_button').click();
    P.top_bar.reloadMessagesCount = 0;
    P.top_bar.reloadEventsCount = 0;
    $("#messages_icon").click(function() {
      P.top_bar.reloadMessagesCount += 1;
      $("#messages_icon").attr('href', "/careers/dashboard#/messages/reload_" + P.top_bar.reloadMessagesCount);
    });
    $('.topbar_events_icon').unbind().click(function(){
      $(".event_count").hide();
      PA.call_pj("user_profile.set_last_saw_events", {}, 1, function(data){
        window.location.href = "/careers/dashboard#/events";
      });
      if (P.top_bar.userProfile)
        P.top_bar.userProfile.profile_settings.last_saw_events = moment().format();
      return false;
    });
  },
  gotoConfigClass: function(section) {
    if (P.top_bar.network.type == "group")
      window.location = "/configure-group/" + P.top_bar.nid;
    else {
      var term = P.top_bar.network.term.toLowerCase().replace(/\s+/g, "") || "other";
      var shortNumber = P.top_bar.network.short_number;
      if (section)
        window.location = "/configure-classes/" + term + "/" + shortNumber + "#" + section;
      else
        window.location = "/configure-classes/" + term + "/" + shortNumber;
    }
  },
  gotoCoursePage: function(subpage) {
    subpage = subpage || "home";
    var net = P.top_bar.network;
    if (!net) return;
    var term = net.term.toLowerCase().replace(/\s+/g, "") || "other";
    var shortNumber = net.short_number;
    window.location = "/" + net.school_ext + "/" + term + "/" + shortNumber + '/' + subpage;
  },
  initTipsies: function() {
    $('.show-tipsy').tipsy({gravity: 'n'});
  },
  refreshOnlineUsers: function(nid) {
    if (nid == P.top_bar.network.id) {
      var params = {nid: nid,uid: P.top_bar.user.id};
      if (P.top_bar.onWhatPage) params.page = P.top_bar.onWhatPage; // make this log in vertica
      PA.call_pj("network.get_online_users", params, 1, function(data) {
        if (nid == P.top_bar.network.id) {
          PEM.fire("online_users", data);
          if (P.top_bar.getOnlineUsers) {
            clearTimeout(P.top_bar.getOnlineUsers);
          }
          P.top_bar.getOnlineUsers = setTimeout(function() { P.top_bar.refreshOnlineUsers(P.top_bar.network.id); }, 1000 * 180); // 3 minute timeout
        }
      }, function(err) {
        if (err === "User session changed") {
          PEM.fire("user_logout");
        }
      });

    }
  },
  careersPing: function() {
    if (typeof(COMPANY_USER_ID) != 'undefined') {
      PA.call_pj("careers_company.ping", {}, 1, function(data) {
        P.top_bar.getOnlineUsers = setTimeout(P.top_bar.careersPing, 1000 * 180); // 3 minute timeout
      });
    }
  },
  ensureTooltips: function() {
    var showTips = true;
    if (P.top_bar.user && P.top_bar.user.config && P.top_bar.user.config.no_tips) showTips = false;
    if (!showTips && !P.top_bar.showTips) {// no need to spend extra cycles
      $('[notutorial]').unbind('mouseenter mouseleave')
      $('[notutorialw]').unbind('mouseenter mouseleave')
      $('[notutorial]').tipsy({gravity: 'n', html: true, title:"notutorial"});
      $('[notutorialw]').tipsy({gravity: 'w', html: true, title:"notutorialw"});
      return;
    }
    // either show, or hide tooltips
    $('[tutorial]').unbind('mouseenter mouseleave')
    $('[tutorialw]').unbind('mouseenter mouseleave')
    $('[notutorial]').unbind('mouseenter mouseleave')
    $('[notutorialw]').unbind('mouseenter mouseleave')
    $('[notutorial]').tipsy({gravity: 'n', html: true, title:"notutorial"});
    $('[notutorialw]').tipsy({gravity: 'w', html: true, title:"notutorialw"});
    if (showTips) {
      $('.icons .sr_icon').attr("tutorial", "Question has a Students' Answer");
      $('.instructor_endorsed_sr .icons .sr_icon').attr("tutorial", "Question has an instructor-endorsed Students' Answer");
      $('.icons .ir_icon').attr("tutorial", "Question has an Instructors' Answer");
      $('.icons .note').attr("tutorial", "This is a note");
      $('.icons .poll_icon').attr("tutorial", "This is a poll");

      $('[tutorialw]').tipsy({gravity: 'w', html: true, title:"tutorialw"});
      $('[tutorial]').tipsy({gravity: 'n', html: true, title:"tutorial"});
    }
    P.top_bar.showTips = showTips;
  },
  executeDropdownAction: function(action) {
    if (action == "settings") {
      window.location = '/account_settings';

    } else if (action == "features") {
      window.open('/features', '_blank');

    } else if (action == "tooltips") {
      if (P.top_bar.user.config.no_tips) {
        // TURNING TUTORIAL ON
        P.top_bar.user.config.no_tips = false;
        PA.call_pj("user.unset", {stat:"no_tips"}, 1);
        $('#tooltip_link').html("Turn off Tooltips");
        P.top_bar.ensureTooltips();
      } else {
        // TURNING TUTORIAL OFF
        P.top_bar.user.config.no_tips = 1;
        PA.call_pj("user.set", {stat:"no_tips", val:1}, 1);
        $('#tooltip_link').html("Turn on Tooltips");
        P.top_bar.ensureTooltips();
      }

    } else if (action == "contact") {
      window.open('/contactus.html?nid=' + P.top_bar.network.id, '_blank');

    } else if (action == "bug") {
      PTM.getModuleTemplate("top_bar", "bug_report", P.top_bar.showBugReport);

    } else if (action == "homepage") {
      window.location = '/';
    } else if (action == "careers") {
      if (P.top_bar.isDashboard) {
        PEM.fire("cleanDashboard");
        PEM.fire("showHomescreen");
      } else {
        window.location = "/class/" + P.top_bar.nid;
      }
    }

    return false;
  },
  showBugReportExternal: function() {
    PTM.getModuleTemplate("top_bar", "bug_report", P.top_bar.showBugReport);
  },
  showBugReport: function(template) {
    if ($('#report_bug_dialog') && $('#report_bug_dialog').length > 0) {
      $('#report_bug_dialog').jqmShow();
    } else {
      $("body").append(template({}));
      $('#report_bug_dialog').jqm();
      $("#submit_bug").click(function() {
        PA.call("user.bug_report", {details:$('#bug_details').val(), nid: P.top_bar.network.id},
          $('#report_bug_dialog'), function() {
              $('#report_bug_dialog').jqmHide();
              $('#bug_details').val("");
              alert("Thanks for your feedback!");
        });
        return false;
      });
      $("#close_bug_report").click(function() {
        $('#report_bug_dialog').jqmHide();
        return false;
      });
      $('#report_bug_dialog').jqmShow();
    }
  },
  fileBugReport: function() {

  },
  setUserAndPopulateNetworks: function(user) {
    $('.my_pic').html(PA.getUserPic(user.id));
    $('.my_pic_noclick').html(PA.getUserPic(user.id, true));

    if (user.total_profiles) user.total_profiles += 2000;
    // populate network dropdown
    P.top_bar.globalNotifications = 0;
    var nid = user.last_network;
    if (typeof(FORCE_NID) != "undefined")
      nid = FORCE_NID;
    // make sure we have this network
    var have = false;
    for (var i = 0; i < user.networks.length; i++)
      if (user.networks[i].id == nid) have = true;
    if (!have && typeof(FORCE_NID_NOTAUTO) == 'undefined') nid = false;
    if (!have && typeof(FORCE_NID_NOTAUTO) != 'undefined') {
      $('.logged_out').show();
      $('.logged_in').hide();
      $('.top_bar_button.login').hide();
    }
    if (!nid)
      nid = user.networks[0].id;
    // see if URL has old-style link
    var hash = window.location.hash;
    if (hash) {
      // form: #summer2013/math021wd/76
      var entries = hash.split(/[#\/]/);
      if (entries.length > 2) {
        var term = entries[1];
        var courseNr = entries[2];
        var cid = "";
        if (entries.length > 3) cid = entries[3];
        // find class in question
        for (var i = 0; i < user.networks.length; i++) {
          var net = user.networks[i];
          var netterm = net.term.toLowerCase().replace(/\s+/g, "") || "other";
          if (netterm == term && courseNr == net.short_number) {
            nid = net.id;
            if (cid) CID = cid;
          }
        }
      }
    }
    var haveInactiveClasses = false;
    var haveActiveClasses = false;
    var myClasses = $("#my_classes");
    if (user.new_questions) {
      user.new_questions[nid] = 0;
    }
    P.top_bar.schoolExt = "";
    P.top_bar.user.hasCS = false;
    P.top_bar.user.hasUS = false;
    if (P.top_bar.user.config.cs_student)
      P.top_bar.user.hasCS = true;
    if (!P.top_bar.user.isPublicFaq) {
      jQuery.each(user.networks, function(idx, net) {
        // Construct each item in the list and add to the dropdown
        if (net.is_cs) P.top_bar.user.hasCS = true;
        var theHTML = "";
        if (net.school_ext) P.top_bar.schoolExt = net.school_ext;
        if (net.school_emails && (net.school_emails.length > 3)) {
          if (net.school_emails.substr(net.school_emails.length - 4, 4) == ".edu") P.top_bar.user.hasUS = true;
          if (net.school_emails.substr(net.school_emails.length - 3, 3) == ".ca") P.top_bar.user.hasUS = true;
        }
        var nameHTML = '<span class="course_number">' + net.course_number + '</span>' + net.name + ' <span class="term">[' + net.term + ']</span>';
        if (net.type == "group") {
          var creatorName = net.creator_name;
          if (!creatorName)
            creatorName = "";
          nameHTML = '<span class="course_number">' + net.name + '</span> ' + creatorName;
        }
        if (net.status !== "inactive") {
          haveActiveClasses = true;
          theHTML += '<li class="clearFix classDropdownItem sortable networkDropdown" id="network_' + net.id + '" onclick="P.top_bar.changeNetwork(\'' + net.id + '\')">';
          theHTML += '<div class="main ">' + nameHTML + '</div>';
        } else {
          haveInactiveClasses = true;
          theHTML += '<li class="clearFix classDropdownItem sortable networkDropdown inactiveNetwork" style="display:none;" id="network_' + net.id + '" onclick="P.top_bar.changeNetwork(\'' + net.id + '\')">';
          theHTML += '<div class="main ">' + "(inactive) " + nameHTML + '</div>';
        }

        if (user.new_questions[net.id]) {
          theHTML += '<div class="global_notifications my_classes" id="dropdown_notifications_' + net.id + '">' + user.new_questions[net.id] + '</div>';
        }
        theHTML += '</li>';
        myClasses.append(theHTML);
        // Updated the global notification count on the network dropdown bar
        if (user.new_questions && user.new_questions[net.id] > 0 && net.status !== 'inactive') {
          P.top_bar.globalNotifications += user.new_questions[net.id];
        }
      });

      $('#my_classes').b_sortable().bind('sortupdate', function() {
        P.top_bar.updateClassListOrder();
      });

      if (haveInactiveClasses && haveActiveClasses) {
        $("#inactive_network_toggle").show();
      } else {
        $("#inactive_network_toggle").hide();
        if (!haveActiveClasses)
          $('.inactiveNetwork').show();
      }
    } else {
      // hide drop-down, and disable it
      $('#network_button .topbar_arrow').hide();
      $('#network_button').unbind();
    }
    P.top_bar.user.showCareers = true;
    if (P.top_bar.user.config.email_prefs.careers && P.top_bar.user.config.email_prefs.careers.no_careers)
      P.top_bar.user.showCareers = false;
    $('#global_wishlist_notifications').hide();

    P.top_bar.changeNetwork(nid);
    P.top_bar.displayGlobalNotifications();
  },
  updateClassListOrder: function() {
    var arr = $('#my_classes .classDropdownItem');
    var list = {};
    for (var i = 0; i < arr.length; i++)
      list[$(arr[i]).attr("id").replace("network_", "")] = i;
    var req = {
      stat: 'class_list',
      val:  list
    };
    PA.call_pj("user.set", req, $('#my_classes'), function(data) {
      // sort array on the frontend
      P.top_bar.user.networks.sort(function(a,b) {
        return list[a.id] - list[b.id];
      });
    }, function(err) {
      alert(err);
    });
  },
  displayGlobalNotifications: function() {
    if (P.top_bar.globalNotifications > 0) {
      $("#global_notifications_indicator").html(P.top_bar.globalNotifications);
      $("#global_notifications_indicator_wrapper").show();
      $("#network_button").addClass("notification_present");
    } else {
      $("#global_notifications_indicator_wrapper").hide();
      $("#network_button").removeClass("notification_present");
    }
  },
  changeNetwork: function(id, showNewPost) {
    if (P.top_bar.nid) {
      PEM.fire("verifyAnyCancel", function() {
        P.top_bar.doChangeNetwork(id, showNewPost);
      });
    } else {
      P.top_bar.doChangeNetwork(id, showNewPost);
    }
    return false;
  },
  doChangeNetwork: function(id, showNewPost) {
    if (id === P.top_bar.nid)
      return;
    var user = P.top_bar.user;
    for (var i = 0; i < user.networks.length; i++) {
      if (user.networks[i].id == id) {
        P.top_bar.nid = id;
        var net = user.networks[i];
        net.isGroup = (net.type == "group");
        $('#dropdown_notifications_' + net.id).hide(); // remove red badge
        P.top_bar.globalNotifications -= P.top_bar.user.new_questions[net.id];
        P.top_bar.user.new_questions[net.id] = 0;
        P.top_bar.displayGlobalNotifications();
        P.top_bar.network = net;
        P.top_bar.user.isInst = P.top_bar.user.can_admin[id] || 0;
        P.top_bar.user.isTA = false;
        if (P.top_bar.user.can_admin[id] && P.top_bar.user.can_admin[id] < 10)
          P.top_bar.user.isTA = true;
        // populate section names
        net.sectionNames = {};
        for (var z = 0; z < net.profs.length; z++) {
          PA.users[net.profs[z].id] = net.profs[z];
        }
        if (net.config && net.config.class_sections && net.config.class_sections.sections.length > 0) {
          net.subGroups = net.config.class_sections.sections;
          for (var j = 0; j < net.config.class_sections.sections.length; j++) {
            var sect = net.config.class_sections.sections[j];
            var sectGroup = sect.toLowerCase() + "_" + net.id;
            net.sectionNames[sectGroup] = sect;
          }
        }
        if (net.private_posts == "no" && !P.top_bar.user.isInst) net.noPrivatePosts = true;
        if (net.type == "no-verify") net.isLargeClass = true;

        P.modules.setNetwork(P.top_bar.network);
        P.top_bar.refreshOnlineUsers(P.top_bar.network.id); // 3 minute timeout
        if (net.type != "group") {
          $(".current_class_name").html(P.top_bar.network.course_number);
        } else {
          $(".current_class_name").html(P.top_bar.network.name);
        }
        $(".current_class_name").css("min-width", "90px");// safari trick, to force recalculation of width
        if (typeof(COMPANY_PROFILE) != 'undefined' || typeof(LOAD_MY_PROFILE) != 'undefined') {
          $('.top_bar_qa').hide();
          $('.top_bar_classes').show();
          $('.top_bar_new_careers').show();
          $('.top_bar_new_careers').addClass("active");
          return;
        }
        $('.top_bar_manage').hide();
        $('.top_bar_course_page').hide();
        $('.class_report').hide();
        $('.topbar_icons.stats').hide();
        $('.top_bar_manage').html("<a href='#'>Manage Group</a>");
        $('.top_bar_qa').html("<a href='#'>Home</a>");
        $(".student_only").hide();
        $('#careers_button').hide();
        $('#careers_button_signed').hide();
        $('#piazza_careers_link').hide();
        $('.top_bar_careers_homescreen').hide();
        if (!P.top_bar.user.isPublic)
          P.top_bar.showCareersStuff();
        if (P.top_bar.user.isInst) {
          $(".instructor_only").show();
          $("#topbar_careers_popover").hide();
          $("#topbar_career_events_popover").hide();
        } else {
          $(".instructor_only").hide();
          if (!P.top_bar.user.is_public) {
            if (P.top_bar.schoolExt && P.top_bar.user.networks[0].type != "public" ) {
              $(".student_only").show();
              var url = "/signup/" + P.top_bar.schoolExt;
              $('.top_bar_dropdown_actions_wrapper.student_only').html('<a class="top_bar_dropdown_actions" href="'+url+'">+&nbsp;Add Another Class</a>');
              if (P.top_bar.isDashboard && P.top_bar.user.config.logins > 10) {
                if (!P.top_bar.user.config.careers || !P.top_bar.user.config.careers.stop)
                  $('#careers_button').show();
              }
            }
            if (P.top_bar.user.config.careers && P.top_bar.user.config.careers.signed) {
              $('#careers_button_signed').show();
              $('#careers_button').hide();
            }
          }
        }
        // only show if user has permission
        var role = "member";
        if (P.top_bar.user.config.roles && P.top_bar.user.config.roles[id]) {
          role = P.top_bar.user.config.roles[id];
        }
        if (role == "admin" && net.type != "group")
          role = "instructor";
        P.top_bar.user.network_permissions = {};
        if (net.config && net.config.roles && net.config.roles[role]) {
          P.top_bar.user.network_permissions = net.config.roles[role];
        }
        var canManageClass = PA.hasPermission("manage_group_info");
        P.top_bar.user.role = role;
        if (net.type != "group") {
          net.urlType = "/class";
          $('.top_bar_manage').html("<a href='#'>Manage Class</a>");
          $('.top_bar_qa').html("<a href='#'>Q &amp; A</a>");
          $('.top_bar_course_page').show();
          if (net.total_content_stud > 20)
            $('.class_report').show();
          if (!P.top_bar.user.isPublic)
            $('.topbar_icons.stats').show();
          if (!P.top_bar.user.isPublic && (!P.top_bar.user.config || !P.top_bar.user.config.logins || P.top_bar.user.config.logins < 5) && !PA.isSeenUser('tutorial_dashboard')) {
            P.modules.loadModule("onboarding_overlay", {}, function() {
              PEM.fire("show_onboarding_overlay", P.top_bar.user.isInst);
            }, null);
          }
        } else {
          net.urlType = "/group";
        }
        if (P.top_bar.changeUrl && window.history && window.history.pushState) {
          try {
            window.history.pushState({cid:false, id:false}, "Piazza", P.top_bar.network.urlType + "/" + P.top_bar.network.id );
          } catch (err) {}
        }
        if (canManageClass)
          $('.top_bar_manage').show();
        PEM.fire("network", P.top_bar.network);
        $('#question_feed_questions').scrollTop(0);
        var showHomescreen = true;
        if (typeof(COMPANY_PROFILE) != 'undefined' || typeof(COMPANY_STATS) != 'undefined' || typeof(CAREERS_DASHBOARD) != 'undefined') {
          showHomescreen = false;
        } else
          PEM.fire("cleanDashboard");
        if (showNewPost || (typeof(SHOW_POST) != 'undefined' && SHOW_POST)) {
          SHOW_POST = false;
          setTimeout(function(){PEM.fire("showNewPost");}, 100);
          showHomescreen = false;
        }
        if ((typeof(SHOW_STATS) != 'undefined' && SHOW_STATS)) {
          setTimeout(function(){
            PEM.fire("showClassStats");
            SHOW_STATS = false;
            $('.top_bar_statistics').addClass('active');
            $('.top_bar_qa').removeClass('active');
          }, 100);
          showHomescreen = false;
        }
        if ((typeof(SHOW_UP) != 'undefined' && SHOW_UP)) {
          SHOW_UP = false;
          PEM.fire("showMyProfile");
          showHomescreen = false;
        }
        if (showHomescreen)
          PEM.fire("showHomescreen");
      }
    }
    if (P.top_bar.nid != id && typeof(FORCE_CN) != 'undefined') {
      $(".current_class_name").html(FORCE_CN);
    }
    if (P.top_bar.user.isPublic) {
      $('.top_bar_course_page').hide();
      $('.top_bar_manage').hide();
      if (!P.top_bar.user.isPublicFaq) {
        $('#signup_button').show();
        $('#piazza_com_button').show();
      }
    }
    // if (P.top_bar.user.showCareers && !(P.top_bar.user.isInst && !P.top_bar.user.isTA) && !PA.isSeenUser("careers_select_company_modal")) {
    //   P.modules.loadModule("careers_company_select_modal", {}, function() {
    //     PEM.fire("showCompanySelectModal");
    //   }, null);
    // }
  },
  showCareersStuff: function() {
    if ((P.top_bar.user.showCareers && !(P.top_bar.user.isInst && !P.top_bar.user.isTA) && !P.top_bar.user.isPublic) || P.top_bar.isCareers) {
      $('.top_bar_careers_homescreen').show();
      if (!PA.isSeenUser("careers_intro_modal")) {
        // make sure images have loaded!!
        $('.careers_intro_modal').waitForImages(function() {
          $('.careers_intro_modal').show();
        });
        $('.close_careers_intro_modal').click(function(){
          $('.careers_intro_modal').hide();
          PA.markSeenUnseen("careers_intro_modal");
        });
        $('.careers_intro_image_wrapper a').click(function(){
          var link = $(this).attr('href');
          PA.call_pj("user.mark_seen", {msg:"careers_intro_modal"}, null, function(){
            $.blockUI();
            window.location = link;
          });
          return false;
        });
        $('.close_careers_intro_browse').click(function(){
          PA.call_pj("user.mark_seen", {msg:"careers_intro_modal"}, null, function(){
            $.blockUI();
            window.location = '/careers/dashboard#/companies';
          });
        });
      }
      if (!P.top_bar.allEvents) {
        P.top_bar.rsvpdCompanies = [];
        P.modules.getData("user_profile", null, function(data){
          var pro = PEM.callFirst("loadMyProfile", P.top_bar.loadAllEvents);
          if (pro) {
            P.top_bar.loadAllEvents(pro);
          }
        });
      }
      if (!P.top_bar.allMessages) P.top_bar.loadAllMessages();
      // if (P.top_bar.allStories && P.top_bar.allStories.events && P.top_bar.allStories.events.length > 0)
      //   $('#event_notifications_button').show();
      // P.top_bar.showJobStatus();
    } else {
      $('.top_bar_careers_homescreen').hide();
    }
  },
  profileChange: function(profile) {
    P.top_bar.userProfile = profile;
  },
  loadAllStories: function() {
    P.modules.getData("career_stories", 1, function(data){
      if (P.top_bar.allStories) return;
      var allStories = {events:[], stories:[]};
      var newCount = 0;
      var lastSaw = "";
      if (PA.user.config && PA.user.config.last_saw_careers)
        lastSaw = new Date(PA.user.config.last_saw_careers);
      for (var i = 0; i < data.length; i++) {
        var item = data[i];
        if (item.config.type && item.config.type == "event") {
          var eventDate = new Date(item.show_at);
          if (eventDate > lastSaw)
            newCount += 1;
          allStories.events.push(item);
        } else {
          allStories.stories.push(item);
        }
      }
      if (newCount > 0) {
        $(".event_count").html(newCount);
        $(".event_count").show();
      }
      if (allStories.events.length > 0) {
        $('#event_notifications_button').show();
        var html = "";
        for(var i = 0; i < allStories.events.length; i++) {
          html += P.top_bar.eventStorySmallTemplate({item:allStories.events[i]});
        }
        $('.event_notifications_list').html(html);
      }
      //randomize stories
      shuffleArray(allStories.stories);
      P.modules.getDataLoaded("career_stories_all", allStories);
      P.top_bar.allStories = allStories;
    });
  },
  loadAllEvents: function(profile) {
    // if not already doing this
    if (P.top_bar.loadAllEventsTimout)
      clearTimeout(P.top_bar.loadAllEventsTimout);
    P.top_bar.loadAllEventsTimout = setTimeout(function() {P.top_bar.loadAllEvents(profile);}, 1000 * 60 * 60); // poll every 1 hour
    PA.call_pj("company_event.get_my_events_info", {}, 1, function(data) {
      P.top_bar.userProfile = profile;
      var calcProfileProgress = function(profile) {
        var progress = 0;
        var hasLinks = false;
        if (profile.links && (profile.links.stackoverflow || profile.links.github || profile.links.website || profile.links.linkedin))
          hasLinks = true;
        profile.has_links = hasLinks;
        if (profile.has_links)
          progress += 2;
        if (profile.coding_since)
          progress += 2;
        if (profile.status)
          progress += 2;
        if (profile.visa)
          progress += 2;
        if (profile.roles && profile.roles.length > 0)
          progress += 2;
        var haveSkills = false;
        if (profile.skills && profile.skills.length > 0)
          haveSkills = true;
        if (haveSkills)
          progress += 10;
        if (profile.resume || profile.resume_internal)
          progress += 80;
        profile.progress = progress;
      };
      calcProfileProgress(P.top_bar.userProfile);
      var lastSawEvents = profile.profile_settings.last_saw_events;
      var lastSawEventsMoment;
      if (!lastSawEvents)
        lastSawEventsMoment = moment().year(2013).startOf('year');
      else
        lastSawEventsMoment = moment(lastSawEvents);
      P.top_bar.allCompanies = data.companies;
      var weeks = {};
      var processedWeeks = [];
      P.top_bar.allEvents = {};
      for (var i = 0; i < data.events.length; i++) {
        var e = data.events[i];
        if (e.config && e.config.is_child)
          continue;
        if (!(P.top_bar.allCompanies && P.top_bar.allCompanies[e.internal_id]) && e.internal_id != "all")
          continue;
        if (e.start_date) {
          e.start_date = new Date(e.start_date);
          e.start_date = new Date(e.start_date.getUTCFullYear(),
                                        e.start_date.getUTCMonth(),
                                        e.start_date.getUTCDate());
        }
        if (e.end_date) {
          e.end_date = new Date(e.end_date);
          e.end_date = new Date(e.end_date.getUTCFullYear(),
                                        e.end_date.getUTCMonth(),
                                        e.end_date.getUTCDate());
        }
        e.description = e.description.replace(/(^|[^"'])(https?:\/\/(\([^\s<\[\]"\)]*\)|[^ \t\n<\[\]"()])+?(\([^\s<\[\]"\)]*\)|[\w\/?=)}#&]))(?=$|<br|<\/|\s|([\]\)]|&gt;)[\.,:;?!"'\-]*(\s|<br|<\/|$)|[\.,:;!"'\-]+(\s|<br|<\/|$))/g, '$1<a href="$2" target="_blank">$2</a>');
        if (e.description.length > 300 && e.description.indexOf("href") < 0)
        if (e.description.length > 300)
          e.description = e.description.substring(0, 297) + "...";
        if (e.published && e.show_at && moment(e.show_at) > lastSawEventsMoment)
          e["new"] = true;
        if (e.config && e.config.is_parent) {
          e.children = [];
          for (var j = 0; j < e.config.children.length; j++) {
            var child = e.config.children[j];
            child.image = P.top_bar.allCompanies[child.internal_id].image;
            child.name = P.top_bar.allCompanies[child.internal_id].name;
            child.desc = child.name + "- " + P.top_bar.allCompanies[child.internal_id].short_about;
            if (child.published && child.show_at && moment(child.show_at) > lastSawEventsMoment) {
              e["new"] = true;
              child["new"] = true;
            }
            e.children.push(child);
            P.top_bar.allEvents[child.id] = child;
          }
        }
        if (P.top_bar.allCompanies && P.top_bar.allCompanies[e.internal_id]) {
          e.image = P.top_bar.allCompanies[e.internal_id].image;
          e.name = P.top_bar.allCompanies[e.internal_id].name;
        }
        var momentDate = moment(e.start_date);
        if (!weeks[momentDate.week()])
          weeks[momentDate.week()] = {};
        if (!weeks[momentDate.week()][momentDate.day()])
          weeks[momentDate.week()][momentDate.day()] = [];
        weeks[momentDate.week()][momentDate.day()].push(e);
        if (e.end_date_str && e.start_date_str != e.end_date_str) {
          var tomorrow = moment(e.start_date).add(1, "day");
          var endDate = moment(e.end_date_str);
          while (tomorrow <= endDate) {
            if (!weeks[tomorrow.week()])
              weeks[tomorrow.week()] = {};
            if (!weeks[tomorrow.week()][tomorrow.day()])
              weeks[tomorrow.week()][tomorrow.day()] = [];
            weeks[tomorrow.week()][tomorrow.day()].push(e);
            tomorrow.add(1, "day");
          }
        }
        P.top_bar.allEvents[e.id] = e;
      }
      var newCount = 0;
      var followingEvents = [];
      var week = weeks[moment().day("Monday").week()];
      var hasEvents = false;
      // for (var week in weeks) {
      if (week) {
        var pWeek = [];
        var w = moment().day("Monday").week(week).add(-1, "days");
        w.add(-1, "days");
        var seenEvents = {};
        for (var i = 0; i < 7; i++) {
          var date = w.add(1, "days");
          dateFormatted = date.format("ddd, MMMM Do");
          noDateFormatted = date.format("ddd");
          var popoverSide = "right";
          if (i >= 4)
            popoverSide = "left";
          if (week[i]) {
            pWeek.push({events: week[i], date: dateFormatted, side: popoverSide});
            hasEvents = true;
            for (var j = 0; j < week[i].length; j++) {
              var seenId = week[i][j].internal_id + week[i][j].title;
              if (seenEvents[seenId])
                continue;
              seenEvents[seenId] = 1;
              if (week[i][j]["new"]) newCount += 1;
              if (week[i][j].following)
                followingEvents.push(week[i][j]);
            }
          } else {
            pWeek.push({events: [], date: noDateFormatted, side: popoverSide});
          }
        }
        processedWeeks.push(pWeek);
      }
      // }
      // processedWeeks = [processedWeeks[0]];
      if (processedWeeks.length == 0) {
        processedWeeks = false;
        $("#rsvp_header_1").hide();
      }
      PTM.getModuleTemplate("top_bar", "event_week", function(template){
        P.top_bar.eventWeekTemplate = template;
        $("#event_cal_popover").html(P.top_bar.eventWeekTemplate({events: processedWeeks}));
        if (hasEvents) {
          $("#event_notifications_button").show();
          if (newCount > 0) {
            $(".event_count").html(newCount);
            $(".event_count").show();
          }
        }
        var displayResumeHeader = function() {
          if (followingEvents.length == 0) {
            $('#rsvp_header_2').hide();
            $('#rsvp_header_1').show();
          } else {
            $('#rsvp_header_1').hide();
            $('#rsvp_header_2').show();
            var comps = {};
            var compArray = [];
            for (var i = 0; i < followingEvents.length; i++) {
              if (!comps[e.name]) {
                comps[e.name] = 1;
                compArray.push(e.name);
              }
            }
            $('#rsvp_company_list').html(compArray.join(", "));
            if (P.top_bar.userProfile.resume) {
              $('#rsvp_company_no_resume').show();
              $('#rsvp_company_have_resume').hide();
            } else {
              $('#rsvp_company_no_resume').hide();
              $('#rsvp_company_have_resume').show();
            }
          }
        };
        // displayResumeHeader();
        $(".event_cal_item").hover(function() {
          var eid = $(this).attr("eid");
          var e = P.top_bar.allEvents[eid];
          if (!e) return false;
          $("#event_title_info").html(e.title);
          var dateStr = e.start_date_str;
          if (e.end_date_str)
            dateStr += " - " + e.end_date_str;
          $("#event_date_info").html(dateStr);
          var timeStr = e.start_time;
          if (e.end_time)
            timeStr += " - " + e.end_time;
          $("#event_time_info").html(timeStr);
          $("#event_location_info").html(e.location);
          if (!e.internal_id == "all")
            $("#event_logo_info").html("<img src='" + P.top_bar.allCompanies[e.internal_id].image + "' alt=''>")
          $("#hover_info").addClass('show_info');
        }, function() {
          $("#hover_info").removeClass('show_info');
        });
        $(".child_event_cal_item").hover(function() {
          var e = P.top_bar.allEvents[$(this).attr("eid")];
          $(this).closest(".event_cal_item").find(".event_description").html(e.desc);
        }, function() {
          var e = P.top_bar.allEvents[$(this).closest(".event_cal_item").attr("eid")];
          $(this).closest(".event_cal_item").find(".event_description").html(e.description);
        });
        $(".event_cal_item").click(function(click) {
          if (click && $(click.target).closest(".event_hover_popover").length != 0 && $(click.target).closest("a").length == 0)
            return false;
          if (!(click && $(click.target).closest("a").length > 0)) {
            var eid = $(this).attr('eid');
            var e = P.top_bar.allEvents[eid];
            if (!e) return false;
            var params = {event_id: eid};
            if (e.following) {
              followingEvents = jQuery.grep(followingEvents, function(value) {return value != e;});
              params.unfollow = true;
              e.following = false;
              $("[eid='" + eid + "']").removeClass("rsvped");
              $("[eid='" + eid + "']").find(".event_wrapper").removeClass("rsvped_event");
            } else {
              e.following = true;
              followingEvents.push(e);
              $("[eid='" + eid + "']").addClass("rsvped");
              $("[eid='" + eid + "']").find(".event_wrapper").addClass("rsvped_event");
              if (e.config.is_parent) {
                for (var i = 0; i < e.children.length; i++) {
                  var name = e.children[i].name;
                  if (!P.top_bar.rsvpdCompanies.exist(name))
                    P.top_bar.rsvpdCompanies.push(name);
                }
              } else {
                if (!P.top_bar.rsvpdCompanies.exist(e.name))
                  P.top_bar.rsvpdCompanies.push(e.name);
              }
              if (P.top_bar.rsvpdCompanies.length == 1) {
                $("#rsvp_company_list").html(e.name);
              } else {
                $("#rsvp_company_list").html(P.top_bar.rsvpdCompanies.length + "  companies");
              }
              var progress = P.top_bar.userProfile.progress;
              if (!progress) progress = 0;
              $("#profile_progress").html(progress);
              $("#rsvp_header_1").hide();
              $("#rsvp_header_2").show();
            }
            PA.call_pj("company_event.follow_unfollow_event", params, 1);
            // displayResumeHeader();
          }
        });
        $("#event_cal_popover").click(function(e) {
          e.stopPropagation();
        });
      });
    });
  },
  // clickOutsidePopover: function(e) {
  //   if ($(e.target).closest(".event_actions_popover").length == 0) P.top_bar.closeEventPopover();
  // },
  // closeEventPopover: function() {
  //   if (!P.top_bar.popoverToShow) return;
  //   P.top_bar.popoverToShow = false;
  //   $(".event_actions_popover").hide();
  //   $(document).unbind('mousedown', P.top_bar.clickOutsidePopover);
  // },
  loadAllMessages: function() {
    if (P.top_bar.loadAllMessagesTimout)
      clearTimeout(P.top_bar.loadAllMessagesTimout);
    P.top_bar.loadAllMessagesTimout = setTimeout(function() {P.top_bar.loadAllMessages();}, 1000 * 60 * 5); // poll every 5 minutes
    PA.call_pj("memo.get_unread_message_count", {}, 1, function(data){
      if (data > 0) {
        $(".message_count").html(data);
        $(".message_count").show();
      } else
        $(".message_count").hide();
      P.top_bar.allMessages = [];
    }, function(err){
      $(".message_count").hide();
    });


      // if (P.top_bar.allMessages) return;
      // var allMessages = [];
      // var newCount = 0;
      // var lastSaw = "";
      // if (PA.user.config && PA.user.config.last_saw_messages)
      //   lastSaw = new Date(PA.user.config.last_saw_messages);
      // for (var i = 0; i < data.length; i++) {
      //   var message = data[i];
      //   var messageDate = new Date(message.when);
      //   if (messageDate > lastSaw)
      //     newCount += 1;
      //   allMessages.push(message);
      // }
      // if (newCount > 0) {
      //   $(".message_count").html(newCount);
      //   $(".message_count").show();
      //   PA.call_pj("generic.event_to_requests", {event: "careers.message_count_shown",count:newCount},1);
      // }
      // if (allMessages.length > 0) {
      //   $("#message_notifications_button").show();
      //   PA.call_pj("generic.event_to_requests", {event: "careers.message_icon_shown",count:newCount},1);
      //   var html = "";
      //   for (var i = 0; i < allMessages.length && i<4; i++) {
      //     var newDate = new Date(allMessages[i].when).getFullDate();
      //     allMessages[i].date = newDate;
      //     html += P.top_bar.messageSmallTemplate(allMessages[i]);
      //   }
      //   $('.messages_notifications_list').html(html);
      // }
      // P.modules.getDataLoaded("messages_all", allMessages);
      // P.top_bar.allMessages = allMessages;
    // });
  },
  getUserData: function() {
    PA.call_pj("user.status", {}, null, function(data, aid) {
      P.top_bar.user = data;
      PA.cacheUser(data);
      $("#top_bar").replaceWith(P.top_bar.template(data));
      P.top_bar.initEventHandlers();
      P.top_bar.initTipsies();
      if (data.id.indexOf("public_") == 0 || data.email == "tutorial") data.isPublic = true;
      if (data.id.indexOf("public_faq") == 0 || data.email == "tutorial") data.isPublicFaq = true;
      data.is_public = data.isPublic;
      if (!data.config) data.config = {};
      if (!data.config.email_prefs) data.config.email_prefs = {};
      P.modules.setUser(data);
      P.top_bar.setUserAndPopulateNetworks(data);
      if (typeof(CAN_ADMIN) != 'undefined' && CAN_ADMIN) {
        $('.top_bar_company').show();
      }
      if (typeof(IS_NEW_CAREERS) != 'undefined' && IS_NEW_CAREERS) {
        $("#report_bug_item").hide();
        P.top_bar.thisIsCareers();
      }

      PEM.fire("user", data);
    }, function(err) {
      if (err == "Email verification needed") {
        if (PA.pushCurrent) {
          PA.pushCurrent.abort();
          PA.pushAbort = false;
          PA.pushCurrent = false;
        }
        window.location = "/email_auth";
        return;
      }
      // no user; show login button
      $('.top_bar_middle').hide();
      $('.top_bar_right.logged_in').hide();
      $('#network_button').hide();
      $('.top_bar_dropdown_wrapper').hide();
      $('.top_bar_right.logged_out').show();
      if (typeof(COMPANY_USER) != 'undefined') {
        if (typeof(COMPANY_USER_ID) != 'undefined') {
          P.top_bar.careersPing();
        }
        $('.top_bar_right.logged_out').hide();
        if (typeof(COMPANY_USER) != 'undefined' && COMPANY_USER) {
          var templateParams = {};
          if (typeof(MY_NAME) != 'undefined')
            templateParams.my_name = MY_NAME;
          $("#top_bar").replaceWith(P.top_bar.template(templateParams));
          P.top_bar.initEventHandlers();
          $('.top_bar_right.logged_in_company_profile').show();
          $('.top_bar_middle').show();
          $('.top_bar_company').show();
        }
        else
          $('.top_bar_right.logged_out_company_profile').show();
      }
    });
  },
  openDropDown: function(menu) {
    closeDropDown();
    var dropdown_wrapper = menu.closest('.top_bar_dropdown_wrapper');
    dropdown_wrapper.show();
  },
  thisIsDashboard: function() {
    $('.top_bar_qa').addClass("active");
    P.top_bar.isDashboard = true;
    if (P.top_bar.network.type != "group") {
      if (P.top_bar.network.total_content_stud > 20)
        $('.class_report').show();
      if (!P.top_bar.user.isPublic)
        $('.topbar_icons.stats').show();
      if (!P.top_bar.user.is_public && P.top_bar.schoolExt && P.top_bar.user.networks[0].type != "public" && !P.top_bar.user.isInst
           && P.homescreen.user.config.logins > 10) {
        if (!P.top_bar.user.config.careers || !P.top_bar.user.config.careers.stop) {
          $('#careers_button').show();
        }
      }
      if (!P.top_bar.user.is_public && !P.top_bar.user.isInst) {
        if (P.top_bar.user.config.careers && P.top_bar.user.config.careers.signed) {
          $('#careers_button_signed').show();
          $('#careers_button').hide();
        }
      }
      if (!P.top_bar.user.isPublic)
        P.top_bar.showCareersStuff();
    }
  },
  thisIsCareers: function() {
    P.top_bar.isCareers = true;
    //$("#classes_brand").hide();
    //$("#careers_brand").show();
    //$(".top_bar_tab").hide();
    //$(".class_list").hide();
    //$(".topbar_icon").hide();
    //$(".top_bar_classes_homescreen").show();
    $('.top_bar_manage').hide();
    $('.careers_dashboard_link').addClass('active');
    $('.topbar_events_icon').unbind().click(function(){
      $(".event_count").hide();
      PA.call_pj("user_profile.set_last_saw_events", {}, 1);
      if (P.top_bar.userProfile)
        P.top_bar.userProfile.profile_settings.last_saw_events = moment().format();
      P.top_bar.reloadEventsCount += 1;
      window.location.href = "/careers/dashboard#/events?reload=" + P.top_bar.reloadEventsCount;
      return false;
    });
    P.top_bar.showCareersStuff();
  },
  thisIsManage: function() {
    P.top_bar.isManage = true;
    $('.top_bar_manage').addClass('active');
    $('.topbar_events_icon').click(function(){
      window.location.href = "/careers/dashboard#/events";
      return false;
    });
  },
  cleanDashboard: function() {
    $('.top_bar_statistics').removeClass('active');
    if (P.top_bar.isDashboard)
      $('.top_bar_qa').addClass('active');
  },
  resetEventNotifications: function() {
    $(".event_count").hide();
  },
  resetMessageNotifications: function() {
    $(".message_count").hide();
  },
  init: function(module) {
    PEM.addListener("changeNetwork", function(param){P.top_bar.changeNetwork(param.id, param.show)})
    PEM.addListener("thisIsDashboard", P.top_bar.thisIsDashboard);
    PEM.addListener("thisIsCareers", P.top_bar.thisIsCareers);
    PEM.addListener("thisIsManage", P.top_bar.thisIsManage);
    PEM.addListener("isDashboard", function(){return P.top_bar.isDashboard});
    PEM.addListener("gotoCoursePage", P.top_bar.gotoCoursePage);
    PEM.addListener("gotoConfigClass", P.top_bar.gotoConfigClass);
    PEM.addListener("showBugReport", P.top_bar.showBugReportExternal);
    PEM.addListener("ensureTooltips", P.top_bar.ensureTooltips);
    PEM.addListener("resetEventNotifications", P.top_bar.resetEventNotifications);
    PEM.addListener("resetMessageNotifications", P.top_bar.resetMessageNotifications);
    PEM.addListener("profileChange", P.top_bar.profileChange);
    PEM.addListener("cleanDashboard", P.top_bar.cleanDashboard);
    PEM.addLastListener("feed_created", P.top_bar.ensureTooltips);
    PEM.addLastListener("feed_filtered", P.top_bar.ensureTooltips);
    PEM.addLastListener("content", P.top_bar.ensureTooltips);
    PTM.getModuleTemplate("careers_dashboard", "careers_dashboard_event_story_small", function(template){P.top_bar.eventStorySmallTemplate = template});
    PTM.getModuleTemplate("careers_dashboard", "careers_dashboard_message_small", function(template){P.top_bar.messageSmallTemplate = template});

    P.top_bar.template = module.template;
    $("body").prepend(module.template({}));
    P.top_bar.initEventHandlers();
    P.top_bar.initTipsies();
    P.top_bar.getUserData();

  }
};


(function(a){var b,e=a();a.fn.b_sortable=function(c){var j=String(c);c=a.extend({connectWith:!1},c);return this.each(function(){if(/^enable|disable|destroy$/.test(j)){var g=a(this).children(a(this).data("items")).attr("draggable","enable"==j);"destroy"==j&&g.add(this).removeData("connectWith items").off("dragstart.h5s dragend.h5s selectstart.h5s dragover.h5s dragenter.h5s drop.h5s")}else{var h,k,g=a(this).children(c.items),f=a("<"+(/^ul|ol$/i.test(this.tagName)?"li":"div")+' class="sortable-placeholder">');
g.find(c.handle).mousedown(function(){h=!0}).mouseup(function(){h=!1});a(this).data("items",c.items);e=e.add(f);c.connectWith&&a(c.connectWith).add(this).data("connectWith",c.connectWith);g.attr("draggable","true").on("dragstart.h5s",function(d){if(c.handle&&!h)return!1;h=!1;d=d.originalEvent.dataTransfer;d.effectAllowed="move";d.setData("Text","dummy");k=(b=a(this)).addClass("sortable-dragging").index()}).on("dragend.h5s",function(){b&&(b.removeClass("sortable-dragging").show(),e.detach(),k!=b.index()&&
b.parent().trigger("sortupdate",{item:b}),b=null)}).not("a[href], img").on("selectstart.h5s",function(){this.dragDrop&&this.dragDrop();return!1}).end().add([this,f]).on("dragover.h5s dragenter.h5s drop.h5s",function(d){if(!g.is(b)&&c.connectWith!==a(b).parent().data("connectWith"))return!0;if("drop"==d.type)return d.stopPropagation(),e.filter(":visible").after(b),b.trigger("dragend.h5s"),!1;d.preventDefault();d.originalEvent.dataTransfer.dropEffect="move";g.is(this)?(c.forcePlaceholderSize&&f.height(b.outerHeight()),
b.hide(),a(this)[f.index()<a(this).index()?"after":"before"](f),e.not(f).detach()):!e.is(this)&&!a(this).children(c.items).length&&(e.detach(),a(this).append(f));return!1})}})}})(jQuery);

!function(a){var b="waitForImages";a.waitForImages={hasImageProperties:["backgroundImage","listStyleImage","borderImage","borderCornerImage","cursor"]},a.expr[":"].uncached=function(b){if(!a(b).is('img[src!=""]'))return!1;var c=new Image;return c.src=b.src,!c.complete},a.fn.waitForImages=function(c,d,e){var f=0,g=0;if(a.isPlainObject(arguments[0])&&(e=arguments[0].waitForAll,d=arguments[0].each,c=arguments[0].finished),c=c||a.noop,d=d||a.noop,e=!!e,!a.isFunction(c)||!a.isFunction(d))throw new TypeError("An invalid callback was supplied.");return this.each(function(){var h=a(this),i=[],j=a.waitForImages.hasImageProperties||[],k=/url\(\s*(['"]?)(.*?)\1\s*\)/g;e?h.find("*").addBack().each(function(){var b=a(this);b.is("img:uncached")&&i.push({src:b.attr("src"),element:b[0]}),a.each(j,function(a,c){var d,e=b.css(c);if(!e)return!0;for(;d=k.exec(e);)i.push({src:d[2],element:b[0]})})}):h.find("img:uncached").each(function(){i.push({src:this.src,element:this})}),f=i.length,g=0,0===f&&c.call(h[0]),a.each(i,function(e,i){var j=new Image;a(j).on("load."+b+" error."+b,function(a){return g++,d.call(i.element,g,f,"load"==a.type),g==f?(c.call(h[0]),!1):void 0}),j.src=i.src})})}}(jQuery);

P.feed = {
  user: null,
  network: null,
  content: null,
  feedPrefetch: null,
  feedObj: null,
  searchFeed: null,
  feedHash: {},
  initialFeedWidth: 350,
  searchFeedWidth: 550,

  feedBuckets: {},       // indicate whether or not a feed bucket is open
  bucketIds:{},
  initialFeedSize: 20,   // how many items to load at page start
  finalFeedSize: 200,    // stop dynamically loading the feed after we have this many items
  loadAtOnce: 150,       // how many feed items to load at a time after the initial feed has been loaded
  sort: "updated",       // sorting order: updated|score
  searchSort: "date", // search sort order: date|relevance
  moreFeed: false,       // do we have more feed
  showFeedDetails: "yes",
  feedItemTemplate: null,
  curURLID: null,
  activeClasses: [],     // list of classes user is instructor for

  initEventHandlers: function() {
    window.onpopstate = function(event) {
      if (event && event.state && event.state.cid) {
        P.feed.curURLID = event.state.id;
        P.feed.selectContent(event.state.cid);
      }
    }
    $('.dropdownToggler.feed-options').click(function(){
      $('.feed-options-menu').show();
      return false;
    });
    $('.search_tips_toggle').click(function(){
      if ($('.search_tips').is(':visible')) {
        $('.search_tips').hide();
        $('.search_tips_arrow').removeClass('up').addClass('down');
        $('#question_feed_questions').css('top', '90px');
      } else {
        $('#question_feed_questions').css('top', '345px');
        $('.search_tips').show();
        $('.search_tips_arrow').removeClass('down').addClass('up');
        $('.initial_message').hide();
      }
    });


    // $('#new_post_button').click(function() {
    //   P.modules.loadModule("new_post", {folders: P.feed.feedObj.tags.instructor}, function() {
    //     PEM.fire("show_new_post", {});
    //   }, null);
    //   return false;
    // });
    $('#new_post_button').click(function() {
      P.feed.showNewPost();
      closeDropDown();
      return false;
    });
    $('.manual_filter').click(function() {
      $('.manual_filter').removeClass("active");
      $(this).addClass("active");
      P.feed.filterFeed({filter: $(this).attr("filter")});
    });
    $('#markAllRead').click(function() {
      var answer = confirm("Mark all posts as read?");
      if (answer)
        P.feed.markAllRead();
    });
    $('.show_icons_in_feed').click(function() {
      $('.show_icons_in_feed').toggleClass('active');
      $('#question_feed_questions').toggleClass('hidingIcons');
      if (!P.feed.user.config.feed) P.feed.user.config.feed = {};
      if (P.feed.user.config.feed.icons) {
        PA.call_pj("user.set", {stat:"feed.icons",val:0}, 1);
        P.feed.user.config.feed.icons = 0;
      } else {
        PA.call_pj("user.set", {stat:"feed.icons",val:1}, 1);
        P.feed.user.config.feed.icons = 1;
      }
    });
    $('.show_feed_details').click(function() {
      if ($('#question_feed_questions').hasClass('compact_view')) {
        P.feed.showFeedDetails = "yes";
      } else {
        P.feed.showFeedDetails = "no";
      }
      PA.call_pj("user.set", {stat: "feed_details", val: P.feed.showFeedDetails}, 1);
      if (!P.feed.user.config) P.feed.user.config = {};
      P.feed.user.config.feed_details = P.feed.showFeedDetails;
      P.feed.setFeedDetails(P.feed.showFeedDetails);
    });
    $('.page_feed_options').unbind().click(function(event){
      if ($('#page_feed_options_dropdown').is(':visible')) {
        closeDropdown('#page_feed_options_dropdown', event);
      } else {
        openDropdown('#page_feed_options_dropdown', event);
      }
    });
    $('.feed_options_arrow').unbind().click(function(event){
      if ($('#page_feed_options_dropdown').is(':visible')) {
        closeDropdown('#page_feed_options_dropdown', event);
      } else {
        openDropdown('#page_feed_options_dropdown', event);
      }
    });
    $('#search-box').keyup(function(e){
      var text = $(this).val();
      if ((text.length > 1 || text.match("^\\d+$")) &&
        text !== P.feed.searchQuery) {

        clearTimeout(P.feed.searchTimeout);
        var timeout = 1000;
        if (e.keyCode == 13) timeout = 10;
        P.feed.searchTimeout = setTimeout(function() {
          P.feed.search(text);
          $('#clear-search-button').show();
        }, timeout);
      }
      if (text.length == 0) {
        P.feed.filterFeed();
        clearTimeout(P.feed.searchTimeout);
        $('#clear-search-button').hide();
      }
    });
    $('#clear-search-button').click(function(){
      P.feed.filterFeed();
      return false;
    });
    $('.sort_results_by').unbind().click(function() {
      var sortOrder = 'date';
      if ($(this).attr('id') === "sort_by_rel") {
        sortOrder = 'relevance';
      }
      if(P.feed.searchSort === sortOrder) {
	return;
      }
      P.feed.searchSort = sortOrder;
      P.feed.orderSearchResults(sortOrder);
      if(sortOrder === 'relevance') {
        PA.call_pj("generic.event_to_requests", {event: "sort_by_relevance", ad_id: P.feed.searchHashValue}, 1);
      }
      $('.sort_results_by').removeClass("active");
      $(this).addClass("active");
    });
    $(".open_sort_option").click(function(){
      $(".open_sort_option").removeClass("active");
      $(this).addClass("active");
      var sort = $(this).attr("filter");
      P.feed.changeSortBy(sort, true);
    });
    $("#dismiss_feed_expanded_msg").click(function() {
      PA.markSeenUnseen("feed_view_toggle_msg_new");
    });
    $('#dismiss_feed_search_disabled').click(function(){
      $('#feed_search_disabled').hide();
    });
  },
  showNewPost: function() {
    PEM.fire("verifyAnyCancel", function() {
      P.modules.loadModule("old_new_post", {folders: P.feed.feedObj.tags.instructor}, function() {
        PEM.fire("show_new_post");
      }, null);
    });
  },
  initPersonalFeed: function() {
    if (P.feed.user && P.feed.user.config && P.feed.user.config.feed) {
      var f = P.feed.user.config.feed;
      if (f.icons == 0) {
        $('#show_icons_in_feed').removeClass('active');
        $('#question_feed_questions').addClass('hidingIcons');
      }
      // $('.filter-shortcut').each(function() {
      //   var id = $(this).attr('id').split("-")[1];
      //   if (f[id] == 1)
      //     $(this).show();
      // });
    }
  },
  /*activateHover: function(event, item) {
    $(item).attr('onmouseover', '').unbind('mouseover');
    $(item).find('.feed_item_dropdown_selector .feed_item_dropdown_arrow').hover(
      function(){
        $(this).find('ul').show();
      },
      function(){
        $(this).find('ul').hide();
      }
    );
    $(item).find('.feed_item_dropdown_selector li').click(P.feed.feedItemDropdownMenuCallback);
  },*/
  feedItemDropdownMenuCallback: function(that) {
    var item = $(that);
    var postID = item.closest('.feed_item').attr('id');
    var action = item.attr('class');
    if (action == 'archive_action')
      P.feed.delFeedItem(postID);
    if (action == 'unarchive_action')
      P.feed.addFeedItem(postID);
    if (action == 'follow_action')
      P.feed.toggleFollow(postID, true);
    if (action == 'unfollow_action')
      P.feed.toggleFollow(postID, false);
    if (action == 'mark_unread_action')
      P.feed.markUnread(postID);
    if (action == 'mark_read_action')
      P.feed.markUnread(postID, true);
    if (action == 'delete_action')
      P.feed.deleteContent(postID);
    if (action == 'clone_action') {
      var nid = item.attr("id").substr(9);
      var cn = item.attr("cn"); // course number
      P.feed.clone(postID, nid, cn);
    }
    if (action == 'pin_post' || action == 'unpin_post') {
      var method;
      if (action == 'pin_post')
        method = "content.pin";
      else
        method = "content.unpin";

      PA.call_pj(method, {cid: postID}, 1, function(data) {
        if (P.feed.feedHash[postID]) {
          P.feed.feedHash[postID].tags = data.item.tags;
          P.feed.feedHash[postID].version += 1;
          P.feed.feedItemUpdate(P.feed.feedHash[postID], true);
        }
      });
    }
    return false;
  },
  clone: function(cid, nid, cn) {
    P.feed.feedItemUpdate(P.feed.feedHash[cid]);
    PA.call_pj('network.clone_single_content',
            {content_id:cid, new_course_id:nid}, 1, function() {
              var item = $('#' + cid);
              item.find('.feed_item_dropdown_selector .feed_item_dropdown_arrow ul').hide();
              if (item.find('.successful_clone_message').length == 0) {
                item.find('.messages').append('<li class="successful_clone_message" style="display: none;"><div>Copied to <span class="copy_post_course_number">class</span> as a private post.</div></li>');
              }
              item.find('.copy_post_course_number').text(cn);
              item.find('.successful_clone_message').fadeIn(300).delay(2400).fadeOut(200);
            }, function(err) {
                alert('Failed to clone content: ' + err);
            });
  },
  feedItemUpdate: function(content, forceRecreate) {
	// if there is no post with this ID in the feed, no need to update anything, so we're done
    var $feedItem = $("#" + content.id);
    if ($feedItem.size() < 1)
      return;
    if (forceRecreate || (content.tags && content.tags.exist("pin"))) {
      if (!P.feed.feedFilter && !P.feed.searchFeed) {
        P.feed.setNewFeed(P.feed.feedObj);
        return;
      }
    }
    $(".tipsy").remove();
    var html = P.feed.createFeedItem(content);
    $feedItem.replaceWith(html);
    if (P.feed.content) { // select item again
      $('#' + P.feed.content.id).addClass('selected');
    }
  },
  addFeedItem: function(id, event) {
    PA.call_pj("network.add_item", {cid:id}, $('#' + id), function(data){
      P.feed.searchFeed.remove(function(item) {
        if (id == item.id) {
          item.hidden = false;
          P.feed.feedObj.feed.push(item);
          P.feed.feedHash[item.id] = item;
          return true;
        }
        return false;
      });
      $('#' + id).hide();
    });
    if (event)
      event.stopPropagation();
    return false;//do not bubble event
  },
  deleteContent: function(id) {
    //if (P.feed.checkNotActive()) return false;
    var params = {
      title: "Delete this content?",
      confirm: "Delete",
      cancel: "Cancel",
      callback: function() {
        PA.call_pj("content.delete", {cid:id}, null, function(data){
          P.feed.removeFromFeed(id);
          //P.feed.closeQuestion();
          //P.feed.clearSelectedContent();
        }, function(err) {setTimeout(function() {alert(err);}, 1000)});
      }
    }
    PEM.fire("showConfirmationWindow", params);
    return false;
  },
  toggleFollow: function(cid, follow) {
    var method = "content.unbookmark"
    if (follow)
      method = "content.bookmark"
      PA.call_pj(method, {cid: cid}, 1, function(data) {
        P.feed.feedObj.feed.forEach(function(item){
          if (item.id == cid) {
            if (follow)
              item.book = true;
            else
              item.book = false;
            P.feed.feedItemUpdate(item);
            PEM.fire("toggleFollowFromFeed", {cid: cid, follow: follow});
          }
        });
      });
  },
  toggleFollowFromPost: function(params) {
    P.feed.toggleFollow(params.cid, params.follow);
  },
  markUnread: function(cid, markRead) {
    if (!cid && P.feed.content) cid = P.feed.content.id;
    if (markRead) {
      PA.call_pj("content.view", {cid:cid}, 1, function(data){
        //mark it read on the feed
        P.feed.feedObj.feed.forEach(function(item){
          if (item.id == cid) {
            item.is_new = false;
            P.feed.feedItemUpdate(item);
            PEM.fire("updateFolderCount", {folders: item.folders, action: "dec"});
            //if (item.folders)
            //  P.feed.removeFolderCount(item.folders);
            P.feed.updateTitle();
          }
        });
      });
    } else {
      PA.call_pj("content.mark_unread", {cid:cid}, 1,
        function(data) {
          //mark it unread on the feed
          P.feed.feedObj.feed.forEach(function(item){
            if (item.id == cid) {
              item.is_new = true;
              P.feed.feedItemUpdate(item);
              PEM.fire("updateFolderCount", {folders: item.folders, action: "inc"});
              //if (item.folders)
              //  P.feed.addFolderCount(item.folders);
              P.feed.updateTitle();
            }
          });
        });
    }
  },
  changeSortBy: function(sort, savePrefs) {
    P.feed.sort = sort;
    if (savePrefs) {
      P.feed.user.config.sort_default = sort;
      PA.call_pj("user.set", {stat:"sort_default",val:sort}, 1);
    }
    if (P.feed.feedObj && P.feed.feedObj.feed) {
      if (P.feed.feedFilter) {
        P.feed.searchFeed.sort(P.feed.feedComparator);
        P.feed.createFeed(P.feed.searchFeed);
      } else {
        P.feed.addBuckets(P.feed.feedObj.feed);
        P.feed.feedObj.feed.sort(P.feed.feedComparator);
        P.feed.createFeed(P.feed.feedObj.feed);
      }
    }
  },
  delFeedItem: function(id) {
    PA.call_pj("network.del_item", {cid:id}, $('#' + id), function(data){
      P.feed.removeFromFeed(id);
    });
    return false;//do not bubble event
  },
  removeFromFeed: function(cid) {
    P.feed.feedObj.feed.removeF(function(item) {
      if (cid == item.id) {
        return true;
      }
      return false;
    });
    delete(P.feed.feedHash[cid]);
    $('#' + cid).remove();
    P.feed.updateTitle();
  },
  bucketHeaderHTML: function(bucketName, bucketNumber, start_css, arrow){
    var id = "bucket_" + bucketNumber;
    var img = "";
    if (bucketName == "Pinned") img = "<img src='/images/piazza/dashboard/feed_icon_pin.png' alt='pin'>";

    //DMITRY - I put the image for the top bar of the bucket here. For the Favorite section,
    if (bucketName == "Favorites") img = "<img src='/images/piazza/dashboard/feed_icon_favorite.png' alt='pin'></img>"

    var html = '<div title="' + bucketName + '" onclick="P.feed.toggleBucket(' + "'" + id + "'" + ')" id="' + id + '" class="' + start_css + ' page_feed_bucket_header"><span>' + arrow + ' ' + bucketName + '</span>'+ img +'</div>';
    return html;
  },
  toggleBucket: function(bucketId){
    var $bucket = $('#' +  bucketId);
    if($bucket.siblings('.item-list-in-bucket').is(':visible')){
      P.feed.feedBuckets[$bucket.attr('id')] = 1;
      $bucket.find('span').html('&#9656;' + $bucket.find('span').html().substring(1));
      $bucket.siblings('.item-list-in-bucket').hide();
    } else {
      P.feed.feedBuckets[$bucket.attr('id')] = 2;
      $bucket.find('span').html('&#9662;' + $bucket.find('span').html().substring(1));
      $bucket.siblings('.item-list-in-bucket').show();
    }
  },

  /*
   * Private Function: P.feed.createFeedItem
   * ===================================
   * This function constructs all of the HTML for a single feed item. It
   * handles the showing and hiding of all elements based on the state of
   * the associated content (i.e. if it has a students' response and/or
   * instructors' response, if it has new activity, if it is unread or
   * unanswered, if it has unresolved followups, etc.), so no additional
   * logic is needed on that front.
   */
  createFeedItem: function (content) {

    var statuses = '';
    content.changes = (content.version)
                    ? content.main_version - content.version
                    : content.main_version;
    if (content.has_s)                  statuses += 'has_sr ';                           // SR
    if (content.has_i)                  statuses += 'has_ir ';                           // IR
    if (content.type == 'question'
        && content.no_answer)           statuses += 'unanswered ';                      // Unanswered
    if (content.type == 'note')         statuses += 'note ';                            // Note
    if (content.type == 'poll')         statuses += 'poll ';                            // Poll
    if (content.tag_endorse_prof)       statuses += 'instructor_endorsed_sr ';            // Instructor-Endorsed SR
    if (content.tag_good_prof > 0)      statuses += 'instructor_endorsed_post ';          // Endorsed Post
    if (content.status == 'private')    statuses += 'private ';                         // Private
    if (content.no_answer_followup > 0) statuses += 'has_unresolved_followups ';          // Unanswered Followups
    if (content.id == 'careers_optin')  statuses += 'careers_optin ';
    if (content.id == 'careers_optin_new')  statuses += 'careers_optin_new ';
    if (content.changes > 0 && !P.feed.user.isPublic) statuses += 'has_new_activity ';       // New Activity
    if (content.is_new) statuses += 'unread '; // Unread
    var timeStamp;
    if (content.updated) {
      if (content.dateType == 0) timeStamp = content.updated.get12();       // x units ago
      if (content.dateType == 1) timeStamp = content.updated.getWDay();     // Mon, Tue, Wed
      if (content.dateType == 2) timeStamp = content.updated.getFullDate(); // MM/DD/YY
    }
    var contentChangesPlural = (content.changes > 1 ? 's' : '')
    var icon;
    var memIcon = false;
    if (content.type == 'poll') icon = "poll_icon";
    if (content.type == 'note') icon = "note";
    if (content.type == 'question' && P.feed.network.type == 'group') {
      icon = "";
      memIcon = true;
    }
    var publicUser = P.feed.user.is_public;
    var isInst = P.feed.user.isInst;
    if (!content.tags) content.tags = [];
    var hasPin = content.tags.exist('pin');

    var snippetText = content.content_snipet;
    var subject = content.subject;
    subject = subject.replace(/</g, "&lt;");
    subject = subject.replace(/>/g, "&gt;");
    snippetText = snippetText.replace(/<[^>]+>/g, "");
    snippetText = snippetText.replace(/___bold_start___/g, "<strong style='color:#222'>");
    snippetText = snippetText.replace(/___bold_end___/g, "</strong>");
    if (snippetText.indexOf("<script") >= 0 || snippetText.indexOf("PA.load(") >= 0) snippetText = "";
    var isPrivateToIndividuals = false;
    var icons = 0;
    if (content.hidden)
      icons += 1;
    var didPrivate = false;
    if (content.status == "private") {
      didPrivate = true;
      content.is_private = true;
      icons += 1;
    }
    var sectName;
    if (content.feed_groups) {
      // see if this item is in a section
      sectName = "";
      for (var group in P.feed.network.sectionNames)
        if (content.feed_groups.indexOf(group) == 0) {
          sectName = P.feed.network.sectionNames[group];
          break;
        }
      if (sectName != "") {
        icons += 1;
      } else {
        // must be private to individuals
        if ((content.feed_groups.indexOf(",") >= 0 || content.feed_groups.indexOf("instr_" + P.feed.network.id) >= 0) && !didPrivate) {
          isPrivateToIndividuals = true;
          content.is_private = true;
          icons += 1;
        }
      }
    }
    var instNote = content.tags.exist('instructor-note') || content.tags.exist('instructor-question') || content.tags.exist('instructor-poll');
    if (P.feed.network.isGroup) instNote = false;
    var iconsGtOne = false;
    if (instNote) icons += 1;
    if (icons > 1) {
      iconsGtOne = true;
      icons = 0;
    }
    var maxTitleLen = 235 - icons*59;
    if (content.has_attach) maxTitleLen -= 15;
    var showLikes = P.feed.network.isOpen;
    if (showLikes && content.lk && content.lk > 0) maxTitleLen -= 38;
    var hasLikes = (showLikes && content.lk && content.lk > 0);
    // Instructor-Endorsed Post
    var isEndorsed = (content.tag_good_prof > 0);
    var isEndorsedSR = (content.tag_endorse_prof > 0);
    // Unresolved Followups
    var unresolvedFollowups = content.no_answer_followup;
    var hasUnresolved = false;
    var unresolvedFollowupsPlural = "";
    if (unresolvedFollowups > 0) {
      hasUnresolved = true;
      if (unresolvedFollowups > 1)
        unresolvedFollowupsPlural = "s";
    }
    // Open team mate searches
    var openTeammateSearch = false;
    if ((content.subject.indexOf("Form project teams & study groups!") != -1 ||
       content.subject.indexOf("Search for Teammates!") != -1)) {
       openTeammateSearch = P.feed.feedObj.no_open_teammate_search;
       statuses += 'has_open_teammate_searches ';         // Open Teammate Searches
    }

    var context = {
      isMobile: is_mobile,
      content: content,
      isGroup: (P.feed.network.type == 'group'),
      statuses: statuses,
      timeStamp: timeStamp,
      contentChangesPlural: contentChangesPlural,
      icon: icon,
      memIcon: memIcon,
      publicUser: publicUser,
      isInst: isInst,
      hasPin: hasPin,
      isPrivate: didPrivate,
      sectName: sectName,
      maxTitleLen: maxTitleLen,
      isPrivateToIndividuals:isPrivateToIndividuals,
      instNote: instNote,
      iconsGtOne: iconsGtOne,
      hasLikes: hasLikes,
      numLikes: content.lk,
      snippetText: snippetText,
      subject: subject,
      isEndorsed: isEndorsed,
      isEndorsedSR: isEndorsedSR,
      hasUnresolved: hasUnresolved,
      unresolvedFollowupsPlural: unresolvedFollowupsPlural,
      openTeammateSearch: openTeammateSearch,
      activeClasses: P.feed.activeClasses
    };
    return P.feed.feedItemTemplate(context);
  },

  setUser: function(u) {
    if (!P.feed.user || P.feed.user.id != u.id) {
      P.feed.user = u;
      P.feed.feedPrefetch = u.feed_prefetch;
      u.feed_prefetch = null;
    }
    if (P.feed.template && $('.page_feed').length == 0) {
      $('#views').append(P.feed.template({user:P.feed.user}));
      P.feed.initEventHandlers();
      P.feed.setFeedHideState();
      P.feed.showFeedMessages();
      if ($.browser.msie) {
        setTimeout(function(){
          $('#search-box').focus();
          setTimeout(function(){$('#search-box').blur();}, 200);
        }, 500);
      }
    }
    P.feed.setFeedDetails(u.config.feed_details);
    P.feed.initPersonalFeed();
  },
  setFeedDetails: function(details) {
    P.feed.showFeedDetails = "yes";
    if (details == "no")
      P.feed.showFeedDetails = "no";
    if (P.feed.showFeedDetails == "no") {
      $('#question_feed_questions').addClass('compact_view');
      $('#question_feed_questions').addClass('hidingTags');
      $('.show_feed_details').addClass('active');
    } else {
      $('#question_feed_questions').removeClass('compact_view');
      $('.show_feed_details').removeClass('active');
      if (P.feed.user && P.feed.user.config && P.feed.user.config.feed && P.feed.user.config.feed.tags == 0) return;
      $('#question_feed_questions').removeClass('hidingTags');
    }
  },
  setContent: function(c) {
    P.feed.content = c;
    if (!c) {
      return;
    }
    if (c.status && c.status == "deleted") {
      alert("Content not available!");
      return;
    }
    $('#question_feed_questions').find('.selected').removeClass('selected');
    var element = $('#' + P.feed.content.id);
    if (element.length > 0) {
      element.addClass('selected');
      // scroll to the item
      if (!P.feed.clicked) {
        $('#question_feed_questions').scrollTop(element.offset().top - 200 + $('#question_feed_questions').scrollTop());
      }
      P.feed.clicked = false;
    }
  },
  feedItemClick: function(ev, that) {
    var e = ev;
    // Does this do anything? Removing it in Chrome seems to have no adverse effects; haven't tried IE though

    if ($(e.target).closest('.feed_item_dropdown_selector').size() == 0) {
      P.feed.clicked = true;
      P.feed.selectContent($(that).attr('id'));
    }
  },
  selectContent: function(cid) {
    P.feed.resetSearchTips();
    // get content
    PEM.fire("verifyAnyCancel", function() {
      if (cid == "careers_optin") {
        if (PA.isSeenUser("c_optin")) return;
        PEM.fire("showCareersOptin");
        if (P.feed.feedHash["careers_optin"]) {
          P.feed.feedHash["careers_optin"].is_new = false;
          P.feed.content = false;
          P.feed.feedItemUpdate(P.feed.feedHash["careers_optin"]);
          P.feed.updateTitle();
          $('#question_feed_questions').find('.selected').removeClass('selected');
          $('#careers_optin').addClass('selected');
        };
        if (!PA.isSeenUser("c_optin_seen")) PA.markSeenUnseen("c_optin_seen");
        return;
      }
      if (cid == "careers_optin_new") {
        if (PA.isSeenUser("c_optin_new")) return;
        PEM.fire("showCareersOptinNew");
        if (P.feed.feedHash["careers_optin_new"]) {
          P.feed.feedHash["careers_optin_new"].is_new = false;
          P.feed.content = false;
          P.feed.feedItemUpdate(P.feed.feedHash["careers_optin_new"]);
          P.feed.updateTitle();
          $('#question_feed_questions').find('.selected').removeClass('selected');
          $('#careers_optin_new').addClass('selected');
        };
        if (!PA.isSeenUser("c_optin_new_seen")) PA.markSeenUnseen("c_optin_new_seen");
        return;
      }
      var params = {cid:cid, nid:P.feed.network.id};
      if (P.feed.searchQuery && $('#search-box').val() && $('#search-box').val().length > 1) {
        var index = 0;
        $(".feed_item").each(function(i) {
          if ($(this).attr("id") == cid) index = i;
        });
        params.sid = P.feed.searchHashValue;
        params.index = index;
      }
      PA.call_pj("content.get", params, $("#page_center"), function(content) {
        ATTACHMENTS = {};
        if (P.feed.curURLID != content.id) {
          if (window.history && window.history.pushState) {
            try {
              window.history.pushState({cid:cid, id:content.id}, "Piazza @" + content.nr, P.feed.network.urlType + "/" + P.feed.network.id + "?cid=" + content.nr);
            } catch (err) {}
          }
          P.feed.curURLID = content.id;
        }
        $("#" + content.id).removeClass('unread');
        if (P.feed.feedHash[content.id]) {
          var item = P.feed.feedHash[content.id];
          P.feed.selectedItem = item;
        }
        PEM.fire("updateFolderCount", {folders: content.tags, action: "dec"});
        $('#question_feed_questions').find('.selected').removeClass('selected');
        content.dupeMsg = $('#duplicate_reason').val();
        PEM.fire("cleanDashboard");
        PEM.fire("content", content);
        if (P.feed.feedHash[content.id]) {
          item.is_new = false;
          item.version = item.main_version;
          P.feed.feedItemUpdate(item);
          P.feed.updateTitle();
        };
        // scroll up
        $('.main_panel.scrollable"').scrollTop(0);

        // if search post, record if they stay on it 2, 5, 10 seconds
        if (P.feed.searchQuery && $('#search-box').val() && $('#search-box').val().length > 1) {
          var timeoutFunction = function(seconds) {
            if ($("#" + content.id).hasClass("selected")) {
              var params = {
                event: "search_result_view_" + seconds,
                ad_id: P.feed.searchHashValue,
                content_id: content.id,
                line: index
              }
              PA.call_pj("generic.event_to_requests", params, 1);
            }
          };
          P.feed.searchResultSelectTimeout2 = setTimeout(function() {timeoutFunction("2")}, 2000);
          P.feed.searchResultSelectTimeout5 = setTimeout(function() {timeoutFunction("5")}, 5000);
          P.feed.searchResultSelectTimeout10 = setTimeout(function() {timeoutFunction("10")}, 10000);
          P.feed.searchResultSelectTimeout30 = setTimeout(function() {timeoutFunction("30")}, 30000);
          P.feed.searchResultSelectTimeout60 = setTimeout(function() {timeoutFunction("60")}, 60000);
        }
      }, function(err){alert(err);});
    });
  },
  getSelectedItem: function() {
    return P.feed.selectedItem;
  },
  markAllRead: function() {
    PA.call_pj("network.mark_all", {nid:P.feed.network.id,read:"read"}, null, function(data) {
      // set feed as all read and regenerate
      P.feed.feedObj.feed.forEach(function(item) {
        item.is_new = false;
        item.version = item.main_version;
        PEM.fire("updateFolderCount", {folders: item.folders, action: "dec"});
      });
      if (!P.feed.feedFilter)
        P.feed.setNewFeed(P.feed.feedObj);
    }, function(err) {
      alert(err);
    });
  },
  markAllUnread: function() {
    PA.call_pj("network.mark_all", {nid:P.feed.network.id,read:"unread"}, null, function(data) {
      P.feed.feedObj.feed.forEach(function(item) {
        item.is_new = true;
        PEM.fire("updateFolderCount", {folders: item.folders, action: "inc"});
      });
      if (!P.feed.feedFilter)
        P.feed.setNewFeed(P.feed.feedObj);
    }, function(err) {
      alert(err);
    });
  },
  // when network changes, this is called
  setNetwork: function(n) {
    PEM.fire("thisIsDashboard");
    P.feed.network = n;
    P.feed.activeClasses = [];
    // populate active classes
    var isGroup = (n.type == "group");
    for (var i = 0; i < P.feed.user.networks.length; i++) {
      var net = P.feed.user.networks[i];
      if (net.status == 'active' && net.id != n.id && P.feed.user.can_admin[net.id] > 0 &&
          ((isGroup && net.type == "group") || (!isGroup && net.type != "group")))
        P.feed.activeClasses.push(net);
    }
    // set feed sort
    if (P.feed.network.isOpen) {
      if (P.feed.user.config.sort_default)
        P.feed.changeSortBy(P.feed.user.config.sort_default, false);
    } else {
      P.feed.sort = "updated";
    }

    if (n.id == P.feed.user.last_network && P.feed.feedPrefetch) {
      // this is first time; show prefetched feed
      P.feed.setNewFeed(P.feed.feedPrefetch);
      PEM.fire("initialFolders", P.feed.feedObj.tags);
      PEM.fire("setDrafts", P.feed.feedObj.drafts);
      var specialMentionsInfo = {avg: P.feed.feedPrefetch.avg, hof: P.feed.feedPrefetch.hof, users_7: P.feed.feedPrefetch.users_7};
      PEM.fire("newHof", specialMentionsInfo);
      P.feed.network.draft = P.feed.feedObj.draft;
      if (P.feed.feedPrefetch.more) {
        setTimeout(function() {P.feed.getMoreFeed(P.feed.feedObj.feed.length);}, 500);         //Should be doing this after page is fully loaded -JEG
        P.feed.moreFeed = true;
      } else
        P.feed.moreFeed = false;
      P.feed.feedPrefetch = null;
    } else {
      // need to get feed
      PA.call_pj("network.get_my_feed", {nid:P.feed.network.id,
        limit: P.feed.initialFeedSize,
        sort: P.feed.sort}, $("#feed"), function(feed, aid) {
        //P.feed.setNewFeed(feed);
        P.feed.feedObj = feed;
        PEM.fire("initialFolders", feed.tags);
        PEM.fire("setDrafts", P.feed.feedObj.drafts);
        PEM.fire("newRecentNetworks", P.feed.feedObj.last_networks);
        var specialMentionsInfo = {avg: feed.avg, hof: feed.hof, users_7: feed.users_7};
        PEM.fire("newHof", specialMentionsInfo);
        P.feed.filterFeed({});
      	if (feed.more) {
      	  setTimeout(function() {P.feed.getMoreFeed(P.feed.initialFeedSize);}, 500);         //Should be doing this after page is fully loaded -JEG
          P.feed.moreFeed = true;
        } else
          P.feed.moreFeed = false;
      }, function(err){
        if (err == "Email verification needed") {
          window.location = "/email_auth?nid=" + P.feed.network.id;
        }
      });
    }
    // select content, if needed
    if (typeof(CID) != 'undefined' && CID) {
      P.feed.selectContent(CID);
      CID = false;
    }
  },
  getMoreFeed: function(offset, limit, getAll) {
    offset = (typeof(offset) == 'undefined' || offset == null) ? P.feed.feedObj.feed.length : offset;
    limit = (typeof(limit) == 'undefined' || limit == null) ? P.feed.loadAtOnce : limit;
    getAll = (typeof(getAll) == 'undefined' || getAll == null) ? false :  getAll;
    var params = {nid:P.feed.network.id,
      offset:offset,
      limit:limit,
      sort:P.feed.sort
    };
    var curNetwork = P.feed.network.id;
    var block = 1;
    if (getAll) block = $("#feed_loading_div");
    PA.call_pj("network.get_my_feed", params, block,
      function(feed) {
        if (P.feed.network.id != curNetwork)
          return;
        if (feed.more)
          P.feed.moreFeed = true;
        else
          P.feed.moreFeed = false;
        P.feed.feedObj.feed = P.feed.feedObj.feed.concat(feed.feed);
        P.feed.setNewFeed(P.feed.feedObj);
        if ((P.feed.feedObj.feed.length < P.feed.finalFeedSize || getAll) && feed.more) {// If there are more feed items, load them later
          setTimeout(function() {P.feed.getMoreFeed(null,null,getAll);}, 500);
        }
      }, function(err) {
        $('#feed').find('.loadMoreContent').remove();
        P.feed.moreFeed = false;
    });
  },

  setNewFeed: function(f) {
    P.feed.feedObj = f;
    P.feed.addBuckets(P.feed.feedObj.feed);
    P.feed.feedObj.feed.sort(P.feed.feedComparator);
    $('#filter_message').hide();
    if (P.feed.network && P.feed.network.isOpen) {
      $(".open_sort_option").removeClass("active");
      $(".open_sort_option").show();
      if (P.feed.sort == "like")
        $(".open_sort_option[filter='like']").addClass("active");
      else if (P.feed.sort == "score")
        $(".open_sort_option[filter='score']").addClass("active");
      else
        $(".open_sort_option[filter='updated']").addClass("active");
    } else
      $(".open_sort_option").hide();

    // clear filter
    //
    // create feed here!
    // if (!P.feed.searchFeed && P.feed.user.showCareers && !PA.isSeenUser("c_optin") && P.feed.feedObj.feed.length > 0 && P.feed.feedObj.feed[0].nr != "careers_optin") {
    //   var pp = PEM.callFirst("loadMyProfile", P.feed.injectCareersPost);
    //   if (pp) {
    //     // inject!
    //     P.feed.injectCareersPost(pp, true);
    //   }
    // }
    // if (!P.feed.searchFeed && P.feed.user.showCareers && !PA.isSeenUser("c_optin_new") && P.feed.feedObj.feed[0].nr != "careers_optin_new") {
    //   var pp = PEM.callFirst("loadMyProfile", P.feed.injectCareersPostNew);
    //   if (pp && !(pp.profile_settings && pp.profile_settings.published)) {
    //     // inject!
    //     //P.feed.injectCareersPostNew(pp, true);
    //   }
    // }
    PTM.getModuleTemplate("feed", "feed_item", P.feed.setFeedItemAndCreateFeed, P.feed.feedObj.feed);
    if ($('#careers_optin').length > 0) {
      $('#careers_optin .metadata').before('<i class="icon-remove-sign hide_feed_item" onclick="return P.homescreen.hideOptin();"></i>');
    }
  },
  injectCareersPost:function(profile, dontCreate) {
    if (!profile.profile_settings || !profile.profile_settings.published || profile.resume) return;
    var optinItem = {
      bucket_name:"Pinned",
      bucket_order:0,
      changes:0,
      content_snipet:"Discover careers at companies like Square, Yelp and Airbnb. You can directly message companies and let them directly message you with career opportunities.",
      subject:"Introducing Piazza Careers",
      dateType:2,
      folders:[],
      id:"careers_optin",
      is_new:!PA.isSeenUser("c_optin_seen"),
      no_answer_followup:0,
      nr:"careers_optin",
      pin:1,
      status:"active",
      tags:["pin"],
      type:"other",
      version:0
      //updated: new Date()
    };
    P.feed.feedObj.feed.splice(0, 0, optinItem);
    if (!dontCreate) {
      PTM.getModuleTemplate("feed", "feed_item", P.feed.setFeedItemAndCreateFeed, P.feed.feedObj.feed);
      if ($('#careers_optin').length > 0) {
        $('#careers_optin .metadata').before('<i class="icon-remove-sign hide_feed_item" onclick="return P.homescreen.hideOptin();"></i>');
      }
    }
  },
  injectCareersPostNew:function(profile, dontCreate) {
    if (profile.profile_settings && profile.profile_settings.published) return;
    var optinItem = {
      bucket_name:"Pinned",
      bucket_order:0,
      changes:0,
      content_snipet:"Discover careers at companies like Square, Yelp and Airbnb. You can directly message companies and let them directly message you with career opportunities.",
      subject:"Introducing Piazza Careers",
      dateType:2,
      folders:[],
      id:"careers_optin_new",
      is_new:!PA.isSeenUser("c_optin_new_seen"),
      no_answer_followup:0,
      nr:"careers_optin_new",
      pin:1,
      status:"active",
      tags:["pin"],
      type:"other",
      version:0
      //updated: new Date()
    };
    P.feed.feedObj.feed.splice(0, 0, optinItem);
    if (!dontCreate) {
      PTM.getModuleTemplate("feed", "feed_item", P.feed.setFeedItemAndCreateFeed, P.feed.feedObj.feed);
      PA.call_pj("generic.event_to_requests", {event: "careers.inject_new_optin_post"}, 1);
      if ($('#careers_optin_new').length > 0) {
        $('#careers_optin_new .metadata').before('<i class="icon-remove-sign hide_feed_item" onclick="return P.homescreen.hideOptinNew(\'feed\');"></i>');
      }
    }
  },
  setFeedItemAndCreateFeed: function(template, feed) {
    P.feed.feedItemTemplate = template;
    P.feed.createFeed(feed);

    PEM.fire("feed_created");
    // hide loading screen
    $('#loading-screen').hide();
  },
  toggleFeedShortcut: function() {
    var id = P.feed.manualFilter;
    if (!id) return;
    if (!P.feed.user.config) P.feed.user.config = {};
    if (!P.feed.user.config.feed) P.feed.user.config.feed = {};
    if (!P.feed.user.config.feed[id]) {
      P.feed.user.config.feed[id] = 1;
      $('#shortcut_' + id).show();
    } else {
      P.feed.user.config.feed[id] = 0;
      $('#shortcut_' + id).hide();
    }
    PA.call_pj("user.set", {stat:"feed." + id, val:P.feed.user.config.feed[id]}, 1);
    P.feed.showToggleShortcut();
  },
  showToggleShortcut: function() {
    if (!P.feed.manualFilter) return;
    if (P.feed.manualFilter == "folder") {
      $('#filter_message .bookmark_filter_link').hide();
    }
    else {
      if (P.feed.user.config && P.feed.user.config.feed && P.feed.user.config.feed[P.feed.manualFilter])
        $('#filter_message .bookmark_filter_link').text("Remove shortcut");
      else
        $('#filter_message .bookmark_filter_link').text("Add shortcut");
      $('#filter_message .bookmark_filter_link').show();
    }
  },
  resetSearchTips: function() {
    $('.search_tips').hide();
    $('.search_tips_arrow').removeClass('up').addClass('down');
    if(P.feed.searchFeed) {
      $('#question_feed_questions').css('top', '90px');
    } else {
      $('#question_feed_questions').css('top', '61px');
    }
  },
  filterFeed: function(params) {
    P.feed.resetSearchTips();
    // parameters are "filter" - string representing the filter used (e.g., 'updated', 'unread'); "isTag" - whether the filter is a tag, "showHidden" - whether to show archived posts
    if (params === undefined) {
      params = {};
    }
    var filter = params.filter;
    var isTag = params.isTag;
    var folder = params.folder;

    P.feed.searchFeed = null;
    P.feed.showHidden = false;
    $('#clear-search-button').hide();
    $('#filter_sort_method').hide();
    P.feed.searchQuery = '';
    $('#search_help_box').hide();
    if (!$('#search-box').hasClass('placeholder')) {
      $('#search-box').val('');
    }
    P.feed.animateFeedToWidth(P.feed.initialFeedWidth);
    if (!filter) {
      P.feed.manualFilter = null;
      P.feed.feedFilter = null;
      $('#page_feed_options_dropdown').children(".manual_filter").removeClass('active');
      $('.filter_show_all').addClass('active');
      P.feed.setNewFeed(P.feed.feedObj);
      $('#question_feed_questions').css('top', '61px');
      if (P.feed.showFeedDetails == "no") {
        $("#question_feed_questions").addClass("compact_view");
        $(".show_feed_details").addClass("active");
      }
      P.feed.setFeedHideState(); // reset to default hide state
      // $('#clear-search-button').hide();
      // $('#searchSortToggle').hide();
      // P.feed.scrollFeedToSelected();
      // P.feed.updateFilterDropdown('filter-show-all');
      return false;
    }
    // clear any current search if we're starting a new one
    //P.feed.UIElements.UISearch.emptySearchBox();
    // if (PA.staticContent && isTag) {
    //   filter = filter.toLowerCase();
    //   $('#search-box').removeClass('placeholder');
    //   $('#search-box').val('tag:' + filter);
    //   P.feed.feedFilterTag = filter;
    //   if (P.feed.feed && P.feed.feed.length > 0) {
    //     P.feed.addBuckets(P.feed.feed);
    //     P.feed.feed.sort(P.feed.feedComparator);
    //     P.feed.createFeed(P.feed.feed);
    //   }
    //   $("#" + P.feed.feedElementID).find('.scrollable').scrollTop(0);
    //   return false;
    // }
    var manualFilters = {
      'good_question': 'Instructor-marked Good Questions',
      'unread': 'Unread Posts',
      'following': 'Posts I Follow',
      'unresolved': 'Unresolved Questions',
      'updated': 'Updated Posts',
      'hidden': 'Posts I Archived',
      'unanswered': 'Unanswered Questions',
      'unresolved_followups': 'Unresolved Followups',
      'folder': ''
    };
    P.feed.feedFilter = manualFilters[filter];
    P.feed.manualFilter = filter;
    P.feed.searchQuery = '';
    var apiParams = {nid:P.feed.network.id, sort:P.feed.sort};
    if (folder) {
      apiParams.filter_folder = folder;
      P.feed.feedFilter = folder;
      P.feed.manualFitler = 'folder';
    }
    apiParams[filter] = 1;
    if(params.showHidden) {
      apiParams.hidden = params.showHidden;
    }
    // if (PA.staticContent) {
    //   P.feed.createFeed(P.feed.feedObj.feed);
    //   //$("#" + P.feed.feedElementID).find('.scrollable').scrollTop(0);
    //   return false;
    // }
    PA.call_pj("network.filter_feed", apiParams, $('#feed'), function(result){
      if (result.feed) {
        if (params.hidden) {
          P.feed.showHidden = true;
        }
        P.feed.searchFeed = result.feed;
        P.feed.addBuckets(P.feed.searchFeed);
        P.feed.searchFeed.sort(P.feed.feedComparator);
        P.feed.createFeed(P.feed.searchFeed);
        P.feed.autoSearch = false;
        P.feed.mergeIntoMainFeed();
        $('#question_feed_questions').css('top', '91px');
        $('#filter_message').show();
        $('#filter_message #filter_by').text(P.feed.feedFilter);
        P.feed.showToggleShortcut();
        P.feed.setFeedHideState(true);//show feed, if it is hidden right now
        PEM.fire("feed_filtered");
      }
    }, function(err) {
      alert(err);
      P.feed.autoSearch = false;
    });
  },
  searchHash: function(query) {
    query = (new Date()).getTime().toString() + query;
    var hash = 0, i, char;
    if (query.length == 0) return hash;
    for (i = 0, l = query.length; i < l; i++) {
        char  = query.charCodeAt(i);
        hash  = ((hash<<5)-hash)+char;
        hash |= 0; // Convert to 32bit integer
    }
    return hash;
  },
  search: function(query) {
    if (P.feed.user.is_public) {
      $('#feed_search_disabled').show();
      return;
    }
    if (P.feed.searchResultSelectTimeout2) {
      clearTimeout(P.feed.searchResultSelectTimeout2);
      clearTimeout(P.feed.searchResultSelectTimeout5);
      clearTimeout(P.feed.searchResultSelectTimeout10);
      clearTimeout(P.feed.searchResultSelectTimeout30);
      clearTimeout(P.feed.searchResultSelectTimeout60);
    }
    P.feed.searchQuery = query;
    if (!query || query == "Search or add a post...")
      return P.feed.filterFeed();
    if (query.indexOf("@") === 0 && parseInt(query.substr(1)) >= 0) {
      P.feed.selectContent(query.substr(1));
      return;
    }
    $('#question_feed_questions').css('top', '61px');
    P.feed.searchHashValue = P.feed.searchHash(query);
    PA.call_pj("network.search", {nid:P.feed.network.id, query:query, sid:P.feed.searchHashValue}, $('#feed'), function(result, aid){
      if (P.feed.searchQuery && P.feed.searchQuery !== "") {
        $('.search_term').html(query);
        if (query.indexOf(":") < 0)
          $('#search_help_box').show();
        P.feed.feedFilter = null;
        P.feed.searchFeed = result;
	P.feed.orderSearchResults(P.feed.searchSort);
        P.feed.mergeIntoMainFeed();

        $('.sort_results_by').removeClass("active");
	$('#question_feed_questions').css('top', '91px');
	$('#filter_sort_method').show();

	if(P.feed.searchSort === 'date') {
          $(".sort_results_by[id=sort_by_date]").addClass("active");
        } else {
	  $(".sort_results_by[id=sort_by_rel]").addClass("active");
	}
        $('#filter_message').hide();
        P.feed.animateFeedToWidth(P.feed.searchFeedWidth);
        $("#question_feed_questions").removeClass("compact_view");
        $(".show_feed_details").removeClass("active");
        PEM.fire("feed_filtered");
      }
    }, function(err) {
      // alert(err);
    });
  },
  orderSearchResults: function(sortOrder) {
    if (P.feed.searchFeed) {
      if (sortOrder == 'date') {
        P.feed.searchFeed.sort(function(a,b) {
          if (b.updated > a.updated) return 1;
          if (b.updated < a.updated) return -1;
            return 0;
          });
        P.feed.addBuckets(P.feed.searchFeed);
      } else {
        P.feed.searchFeed.sort(function(a,b) {
          return a.sort_order - b.sort_order;
        });
        P.feed.addSearchBuckets(P.feed.searchFeed);
      }
      P.feed.createFeed(P.feed.searchFeed);
    }
  },
  mergeIntoMainFeed: function() {
    if (!P.feed.feedObj || !P.feed.feedObj.feed) return;
    for (var i = 0; i < P.feed.feedObj.feed.length; i++) {
      var id = P.feed.feedObj.feed[i].id;
      if (P.feed.feedHash[id])
        P.feed.feedObj.feed[i] = P.feed.feedHash[id];
    }
  },
  searchSubject: function() {
    var term = 'subject:"' + P.feed.searchQuery + '"';
    $('#search-box').val(term);
    P.feed.search(term);
    $('#search_help_box').hide();
  },
  searchContributor: function() {
    var term = 'contributor:"' + P.feed.searchQuery + '"';
    $('#search-box').val(term);
    P.feed.search(term);
    $('#search_help_box').hide();
  },
  searchDate: function() {
    var term = P.feed.searchQuery + ' date:' + $('.date_syntax').text();
    $('#search-box').val(term);
    P.feed.search(term);
    $('#search_help_box').hide();
  },
  addSearchBuckets: function(feed) {
    for (var i = 0; i < feed.length; i++) {
      var item = feed[i];
      if (item.updated && !(item.updated instanceof Date)) {
        var dt = new Date();
        dt.setISO8601(item.updated);
        item.updated = dt;
      }
      item.bucket_name = "Search results";
      item.bucket_order = 2;
    }
  },

  createFeed: function(feed) {
    $(".tipsy").remove(); // remove all tipsy messages
    if (typeof(is_mobile) == 'undefined') is_mobile = false;
    var feedHTML = '';
    var now = new Date();
    var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    P.feed.today = today;

    var lastBucket = "";
    var dateType = -1;
    var need_titles = true;
    var shown = 0;

    var lastOpen = true;
    var selContentIn = false;
    P.feed.bid = 0;
    var pinned = "";
    var favorited = "";
    P.feed.bucketIds = {};
    P.feed.feedHash = {};
    var selectedCid = false;
    if (typeof(CID) != 'undefined')
      selectedCid = CID;
    if (P.feed.content) selectedCid = P.feed.content.id;
    for (var i = 0; i < feed.length; i++) {
      var item = feed[i];
      if (!item) continue;
      if (item.type == "ad") continue;
      P.feed.feedHash[item.id] = item;
      var bucket = item.bucket_name;
      if (dateType < 0)
        dateType = P.feed.getDateType(bucket);
      if (bucket != lastBucket && need_titles && !(item.tags && item.tags.exist("pin") && !P.feed.searchFeed) && !item.my_favorite) {
        var open = true;
        if (shown > 50 && !P.feed.searchFeed) {
          open = false;
        }
        var start_css;
        var arrow;
        P.feed.bid++;
        if (P.feed.feedBuckets['bucket_' + P.feed.bid] == 1) open = false;
        if (P.feed.feedBuckets['bucket_' + P.feed.bid] == 2) open = true;
        if (open) {
          start_css = "start_open";
          arrow = "&#9662;";
        } else {
          start_css = "start_closed";
          arrow = "&#9656;";
        }
        if (lastBucket.length > 0) feedHTML += '</div>';
        //var id = "bucket_" + bid;
        feedHTML += '<div class="question_group">'
        feedHTML += P.feed.bucketHeaderHTML(bucket, P.feed.bid, start_css, arrow);
        feedHTML += '<ul id="bucket_' + P.feed.bid + '-item-list" class="item-list-in-bucket" ' + (!open ? 'style="display:none;"' : '') + '>';
        P.feed.bucketIds[bucket] = 'bucket_' + P.feed.bid; //keep mapping of bucket name to id
        lastBucket = bucket;
        dateType = P.feed.getDateType(bucket);
      }
      if (item.id == selectedCid || item.nr == selectedCid) selContentIn = P.feed.bid;
      if (lastOpen) shown++;
      item.dateType = dateType;
      var itemHTML = P.feed.createFeedItem(item);
      if (item.tags && item.tags.exist("pin") && !P.feed.searchFeed) {
        pinned += itemHTML;
      } else if (item.my_favorite) {
        favorited += itemHTML;
      } else {
        feedHTML += itemHTML;
      }
    }
    if (lastBucket.length > 0)
      feedHTML += '</ul></div>';
    if (favorited.length > 0) {
      if (!((P.feed.searchFeed || P.feed.feedFilter) && favorited.length == 0)) {
        var favoriteHTML = '<div class="question_group">';
        var startState = "start_open";
        var startArrow = '&#9662;';
        if (P.feed.feedBuckets['bucket_favorite'] == 1) {
          startState = "start_closed";
          startArrow = '&#9656;';
        }
      }
      favoriteHTML += P.feed.bucketHeaderHTML("Favorites", "favorite", startState, startArrow);
      favoriteHTML += '<ul id="favorite_pin-item-list" class="item-list-in-bucket">' + favorited + '</ul></div>';
      feedHTML = favoriteHTML + feedHTML;
      P.feed.bucketIds['Favorites'] = "bucket_favorite";
    }

    if (pinned.length > 0) {
      var pinnedHTML = '<div class="question_group">';
      var startState = "start_open";
      var startArrow = '&#9662;';
      if (P.feed.feedBuckets['bucket_pin'] == 1) {
        startState = "start_closed";
        startArrow = '&#9656;';
      }
      pinnedHTML += P.feed.bucketHeaderHTML("Pinned", "pin", startState, startArrow);
      pinnedHTML += '<ul id="bucket_pin-item-list" class="item-list-in-bucket">' + pinned + '</ul></div>'
      feedHTML = pinnedHTML + feedHTML;
      P.feed.bucketIds['Pinned'] = "bucket_pin";
    }
    $('#question_feed_questions').removeClass('sortedFiltered');
    var oldTop = $("#feed").find('.scrollable').scrollTop();
    $('#question_feed_questions').html(feedHTML);
    $('#noresults').hide();
    if (P.feed.searchFeed && P.feed.searchFeed.length == 0) {
      $("#noresults").show();
    }
    $("#feed").find('.scrollable').scrollTop(oldTop);
    if (selContentIn) {
      if (!$('#bucket_' + selContentIn).siblings('.item-list-in-bucket').is(':visible'))
        P.feed.toggleBucket('bucket_' + selContentIn);
    }
    if (P.feed.content) {
      $('#feed').find('li.selected').removeClass('selected');
      var element = $('#' + P.feed.content.id);
      if (element.length > 0) {
        element.addClass('selected');
        $('#question_feed_questions').scrollTop(element.offset().top - 200 + $('#question_feed_questions').scrollTop());
      }
    }
    if(P.feed.moreFeed) {
      P.feed.displayShowAll();
    } else
      $('.loadMoreContent').html('');
    P.feed.updateTitle();
    // if (P.feed.user && !(P.feed.user.isInst && !P.feed.user.isTA) && P.feed.user.config && P.feed.user.config.logins && P.feed.user.config.logins > 10) {
    //   if (!(P.feed.user.config && P.feed.user.config.email_prefs && P.feed.user.config.email_prefs.careers && P.feed.user.config.email_prefs.careers.no_careers)) {
    //     if (!PA.isSeenUser("careers_feed_resume_dec")) {
    //       P.modules.getData("user_profile", null, function(data){
    //         var pro = PEM.callFirst("loadMyProfile", P.feed.showCareersFeedResume);
    //         if (pro) {
    //           P.feed.showCareersFeedResume(pro);
    //         }
    //       });
    //     }
    //   }
    // }
  },
  getDateType: function(bucketLabel){
    var dateType = 2;
    if (bucketLabel == "This week" || bucketLabel == "Last week")
      dateType = 1;
    if (bucketLabel == "Today" || bucketLabel == "Yesterday")
      dateType = 0;
    return dateType;
  },
  /*
   * Add bucket names to items in feed
   */
  addBuckets: function(feed) {
    var now, today, this_week;
    now = new Date();
    today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    P.feed.today = today;
    this_week = new Date(today.getTime() - today.getDay() * 24 * 60 * 60 * 1000).getTime();
    today = today.getTime();
    for (var i = 0; i < feed.length; i++) {
      var item = feed[i];
      var bucket_name, bucket_order;
      if (item.updated && !(item.updated instanceof Date)) {
        var dt = new Date();
        dt.setISO8601(item.updated);
        item.updated = dt;
      }
      if (item.tags && item.tags.exist("pin")) {
        bucket_name = "Pinned";
        bucket_order = 0;
      } else if (item.my_favorite) {
        bucket_name = "Favorites";
        bucket_order = 1;
      } else {
        var target = item.updated.getTime();
        var when = item.updated;
        if (target >= today) {
          bucket_name = "Today";
          bucket_order = 2;
        } else if (target >= today - 24 * 60 * 60 * 1000) {
          bucket_name = "Yesterday";
          bucket_order = 3;
        } else if (target >= this_week) {
          bucket_name = "This week";
          bucket_order = 4;
        } else if (target >= this_week - 7 * 24 * 60 * 60 * 1000) {
          bucket_name = "Last week";
          bucket_order = 5;
        } else {
          var start = new Date(when.getTime() - when.getDay() * 24 * 60 * 60 * 1000);
          var end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
          bucket_name = "Week " + (start.getMonth() + 1) + "/" + start.getDate() + " - " + (end.getMonth() + 1) + "/" + end.getDate();
          // remove extra precision so bucket_order is same for buckets that have same start week
          var week_start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
          // we want the larger times (more recent start dates) to have smaller bucket_order to be at the top, so need decreasing function
          bucket_order = 6 + (now.getTime() - week_start.getTime())/(1000*60*60*24*7);
        }
      }
      item.bucket_name = bucket_name;
      item.bucket_order = bucket_order;
    }
  },
  feedComparator: function(a,b) {
    var bucket_diff = a.bucket_order - b.bucket_order;
    if (bucket_diff != 0) return bucket_diff;
    // force chronological sort for first two buckets, pinned and favorites
    if (P.feed.sort != "score" || a.bucket_order < 2) {
      if (P.feed.sort == "like")
        return (b.lk ? b.lk : 0) - (a.lk ? a.lk : 0);
      return b.updated - a.updated;
    } else {
       return b.score - a.score;
    }
  },
  /**
  * Displays the "Show All" element at the bottom of the feed.
  * If loading is true, add the loading class to the element so that a spinner gif shows
  * loading defaults to false
  */
  displayShowAll: function(loading){
    loading = (typeof(loading) == 'undefined' || loading == null) ? false : loading; //loading defaults to false
    if (P.feed.searchFeed) return;

    PTM.getModuleTemplate("feed", "show_all_feed", P.feed.displayShowAllCallback, loading);
  },
  displayShowAllCallback: function(template, loading) {
    var $feedRegion = $('#feed').find('.scrollable');
    if($feedRegion.find('.loadMoreContent').length > 0) {
      $feedRegion.find('.loadMoreContent').replaceWith(template({loading: loading}));
    } else {
      $feedRegion.append(template({loading: loading}));
    }
  },
  showAllFeed: function() {
    P.feed.displayShowAll(true);
    P.feed.getMoreFeed(null,1000000,true);
    return false;
  },
  getUnreadPosts: function() {
    var unread = 0;
    if (!P.feed.feedObj) return 0;
    if (!P.feed.feedObj.feed) return 0;
    for (var i = 0; i < P.feed.feedObj.feed.length; i++) {
      if (P.feed.feedObj.feed[i].is_new) unread += 1;
    }
    return unread;
  },
  getUpdatedPosts: function() {
    var updated = 0;
    if (!P.feed.feedObj) return 0;
    if (!P.feed.feedObj.feed) return 0;
    for (var i = 0; i < P.feed.feedObj.feed.length; i++) {
      if (P.feed.feedObj.feed[i].changes && P.feed.feedObj.feed[i].changes > 0) updated += 1;
    }
    return updated;
  },
  updateTitle: function() {
    var title = P.feed.network.course_number;
    var unread = P.feed.getUnreadPosts();
    if(unread !== undefined && unread > 0) {
      title += " (" + unread + " unread)";
    }
    $(document).attr("title", title);
  },
  pushNetworkMessage: function(message) {
    if (message.item) {
      // make sure this item is for me, if it belongs to a group
      if (message.item.feed_groups) {
        var canSee = (message.item.feed_groups.indexOf(P.feed.user.id) >= 0);
        if (P.feed.user.isInst && message.item.feed_groups.indexOf("instr_" + P.feed.network.id) >= 0) canSee = true;
        if (!canSee) {
          if (P.feed.user.config.feed_groups && P.feed.user.config.feed_groups.length > 0) {
            for (var i = 0; i < P.feed.user.config.feed_groups.length; i++)
              if (message.item.feed_groups.indexOf(P.feed.user.config.feed_groups[i]) == 0) {
                canSee = true;
                break;
              }
          }
        }
        if (!canSee) return false;
      }
    }
    if (message.action == 'feed_item_change' && P.feed.feedObj) {
      var dt = new Date();
      dt.setISO8601(message.item.updated);
      message.item.updated = dt;
      var f = null;
      var forceFeedRecreate = false;
      if (P.feed.feedHash[message.item.id]) {
        f = P.feed.feedHash[message.item.id];
        if (f.is_new)
          message.item.is_new = true;
        if (f.tags.exist("pin")) forceFeedRecreate = true;
        message.item.version = f.version;
        message.item.book = f.book;
        message.item.my_favorite = f.my_favorite;
        if (message.item.log && message.item.log[message.item.log.length - 1].u && message.item.log[message.item.log.length - 1].u == P.feed.user.id) {
          message.item.version = message.item.main_version;
        } else {
          if (P.feed.content && message.item.id == P.feed.content.id) {
            message.item.version = message.item.main_version;
            PA.call_pj("content.view", {cid:P.feed.content.id}, 1);
          }
        }
        for (var key in message.item)
          f[key] = message.item[key];
        f.feed_groups = message.item.feed_groups;
        f.tag_good_prof = message.item.tag_good_prof;
        f.tag_endorse_prof = message.item.tag_endorse_prof;
        f.gd = message.item.gd;
        f.gd_a = message.item.gd_a;
      }
      if (P.feed.searchFeed && P.feed.searchFeed.length > 0) {
        for (var i = 0; i < P.feed.searchFeed.length; i++) {
          if (P.feed.searchFeed[i].id == message.item.id) {
            P.feed.searchFeed[i] = message.item;
          }
        }
      }
      if (f)
        P.feed.feedItemUpdate(f, forceFeedRecreate);
    }
    if (message.action == 'feed_item_delete' && P.feed.feedObj && message.item) {
      P.feed.removeFromFeed(message.item.id);
    }
    if (message.action == 'feed_item_delete' && P.feed.feedObj && message.cid) {
      P.feed.removeFromFeed(message.cid);
    }
    if (message.action == 'feed_item_new' && P.feed.feedObj) {
      if (message.item) {
        var dt = new Date();
        dt.setISO8601(message.item.updated);
        message.item.updated = dt;
        if (P.feed.content && message.item.id == P.feed.content.id) {
          message.item.is_new = false;
          message.item.is_modified = false;
          message.item.changes = 0;
        }
        // see who made last few edits
        if (message.item.log && message.item.log[message.item.log.length - 1].u && message.item.log[message.item.log.length - 1].u == P.feed.user.id) {
          message.item.version = message.item.main_version;
          message.item.is_new = false;
        }
        // make sure we don't have this item yet --Where to add new items
        if (!P.feed.feedHash[message.item.id]) {
          P.feed.feedObj.feed.push(message.item);
          if (!P.feed.feedFilter)
            P.feed.setNewFeed(P.feed.feedObj);
          if (message.item.is_new) {
            PEM.fire("updateFolderCount", {folders: message.item.folders, action: "inc"});
          }
          P.feed.updateTitle();
        }
      }
    }
  },
  updateFavoriteListener: function(content) {
    var f = null;
    if (P.feed.feedHash[content.id]) {
      f = P.feed.feedHash[content.id];
      f.my_favorite = content.my_favorite;
    }
    if (P.feed.searchFeed && P.feed.searchFeed.length > 0) {
      for (var i = 0; i < P.feed.searchFeed.length; i++) {
        if (P.feed.searchFeed[i].id == content.id) {
          P.feed.searchFeed[i] = content;
        }
      }
    }
    if (f)
      P.feed.feedItemUpdate(f, true);
  },
  unselectPost: function() {
    $('#question_feed_questions').find('.selected').removeClass('selected');
    if (P.feed.searchResultSelectTimeout2) {
      clearTimeout(P.feed.searchResultSelectTimeout2);
      clearTimeout(P.feed.searchResultSelectTimeout5);
      clearTimeout(P.feed.searchResultSelectTimeout10);
      clearTimeout(P.feed.searchResultSelectTimeout30);
      clearTimeout(P.feed.searchResultSelectTimeout60);
    }
  },
  showHideFeed: function(show) {
    if (show) {
      P.feed.user.config.hide_feed = false;
      PA.call_pj("user.unset", {stat:"hide_feed"}, 1);
    } else {
      P.feed.user.config.hide_feed = "yes";
      PA.call_pj("user.set", {stat:"hide_feed", val:"yes"}, 1);
    }
    P.feed.setFeedHideState();
  },
  hideFeed: function() {
    $("#feed").hide();
    $("#page_center").css("left", 0);
  },
  showFeed: function() {
    $("#feed").show();
    PEM.fire("initialFolders", P.feed.feedObj.tags);
    P.feed.setFeedHideState();
  },
  showCareersOptOut: function() {
    html = '<div class="company_images"><img src="../../../images/dashboard/question-feed/company_logos.png"></div>';
    html += '<h2>Allow companies to message me on Piazza about  career opportunities</h2>';
    html += '<div class="clearfix">';
    html += '<div class="half_width"><button class="btn btn-block btn-small ok_got_careers_opt_out">Sounds Good!</button></div>';
    html += '<div class="half_width"><a href="#" class="center_link message_box_link not_relevant_careers_opt_out">Careers are not relevant to me</a></div>';
    html += '</div>';
    html += '<div class="message_box_small_message">* Companies can find you by your class titles on Piazza. Questions and answers you post on Piazza are never shared with companies, nor is your email address.</div>';
    $("#share_classes_message_box").html(html);
    $(".ok_got_careers_opt_out").click(function() {
      var params = {set:{"profile_settings.published":true, "last_published":parseInt((new Date()).getTime() / 1000)}};
      P.user_careers_profile.updateProfile(params); // publish profile
      PA.markSeenUnseen("careers_opt_out_feed");
      $("#share_classes_message_box").hide();
      $("#question_feed_questions").removeClass("showing_careers_message_box");
      PA.call_pj("generic.page_event", {type:"hide_careers_opt_out_feed10"}, 1, function(){});
    });
    $(".not_relevant_careers_opt_out").click(function() {
      PA.call_pj("generic.page_event", {type:"careers_opt_out_turrible10"}, 1, function(){});
      PA.markSeenUnseen("careers_opt_out_feed");
      $("#share_classes_message_box").hide();
      $("#question_feed_questions").removeClass("showing_careers_message_box");
      PA.call_pj("generic.page_event", {type:"hide_careers_opt_out_feed10"}, 1, function(){});
    });
    $("#question_feed_questions").addClass("showing_careers_message_box");
    $("#share_classes_message_box").show();
    PA.call_pj("generic.page_event", {type:"show_careers_opt_out_feed10"}, 1, function(){});
  },
  showCareersFeedGradYear: function(profile) {
    $("input:radio[name=grad_year]").change(function() {
      var gradYear = $("input:radio[name=grad_year]:checked").val();
      var params = {set:{"academics.grad_year":gradYear}};
      P.user_careers_profile.updateProfile(params); // publish profile
      PA.markSeenUnseen("careers_feed_grad_year");
      $("#question_feed_questions").removeClass("showing_careers_grad_year_input");
      $("#enter_grad_year_major").hide();
      PA.call_pj("generic.event_to_requests", {event:"hide_feed_grad_year_2"}, 1, function(){});
    });
    $("#question_feed_questions").addClass("showing_careers_grad_year_input");
    $("#enter_grad_year_major").show();
    PA.call_pj("generic.event_to_requests", {event:"show_feed_grad_year_2"}, 1, function(){});
  },
  showCareersFeedResume: function(profile) {
    if (profile && profile.resume)
      return false;
    P.feed.userProfile = profile;
    $("#upload_resume_feed_btn").unbind().click(function() {
      $("#upload_form_file").click();
    });
    $("#close_resume_feed_box").unbind().click(function() {
      if ($("#submit_resume .first_view").is(":visible")) {
        PA.call_pj("generic.event_to_requests", {event: "resume_feed.xed_no_resume"}, 1);
      } else {
        clearTimeout(P.feed.resumeBoxTimeout);
        var published = false;
        if ($("#feed_resume_checkbox").is(":checked"))
          published = true;
        PA.call_pj("user_profile.save_published_status", {published: published, message: "xed"}, 1);
      }
      $("#submit_resume").hide();
      PA.markSeenUnseen("careers_feed_resume_dec");
      $("#question_feed_questions").removeClass("showing_upload_resume");
    });
    $("#okay_resume_feed_box").unbind().click(function(){
      clearTimeout(P.feed.resumeBoxTimeout);
      $("#submit_resume").hide();
      PA.markSeenUnseen("careers_feed_resume_dec");
      $("#question_feed_questions").removeClass("showing_upload_resume");
      var published = false;
      if ($("#feed_resume_checkbox").is(":checked"))
        published = true;
      PA.call_pj("user_profile.save_published_status", {published: published, message: "okay"}, 1);
    });
    $("#question_feed_questions").addClass("showing_upload_resume");
    PA.call_pj("generic.event_to_requests", {event: "resume_feed.show"}, 1);
    $("#submit_resume").show();
  },
  startUpload: function() {
    P.feed.uploading = true;
    $.blockUI();
    PA.call_pj("generic.event_to_requests", {event: "resume_feed.uploaded_resume"}, 1);
    $('#upload_form_feed').submit();
  },
  onUploadComplete: function() {
    if (!P.feed.uploading) return false;
    P.feed.uploading = false;
    $.unblockUI();
    if (P.feed.userProfile && P.feed.userProfile.profile_settings && P.feed.userProfile.profile_settings.published) {
      $("#submit_resume").hide();
      $("#question_feed_questions").removeClass("showing_upload_resume");
      PA.markSeenUnseen("careers_feed_resume_dec");
      PA.call_pj("generic.event_to_requests", {event: "resume_feed.already_opted_in"}, 1);
      return false;
    }
    $("#submit_resume .first_view").hide();
    $("#submit_resume .second_view").show();
    P.feed.resumeBoxTimeout = setTimeout(function() {
      $("#submit_resume").fadeOut(500, function() {
        var published = false;
        if ($("#feed_resume_checkbox").is(":checked"))
          published = true;
        PA.call_pj("user_profile.save_published_status", {published: published, message: "fade"}, 1);
        $("#question_feed_questions").removeClass("showing_upload_resume");
      });
      PA.markSeenUnseen("careers_feed_resume_dec");
    }, 8000);
  },
  setFeedHideState: function(forceShow) {
    if (P.feed.user.config.hide_feed && !forceShow) {
      $('.hide_show_feed.show_feed').show();
      $('#feed').hide();
      $('#page_center').css("left", "0px");
      $('#page_bottom_bar').css("left", "0px");
    } else {
      $('.hide_show_feed.show_feed').hide();
      $('#feed').show();
      $('#page_center').css("left", "350px");
      $('#page_bottom_bar').css("left", "350px");
    }
  },
  showFeedMessages: function() {
    if (P.feed.user.config && P.feed.user.config.seen_message) {
      var msg = "feed_view_toggle_msg_new";
      if (P.feed.user.config.seen_message.exist(msg) || (msg == "feed_view_toggle_msg_new" && (!P.feed.user.config.logins || P.feed.user.config.logins < 20))) {

      } else {
        PA.markSeenUnseen(msg);
        if (P.feed.user.config.feed_details != "yes") {
          $("#feed_expanded").show();
          P.feed.user.config.feed_details = "yes";
          P.feed.showFeedDetails = "yes";
          P.feed.setFeedDetails(P.feed.showFeedDetails);
          PA.call_pj("user.set", {stat: "feed_details", val: "yes"}, 1);
        }
      }
    }
  },
  animateFeedToWidth: function(width) {
    $("#feed").animate({
      width: width
    }, 300);
    $("#page_center").animate({
      left: width
    }, 300);
    $("#page_bottom_bar").animate({
      left: width
    }, 300);
  },
  init: function(module) {
    PEM.addListener("network", P.feed.setNetwork);
    PEM.addListener("content", P.feed.setContent);
    PEM.addListener("pushNetworkMessage", P.feed.pushNetworkMessage);
    PEM.addListener("updateFavorite", P.feed.updateFavoriteListener);
    PEM.addListener("filterFeed", P.feed.filterFeed);
    PEM.addListener("toggleFeedShortcut", P.feed.toggleFeedShortcut);
    PEM.addListener("selectContent", P.feed.selectContent);
    PEM.addListener("toggleFollowFromPost", P.feed.toggleFollowFromPost);
    PEM.addListener("showNewPost", P.feed.showNewPost);
    PEM.addListener("cleanDashboard", P.feed.unselectPost);
    PEM.addListener("getUnreadPosts", P.feed.getUnreadPosts);
    PEM.addListener("getUpdatedPosts", P.feed.getUpdatedPosts);
    PEM.addListener("deleteContent", P.feed.deleteContent);
    PEM.addListener("showHideFeed", P.feed.showHideFeed);
    PEM.addListener("getSelectedItem", P.feed.getSelectedItem);
    PEM.addListener("updateTitle", P.feed.updateTitle);
    PEM.addListener("hideFeed", P.feed.hideFeed);
    PEM.addListener("showFeed", P.feed.showFeed);
    P.feed.template = module.template;
 }
};
P.folders_bar = {
  network:null,
  allFolders:null,
  maxTags: 20,

  setNetwork: function(network) {
    P.folders_bar.network = network;
  },
  setInitialFolders: function(tags) {
    if (!tags) {
      $("#page_main").removeClass("has_popular_tags_bar");
      return;
    }

    P.folders_bar.allFolders = tags;

    foldersToShow = [];
    if (!P.folders_bar.allFolders || !P.folders_bar.allFolders.instructor) return;
    var folders = P.folders_bar.allFolders.instructor;
    var upd = P.folders_bar.allFolders.instructor_upd;
    // only show folders that has something in them
    var foldUpd = [];
    for (var i = 0; i < folders.length; i++) {
      if (upd[folders[i]])
        foldUpd.push({f:folders[i],u:upd[folders[i]]})
    }
    foldUpd.sort(function(a,b){ return b.u - a.u; });
    var show = {};
    if (foldUpd.length < P.folders_bar.maxTags / 4) {
      for (var i = 0; i < Math.min(folders.length, P.folders_bar.maxTags / 4); i++)
        foldUpd.push({f:folders[i],u:0});
    }
    for (var i = 0; i < Math.min(P.folders_bar.maxTags, foldUpd.length); i++) {
      show[foldUpd[i].f] = 1;
    }
    for (var i = 0; i < folders.length; i++) {
      if (!show[folders[i]]) continue;
      var cnt = (P.folders_bar.allFolders.instructor_count[folders[i]]);
      foldersToShow.push({name: folders[i], count: cnt});
    }
    // for (var i = 0; i < folders.length; i++) {
    //   if (!show[folders[i]]) continue;
    //   if (P.folders_bar.allFolders.instructor_count[folders[i]])
    //     foldersToShow.push({name: folders[i], count: P.folders_bar.allFolders.instructor_count[folders[i]]})
    // }
    // $('#PopularTagsList li a').each(function(){
    //   $(this).parent().width($(this).parent().width());
    // });

    if (P.folders_bar.network && P.folders_bar.network.config && P.folders_bar.network.config.disable_folders) {
      $("#bars").html("");
      $("#page_main").removeClass("has_popular_tags_bar");
    }
    else {
      $("#page_main").removeClass("has_popular_tags_bar").addClass("has_popular_tags_bar");
      $("#bars").html(P.folders_bar.template({folders: foldersToShow}));
      $("#bars").show();
    }
  },
  escapeId:function(str) {
    return str.replace(/([:.+])/g, "\\$1");
  },
  updateFolderCount: function(params) {
    if (P.feed.user.isPublic) return;
    var folderNames = params.folders;
    if (!folderNames) return;
    if (!P.folders_bar.allFolders) return;
    var action = params.action;

    if (action == "inc") {
      for (var i = 0; i < folderNames.length; i++) {
        var folderName = folderNames[i];
        if (!P.folders_bar.allFolders.instructor_count[folderName])
          P.folders_bar.allFolders.instructor_count[folderName] = 0;
        P.folders_bar.allFolders.instructor_count[folderName] += 1;
        var escapedName = P.folders_bar.escapeId(folderName);
        if ($("#folder_count_" + escapedName)) {
          $("#folder_count_" + escapedName).addClass("show");
          $("#folder_count_" + escapedName).html(P.folders_bar.allFolders.instructor_count[folderName]);
        }
      }
    }
    if (action == "dec") {
      for (var i = 0; i < folderNames.length; i++) {
        var folderName = folderNames[i];
        if (!P.folders_bar.allFolders.instructor_count[folderName] || P.folders_bar.allFolders.instructor_count[folderName] < 1)
          P.folders_bar.allFolders.instructor_count[folderName] = 0;
        else
          P.folders_bar.allFolders.instructor_count[folderName] -= 1;
        var escapedName = P.folders_bar.escapeId(folderName);
        if ($("#folder_count_" + escapedName)) {
          if (P.folders_bar.allFolders.instructor_count[folderName] > 0)
            $("#folder_count_" + escapedName).html(P.folders_bar.allFolders.instructor_count[folderName]);
          else
            $("#folder_count_" + escapedName).removeClass("show");
        }
      }
    }
  },
  hideFoldersBar: function() {
    $("#bars").hide();
    $("#page_main").removeClass("has_popular_tags_bar");
  },

  init: function(module) {
    PEM.addListener("network", P.folders_bar.setNetwork);
    PEM.addListener("initialFolders", P.folders_bar.setInitialFolders);
    PEM.addListener("updateFolderCount", P.folders_bar.updateFolderCount);
    PEM.addListener("hideFoldersBar", P.folders_bar.hideFoldersBar);
    if (module.options.network)
      P.folders_bar.network = module.options.network;
    P.folders_bar.template = module.template;
  }

};

P.note_view = {
  content:null,
  network:null,
  user:null,
  questionTextTemplate: null,

  initHandlers: function() {
    $('.post_region_box.question_note_view .others.highlight').attr("title", "one, two<br>three");
    $('.post_region_box.question_note_view .others').tooltip({placement: 'bottom', html: true});
    $(".post_region_arrow_dropdown").hover(
      function() {
        $(this).find(".dropdown-menu").show();
      }, function() {
        $(this).find(".dropdown-menu").hide();
      }
    );
    // select correct group
    if (P.note_view.content.isGroup) {
      if (P.note_view.network.sectionNames[P.note_view.content.myGroup]) {
        $('#subgroup_dropdown_edit').val(P.note_view.network.sectionNames[P.note_view.content.myGroup]);
      }
    }
    $('.post_converted_message_close').click(function(){
      $(this).closest('.post_converted_message').hide();
    });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,$('.post_region_box.question_note_view')[0]]);
    P.note_view.subGroupChange();
    P.note_view.showEditors();
  },
  showEditors: function() {
    var edits = P.note_view.content.q_edits;
    var elem = $('.question_note_view .currently_editing');
    if (!edits) return;
    if (edits.length == 0) {
      elem.hide();
      return;
    }
    elem.find('.editing_message').html(
      '&#8764; ' + edits.length + ' other user' + (edits.length > 1 ? 's are' : ' is') + ' editing this right now. &#8764;'
    );
    elem.show();
  },
  setUser: function(user) {
    P.note_view.user = user;
  },
  setNetwork: function(network) {
    P.note_view.network = network;
  },
  setContent: function(content) {
    P.note_view.content = content;

    if (!content) return;
    if (content.type == "note") {
      // this is my content! render it
      P.note_view.prepareHistoryAndChildren(content);
      PTM.getTemplate("question_note_view", P.note_view.showContent);
    }

    var anon = P.note_view.content ? P.note_view.content.default_anonymity : "no";
    $(".anonymity_selector").val(anon);
  },
  showContent: function(template) {
    $('.post_region_box.question_note_view').replaceWith(template({
      content:P.note_view.content,
      network:P.note_view.network,
      user:P.note_view.user,
      anon: PEM.callFirst("getAnonymityOptions")
    }));
    P.note_view.initHandlers();
    P.note_view.visibilityChange();
  },
  prepareHistoryAndChildren: function(content, historyIdx) {
    historyIdx = historyIdx || 0;
    if (content.history && content.history.length > 0) {
      // first make sure history is sorted
      content.history.sort(function(a,b){
        if (a.created > b.created) return -1;
        if (a.created < b.created) return 1;
        return 0;
      })
      content.lastUid = content.history[historyIdx].uid;
      content.anon = content.history[historyIdx].anon;
      if (content.anon == "stud" && content.my_post)
        content.showMyAnon = true;
      content.subject = content.history[historyIdx].subject;
      content.body = content.history[historyIdx].content;
      // special embedding
      if (content.data && content.data.embed_links) {
        for (var i = 0; i < content.data.embed_links.length; i++) {
          var link = content.data.embed_links[i][0];
          var html = content.data.embed_links[i][1];
          // support up to two repeat occurrences of the same link (replaceAll requires using a regex,
          // which requires escaping metacharacters)
          content.body = content.body.replace(link, html).replace(link, html);
        }
      }
      content.last_edit = content.history[historyIdx].created;
      var others = {};
      for (var i = 1; i < content.history.length; i++)
        if (content.lastUid != content.history[i].uid)
          others[content.history[i].uid] = 1;
      var othersArr = [];
      for (var id in others)
        othersArr.push(id);
      content.others = othersArr;
    }
    if (content.children && content.children.length > 0) {
      var attach = [];
      for (var i = 0; i < content.children.length; i++) {
        if (content.children[i].type == "attach") {
          var attachment = P.note_view.makeAttachmentObject(content.children[i]);
          attach.push(attachment);
        }
      }
      if (attach.length > 0)
        content.attach = attach;
    }
    if (content.config && content.config.feed_groups) {
      var arr = content.config.feed_groups.split(",");
      var groups = 0;

      for (var i = 0; i < arr.length; i++) {
        if (arr[i].indexOf("instr_") == 0)
          arr[i] = "Instructors";
        else
          if (arr[i].indexOf("_") > 0) {
            groups = 1;
            content.myGroup = arr[i];
          }
      }
      if (!groups) {
        content.visibleOne = arr[0];
        if (arr.length == 2) {
          content.visibleTwo = arr[1];
        } else {
          arr.splice(0, 1);
          content.visibleArr = arr;
        }
        content.isPrivate = true;
        content.visibility = "private";
        if (content.config.anon_group)
          content.visibleOne = false;
      } else {
        content.visibility = content.myGroup;
        content.isGroup = true;
        P.note_view.subGroupChange();
      }
    } else {
      if (content.status == "private") {
        content.isPrivate = true;
        content.visibility = "private";
      } else {
        content.isPublic = true;
        content.visibility = "all";
      }
    }
    content.showType = content.type;
    P.note_view.prepareEndorsementVars(content, historyIdx);
    content.isPoll = false;
    content.isNote = false;
    content.isQuestion = false;
    content.canEdit = true;
    content.canDelete = true;
    if (!content.uid && content.change_log) content.uid = content.change_log[0].uid;
    if (!P.note_view.network.isGroup && !P.note_view.user.isInst)
      content.canDelete = false;
    if (P.note_view.network.prof_hash && P.note_view.network.prof_hash[content.uid] && !P.note_view.user.isInst)
      content.canEdit = false;
    content.disabledHistory = content.tags.exist("no_history");
    if (content.type == "poll") content.isPoll = true;
    if (content.type == "note") content.isNote = true;
    if (content.type == "question") content.isQuestion = true;
    if (content.isPrivate)
      $(".main_panel").addClass("private_post");
    else
      $(".main_panel").removeClass("private_post");
    // special case for teammate search
    if (content.type == "note" && content.subject == "Form project teams & study groups!" && content.body.indexOf("<script") == 0) {
      content.canEdit = false;
      content.canDelete = false;
      content.noFollowups = true;
      content.isTeammateSearch = true;
    }
  },
  prepareEndorsementVars: function(content, historyIdx) {
    content.endorseOne = null;
    content.endorseTwo = null;
    content.endorseArr = null;
    if (historyIdx > 0) return;
    if (content.tag_good_arr && content.tag_good_arr.length > 0) {
      content.endorseOne = content.tag_good_arr[0];
      if (content.tag_good_arr.length == 2) {
        content.endorseTwo = content.tag_good_arr[1];
      }
      else {
        content.endorseArr = content.tag_good_arr.slice(1, content.tag_good_arr.length);
      }
      if (!(P.note_view.network.type && P.note_view.network.type == "group")) {
        content.endorseOne = false;
        for (var i = 0; i < content.tag_good_arr.length; i++) {
          if (P.note_view.network.prof_hash[content.tag_good_arr[i]]) {
            content.endorseOne = content.tag_good_arr[i];
            break;
          }
        }
      }

    }
  },
  subGroupChange: function() {
    if (!P.note_view.network.config.class_sections) return;
    if (!$("#subgroup_dropdown_edit").val()) return;
    var sect = $('#subgroup_dropdown_edit').val().toLowerCase() + "_" + P.note_view.network.id;
    P.note_view.selectedSection = sect;
    P.note_view.selectedSectionError = false;
    $('#subgroup_list_edit .error_wrapper').hide();
    var usr = P.note_view.user;
    if (usr.config && usr.config.feed_groups && usr.config.feed_groups.exist(sect)) {
      // do nothing here
    } else {
      if (usr.isInst) {
        $('#not-in-section-instructor-edit').show();
      } else {
        if (P.note_view.network.config.class_sections.allow_enroll != 1) {
          $('#not-in-section-student-edit').show();
          P.note_view.selectedSectionError = true;
        } else {
          $('#not-in-section-can-join-edit').show();
          P.note_view.selectedSectionError = true;
        }
      }
    }
  },
  visibilityChange: function() {
    if ($('#question_visibility_1').attr('checked'))
      $('#subgroup_list_edit').show();
    else
      $('#subgroup_list_edit').hide();
  },
  makeAttachmentObject: function(attachment) {
    var nameSize = attachment.subject.split("|");
    attachment.name = nameSize[0];
    var size = nameSize[1];
    if (size < 1000) attachment.size = size + "b";
    if (size >= 1000 && size < 1000000) attachment.size = (size / 1000) + "k";
    if (size >= 1000000) attachment.size = (size / 1000000) + "mb";
    return attachment;
  },
  startEdit: function() {
    if (P.note_view.user.isPublic) {
      alert("You cannot edit this post");
      return;
    }
    $('#edit_question_note').show();
    $('#edit_question_note_bar').show();
    $('#view_quesiton_note').hide();
    $('#view_question_note_bar').hide();
    var toSet = null;
    $(".post_region_box.question_note_view").addClass("edit_mode");
    if (P.note_view.content.config) {
      var feedGroups = P.note_view.content.config["feed_groups"];
      if (feedGroups) {
        feedGroups = feedGroups.split("_")[0];
        $("#subgroup_dropdown_edit option").each(function() {
          if (feedGroups == $(this).attr("value").toLowerCase()) {
            toSet = $(this).attr("value");
          }
        });
      }
    }
    PEM.fire("injectEditor", {
      anonymity: P.note_view.content.default_anonymity,
      where: $("#question_note_editor"),
      postfix: "question_note_edit",
      text: P.note_view.content.body,
      save: P.note_view.editSubmit,
      cancel: P.note_view.stopEdit,
      height: 150,
      type: P.note_view.content.type,
      noSave: true,
      group: toSet
    });
    PA.call_pj("content.edit", {cid: P.note_view.content.id, type: P.note_view.content.type}, 1, function(sid) { PA.user.sid = sid; });
    return false;
  },
  stopEdit: function() {
    $('#edit_question_note').hide();
    $('#edit_question_note_bar').hide();
    $('#view_question_note_bar').show();
    $('#view_quesiton_note').show();
    $(".post_region_box.question_note_view").removeClass("edit_mode");
    PA.call_pj("content.cancel_edit", {cid:P.note_view.content.id, nid:P.note_view.network.id}, 1);
    return false;
  },
  convertType: function() {
    var type = P.note_view.content.type;
    if (type == "question")
      P.note_view.content.type = "note";
    else if (type == "note")
      P.note_view.content.type = "question";

    var obj = {
      cid:       P.note_view.content.id,
      subject:   P.note_view.content.subject,
      content:   P.note_view.content.body,
      anonymous: P.note_view.content.anon,
      type:      P.note_view.content.type
    };

    PA.call_pj("content.update", obj, $('.question_note_view'),
      function(data) {
        PEM.fire("content", data);
        $(".post_converted_message").show().delay(2000).fadeOut(350);
    }, function(err) {setTimeout(function(){alert(err);}, 1000);});

  },
  editFolderClick: function(element) {
    if ($(element).hasClass('selected'))
      $(element).removeClass('selected');
    else
      $(element).addClass('selected');
  },
  startFollow: function() {
    if (!P.note_view.content.is_bookmarked) {
      PA.call_pj("content.bookmark", {cid:P.note_view.content.id}, $('.question_note_view'),
          function(data) {
            P.note_view.content.is_bookmarked = true;
            P.note_view.content.bookmarked += 1;
            PEM.fire("content", P.note_view.content); // re-render
            PEM.fire("toggleFollowFromPost", {cid: P.note_view.content.id, follow: true});
      });
    }
  },
  stopFollow: function() {
    if (P.note_view.content.is_bookmarked) {
      PA.call_pj("content.unbookmark", {cid:P.note_view.content.id}, $('.question_note_view'),
          function(data) {
            P.note_view.content.is_bookmarked = false;
            P.note_view.content.bookmarked -= 1;
            PEM.fire("content", P.note_view.content); // re-render
            PEM.fire("toggleFollowFromPost", {cid: P.note_view.content.id, follow: false});
      });
    }
  },
  toggleFollow: function(params) {
    var cid = params.cid;
    var follow = params.follow;
    if (P.note_view.content && P.note_view.content.id == cid) {
      if (follow)
        P.note_view.startFollow();
      else
        P.note_view.stopFollow();
    }
  },
  editSubmit: function() {

    // this is called when main note/question body is edited

    var $wrapper =
      $('#edit_question_note_subject')
      .closest('.post_region_content.edit_mode');

    var subject = $('#edit_question_note_subject').val();
    var content = PEM.callFirst("getEditorText", "question_note_edit");
    var anon = $('#edit_quesiton_anonymity').val() || "no";
    var type = P.note_view.content.type;

    var    titleIsValid = P.note_view.validateTitle( subject, $wrapper );
    var foldersAreValid = P.note_view.validateFolders( $wrapper );
    // var detailsAreValid = P.note_view.validateDetails( content, $wrapper );

    if ( !titleIsValid || !foldersAreValid ) {
      return false;
    }

    if (type != "poll") {
      if ($('#question_type_0').attr('checked')) type = 'question';
      if ($('#question_type_1').attr('checked')) type = 'note';
    }
    //if ($('#question-type-2').attr('checked')) type = 'poll';

    var obj = {
      cid:       P.note_view.content.id,
      subject:   subject,
      content:   content,
      anonymous: anon,
      type:      type,
      folders:   []
    };

    var visibility = "all";
    if ($('#question_visibility_1').attr('checked'))
      visibility = $('#subgroup_dropdown_edit').val();
    if ($('#question_visibility_2').attr('checked'))
      visibility = "private";
    if (P.note_view.content.visibility != visibility) {
      if ($('#not-in-section-student-edit').is(":visible") || $('#not-in-section-can-join-edit').is(":visible"))
        return false;
      obj.visibility = visibility;
    }

    var selectedFolders = $('#edit_quesiton_note_folders').find('.selected');
    for (var i = 0; i < selectedFolders.length; i++)
      obj.folders.push($(selectedFolders[i]).text());
    if (obj.folders.length == 0 && !P.note_view.network.config.disable_folders) {
      alert("You need to select at least one folder");
      return false;
    }

    PA.call_pj("content.update", obj, $('.question_note_view'),
      function(data) {
        data.is_tag_good = P.note_view.content.is_tag_good;
        data.default_anonymity = anon;
        PEM.fire("content", data);
    }, function(err) {setTimeout(function(){alert(err);}, 1000);});//anonymous

    $(".post_region_box.question_note_view").removeClass("edit_mode");
    PEM.fire('cancelOneForce', 'question_note_edit');

    return false;
  },
  validateTitle: function(title, $wrapper) {

    var isValid = true;

    if (title.length <= 0) {
      $wrapper.find(".error_message.long_summary").removeClass("show");
      $wrapper.find(".error_message.no_summary").addClass("show");
      isValid = false;
    } else if (title.length > 100) {
      $wrapper.find(".error_message.no_summary").removeClass('show');
      $wrapper.find(".error_message.long_summary").addClass("show");
      isValid = false;
    } else {
      $wrapper.find(".error_message.no_summary").removeClass('show');
      $wrapper.find(".error_message.long_summary").removeClass("show");
    }

    return isValid;
  },
  validateFolders: function($wrapper) {

    var isValid = true;

    if (P.note_view.network.config.disable_folders) return true;

    var cnt = $('#edit_quesiton_note_folders').find('.folder.selected').size();
    // for (var s in P.old_new_post.selectedFolders) cnt += 1;
    if (cnt == 0) {
      $wrapper.find(".error_message.no_folders").addClass("show");
      isValid = false;
    } else {
      $wrapper.find(".error_message.no_folders").removeClass("show");
    }

    return isValid;
  },
  validateDetails: function(text, $wrapper) {

    var isValid = true;

    if (text.length <= 0) {
      $wrapper.find('.error_message.no_details').addClass('show');
      isValid = false;
    } else {
      $wrapper.find(".error_message.no_details").removeClass("show");
    }

    return isValid;
  },

  reshowContent: function() {
    var pollChoice = $('.poll_button:checked').attr("id");
    $('#view_quesiton_note').html(P.note_view.questionTextTemplate({content:P.note_view.content, network:P.note_view.network}));
    if (pollChoice)
      $('#' + pollChoice).attr('checked', true);
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,$('.post_region_box.question_note_view')[0]]);
  },
  markAsDuplicate: function() {
    alert("dup");
  },
  reportSpam: function() {
    PA.call("content.report_spam", {cid:P.note_view.content.id}, null, function() {
      if (P.note_view.user.isInst)
        alert("Thanks, we've notified the Piazza Team. Feel free to delete or edit this post in the meanwhile. You can also disable history under the Actions menu so no one can see the question history.");
        //$('#report_spam_window2').jqmShow();
      else
        alert("Thanks, we have sent the report for a review to Piazza staff.");
        //$('#report_spam_window').jqmShow();
    });
  },
  deleteContent: function() {
    var params = {
      title: "Delete this content?",
      confirm: "Delete",
      cancel: "Cancel",
      callback: function() {
        PA.call_pj("content.delete", {cid:P.note_view.content.id}, null, function(data){
          PEM.fire("cleanDashboard");
          PEM.fire("showHomescreen");
        }, function(err) {setTimeout(function() {alert(err);}, 1000)});
      }
    }
    PEM.fire("showConfirmationWindow", params);
    return false;
  },
  deleteAttachment: function(id) {
    var params = {
      title: "Delete this attachment?",
      confirm: "Delete",
      cancel: "Cancel",
      callback: function() {
        PA.call_pj("content.delete", {cid:id}, null, function(data){
        }, function(err) {setTimeout(function() {alert(err);}, 1000)});
      }
    }
    PEM.fire("showConfirmationWindow", params);
    return false;
  },
  attachFile: function() {
    var params = {
      cid: P.note_view.content.id,
      uid: P.note_view.user.id,
      type: P.note_view.content.type,
      nid: P.note_view.network.id
    }
    P.modules.loadModule("attachments", {},
      function() {
        PEM.fire("show_upload_attachment", params);
      }, null);
  },
  pushContentMessage: function(message) {
    if (!P.note_view.content) return;
    if ((message.action == 'start_edit' || message.action == 'done_edit')) {
      setTimeout(function() {
        var sid = message.sid;
        if(sid != PA.user.sid) {
          // someone is starting/finishing to edit answer
          if (!P.note_view.content.q_edits) P.note_view.content.q_edits = [];
          if (!P.note_view.content.s_edits) P.note_view.content.s_edits = [];
          if (!P.note_view.content.i_edits) P.note_view.content.i_edits = [];
          var arr = P.note_view.content.q_edits;
          if (message.sub_action == 's_answer') arr = P.note_view.content.s_edits;
          if (message.sub_action == 'i_answer') arr = P.note_view.content.i_edits;
          if (message.action == 'start_edit') {
            arr.push(sid);
          } else {
            if (arr) {
              for (var i = 0; i < arr.length; i++)
                if (arr[i] == sid)
                  arr.splice(i, 1);
            }
          }
          P.note_view.showEditors();
          PEM.fire("update_editors");
        }
      }, 2000); // add 2 second delay in case push arrived before response to actual content.edit call
    }
    var newContent = message.content;
    if (!newContent) return;
    if (message.action == 'create' && newContent.type == 'attach' &&
      (message.parent_type == 'question' || message.parent_type == 'note' || message.parent_type == 'poll')) {
      // new attachment for question area
      var attachment = P.note_view.makeAttachmentObject(message.item);
      if (!P.note_view.content.attach)
        P.note_view.content.attach = [];
      P.note_view.content.attach.push(attachment);
      if (PTM.templates["attachment"]) {
        $('.question_note_view .attachments_list').append(PTM.templates["attachment"]({attach:attachment, content:P.note_view.content, network:P.note_view.network}));
        $('.question_note_view .attachments').show();
      }
    }
    if (newContent.type == 'question' || newContent.type == 'note' || newContent.type == 'poll') {
      for (var key in newContent) {
        if (key == "data") {
          if (P.note_view.content.data && P.note_view.content.data.has_voted)
            newContent.data.has_voted = P.note_view.content.data.has_voted;
        }
        P.note_view.content[key] = newContent[key];
      }
      P.note_view.prepareHistoryAndChildren(P.note_view.content);
      P.note_view.reshowContent();
    }
  },
  doGoodPost: function() {
    var feedbackType = "tag_good";
    var feedbackTypeArr = "tag_good_arr";
    if (!P.note_view.content[feedbackType]) P.note_view.content[feedbackType] = [];
    P.note_view.content[feedbackType].push({id:P.note_view.user.id, name:P.note_view.user.name});
    P.note_view.content[feedbackTypeArr].push(P.note_view.user.id);
    $(".post_action.do_good_note").hide();
    $(".post_action.undo_good_note").show();
    $(".post_actions_number.good_note").html(P.note_view.content[feedbackType].length);
    P.note_view.prepareEndorsementVars(P.note_view.content, 0);
    if (P.note_view.network.isGroup)
      $("#endorse_text").html(P.note_view.endorseTemplate({content: P.note_view.content}));
    else
      $("#endorse_text").html(P.note_view.endorseTemplateClass({content: P.note_view.content}));
    PA.call_pj('content.add_feedback', {cid:P.note_view.content.id, type:feedbackType}, 1);
  },
  undoGoodPost: function() {
    var feedbackType = "tag_good";
    var feedbackTypeArr = "tag_good_arr";
    if (P.note_view.content[feedbackType]) {
      for (var i = 0; i < P.note_view.content[feedbackType].length; i++) {
        if (P.note_view.content[feedbackType][i].id == P.note_view.user.id) {
          P.note_view.content[feedbackType].splice(i, 1);
          break;
        }
      }
    }
    if (P.note_view.content[feedbackTypeArr]) P.note_view.content[feedbackTypeArr].remove(P.note_view.user.id);
    $(".post_action.undo_good_note").hide();
    $(".post_action.do_good_note").show();
    var cnt = 0;
    if (P.note_view.content[feedbackType])
      cnt = P.note_view.content[feedbackType].length
    $(".post_actions_number.good_note").html(cnt);
    P.note_view.prepareEndorsementVars(P.note_view.content, 0);
    if (P.note_view.network.isGroup)
      $("#endorse_text").html(P.note_view.endorseTemplate({content: P.note_view.content}));
    else
      $("#endorse_text").html(P.note_view.endorseTemplateClass({content: P.note_view.content}));
    PA.call_pj('content.remove_feedback', {cid:P.note_view.content.id, type:feedbackType}, 1);
  },
  favorite: function(doFavorite) {
    var method = "content.mark_favorite";
    if (!doFavorite) method = "content.mark_unfavorite";

    PA.call_pj(method, {cid:P.note_view.content.id}, 1, function(data) {
      P.note_view.updateFavorite(doFavorite);
    });
  },
  updateFavorite: function(doFavorite) {
    if (!P.note_view.content) P.note_view.content = {};
    P.note_view.content.my_favorite = doFavorite;
    /* in case num_favorites wasn't initialized, we need to set it, or the user won't see updated number until full feed reload */
    if (P.note_view.content && !P.note_view.content.num_favorites && doFavorite) P.note_view.content.num_favorites = 0;

    if (doFavorite) {
      P.note_view.content.num_favorites++;
      $(".post_favorite").removeClass('is_not_favorite').addClass('is_favorite');
    } else {
      P.note_view.content.num_favorites--;
      $(".post_favorite").removeClass('is_favorite').addClass('is_not_favorite');
    }
    var numFavorites = 0;
    if (P.note_view.content.num_favorites > 0)
      numFavorites = P.note_view.content.num_favorites;
    $(".post_actions_number.favorites").html(numFavorites);

    PEM.fire("updateFavorite", P.note_view.content); /* This will reload the feed */
  },
  like: function() {
    if (!(P.note_view.content && P.note_view.content.id)) return false;
    $('#like_button_wrapper').hide();
    PA.call_pj("content.like", {cid:P.note_view.content.id}, 1);
    return false;
  },
  hideHistoryHighlight: function() {
    $('#view_quesiton_note').css("border", "none");
  },
  showHistory: function(history) {
    if (history.highlight == "question") {
      $('#view_quesiton_note').css("border-top","2px solid #0f0");
      $('#view_quesiton_note').css("border-bottom", "2px solid #0f0");
      $('.main_panel').scrollTo('#view_quesiton_note');
    } else {
      P.note_view.hideHistoryHighlight();
    }
    var content = P.note_view.content;
    if (!content.tag_good_arr_old)
      content.tag_good_arr_old = content.tag_good_arr;
    content.tag_good_arr = content.tag_good_arr_old.slice(0);
    for (var uid in history.tag_good)
      content.tag_good_arr.remove(uid);
    P.note_view.prepareHistoryAndChildren(P.note_view.content, history.q_idx);
    P.note_view.reshowContent();
  },
  ensureSyntaxHighlighting: function() {
    if (P.note_view.network.config && !P.note_view.network.config.disable_syntax && !is_ie) {
      $('.post_region_content').find('pre').addClass('prettyprint');
      prettyPrint();
      /* Avoid conflict with our own "tag" styles. */
      $('.prettyprint .tag').removeClass('tag').addClass('tag_code');
    }
    $('.others').tooltip({placement: 'bottom', html: true});
  },
  init: function(module) {
    PEM.addListener("content", P.note_view.setContent);
    PEM.addListener("network", P.note_view.setNetwork);
    PEM.addListener("question_note_edit", P.note_view.startEdit);
    PEM.addListener("question_note_convert_type", P.note_view.convertType);
    PEM.addListener("question_note_edit_submit", P.note_view.editSubmit);
    PEM.addListener("question_note_start_follow", P.note_view.startFollow);
    PEM.addListener("question_note_stop_follow", P.note_view.stopFollow);
    PEM.addListener("mark_as_duplicate", P.note_view.markAsDuplicate);
    PEM.addListener("report_spam", P.note_view.reportSpam);
    PEM.addListener("delete_content", P.note_view.deleteContent);
    PEM.addListener("attach_file", P.note_view.attachFile);
    PEM.addListener("do_good_post", P.note_view.doGoodPost);
    PEM.addListener("undo_good_post", P.note_view.undoGoodPost);
    PEM.addListener("like", P.note_view.like);
    PEM.addListener("favorite", P.note_view.favorite);
    PEM.addListener("pushContentMessage", P.note_view.pushContentMessage);

    PEM.addListener("deleteAttachment", P.note_view.deleteAttachment);
    PEM.addListener("toggleFollowFromFeed", P.note_view.toggleFollow);

    PEM.addListener("history", P.note_view.showHistory);
    PEM.addListener("hideHistoryHighlight", P.note_view.hideHistoryHighlight);
    PEM.addLastListener("content", P.note_view.ensureSyntaxHighlighting);

    PTM.getTemplate("question_note_view_text", function(template) {P.note_view.questionTextTemplate = template;});
    PTM.getTemplate("question_note_view_endorse_text", function(template) {P.note_view.endorseTemplate = template;});
    PTM.getTemplate("question_note_view_endorse_class", function(template) {P.note_view.endorseTemplateClass = template;});
    Handlebars.registerHelper('questionNoteText', function(content, network) {
      if (P.note_view.questionTextTemplate)
        return P.note_view.questionTextTemplate({content:content, network:network});
      return "";
    });
    Handlebars.registerHelper('endorseText', function(content) {
      if (P.note_view.endorseTemplate && P.note_view.network.isGroup)
        return P.note_view.endorseTemplate({content:content});
      if (P.note_view.endorseTemplateClass && !P.note_view.network.isGroup)
        return P.note_view.endorseTemplateClass({content:content});
      return "";
    });

    if (module.options.network)
      P.note_view.network = module.options.network;
  }

};

P.question_view = {
  content:null,
  network:null,
  user:null,
  dupeState: {},
  
  setUser: function(user) {
    P.question_view.user = user;
  },
  setNetwork: function(network) {
    P.question_view.network = network;
  },
  setContent: function(content) {
    if (!content) return;
    P.question_view.content = content;
    if (content.type == "question") {
      // this is my content! render it
      P.note_view.prepareHistoryAndChildren(content);
      P.question_view.prepareHistoryAndChildren(content);
      PTM.getTemplate("question_note_view", P.question_view.showContent);
    }
    if (content.type == "question" || content.type == "note") {
      if (P.question_view.dupeState.dupe_id) {
        $('#duplicate_reason').val(content.dupeMsg);
        if (P.question_view.dupeState.dupe_id != content.id) {
          P.question_view.dupeState.to_id = content.id;
          P.question_view.dupeState.to_subject = content.subject;
        }
        $('#mark_dupe_form').show();
        $('#duplicate_title').html("<b>" + P.question_view.dupeState.dupe_subject + "</b>");
        if (P.question_view.dupeState.to_subject) {
          $('#duplicate_of_title').html("<b>" + P.question_view.dupeState.to_subject + "</b>");
          $('#mark_duplicate').attr("disabled", false);
        }
      }
    }
  },
  showContent: function(template) {
    $('.post_region_box.question_note_view').replaceWith(template({
      content:P.question_view.content,
      network:P.question_view.network,
      user:P.question_view.user,
      anon: PEM.callFirst("getAnonymityOptions")
    }));
    P.note_view.initHandlers();
    P.note_view.visibilityChange();
    P.note_view.showEditors();
  },
  /*
   *  This is only question-specific stuff
   */
  prepareHistoryAndChildren: function(content) {
    if (content.children && content.children.length > 0) {
      var answers = [];
      for (var i = 0; i < content.children.length; i++) {
      }
      if (answers.length > 0)
        content.answers = answers;
    }
    content.isPoll = false;
    content.isNote = false;
    content.isQuestion = false;
    if (content.type == "poll") content.isPoll = true;
    if (content.type == "note") content.isNote = true;
    if (content.type == "question") content.isQuestion = true;
  },
  markDuplicate: function() {
    P.question_view.dupeState = {
      dupe_id:P.question_view.content.id,
      dupe_subject:P.question_view.content.subject
    };
    $('#mark_dupe_form').show();
    $('#duplicate_title').html("<b>" + P.question_view.content.subject + "</b>");

  },
  markDuplicateCancel: function() {
    $('#mark_dupe_form').hide();
    P.question_view.dupeState = {};
  },
  markDuplicateSubmit: function() {
    if (!P.question_view.dupeState.dupe_id || !P.question_view.dupeState.to_id)
      return;
    var params = {
      cid_dupe: P.question_view.dupeState.dupe_id,
      cid_to: P.question_view.dupeState.to_id,
      msg:$('#duplicate_reason').val()
    };
    PA.call_pj("content.duplicate", params, null, function(data) {
      P.question_view.markDuplicateCancel();
      PEM.fire("selectContent", P.question_view.content.id); //reload content
    }, alert);
  },
  setAnonymity: function(anon) {
    P.question_view.content.default_anonymity = anon;
  },
  init: function(module) {
    PEM.addListener("content", P.question_view.setContent);
    PEM.addListener("network", P.question_view.setNetwork);
    PEM.addListener("question_mark_duplicate", P.question_view.markDuplicate);
    PEM.addListener("setAnonymity", P.question_view.setAnonymity);
    PEM.addListener("question_mark_duplicate_cancel", P.question_view.markDuplicateCancel)
    PEM.addListener("question_mark_duplicate_submit", P.question_view.markDuplicateSubmit)
    if (module.options.network)
      P.question_view.network = module.options.network;
  }

};
P.poll_view = {
  content:null,
  network:null,
  user:null,
  initHandlers: function() {
    $(".post_region_arrow_dropdown").hover(
      function() {
        $(this).find(".dropdown-menu").show();
      }, function() {
        $(this).find(".dropdown-menu").hide();
      }
    );
    if (P.poll_view.content.config.unpublished == 0 || typeof(P.poll_view.content.config.unpublished) === 'undefined')
      $('.poll_button').attr("disabled", false);
    else
      $('.poll_button').attr("disabled", true);
    var isClosed = false;
    var openDate = new Date();
    openDate.setISO8601(P.poll_view.content.created);
    var openHours = Math.floor((new Date() - openDate) / (1000 * 60 * 60));
    var openMinutes = Math.floor((new Date() - openDate) / (1000 * 60));
    if (openMinutes < 0) openMinutes = 0;
    if (openHours < 0) openHours = 0;
    if (openHours >= parseInt(P.poll_view.content.config.close_after) && P.poll_view.content.config.always_open == 0) {
      isClosed = true;
    }
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,$('.post_region_box.question_note_view')[0]]);
    if (isClosed)
      $('.poll_button').attr("disabled", true);

  },
  setUser: function(user) {
    P.poll_view.user = user;
  },
  setNetwork: function(network) {
    P.poll_view.network = network;
  },
  setContent: function(content) {
    if (!content) return;
    if (content.type == "poll") {
      P.poll_view.content = content;
      P.note_view.prepareHistoryAndChildren(content);
      P.poll_view.preparePollAdmin();
      PTM.getTemplate("question_note_view", P.poll_view.showContent);
      P.poll_view.showPollChoices();
      if (P.question_view.dupeState.dupe_id) {
        if (P.question_view.dupeState.dupe_id != content.id) {
          P.question_view.dupeState.to_id = content.id;
          P.question_view.dupeState.to_subject = content.subject;
        }
        $('#mark_dupe_form').show();
        $('#duplicate_title').html("<b>" + P.question_view.dupeState.dupe_subject + "</b>");
        if (P.question_view.dupeState.to_subject) {
          $('#duplicate_of_title').html("<b>" + P.question_view.dupeState.to_subject + "</b>");
          $('#mark_duplicate').attr("disabled", false);
        }
      }
    }
  },
  showAdmin: function(template) {
    if (template)
      P.poll_view.adminTemplate = template;
    if (!P.poll_view.adminTemplate) return;
    $('#poll_admin').html(P.poll_view.adminTemplate({content: P.poll_view.content, toShow: P.poll_view.toShow}));
  },
  showContent: function(template) {
    $('.post_region_box.question_note_view').replaceWith(template({
      content:P.poll_view.content,
      network:P.poll_view.network,
      user:P.poll_view.user,
      anon: PEM.callFirst("getAnonymityOptions")
    }));
    P.poll_view.initHandlers();
    PTM.getModuleTemplate("poll_view", "poll_admin", P.poll_view.showAdmin);
  },
  /*
   *  This is only poll-specific stuff
   */
  preparePollAdmin: function() {
    var toShow = {
      poll_closed: false,
      poll_time: false,
      poll_published: false,
      is_instructor: P.stats.user.isInst,
      is_poll_admin: false,
      poll_unpublished: false,
      poll_toggle_visibility_on: true
    }

    var conf = P.poll_view.content.config;

    toShow.is_poll_admin = P.poll_view.content.change_log[0].uid === P.poll_view.user.id;

    toShow.poll_unpublished = conf.unpublished === 1 ? true : false;
    toShow.poll_toggle_visibility_on = (conf.toggle_visibility_on == 1 || typeof(conf.toggle_visibility_on) == 'undefined');;

    var openDate = new Date();
    openDate.setISO8601(P.poll_view.content.created);
    var openHours = Math.floor((new Date() - openDate) / (1000 * 60 * 60));
    var openMinutes = Math.floor((new Date() - openDate) / (1000 * 60));
    if (openMinutes < 0) openMinutes = 0;
    if (openHours < 0) openHours = 0;
    toShow.poll_time = openHours;
    if (openHours >= parseInt(conf.close_after) && conf.always_open == 0) {
      toShow.poll_closed = true;
    }

    P.poll_view.toShow = toShow;
  },

   downloadPollStats: function() {
    //console.log("trying to donwload poll stats... ");
    var day = new Date().format("mmm-dd");
    window.location.href = '/poll_statistics/' + P.stats.network.id + '/' + P.poll_view.content.id + '?day=' + day;
    
   },

  showPollChoices: function() {
    //P.poll_results.getItemsToShow();
    var content = P.poll_view.content;
    if (content.data && content.data.has_voted && content.data.has_voted.length > 0)
      P.poll_results.hasVoted = true;
    var conf = P.poll_view.content.config;
    var openDate = new Date();
    openDate.setISO8601(P.poll_view.content.created);
    var openHours = Math.floor((new Date() - openDate) / (1000 * 60 * 60));
    if (openHours < 0) openHours = 0;
    if (openHours >= parseInt(conf.close_after) && conf.always_open == 0) {
      $('.poll_button').attr("disabled", true);
    }

    if (content.data && content.data.has_voted && content.data.has_voted.length > 0) {
      for (var z = 0; z < content.data.has_voted.length; z++) {
        $('#poll_button' + content.data.has_voted[z]).attr('checked', true);
      }
      if (content.config.revote !== 1)
        $('.poll_button').attr("disabled", true);
    }

    var poll_anonymity = "";

    if (content.data && content.data.has_voted && content.data.has_voted.length > 0)
      poll_anonymity += "You have voted.<br>";
    else
      poll_anonymity += "You have <b>not yet</b> voted.<br>";
    


    if (content.config.revote) 
      poll_anonymity += "Revoting is <b>allowed</b>. Select your vote and click submit to register your vote.<br>";
    else
      poll_anonymity += "Revoting is <b>not allowed</b>. Select your vote and click submit to register your vote.<br>";

    if (content.config.anonymous == "yes")
      poll_anonymity += "Your name will <b>not be visible to anyone.</b>";
    if (content.config.anonymous == "stud")
      poll_anonymity += "Your name will be <b>visible to instructors but not students.</b>";
    if (content.config.anonymous == "no")
      poll_anonymity += "Your name will be <b>visible to everyone.</b>";


    $('#poll_anonymity_placeholder').html(poll_anonymity);
    
  },
  closePoll: function() {
    P.poll_view.toShow.poll_closed = true;
    var params = {
      cid: P.poll_view.content.id,
      action: "close"
    }
    PA.call_pj("content.update_poll", params, null, function() {
      PEM.fire("poll_close");
      P.poll_view.showAdmin();
      P.poll_view.showPollChoices();
      $('.poll_button').attr("disabled", true);
    });
  },
  reopenPoll: function() {
    P.poll_view.toShow.poll_closed = false;
    var params = {
      cid: P.poll_view.content.id,
      action: "reopen",
      always_open: "1"
    }
    PA.call_pj("content.update_poll", params, null, function() {
      PEM.fire("poll_reopen");
      P.poll_view.showAdmin();
      P.poll_view.showPollChoices();
      $('.poll_button').attr("disabled", false);

    });
  },
  publishPoll: function() {
    P.poll_view.toShow.poll_closed = false;
    P.poll_view.toShow.poll_published = true;
    P.poll_view.toShow.poll_unpublished = false;
    P.poll_view.content.config.unpublished = 0;
    P.poll_view.content.config.publish_later = 0;
    var params = {
      cid: P.poll_view.content.id,
      action: "publish"
    }
    PA.call_pj("content.update_poll", params, null, function() {
      PEM.fire("poll_publish");
      P.poll_view.showAdmin();
      P.poll_view.showPollChoices();
      $('.poll_button').attr("disabled", false);
      P.poll_results.toShow.poll_unpublished = false;


    });
  },
  doVote: function() {
    var arr = [];
    $('.poll_button').each( function (idx, item) {
      if ($(item).attr('checked')) {
        var id = $(item).attr("id").replace("poll_button", "");
        arr.push(id);
      }
    });
    if (arr.length == 0) {
      alert("Please make your selection");
      return;
    }
    PA.call_pj("content.vote", {cid:P.poll_view.content.id, votes:arr}, null, function(data) {
      P.poll_view.content.data = data;
      P.poll_view.showPollChoices();
      P.poll_view.preparePollAdmin();
      P.poll_results.hasVoted = true;
      P.poll_view.showAdmin();
      PEM.fire("vote");
    }, function(err) {
      alert(err);
    });
  },
  clonePoll: function() {
    P.modules.loadModule("old_new_post", {folders: P.feed.feedObj.tags.instructor}, function() {
      PEM.fire("clone_new_poll");
    }, null);
  },
  togglePollVisibility: function() {
    P.poll_view.toShow.poll_toggle_visibility_on = !P.poll_view.toShow.poll_toggle_visibility_on;
    if (typeof(P.poll_view.content.config.toggle_visibility_on) != 'undefined')
      P.poll_view.content.config.toggle_visibility_on = !P.poll_view.content.config.toggle_visibility_on;
    var params = {
      cid: P.poll_view.content.id,
      action: "toggle_visibility",
    }
    PA.call_pj("content.update_poll", params, null, function() {
      PEM.fire("poll_toggle_visibility");
      P.poll_view.showAdmin();
      P.poll_view.showPollChoices();
    });
  },
  pushContentMessage: function(message) {
    if (!P.poll_view.content) return;
    var newContent = message.content;
    if (!newContent) return;
    if (newContent.type == 'poll') {
      var pollChoice = $('.poll_button:checked').attr("id");
      $('#view_quesiton_note').html(P.note_view.questionTextTemplate({content:P.poll_view.content, network:P.poll_view.network}));
      if (pollChoice)
        $('#' + pollChoice).attr('checked', true);
      P.poll_view.showPollChoices();
      P.poll_view.preparePollAdmin();
      P.poll_view.showAdmin();
    }    
  },
  getHasVoted: function() {
    var params = {
      cid: P.poll_view.content.id,
    }
    PA.call_pj("content.has_voted", params, null, function(i) {
      P.poll_results.getItemsToShow();
      P.poll_results.hasVoted = i;
      P.poll_view.preparePollAdmin();
      P.poll_view.showAdmin();
    });
  },

  
  init: function(module) {
    PEM.addListener("content", P.poll_view.setContent);
    PEM.addListener("network", P.poll_view.setNetwork);
    PEM.addListener("close_poll", P.poll_view.closePoll);
    PEM.addListener("publish_poll", P.poll_view.publishPoll);
    PEM.addListener("reopen_poll", P.poll_view.reopenPoll);
    PEM.addListener("doVote", P.poll_view.doVote);
    PEM.addListener("download_poll_stats", P.poll_view.downloadPollStats);
    PEM.addListener("clone_poll", P.poll_view.clonePoll);
    PEM.addListener("toggle_poll_visibility", P.poll_view.togglePollVisibility);
    PEM.addListener("pushContentMessage", P.poll_view.pushContentMessage);
    if (module.options.network)
      P.poll_view.network = module.options.network;
  }

};

P.poll_results = {
  template: null,
  user: null,
  network: null,
  content: null,
  resultTemplate: null,
  hasVoted: false,

  initShowHideVoters: function() {
    $(".show_voters").click(function() {
      $(this).hide();
      $(this).siblings(".voters_list").show();
    });
    $(".hide_voters").click(function() {
      $(this).closest(".voters_list").hide();
      $(this).closest(".voters_list").siblings(".show_voters").show();
    });
  },

  setContent:function(content) {
    P.poll_results.content = content;
    if (P.poll_results.content && P.poll_results.content.subject) {      
      P.poll_results.content.subject = P.poll_results.content.subject.replace(/&amp;/g, "&");
      P.poll_results.content.subject = P.poll_results.content.subject.replace(/&quot;/g, "\"");
      P.poll_results.content.subject = P.poll_results.content.subject.replace(/&apos;/g, "'");
      P.poll_results.content.subject = P.poll_results.content.subject.replace(/&#39;/g, "'");
    }    
    if (!content) return;
    if (content.type == "poll") {
      var results = P.poll_results.getPollResults();
      var toShow = P.poll_results.getItemsToShow();

      $('#poll_results').html(P.poll_results.template({content: P.poll_results.content, results: results, toShow: toShow}));
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,$('#poll_results')[0]]);
      P.poll_results.initShowHideVoters();
      //P.poll_results.showPollMessage();
      P.poll_results.hasVoted = P.poll_results.content.data && P.poll_results.content.data.has_voted && P.poll_results.content.data.has_voted.length > 0 ? true : false;
    } else {
      $('#poll_results').html("");
    }
  },
  setNetwork:function(network) {
    P.poll_results.network = network;
  },
  pushContentMessage:function(message) {
    if (!P.poll_results.content) return;
    if (message.action == "vote_result" && message.data) {
      if (P.poll_results.content.data && P.poll_results.content.data.has_voted)
        message.data.has_voted = P.poll_results.content.data.has_voted;
      P.poll_results.content.data = message.data;
      P.poll_results.setContent(P.poll_results.content);
      return;
    }
    var newContent = message.content;
    if (!newContent) return;
    if (newContent.type == 'poll') {
      P.note_view.prepareHistoryAndChildren(newContent);
      // this basically is a whole new updated poll object
      P.poll_results.setContent(newContent);
    }
  },
  getItemsToShow: function() {
    var toShow = {
      poll_submitted: false,
      poll_closed: false,
      poll_not_submitted: false,
      poll_will_close: false,
      poll_not_closed: false,
      poll_closes_in: false,
      poll_time: false,
      poll_only_instructors: false,
      poll_show_results: true,
      poll_no_data: false,
      poll_reopened: false,
      poll_published: false,
      is_instructor: P.stats.user.isInst,
      is_poll_admin: false,
      poll_unpublished: false,
    }

    if (P.poll_results.content.data && P.poll_results.content.data.has_voted && P.poll_results.content.data.has_voted.length > 0 || P.poll_results.hasVoted)
      toShow.poll_submitted = true;

    var conf = P.poll_results.content.config;
    toShow.poll_unpublished = P.poll_results.content.config.unpublished === 1 ? true : false;
    toShow.poll_toggle_visibility_on = (conf.toggle_visibility_on == 1 || typeof(conf.toggle_visibility_on) == 'undefined');
    var isClosed = false;
    var dontShowNoData = false;
    var openDate = new Date();
    openDate.setISO8601(P.poll_results.content.created);
    var openHours = Math.floor((new Date() - openDate) / (1000 * 60 * 60));
    var openMinutes = Math.floor((new Date() - openDate) / (1000 * 60));
    if (openMinutes < 0) openMinutes = 0;
    if (openHours < 0) openHours = 0;
    toShow.poll_time = openHours;

    if (openHours >= parseInt(conf.close_after) && conf.always_open == 0) {
      isClosed = true;
      toShow.poll_closed = true;
    }
    if (!isClosed && conf.always_open == 0) {
      var closesAfter = parseInt(conf.close_after) - openHours;
      var closesAfterMin = parseInt(conf.close_after) * 60 - openMinutes;
      if (closesAfterMin < 60)
        toShow.poll_closes_in = (closesAfterMin > 0 ? closesAfterMin : 1) + " minutes"
      else {
        toShow.poll_closes_in = closesAfter + " hours"
        if (closesAfter > 24)
          toShow.poll_closes_in = Math.floor(closesAfter / 24) + " day(s)"
      }
      toShow.poll_will_close = true
    }
    //if (!P.poll_results.user.isInst) {
      if (P.poll_results.content.data.has_voted && P.poll_results.content.data.has_voted.length > 0) P.poll_results.hasVoted = true;
      if (!P.poll_results.hasVoted && conf.show_results == "av" && !isClosed) {
        toShow.poll_not_submitted = true;
        dontShowNoData = true;
      }
      if (conf.show_results == "ac" && !isClosed && conf.always_open == 0) {
        toShow.poll_not_closed = true;
        toShow.poll_will_close = false;
        toShow.poll_no_data = false;
        dontShowNoData = true;
      }
    //}
    var res = P.poll_results.content.data.result;
    if (!res) res = [];
    var totalVotes = 0;
    if (P.poll_results.content.data.total_votes)
      totalVotes = P.poll_results.content.data.total_votes;
    if (totalVotes == 0) {
      toShow.poll_show_results = false;
      if (conf.show_results == "nn")
        toShow.poll_only_instructors = true;
      else {
        if (!dontShowNoData) {
          toShow.poll_no_data = true;
        }
      }
    } else {
      if (dontShowNoData) {
        toShow.poll_show_results = false;
        return toShow;
      }
      toShow.poll_show_results = true;
      toShow.poll_not_submitted = false;
    }

    return toShow;

      },
  getPollResults: function() {
    var results = [];
    var text = P.poll_results.content.body;
    var allToReplace = text.match(/\[[o*]] /g);
    var options = [];
    if (allToReplace) {
      for (var i = 0; i < allToReplace.length; i++) {
        var toReplace = allToReplace[i];
        var at = text.indexOf(toReplace);
        var enter = text.indexOf("\n", at);
        var enter2 = text.indexOf("<br", at);
        var enter3 = text.indexOf("</p>", at);
        if (enter < 0 || (enter2 > 0 && enter2 < enter)) enter = enter2;
        if (enter < 0 || (enter3 > 0 && enter3 < enter)) enter = enter3;
        if (enter < 0) enter = text.length;
        var label = text.substr(at + 4, (enter - at - 4));
        var goodLabel = label.replace(/<[^>]*>/g, "");
        options.push(goodLabel);
        var before = text.substr(0, at + 4);
        var after = text.substr(enter);
        text = before + goodLabel + after;
        text = text.replace(toReplace, "");
      }
    }
    if (options.length > 0) {
      var content = P.poll_results.content;
      var totalVotes = content.data.total_votes;
      for (var i = 0; i < options.length; i++) {
        var votes = 0;
        var percent = 0;
        var showVoters = false;
        var voters = [];
        if (content.data.result && content.data.result[i]) {
          if (typeof(content.data.result[i]) == "number")
            votes = content.data.result[i];
          if (typeof(content.data.result[i].length) != "undefined") {
            showVoters = true;
            votes = content.data.result[i].length;
            for (var j = 0; j < content.data.result[i].length; j++) {
              voters.push(PA.getUserName(content.data.result[i][j]));
            }
          }
        }
        if (votes > totalVotes)
          votes = totalVotes;
        if (totalVotes)
          percent = Math.round(votes * 100 / totalVotes);
        var result = {
          percent: percent,
          votes: votes,
          option: options[i],
          showVoters: showVoters,
          voters: voters
        }
        results.push(result);
      }
    }
    return results;
  },
  vote: function() {
    P.poll_results.hasVoted = true;
    P.poll_results.setContent(P.poll_results.content);
  },
  poll_close: function() {
    P.poll_results.toShow = P.poll_results.getItemsToShow();
    P.poll_results.toShow.poll_closed = true;
    P.poll_results.toShow.poll_closes_in = false;
    P.poll_results.toShow.poll_will_close = false;
    var results = P.poll_results.getPollResults();
    $('#poll_results').html(P.poll_results.template({content: P.poll_results.content, results: results, toShow: P.poll_results.toShow}));


  },
  poll_reopen: function() {
    P.poll_results.toShow = P.poll_results.getItemsToShow();
    P.poll_results.toShow.poll_closed = false;
    var results = P.poll_results.getPollResults();
    $('#poll_results').html(P.poll_results.template({content: P.poll_results.content, results: results, toShow: P.poll_results.toShow}));

  },
  poll_publish: function() {
    P.poll_results.toShow = P.poll_results.getItemsToShow();
    P.poll_results.toShow.poll_closed = false;
    P.poll_results.toShow.poll_published = true;
    P.poll_results.toShow.poll_unpublished = false;
    P.poll_results.content.config.unpublished = 0;
    P.poll_results.content.config.publish_later = 0;
    $(".main_panel").removeClass("private_post");
    $(".post_region_message").remove();
    var results = P.poll_results.getPollResults();
    $('#poll_results').html(P.poll_results.template({content: P.poll_results.content, results: results, toShow: P.poll_results.toShow}));

  },
  poll_toggle_visibility: function() {
    P.poll_results.toShow = P.poll_results.getItemsToShow();
    var results = P.poll_results.getPollResults();
    $('#poll_results').html(P.poll_results.template({content: P.poll_results.content, results: results, toShow: P.poll_results.toShow}));
  },
  init: function(module) {
    P.poll_results.template = module.template;

    PEM.addListener("content", P.poll_results.setContent);
    PEM.addListener("network", P.poll_results.setNetwork);
    PEM.addListener("pushContentMessage", P.poll_results.pushContentMessage);
    PEM.addListener("vote", P.poll_results.vote);
    PEM.addListener("poll_close", P.poll_results.poll_close);
    PEM.addListener("poll_reopen", P.poll_results.poll_reopen);
    PEM.addListener("poll_publish", P.poll_results.poll_publish);
    PEM.addListener("poll_toggle_visibility", P.poll_results.poll_toggle_visibility);
    PTM.getModuleTemplate("poll_results", "result", function(template) {P.poll_results.resultTemplate = template;});

    Handlebars.registerHelper('pollResult', function(result) {
      if (P.poll_results.resultTemplate)
        return P.poll_results.resultTemplate({result: result});
      return "";
    });

    if (module.options.network)
      P.poll_results.network = module.options.network;
    if (module.options.user)
      P.poll_results.user = module.options.user;
  }
};

P.answer = {
  template: null,
  network: null,
  content: null,
  user: null,
  answers: {},
  answerTextTemplate: null,
  editRevision: {},

  initEventHandlers: function() {
    $(".post_region_box.answer .post_action.edit").click(function() {
      if (P.answer.user.isPublic) {
        alert("You cannot edit this answer");
        return;
      }
      P.answer.startEdit(this);
      return false;
    });
    $(".post_region_box.answer .post_action.cancel").click(function(){
      //var top = $(this).closest('.post_region_box.answer');
      //P.answer.stopEdit(top);
      var id = $(this).closest(".post_region_box").attr("id");
      PEM.fire("cancelOne", "answer_" + id);
      return false;
    });
    $(".post_region_box.answer .post_action.submit").click(function(){
      var top = $(this).closest('.post_region_box.answer');
      P.answer.editSubmit(top);
      return false;
    });
    $(".post_region_box.answer .compose_mode").click(function() {
      if (P.answer.user.isPublic) {
        alert("You cannot edit this answer");
        return;
      }
      $(this).hide();
      P.answer.startEdit(this);
      //P.answer.startAnswer(this);
      return false;
    });
    $(".post_action.do_good_answer").click(function() {
      var id = $(this).closest(".post_region_box").attr("id");
      P.answer.doGoodAnswer(id);
      return false;
    });
    $(".post_action.undo_good_answer").click(function() {
      var id = $(this).closest(".post_region_box").attr("id");
      P.answer.undoGoodAnswer(id);
      return false;
    });
    $("#answer_actions_dropdown li").click(function() {
      $(this).closest('.general_dropdown').hide();
      var type = $(this).closest(".post_region_box").attr("id");
      if ($(this).hasClass("attach"))
        P.answer.addAttachment(type);
      else if ($(this).hasClass("report_spam"))
        P.answer.reportSpam();
      return false;
    });
    $(".post_region_arrow_dropdown").hover(
      function() {
        $(this).find(".dropdown-menu").show();
      }, function() {
        $(this).find(".dropdown-menu").hide();
      }
    );
    $('.post_region_box.answer .others').tooltip({placement: 'bottom', html: true});
  },

  setNetwork: function(network) {
    P.answer.network = network;
  },
  setUser: function(user) {
    P.answer.user = user;
  },
  setContent: function(content) {
    P.answer.content = content;
    if (!content) return;
    P.answer.answers = {};
    if (content.type == "question") {
      P.answer.answers = {s_answer:{body:"", type:"s_answer", title:"wiki answer", long:"collectively construct a single answer", icon:"member_answer", showEdit:true}};
      if (P.answer.network.type != "group")
        P.answer.answers = {s_answer:{body:"", type:"s_answer", icon:"s_answer", title:"the students' answer", long:"where students collectively construct a single answer", showEdit:true, showSuper:(P.answer.user.isInst > 0)},
                            i_answer:{body:"", type:"i_answer", icon:"i_answer", title:"the instructors' answer", long:"where instructors collectively construct a single answer", showEdit:P.answer.user.isInst}};
      for (var i = 0; i < content.children.length; i++) {
        if (content.children[i].type == 's_answer' || content.children[i].type == 'i_answer') {
          P.answer.prepareAnswer(content.children[i]);
        }
      }
      P.answer.showCurrentAnswer();
    } else {
      $('#member_answer').html("");
      $('#instructor_answer').html("");
    }
    //P.member_answer.initHandlers();
  },
  prepareAnswer: function(answer, historyIdx) {
    historyIdx = historyIdx || 0;
    if (answer.history) {
      answer.history.sort(function(a,b){
        if (a.created > b.created) return -1;
        if (a.created < b.created) return 1;
        return 0;
      })
      answer.body = answer.history[historyIdx].content;
      if (answer.data && answer.data.embed_links) {
        for (var i = 0; i < answer.data.embed_links.length; i++) {
          var link = answer.data.embed_links[i][0];
          var html = answer.data.embed_links[i][1];
          // support up to two repeat occurrences of the same link (replaceAll requires using a regex,
          // which requires escaping metacharacters)
          answer.body = answer.body.replace(link, html).replace(link, html);
        }
      }
      answer.uid = answer.history[historyIdx].uid;
      answer.anon = answer.history[historyIdx].anon;
      answer.updated = answer.history[historyIdx].created;
      var others = {};
      for (var i = 1; i < answer.history.length; i++)
        if (answer.uid != answer.history[i].uid)
          others[answer.history[i].uid] = 1;
      var othersArr = [];
      for (var id in others)
        othersArr.push(id);
      answer.others = othersArr;
    }
    if (answer.children && answer.children.length > 0) {
      var attach = [];
      for (var i = 0; i < answer.children.length; i++) {
        if (answer.children[i].type == "attach") {
          var attachment = P.note_view.makeAttachmentObject(answer.children[i]);
          attach.push(attachment);
        }
      }
      if (attach.length > 0)
        answer.attach = attach;
    }
    P.answer.prepareEndorsementVars(answer, historyIdx);
    answer.showType = "answer";
    if (P.answer.answers[answer.type]) {
      answer.title = P.answer.answers[answer.type].title;
      answer.icon = P.answer.answers[answer.type].icon;
      answer.long = P.answer.answers[answer.type].long;
      answer.showEdit = P.answer.answers[answer.type].showEdit;
      answer.showSuper = P.answer.answers[answer.type].showSuper;
    }
    P.answer.answers[answer.type] = answer;
  },
  prepareEndorsementVars: function(answer, historyIdx) {
    answer.endorseOne = null;
    answer.endorseTwo = null;
    answer.endorseArr = null;
    answer.endorseCnt = 0;
    if (historyIdx > 0) return;
    if (answer.tag_endorse_arr && answer.tag_endorse_arr.length > 0) {
      answer.endorseCnt = answer.tag_endorse_arr.length;
      answer.endorseOne = answer.tag_endorse_arr[0];
      if (answer.tag_endorse_arr.length == 2) {
        answer.endorseTwo = answer.tag_endorse_arr[1];
      }
      else {
        answer.endorseArr = answer.tag_endorse_arr.slice(1, answer.tag_endorse_arr.length);
      }
      // special handling for class
      if (!P.answer.network.isGroup) {
        answer.isAnswer = true;
        answer.endorseOne = false;
        for (var i = 0; i < answer.tag_endorse_arr.length; i++) {
          if (P.answer.network.prof_hash[answer.tag_endorse_arr[i]]) {
            answer.endorseOne = answer.tag_endorse_arr[i];
            break;
          }
        }
      }
    }
  },
  doGoodAnswer: function(type) {
    var feedbackType = "tag_endorse";
    var feedbackTypeArr = "tag_endorse_arr";
    if (!P.answer.answers[type][feedbackType]) P.answer.answers[type][feedbackType] = [];
    P.answer.answers[type][feedbackType].push({id:P.answer.user.id, name:P.answer.user.name});
    P.answer.answers[type][feedbackTypeArr].push(P.answer.user.id);
    $("#" + type + " .post_action.do_good_answer").hide();
    $("#" + type + " .post_action.undo_good_answer").show();
    $("#" + type + " .post_actions_number.good_answer").html(P.answer.answers[type][feedbackType].length);
    PA.call_pj('content.add_feedback', {cid:P.answer.answers[type].id, type:feedbackType}, 1);
    P.answer.prepareEndorsementVars(P.answer.answers[type], 0);
    if (P.note_view.network.isGroup)
      $("#endorse_text_" + P.answer.answers[type].type).html(P.note_view.endorseTemplate({content: P.answer.answers[type]}));
    else
      $("#endorse_text_" + P.answer.answers[type].type).html(P.note_view.endorseTemplateClass({content: P.answer.answers[type]}));
  },
  undoGoodAnswer: function(type) {
    var feedbackType = "tag_endorse";
    var feedbackTypeArr = "tag_endorse_arr";
    if (P.answer.answers[type][feedbackType]) {
      for (var i = 0; i < P.answer.answers[type][feedbackType].length; i++) {
        if (P.answer.answers[type][feedbackType][i].id == P.answer.user.id) {
          P.answer.answers[type][feedbackType].splice(i, 1);
          break;
        }
      }
    }
    if (P.answer.answers[type][feedbackTypeArr]) P.answer.answers[type][feedbackTypeArr].remove(P.answer.user.id);
    $(".post_action.undo_good_answer").hide();
    $(".post_action.do_good_answer").show();
    $(".post_actions_number.good_answer").html(P.answer.answers[type][feedbackType].length);
    PA.call_pj('content.remove_feedback', {cid:P.answer.answers[type].id, type:feedbackType}, 1);
    P.answer.prepareEndorsementVars(P.answer.answers[type], 0);
    if (P.note_view.network.isGroup)
      $("#endorse_text_" + P.answer.answers[type].type).html(P.note_view.endorseTemplate({content: P.answer.answers[type]}));
    else
      $("#endorse_text_" + P.answer.answers[type].type).html(P.note_view.endorseTemplateClass({content: P.answer.answers[type]}));
  },
  showCurrentAnswer: function() {
    var endorsed = false;
    if (P.answer.answers["s_answer"].updated) {
      $('#member_answer .compose_mode').hide();
      for (var i = 0; i < P.answer.answers["s_answer"].tag_endorse_arr.length; i++) {
        if (P.answer.answers["s_answer"].tag_endorse_arr[i] == P.answer.user.id)
          endorsed = true;
      }
    }
    var params = {
      content:P.answer.content,
      network:P.answer.network,
      user:P.answer.user,
      answer: P.answer.answers["s_answer"],
      endorsed: endorsed,
      anon: PEM.callFirst("getAnonymityOptions")
    };
    if (P.answer.network.type == "group" || !P.answer.user.isInst || P.answer.answers["s_answer"].updated) {
      $('#member_answer').html(P.answer.template(params));
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,'member_answer']);
    } else
      $('#member_answer').html("");
    if (P.answer.network.type != "group") {
      endorsed = false;
      if (P.answer.answers["i_answer"].updated) {
        $('#instructor_answer .compose_mode').hide();
        for (var i = 0; i < P.answer.answers["i_answer"].tag_endorse_arr.length; i++) {
          if (P.answer.answers["i_answer"].tag_endorse_arr[i] == P.answer.user.id)
            endorsed = true;
        }
      }
      var params = {
        content:P.answer.content,
        network:P.answer.network,
        user:P.answer.user,
        answer: P.answer.answers["i_answer"],
        endorsed: endorsed
      };
      if (P.answer.answers["i_answer"].updated || P.answer.user.isInst) {
        $('#instructor_answer').html(P.answer.template(params));
        MathJax.Hub.Queue(["Typeset",MathJax.Hub,'instructor_answer']);
      } else
        $('#instructor_answer').html("");
    }
    P.answer.initEventHandlers();
    P.answer.updateEditors();
  },
  updateEditors: function() {
    P.answer.showEditors($('#member_answer .answer'));
    if (P.answer.network.type != "group") {
      P.answer.showEditors($('#instructor_answer .answer'));
    }
  },
  showEditors: function(top) {
    var type = top.attr("id");
    var edits = [];
    if (type == "s_answer") edits = P.answer.content.s_edits;
    if (type == "i_answer") edits = P.answer.content.i_edits;
    if (!edits) edits = [];
    var elem = top.find('.currently_editing');
    if (edits.length == 0) {
      elem.hide();
      return;
    }
    elem.find('.editing_message').html(
      '&#8764; ' + edits.length + ' other user' + (edits.length > 1 ? 's are' : ' is') + ' editing this right now. &#8764;'
    );
    elem.show();
  },
  startEdit: function(element) {
    var top = $(element).closest('.post_region_box.answer');
    var type = top.attr("id");
    top.find('.post_region_content.edit_mode').show();
    top.find('.post_region_actions.edit_mode').show();
    top.find('.post_region_content.view_mode').hide();
    top.find('.post_region_actions.view_mode').hide();
    top.addClass("edit_mode");
    if (P.answer.answers[type] && P.answer.answers[type].history)
      P.answer.editRevision[type] = P.answer.answers[type].history.length;
    else
      P.answer.editRevision[type] = 0;
    PEM.fire("injectEditor", {
      anonymity: P.answer.content.default_anonymity,
      where: top.find(".answer_edit_wrapper"),
      postfix: "answer_" + P.answer.answers[type].type,
      text: P.answer.answers[type].body,
      save: P.answer.editSubmit,
      cancel: function(){P.answer.stopEdit(top)},
      height: 150,
      noSave: true
    });
    PA.call_pj("content.edit", {cid: P.answer.content.id, type: type}, 1, function(sid) { PA.user.sid = sid; });
    return false;
  },
  stopEdit: function(top) {
    var type = top.attr("id");
    top.find('.post_region_content.edit_mode').hide();
    top.find('.post_region_actions.edit_mode').hide();
    top.find('.post_region_content.view_mode').show();
    top.find('.post_region_actions.view_mode').show();
    P.answer.showCurrentAnswer();
    top.removeClass("edit_mode");
    PA.call_pj("content.cancel_edit", {cid:P.answer.content.id, nid:P.answer.network.id}, 1);
    if (!P.answer.answers[type].updated)
      top.find('.compose_mode').show();
    return false;
  },
  mergeConflict: function(myText, top) {
    var type = top.attr("id");
    P.answer.mergeEditorTop = top;
    P.answer.editRevision[type] = P.answer.answers[type].history.length;
    PEM.fire("showConflict", {
      myText: myText,
      otherText: P.answer.answers[type].history[0].content,
      submit: function(text) {
        P.answer.editSubmit(P.answer.mergeEditorTop, text);
      },
      cancel: function() {
        PEM.fire('cancelOneForce', 'answer_' + P.answer.answers[type].type);
      }
    });
  },
  editSubmit: function(top, overrideText) {
    var type = top.attr("id");
    var text = PEM.callFirst("getEditorText", "answer_" + type);
    if (overrideText)
      text = overrideText;
    var latestRevision = 0;
    if (P.answer.answers[type] && P.answer.answers[type].history)
      latestRevision = P.answer.answers[type].history.length;
    if (P.answer.editRevision[type] < latestRevision) {
      // show merge conflict
      P.answer.mergeConflict(text, top);
      return false;
    }
    var anon = top.find(".anonymity_selector").val();
    if (!anon) anon = "no";
    var params = {
      content: text,
      type: type,
      cid: P.answer.content.id,
      revision: P.answer.editRevision[type],
      anonymous: anon
    };
    P.answer.submitAnswer(params, top);
    top.removeClass("edit_mode");
    return false;
  },
  submitAnswer: function(params, top) {
    var myTop = top;
    var type = top.attr("id");
    PA.call_pj("content.answer", params, $('#page_center'),
      function(data) {
        PEM.fire('cancelOneForce', "answer_" + params.type);
        if (data.bad) {
          P.answer.answers[type] = data.bad;
          P.answer.mergeConflict(params.content, myTop);
        }
        P.answer.prepareAnswer(data);
        P.answer.showCurrentAnswer();
        PEM.fire("setAnonymity", params.anonymous);
    }, function(err) {setTimeout(function(){alert(err);}, 1000);});//anonymous
  },
  updateCurrentAnswer: function(top, answer) {
    top.find('.post_region_content.view_mode').html(P.answer.answerTextTemplate({answer:answer, network:P.answer.network}));
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,top.find('.post_region_content.view_mode')[0]]);
  },
  pushContentMessage: function(message) {
    if (!P.answer.content) return;
    var newContent = message.content;
    if (!newContent) return;
    if (message.action == 'create' && newContent.type == 'attach' && message.parent_type == 's_answer') {
      // new attachment for answer
    }
    if (newContent.type == 's_answer' || newContent.type == 'i_answer') {
      // this basically is a whole new updated answer object
      P.answer.content.no_answer = false;
      if (!P.answer.answers[newContent.type]) {
        if (!P.answer.content.children)
          P.answer.content.children = [];
        P.answer.content.children.push(newContent);
        P.answer.answers[newContent.type] = newContent;
        P.answer.prepareAnswer(newContent);
        P.answer.showCurrentAnswer();
        return;
      }
      P.answer.prepareAnswer(newContent);
      // update text, but keep edit window open if needed
      P.answer.updateCurrentAnswer($('#' + newContent.type), newContent);
    }
  },
  addAttachment: function(type) {
    var params = {
      cid: P.answer.answers[type].id,
      uid: P.answer.user.id,
      type: "answer",
      nid: P.answer.network.id
    }
    P.modules.loadModule("attachments", {},
      function() {
        PEM.fire("show_upload_attachment", params);
      }, null);
  },
  reportSpam: function() {
    PA.call("content.report_spam", {cid:P.answer.answers["s_answer"].id}, null, function() {
      if (P.answer.user.isInst)
        alert("Thanks, we've notified the Piazza Team. Feel free to delete or edit this post in the meanwhile. You can also disable history under the Actions menu so no one can see the question history.");
        //$('#report_spam_window2').jqmShow();
      else
        alert("Thanks, we have sent the report for a review to Piazza staff.");
        //$('#report_spam_window').jqmShow();
    });
  },
  hideHistoryHighlight: function() {
    $('#s_answer .post_region_content').css("border", "none");
    $('#i_answer .post_region_content').css("border", "none");
  },
  showHistory: function(history) {
    P.answer.hideHistoryHighlight();
    if (history.highlight == "s_answer" || history.highlight == "i_answer") {
      $('#' + history.highlight + ' .post_region_content').css("border-top","2px solid #0f0");
      $('#' + history.highlight + ' .post_region_content').css("border-bottom", "2px solid #0f0");
      $('.main_panel').scrollTo('#' + history.highlight + ' .post_region_content');
    }
    if (P.answer.answers.s_answer && P.answer.answers.s_answer.history) {
      // save old endorsement array
      var s_answer = P.answer.answers.s_answer;
      if (!s_answer.tag_endorse_arr_old)
        s_answer.tag_endorse_arr_old = s_answer.tag_endorse_arr;
      s_answer.tag_endorse_arr = s_answer.tag_endorse_arr_old.slice(0);
      for (var uid in history.tag_endorse_s)
        s_answer.tag_endorse_arr.remove(uid);
      if (history.sa_idx >= s_answer.history.length) {
        $('#s_answer').hide();
      } else {
        $('#s_answer').show();
        P.answer.prepareAnswer(s_answer, history.sa_idx);
        P.answer.updateCurrentAnswer($('#s_answer'), s_answer);
      }
    }
    if (P.answer.answers.i_answer && P.answer.answers.i_answer.history) {
      var i_answer = P.answer.answers.i_answer;
      if (!i_answer.tag_endorse_arr_old)
        i_answer.tag_endorse_arr_old = i_answer.tag_endorse_arr;
      i_answer.tag_endorse_arr = i_answer.tag_endorse_arr_old.slice(0);
      for (var uid in history.tag_endorse_i)
        i_answer.tag_endorse_arr.remove(uid);
      if (history.ia_idx >= i_answer.history.length) {
        $('#i_answer').hide();
      } else {
        P.answer.prepareAnswer(i_answer, history.ia_idx);
        P.answer.updateCurrentAnswer($('#i_answer'), i_answer);
        $('#i_answer').show();
      }
    }
  },
  init: function(module) {
    P.answer.template = module.template;

    PEM.addListener("content", P.answer.setContent);
    PEM.addListener("network", P.answer.setNetwork);
    PEM.addListener("pushContentMessage", P.answer.pushContentMessage);
    PEM.addListener("history", P.answer.showHistory);
    PEM.addListener("hideHistoryHighlight", P.answer.hideHistoryHighlight);
    PEM.addListener("update_editors", P.answer.updateEditors);
    PTM.getModuleTemplate("answer", "answer_text", function(template) {P.answer.answerTextTemplate = template;});
    Handlebars.registerHelper('answerText', function(element, network) {
      if (P.answer.answerTextTemplate)
        return P.answer.answerTextTemplate({answer:element, network:network});
      return "";
    });

    if (module.options.network)
      P.answer.network = module.options.network;
    if (module.options.user)
      P.answer.user = module.options.user;
  }
};
P.conflict = {

  cancelCallback: null,
  submitCallback: null,

  initHandlers: function() {
  },
  submit: function() {
    if (P.conflict.submitCallback)
      P.conflict.submitCallback.call(window, $('#conflictServerResponse').val());
  },
  cancel: function() {
    if (P.conflict.cancelCallback)
      P.conflict.cancelCallback.call(window);
  },
  showConflict: function(params) {
    $('#concurrency_conflict_dialog').jqmShow();
    $('#conflictServerResponse').val(params.otherText);
    $('#conflictMyResponse').val(params.myText);
    $('#conflictServerResponse').focus();
    P.conflict.submitCallback = params.submit;
    P.conflict.cancelCallback = params.cancel;
    return false;
  },

  init: function(module) {
    $("body").append(module.template());
    $('#concurrency_conflict_dialog').jqm();
    P.conflict.initHandlers()

    PEM.addListener("showConflict", P.conflict.showConflict);
  }

};

P.clarifying_discussion = {
  template: null,
  network: null,
  content: null,
  user: null,
  messageTemplate: null,
  replyTemplate: null,
  followups: {},
  replies: {},
  followupsSort: [],
  repliesSort: [],

  initHandlers: function() {
    $('#create_new_followup').unbind().click(function(){
      if (P.answer.user.isPublic) {
        alert("You cannot do that");
        return;
      }
      $(this).hide();
      $('#create_new_followup_div').show();
      PEM.fire("injectEditor", {
        where: $("#create_new_followup_editor"),
        postfix: "new_followup",
        text: "",
        anonymity: P.clarifying_discussion.content.default_anonymity,
        save: function(text, anon) {
          return P.clarifying_discussion.postFollowup(text, anon);
        },
        cancel: function(){
          $('#create_new_followup_div').hide();
          $('#create_new_followup').show();
        },
        height: 120,
        saveText: "post"
      });
      return false;
    });
    $('.clarifying_discussion_dropdown').unbind().click(function(event){
      var top = $(this).closest('.clarifying_discussion');
      return openDropdown(top.find('.discussion_dropdown')[0], event);
    });
    $('.discussion_action.delete_reply').unbind().click(function(){
      var id = $(this).closest('.existing_reply').attr('id');
      P.clarifying_discussion.deleteItem(id, "comment");
      return false;
    });
    $('.clarifying_discussion .edit_reply').unbind().click(function(){
      if (P.answer.user.isPublic) {
        alert("You cannot do that");
        return;
      }
      var top = $(this).closest('.existing_reply');
      var id = top.attr("id");
      var parentId = top.closest('.clarifying_discussion').attr("id");
      top.find('.discussion_content').hide();
      var editWrapper = top.find('#reply_edit_' + id);
      editWrapper.show();
      top.addClass("edit_mode");
      PEM.fire("injectEditor", {
        where: editWrapper,
        postfix: "edit_followup_reply_" + id,
        text: P.clarifying_discussion.replies[id].subject,
        anonymity: P.clarifying_discussion.content.default_anonymity,
        save: function(text) {
          P.clarifying_discussion.reShowFollowup(parentId);
          PA.call_pj("content.update", {cid:id, subject: text}, $('#clarifying_discussion'), function(data){
            top.find('.discussion_content').show();
            top.find('#reply_edit_' + id).hide();
            var f = P.clarifying_discussion.replies[id];
            if (f) {
              f.subject = data.subject;
              P.clarifying_discussion.reShowFollowup(parentId);
            }
          }, function(err){
            alert(err);
          });
          top.removeClass("edit_mode");
        },
        cancel: function(){
          top.find('.discussion_content').show();
          top.find('#discussion_edit_' + id).hide();
          top.removeClass("edit_mode");
          P.clarifying_discussion.reShowFollowup(parentId);
        },
        height: 100,
        saveText: "post"
      });
      return false;
    });
    $('.clarifying_discussion .delete_discussion').unbind().click(function(){
      var id = $(this).closest('.clarifying_discussion').attr('id');
      $('#' + id).find('.discussion_dropdown').hide();
      P.clarifying_discussion.deleteItem(id, "discussion");
      return false;
    });
    $('.clarifying_discussion .edit_discussion').unbind().click(function(){
      if (P.answer.user.isPublic) {
        alert("You cannot edit this");
        return;
      }
      var top = $(this).closest('.clarifying_discussion');
      var id = top.attr('id');
      top.find('.discussion_content.main_followup').hide();
      top.find('.discussion_dropdown').hide();
      var editWrapper = top.find('#discussion_edit_' + id);
      editWrapper.show();
      top.addClass("edit_mode");
      PEM.fire("injectEditor", {
        where: editWrapper,
        postfix: "edit_followup_" + id,
        text: P.clarifying_discussion.followups[id].subject,
        anonymity: P.clarifying_discussion.content.default_anonymity,
        save: function(text) {
          P.clarifying_discussion.reShowFollowup(id);
          PA.call_pj("content.update", {cid:id, subject: text}, $('#clarifying_discussion'), function(data){
            top.find('.discussion_content').show();
            top.find('#discussion_edit_' + id).hide();
            var f = P.clarifying_discussion.followups[id];
            if (f) {
              f.subject = data.subject;
              P.clarifying_discussion.reShowFollowup(f.id);
            }
          }, function(err){
            alert(err);
          });
          top.removeClass("edit_mode");
        },
        cancel: function(){
          top.find('.discussion_content').show();
          top.find('#discussion_edit_' + id).hide();
          top.removeClass("edit_mode");
        },
        height: 120,
        saveText: "post"
      });
      return false;
    });
    $('.clarifying_discussion .start_reply').unbind().click(function(){
      if (P.answer.user.isPublic) {
        alert("You cannot do that");
        return;
      }
      var top = $(this).closest('.clarifying_discussion');
      var id = top.attr("id");
      top.addClass('edit_answer');
      top.find('.all_replies').show();
      top.find('.compose_reply').hide();
      top.find('.discussion_replies.edit_mode').show();
      PEM.fire("injectEditor", {
        where: $("#followup_reply_" + id),
        postfix: "followup_reply_" + id,
        text: "",
        anonymity: P.clarifying_discussion.content.default_anonymity,
        save: function(text, anon){
          return P.clarifying_discussion.postFollowupReply(id, text, anon);
        },
        cancel: function(){
          P.clarifying_discussion.cancelFollowupReply(top);
        },
        height: 100,
        saveText: "post"
      });
      return false;
    });
    $('.clarifying_discussion .resolve_unresolve_actions').unbind().change(function(){
      var top = $(this).closest('.clarifying_discussion');
      var resolve = top.hasClass("unresolved");
      P.clarifying_discussion.markResolved(top, resolve);
      return false;
    });
    $(".followup_region_arrow_dropdown").unbind().hover(
      function() {
        $(this).find(".dropdown-menu").show();
      }, function() {
        $(this).find(".dropdown-menu").hide();
      }
    );
    $(".followup_region_arrow_dropdown.reply").unbind().hover(
      function() {
        $(this).find(".dropdown-menu").show();
      }, function() {
        $(this).find(".dropdown-menu").hide();
      }
    );
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,'clarifying_discussion']);
  },
  deleteItem: function(id, type) {
    if (id) {
      var title = "Are you sure you want to delete this reply?";
      if (type == "discussion")
        title = "Are you sure you want to delete this followup discussion and all its replies?"
      var params = {
        title: title,
        confirm: "Delete",
        cancel: "Cancel",
        callback: function() {
          PA.call_pj("content.delete", {cid:id}, null, function(data){
            $('#' + id).hide();
          }, function(err) {setTimeout(function() {alert(err);}, 1000)});
        }
      }
      PEM.fire("showConfirmationWindow", params);
    }
  },
  markResolved: function(top, resolved) {
    var fid = top.attr('id');
    PA.call_pj('content.mark_resolved', {cid:fid, resolved:resolved}, top, function(data) {
      var f = P.clarifying_discussion.followups[fid];
      f.no_answer = data.no_answer;
      P.clarifying_discussion.fixResolveState(f);
    });
  },
  reShowFollowup: function(id) {
    var top = $('#' + id);
    if (top) {
      var f = P.clarifying_discussion.followups[id];
      top.replaceWith(P.clarifying_discussion.messageTemplate(f));
      P.clarifying_discussion.initHandlers();
    }
  },
  setNetwork: function(network) {
    P.clarifying_discussion.network = network;
  },
  setUser: function(user) {
    P.clarifying_discussion.user = user;
  },
  setContent: function(content) {
    P.clarifying_discussion.content = content;
    if (!content) return;
    if (content.status && content.status == 'deleted') return;
    P.clarifying_discussion.prepareChildren(content);
    var param = {
      content:P.clarifying_discussion.content,
      network:P.clarifying_discussion.network,
      user:P.clarifying_discussion.user
    };
    if (content.noFollowups)
      $('#clarifying_discussion').html("");
    else
      $('#clarifying_discussion').replaceWith(P.clarifying_discussion.template(param));

    P.clarifying_discussion.initHandlers();
  },
  cancelFollowupReply: function(top) {
    top.removeClass('edit_answer');
    top.find('.discussion_replies.edit_mode').hide();
    top.find('.start_reply').show();
  },
  postFollowupReply: function(id, text, anon) {
    if (text.length == 0) {
      alert("You cannot make an empty post");
      return false;
    }
    P.clarifying_discussion.cancelFollowupReply($('#' + id));
    PA.call_pj('content.create', {
      cid:id,
      subject:text,
      nid:P.clarifying_discussion.network.id,
      type:'feedback',
      anonymous:anon}, $('#' + id),
      function(data) {
        // do nothing. Push should take care of this (?)
        if (P.clarifying_discussion.followups[id] && !P.clarifying_discussion.replies[data.id]) {
          P.clarifying_discussion.insertReply(id, data);
        }
        P.clarifying_discussion.content.is_bookmarked = true;
        PEM.fire("setAnonymity", anon);
    }, function(err) {
      alert(err);
    });
    return true;
  },
  postFollowup: function(text, anon) {
    if (text.length == 0) {
      alert("You cannot make an empty post");
      return false;
    }
    $('#create_new_followup_div').hide();
    $('#create_new_followup').show();
    PA.call_pj("content.create", {
      nid:P.clarifying_discussion.network.id,
      cid:P.clarifying_discussion.content.id,
      type:'followup',
      subject:text,
      content:"", anonymous:anon},
      $('#clarifying_discussion'),
      function(data) {
        P.clarifying_discussion.addFollowup(data);
        P.clarifying_discussion.content.is_bookmarked = true;
        PEM.fire("setAnonymity", anon);
    }, function(error) {
      alert(error);
    });
    return true;
  },
  addFollowup: function(newContent) {
    if (!P.clarifying_discussion.followups[newContent.id]) {
      if (!P.clarifying_discussion.content.children)
        P.clarifying_discussion.content.children = [];
      newContent.inst = false;
      if (P.clarifying_discussion.network.prof_hash && P.clarifying_discussion.network.prof_hash[newContent.uid])
        newContent.inst = true;
      P.clarifying_discussion.content.children.push(newContent);
      P.clarifying_discussion.content.followups.push(newContent);
      P.clarifying_discussion.followups[newContent.id] = newContent;
      newContent.user = P.clarifying_discussion.user;
      $('#start_new_followup_header').before(P.clarifying_discussion.messageTemplate(newContent));
      P.clarifying_discussion.initHandlers();
    }
  },
  fixResolveState: function(f) {
    if (f.no_answer) {
      $('#' + f.id).addClass("unresolved");
      $('#' + f.id + " .discussion_action.mark_unresolved").removeClass("mark_unresolved").addClass("mark_resolved").html("mark as resolved");
      $('#unresolved_' + f.id).attr('checked', true);
    } else {
      $('#' + f.id).removeClass("unresolved");
      $('#' + f.id + " .discussion_action.mark_resolved").removeClass("mark_resolved").addClass("mark_unresolved").html("mark as unresolved");
      $('#resolved_' + f.id).attr('checked', true);
    }
  },
  prepareChildren: function(content) {
    var followups = [];
    P.clarifying_discussion.followups = {};
    P.clarifying_discussion.replies = {};
    P.clarifying_discussion.followupsSort = [];
    P.clarifying_discussion.repliesSort = [];
    if (content.children && content.children.length > 0) {
      for (var i = 0; i < content.children.length; i++) {
        if (content.children[i].type == "followup") {
          var f = content.children[i];
          f.inst = false;
          if (P.clarifying_discussion.network.prof_hash && P.clarifying_discussion.network.prof_hash[f.uid])
            f.inst = true;
          followups.push(f);
          P.clarifying_discussion.followups[f.id] = f;
          P.clarifying_discussion.followupsSort.push({id:f.id,u:f.updated});
          for (var j = 0; j < f.children.length; j++) {
            if (f.children[j].type == "feedback") {
              f.children[j].canShow = true;
              f.children[j].inst = false;
              if (P.clarifying_discussion.network.prof_hash && P.clarifying_discussion.network.prof_hash[f.children[j].uid])
                f.children[j].inst = true;
              P.clarifying_discussion.replies[f.children[j].id] = f.children[j];
              P.clarifying_discussion.repliesSort.push({id:f.children[j].id,u:f.children[j].updated});
            }
            if (f.children[j].type == "dupe")
              f.dupe = f.children[j];
          }
        }
      }
    }
    content.followups = followups;
    var sortF = function(a,b){
      if (a.u > b.u) return -1;
      if (a.u < b.u) return 1;
      return 0;
    };
    P.clarifying_discussion.followupsSort = P.clarifying_discussion.followupsSort.sort(sortF);
    P.clarifying_discussion.repliesSort = P.clarifying_discussion.repliesSort.sort(sortF);
  },
  insertReply: function(pid, newContent) {
    var f = P.clarifying_discussion.followups[pid];
    if (f) {
      if (!f.children) f.children = [];
      newContent.inst = false;
      newContent.canShow = true;
      if (P.clarifying_discussion.network.prof_hash && P.clarifying_discussion.network.prof_hash[newContent.uid])
        newContent.inst = true;
      f.children.push(newContent);
      P.clarifying_discussion.replies[newContent.id] = newContent;
      $('#' + pid + ' .compose_reply').before(P.clarifying_discussion.replyTemplate(newContent));
      $('#' + pid + ' .num_replies').removeClass("start_reply").addClass("show_reply").html("view " + f.children.length + " " + (f.children.length == 1 ? "reply" : "replies"));
      P.clarifying_discussion.initHandlers();
    }
  },
  pushContentMessage: function(message) {
    if (!P.clarifying_discussion.content) return;
    if (message.content && message.parent) {
      var pid = message.parent; // where this should go
      var newContent = message.content;
      if (message.action == 'create' && newContent.type == 'followup') {
        P.clarifying_discussion.addFollowup(newContent);
      }
      if (message.action == 'update' && newContent.type == 'followup') {
        if (P.clarifying_discussion.followups[newContent.id]) {
          var f = P.clarifying_discussion.followups[newContent.id];
          for (var key in newContent)
            f[key] = newContent[key];
          P.clarifying_discussion.prepareChildren(P.clarifying_discussion.content);
          // update subject
          $('#' + f.id + " .actual_text").html(PEM.callFirst("makeHtml", {text: f.subject}));
          MathJax.Hub.Queue(["Typeset",MathJax.Hub,'clarifying_discussion']);
          // update resolved state
          P.clarifying_discussion.fixResolveState(f);
        }
      }
      if (message.action == 'create' && newContent.type == 'feedback') {
        if (!P.clarifying_discussion.replies[newContent.id]) {
          P.clarifying_discussion.insertReply(pid, newContent);
        }
      }
      if (message.action == 'update' && newContent.type == 'feedback') {
        if (P.clarifying_discussion.followups[newContent.id]) {
          var r = P.clarifying_discussion.replies[newContent.id];
          for (var key in newContent)
            r[key] = newContent[key];
          // just update subject
          $('#' + r.id + " .actual_reply_text").html(PEM.callFirst("makeHtml", {text: r.subject}));
          MathJax.Hub.Queue(["Typeset",MathJax.Hub,'clarifying_discussion']);
        }
      }
    }
  },
  hideHistoryHighlight: function() {
    $('.discussion_replies.existing_reply').css("border", "none");
    $('.clarifying_discussion.clearFix:not(.new)').css("border-top", "none");
    $('.clarifying_discussion.clearFix:not(.new)').css("border-bottom", "none");
  },
  showHistory: function(history) {
    $('.discussion_replies.existing_reply').show();
    for (var i = 0; i < history.hide_feedbacks; i++) {
      if (i < P.clarifying_discussion.repliesSort.length)
        $('#' + P.clarifying_discussion.repliesSort[i].id).hide();
    }
    $('.clarifying_discussion.clearFix:not(.new)').show();
    for (var i = 0; i < history.hide_followups; i++) {
      if (i < P.clarifying_discussion.followupsSort.length)
        $('#' + P.clarifying_discussion.followupsSort[i].id).hide();
    }
    P.clarifying_discussion.hideHistoryHighlight();
    if (history.highlight == "followup") {
      var curFollowup = history.hide_followups || 0;
      if (curFollowup < P.clarifying_discussion.followupsSort.length) {
        $('#' + P.clarifying_discussion.followupsSort[curFollowup].id).css("border-top","2px solid #0f0");
        $('#' + P.clarifying_discussion.followupsSort[curFollowup].id).css("border-bottom", "2px solid #0f0");
        $('.main_panel').scrollTo('#' + P.clarifying_discussion.followupsSort[curFollowup].id);
      }
    }
    if (history.highlight == "feedback") {
      var curFeedback = history.hide_feedbacks || 0;
      if (curFeedback < P.clarifying_discussion.repliesSort.length) {
        $('#' + P.clarifying_discussion.repliesSort[curFeedback].id).css("border-top","2px solid #0f0");
        $('#' + P.clarifying_discussion.repliesSort[curFeedback].id).css("border-bottom", "2px solid #0f0");
        $('.main_panel').scrollTo('#' + P.clarifying_discussion.repliesSort[curFeedback].id);
      }
    }
  },
  init: function(module) {
    P.clarifying_discussion.template = module.template;

    PEM.addListener("content", P.clarifying_discussion.setContent);
    PEM.addListener("network", P.clarifying_discussion.setNetwork);
    PEM.addListener("pushContentMessage", P.clarifying_discussion.pushContentMessage);

    PEM.addListener("history", P.clarifying_discussion.showHistory);
    PEM.addListener("hideHistoryHighlight", P.clarifying_discussion.hideHistoryHighlight);

    PTM.getModuleTemplate("clarifying_discussion", "message", function(template) {P.clarifying_discussion.messageTemplate = template;});
    PTM.getModuleTemplate("clarifying_discussion", "reply", function(template) {P.clarifying_discussion.replyTemplate = template;});

    Handlebars.registerHelper('followupMessage', function(element) {
      if (P.clarifying_discussion.messageTemplate) {
        element.user = P.clarifying_discussion.user;
        return P.clarifying_discussion.messageTemplate(element);
      }
      return "";
    });
    Handlebars.registerHelper('followupReply', function(element, isVisible) {
      if (P.clarifying_discussion.replyTemplate) {
        element.isVisible = isVisible;
        return P.clarifying_discussion.replyTemplate(element);
      }
      return "";
    });
    Handlebars.registerHelper('canEditFollowup', function(element, options) {
      if (PA.hasPermission("followup_edit") || element.uid == P.clarifying_discussion.user.id) {
        return options.fn(this);
      }
      return "";
    });

    if (module.options.network)
      P.clarifying_discussion.network = module.options.network;
  }
};

function myFileBrowser (field_name, url, type, win) {
    //alert("Field_Name: " + field_name + ";nURL: " + url + ";nType: " + type + ";nWin: " + win); // debug/testing
    P.modules.loadModule("upload_manager", {}, function() {
      PEM.fire("showUploadManager", {submit: function(url){
        $("#" + field_name).val(url);
      }});
    }, null);
}
var actualCaretPositionBookmark = null;
function LatexImageAlign(evt) {
  var img;
  try {
    img = evt.currentTarget;
    img = (evt.currentTarget) ? evt.currentTarget : evt.srcElement;
  } catch (err) {
    return;
  }
  var h = img.naturalHeight;
  if (h > 16)
    $(img).css("vertical-align", "middle");
}
/*
var MATHJAX_CONFIG = 'MathJax.Hub.Config({root: "/third_party/mathjax/unpacked",' +
    'extensions: ["tex2jax.js"],messageStyle: "none",' +
    'jax: ["input/TeX", "output/HTML-CSS"],' +
    'tex2jax: {' +
    '  inlineMath: [ ["$$","$$"] ],' +
    '  displayMath: [ ],' +
    '  processEscapes: true}, ' +
    '"HTML-CSS": { availableFonts: ["TeX"] } });' +
    'MathJax.Hub.Startup.onload();';
  */
P.text_editor = {
  template: null,
  converter: null,
  callbacks: {},
  active: {},
  oldText: {},
  tinymceInit: false,
  user: null,
  dollars: "$$$$",

  setUser: function(user) {
    P.text_editor.user = user;
  },

  createEditor: function(options) {
    if (!options.height || options.height < 200) options.height = 200;
    options.anon = P.text_editor.getAnonymityOptions();
    P.text_editor.isRich = true;
    if (P.text_editor.user && P.text_editor.user.config && P.text_editor.user.config.default_editor == "plain")
      P.text_editor.isRich = false;
    if (P.text_editor.isRich)
      options.text = P.text_editor.convertLatex(options.text, options.type);
    else
      options.text = P.text_editor.removeTags(options.text);
    options.where.html(P.text_editor.template({options:options, isRich:P.text_editor.isRich}));
    $('#rich_' + options.postfix).val(options.text);
    if (P.text_editor.active[options.postfix])
      P.text_editor.cancelActive(options.postfix);
    if (P.text_editor.isRich) {
      tinymce.execCommand('mceAddEditor',true, 'rich_' + options.postfix);
      
      // we need to initialize mathjax in the editor frame
      //var dom = tinymce.get('rich_' + options.postfix).dom;
      //var doc = tinymce.get('rich_' + options.postfix).getDoc();
      //var script1 = dom.create('script',{type:"text/x-mathjax-config"},MATHJAX_CONFIG);
      //var script2 = dom.create('script',{type:"text/javascript",src:"/third_party/mathjax/unpacked/MathJax.js"});
      //var head = doc.getElementsByTagName("head")[0];
      //head.appendChild(script1);
      //head.appendChild(script2);

      //MathJax.Hub.Typeset(tinymce.get('rich_' + options.postfix).getBody());
      //P.text_editor.oldText[options.postfix] = $('#rich_' + options.postfix).val();
    } else {
      P.text_editor.oldText[options.postfix] = $('#rich_' + options.postfix).val();
      $("#rich_" + options.postfix).focus();
    }
    //var editor = new Markdown.Editor(P.text_editor.converter, options.postfix, {handler:P.text_editor.helpFunction});
    P.text_editor.callbacks[options.postfix] = options;
    //editor.run();
    //$('#wmd-input' + options.postfix).focus();
    P.text_editor.active[options.postfix] = options.postfix;
  },

  helpFunction: function() {
    window.open('/formatting.html', '_blank');
  },
  previewPost: function(postfix) {
    if (P.text_editor.isRich) {
      doPostPreview(tinymce.get('rich_' + postfix), {});
    } else {
      doPostPreview(null, {}, postfix);
    }
    return false;
  },
  getAnonymityOptions: function() {
    var anon = false;
    if (PA.hasPermission("can_post_anonymous_all") || PA.hasPermission("can_post_anonymous_members")) {
      anon = [{title:PA.user.name, val:"no"}];
      if (PA.hasPermission("can_post_anonymous_members") && P.modules.network && !P.modules.network.isGroup)
        anon.push({title:"Anonymous to Classmates", val:"stud"});
      if (PA.hasPermission("can_post_anonymous_all"))
        anon.push({title:"Anonymous to everyone", val:"full"});
    }
    return anon;
  },
  save: function(postfix) {
    if (P.text_editor.callbacks[postfix] && P.text_editor.callbacks[postfix].save) {
      if (P.text_editor.callbacks[postfix].save(P.text_editor.getEditorText(postfix), P.text_editor.getEditorAnonymity(postfix)) === false) return;
    }
    P.text_editor.cancelActive(postfix);
    return false;
  },
  cancel: function(postfix) {
    var newContent = $('#rich_' + postfix).val();
    if (P.text_editor.isRich)
      newContent = tinymce.get('rich_' + postfix).getContent();
    if (newContent != '' && newContent != P.text_editor.oldText[postfix]) {
      if (postfix == 'old_new_post')
        PEM.fire("verifyCancelNewPost", function(){P.text_editor.doCancel(postfix)});
      else
        PEM.fire("verifyCancel", function(){P.text_editor.doCancel(postfix)});
    } else {
      P.text_editor.doCancel(postfix);
    }
    return false;
  },
  doCancel: function(postfix) {
    P.text_editor.cancelActive(postfix);
    if (P.text_editor.callbacks[postfix] && P.text_editor.callbacks[postfix].cancel)
      P.text_editor.callbacks[postfix].cancel();
    return false;
  },
  cancelActive: function(postfix) {
    if (typeof(tinymce) != "undefined") {
      tinymce.execCommand('mceRemoveEditor',true, 'rich_' + postfix);
    }
    //tinymce.get("rich_" + postfix).remove();
    delete (P.text_editor.active[postfix]);
  },
  cancelAll: function() {
    for (var postfix in P.text_editor.active) {
      if (P.text_editor.callbacks[postfix] && P.text_editor.callbacks[postfix].cancel)
        P.text_editor.callbacks[postfix].cancel();
      P.text_editor.cancelActive(postfix);
    }
  },
  hasActiveEditor: function(keepOpen) {
    for (var postfix in P.text_editor.active) {
      var newContent = P.text_editor.getEditorText(postfix, true);
      if (postfix == 'old_new_post') return postfix;
      if (!newContent || newContent == P.text_editor.oldText[postfix]) {
        P.text_editor.cancelActive(postfix);
      } else {
        if (newContent != '' && newContent != P.text_editor.oldText[postfix]) return postfix;
      }
    }
    return false;
  },
  makeHtml: function(option) {
    var text = option.text;
    var type = option.type;
    if (type && type == "poll")
      text = "<" + type + ">" + text;
    return P.text_editor.convertHtml(text, option.isNew, option.isEditorPreview);
  },
  makeLaTeX: function(src, toHTML) {
    var content_text = src;
    content_text = $("<span>" + content_text + "</span>").html();  // escape weird characters
    content_text = content_text.replace(/&lt;/g, "<");
    content_text = content_text.replace(/&gt;/g, ">");
    content_text = content_text.replace(/&amp;/g, "&");
    content_text = content_text.replace(/&quot;/g, '"');
    content_text = content_text.replace(/&nbsp;/g, ' ');
    content_text = content_text.replace(/<br>/g, "\n");
    content_text = content_text.replace(/<p>/g, "");
    content_text = content_text.replace(/<\/p>/g, "\n");
    if (toHTML) {
      content_text = content_text.replace(/\n$/, "<br/>&nbsp;");
      content_text = content_text.replace(/\n/g, "<br/>");
    }
    return content_text;
  },
  convertHtml: function(html, isNew, isEditorPreview) {
    if (!html) return "";
    html = html.replace(/&quot;/g, '"');
    html = html.replace(/&#34;/g, '"');
    html = html.replace(/&#39;/g, "'");
    html = html.replace(/&amp;amp;/g, '&amp;');
    html = html.replace(/begin{tabular}/g, 'begin{array}');
    html = html.replace(/end{tabular}/g, 'end{array}');
    var pres = html.match(/<pre>[\s\S]*?<\/pre>/g);
    if (pres) {
      for (var i = 0; i < pres.length; i++) {
        html = html.replace(pres[i], "<|_p_" + i + "_p_|>");
      }
    }
    if (html.indexOf("<p ") != 0 && html.indexOf("<p>") != 0 && html.indexOf("<div") != 0 && !isNew) { // this is old edit
      html = html.replace(/^(.{0,3})\n\n/g, "$1<br/><br/>");
      html = html.replace(/^(.{0,3})\n/g, "$1<br/>");
      html = html.replace(/((?!<\/p>|ble>|p_\|>|\/ol>|\/ul>|\/li>|<ul>|<ol>)....)\n\n/g, "$1<br/><br/>");
      html = html.replace(/((?!<\/p>|ble>|p_\|>|\/ol>|\/ul>|\/li>|<ul>|<ol>)....)\n/g, "$1<br/>");
      html = html.replace(/\n\n\n/g, "<br/><br/>");
      html = html.replace(/\n\n/g, "<br/>");
    } else {
      html = html.replace(/<p><\/p>/g, "<p>&nbsp;</p>");
    }
    var tts = html.match(/<tt>[\s\S]*?<\/tt>/g);
    if (tts) {
      for (var i = 0; i < tts.length; i++) {
        html = html.replace(tts[i], "<|_tt_" + i + "_tt_|>");
      }
    }
    //if (html.indexOf("<p") != 0) { // this is old edit
      html = html.replace(/(^|[^"'])(https?:\/\/(\([^\s<\[\]"\)]*\)|[^ \t\n<\[\]"()])+?(\([^\s<\[\]"\)]*\)|[\w\/?=)}#&]))(?=$|<br|<\/|\s|([\]\)]|&gt;)[\.,:;?!"'\-]*(\s|<br|<\/|$)|[\.,:;!"'\-]+(\s|<br|<\/|$))/g, '$1<a href="$2" target="_blank">$2</a>');
    //}
    //var arr = html.split('$$');
    //if (arr.length > 2) {
      // potential latex
    html = html.replace(/"http:\/\/www.youtube.com\/embed\//g, '"https:\/\/www.youtube.com\/embed\/');
    html = html.replace(/<latex[^>]*>/g, "").replace("</latex>", "");
    var pageUrl = "/class/";
    if (P.modules && P.modules.network) pageUrl += P.modules.network.id;
    html = html.replace(/^@(\d+)/g, '<a href="' + pageUrl + '?cid=$1" onclick="return PEM.fire(\'selectContent\', \'$1\')">@$1</a>');
    html = html.replace(/>@(\d+)/g, '><a href="' + pageUrl + '?cid=$1" onclick="return PEM.fire(\'selectContent\', \'$1\')">@$1</a>');        
    html = html.replace(/(\s+|\(|&#40;)@(\d+)/g, '$1<a href="' + pageUrl + '?cid=$2" onclick="return PEM.fire(\'selectContent\', \'$2\')">@$2</a>');
    html = html.replace(/^&#64;(\d+)/g, '<a href="' + pageUrl + '?cid=$1" onclick="return PEM.fire(\'selectContent\', \'$1\')">@$1</a>');
    html = html.replace(/>&#64;(\d+)/g, '><a href="' + pageUrl + '?cid=$1" onclick="return PEM.fire(\'selectContent\', \'$1\')">@$1</a>');    
    html = html.replace(/(\s+|\(|&#40;)&#64;(\d+)/g, '$1<a href="' + pageUrl + '?cid=$2" onclick="return PEM.fire(\'selectContent\', \'$2\')">@$2</a>');
    if (html.indexOf("<poll>") == 0) {
      html = html.replace("<poll>", "");
      var allToReplace = html.match(/\[[o*]\] /g);
      if (allToReplace) {
        for (var i = 0; i < allToReplace.length; i++) {
          var toReplace = allToReplace[i];
          var replaceWith = "[[[radio-"+i+"]]]";
          if (toReplace == "[*] ")
            replaceWith = "[[[checkbox-"+i+"]]]";
          var at = html.indexOf(toReplace);
          var enter = html.indexOf("\n", at);
          var enter2 = html.indexOf("<br", at);
          var enter3 = html.indexOf("</", at);
          var addBreak = "";
          if (enter > 0) {
            if (enter2 > 0 && enter2 > enter) enter2 = -1;
            if (enter3 > 0 && enter3 > enter) enter3 = -1;
          }
          if (enter2 > 0) {
            if (enter > 0 && enter > enter2) enter = -1;
            if (enter3 > 0 && enter3 > enter2) enter3 = -1;
          }
          if (enter3 > 0) {
            if (enter2 > 0 && enter2 > enter3) enter2 = -1;
            if (enter > 0 && enter > enter3) enter = -1;
          }
          if (enter >= 0 && enter2 < 0 && enter3 < 0) addBreak = "<br/>";
          if (enter < 0 || (enter2 > 0 && enter2 < enter)) enter = enter2;
          if (enter < 0 || (enter3 > 0 && enter3 < enter)) enter = enter3;
          if (enter < 0) enter = html.length;
          var label = html.substr(at + 3, (enter - at - 3));
          var goodLabel = label.replace(/<[^>]*>/g, "");
          var before = html.substr(0, at + 3);
          var after = html.substr(enter);
          html = before + goodLabel + addBreak + after;
          html = html.replace(toReplace, replaceWith);
        }
        html += "\n\n[[[submit_vote]]]";
      }
    }

    if (pres) {
      for (var i = 0; i < pres.length; i++) {
        html = html.replace("<|_p_" + i + "_p_|>", "<pre style='white-space: -moz-pre-wrap;white-space: -o-pre-wrap;white-space: pre-wrap;word-wrap: break-word;'>" +
          pres[i].substr(5, pres[i].length - 11).replace(/[$]/g, P.text_editor.dollars).replace(/<br \/>/g,"\n").replace(/&amp;/g, "&").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br&gt;/g, "<br>") + "</pre>");
      }
    }
    if (tts) {
      for (var i = 0; i < tts.length; i++) {
        html = html.replace("<|_tt_" + i + "_tt_|>", "<tt>" + tts[i].substr(4, tts[i].length - 9).replace(/[$]/g, P.text_editor.dollars).replace(/&amp;/g, "&").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br\/&gt;/g, "<br/>") + "</tt>");
      }
    }
    // html = html.replace(/\[\[\[radio-(\d+)]]]/, "<br/><input type='radio' class='poll_button' name='poll_radio_button' id='poll_button$1'/>&nbsp;")
    html = html.replace(/\[\[\[radio-(\d+)]]]/g, "<input type='radio' class='poll_button' name='poll_radio_button' id='poll_button$1'/>&nbsp;");
    html = html.replace(/\[\[\[checkbox-(\d+)]]]/g, "<input type='checkbox' class='poll_button' name='poll_radio_button' id='poll_button$1'/>&nbsp;");

    html = html.replace(/\[\[\[submit_vote]]]/, "<br/><br/><button onclick='PEM.fire(\"doVote\");' class='poll_button btn btn-mini'>Submit</button><br/><span id='poll_anonymity_placeholder'></span><br/>");


    return html;
  },
  convertLatex: function(html, type) {
    if (!html) return "";
    html = html.replace(/&amp;amp;/g, '&amp;');
    var pres = html.match(/<pre>[\s\S]*?<\/pre>/g);
    if (pres) {
      for (var i = 0; i < pres.length; i++) {
        html = html.replace(pres[i], "<|_p_" + i + "_p_|>");
      }
    }
    if (html.indexOf("<p") != 0 && html.indexOf("<div") != 0) { // this is old edit
      html = html.replace(/^(.{0,3})\n\n/g, "$1<br/><br/>");
      html = html.replace(/^(.{0,3})\n/g, "$1<br/>");
      html = html.replace(/((?!<\/p>|ble>|p_\|>|\/ol>|\/ul>|\/li>|<ul>|<ol>|<li>)....)\n\n/g, "$1<br/><br/>");
      html = html.replace(/((?!<\/p>|ble>|p_\|>|\/ol>|\/ul>|\/li>|<ul>|<ol>|<li>)....)\n/g, "$1<br/>");
      html = html.replace(/\n\n\n/g, "<br/><br/>");
    }
    var tts = html.match(/<tt>[\s\S]*?<\/tt>/g);
    if (tts) {
      for (var i = 0; i < tts.length; i++) {
        html = html.replace(tts[i], "<|_tt_" + i + "_tt_|>");
      }
    }
    //html = html.replace(/\$\$$/, "$$$$<br/><br/>");
    var arr = html.split('$$');
    if (arr.length > 2) {
      // potential latex
      for (var i = 1; i <= arr.length - 1; i+=2) {
        var str = arr[i]
        if (str.length >= 1) {
            var content_text = P.text_editor.makeLaTeX(str, true);
            var content_escaped = content_text.replace(/>/g, "&#62;");
            content_escaped = content_escaped.replace(/</g, "&#60;");
            content_escaped = content_escaped.replace(/"/g, "&#34;");
            //var replaced = "<img style='width: auto;vertical-align: baseline;' onload='LatexImageAlign(event)' src='/main/show_latex?" + content_text + "' ondblclick='window.parent.editSelectedLatex()' data-mce-object='latex' data-mce-resize='false' data-mce-src='/main/show_latex?" + content_escaped + "' data-mce-html='" + content_escaped + "'/>"
            content_escaped = content_escaped.replace(/'/g, "&#39;");
            var replaced = P.text_editor.dollars + "<latex class='piazza-latex-edit' ondblclick='window.parent.editSelectedLatex()'>" + content_text + "</latex>" + P.text_editor.dollars;
            html = html.replace("$$" + str + "$$", replaced);
        }
      }
    }
    if (type == "poll") {
      html = html.replace(/(\n\s*\[[o*]\] )/g, "<br/>$1");
      //html = html.replace(/<br\/>(\n\[[o*]\] )/, "$1");
    }
    if (pres) {
      for (var i = 0; i < pres.length; i++) {
        html = html.replace("<|_p_" + i + "_p_|>", "<pre style='white-space: -moz-pre-wrap;white-space: -o-pre-wrap;white-space: pre-wrap;word-wrap: break-word;'>" +
          pres[i].substr(5, pres[i].length - 11).replace(/[$]/g, P.text_editor.dollars).replace(/<br \/>/g,"\n").replace(/&amp;/g, "&").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br&gt;/g, "<br>") + "</pre>");
      }
    }
    if (tts) {
      for (var i = 0; i < tts.length; i++) {
        html = html.replace("<|_tt_" + i + "_tt_|>", "<tt>" + tts[i].substr(4, tts[i].length - 9).replace(/[$]/g, P.text_editor.dollars).replace(/&amp;/g, "&").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br\/&gt;/g, "<br/>") + "</tt>");
      }
    }
    return html;
  },
  convertToLatex: function(html) {
    if (!html) return "";
    html = html.replace(/<\/latex>/g, "");
    html = html.replace(/<latex[^>]*>/g, "");
    var arr = html.split('$$');
    if (arr.length > 2) {
      // potential latex
      for (var i = 1; i <= arr.length - 1; i+=2) {
        var str = arr[i]
        if (str.length >= 1) {
            var content_text = P.text_editor.makeLaTeX(str);
            var content_escaped = content_text.replace(/>/g, "&#62;");
            content_escaped = content_escaped.replace(/</g, "&#60;");
            content_escaped = content_escaped.replace(/"/g, "&#34;");
            content_escaped = content_escaped.replace(/'/g, "&#39;");
            var replaced = P.text_editor.dollars + content_text + P.text_editor.dollars;
            html = html.replace("$$" + str + "$$", replaced);
        }
      }
    }
    //html = html.replace(/<\/span>\$\$/g, "$$$$");
    //html = html.replace(/\$\$<span[^>]*>/g, "$$$$");
    
    return html;
  },
  removeTags: function(text) {
    text = $("<span>" + text + "</span>").html(); // remove weird characters
    text = text.replace(/\r/g, "");
    text = text.replace(/<p(\s[^>]*?)?>/gi, "");
    text = text.replace(/<div[^>]*?>/gi, "");
    text = text.replace(/<\/p>\n/gi, "\n");
    text = text.replace(/<\/p>/gi, "\n");
    text = text.replace(/<\/div>\n/gi, "\n");
    text = text.replace(/<\/div>/gi, "\n");
    text = text.replace(/<br\s?\/>\n/gi, "\n");
    text = text.replace(/<br\s?\/>/gi, "\n");
    text = text.replace(/<br\s?>\n/gi, "\n");
    text = text.replace(/<br\s?>/gi, "\n");
    //text = text.replace(/&lt;/g, "<");
    //text = text.replace(/&gt;/g, ">");
    text = text.replace(/&nbsp;/gi, " ");
    text = text.replace(/<pre [^>]*?>/gi, "<pre>");
    return text;
  },
  removeTagsFromPre: function(html) {
    if (!html) return "";
    var pres = html.match(/<pre\s?[^>]*?>[\s\S]*?<\/pre>/g);
    if (pres) {
      for (var i = 0; i < pres.length; i++) {
        html = html.replace(pres[i], "<|_p_" + i + "_p_|>");
      }
    }
    var tts = html.match(/<tt>[\s\S]*?<\/tt>/g);
    if (tts) {
      for (var i = 0; i < tts.length; i++) {
        html = html.replace(tts[i], "<|_tt_" + i + "_tt_|>");
      }
    }
    if (pres) {
      for (var i = 0; i < pres.length; i++) {
        html = html.replace("<|_p_" + i + "_p_|>", "<pre>" +
          pres[i].substr(5, pres[i].length - 11).replace(/\$\$/g, "&#36;&#36;").replace(/&amp;/g, "&").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</pre>");
      }
    }
    if (tts) {
      for (var i = 0; i < tts.length; i++) {
        html = html.replace("<|_tt_" + i + "_tt_|>", "<tt>" + tts[i].substr(4, tts[i].length - 9).replace(/\$\$/g, "&#36;&#36;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</tt>");
      }
    }
    return html;
  },
  getEditorText: function(postfix, noLatex) {
    var newContent = $('#rich_' + postfix).val();
    if (P.text_editor.isRich && tinymce.get('rich_' + postfix)) {
      //var body = $(tinymce.get('rich_' + postfix).getBody());
      //body.find('#MathJax_Hidden').parent().remove();
      //body.find('#MathJax_Message').remove();
      //body.find('#MathJax_Font_Test').remove();
      newContent = tinymce.get('rich_' + postfix).getContent();
    } else {
      newContent = P.text_editor.removeTagsFromPre(newContent);
    }
    if (noLatex || !P.text_editor.isRich) return newContent;
    return P.text_editor.convertToLatex(newContent);
  },
  getEditorAnonymity: function(postfix) {
    var anon = $('#anon_' + postfix).val();
    if (!anon) anon = "no";
    return anon;
  },
  setEditorText: function(options) {
    if (P.text_editor.isRich)
      tinymce.get('rich_' + options.postfix).setContent(options.text);
    else
      $('#rich_' + options.postfix).val(options.text);
  },
  focusEditor: function(postfix) {
    if (P.text_editor.isRich)
      tinymce.get('rich_' + postfix).focus();
    else
      $('#rich_' + postfix).focus();
  },
  injectEditor: function(options) {
    P.text_editor.createEditor(options);
    $(".anonymity_selector").val(options.anonymity);
    if (options.group) {
      $("#subgroup_dropdown_edit").val(options.group);
    }
  },
  toggleRichtext: function() {
    P.text_editor.isRich = true;
    if (P.text_editor.user.config && P.text_editor.user.config.default_editor == "plain")
      P.text_editor.isRich = false;
    var editor = "rte";
    if (P.text_editor.isRich) editor = "plain";
    P.text_editor.user.config.default_editor = editor;
    PA.call_pj("user.update", {"default_editor":editor}, 1);
    if (P.text_editor.isRich) {// switch from rich to plain
      if (typeof(tinymce) != "undefined") {
        for (var postfix in P.text_editor.active) {
          var text = P.text_editor.getEditorText(postfix);
          tinymce.execCommand('mceRemoveEditor',true, 'rich_' + postfix);
          text = P.text_editor.removeTags(text);
          $('#rich_' + postfix).val(text);
          $('#rich_' + postfix).focus();
        }
      }
      $('.richtext_toggle').html("use rich text editor");
      P.text_editor.isRich = false;
    } else {
      for (var postfix in P.text_editor.active) {
        var options = P.text_editor.callbacks[postfix];
        options.text = $('#rich_' + postfix).val();
        var height = $('#rich_' + postfix).css("height");
        if (height) options.height = parseInt(height);
        P.text_editor.createEditor(options);
      }
      $('.richtext_toggle').html("use plain text editor");
      P.text_editor.isRich = true;
    }
  },
  init: function(module) {
  
    // see how many dollars we need
    if ("a".replace("a", "$$") == "$$")
      P.text_editor.dollars = "$$";
  
    P.text_editor.template = module.template;

    PEM.addListener("makeHtml", P.text_editor.makeHtml);
    PEM.addListener("convertToLatex", P.text_editor.convertToLatex);
    PEM.addListener("getEditorText", P.text_editor.getEditorText);
    PEM.addListener("getEditorAnonymity", P.text_editor.getEditorAnonymity);
    PEM.addListener("getAnonymityOptions", P.text_editor.getAnonymityOptions);
    PEM.addListener("setEditorText", P.text_editor.setEditorText);
    PEM.addListener("injectEditor", P.text_editor.injectEditor);
    PEM.addListener("cancelOne", P.text_editor.cancel);
    PEM.addListener("cancelOneForce", P.text_editor.doCancel);
    PEM.addListener("cancelAll", P.text_editor.cancelAll);
    PEM.addListener("hasActiveEditor", P.text_editor.hasActiveEditor);
    PEM.addListener("toggleRichtext", P.text_editor.toggleRichtext);
    PEM.addListener("focusEditor", P.text_editor.focusEditor);
    PEM.addListener("previewPost", P.text_editor.previewPost);
/*
    MathJax.Hub.Config({
      jax: ["input/TeX","output/HTML-CSS"],
      extensions: ["tex2jax.js"],//,"MathMenu.js","MathZoom.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$$','$$'] ],
        displayMath: [ [] ]
      },
      "HTML-CSS": { availableFonts: ["TeX"] }
    });
*/
    if (typeof(tinymce) != 'undefined') {
      if (!P.text_editor.tinymceInit) {
        P.text_editor.tinymceInit = true;
        tinymce.init({
          theme : "modern",
          relative_urls: false,
          plugins: [
            "advlist autolink lists link image charmap preview",
            "searchreplace media",
            "insertdatetime table equation directionality paste"
          ],
          valid_elements: "*[*]",
          toolbar: "bold italic | alignleft aligncenter | ltr rtl | bullist numlist | link image insertfile | equation prebutton ttbutton | preview | help",
          skin_url: "/modules/tinymce/skins/lightgray",
          file_browser_callback : myFileBrowser,
          statusbar: true,
          resize: true,
          gecko_spellcheck : true,
          browser_spellcheck: true,
          init_instance_callback: function(inst){
            if (inst.id == 'fake_editor') {
              setTimeout(function(){tinymce.execCommand('mceRemoveEditor',true, 'fake_editor');}, 100);
              return;
            }
            tinymce.get(inst.id).focus();
            var postfix = inst.id.replace("rich_", "");
            P.text_editor.oldText[postfix] = tinymce.get(inst.id).getContent();
          },
          setup : function(ed) {
            ed.on("click keyup", function(evt) {
              actualCaretPositionBookmark = ed.selection.getBookmark(true);
            });
            ed.on("keydown", function(evt) {
              if (evt.keyCode == 9){ // tab pressed
                var elem = ed.selection.getNode();
                if (elem.nodeName == "PRE") {
                  ed.selection.setContent('\x09');
                  evt.preventDefault();
                  evt.stopPropagation();
                  return false;
                }
              }
              return true;
            });
          }
       });
      }
      tinymce.execCommand('mceAddEditor',true, 'fake_editor');
    }
  }
};

P.push = {
  network: null,
  content: null,
  user: null,
  getOnlineUsers: null,
  pushstream: null,
  pushtimer: null,
  pushstreamLastOpen: null,
  pushstreamTimeout: null,
  pushstreamPingTimeout: 1000*50, // timeout for websocket pings
  pushstreamPingHandle: 0, // handle for javascript setTimeout
  pushstreamRefresh: 1000*60*2, // refresh feed after 2 minute of connection loss
  pushstreamNid: null,

  setContent: function(content) {
    P.push.content = content;
  },
  setNetwork: function(network) {
    P.push.network = network;
    var nid = network.id;
    if (P.push.pushstreamNid != nid) {
      P.push.pushstreamNid = nid;
      if (!P.push.user.isPublicFaq)
        setTimeout(function(){P.push.initStreamPush(nid);}, 2000);
    }
    // after network change, open communication channel
    // also keep refreshing online users here as well
  },
  setUser: function(user) {
    P.push.user = user;
  },
  initStreamPush: function(nid) {
    if (!P.push.network) return;
    if (P.push.network.id != nid) return;
    //PushStream.LOG_LEVEL = 'debug';
    try {
      if (P.push.pushstream)
        P.push.pushstream.disconnect();
    } catch (err) {}
    P.push.pushstream = new PushStream({
      host: window.location.hostname,
      port: window.location.port,
      modes: "websocket|longpolling"
    });
    P.push.pushtimer = (new Date()).getTime();
    P.push.pushstream.onmessage = P.push.onMessage;
    P.push.pushstream.onstatuschange = P.push.onStatuschange;
    P.push.pushstream.removeAllChannels();
    var channel = P.push.network.id;
    if (P.push.user.isInst)
      channel += "_prof";
    else
      channel += "_stud";
    P.push.pushstream.addChannel(channel);
    P.push.pushstream.connect();
  },
  pushTimeout: function() {
    P.push.pushstream.disconnect();
    P.push.pushstream._connect();
  },
  onMessage: function(eventMessage, id, channel) {
    P.push.pushstreamLastOpen = (new Date()).getTime();
    if (P.push.pushstreamTimeout > 0) {
      clearTimeout(P.push.pushstreamTimeout);
      P.push.pushstreamTimeout = 0;
    }
    if (Object.prototype.toString.call(eventMessage) == '[object String]' && eventMessage.length > 0 && id >= 0) {
      if ($.browser && $.browser.msie) // for internet explorer, escape enters
        eventMessage = eventMessage.replace(/\n/g, '\\n');
      eventMessage = JSON.parse(eventMessage);
    }
    if (channel == "ctrl_c") {
      P.push.pushTimeout();
      return;
    }
    if (channel == "ping" || id == -1) {
      return;
    }
    if (eventMessage.oid) {
      if (eventMessage.oid == P.push.network.id)
        PEM.fire("pushNetworkMessage", eventMessage);
      if (P.push.content && P.push.content.id == eventMessage.oid)
        PEM.fire("pushContentMessage", eventMessage);
    }
  },
  sendPing: function() {
    if (P.push.pushstream && P.push.pushstream.wrapper && P.push.pushstream.wrapper.type == "WebSocket") {
      if (P.push.pushstream.readyState == PushStream.OPEN) {
        P.push.pushstream.sendMessage("pong");
      }
      if (P.push.pushstreamLastOpen > 0) {
        // check how long we were down
        var now = (new Date()).getTime();
        var down = now - P.push.pushstreamLastOpen;
        //console.log("going up at: " + now + "; down: " + down);
        if (down > P.push.pushstreamRefresh) { // more than 2 minutes down, refresh
          P.push.pushTimeout();
        }
      }
      P.push.pushstreamPingHandle = setTimeout(P.push.sendPing, P.push.pushstreamPingTimeout);
    }
  },
  onStatuschange: function(state) {
    //console.log("State: " + state);
    if (state == PushStream.OPEN) {
      // create timeout for pings
      if (P.push.pushstreamTimeout > 0)
        clearTimeout(P.push.pushstreamTimeout);
      if (P.push.pushstream.wrapper.type != "LongPolling") {
        P.push.pushstreamTimeout = setTimeout(P.push.pushTimeout, 10000); // set 10 second timeout
        if (P.push.pushstreamPingHandle > 0)
          clearTimeout(P.push.pushstreamPingHandle);
        P.push.pushstreamPingHandle = setTimeout(P.push.sendPing, P.push.pushstreamPingTimeout);
      } else {
        // no ping needed for longpolling
        if (P.push.pushstreamPingHandle > 0)
          clearTimeout(P.push.pushstreamPingHandle);
      }
      if (P.push.pushstreamLastOpen > 0) {
        // check how long we were down
        var now = (new Date()).getTime();
        var down = now - P.push.pushstreamLastOpen;
        //console.log("going up at: " + now + "; down: " + down);
        if (down > P.push.pushstreamRefresh) { // more than 2 minutes down, refresh
          P.push.reloadState();
        }
        P.push.pushstreamLastOpen = now;
      }
    }
    P.push.pushstreamLastState = state;
  },
  reloadState: function() {
    /* this can cause users to lose their work!
    setTimeout(function(){
      PEM.fire("network", P.push.network);
      if (P.push.content) {
        PA.call_pj("content.get", {cid:P.push.content.id, nid:P.push.network.id}, 1, function(content, aid) {
          PEM.fire("content", content);
        });
      }
    }, 200);
    */
  },
  refreshOnlineUsers: function() {
    if (!P.push.network) return;
    var nid = P.push.network.id;
    PA.call_pj("network.get_online_users", {
      nid: nid,
      uid: P.push.user.id
    }, 1, function(data) {
      PEM.fire("onlineUsers", {nid:nid, data:data});
      if (nid == P.push.network.id) {
        P.push.network.online_users = data.users;
        if (P.push.getOnlineUsers) {
          clearTimeout(P.push.getOnlineUsers);
        }
        P.push.getOnlineUsers = setTimeout(function() { P.push.refreshOnlineUsers(); }, 1000 * 180); // 3 minute timeout
      }
    }, function(err) {
      if (err === "User session changed") {
        PEM.fire("triggerLogoutWarning");
      }
    });
  },
  detectNetworkTimeout: function() {
  },
  init: function(module) {
    PEM.addListener("network", P.push.setNetwork);
    PEM.addListener("content", P.push.setContent);
    PEM.addListener("refreshOnlineUsers", P.push.refreshOnlineUsers);
    PEM.addListener("detectNetworkTimeout", P.push.detectNetworkTimeout);

    if (module.options) {
      if (module.options.user)
        P.push.setUser(module.options.user);
      if (module.options.network)
        P.push.setNetwork(module.options.network);
    }
  }
};
P.attachments = {

  initClickHandlers: function() {
    $("#closeAttachmentModal").click(function() {
      $('#dialog_upload_attach').jqmHide();
      $('#upload-attachment-iframe').attr('src', '/upload/upload_attach');
      return false;
    });
  },

  showUploadAttachment: function(params) {
    $('#attachment-what').html(params.type);
    $('#dialog_upload_attach').jqmShow();

    $('#upload-attachment-iframe').contents().find('#cid').val(params.cid);
    $('#upload-attachment-iframe').contents().find('#nid').val(params.nid);
    $('#upload-attachment-iframe').contents().find('#uid').val(params.uid);
    return false;
  },

  init: function(module) {
    $("body").append(module.template());
    P.attachments.initClickHandlers()
    $('#dialog_upload_attach').jqm();
    PEM.addListener("show_upload_attachment", P.attachments.showUploadAttachment);
  }

};
P.user_careers_profile = {

  user: {},
  profileData: null,
  termOrder: ['Fall 2014', 'Summer 2014', 'Spring 2014', 'Winter 2014', 'Fall 2013', 'Summer 2013', 'Spring 2013', 'Winter 2013', 'Autumn 2012', 'Winter Term 1 2012', 'Fall 2012', 'Summer 2012', 'Spring 2012', 'Winter 2012', 'Fall 2011', 'Summer 2011', 'Spring 2011', 'Winter 2011', 'Fall 2010', 'Summer 2010', 'Spring 2010', 'Winter 2010', 'Other'],
  pastTerms: ['Fall 2013', 'Summer 2013', 'Spring 2013', 'Winter 2013', 'Autumn 2012', 'Fall 2012', 'Summer 2012', 'Spring 2012', 'Winter 2012', 'Fall 2011', 'Summer 2011', 'Spring 2011', 'Winter 2011', 'Fall 2010', 'Summer 2010', 'Spring 2010', 'Winter 2010', 'Other'],
  skillList: ["C", "C++", "C#", "Java", "R", "Ruby", "Python", "Perl",
    "HTML", "CSS", "Javascript", "jQuery", "Rails", "PHP", "SQL", "MySQL",
    "Objective-C", "Android", "Illustrator", "Photoshop"],
  tagAutocompleteSelected: false,

  initHandlers: function() {
    if (!$('.request_resume_as').hasClass("disabled")) {
      $('.request_resume_as').click(function(){
        $(this).toggleClass('anon');
        return false;
      });
    }
    if (jQuery().placeholder) // only do this if placeholder plugin is loaded
      $('#add_tags').placeholder();
    $('.show_tag_toggle').click(function(){
      $('.tag_library').show();
      $(this).hide();
      $('.hide_tag_toggle').show();
    });
    $('.hide_tag_toggle').click(function(){
      $('.tag_library').hide();
      $(this).hide();
      $('.show_tag_toggle').show();
    });
    $('.start_manage_tag_toggle').click(function(){
      $('.tag_library').addClass('edit_mode');
      $(this).hide();
      $('.done_manage_tag_toggle').show();
    });
    $('.done_manage_tag_toggle').click(function(){
      $('.tag_library').removeClass('edit_mode');
      $(this).hide();
      $('.start_manage_tag_toggle').show();
    });
    $("#add_tags").keyup(function(e) {
      if (!$(this).val()) {
        $(".tags_autocomplete").hide();
        return false;
      }
      var keyCode = (window.event) ? e.which : e.keyCode;
      if (keyCode == 13) {
        e.preventDefault();
        if (P.user_careers_profile.tagAutocompleteSelected)
          P.user_careers_profile.addTag(P.user_careers_profile.tagAutocompleteSelected);
        else
          P.user_careers_profile.addTag($(this).val());
        return false;
      }
      if(keyCode == 40 && $(".tags_autocomplete li").length > 0) {
        e.preventDefault();
        if (!P.user_careers_profile.tagAutocompleteSelected) {
          var topList = $(".tags_autocomplete li").first();
          topList.addClass("highlight");
          P.user_careers_profile.tagAutocompleteSelected = topList.text();
        }
        else {
          $(".tags_autocomplete li").each(function() {
            if ($(this).hasClass("highlight")) {
              $(this).removeClass("highlight");
              if ($(this).next() && $(this).next().length > 0) {
                $(this).next().addClass("highlight");
                P.user_careers_profile.tagAutocompleteSelected = $(this).next().text();
              }
              else {
                $(".tags_autocomplete li").first().addClass("highlight");
                P.user_careers_profile.tagAutocompleteSelected = $(".tags_autocomplete li").first().text();
              }
              return false;
            }
          });
        }
        return false;
      }
      if (keyCode == 38 && $(".tags_autocomplete li").length > 0) {
        if (!P.user_careers_profile.tagAutocompleteSelected) {
          var topList = $(".tags_autocomplete li").last();
          topList.addClass("highlight");
          P.user_careers_profile.tagAutocompleteSelected = topList;
        }
        else {
          $(".tags_autocomplete li").each(function() {
            if ($(this).hasClass("highlight")) {
              $(this).removeClass("highlight");
              if ($(this).prev() && $(this).prev().length > 0) {
                $(this).prev().addClass("highlight");
                P.user_careers_profile.tagAutocompleteSelected = $(this).prev().text();
              }
              else {
                $(".tags_autocomplete li").last().addClass("highlight");
                P.user_careers_profile.tagAutocompleteSelected = $(".tags_autocomplete li").last().text();
              }
              return false;
            }
          });
        }
        return false;
      }
      var storedTags = [];
      if (typeof(COMPANY_TAGS) != 'undefined') storedTags = COMPANY_TAGS;
      var searchTag = $.trim($(this).val().toLowerCase());
      //var listHtml = '<li>Searching for:<br> &quot;<span id="tag_search_query">' + $(this).val() + '</span>&quot;</li>';
      var listHtml = '';
      for (var i = 0; i < storedTags.length; i++) {
        var searchAgainst = $.trim(storedTags[i].toLowerCase());
        if (searchAgainst.indexOf(searchTag) !== -1)
          listHtml += '<li class="add_tag_autocomplete" onclick="return P.user_careers_profile.addTag(\'' + storedTags[i].replace("\'", "\\'") + '\');">' + storedTags[i] + '</li>';
      }
      $(".tags_autocomplete").html(listHtml);
      P.user_careers_profile.tagAutocompleteSelected = false;
      $(".tags_autocomplete").show();
    });

    $(".profile_body .edit_button").click(function() {
      var top = $(this).closest('.profile_section');
      if (top.find('.no_conent_message:visible').length > 0) {
        setTimeout(function(){top.find('.add_button').click();}, 100);
      }
      top.addClass('edit_mode');
      top.find('.profile_block').show();
      return false;
    });
    $(".profile_body .save_button").click(function() {
      P.user_careers_profile.saveSection($(this).closest('.profile_section'));
      $(this).closest('.profile_section').removeClass('edit_mode');
      return false;
    });
    $(".profile_header .edit_button").click(function() {
      $('.profile_header').addClass('edit_mode');
      return false;
    });
    $(".profile_header .save_button").click(function() {
      P.user_careers_profile.saveSection($('.profile_header'));
      $('.profile_header').removeClass('edit_mode');
      return false;
    });
    $(".view_as_company").click(function() {
      $('#careers_profile').addClass('previewing_company_view');
      return false;
    });
    $(".stop_view_as_company").click(function() {
      $('#careers_profile').removeClass('previewing_company_view');
      return false;
    });
    //$(".back_to_search").click(function() {
      //PEM.fire("showHomescreen");
    //  $("#user_profile_wrapper").html('');
    //  $("#company_search").show();
    //  $(".back_to_search").hide();
    //  $(".feed_item").removeClass("selected");
    //  return false;
    //});
    $('.remove_profile_row').click(function() {
      $(this).closest('.profile_row').remove();
      return false;
    });
    $('.add_profile_row').click(function() {
      var dataFieldArray = $(this).attr('data-field-array');
      $(this).before('<div class="profile_row clearfix"><input type="text" class="profile_text_input long_input show_for_edit" data-field-array="' + dataFieldArray + '">' +
            '<i class="icon-remove-sign remove_button show_for_edit remove_profile_row" onclick="$(this).closest(\'.profile_row\').remove();"></i></div>');
      $(this).prev().find('input').focus();
      return false;
    });
    $('.delete_section').click(function() {
      $(this).closest('.profile_sub_section').remove();
      return false;
    });
    $('.add_work_row').click(function(){
      var html = P.user_careers_profile.defaultExtraFields('work');
      $(this).before(html);
      $($(this).prev().find('input')[0]).focus();
      return false;
    });
    $('.add_research_row').click(function(){
      var html = P.user_careers_profile.defaultExtraFields('research');
      $(this).before(html);
      $($(this).prev().find('input')[0]).focus();
      return false;
    });
    $('.add_side_row').click(function() {
      var html = ' \
        <div class="profile_sub_section add_section" data-field-array="side_projects"> \
            <input type="text" class="profile_text_input full_width_input show_for_edit" placeholder="What was project title?" data-subfield="title"> \
            <textarea rows="5" class="profile_textarea show_for_edit" placeholder="What did you do?" data-subfield="text"></textarea> \
            <a href="#" class="show_for_student action_link delete_button show_for_edit right_align" onclick="$(this).closest(\'.profile_sub_section\').remove();">delete section</a> \
        </div>';
      $(this).before(html);
      $($(this).prev().find('input')[0]).focus();
      return false;
    });
    $('.add_extra_row').click(function() {
      var html = P.user_careers_profile.defaultExtraFields('extracurriculars');
      $(this).before(html);
      $($(this).prev().find('input')[0]).focus();
      return false;
    });
    $('.add_skill_row').click(function() {
      var html = '\
          <div class="profile_row add_another clearfix" data-field-array="skills_list_tmp"> \
            <select style="width:150px;" data-subfield="name">' + P.user_careers_profile.generateSkillList() + '</select> \
            <select style="width:100px;" data-subfield="years">' + P.user_careers_profile.generateYearList('1') + '</select> \
            <i class="icon-remove-sign remove_button show_for_edit" onclick="$(this).closest(\'.profile_row\').remove();"></i> \
          </div>';
      $(this).before(html);
      return false;
    });
    $('.view_as_company').click(function() {
      PA.call_pj("user_profile.get_public_profile", {user_id:P.user_careers_profile.user.id}, null, function(data) {
         if (data["company_status"]) {
           var updater_id = data["company_status"]["updater"];
           if (COMPANY_USERS[updater_id]) {
             data["company_status"]["updater"] = COMPANY_USERS[updater_id].name;
           }
        }
        P.user_careers_profile.profileData = data;
        P.user_careers_profile.showProfile(P.user_careers_profile.profileData, true);
      }, function(err){alert(err);})
      return false;
    });
    $('.stop_view_as_company').click(function(){
      P.user_careers_profile.profileData = null;
      P.user_careers_profile.showMyProfile();
      return false;
    });
    $('.publish_profile').click(function() {
      var params = {set:{"profile_settings.published":true}};
      if (!P.user_careers_profile.profileData.profile_settings.company_see)
        params.set["profile_settings.company_see"] = true;
      if (!P.user_careers_profile.profileData.profile_settings.any_see)
        params.set["profile_settings.any_see"] = true;
      if (!P.user_careers_profile.profileData.profile_settings.company_profile)
        params.set["profile_settings.company_profile"] = true;
      P.user_careers_profile.updateProfile(params);
      return false;
    });
    $('.unpublish_profile').click(function() {
      P.user_careers_profile.updateProfile({unset:{"profile_settings.published":true}});
      return false;
    });
    $('.edit_settings').click(function() {
      P.user_careers_profile.editCareersSettings();
      return false;
    });
    $(".archive").click(function() {
      if (typeof(COMPANY_USER_ID) === 'undefined') return false;
      var userId = $("#careers_profile").attr("uid");
      var method = "company.archive_profile";
      if (P.user_careers_profile.profileData.archived.exist(COMPANY_USER_ID))
        method = "company.unarchive_profile";
      PA.call_pj(method, {user_id: userId}, $("#user_profile_wrapper"), function(data) {
        if (method == "company.archive_profile") {
          $("#" + userId).remove();
          $('.archive_icon, .archive_icon_small, .archive').addClass('active');
          $('.archive_text').text('Un-archive Profile');
          P.user_careers_profile.profileData.archived.push(COMPANY_USER_ID);
        } else {
          $('.archive_icon, .archive_icon_small, .archive').removeClass('active');
          $('.archive_text').text('Archive Profile');
          P.user_careers_profile.profileData.archived = [];
        }
      }, function(err){
        alert(err);
      });
      return false;
    });
    $(".favorite").click(function() {
      var method = "favorite_profile";
      if ($('.favorite_text').html() == "Unfavorite")
        method = "unfavorite_profile";
      var userId = $("#careers_profile").attr("uid");
      PA.call_pj("company."+method, {user_id: userId, company_id:INTERNAL_ID}, 1, function(data) {
        PEM.fire("toggleFavorite", {userId: userId, method: method});
      }, function(err){
        alert(err);
      });
      if (method == "favorite_profile") {
        $(".profile_who .favorite_icon, .favorite").addClass('active');
        $('.favorite_text').html("Unfavorite");
      }
      else {
        $(".profile_who .favorite_icon, .favorite").removeClass('active');
        $('.favorite_text').html("Favorite");
      }
      return false;
    });
    $('.favorite_link').click(function() {
      var method = "favorite_profile";
      if ($(".favorite_text").html() == "Unfavorite")
        method = "unfavorite_profile";
      var userId = $("#careers_profile").attr("uid");
      PA.call_pj("company."+method, {user_id: userId, company_id:INTERNAL_ID}, 1, function(data) {
        PEM.fire("toggleFavorite", {userId: userId, method: method});
      }, function(err){
        alert(err);
      });
      if (method == "favorite_profile") {
        $(".profile_who .favorite_icon, .favorite").addClass('active');
        $(".favorite_text").html("Unfavorite");
      }
      else {
        $(".profile_who .favorite_icon, .favorite").removeClass('active');
        $(".favorite_text").html("Favorite");
      }
      return false;
    });
    $(".archive").click(function(){
      var method = "archive";
      if ($(".archive_text").html() == "Unarchive Profile")
          method = "un_archive";
      if (method == "archive") {
        $(".archive").addClass("active");
        $(".archive_text").html("Unarchive Profile");
      }
      else {
        $(".archive").removeClass("active");
        $(".archive_text").html("Archive Profile");
      }
      return false;
    });
    $('.remove_fast_actions_tips').click(function(){
      $(this).parent().parent().hide();
      PA.markSeenCompany("fast_actions");
      return false;
    });
    $(".send_message").click(function() {
      var cName = false;
      if (typeof(COMPANY_NAME) != 'undefined')
        cName = COMPANY_NAME;
      var params = {
        uid: P.user_careers_profile.profileData.user_id,
        name: P.user_careers_profile.profileData.name,
        companyName: cName
      };
      PEM.fire("showSendMessageModal", params);
      return false;
    });
    $(".see_messages").click(function() {
      PA.call_pj("company.get_conversation", {user_id: P.user_careers_profile.profileData.user_id}, 1, function(data) {
        var params = {
          withName: data.with_name,
          messages: data.messages
        }
        PEM.fire("showConversationModal", params);
      });
      return false;
    });
    $('.profile_text_input.new_class').keypress(function(e) {
      if(e.which == 13) {
        // add new class
        var term = $(this).attr("term");
        var where = "courses_stud";
        if ($(this).attr("ista") == "yes") where = "courses_inst";
        var data = {name:$(this).val()};
        var key = where + "." + term;
        var mySet = {};
        mySet[key] = data;
        P.user_careers_profile.updateProfile({add_to_set:mySet});
        return false;
      }
    });
    $('.delete_existing_class').click(function(){
      var me = $(this);
      var data = {};
      if (me.attr('cn').length > 0) data.cn = me.attr('cn');
      if (me.attr('name').length > 0) data.name = me.attr('name');
      if (me.attr('type').length > 0) data.type = me.attr('type');
      var key = "courses_stud";
      if (me.attr('ista') == "yes") key = "courses_inst";
      key += "." + me.closest(".profile_section").attr("term");
      mySet = {};
      mySet[key] = data;
      P.user_careers_profile.updateProfile({pull:mySet});
      return false;
    });
    $('.add_new_class').click(function(){
      $(this).hide();
      $(this).parent().find('.adding_class').show();
    });
    $('.add_new_term_class').click(function(){
      var me = $(this);
      var term = me.closest(".adding_class").find(".adding_class_term").val();
      var where = "courses_stud";
      if (me.attr("ista") == "yes") where = "courses_inst";
      var data = {name:me.closest(".adding_class").find(".profile_text_input").val()};
      var key = where + "." + term;
      var mySet = {};
      mySet[key] = data;
      P.user_careers_profile.updateProfile({add_to_set:mySet});
      return false;
    });
    $('.upload_resume_link').click(function(){
      $('#upload_form_file').click();
      return false;
    });
    $('.close_privacy_msg').click(function(){
      $(this).closest(".message").remove();
      PA.markSeenUnseen("prof_priv");
    });
    $('.request_resume').click(function(){
      var userId = $("#careers_profile").attr("uid");
      var _this = this;
      if (typeof(INTERNAL_ID) != 'undefined') {
        var params = {user_id: userId, company_id:INTERNAL_ID};
        if ($('.request_resume_as').hasClass("anon"))
          params.config = {anonymous:true};
        PA.call_pj("careers_company.request_resume", params, 1, function(data) {
          $(_this).replaceWith("Resume requested!");
          $('.request_resume_as').addClass("disabled");
          $('.request_resume_as').unbind();
          var prof = P.user_careers_profile.profileData;
          if (!prof.resume_req) prof.resume_req = {};
          prof.resume_req[INTERNAL_ID] = 1;
        }, function(err){
          alert(err);
        });
      }
      return false;
    });
    $('.show_tagging').click(function(){
      $(this).closest('.careers_tagging').find('.tagging_wrapper').show();
      $(this).hide();
      $('.hide_tagging').show();
      $('.profile_company_tag_list').hide();
      return false;
    });
    $('.hide_tagging').click(function(){
      $(this).closest('.careers_tagging').find('.tagging_wrapper').hide();
      $(this).hide();
      $('.show_tagging').show();
      if (!P.user_careers_profile.profileData.company_tags || P.user_careers_profile.profileData.company_tags.length == 0)
        $('.profile_company_tag_list').hide();
      else {
        var html = '';
        for (var i = 0; i < P.user_careers_profile.profileData.company_tags.length; i++) {
          html += '<li><a href="#" class="tag folder selected" onclick="return false;">' + P.user_careers_profile.profileData.company_tags[i] + '</a></li>';
        }
        $(".selected_tags").html(html);
        $('.profile_company_tag_list').show();
      }
      return false;
    });
    $('.create_new_tag').click(function(){
      var tag = $(this).parent().find('.new_tag_textbox').val();
      if (tag) {
        $(this).parent().find('.new_tag_textbox').val('');
        var prof = P.user_careers_profile.profileData;
        if (!prof.company_tags) prof.company_tags = [];
        prof.company_tags.push(tag);
        PA.call_pj("careers_company.update_profile_tag", {tags: prof.company_tags, internal_id:INTERNAL_ID, uid:prof.user_id}, null);
        $('.tag_list_profile').append('<li class="li_tag_wrapper" tag="' + tag + '"><a href="#" class="tag folder selected" onclick="return P.user_careers_profile.toggleTag(this);">' + tag + '</a></li>');
        $('.tag_list_modal').append('<li class="li_tag_wrapper" tag="' + tag + '"><a href="#" class="tag folder" onclick="return false;">' + tag + '</a> <a href="#" onclick="return P.user_careers_profile.deleteTag(this);">Remove</a></li>');
        PA.call_pj("careers_company.update_tag", {tag: tag, internal_id:INTERNAL_ID}, null, function(data) {
          COMPANY_TAGS = data.sort();
        });
      }
    });
    $('.create_new_tag_pure').click(function(){
      var tag = $(this).parent().find('.new_tag_textbox').val();
      if (tag) {
        $(this).parent().find('.new_tag_textbox').val('');
        var prof = P.user_careers_profile.profileData;
        if (!prof.company_tags) prof.company_tags = [];
        prof.company_tags.push(tag);
        PA.call_pj("careers_company.update_profile_tag", {tags: prof.company_tags, internal_id:INTERNAL_ID, uid:prof.user_id}, null);
        $('.tag_list_profile').append('<li class="li_tag_wrapper" tag="' + tag + '"><a href="#" class="tag folder selected" onclick="return P.user_careers_profile.toggleTag(this);">' + tag + '</a></li>');
        $('.tag_list_modal').append('<li class="li_tag_wrapper" tag="' + tag + '"><a href="#" class="tag folder" onclick="return false;">' + tag + '</a> <a href="#" onclick="return P.user_careers_profile.deleteTag(this);">Remove</a></li>');
        PA.call_pj("careers_company.update_tag", {tag: tag, internal_id:INTERNAL_ID}, null, function(data) {
          COMPANY_TAGS = data.sort();
        });
      }
    });
    $('.download_resume').click(function() {
      PA.call_pj("user_profile.company_download_resume", {uid:$(this).attr("uid")}, 1);
      params = {
        message: "resume",
        uid: $(this).attr("uid"),
        link: $(this).attr("href"),
        event: "careers.profile_info_link",
        from: "profile"
      }
      var prof = P.user_careers_profile.profileData;
      if (typeof(INTERNAL_ID) != 'undefined' && prof.resume_req && prof.resume_req[INTERNAL_ID]) params.message = "resume req";
      PA.call_pj("generic.event_to_requests", params,1);
    });
    $(".profile_info_link").click(function() {
      var uid = $(this).closest("#careers_profile").attr("uid");
      if (!uid) return;
      params = {
        message: $(this).attr('ltype'),
        uid: $(this).closest("#careers_profile").attr("uid"),
        link: $(this).attr("href"),
        event: "careers.profile_info_link",
        from: "profile"
      }
      PA.call_pj("generic.event_to_requests", params,1);
    });
    $(".status_value").unbind().change(function() {
      var new_status = $("#careers_profile[uid=" + P.user_careers_profile.profileData.user_id + "] .status_value").val();
      PA.call_pj("careers_company.update_candidate_status", {user_id:P.user_careers_profile.profileData.user_id , status:new_status, update_if_set: 1}, 1, function(data) {
        P.user_careers_profile.profileData.company_status = data;
        var status = data.status;
        var updater = data.updater;
        var params = {
          status: status,
          updater: updater,
          user_id: P.user_careers_profile.profileData.user_id
        }
        PEM.fire("updateCandidateStatus", params);

      },function(err){
        alert(err);
      });
    });
    if (P.user_careers_profile.profileData.company_status && P.user_careers_profile.profileData.company_status.status) {
      $('.status_value').val(P.user_careers_profile.profileData.company_status.status);
    }
    $(".tipsy").remove(); // remove all tipsy messages
    $('[tipsy]').tipsy({gravity: 'n', html: true, title:"tipsy"});
    var buttons = PEM.callFirstTrue("studentProfilePrevNext");
    if (buttons && !buttons.p) $('.profile_nav_btn_previous').addClass("disabled");
    if (buttons && !buttons.n) $('.profile_nav_btn_next').addClass("disabled");
    $('.profile_nav_btn_previous').unbind().click(function(){
      PEM.fire("studentProfilePrevNext", -1);
      return false;
    });
    $('.profile_nav_btn_next').unbind().click(function(){
      PEM.fire("studentProfilePrevNext", 1);
      return false;
    });
    $('.add_profile_note').click(function(){
      $(this).hide();
      $(this).siblings('.action_note_edit').show();
      return false;
    });
    $('.cancel_profile_note').click(function(){
      var top = $(this).closest('.action_note_edit');
      top.hide();
      top.siblings('.add_profile_note').show();
      return false;
    });
    $('.save_profile_note').click(function(){
      var top = $(this).closest('.action_note_edit');
      var note = top.find('.company_actions_note').val();
      var when = top.attr("when");
      var params = {
        internal_id:INTERNAL_ID,
        uid:P.user_careers_profile.profileData.user_id,
        note:note
      };
      if (when)
        params.update = when;
      PA.call_pj("careers_company.add_update_profile_note", params, null, function(data) {
        if (when) {
          // update note here
          top.siblings('.add_profile_note').html('&ldquo;' + note + '&rdquo; <a href="#" class="edit_profile_note">Edit</a>');
          top.siblings('.add_profile_note').show();
          top.hide();
        } else {
          // add note here
          // actually need to refresh the whole thing
          var pd = P.user_careers_profile.profileData;
          if (!pd.company_log) pd.company_log = [];
          pd.company_log.push({
              who:COMPANY_USER_ID,
              note:note,
              when:parseInt(data),
              action:"note"
          });
          if ($('#user_profile_wrapper_modal').is(':visible'))
            P.user_careers_profile.showProfile(P.user_careers_profile.profileData, true, false, '#user_profile_wrapper_modal', true);
          else
            P.user_careers_profile.showProfileToCompany(pd);
        }
      });
      return false;
    });
    if (!PA.isSeenCompany("fast_actions")) $('.fast_actions_tips').show();
  },
  toggleTag: function(me) {
    var prof = P.user_careers_profile.profileData;
    if (!prof.company_tags) prof.company_tags = [];
    var tag = $(me).text();
    $(".tag_library li a").each(function() {
      if ($(this).text() == tag) {
        if ($(me).hasClass("active"))
          $(this).removeClass("active");
        else
          $(this).addClass("active");
        return false;
      }
    });
    if ($(me).hasClass("active")) {
      $(me).remove();
      prof.company_tags.remove(tag);
    } else {
      $(me).addClass("active");
      prof.company_tags.push(tag);
    }
    PA.call_pj("careers_company.update_profile_tag", {tags: prof.company_tags, internal_id:INTERNAL_ID, uid:prof.user_id}, null);
    return false;
  },
  toggleTagFromLibrary: function(me) {
    if ($(".tag_library").hasClass("edit_mode"))
      return false;
    var prof = P.user_careers_profile.profileData;
    if (!prof.company_tags) prof.company_tags = [];
    var tag = $(me).text();
    if ($(me).hasClass("active")) {
      $(me).removeClass("active");
      prof.company_tags.remove(tag);
      $("#selected_user_tags li").each(function() {
        if ($(this).find("a").text() == tag)
          $(this).find("a").remove();
      });
      PA.call_pj("careers_company.update_profile_tag", {tags: prof.company_tags, internal_id:INTERNAL_ID, uid:prof.user_id}, null);
    } else {
      $(me).addClass("active");
      P.user_careers_profile.addTag(tag)
    }
    return false;
  },
  deleteTag: function(me) {
    var tag = $(me).parent().parent().text();
    var prof = P.user_careers_profile.profileData;
    if (!prof.company_tags) prof.company_tags = [];
    prof.company_tags.remove(tag);
    $('#selected_user_tags li').each(function(){
      if ($(this).text() == tag) $(this).remove();
    });
    $(me).parent().parent().parent().remove();
    PA.call_pj("careers_company.update_tag", {tag: tag, internal_id:INTERNAL_ID, remove:true}, null, function(data) {
      COMPANY_TAGS = data.sort();
    });
    PA.call_pj("careers_company.update_profile_tag", {tags: prof.company_tags, internal_id:INTERNAL_ID, uid:prof.user_id}, null);
  },
  addTag: function(tagName) {
    var prof = P.user_careers_profile.profileData;
    if (!prof.company_tags) prof.company_tags = [];
    $(".tags_autocomplete").hide();
    $("#add_tags").val('');
    $(".tag_library li a").each(function() {
      if ($(this).text() == tagName) {
        $(this).addClass("active");
      }
    });
    if  (prof.company_tags.exist(tagName))
      return false;
    prof.company_tags.push(tagName);
    PA.call_pj("careers_company.update_profile_tag", {tags: prof.company_tags, internal_id:INTERNAL_ID, uid:prof.user_id}, null);
    var tagExists = false;
    $("#selected_user_tags li").each(function() {
      if ($(this).find("a").text() == tagName) {
        $(this).find("a").addClass("active");
        tagExists = true;
      }
    });
    if (!tagExists)
      $("#add_tags_input").before('<li><a href="#" class="careers_tag active" onclick="return P.user_careers_profile.toggleTag(this);">' + tagName + '</a></li>');
    PA.call_pj("careers_company.update_tag", {tag: tagName, internal_id:INTERNAL_ID}, null, function(data) {
      if (typeof(COMPANY_TAGS) != 'undefined' && !COMPANY_TAGS.exist(tagName)) {
        $(".start_manage_tag_toggle").before('<li><a href="#" class="careers_tag active" onclick="return P.user_careers_profile.toggleTagFromLibrary(this);">' + tagName + '<span class="remove_tag_wrap"><i class="icon-remove-sign remove_tag" onclick="return P.user_careers_profile.deleteTag(this);"></i></span></a></li>');
      } else {
      }
      COMPANY_TAGS = data.sort();
    });
  },
  startUpload: function() {
    P.user_careers_profile.uploading = true;
    $.blockUI();
    $('#upload_form').submit();
  },
  onUploadComplete: function() {
    if (!P.user_careers_profile.uploading) return false;
    P.user_careers_profile.uploading = false;
    $.unblockUI();
    var content = $('#hidden-upload-frame-ucp').contents().find('body').html();
    P.user_careers_profile.profileData.resume = content;
    P.user_careers_profile.showProfile(P.user_careers_profile.profileData);
  },
  editCareersSettings: function() {
    if (P.user_careers_profile.profileData)
      P.user_careers_profile.editCareersSettingsShow();
    else {
      P.user_careers_profile.loadMyProfile(P.user_careers_profile.editCareersSettingsShow);
    }
  },
  editCareersSettingsShow: function() {
    if ($('#edit_profile_settings').length > 0)
      $('#edit_profile_settings').modal('show');
    else {
      $('#user_profile_wrapper').append(P.user_careers_profile.settingsTemplate({profile:P.user_careers_profile.profileData}));
      $('#edit_profile_settings .submit').click(function(){
        P.user_careers_profile.saveSection($('#edit_profile_settings'));
        $('#edit_profile_settings').modal('hide');
        return false;
      });
      $('#edit_profile_settings').modal('show');
    }
  },
  defaultExtraFields: function(type) {
    return '<div class="profile_sub_section add_section" data-field-array="' + type + '"> \
            <input type="text" class="profile_text_input full_width_input show_for_edit" placeholder="What was your title?" data-subfield="title"> \
            <input type="text" class="profile_text_input full_width_input show_for_edit" placeholder="Where did you do this?" data-subfield="where"> \
            <input type="text" class="profile_text_input full_width_input show_for_edit" placeholder="When did you do this?" data-subfield="when"> \
            <textarea rows="5" class="profile_textarea show_for_edit" placeholder="What did you do?" data-subfield="what"></textarea> \
            <a href="#" class="show_for_student action_link delete_button show_for_edit right_align" onclick="$(this).closest(\'.profile_sub_section\').remove();">delete section</a> \
        </div>';
  },
  saveSection: function(top) {
    noShow = false;
    if (top.top) {
      noShow = top.noShow;
      top = top.top;
    }
    var text = top.find("input[data-field][type=text], input[data-field][type=hidden]");
    var textarea = top.find("textarea[data-field]");
    var radio = top.find("input[data-field][type=radio]:checked");
    var check = top.find("input[data-field][type=checkbox]");
    var select = top.find("select[data-field]");
    var arr = top.find("input[data-field-array][type=text], input[data-field-array][type=hidden], textarea[data-field-array]");
    var arr_a = top.find("a[data-field-array]");
    var divs = top.find("div[data-field-array]");
    var params = {set:{},div_id:top.attr("id")};
    for (var i = 0; i < text.length; i++) {
      var e = $(text[i]);
      params.set[e.attr('data-field')] = e.val();
    }
    for (var i = 0; i < textarea.length; i++) {
      var e = $(textarea[i]);
      params.set[e.attr('data-field')] = e.val();
    }
    for (var i = 0; i < select.length; i++) {
      var e = $(select[i]);
      var val = e.val();
      var key = e.attr('data-field');
      if (key == "school_id") {
        // find it in the array
        for (var i = 0; i < P.user_careers_profile.profileData.schools.length; i++) {
          if (P.user_careers_profile.profileData.schools[i].id == val) {
            key = "school";
            val = P.user_careers_profile.profileData.schools[i].name;
          }
        }
      }
      params.set[key] = val;
    }
    for (var i = 0; i < radio.length; i++) {
      var e = $(radio[i]);
      var key = e.attr('data-field');
      var val = e.attr('value');
      if (params.set[key]) val = val + ", " + params.set[key];
      params.set[key] = val;
    }
    for (var i = 0; i < check.length; i++) {
      var e = $(check[i]);
      if (e.attr('checked'))
        params.set[e.attr('data-field')] = true;
      else
        params.set[e.attr('data-field')] = false;
    }
    for (var i = 0; i < arr_a.length; i++) {
      var e = $(arr_a[i]);
      var field = e.attr('data-field-array');
      if (!params.set[field]) params.set[field] = [];
    }
    for (var i = 0; i < arr.length; i++) {
      var e = $(arr[i]);
      var field = e.attr('data-field-array');
      if (!params.set[field]) params.set[field] = [];
      if (e.val())
        params.set[field].push(e.val());
    }
    for (var i = 0; i < divs.length; i++) {
      var e = $(divs[i]);
      var arrField = e.attr('data-field-array');
      if (!params.set[arrField]) params.set[arrField] = [];
      // now create hashmap
      var map = {};
      var sub = e.find("[data-subfield]");
      var nr = 0;
      for (var j = 0; j < sub.length; j++) {
        var f = $(sub[j]);
        if ((f.attr("type") == "radio" || f.attr("type") == "checkbox") && !f.attr("checked")) continue;
        if (f.val()) {
          map[f.attr('data-subfield')] = f.val();
          if (f.prop("tagName") != "SELECT" || arrField == "skills_list_tmp") nr += 1;
        }
      }
      if (nr > 0) params.set[arrField].push(map);
    }
    if (params.set.skills_list_tmp) {
      // generate skills_list and skills_hash
      var skillsList = [];
      var skillsHash = {};
      for (var i = 0; i < params.set.skills_list_tmp.length; i++) {
        var e = params.set.skills_list_tmp[i];
        skillsList.push(e.name);
        var normalized = e.name.toLowerCase().replace(/[^\w]/g, "_");
        skillsHash[normalized] = e;
      }
      delete params.set.skills_list_tmp;
      params.set.skills_list = skillsList;
      params.set.skills_hash = skillsHash;
    }
    P.user_careers_profile.updateProfile(params, noShow);
  },
  setUser: function(user) {
    P.user_careers_profile.user = user;
    if (typeof(LOAD_MY_PROFILE) != 'undefined') P.user_careers_profile.showMyProfile();
  },
  loadMyProfile: function(callback) {
    if (!P.user_careers_profile.profileData && !P.user_careers_profile.user.isPublic) {
      P.modules.getData("user_profile", 1, function(data){
        P.user_careers_profile.profileData = data;
        P.user_careers_profile.prepareProfile(data);
        PEM.fire("profileChange", data);
        if (callback) callback.call(window, data);
      });
      return false;
    }
    return P.user_careers_profile.profileData;
  },
  showMyProfile: function() {
    //if (P.user_careers_profile.user.isInst && !P.user_careers_profile.user.isTA) return;
    PEM.fire("cleanDashboard");
    $('#student_careers_navbar li').removeClass('active');
    if (!P.user_careers_profile.profileData) {
      PA.call_pj("user_profile.get_profile", {}, null, function(data){
        P.user_careers_profile.profileData = data;
        PEM.fire("profileChange", data);
        P.user_careers_profile.showProfile(P.user_careers_profile.profileData);
      }, function(err){alert(err);});
      return;
    }
    P.user_careers_profile.showProfile(P.user_careers_profile.profileData);
  },
  showCustomProfile: function(uid) {
    PEM.fire("cleanDashboard");
    $('#student_careers_navbar li').removeClass('active');
    PA.call_pj("user_profile.get_public_profile", {user_id:uid}, null, function(data){
        if (data["company_status"]) {
          var updater_id = data["company_status"]["updater"];
          if (COMPANY_USERS[updater_id]) {
            data["company_status"]["updater"] = COMPANY_USERS[updater_id].name;
          }
        }
      P.user_careers_profile.profileData = data;
      PEM.fire("profileChange", data);
      P.user_careers_profile.showProfile(P.user_careers_profile.profileData, true);
    }, function(err){alert(err);});
  },
  showCustomProfileModal: function(uid) {
    var from = "discover";
    if (typeof(LOAD_PROFILE) != 'undefined' && LOAD_PROFILE) from = "link";
    var params = {user_id:uid, from:from};
    if (typeof(DEBUG_PARAMS) != 'undefined') {
      params.debug = DEBUG_PARAMS;
      if (DEBUG_PARAMS.from) params.from = DEBUG_PARAMS.from;
    }
    LOAD_PROFILE = false;
    PA.call_pj("user_profile.get_public_profile", params, null, function(data){
         if (data["company_status"]) {
           var updater_id = data["company_status"]["updater"];
           if (COMPANY_USERS[updater_id]) {
             data["company_status"]["updater"] = COMPANY_USERS[updater_id].name;
           }
         }
      P.user_careers_profile.profileData = data;
      PEM.fire("profileChange", data);
      P.user_careers_profile.showProfile(P.user_careers_profile.profileData, true, false, '#user_profile_wrapper_modal', true);
      setTimeout(function() {
        $('#user_profile_wrapper_modal').scrollTop(0);
      }, 200);
      $('#user_profile_modal').modal('show');
      $('.user_profile_modal_title').text(P.user_careers_profile.profileData.name);
      $('#back_to_company_wrapper').hide();
    }, function(err){alert(err);});
  },
  detectWebsite: function(url, type) {
    if (!url) return "";
    url = url.trim();
    var actualUrl = url;
    if (url.indexOf(".") > 0 && url.toLowerCase().indexOf("http") != 0)
      actualUrl = "http://" + url;
    if (actualUrl.toLowerCase().indexOf("http") == 0) {
      return "<a href='" + actualUrl + "' class='profile_info_link' ltype='" + type + "' target='_blank'>" + url + "</a>";
    }
    return url;
  },
  prepareProfile: function(data) {
    var testForValue = function(hash) {
      var hasValue = false;
      for (var i in hash) {
        if (hash[i] && i != "email") {
          hasValue = true;
          break;
        }
      }
      return hasValue;
    }
    var total = 100;
    if (!data.contact) data.contact = {};
    if (!testForValue(data.contact)) {data.noContact = true; total -= 10;}
    if (!data.academics) data.academics = {};
    if (!testForValue(data.academics)) {data.noAcademics = true;total -= 10;}
    if (!data.archived) data.archived = [];
    if (!data.awards) data.awards = [];
    if (data.awards.length == 0) {data.noAwards = true;total -= 10;}
    if (!data.work) data.work = [];
    if (data.work.length == 0) {data.noWork = true;total -= 10;}
    if (!data.research) data.research = [];
    if (data.research.length == 0) {data.noResearch = true;total -= 10;}
    if (!data.side_projects) data.side_projects = [];
    if (data.side_projects.length == 0) {data.noSideProjects = true;total -= 10;}
    if (!data.extracurriculars) data.extracurriculars = [];
    if (data.extracurriculars.length == 0) {data.noExtracurriculars = true;total -= 10;}
    if (!data.skills_list) data.skills_list = [];
    if (!data.skills_hash) data.skills_hash = {};
    if (data.skills_list.length == 0) {data.noSkills = true;total -= 10;}
    if (!data.links) data.links = {};
    if (!testForValue(data.links)) {data.noLinks = true;total -= 10;}
    if (data.noLinks && data.contact.website) {data.noLinks = false;total += 10}
    if (!data.about_me) {data.about_me = "";total -= 10;}
    if (!data.profile_settings) data.profile_settings = {};
    if (!data.companies) data.companies = [];
    if (total <= 0) total = 10;

    if (!data.academics.grad_year) data.noGradYear = true;
    if (!data.academics.major) data.noMajor = true;
    if (!data.academics.program) data.noProgram = true;
    if (data.noGradYear || data.noProgram) data.noGradYearOrProgram = true;
    if (!data.contact.website || !data.links.linkedin || !data.resume) data.noResumeOrLink = true;

    if (data.schools)
      data.schools.sort(function(a,b){ if(a.name>b.name) return 1; if (a.name<b.name) return -1; return 0;})
    data.allEmails = data.contact.email;
    if (!data.allEmails) data.allEmails = data.email;
    data.allEmails2 = data.allEmails;
    if (typeof(data.emails) == "string") {
      data.allEmails = data.emails.replace(/["\[\]]/g, "").replace(/,/g, "<br/>").trim();
      data.allEmails2 = data.emails.replace(/["\[\]]/g, "").trim();
    }
    if (typeof(data.emails) == "object" && data.emails.join) {
      data.allEmails = data.emails.join("<br/>");
      data.allEmails2 = data.emails.join(", ");
    }
    if (data.contact.custom_email) {
      data.allEmails = data.contact.custom_email.replace(/,/g, "<br/>").trim();
      data.allEmails2 = data.contact.custom_email;
    }
    // make links
    data.contact.WS = P.user_careers_profile.detectWebsite(data.contact.website, 'website');
    data.links.FB = P.user_careers_profile.detectWebsite(data.links.facebook, 'facebook');
    data.links.LI = P.user_careers_profile.detectWebsite(data.links.linkedin, 'linkedin');
    data.links.TW = P.user_careers_profile.detectWebsite(data.links.twitter, 'twitter');
    data.links.GI = P.user_careers_profile.detectWebsite(data.links.github, 'github');
    data.links.SO = P.user_careers_profile.detectWebsite(data.links.stackoverflow, 'stackoverflow');
    data.profileProgress = total;
    if (total < 25) data.profileProfessLessThan25 = true;
    if (data.photo) {
      if (data.photo.indexOf("_35.png") > 0) {
        data.photo = data.photo.replace("_35.png", "") + "_100.png";
      }
      data.imagePath = 'https://d1b10bmlvqabco.cloudfront.net/photos/' + data.user_id + '/' + data.photo;
    } else if (data.facebook_id)
      data.imagePath = 'https://graph.facebook.com/' + data.facebook_id + '/picture?type=square';

    var program = data.academics.program;
    if (program && program.toLowerCase() == "grad") data.academics.program = "Graduate";
    if (program && program.toLowerCase() == "undergrad") data.academics.program = "Undergraduate";

    data.skillsList = [];
    for (var i = 0; i < data.skills_list.length; i++) {
      var skill = data.skills_list[i].toLowerCase().replace(/[^\w]/g, "_");
      if (data.skills_hash[skill])
        data.skillsList.push(data.skills_hash[skill]);
    }
    // prepare courses
    if (!P.user_careers_profile.termOrderHash) {
      P.user_careers_profile.termOrderHash = {};
      for (var i = 0; i < P.user_careers_profile.termOrder.length; i++) {
        P.user_careers_profile.termOrderHash[P.user_careers_profile.termOrder[i]] = i;
      }
    }
    var hasTAed = false;
    if (data.courses_inst) {
      var arr = [];
      for (var term in data.courses_inst) {
        var classes = data.courses_inst[term];
        if (!term) term = "Other";
        if (classes.length > 0) {
          var company_profile_id = "";
          if (typeof(INTERNAL_ID) != 'undefined')
            company_profile_id = INTERNAL_ID;
          classes = $.map(classes, function(class_obj) {return {"company_profile_id": company_profile_id, "cn": class_obj.cn, "name": class_obj.name, "cn_esc": escape(class_obj.cn), "name_esc": escape(class_obj.name), "type": class_obj.type, "term": escape(term), "school": escape(data.school)}});
          arr.push({term:term, nr:P.user_careers_profile.termOrderHash[term], classes:classes});
          hasTAed = true;
        }
      }
      arr.sort(function(a,b){return a.nr - b.nr;});
      data.coursesInst = arr;
    }
    data.hasTAed = hasTAed;
    var hasStudded = false;
    if (data.courses_stud) {
      var arr = [];
      for (var term in data.courses_stud) {
        var classes = data.courses_stud[term];
        if (!term) term = "Other";
        if (classes.length > 0) {
          var company_profile_id = "";
          if (typeof(INTERNAL_ID) != 'undefined')
            company_profile_id = INTERNAL_ID;
          classes = $.map(classes, function(class_obj) {return {"company_profile_id": company_profile_id, "cn": class_obj.cn, "name": class_obj.name, "cn_esc": escape(class_obj.cn), "name_esc": escape(class_obj.name), "type": class_obj.type, "term": escape(term), "school": escape(data.school)}});
          arr.push({term:term, nr:P.user_careers_profile.termOrderHash[term], classes:classes});
          hasStudded = true;
        }
      }
      arr.sort(function(a,b){return a.nr - b.nr;});
      data.coursesStud = arr;
    }
    data.hasStudded = hasStudded;
    if (typeof(COMPANY_PROFILE) != 'undefined') data.onCompany = true;
  },
  showProfile: function(data, asCompany, noShow, id, forCompany) {
    data.me = false;
    if (!id) id = '#user_profile_wrapper';
    if (P.user_careers_profile.user)
      data.me = (data.user_id === P.user_careers_profile.user.id);
    if (asCompany && !data.me) asCompany = false;
    if (asCompany) data.me = false;
    data.notMe = !data.me;
    data.asCompany = asCompany;
    var showPrivacyMessage = false;
    var forStudent = true;
    if (forCompany) forStudent = false;
    var canAdmin = false;
    if (typeof(CAN_ADMIN) != 'undefined' && CAN_ADMIN) canAdmin = true;

    P.user_careers_profile.prepareProfile(data);
    if (!noShow) {
      var user = P.user_careers_profile.user;
      if (data.me && user && user.config.seen_message && !user.config.seen_message.exist("prof_priv")) {
        showPrivacyMessage = true;
      }
      var req = false;
      var reqAnon = false;
      var myid = "";
      if (typeof(INTERNAL_ID) != 'undefined' && data.resume_req_arr && data.resume_req_arr.exist(INTERNAL_ID + "_anon")) reqAnon = true;
      if (typeof(INTERNAL_ID) != 'undefined' && data.resume_req && data.resume_req[INTERNAL_ID]) req = true;
      if (typeof(COMPANY_USER_ID) != 'undefined') myid = COMPANY_USER_ID;
      var tags = [];
      if (typeof(COMPANY_TAGS) != 'undefined') tags = COMPANY_TAGS;
      $(id).html(P.user_careers_profile.template({
        user:user,
        profile:data,
        forStudent:forStudent,
        forCompany:forCompany,
        showPrivacy:showPrivacyMessage,
        pastTerms:P.user_careers_profile.pastTerms,
        canAdmin: canAdmin,
        allTags: tags,
        res_req:req,
        myid: myid,
        res_req_anon:reqAnon
      }));
      $(id).show();
      P.user_careers_profile.initHandlers();
      if (asCompany) {
        $('.show_for_student_preview').show();
        $('.hide_for_student_preview').hide();
        //$('.profile_actions').hide();
        if (P.user_careers_profile.profileData.noContact)
          $('.profile_contact').hide();
      } else {
        //$('.profile_actions').show();
      }
      if (!data.me && P.user_careers_profile.profileData.noContact)
        $('.profile_contact').hide();
      //if (typeof(INTERNAL_ID) != 'undefined') {
      //  if (window.history && window.history.pushState) {
      //    try {
      //      window.history.pushState({}, "User profile", "/company/" + INTERNAL_ID + "/user/" + data.user_id);
      //    } catch (err) {}
      //  }
      //}
      if (P.user_careers_profile.profileData.no_profile || P.user_careers_profile.profileData.no_info) {
        $('.hide_for_not_published').hide();
        $('.show_for_not_published').show();
      }
    }
  },
  showProfileToCompany: function(profile) {
    P.user_careers_profile.profileData = profile;
    P.user_careers_profile.prepareProfile(profile);
    P.user_careers_profile.profileData = profile;
    var req = false;
    var reqAnon = false;
    var myid = "";
    if (typeof(INTERNAL_ID) != 'undefined' && profile.resume_req_arr && profile.resume_req_arr.exist(INTERNAL_ID + "_anon")) reqAnon = true;
    if (typeof(INTERNAL_ID) != 'undefined' && profile.resume_req && profile.resume_req[INTERNAL_ID]) req = true;
    if (typeof(COMPANY_USER_ID) != 'undefined') myid = COMPANY_USER_ID;
    var canAdmin = false;
    if (typeof(CAN_ADMIN) != 'undefined' && CAN_ADMIN) canAdmin = true;
    var tags = [];
    if (typeof(COMPANY_TAGS) != 'undefined') tags = COMPANY_TAGS;
    $('#user_profile_wrapper').html(P.user_careers_profile.template({
          profile:profile,
          forCompany:true,
          fromSearch:true,
          res_req:req,
          res_req_anon:reqAnon,
          canAdmin:canAdmin,
          myid:myid,
          allTags:tags
    }));
    //if (typeof(INTERNAL_ID) != 'undefined') {
    //  if (window.history && window.history.pushState) {
    //    try {
    //      window.history.pushState({}, "User profile", "/company/" + INTERNAL_ID + "/user/" + profile.user_id);
    //    } catch (err) {}
    //  }
    //}
    P.user_careers_profile.initHandlers();
    $('.show_for_student_preview').hide();
    $(".empty_academics").hide();
    $("#company_search").hide();
    $('.back_to_search').show();
    $('#user_profile_wrapper').show();
  },
  updateProfile: function(params, noShow) {
    PA.call_pj("user_profile.update_profile", params, null, function(data) {
      P.user_careers_profile.profileData = data;
      PEM.fire("profileChange", data);
      if ($('#careers_profile').length == 0) noShow = true;
      P.user_careers_profile.showProfile(P.user_careers_profile.profileData, false, noShow);
      PEM.fire("profileChange", P.user_careers_profile.profileData);
    }, function(err){alert(err);})
  },
  generateSkillList: function(selected) {
    var html = "";
    for (var i = 0; i < P.user_careers_profile.skillList.length; i++) {
      var skill = P.user_careers_profile.skillList[i];
      html += "<option value='" + skill + "' ";
      if (selected == skill) html += "selected";
      html += ">" + skill + "</option>";
    }
    return html;
  },
  generateYearList: function(selected) {
    var html = "<option value=''>Years Exp.</option>";
    selected = parseInt(selected);
    for (var i = 1; i < 10; i++) {
      html += "<option value='" + i + "' ";
      if (selected == i) html += "selected";
      html += ">" + i + " year" + (i > 1 ? "s":"") + "</option>";
    }
    return html;
  },
  sentMessage: function() {
    $(".show_for_messages").show();
  },
  init: function(module) {
    P.user_careers_profile.template = module.template;
    PEM.addListener("showMyProfile", P.user_careers_profile.showMyProfile);
    PEM.addListener("loadMyProfile", P.user_careers_profile.loadMyProfile);
    PEM.addListener("saveSection", P.user_careers_profile.saveSection);
    PEM.addListener("editCareersSettings", P.user_careers_profile.editCareersSettings);
    PEM.addListener("showUserProfileToCompany", P.user_careers_profile.showProfileToCompany);
    PEM.addListener("showCustomProfile", P.user_careers_profile.showCustomProfile);
    PEM.addListener("showCustomProfileModal", P.user_careers_profile.showCustomProfileModal);
    PEM.addListener("sentMessage", P.user_careers_profile.sentMessage);
    PTM.getModuleTemplate("user_careers_profile", "settings", function(template) {P.user_careers_profile.settingsTemplate = template;});
    Handlebars.registerHelper('skillList', function(selected, options) {
      return P.user_careers_profile.generateSkillList(selected);
    });
    Handlebars.registerHelper('yearList', function(selected, options) {
      return P.user_careers_profile.generateYearList(selected);
    });
  }

};
P.homescreen = {
  template: null,
  user: null,
  network: null,
  seenMessages: {},
  // Messages that instructors see (in order)
  welcomeQueue: ['tips_tricks', 'first_day', 'enroll_students', 'access_code', 'enroll_inst', 'setup_course_page', 'setup_sections', 'share_piazza', 'create_class'],
  fetchCallbacks: [],

  initHandlers:function() {
    $("#enroll_members_button").click(function() {
      var members = $(".enroll_members").val();
      var params = {
        from: "groupsHomeScreen",
        id: P.homescreen.network.id,
        add_members: members,
        event: 'groups.home_sent_invites'
      };
      PA.call_pj("network.update", params, $(".homescreen_box.invite_members"), function(data) {
        $("#enroll_members_button").fadeOut(200, function() {
            $(".enroll_members_confirmation").fadeIn(200).delay(1000).fadeOut(function() {
              $("#enroll_members_button").fadeIn(200);
            });
          });
        $(".enroll_members").val("");
      }, function(err){ alert(err); });
    });
    $('.invite_members_button').click(function(e) {
      var members = $(".enroll_members").val();
      var params = {
        from: "groupsHomescreen",
        id: P.homescreen.network.id,
        add_members: members,
        event: 'groups.homescreen_sent_invites'
      };
      if ($('#customize_invite_checkbox').is(":checked"))
        params.message = $(".invite_email_text").val();
      PA.call_pj("network.update", params, $(".invite_members"), function(data) {
        $('#customize_invite_checkbox').attr('checked', false);
        $(".enroll_members").val("");
        $(".invite_email_text").hide();
        $(".customize_invite_label").fadeOut(200, function() {
          $(".enroll_mebmers_sent").fadeIn(200).delay(1500).fadeOut(function() {
            $(".customize_invite_label").fadeIn(200);
          });
        });
        }, function(err){ alert(err); });
    });
    $(".import_button.facebook").click(function() {
      PA.call_pj("generic.event_to_requests", {event: "group.invite_click_fb"}, 1);
      alert("Implementing as you click...");
    });
    $(".import_button.gmail").click(function() {
      PA.call_pj("generic.event_to_requests", {event: "group.invite_click_gmail"}, 1);
      alert("Implementing as you click...");
    });
    $('#customize_invite_checkbox').change(function() {
      if($(this).is(":checked")) {
        $(".invite_email_text").show();
        $(".invite_email_text").focus();
      } else {
        $(".invite_email_text").hide();
      }
    });
  },
  setUser: function(user) {
    P.homescreen.user = user;
  },
  setNetwork:function(network) {
    P.homescreen.network = network;
  },
  showHomeScreen: function(from) {
    if (typeof(AUTO_POST) != 'undefined' && AUTO_POST) return;
    if (typeof(SHOW_STATS) != 'undefined' && SHOW_STATS) return;
    if (typeof(CID) != 'undefined' && CID) return;
    if ($('.question_note_view').length > 0 && $('.question_note_view').html() != "") return;
    if (!P.homescreen.network || !P.homescreen.user) return;
    if (P.homescreen.network.type == "group") {
      $('#homescreen').html(P.homescreen.template({network:P.homescreen.network}));
      $('#homescreen').show();
      $('#inactive_group_message').hide();
      P.homescreen.initHandlers();
    } else {
      // either student or instructor
      if (P.homescreen.user.isPublic) {
        PTM.getModuleTemplate("homescreen", "homescreen_demo", P.homescreen.showStudent);
        return;
      }
      if (P.homescreen.user.isInst && from != "careers") {
        // check if this is not TA
        var showExp = (P.homescreen.network.total_content_prof > 15) || PA.isSeenNetwork(P.homescreen.network, "exp");
        //if (P.homescreen.user.isTA && showExp && !PA.isSeenUser('sv2014') && !P.homescreen.user.isPublic) {
        //  PTM.getModuleTemplate("homescreen", "homescreen_tech_tour", P.homescreen.showStudent);
        //} else {
          PTM.getModuleTemplate("homescreen", "homescreen_instructor", P.homescreen.showInstructor);
        //}
      } else {
        //var showCareers = false;
        //if (P.homescreen.user) {
        //  showCareers = P.homescreen.user.showCareers; // this is set by top_bar
        //}
        //if (P.homescreen.user && P.homescreen.user.config.logins > 10)
        //  PTM.getModuleTemplate("homescreen", "homescreen_careers", P.homescreen.showStudent);
        //else
        //if (showCareers) {
        //  P.homescreen.showStudentCareers1(from);
        //} else {
        //if (PA.isSeenUser('sv2014') || P.homescreen.user.isPublic)
          // PTM.getModuleTemplate("homescreen", "homescreen_student", P.homescreen.showStudent);
        PTM.getModuleTemplate("homescreen", "homescreen_feed", P.homescreen.showStudent);
        //else
        //  PTM.getModuleTemplate("homescreen", "homescreen_tech_tour", P.homescreen.showStudent);
        //}
      }
    }
  },
  maybeShowCareersStory: function() {
    var initStoryClicks = function() {
      $(".careers_feed_click").click(function() {
        var text1 = $(this).attr('iid');
        var text2 = $(this).attr('uid');
        var text3 = $(this).attr('type');
        PA.call_pj("user_profile.read_careers_story", {sid: text2, iid: text1}, 1);
        PA.call_pj("generic.page_event", {type: "careers.homscreen_story_click",text1:text1,text2:text2,text3:text3}, 1);
      });
    };
    var calcProfileProgress = function(profile) {
      var progress = 0;
      var hasLinks = false;
      if (profile.links && (profile.links.stackoverflow || profile.links.github || profile.links.website || profile.links.linkedin))
        hasLinks = true;
      profile.has_links = hasLinks;
      if (profile.has_links)
        progress += 2;
      if (profile.coding_since)
        progress += 2;
      if (profile.status)
        progress += 2;
      if (profile.visa)
        progress += 2;
      if (profile.roles && profile.roles.length > 0)
        progress += 2;
      var haveSkills = false;
      if (profile.skills && profile.skills.length > 0)
        haveSkills = true;
      if (haveSkills)
        progress += 10;
      if (profile.resume || profile.resume_internal)
        progress += 80;
      profile.progress = progress;
      P.modules.getData("careers_feed_stories", 1, function(data){
        if (P.homescreen.user.isTA) {
          PTM.getModuleTemplate("homescreen", "homescreen_feed", function(template) {
            P.top_bar.careersFeedTemplate = template;
            $('.homescreen_student_story').html(P.top_bar.careersFeedTemplate({
              network:P.homescreen.network,
              user:P.homescreen.user,
              profile:profile,
              stories:data
            }));
            initStoryClicks();
            $(".homescreen_student_story").show()
            $(".careers_homescreen_feed").show();
            $(".careers_homescreen").show();
            $(".homescreen_default").hide();
            $('.homescreen_progressbar .progress_count_number.careers').html(progress);
            $('.homescreen_progressbar .bar.careers').css("width", progress + "%");
            PA.call_pj("generic.page_event", {type: "careers.homscreen_feed_shown"}, 1);
          });
        } else {
          $('#homescreen').html(P.top_bar.careersFeedTemplate({
            network:P.homescreen.network,
            user:P.homescreen.user,
            profile:profile,
            stories:data
          }));
          initStoryClicks();
          $(".careers_homescreen").show();
          $(".careers_homescreen_feed").show();
          $(".homescreen_default").hide();
          $('.homescreen_progressbar .progress_count_number.careers').html(progress);
          $('.homescreen_progressbar .bar.careers').css("width", progress + "%");
          PA.call_pj("generic.page_event", {type: "careers.homscreen_feed_shown"}, 1);
        }
      });
    };
    var optedOut = (PA.user.config.email_prefs && PA.user.config.email_prefs.careers && PA.user.config.email_prefs.careers.no_careers);
    if ((!P.homescreen.user.isInst || P.homescreen.user.isTA) && P.homescreen.network && !optedOut) {
      // $(".homescreen_student_story").show();
      // $(".homescreen_default").hide();
      // PA.call_pj("generic.page_event", {type:"careers.homescreen_student_story"}, 1);
      // if (!PA.isSeenUser("homescreen_story2a"))
      //   PA.markSeenUnseen("homescreen_story2a");
      // var p = PEM.callFirst("loadMyProfile", calcProfileProgress);
      // if (p)
      //   calcProfileProgress(p);
      //  $(".homescreen_student_story_remove").click(function() {
      //    $(".homescreen_student_story").hide();
      //    $(".homescreen_default").show();
      //    PA.markSeenUnseen("homescreen_story2");
      //  });
      var p = PEM.callFirst("loadMyProfile", calcProfileProgress);
      if (p)
        calcProfileProgress(p);
    } else {
      $(".homescreen_default").show();
    }
  },
  showStudent: function(template) {
    var newQuestionCount = PEM.callFirst("getUnreadPosts");
    var updatedPostCount = PEM.callFirst("getUpdatedPosts");
    if(newQuestionCount === undefined) newQuestionCount = 0;
    if(updatedPostCount === undefined) updatedPostCount = 0;
    var classAtAGlanceCounts = {
      unread: newQuestionCount,
      updated: updatedPostCount
    };
    PEM.fire("hideSpecialMentions");
    $('#homescreen').html(template({
      network:P.homescreen.network,
      user:P.homescreen.user,
      classAtAGlanceCounts: classAtAGlanceCounts
    }));
    $('#homescreen').show();
    $('#homescreen .upload_resume_button').click(function(){
      $('#upload_form_file').click();
      return false;
    });
    $(".goto_my_profile").click(function() {
      PA.call_pj("generic.event_to_requests", {event: "careers.homscreen_profile_click"}, 1);
    });
    P.top_bar.careersFeedTemplate = template;
    P.homescreen.maybeShowCareersStory();
  /*
    $('.tech_tour_dismiss').click(function(){
      PA.markSeenUnseen("sv2014");
      if (!P.homescreen.user.isTA)
        PTM.getModuleTemplate("homescreen", "homescreen_student", P.homescreen.showStudent);
      else
        PTM.getModuleTemplate("homescreen", "homescreen_instructor", P.homescreen.showInstructor);
    });
    var checkProfile = function(p) {
      if (p.resume && p.last_resume_upload && p.last_resume_upload >= 1406222317) {
        $('.need_upload_resume').hide();
        $('.no_need_upload_resume').show();
      }
    };
    if (PA.user.config.sv2014) {
      $('.need_upload_resume').hide();
      $('.sv2014_apply_done').show();
    } else {
      if (!PA.isSeenUser("sv2014") && !P.homescreen.user.isPublic) {
        var p = PEM.callFirst("loadMyProfile", checkProfile);
        if (p)
          checkProfile(p);
      }
    }
    $('.apply_button').click(function(){
      window.location = "/svtechtour?step=two";
    });
  */
    // PA.call_pj("user_profile.get_careers_at_a_glance", {}, 1, function(data) {
    //   P.homescreen.events = data.events;
    //   P.homescreen.companies = data.companies;
    //   P.homescreen.searches = data.searches;
    //   P.homescreen.user_profile = data.user_profile;
    //   PTM.getModuleTemplate("homescreen", "homescreen_careers_aag", P.homescreen.showStudent);
    // }, function(err) {
    //   alert("Error: " + err);
    // });
  },
  showCareersAtAGlance: function(template) {
    // $("#careers_at_a_glance").html(template({
    //   events: P.homescreen.events,
    //   companies: P.homescreen.companies,
    //   searches: P.homescreen.searches,
    //   user_profile: P.homescreen.user_profile
    // }));
  },
  gotoCareersClass: function(nid) {
    PA.call_pj("generic.page_event", {type:"careers.homescreen_class_link"}, 1);
    P.top_bar.changeNetwork(nid);
    return false;
  },
  showStudentCareers1: function(from) {
    var p = PEM.callFirst("loadMyProfile", function(p){P.homescreen.showStudentCareers2(p, from)});
    if (p)
      P.homescreen.showStudentCareers2(p, from);
  },
  showStudentCareers2: function(profile, from) {
    PEM.fire("hideSpecialMentions");
    P.homescreen.profile = profile;
    if (P.homescreen.user.isTA && from != 'careers')
      $('.homescreen').after(P.homescreen.careersTemplate({network:P.homescreen.network, user:P.homescreen.user, profile:profile}));
    else
      $('#homescreen').html(P.homescreen.careersTemplate({network:P.homescreen.network, user:P.homescreen.user, profile:profile}));
    $('#homescreen').show();
    if (!P.homescreen.user.config.saw_careers) {
      P.homescreen.user.config.saw_careers = parseInt((new Date()).getTime() / 1000);
      PA.call_pj("user.set", {stat:"saw_careers", val:P.homescreen.user.config.saw_careers}, 1);
    }
    $('.update_profile_button').click(function(){
      PA.call_pj("generic.page_event", {type:"careers.click_profile_button"}, null, function(data){
        window.location = "/my_profile";
      });
    });
    if (!P.homescreen.allStories) {
	    P.modules.getData("career_stories_all", $('#homescreen'), function(data){
        P.homescreen.allStories = data;
        P.homescreen.showNewFeed(P.homescreen.allStories.stories, true);
      });
    } else {
      P.homescreen.showNewFeed(P.homescreen.allStories.stories, true);
    }
    $('.view_more_stories').click(function(){
      P.homescreen.showMoreFeed();
      PA.call_pj("generic.page_event", {type:"careers.view_more_stories"}, 1);
      return false;
    });
    $("#close_company_click_popover").click(function() {
      $('#company_click_popover').hide();
      if (PA.user)
        PA.markSeenUnseen("career_hs_apply_pop");
    });
    //PEM.fire("showNagbar", "#homescreen_nagbar");
  },
  showNewFeed: function(data, updateNew) {
    P.homescreen.feed = data;
    $('#all_feed_stories').html('');
    for (var i = 0; i < data.length && i < 3; i++) {
      var item = data[i];
      if (item.config.section) item.config.section = item.config.section.replace("?", "&");
      $('#all_feed_stories').append(P.homescreen.feedItemTemplate({item:item}));
    }
    if (data.length > 3)
      $('.view_more_stories').show();
    else
      $('.view_more_stories').hide();
    if (PA.user && PA.user.config && PA.user.config.seen_message && !PA.user.config.seen_message.exist("career_hs_apply_pop"))
      $("#company_click_popover").show();
    P.homescreen.initHomescreenClicks();
  },
  showMoreFeed: function() {
    if (!P.homescreen.feed) return;
    for (var i = 3; i < P.homescreen.feed.length; i++) {
      var item = P.homescreen.feed[i];
      if (item.config.section) item.config.section = item.config.section.replace("?", "&");
      $('#all_feed_stories').append(P.homescreen.feedItemTemplate({item:item}));
    }
    $('.view_more_stories').hide();
    P.homescreen.initHomescreenClicks();
  },
  initHomescreenClicks: function() {
    $(".read_more_link").unbind().click(function() {
      var id = $(this).closest(".company_story").attr("id");
      PA.call_pj("generic.page_event", {type:"careers.read_more", text1:id}, 1);
    });
    $(".homescreen_company_logo").unbind().click(function() {
      var id = $(this).closest(".company_story").attr("id");
      PA.call_pj("generic.page_event", {type:"careers.story_logo_click", text1:id}, 1);
    });
    $('.do-follow-event').unbind().click(function(){
      var eventId = $(this).attr("event");
      var internalId = $(this).attr("company");
      var _this = this;
      PA.call_pj("careers_company.follow_event", {event_id:eventId, internal_id:internalId}, null, function(data){
        for (var i = 0; i < P.homescreen.feed.length; i++) {
          if (P.homescreen.feed[i].id == eventId) {
            P.homescreen.feed[i].config.following = true;
            if (!P.homescreen.feed[i].config.followers)
              P.homescreen.feed[i].config.followers = 0;
            P.homescreen.feed[i].config.followers += 1;
            var html = P.homescreen.eventStoryTemplate({item:P.homescreen.feed[i]});
            $(_this).closest('.company_story').replaceWith(html);
            P.homescreen.initHomescreenClicks();
            break;
          }
        }
      });
    });
    $('.do-unfollow-event').unbind().click(function(){
      var eventId = $(this).attr("event");
      var internalId = $(this).attr("company");
      var _this = this;
      PA.call_pj("careers_company.unfollow_event", {event_id:eventId, internal_id:internalId}, null, function(data){
        for (var i = 0; i < P.homescreen.feed.length; i++) {
          if (P.homescreen.feed[i].id == eventId) {
            P.homescreen.feed[i].config.following = false;
            P.homescreen.feed[i].config.followers -= 1;
            var html = P.homescreen.eventStoryTemplate({item:P.homescreen.feed[i]});
            $(_this).closest('.company_story').replaceWith(html);
            P.homescreen.initHomescreenClicks();
            break;
          }
        }
      });
    });
  },
  changeResolutionOfItem: function($elt, isResolved) {
    $elt.closest('.notification_wrapper').find('.notification_icon').removeClass('green').removeClass('red').addClass(isResolved ? 'green' : 'red');
  },
  updateRelativeTimes: function() {
    $('.auto_update_time').each(function(idx) {
      var when = $(this).attr("when");
      if (when)
        $(this).html(when.toRelativeTime(3000));
    });
  },
  showInstructor: function(template) {
    PEM.fire("hideSpecialMentions");
    $('#homescreen').html(template({network:P.homescreen.network, user:P.homescreen.user}));
    $('#homescreen').show();
    // get statistics
    P.homescreen.refreshInstructorStats();
    var est = parseInt(P.homescreen.network.enrollment);
    if (isNaN(est)) est = 25;
    if (est < 1) est = 1;
    $('.current_est_enrollment').html(est);
    $('#new_est_enrollment').val(est);
    P.homescreen.showEnrollment();
    $('.new_est_enrollment').unbind().keyup(function(){
      var est = parseInt($(this).val(), 10);
      if (est < 1) est = 1;
      P.homescreen.network.enrollment = est;
      P.homescreen.showEnrollment();
    });
    // either show experienced view, or simple view
    var isDashboard = PEM.callFirst("isDashboard");
    var showExp = (P.homescreen.network.total_content_prof > 15) || PA.isSeenNetwork(P.homescreen.network, "exp");
    if (showExp && isDashboard) {
      $('.homescreen_box.ia2a').hide();
      $('.homescreen_section_wrapper').show();
      if (P.homescreen.user.isTA)
        P.homescreen.maybeShowCareersStory();
      if (P.homescreen.network && !PA.isSeenUser("homescreen_careers_is_here") && !P.homescreen.user.isTA) {
         $(".homescreen_careers_is_here").show();
         $(".homescreen_careers_is_here_hide").hide();
        // PA.call_pj("generic.page_event", {type:"careers.show_careers_is_here"}, 1);
         $(".close_prof_careers_warning").click(function() {
           $(".homescreen_careers_is_here").hide();
           $(".homescreen_careers_is_here_hide").show();
           PA.markSeenUnseen("homescreen_careers_is_here");
         });
      }

    } else {
      $('.homescreen_section_wrapper').hide();
      P.homescreen.showWelcomeQueue();
    }
  },
  saveEnrollment: function() {
    var est = parseInt($('.new_est_enrollment:visible').val(), 10);
    if (isNaN(est)) est = 25;
    if (est < 1) est = 1;
    PA.call_pj("network.update", {id: P.homescreen.network.id, enrollment: est}, 1);
    $('.current_est_enrollment').html(est);
    $('#new_est_enrollment').val(est);
    $('.est_enrollment_wrapper').hide();
    $('.est_enrollment_wrapper.view').show();
  },
  showEnrollment: function() {
    var est = parseInt(P.homescreen.network.enrollment);
    if (isNaN(est)) est = 25;
    if (est < 1) est = 1;
    var students = P.homescreen.network.user_count - P.homescreen.network.profs.length;
    if (students < 0) students = 0;
    $('.homescreen_progressbar .progress_count_number_students').html(students);
    if (students == 0) {
      $('.homescreen_progressbar .progress_count').addClass('none_enrolled');
    } else {
      $('.homescreen_progressbar .progress_count').removeClass('none_enrolled');
    }
    var percent = Math.round(students * 100 / est);
    $('.homescreen_progressbar .bar_students').css("width", percent + "%");
  },
  feedCreated: function() {
    if (P.homescreen.network.type != "group" && !P.homescreen.user.isPublic) {
      P.homescreen.refreshNewQuestions();
    }
  },
  refreshNewQuestions: function() {
    // New questions
    var $new = $('#new_question_count');
    var newQuestionCount = PEM.callFirst("getUnreadPosts");
    if(newQuestionCount === undefined) {
      newQuestionCount = 0;
    }
    $new.text(newQuestionCount === 0 ? 'no' : newQuestionCount);
    P.homescreen.changeResolutionOfItem($new, newQuestionCount === 0);
    $new.closest('.notification_wrapper').unbind().click(function() {
      PEM.fire("filterFeed", {
        filter: 'unread',
        showHidden: 'both'
      });
    });
  },
  refreshInstructorStats: function(force) {
    var now = new Date();
    if (!force && P.homescreen.instructorStatsId == P.homescreen.network.id &&
        P.homescreen.instructorStatsLoaded && (now - P.homescreen.instructorStatsLoaded < 1000*60)) {
        if (P.homescreen.instructorStats)
          P.homescreen.showInstructorStats(P.homescreen.instructorStats);
    }

    P.homescreen.instructorStatsId = P.homescreen.network.id;
    P.homescreen.instructorStatsLoaded = now;
    PA.call_pj("network.get_instructor_stats", {
      nid: P.homescreen.network.id
    }, 1, function(data) {
      P.homescreen.instructorStats = data;
      P.homescreen.showInstructorStats(data);
    }, function(err) {
    });
    //P.homescreen.initHandlers();
  },
  showInstructorStats: function(data) {
    var nowStr = (new Date()).toISOString();
    $('#activity_last_updated').attr("when", nowStr);
    $('#activity_last_updated').html(nowStr.toRelativeTime());
    $('#students_response_count').text(data.students_response);
    $('#instructors_response_count').text(data.instructors_response);
    $('#total_posts_count').text(data.total_posts);
    $('#total_contributions_count').text(data.total_contributions);
    P.homescreen.refreshNewQuestions();
    // Unanswered questions
    var $unanswered = $('#unanswered_question_count');
    var unansweredQuestionCount = data.unanswered_questions;
    // use < 1 instead of === 0 because bugs in the counting mechanism may sometimes bring the number below 0
    $unanswered.text(unansweredQuestionCount < 1 ? 'no' : unansweredQuestionCount);
    P.homescreen.changeResolutionOfItem($unanswered, unansweredQuestionCount < 1);
    $unanswered.closest('.notification_wrapper').unbind().click(function() {
      PEM.fire("filterFeed", {
        filter: 'unanswered',
        showHidden: 'both'
      });
    });

    // Followups
    var $unresolved = $('#unresolved_followup_count');
    var unresolvedFollowupCount = data.unanswered_followups;
    $unresolved.text(unresolvedFollowupCount < 1 ? 'no' : unresolvedFollowupCount);
    P.homescreen.changeResolutionOfItem($unresolved, unresolvedFollowupCount < 1);
    $unresolved.closest('.notification_wrapper').unbind().click(function() {
      PEM.fire("filterFeed", {
        filter: 'unresolved_followups',
        showHidden: 'both'
      });
    });

    // Response time
    var responseTime = data.response_time;
    var responseTimeText;
    if(responseTime === 0) {
      responseTimeText = 'n/a';
    } else {
      responseTimeText = Math.round(responseTime / 60, 2) + ' min';
    }
    $('#average_response_time').text(responseTimeText);
  },
  hideHomeScreen: function() {
    $('#homescreen').hide();
  },
  cleanDashboard: function() {
    $('.dashboard_element').html('');
    $('.main_panel').removeClass("private_post");
    $('#inactive_group_message').hide();
    $('#user_profile_wrapper').hide();
    $('.main_panel').css("top", "0px");
    PEM.fire("showSpecialMentions");
    if (P.homescreen.network && P.homescreen.network.status == "inactive" && !P.homescreen.user.isPublic) {
      $('#inactive_group_message').show();
      if (P.homescreen.network.isGroup)
        $('#inactive_group_message').text("! This group has been made inactive. No posts will be allowed until an admin reactivates the group.");
      else
        $('#inactive_group_message').text("!  This class has been made inactive. No posts will be allowed until an instructor reactivates the class.");
    } else
      $('#inactive_group_message').hide();
  },
  //showProfile: function(opts) {
  //  if (P.homescreen.network.type == "group") return;
  //  PEM.fire("verifyAnyCancel", function() {
  //    P.modules.loadModule("user_profile", {},
  //      function() {
  //        P.user_profile.showProfile(opts);
  //      }, null);
  //  });
  //},
  //showMyProfile: function() {
  //  if (P.homescreen.network.type == "group") return;
  //  if (P.homescreen.user.isInst) return;
  //  PEM.fire("verifyAnyCancel", function() {
  //    P.modules.loadModule("user_profile", {},
  //      function() {
  //        P.user_profile.showProfile(P.homescreen.user.id);
  //      }, null);
  //  });
  //},
  /************************************************/
  // IA2A stuff
  /************************************************/

  // Record that instructor resolved a particular message
  resolveMessage: function(name, params) {
    if(name === 'tips_tricks') {
      PA.call_pj('user.mark_seen', {msg: 'tips_tricks'}, 1, function() {}, function() {});
    }

    P.homescreen.seenMessages[name] = true;

    var $section = $('#' + name);
    $section.addClass('resolved');
    var hider = function() {
      $section.fadeOut(300, function() {
        P.homescreen.showWelcomeQueue({});
      });
    };
    if(typeof params !== 'undefined' && params.hideImmediately) {
      hider();
    } else {
      setTimeout(hider, 5000);
    }
    PA.markSeenNetwork(P.homescreen.network, name);
  },
  showResolvedView: function(name) {
    $section = $('#' + name);
    $section.find('.first_view').hide();
    $section.find('.second_view').show();
    if(name === 'enroll_inst') {
      if(P.homescreen.network.config && P.homescreen.network.config.no_other_instructors === true) {
        $section.find('.second_view').hide();
        $section.find('.no_others_view').show();
      }
    } else if(name === 'setup_course_page') {
      $('#save_setup_course_page').hide();
    }
  },
  showWelcomeQueue: function(params) {
    params = params || {};
    var isDashboard = PEM.callFirst("isDashboard");
    // params are initializing (whether we're in initialization) and prefill (whether there is some particular item that we really want to show)
    // hide them all initially
    if(params.initializing) {
      $('.welome_Q_box').hide();
    }
    P.homescreen.welcomeQueue.forEach(function(msg) {
      P.homescreen.seenMessages[msg] = false;
    });
    if(P.homescreen.network.config && P.homescreen.network.config.seen_message instanceof Array) {
      P.homescreen.network.config.seen_message.forEach(function(msg) {
        // only care about messages that are actually used here: for those, the previous statement would have put them in seenMessages with value false
        if(P.homescreen.seenMessages[msg] === false) {
          P.homescreen.seenMessages[msg] = true;
        }
      });
    }
    var i, len;
    // determine the queue
    var shownQueue = [];
    if(P.homescreen.gettingStartedPage) {
      shownQueue = P.homescreen.welcomeQueue;
      // no access code manipulation in schools that have emails
      if (P.homescreen.network.school_emails) {
        shownQueue.remove(function(elt) {
          return elt === 'access_code';
        });
      }
    } else {
      if(params.prefill !== undefined) {
        shownQueue.push(params.prefill);
      }
      for(i = 0, len = P.homescreen.welcomeQueue.length; i < len; i++) {
        if(P.homescreen.seenMessages[P.homescreen.welcomeQueue[i]] === false || !isDashboard) {
          // make sure prof only sees tips_tricks once
          if(P.homescreen.welcomeQueue[i] === 'tips_tricks' && $.inArray('tips_tricks', PA.user.config.seen_message) !== -1 && isDashboard) {
            continue;
          }
          if(PA.isSeenNetwork(P.homescreen.network, P.homescreen.welcomeQueue[i]) && isDashboard) {
            if (!(P.homescreen.welcomeQueue[i] === 'enroll_students')) {
              continue;
            }
          }
          // never show access code one in temp classes
          if(P.homescreen.welcomeQueue[i] === 'access_code' && P.homescreen.network.school_emails) {
            continue;
          }
          if(!shownQueue.exist(P.homescreen.welcomeQueue[i])) {
            shownQueue.push(P.homescreen.welcomeQueue[i]);
          }
          if(shownQueue.length === 3 && isDashboard) {
            // that's all we need
            break;
          }
        } else {
          if (P.homescreen.welcomeQueue[i] == "enroll_students")
            shownQueue.push("student_progress_bar");
        }
      }
    }
    if (shownQueue.length == 1 && shownQueue[0] == "student_progress_bar") {
      // everything is closed! switch to experienced view
      PA.markSeenNetwork(P.homescreen.network, "exp");
      $('.ia2a').hide();
      $('.homescreen_section_wrapper').show();
    }
    // show the queue
    P.homescreen.welcomeQueue.forEach(function(item) {
      var $item = $('#' + item);
      if(shownQueue.exist(item)) {
        if(!$item.is(':visible')) {
          if(typeof params !== 'undefined' && params.initializing) {
            $item.fadeIn(300);
          } else {
            $item.show();
          }
        }
      } else if($item.is(':visible')) {
        $item.fadeOut(300);
      }
    });
    if (shownQueue.exist("student_progress_bar")) {
      if(!$("#student_progress_bar").is(':visible'))
        $("#student_progress_bar").fadeIn(300);
    }

    P.homescreen.currentlyShown = {};
    // show resolved view for resolved messages
    for(i = 0, len = shownQueue.length; i < len; i++) {
      if(PA.isSeenNetwork(P.homescreen.network, shownQueue[i])) {
        P.homescreen.showResolvedView(shownQueue[i]);
      }
      P.homescreen.currentlyShown[shownQueue[i]] = true;
    }

    P.homescreen.currentlyShownQueue = shownQueue;
    P.homescreen.initIA2A();
  },
  initIA2A: function() {
    // tips & tricks
    var isDashboard = PEM.callFirst("isDashboard");
    if (isDashboard)
      $('.homescreen_close_button').css("visibility", "visible");
    $('#read_tips_tricks').unbind('click').click(function() {
      P.homescreen.resolveMessage('tips_tricks');

      // Tips & Tricks is probably message nr. 1, but may be something else. Backend stores the number
      var tipsTricksNr = 1;
      if(P.homescreen.network.config && P.homescreen.network.config.tips_tricks_nr) {
        tipsTricksNr = P.homescreen.network.config.tips_tricks_nr;
      }
      if(isDashboard) {
        PEM.fire("selectContent", tipsTricksNr);
      } else {
        window.location = '/class/' + P.homescreen.network.id + '?cid=' + tipsTricksNr;
      }
    });

    // first day of class
    if (P.homescreen.currentlyShown["first_day"]) {
      PA.call_pj('network.get_start_date', {nid: P.homescreen.network.id}, 1, function(data) {
        if (data === "DEFAULT") {
          data = new Date().format("mm/dd/yyyy");
          $('#first_day_of_class').val(data);
          $('#first_day_of_class').datepicker();
          $('#first_day').show();
        } else {
          PA.markSeenNetwork(P.homescreen.network, 'first_day');
          if (isDashboard) {
            $('#first_day').hide();
            P.homescreen.showWelcomeQueue({});
          }
          return;
        }
      }, alert);
      $('#save_first_day').unbind('click').click(function() {
        var firstDay = $('#first_day_of_class').val();
        PA.call_pj('network.update', {
          start_date: firstDay,
          id: P.homescreen.network.id
        }, null, function() {
          P.homescreen.resolveMessage('first_day');
          P.homescreen.showResolvedView('first_day');
        });
      });
    }

    if (P.homescreen.currentlyShown["access_code"]) {
      $("#access_code_li").show();
      PA.call_pj('network.get_access_code', {nid: P.homescreen.network.id}, 1, function(data) {
        $('#access_code_input').val(data);
      });
      $('#save_access_code').unbind('click').click(function() {
        var accessCode = $('#access_code_input').val();
        if(accessCode === '') {
          alert("Please provide a nonempty access code");
          return false;
        }
        PA.call_pj('network.update', {id: P.homescreen.network.id,join_code: accessCode}, null, function() {
          P.homescreen.resolveMessage('access_code');
          P.homescreen.showResolvedView('access_code');
        });
      });
    }
      // enrolling professors
    if (P.homescreen.currentlyShown["enroll_inst"]) {
      $('.enroll_inst_actions .btn').unbind('click').click(function() {
        var hasOthers = ($(this).text() === 'yes');
        $('#enroll_inst .ask_view').hide();
        if(hasOthers) {
          $('#enroll_inst .first_view').hide();
          $('#enroll_inst .enroll_view').show();
        } else {
          // save to DB
          PA.call_pj('network.set_config', {nid: P.homescreen.network.id,key: 'no_other_instructors',value: true}, null, function() {
            P.homescreen.network.config.no_other_instructors = true;
            $('#enroll_inst .no_others_view').show();
            P.homescreen.resolveMessage('enroll_inst');
          });
        }
      });
      $('#save_enroll_inst').unbind('click').click(function() {
        var emails = $('#add_instructors').val();
        if(emails === '') {
          alert('Please enter at least one email address.');
          return false;
        }
        P.homescreen.handleAddInstructors(emails);
      });
    }
    $('#share_piazza').unbind('click').click(function() {
      $('#share_email_modal').modal('show');
      return false;
    });
    // enrolling students
    if (P.homescreen.currentlyShown["enroll_students"]) {
      $('#save_enroll_students').unbind('click').click(function() {
        var emails = $('#add_students').val();
        if(emails === '') {
          alert('Please enter at least one email address.');
          return false;
        }
        var params = {id:P.homescreen.network.id, add_students:emails, from:'WelcomeScreen'};
        PA.call_pj("network.update", params, null, function(data) {
          P.homescreen.network.user_count = data.length;
          P.homescreen.showEnrollment();
          P.homescreen.showResolvedView('enroll_students');
          P.homescreen.resolveMessage('enroll_students');
          $('#enroll_students .second_window').hide();
        });
      });
    }
    $('#save_setup_course_page').unbind('click').click(function() {
      P.homescreen.resolveMessage('setup_course_page');
      P.homescreen.showResolvedView('setup_course_page');
    });
    $('#save_setup_sections').unbind('click').click(function() {
      PEM.fire("gotoConfigClass", "ConfigureSection");
    });
    $('.homescreen_close_button').unbind('click').click(function() {
      var welcome_Q_box = $(this).closest('.ia2a');
      welcome_Q_box.fadeOut(400, function() {
        var id = $(this).attr('id');
        P.homescreen.resolveMessage(id, {hideImmediately: true});
        //if (id === "enroll_students") {
          //if (PW.newView.canViewLmsFeature()) {
          //  PA.markSeenUnseen("weblogin_roster");
          //  PA.log_call_pj("log.event", {"event": "weblogin_roster.hide_teaser", "nid" : currentNetworkId});
          //}
        //}
      });
      return false;
    });
    $('#create_a_new_class').unbind('click').click(function() {
      var link = '/instructors/';
      link += (P.homescreen.network.school_ext) ? P.homescreen.network.school_ext : 'school-search';
      window.open(link);
      return false;
    });
  },

  handleAddInstructors: function(text) {
    var i, currEmail;
    var emails = [];
    var unverified_emails = text.split(/[^\w@!#%$&'*+\-\/=?\^_`{}~.]/ig);
    if (unverified_emails.length === 0) {
      return false;
    }
    for (i = 0; i < unverified_emails.length; i++) {
      currEmail = unverified_emails[i];
      if (currEmail !== null && typeof currEmail !== 'undefined' && isValidEmailAddress(currEmail)) {
        emails.push(currEmail);
      }
    }
    if (emails.length === 0) {
      alert('Please enter at least one valid email address.');
      return false;
    }
    // show the modal
    PTM.getModuleTemplate("homescreen", "homescreen_instructor_enroll", function(template) {
      $('#instructor_enroll_modal_wrapper').html(template({emails:emails}));
      $('#instructor_enroll_modal').modal('show');
    });
  },
  handleAddInstructorsAdd: function() {
    var form = $('#instructor_enroll_modal');
    var numberOfEmails = form.find('.instr_email').length;
    var selected = form.find('input:checked').length;
    if(numberOfEmails > selected) {
      alert('Please indicate whether each instructor is a professor or TA');
      return false;
    }

    var profEmails = [];
    var taEmails = [];
    var emails = form.find('.instr_email');
    var selections = form.find('input:checked');
    for (var i = 0; i < emails.length; i++) {
      if($(selections[i]).hasClass("prof")) {
        profEmails.push(emails[i].innerHTML);
      } else {
        taEmails.push(emails[i].innerHTML);
      }
    }

    var params = {id:P.homescreen.network.id, add_inst:profEmails.join(", "), add_ta:taEmails.join(", ")};

    PA.call_pj("network.update", params, null, function(data) {
      if (data) {
        var admins = [];
        data.forEach(function(user) {
          if (user.admin) {
            admins.push(user);
          }
        });
        P.homescreen.network.profs = admins;
        P.homescreen.network.user_count = data.length;
        //Piazzza.WelcomeScreen.initData();
      }
      //var new_profs = currentNetwork.profs.length;
      //PA.trackEvent(true, "InstructorWelcome_Add_Profs", "/class/", {"users_added" : (new_profs - prev_profs)});
    });
    $('#add_instructors').val('');
    P.homescreen.showResolvedView('enroll_inst');
    P.homescreen.resolveMessage('enroll_inst');
    $('#instructor_enroll_modal').modal('hide');
    // hide per Carly
    $('#enroll_inst .third_window').hide();
    return false;
  },
  sendShareEmail: function() {
    var emails = $('#share_email_to').val();

    if(emails.length < 1 || emails.indexOf('@') === -1) {
      alert("Please enter at least one valid email address");
      return false;
    }
    var subject = $('#share_email_subject').val();
    if(subject.length < 1) {
      alert("Please enter a valid subject line");
      return false;
    }
    var content = $('#share_email_content').val();
    if(content.length < 1) {
      alert("Please don't send an empty email");
      return false;
    }
    PA.call_pj('user.send_share_email', {nid: P.homescreen.network.id, to: emails, subject: subject, text: content}, null, function () {
      $('#share_email_modal').modal('hide');
      $('#share_piazza .first_view, #share_piazza_experienced .first_view').hide();
      $('#share_piazza .second_view, #share_piazza_experienced .second_view').show();
      setTimeout(function() {
        $('#share_piazza .second_view, #share_piazza_experienced .second_view').hide();
        $('#share_piazza .first_view, #share_piazza_experienced .first_view').show();
      }, 5000);
    }, alert);
  },
  hideOptin: function() {
    PA.markSeenUnseen("c_optin");
    $('#careers_optin').hide();
    return false;
  },
  hideOptinNew: function(source) {
    PA.markSeenUnseen("c_optin");
    PA.markSeenUnseen("c_optin_new");
    $('#careers_optin_new').hide();
    if (source && source == "feed")
      PA.call_pj("generic.event_to_requests", {event: "careers.hide_new_optin_post_feed"}, 1);
    return false;
  },
  startUpload: function() {
    P.homescreen.uploading = true;
    $.blockUI();
    PA.call_pj("generic.page_event", {type:"careers_student.upload_resume", text1:"homescreen"}, 1);
    $('#upload_form').submit();
  },
  onUploadComplete: function() {
    if (!P.homescreen.uploading) return false;
    P.homescreen.uploading = false;
    $.unblockUI();
    var content = $('#hidden-upload-frame').contents().find('body').html();
    if (P.homescreen.profile)
      P.homescreen.profile.resume = content;
    $('.upload_resume_button').replaceWith('<p class="upload_resume_button profile_status_message">Resume Uploaded</p>');
    window.location = "/svtechtour?step=two";
  },
  saveThis: function(element) {
    var top = element.closest('.profile_prompt_option');
    if (top.length == 0)
      top = element.closest('.profile_content_input_item_wrapper');
    PEM.fire("saveSection", {top:top, noShow:true});
    element.text("Saved!");
  },
  showCareersOptin: function() {
    PTM.getModuleTemplate("homescreen", "homescreen_careers_opt_in", function(template){
      var p = PEM.callFirst("loadMyProfile", P.homescreen.showCareersOptin);
      if (p) {
        P.homescreen.profile = p;
        P.homescreen.cleanDashboard();
        $('#homescreen').html(template({user:P.homescreen.user, profile:p}));
        $('#homescreen').show();
        $('.opt_in_close').click(function(){
          P.homescreen.hideOptin();
          P.homescreen.showHomeScreen();
        });
        $('#disable_careers').click(function(){
          PA.call_pj("user.update", {email_prefs:{careers:{no_careers:true}}}, null, function(data){
            window.location = "/class";
          });
          return false;
        });
        $('#homescreen .upload_resume_button').click(function(){
          $('#upload_form_file').click();
          return false;
        });
        $('#homescreen .next_button').click(function(){
          P.homescreen.saveThis($(this));
        });
      }
    });
  },
  showCareersOptinNew: function() {
    PTM.getModuleTemplate("homescreen", "homescreen_careers_opt_in_new", function(template){
      var p = PEM.callFirst("loadMyProfile", P.homescreen.showCareersOptin);
      if (p) {
        PA.call_pj("generic.event_to_requests", {event: "careers.show_new_optin_post"}, 1);
        P.homescreen.profile = p;
        P.homescreen.cleanDashboard();
        $('#homescreen').html(template({user:P.homescreen.user, profile:p}));
        $('#homescreen').show();
        $('.opt_in_close').click(function(){
          P.homescreen.hideOptinNew();
          P.homescreen.showHomeScreen();
          PA.call_pj("generic.event_to_requests", {event: "careers.hide_new_optin_post"}, 1);
        });
        $("#opt_in_button").click(function() {
          var params = {set:{"profile_settings.published":true, "last_published":parseInt((new Date()).getTime() / 1000)}};
          P.user_careers_profile.updateProfile(params); // publish profile
          PA.call_pj("generic.event_to_requests", {event: "careers.opt_in_from_new_post"}, 1);
          $(".opt_in_message").hide();
          $(".nagbar_wrapper").show();
          PA.markSeenUnseen("c_optin");
        });
        $('#disable_careers').click(function(){
          PA.call_pj("generic.event_to_requests", {event: "careers.opt_out_from_new_post"}, 1);
          PA.markSeenUnseen("c_optin_new");
          PA.markSeenUnseen("c_optin");
          PA.call_pj("user.update", {email_prefs:{careers:{no_careers:true}}}, null, function(data){
            window.location = "/class";
          });
          return false;
        });
        $('#homescreen .upload_resume_button').click(function(){
          $('#upload_form_file').click();
          return false;
        });
        $('#homescreen .next_button').click(function(){
          P.homescreen.saveThis($(this));
        });
      }
    });
  },
  init: function(module) {
    P.homescreen.template = module.template;
    if (module.options.network)
      P.homescreen.network = module.options.network;
    if (module.options.user)
      P.homescreen.user = module.options.user;

    PEM.addListener("network", P.homescreen.setNetwork);
    PEM.addListener("showHomescreen", P.homescreen.showHomeScreen);
    PEM.addListener("cleanDashboard", P.homescreen.cleanDashboard);
    PEM.addListener("content", P.homescreen.hideHomeScreen);
    PEM.addListener("showCareersOptin", P.homescreen.showCareersOptin);
    PEM.addListener("showCareersOptinNew", P.homescreen.showCareersOptinNew);
    //PEM.addListener("showUserProfile", P.homescreen.showProfile);
    //PEM.addListener("showMyProfile", P.homescreen.showMyProfile);
    PEM.addListener("feed_created", P.homescreen.feedCreated);
    //Renars or Zach Change JS here!
    //PTM.getModuleTemplate("homescreen", "homescreen_student_network", function(template){P.homescreen.networkDataTemplate = template});
    PTM.getModuleTemplate("homescreen", "homescreen_new_careers", function(template){P.homescreen.careersTemplate = template});
    PTM.getModuleTemplate("homescreen", "homescreen_new_careers_feed", function(template){P.homescreen.feedItemTemplate = template});
    PTM.getModuleTemplate("careers_dashboard", "careers_dashboard_event_story", function(template){P.homescreen.eventStoryTemplate = template});
    P.homescreen.showHomeScreen();
    setInterval(P.homescreen.updateRelativeTimes, 5000);
  }
};


!function(b){var c=function(d,c){this.element=b(d);this.format=a.parseFormat(c.format||this.element.data("date-format")||"mm/dd/yyyy");this.picker=b(a.template).appendTo("body").on({click:b.proxy(this.click,this)});this.isInput=this.element.is("input");this.component=this.element.is(".date")?this.element.find(".add-on"):false;if(this.isInput)this.element.on({focus:b.proxy(this.show,this),keyup:b.proxy(this.update,this)});else if(this.component)this.component.on("click",b.proxy(this.show,this));else this.element.on("click",b.proxy(this.show,this));this.minViewMode=c.minViewMode||this.element.data("date-minviewmode")||0;if(typeof this.minViewMode==="string")switch(this.minViewMode){case"months":this.minViewMode=1;break;case"years":this.minViewMode=2;break;default:this.minViewMode=0}this.viewMode=c.viewMode||this.element.data("date-viewmode")||0;if(typeof this.viewMode==="string")switch(this.viewMode){case"months":this.viewMode=1;break;case"years":this.viewMode=2;break;default:this.viewMode=0}this.startViewMode=this.viewMode;this.weekStart=c.weekStart||this.element.data("date-weekstart")||0;this.weekEnd=this.weekStart===0?6:this.weekStart-1;this.onRender=c.onRender;this.fillDow();this.fillMonths();this.update();this.showMode()};c.prototype={constructor:c,show:function(a){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();this.place();b(window).on("resize",b.proxy(this.place,this));if(a){a.stopPropagation();a.preventDefault()}!this.isInput;var c=this;b(document).on("mousedown",function(a){b(a.target).closest(".datepicker").length==0&&c.hide()});this.element.trigger({type:"show",date:this.date})},hide:function(){this.picker.hide();b(window).off("resize",this.place);this.viewMode=this.startViewMode;this.showMode();!this.isInput&&b(document).off("mousedown",this.hide);this.element.trigger({type:"hide",date:this.date})},"set":function(){var b=a.formatDate(this.date,this.format);if(!this.isInput){this.component&&this.element.find("input").prop("value",b);this.element.data("date",b)}else this.element.prop("value",b)},setValue:function(b){if(typeof b==="string")this.date=a.parseDate(b,this.format);else this.date=new Date(b);this.set();this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0);this.fill()},place:function(){var a=this.component?this.component.offset():this.element.offset();this.picker.css({top:a.top+this.height,left:a.left})},update:function(b){this.date=a.parseDate(typeof b==="string"?b:this.isInput?this.element.prop("value"):this.element.data("date"),this.format);this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0);this.fill()},fillDow:function(){var c=this.weekStart,b="<tr>";while(c<this.weekStart+7)b+='<th class="dow">'+a.dates.daysMin[c++%7]+"</th>";b+="</tr>";this.picker.find(".datepicker-days thead").append(b)},fillMonths:function(){var b="",c=0;while(c<12)b+='<span class="month">'+a.dates.monthsShort[c++]+"</span>";this.picker.find(".datepicker-months td").append(b)},fill:function(){var m=new Date(this.viewDate),c=m.getFullYear(),h=m.getMonth(),n=this.date.valueOf();this.picker.find(".datepicker-days th:eq(1)").text(a.dates.months[h]+" "+c);var b=new Date(c,h-1,28,0,0,0,0),l=a.getDaysInMonth(b.getFullYear(),b.getMonth());b.setDate(l);b.setDate(l-(b.getDay()-this.weekStart+7)%7);var e=new Date(b);e.setDate(e.getDate()+42);e=e.valueOf();var d=[],f,g,j;while(b.valueOf()<e){b.getDay()===this.weekStart&&d.push("<tr>");f=this.onRender(b);g=b.getFullYear();j=b.getMonth();if(j<h&&g===c||g<c)f+=" old";else if(j>h&&g===c||g>c)f+=" new";if(b.valueOf()===n)f+=" active";d.push('<td class="day '+f+'">'+b.getDate()+"</td>");b.getDay()===this.weekEnd&&d.push("</tr>");b.setDate(b.getDate()+1)}this.picker.find(".datepicker-days tbody").empty().append(d.join(""));var k=this.date.getFullYear(),p=this.picker.find(".datepicker-months").find("th:eq(1)").text(c).end().find("span").removeClass("active");k===c&&p.eq(this.date.getMonth()).addClass("active");d="";c=parseInt(c/10,10)*10;var o=this.picker.find(".datepicker-years").find("th:eq(1)").text(c+"-"+(c+9)).end().find("td");c-=1;for(var i=-1;i<11;i++){d+='<span class="year'+(i===-1||i===10?" old":"")+(k===c?" active":"")+'">'+c+"</span>";c+=1}o.html(d)},click:function(f){f.stopPropagation();f.preventDefault();var c=b(f.target).closest("span, td, th");if(c.length===1)switch(c[0].nodeName.toLowerCase()){case"th":switch(c[0].className){case"switch":this.showMode(1);break;case"prev":case"next":this.viewDate["set"+a.modes[this.viewMode].navFnc].call(this.viewDate,this.viewDate["get"+a.modes[this.viewMode].navFnc].call(this.viewDate)+a.modes[this.viewMode].navStep*(c[0].className==="prev"?-1:1));this.fill();this.set()}break;case"span":if(c.is(".month")){var d=c.parent().find("span").index(c);this.viewDate.setMonth(d)}else{var e=parseInt(c.text(),10)||0;this.viewDate.setFullYear(e)}if(this.viewMode!==0){this.date=new Date(this.viewDate);this.element.trigger({type:"changeDate",date:this.date,viewMode:a.modes[this.viewMode].clsName})}this.showMode(-1);this.fill();this.set();break;case"td":if(c.is(".day")&&!c.is(".disabled")){var g=parseInt(c.text(),10)||1,d=this.viewDate.getMonth();if(c.is(".old"))d-=1;else if(c.is(".new"))d+=1;var e=this.viewDate.getFullYear();this.date=new Date(e,d,g,0,0,0,0);this.viewDate=new Date(e,d,Math.min(28,g),0,0,0,0);this.fill();this.set();this.element.trigger({type:"changeDate",date:this.date,viewMode:a.modes[this.viewMode].clsName})}}},mousedown:function(a){a.stopPropagation();a.preventDefault()},showMode:function(b){if(b)this.viewMode=Math.max(this.minViewMode,Math.min(2,this.viewMode+b));this.picker.find(">div").hide().filter(".datepicker-"+a.modes[this.viewMode].clsName).show()}};b.fn.datepicker=function(a,d){return this.each(function(){var f=b(this),e=f.data("datepicker"),g=typeof a==="object"&&a;!e&&f.data("datepicker",e=new c(this,b.extend({},b.fn.datepicker.defaults,g)));typeof a==="string"&&e[a](d)})};b.fn.datepicker.defaults={onRender:function(){return""}};b.fn.datepicker.Constructor=c;var a={modes:[{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],dates:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},isLeapYear:function(a){return a%4===0&&a%100!==0||a%400===0},getDaysInMonth:function(c,b){return([31,a.isLeapYear(c)?29:28,31,30,31,30,31,31,30,31,30,31])[b]},parseFormat:function(c){var b=c.match(/[.\/\-\s].*?/),a=c.split(/\W+/);if(!b||!a||a.length===0)throw new Error("Invalid date format.");return{separator:b,parts:a}},parseDate:function(a,c){var g=a.split(c.separator),a=new Date,b;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);if(g.length===c.parts.length){for(var e=a.getFullYear(),h=a.getDate(),f=a.getMonth(),d=0,i=c.parts.length;d<i;d++){b=parseInt(g[d],10)||1;switch(c.parts[d]){case"dd":case"d":h=b;a.setDate(b);break;case"mm":case"m":f=b-1;a.setMonth(b-1);break;case"yy":e=2e3+b;a.setFullYear(2e3+b);break;case"yyyy":e=b;a.setFullYear(b)}}a=new Date(e,f,h,0,0,0)}return a},formatDate:function(b,c){var a={d:b.getDate(),m:b.getMonth()+1,yy:b.getFullYear().toString().substring(2),yyyy:b.getFullYear()};a.dd=(a.d<10?"0":"")+a.d;a.mm=(a.m<10?"0":"")+a.m;for(var b=[],d=0,e=c.parts.length;d<e;d++)b.push(a[c.parts[d]]);return b.join(c.separator)},headTemplate:'<thead><tr><th class="prev">&lsaquo;</th><th colspan="5" class="switch"></th><th class="next">&rsaquo;</th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'};a.template='<div class="datepicker dropdown-menu"><div class="datepicker-days"><table class=" table-condensed">'+a.headTemplate+'<tbody></tbody></table></div><div class="datepicker-months"><table class="table-condensed">'+a.headTemplate+a.contTemplate+'</table></div><div class="datepicker-years"><table class="table-condensed">'+a.headTemplate+a.contTemplate+"</table></div></div>"}(window.jQuery);

P.editor_guard = {
  template: null,
  user: null,
  okCallback: null,

  initHandlers: function() {
    $('.UIConfirmationWindow .UIActions .submit').click(function(){
      $(this).closest('.UIConfirmationWindow').hide();
      $.fancybox.close();
      if (P.editor_guard.okCallback)
        P.editor_guard.okCallback.call(window);
      return false;
    });
    $('.UIConfirmationWindow .UIActions .cancel').click(function() {
      $(this).closest('.UIConfirmationWindow').hide();
      $.fancybox.close();
      if ($(this).hasClass("draft")) {
        PEM.fire("saveDraft");
        if (P.editor_guard.okCallback)
          P.editor_guard.okCallback.call(window);
      }
      return false;
    });
  },
  showDialog: function(okCallback, id) {
    P.editor_guard.okCallback = okCallback;
    if (!id) id = 'Confirmation_CancelEditor_MoveAway';
    var $modalWindow = $('#' + id);
    $modalWindow.show();
    // Open the corresponding confirmation window.
    if ($modalWindow.size() > 0) {
      $.fancybox({
        'autoScale': true,
        'hideOnOverlayClick': false,
        'href': '#' + id,
        'padding': 0,
        'showCloseButton': false,
        'transitionIn': 'none',
        'transitionOut': 'none'
      });
    }
  },
  verifyAnyCancel: function(okCallback) {
    var isOpen = PEM.callFirst("hasActiveEditor");
    if (isOpen) {
      var id = false;
      if (isOpen == "old_new_post") {
        PEM.fire("saveDraft", false);
        PEM.fire("cancelAll");
        if (okCallback) okCallback.call(window);
        return;
      }
      P.editor_guard.showDialog(function(){
        PEM.fire("cancelAll");
        if (okCallback) okCallback.call(window);
      }, id);
      return;
    }
    if (okCallback) okCallback.call(window);
  },

  init: function(module) {
    P.editor_guard.template = module.template;
    $('body').append(module.template());
    P.editor_guard.initHandlers();


    PEM.addListener("verifyCancel", P.editor_guard.showDialog);
    PEM.addListener("verifyCancelNewPost", function(callback){P.editor_guard.showDialog(callback, "Confirmation_CancelEditor_NewQuestion")});
    PEM.removeListener("verifyAnyCancel", defaultVerify);
    PEM.addListener("verifyAnyCancel", P.editor_guard.verifyAnyCancel);

    if (module.options.user)
      P.editor_guard.user = module.options.user;
  }

};
P.confirmation_window = {
  okCallback: null,

  initHandlers: function() {
    var $modalWindow = $('#confirm_window');
    $modalWindow.find('.UIActions .submit').click(function(){
      $modalWindow.hide();
      $.fancybox.close();
      if (P.confirmation_window.okCallback)
        P.confirmation_window.okCallback.call(window);
      return false;
    });
    $modalWindow.find('.UIActions .cancel').click(function() {
      $modalWindow.hide();
      $.fancybox.close();
      return false;
    });
  },

  showConfirmationWindow: function(params) {
    P.confirmation_window.okCallback = params.callback;
    var title = params.title;
    var cancel = params.cancel;
    var confirm = params.confirm;
    if (!cancel)
      cancel = "Cancel";
    if (!confirm)
      confirm = "Confirm";

    $(".confirm_window_title").html(title);
    $(".confirm_window.edit_cancel_button.submit").html(confirm);
    $(".confirm_window.edit_cancel_button.cancel").html(cancel);

    var $modalWindow = $('#confirm_window');
    $modalWindow.show();
    // Open the corresponding confirmation window.
    if ($modalWindow.size() > 0) {
      $.fancybox({
        'autoScale': true,
        'hideOnOverlayClick': false,
        'href': '#confirm_window',
        'padding': 0,
        'showCloseButton': false,
        'transitionIn': 'none',
        'transitionOut': 'none'
      });
    }

    return false;
  },

  init: function(module) {
    $("body").append(module.template());
    P.confirmation_window.initHandlers()

    PEM.addListener("showConfirmationWindow", P.confirmation_window.showConfirmationWindow);
  }

};
P.stats = {
  template: null,
  user: null,
  network: null,

  initHandlers:function() {
  },
  setUser: function(user) {
    P.stats.user = user;
  },
  setNetwork:function(network) {
    P.stats.network = network;
  },
  showStats: function(opts) {
    if (P.stats.network.type == "group") return;
    PEM.fire("cleanDashboard");
    $('#statistics_panel').html(P.stats.template({network:P.stats.network, user:P.stats.user}));
    $('#classStatisticLink').html('');
    if (!P.stats.user) { P.stats.user = PA.user;}
    if (P.stats.user && P.stats.user.isInst) {
      var day = new Date().format("mmm-dd");
      var link = '(<a target="_blank" href="/class_statistics/' + P.stats.network.id + '?day=' + day + '">Get class statistics as a CSV file</a>)';
      
      var poll_link = '(<a target="_blank" href="/bulk_poll_statistics/' + P.stats.network.id + '?day=' + day + '">Bulk download poll statistics</a>)';
      if (P.stats.network.total_content_stud >= 20)
        link += ' (<a target="_blank" href="/stats/report/' + P.stats.network.id + '">' + P.stats.network.course_number + ' Piazza Report</a>)';
      $('#classStatisticLink').html(link);
      $('#pollStatisticLink').html(poll_link);
      $('#statsHeader').show();
    } else{
      if (P.stats.network.total_content_stud >= 20)
        $('#classStatisticLink').html('<a target="_blank" href="/stats/report/' + P.stats.network.id + '">View Piazza Report</a>');
    }
    
      PA.call("network.get_stats", {
        nid: P.stats.network.id, anonymize : false
      }, null, function (data) {
        P.stats.classStats = data;
        if (data.total) {
          $('#stats_posts').html(data.total.posts || 0);
          $('#stats_questions').html(data.total.questions || 0);
          $('#stats_ir').html(data.total.i_answers || 0);
          $('#stats_sr').html(data.total.s_answers || 0);
          $('#stats_rt').html(showSecs(data.total.response_time));
          $('#stats_total_time').html(showSecs(data.total.net_time));
        }
        $('#stats_most_active').empty();
        if (data.top_users) { // populate most active users
          data.top_users.forEach(function (usr) {
            
            $('#stats_most_active').append('<li><div class="student_name"><a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a></div>' + '<div class="value">' + usr.posts + ' contributions; ' + usr.days + ' days online</div></li>');
          })
        }
        $('#stats_askers').empty();
        if (data.top_askers && data.top_askers.length > 0) {
          var top_askers = '';
          top_askers += '<thead><tr>';
              top_askers += '<th class="header" style="font-size: 11px;width:275px;">Name, Email</th>';
              top_askers += '<th class="header" style="font-size: 11px;">questions asked</th>'
          top_askers += '</tr></thead>';
          data.top_askers.forEach(function(usr) {
            top_askers += '<tr>';
              top_askers += '<td style="width: 290px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
                top_askers += '<a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a> <span class="span-small">' + usr.email + '</span>';
              top_askers += '</td>';
              top_askers += '<td style="marign-left: 10px;">' + usr.asks + '</td>';
            top_askers += '</tr>';
          });
          $('#top_askers').show();
          $('#stats_askers').html(top_askers);
          $('#stats_askers').tablesorter();
        } else {
          $('#top_askers').hide();
        }
        $('#stats_good_q').empty();
        if (data.top_good_q && data.top_good_q.length > 0) {
          var good_q = '';
          good_q += '<thead><tr>';
            good_q += '<th class="header" class="th-300" style="font-size: 11px;width:275px;">Name, Email</th>';
            good_q += '<th class="header" class="th-300" style="font-size: 11px;">number of &quot;good question&quot;s</th>';
          good_q += '</tr></thead>';
          data.top_good_q.forEach(function(usr) {

            good_q += '<tr>';
              good_q += '<td style="width: 290px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
                good_q += '<a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a>  <span class="span-small">' + usr.email + '</span>';
              good_q += '</td>';
              good_q += '<td style="margin-left: 10px;">' + usr.good_q + '</td>';
            good_q += '</tr>';
          });
          $('#top_good_q').show();
          $('#stats_good_q').html(good_q);
          $('#stats_good_q').tablesorter();
        } else {
          $('#top_good_q').hide();
        }
        $('#stats_answerers').empty();
        if (data.top_answerers && data.top_answerers.length > 0) {
          var top_a = '';
          top_a += '<thead><tr>';
            top_a += '<th class="header" style="font-size: 11px;width: 275px;">Name, Email</th>';
            top_a += '<th class="header" style="font-size: 11px;">number of answers</th>';
          top_a += '</tr></thead>';
          data.top_answerers.forEach(function(usr) {
            top_a += '<tr>';
              top_a += '<td style="width: 290px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
                top_a += '<a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a>  <span class="span-small">' + usr.email + '</span>';
              top_a += '</td>';
              top_a += '<td style="margin-left: 10px;">' + usr.answers + '</td>';
            top_a += '</tr>';
          });
          $('#top_answerers').show();
          $('#stats_answerers').html(top_a);
          $('#stats_answerers').tablesorter();
        } else {
          $('#top_answerers').hide();
        }
        $('#stats_good_a').empty();
        if (data.top_good_a && data.top_good_a.length > 0) {
          var good_a = '';
          good_a += '<thead><tr>';
            good_a += '<th class="header" style="font-size: 11px;width:275px;">Name, Email</th>';
            good_a += '<th class="header" style="font-size: 11px;">number of endorsed answers</th>';
          good_a += '</tr></thead>';
          data.top_good_a.forEach(function(usr) {
            good_a += '<tr>';
              good_a += '<td class="td-300" style="width: 290px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
                good_a += '<a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a> <span class="span-small">' + usr.email + '</span>';
              good_a += '</td>';
              good_a += '<td style="margin-left: 10px;">' + usr.good_a + '</td>';
            good_a += '</tr>';
          });
          $('#top_good_a').show();
          $('#stats_good_a').html(good_a);
          $('#stats_good_a').tablesorter();
        } else {
          $('#top_good_a').hide();
        }
        $('#stats_listeners').empty();
        if (data.top_listeners && data.top_listeners.length > 0) {
          var list = '';
          list += '<thead><tr>';
            list += '<th class="header" style="font-size: 11px;width:275px;">Name, Email</th>';
            list += '<th class="header" style="font-size: 11px;">number of questions/notes viewed</th>';
          list += '</tr></thead>';
          data.top_listeners.forEach(function(usr) {
            list += '<tr>';
              list += '<td style="width: 290px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
                list += '<a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a>  <span class="span-small">' + usr.email + '</span>';
              list += '</td>';
              list += '<td style="margin-left: 10px;">' + usr.views + '</td>';
            list += '</tr>';
          });
          $('#top_listeners').show();
          $('#stats_listeners').html(list);
          $('#stats_listeners').tablesorter();
        } else {
          $('#top_listeners').hide();
        }
        $('#stats_all_users').empty();
        if (data.users && data.users.length > 0) {
          $('#stats_all_users').show();
          $('#stud_participation').show();
          $('#more_info_coming').hide();
	/*$('#stats_all_users').append('' +
					'<tr>' +
						'<th>Name, Email</span>' +
				  		'<th>Days Online</span>' +
				  		'<th>Posts Viewed<em>*</em></span>' +
				  		'<th>Contributions<em>**</em></span>' +
					'</tr>');
				data.users.forEach(function(usr){
				  $('#stats_all_users').append('' +
					'<tr>' +
						'<td>' + usr.name + '<span class="span-small">' + usr.email + '</span></td>' +
						'<td>' + usr.days + '</td>' +
						'<td>' + usr.views + '</td>' +
						'<td>' + usr.posts + '</td>' +
					'</tr>');
				});*/
          $('#stats_all_users').append('<thead><tr><th class="header" style="font-size: 11px;width: 275px;">Name, Email</th>'
            + '<th class="header" style="font-size: 11px;">days online</th>'
            + '<th class="header" style="font-size: 11px;">posts viewed<em>*</em></th>'
            + '<th class="header" style="font-size: 11px;">contributions<em>**</em></th></tr></thead>');
          var total = 0;
          for (var i = 0; i < data.users.length; i++)
            if (data.users[i].posts > 0) total = total + 1;
          if (!P.stats.user.isInst || total >= 5 || (data.top_users && data.top_users.length >= 5)) {
            data.users.forEach(function (usr) {
              $('#stats_all_users').append('<tr><td style="width: 290px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a> <span class="span-small">' + usr.email + '</span></td>' + '<td style="margin-left: 10px;">' + usr.days + '</td>' + '<td>' + usr.views + '</td>' + '<td>' + usr.posts + '</td></tr>');
            });
            $('#stats_all_users').tablesorter();
          } else {
            $('#stud_participation').hide();
            $('#more_info_coming').show();
            $('#stats_most_active').empty();
          }
        } else {
          $('#stats_all_users').hide();
          $('#stud_participation').hide();
          $('#more_info_coming').show();
        }
        $('#stats_all_instructors').empty();
        if (data.profs && data.profs.length > 0) {
          $('#stats_all_instructors').show();
          $('#prof_participation').show();
          $('#stats_all_instructors').append('<thead><tr><th class="header" style="font-size: 11px;width: 275px;">Name, Email</th>' + '<th class="header" style="font-size: 11px;">days online</th>' + '<th class="header" style="font-size: 11px;">posts viewed<em>*</em></th>' + '<th class="header" style="font-size: 11px;">contributions<em>**</em></th></tr></thead>');
          data.profs.forEach(function (usr) {
            $('#stats_all_instructors').append('<tr><td><a href="#" onClick="PEM.fire(\'showUserProfile\', \'' + usr.user_id + '\');return false;" target="_self">' + usr.name + '</a> <span class="span-small">' + usr.email + '</span>' + '</td></td>' + '<td>' + usr.days + '</td>' + '<td>' + usr.views + '</td>' + '<td>' + usr.posts + '</td></tr>');
          });
          $('#stats_all_instructors').tablesorter();
        } else {
          $('#stats_all_instructors').hide();
          $('#prof_participation').hide();
        }
        P.stats.showStatsChart(data);
      });
    
    
    
    $('#statistics_panel').show();
  },
  showStatsChart: function() {
    var classStats = P.stats.classStats;
    if (!classStats) return;
    var type = $('#stats_chart_selector').val();
    var data = "";
    var chxl = "";
    var mc = 0;
    var len = 0;
    var plot = type;
    var modulo = (classStats.daily.length + 1) % 7;
    var minus = 1;
    if (classStats.daily.length > 1 && !classStats.daily[classStats.daily.length - 2].users)
      minus = 2;
    for (var i = 0; i < classStats.daily.length - minus; i++) {
      var o = classStats.daily[i];
      if (!o[type]) o[type] = 0;
      if (o[type] > mc) mc = o[type];
      if (i % 7 == modulo) chxl = chxl + (chxl.length > 0 ? "|" : "") + o.day;
      data = data + (data.length > 0 ? "," : "") + o[type];
    }
    len = classStats.daily.length;
    var graph = "/chart?cht=lc&chd=t:" + data + "&chs=560x300&chxt=x,y&chxl=0:|" + chxl +
      "&chxr=0,1," + len + "|1,0," + mc + "&chdl=" + plot + "&chdlp=b&chds=0," + mc + "&chco=8080FF";
    $("#googleChart").html('<img src="https://chart.googleapis.com' + graph + '"/>');
  },
  init: function(module) {
    P.stats.template = module.template;
    if (module.options.network)
      P.stats.network = module.options.network;
    if (module.options.user)
      P.stats.user = module.options.user;

    PEM.addListener("network", P.stats.setNetwork);
    PEM.addListener("showClassStats", P.stats.showStats);
  }
};
P.upload_manager = {

  containId:  window,
  template: null,
  uploads:   [],
  list:      null,
  network:   null,
  submitCallback: null,
  cancelCallback: null,
  user: null,
  userData: null,

  initHandlers: function() {
    P.upload_manager.uploader.bind("UploadComplete", P.upload_manager.handleUploadComplete, this);
    P.upload_manager.uploader.bind("FilesAdded", P.upload_manager.startUpload, this);
    if ($('#browse_upload_link_' + P.upload_manager.network.id).length > 0) {
      $('#browse_upload_link_' + P.upload_manager.network.id).click();
    } else
      $($('.browse_upload_class a')[0]).click();
  },
  setUser: function(user) {
    P.upload_manager.user = user;
  },
  setUp: function() {
    P.upload_manager.tearDown();
    P.upload_manager.uploader = new plupload.Uploader({
      runtimes: 'html5,silverlight,html4,browserplus',
      browse_button: "browse_upload",
      container: "upload_manager",
      max_file_size: '100mb',
      url: '/upload/upload_file',
      multi_selection: false,
      multipart_params: {
        nid: P.upload_manager.network.id,
        uid: P.upload_manager.user.id
      },
      silverlight_xap_url : '/third_party/plupload/js/plupload.silverlight.xap'
    });
    P.upload_manager.uploader.init();
    P.upload_manager.initHandlers();
  },
  tearDown: function() {
    if (P.upload_manager.uploader) {
      P.upload_manager.uploader.unbindAll();
      P.upload_manager.uploader.destroy();
      while (P.upload_manager.uploader.files.length > 0) {
        P.upload_manager.uploader.removeFile(this.uploader.files[0]);
      }
    }
  },
  startUpload: function() {
    P.upload_manager.fid = (new Date()).getTime().toString(36) + Math.round(Math.random() * 1679616).toString(36);
    P.upload_manager.uploader.settings.multipart_params.fid = P.upload_manager.fid;
    P.upload_manager.uploader.start();
    $.blockUI();
  },
  handleUploadComplete: function(up, files) {
    P.upload_manager.tearDown();
    // get the URL
    setTimeout(function(){
      PA.call_pj("user.get_files", {}, null, function(data){
        // find file with fid
        for (var nid in data) {
          if (data[nid][P.upload_manager.fid]) {
            P.upload_manager.submit(data[nid][P.upload_manager.fid].url, data[nid][P.upload_manager.fid].name);
            return;
          }
        }
        alert("Encountered error in file upload");
        P.upload_manager.setUp();
      }, function(err){
        alert("Error initializing file manager: " + err);
        P.upload_manager.setUp();
      });
    }, 1200);
  },
  submit: function(url, name) {
    if (url.indexOf('http') != 0)
      url = "https://d1b10bmlvqabco.cloudfront.net/" + url;
    if (P.upload_manager.submitCallback)
      P.upload_manager.submitCallback(url, name);
    $('#modal_windows').hide();
    $('#upload_manager').modal('hide');
    return false;
  },
  cancel: function() {
    if (P.upload_manager.cancelCallback)
      P.upload_manager.cancelCallback();
    $('#modal_windows').hide();
    $('#upload_manager').modal('hide');
    return false;
  },
  deleteFile: function(fid) {
    var answer = confirm("Are you sure you want to remove this file? (it will still be downloadable)");
    if (!answer) return false;
    // find nid for this file
    $('#file_' + fid).hide();
    for (var nid in P.upload_manager.userData) {
      if (P.upload_manager.userData[nid][fid]) {
        PA.call_pj("user.remove_file", {nid:nid, fid:fid}, null);
      }
    }
    return false;
  },
  prepareData: function() {
    var data = {};
    var nid = P.upload_manager.network.id;
    if (P.upload_manager.userData[nid]) {
      // find network
      for (var i = 0; i < P.upload_manager.user.networks.length; i++) {
        if (P.upload_manager.user.networks[i].id === nid) {
          var net = P.upload_manager.user.networks[i];
          var networkStuff = {name:net.name, nid:net.id, files:[]};
          if (net.course_number)
            networkStuff.name = net.my_name;
          for (var fid in P.upload_manager.userData[nid]) {
            var fileStuff = P.upload_manager.userData[nid][fid];
            fileStuff.fid = fid;
            var size = parseInt(fileStuff.size);
            if (size > 1000000) size = Math.round(size / 10000) / 100 + "mb";
            else if (size > 1000) size = Math.round(size / 10) / 100 + "kb";
            else size = size + "b";
            fileStuff.size = size;
            networkStuff.files.push(fileStuff);
          }
          networkStuff.files.sort(function(a,b){
            if (a.created > b.created) return 1;
            if (a.created < b.created) return -1;
            return 0;
          });
          if (networkStuff.files.length > 0)
            data = networkStuff;
        }
      }
    }
    P.upload_manager.userDataPrepared = data;
  },
  show: function(callbacks) {
    if (callbacks) {
      P.upload_manager.submitCallback = callbacks.submit;
      P.upload_manager.cancelCallback = callbacks.cancel;
    } else {
      P.upload_manager.submitCallback = null;
      P.upload_manager.cancelCallback = null;
    }
    PA.call_pj("user.get_files", {}, null, function(data){
      P.upload_manager.userData = data;
      P.upload_manager.prepareData();
      if ($('#upload_manager').length == 0) {
        $('#modal_windows').append(P.upload_manager.template({network:P.upload_manager.network, data:P.upload_manager.userDataPrepared}));
      } else {
        $('#upload_manager').replaceWith(P.upload_manager.template({network:P.upload_manager.network, data:P.upload_manager.userDataPrepared}));
      }
      $('#modal_windows').show();
      $('#modal_windows').children().hide();
      $('#upload_manager').modal('show');
      setTimeout(function() {P.upload_manager.setUp();}, 500);
      /*
      $.fancybox({
              'autoScale': true,
              'hideOnOverlayClick': false,
              'padding': 0,
              'href': '#upload_manager',
              'showCloseButton': false,
              'transitionIn': 'none',
              'transitionOut': 'none'
      });
    */  

    }, function(err){
      alert("Error initializing file manager: " + err);
    });
  },
  setNetwork: function(network) {
    P.upload_manager.network = network;
  },
  init: function(module) {
    if (module.options.network)
      P.upload_manager.network = module.options.network;
    P.upload_manager.template = module.template;
    
    PEM.addListener("network", P.upload_manager.setNetwork);
    //PEM.addListener("setup_attachments", P.upload.setUp);
    //PEM.addListener("start_upload", P.upload.startUpload);
    PEM.addListener("showUploadManager", P.upload_manager.show);
  }
};
P.drafts = {
  template: null,
  draft: {},
  drafts: {},
  network: null,
  showing: false,
  autoSave: false,

  initHandlers: function() {
  },

  showDrafts: function() {
    P.drafts.showing = true;
    P.drafts.showDraftsFeed();
    P.drafts.draft = {};
    $('#question_feed_questions').find('.selected').removeClass('selected');
    $('#question_feed_questions').scrollTop(0);
    if (!P.drafts.autoSave && P.drafts.showing)
      P.drafts.saveDraftTimeout();
    return false;
  },
  showDraftsFeed: function() {
    $('#draft_group').remove();
    var arr = [];
    for (var id in P.drafts.drafts) {
      P.drafts.drafts[id].id = id;
      arr.push(P.drafts.drafts[id]);
    }
    arr.sort(function(a,b){ if (a.id > b.id) return -1; return 1;})
    $('#question_feed_questions').prepend(P.drafts.template({drafts:arr}));
    if (P.drafts.draft.id)
      $("#" + P.drafts.draft.id).addClass('selected');
    if (PA.user.config.hide_draft == "yes") {
      var $bucket = $('#bucket_draft');
      if ($bucket.find('span').html())
        $bucket.find('span').html('&#9656;' + $bucket.find('span').html().substring(1));
      $bucket.siblings('.item-list-in-bucket').hide();
    }
  },
  saveDraftTimeout: function() {
    P.drafts.autoSave = setTimeout(function(){
      P.drafts.saveDraft();
      P.drafts.saveDraftTimeout();
    }, 30000);
  },
  maybeShowDrafts: function() {
    if (P.drafts.showing)
      P.drafts.showDraftsFeed();
  },

  hideDrafts: function() {
    $('#draft_group').remove();
    P.drafts.showing = false;
    if (P.drafts.autoSave) {
      clearTimeout(P.drafts.autoSave);
      P.drafts.autoSave = false;
    }
  },

  saveDraft: function(onlyExisting) {
    var d = P.drafts.draft;
    d.content = PEM.callFirst("getEditorText", "old_new_post");
    if (!d.content && !$('#post_summary').val()) return;
    if (onlyExisting && !d.id) return;
    d.btn = {};
    d.txt = {};
    $('#old_new_post_window').find('input[type=radio], input[type=checkbox]').each(function(){
      if ($(this).attr('checked'))
        d.btn[$(this).attr('id')] = true;
      else
        d.btn[$(this).attr('id')] = false;
    });
    $('#old_new_post_window').find('input[type=text], select').each(function(){
      d.txt[$(this).attr('id')] = $(this).val();
    });
    d.folders = [];
    for (var folder in P.old_new_post.selectedFolders)
      d.folders.push(folder);
    d.pollChoices = P.old_new_post.pollChoices;
    d.selectedPrivateUsers = P.old_new_post.selectedPrivateUsers;
    P.drafts.draft = d;
    PA.call_pj("network.save_draft", {nid:P.drafts.network.id, draft:d}, 1, function(id) {
      $('#save_draft').html("Draft saved!");
      setTimeout(function(){$('#save_draft').html("Save Draft");}, 2000);
      if (!onlyExisting) {
        d.id = id;
        P.drafts.drafts[d.id] = d;
      }
      if (P.drafts.showing) P.drafts.showDraftsFeed();
    });
  },

  loadDraft: function(id) {
    if (id == P.drafts.deletedId) return;
    P.drafts.saveDraft(true); // save current draft, if one is open
    $('#question_feed_questions').find('.selected').removeClass('selected');
    $('#' + id).addClass('selected');
    if (P.drafts.drafts[id]) {
      P.drafts.draft = P.drafts.drafts[id];
      var d = P.drafts.draft;
      $('#old_new_post_window').find('input[type=radio], input[type=checkbox]').each(function(){
        if (d.btn[$(this).attr('id')]) {
          if (!$(this).attr('checked'))
            $(this).click();
        } else if ($(this).attr('type') == 'checkbox')
          $(this).attr('checked', false);
      });    
      $('#old_new_post_window').find('input[type=text], select').each(function(){
        $(this).val(d.txt[$(this).attr('id')]);
      });
      PEM.fire("setEditorText", {postfix:"old_new_post", text:d.content});
      
      var ff = {};
      for (var i = 0; i < d.folders.length; i++) {
        ff[d.folders[i]] = 1;
      }
      var folderElements = $("#new_folder_list > li > a")
      P.old_new_post.selectedFolders = {};
      folderElements.removeClass("selected");
      for (var i = 0; i < folderElements.length; i++) {
        var element = $(folderElements[i]);
        if (ff[element.text()])
          element.click();
      }
      P.old_new_post.selectedPrivateUsers = {};
      $(".poll_selected_user_list li").remove();
      $(".selected_user_list li").remove();
      P.old_new_post.pollChoices = d.pollChoices || [];
      P.old_new_post.redrawPollChoices();
      P.old_new_post.sectionTypeChange();
      P.old_new_post.subGroupChange();
      P.old_new_post.isAnnouncement();
      
      P.old_new_post.selectedPrivateUsers = {};
      if (d.btn.publish_to_individuals || d.btn.individual_members) {
        if (!P.old_new_post.usersAutoComplete) {
          P.old_new_post.loadAutocompleteUsers(function(){
            P.old_new_post.sectionTypeChange();
            for (var i = 0; i < P.old_new_post.usersAutoComplete.length; i++)
              if (d.selectedPrivateUsers[P.old_new_post.usersAutoComplete[i].id])
                P.old_new_post.selectIndividualUserToPost(i);
          });
        } else {
          for (var i = 0; i < P.old_new_post.usersAutoComplete.length; i++)
            if (d.selectedPrivateUsers[P.old_new_post.usersAutoComplete[i].id])
              P.old_new_post.selectIndividualUserToPost(i);
        }
      }
    }
  },
  toggleFolder: function() {
    var $bucket = $('#bucket_draft');
    var hideDraft = "no";
    if($bucket.siblings('.item-list-in-bucket').is(':visible')){
      $bucket.find('span').html('&#9656;' + $bucket.find('span').html().substring(1));
      $bucket.siblings('.item-list-in-bucket').hide();
      hideDraft = "yes";
    } else {
      $bucket.find('span').html('&#9662;' + $bucket.find('span').html().substring(1));
      $bucket.siblings('.item-list-in-bucket').show();
    }
    PA.user.config.hide_draft = hideDraft;
    PA.call_pj("user.set", {stat:"hide_draft", val:hideDraft}, 1);
  },
  deleteDraft: function(id) {
    $('#' + id).remove();
    P.drafts.deletedId = id;
    delete P.drafts.drafts[id];
    PA.call_pj("network.delete_draft", {nid:P.drafts.network.id, id:id}, null, function(){
      if (P.drafts.draft && P.drafts.draft.id == id) {
        P.drafts.draft = {};
      }
    });
    return false;
  },
  deleteCurentDraft: function() {
    if (P.drafts.draft && P.drafts.draft.id) {
      P.drafts.deleteDraft(P.drafts.draft.id);
      P.drafts.draft = {};
    }
  },
  setDrafts: function(dr) {
    if (dr)
      P.drafts.drafts = dr;
    else
      P.drafts.drafts = {};
    P.drafts.maybeShowDrafts();
  },

  init: function(module) {
    P.drafts.template = module.template;
    P.drafts.initHandlers()

    PEM.addListener("deleteCurrentDraft", P.drafts.deleteCurentDraft);
    PEM.addListener("saveDraft", P.drafts.saveDraft);
    PEM.addListener("showDrafts", P.drafts.showDrafts);
    PEM.addListener("cleanDashboard", P.drafts.hideDrafts);
    PEM.addListener("hideDrafts", P.drafts.hideDrafts);
    PEM.addListener("setDrafts", P.drafts.setDrafts);
    PEM.addListener("feed_created", P.drafts.maybeShowDrafts);
    PEM.addListener("network", function(n){ P.drafts.network = n; });
    if (module.options.network) {
      P.drafts.network = module.options.network;
    }
  }

};
P.old_new_post = {

  selectedFolders:   {},
  type:              "question",
  postTo:            "all",
  usersAutoComplete: null,
  selectedPrivateUsers: {},
  user:              null,
  network:           null,
  template:          null,
  pollChoices:       [],

  initEventHandlers: function() {

    //Click Handlers for New Post window Footer

    $('.show_more_folders').click(function() {
      P.old_new_post.showAllTags();
      return false;
    });
    $('#post_type_question').click(function() {
      P.old_new_post.switchToQuestion(this);
      return true;
    });
    $('#post_type_poll').click(function() {
      P.old_new_post.switchToPoll(this);
      return true;
    });
    $('#post_type_note').click(function() {
      P.old_new_post.switchToNote(this);
      return true;
    });
    $('#post_button').click(function() {
      P.old_new_post.submitPost();
      return false;
    });

    $("#add_poll_choice").click(function() {
      P.old_new_post.addPollChoice();
      return false;
    });

    $("#save_draft").click(function() {
      PEM.fire("saveDraft");      
      return false;
    });
    $("#post_cancel_button").click(function() {
      PEM.fire("cancelOneForce", "old_new_post");
      return false;
    });

    $("#new_folder_list > li > a").click(function() {
      P.old_new_post.selectTag(this, P.old_new_post.selectedFolders);
      return false;
    });

    $("input[name='post_to']").change(function() {
      P.old_new_post.sectionTypeChange();
    });

    $("input[name='publish_to']").change(function() {
      P.old_new_post.sectionTypeChange();
    });

    $("#posting_options_bypass_email").click(function() {
      P.old_new_post.sectionTypeChange();
    });

    $("#poll_member_names").keyup(function() {
      P.old_new_post.performUsersAutocomplete();
    });

    $("#member_names").keyup(function() {
      P.old_new_post.performUsersAutocomplete();
    });
    $("#input_poll_choice").keypress(function(e){
      if(e.which == 13) {
        P.old_new_post.addPollChoice();
        return false;
      }
    });
    $('#post_summary').keydown(function(event){
      if (event.which == 9) {
        PEM.fire("focusEditor", "old_new_post");
        return false;
      }
      return true;
    });
  },

  switchToQuestion: function(element) {
    $('#post_button').text('Post My Question!');
    $('#old_new_post_window .show_for_note_question').addClass('show');
    $('#old_new_post_window .show_for_poll').removeClass('show');
    $('#old_new_post_window .show_for_note').removeClass('show');
    $('#old_new_post_window .show_for_question').addClass('show');
    $(".post_type_box").removeClass("active");
    $(element).closest(".post_type_box").addClass("active");
    $('#announcement_wrapper').hide();
    P.old_new_post.type = "question";
    P.old_new_post.sectionTypeChange();

  },

  switchToNote: function(element) {
    $('#post_button').text('Post My Note!');
    $('#old_new_post_window .show_for_note_question').addClass('show');
    $('#old_new_post_window .show_for_poll').removeClass('show');
    $('#old_new_post_window .show_for_note').addClass('show');
    $('#old_new_post_window .show_for_question').removeClass('show');
    $(".post_type_box").removeClass("active");
    if ($('#entire_group').attr('checked'))
      $('#announcement_wrapper').show();
    $(element).closest(".post_type_box").addClass("active");
    P.old_new_post.type = "note";
    P.old_new_post.sectionTypeChange();

  },

  switchToPoll: function(element) {
    $('#post_button').text('Post My Poll!');
    $('#old_new_post_window .show_for_note_question').removeClass('show');
    $('#old_new_post_window .show_for_poll').addClass('show');
    $('#old_new_post_window .show_for_note').removeClass('show');
    $('#old_new_post_window .show_for_question').removeClass('show');
    $(".post_type_box").removeClass("active");
    $(element).closest(".post_type_box").addClass("active");
    $('#announcement_wrapper').hide();
    P.old_new_post.type = "poll";
    P.old_new_post.sectionTypeChange();

  },

  showAllTags: function() {
    $('#new_folder_list').addClass('show_all');
    $('.show_more_folders').hide();
  },

  setUser: function(user) {
    if ($.browser.msie) {
      setTimeout(function(){
        setTimeout(function(){$('#search-box').blur();}, 300);
      }, 500);
      $(".post_summary").focus();

    }

    P.old_new_post.user = user;
  },

  cancelNewPost: function() {
    alert('show post delete confirmation message if user started drafting post');
    $('#old_new_post_window').hide();
  },
  addPollChoice: function() {
    var choice = $('#input_poll_choice').val().trim();
    if (choice.length == 0) return;
    choice = choice.replace(/>/g, "&gt;");
    choice = choice.replace(/</g, "&lt;")
    P.old_new_post.pollChoices.push(choice);
    P.old_new_post.redrawPollChoices();
    $('#input_poll_choice').val('');
    $('#input_poll_choice').focus();
  },
  redrawPollChoices: function() {
    var html = "";
    for (var i = 0; i < P.old_new_post.pollChoices.length; i++) {
      html += '<li><span class="poll_option">' + P.old_new_post.pollChoices[i] + '</span>' +
                '<i class="icon-remove" onclick="return P.old_new_post.removePollChoice(' + i + ');"></i>' +
                '</li>'
    }
    $('#poll_options_preview').html(html);
  },
  removePollChoice: function(i) {
    if (i < P.old_new_post.pollChoices.length)
      P.old_new_post.pollChoices.splice(i, 1);
    P.old_new_post.redrawPollChoices();
    return false;
  },
  showNewPostVerify: function() {
    PEM.fire("verifyAnyCancel", P.old_new_post.showNewPost);
  },
  cloneNewPollVerify: function() {
    PEM.fire("verifyAnyCancel", P.old_new_post.cloneNewPoll);
  },
  cleanDashboard: function() {
    $('.main_panel').removeClass("private_post");
  },
  showNewPost: function(html) {

    var publish_later = false;
    var always_open = false;
    var anonymity = "yes";
    var revote = false;
    var multiple_selections = false;
    var bypass_email = false;
    var show_results = "av";


    html = html || "";
    PEM.fire("content", null);
    PEM.fire("cleanDashboard");
    PEM.fire("showDrafts");
    var hasManyFolders = P.old_new_post.network.folders.length > 20;
    P.old_new_post.selectedFolders = {};
    P.old_new_post.selectedSection = "";
    P.old_new_post.pollChoices = [];
    P.old_new_post.selectedPrivateUsers = {};
    var anon = PEM.callFirst("getAnonymityOptions");
    var net = P.old_new_post.network;
    net.isGroup = (net.type == "group");
    net.isNoVerify = (net.type == "no-verify");
    // sections
    if (net.config && net.config.class_sections && net.config.class_sections.sections.length > 0) {
      net.subGroups = net.config.class_sections.sections;
      // find first subgroup that is mine
      if (P.old_new_post.user.config.feed_groups) {
        for (var i = 0; i < net.subGroups.length; i++) {
          var sect = net.subGroups[i];
          var sectGroup = sect.toLowerCase() + "_" + net.id;
          if (P.old_new_post.user.config.feed_groups.exist(sectGroup)) {
            net.mySubgroup = sect;
            break;
          }
        }
      }
    }
    if ((!net.special_tags || net.special_tags.length == 0) && (!net.topics || net.topics.length == 0))
      net.hasNoFolders = true;
    $("#old_new_post_window").replaceWith(P.old_new_post.template({user:P.old_new_post.user, anon:anon, isInst:(P.old_new_post.user.isInst && !P.old_new_post.network.isGroup),
      network:P.old_new_post.network, hasManyFolders: hasManyFolders, publish_later: publish_later, always_open: always_open, anonymity: anonymity,
      revote: revote, multiple_selections: multiple_selections, bypass_email: bypass_email, show_results: show_results, is_clone: false}));
    P.old_new_post.sectionTypeChange();
    PEM.fire("injectEditor", {
      where: $("#old_new_post_editor"),
      postfix: "old_new_post",
      height: 150,
      text: html,
      cancel: function(){P.old_new_post.hideNewPost(true)},
      noSave: true
    });
    P.old_new_post.initEventHandlers();
    //P.old_new_post.initAttachments();
    $('#post_summary').focus();
    $('#post_summary').val('');
    if (P.old_new_post.network.type != "group" && PA.user.isInst)
      $('#post_type_note').click();
    else
      $('#post_type_question').click();
    if (net.mySubgroup) {
      $('#subgroup_dropdown').val(net.mySubgroup);
      P.old_new_post.subGroupChange();
    }
  },
  cloneNewPoll: function(html) {
    html = html || "";
    PEM.fire("cleanDashboard");
    var hasManyFolders = P.old_new_post.network.folders.length > 20;
    P.old_new_post.selectedFolders = {};
    P.old_new_post.selectedSection = "";
    var anon = PEM.callFirst("getAnonymityOptions");
    var net = P.old_new_post.network;
    net.isGroup = (net.type == "group");
    net.isNoVerify = (net.type == "no-verify");
    // sections
    if (net.config && net.config.class_sections && net.config.class_sections.sections.length > 0) {
      net.subGroups = net.config.class_sections.sections;
      // find first subgroup that is mine
      if (P.old_new_post.user.config.feed_groups) {
        for (var i = 0; i < net.subGroups.length; i++) {
          var sect = net.subGroups[i];
          var sectGroup = sect.toLowerCase() + "_" + net.id;
          if (P.old_new_post.user.config.feed_groups.exist(sectGroup)) {
            net.mySubgroup = sect;
            break;
          }
        }
      }
    }

    var allow_followups = P.poll_view.content.config.allow_followups;
    var always_open = P.poll_view.content.config.always_open;
    var anonymity = P.poll_view.content.config.anonymous;
    var close_after = P.poll_view.content.config.close_after;
    var publish_later = P.poll_view.content.config.publish_later;
    var unpublished = P.poll_view.content.config.unpublished;
    var revote = P.poll_view.content.config.revote;
    var show_results = P.poll_view.content.config.show_results;
    var multiple_selections = P.poll_view.content.config.multiple_selections;
    var bypass_email = P.poll_view.content.config.bypass_email;
    var body = P.poll_view.content.body;
    var title = P.poll_view.content.subject;
    var answer = P.poll_results.content.data.answer;

    var poll_options = body.split(/\r?\n/);

    clonePollOptions = [];
    for (var i = 0; i < poll_options.length; i++) {
      if (poll_options[i].indexOf('[o]') !== -1 || poll_options[i].indexOf('[*]') !== -1) {
        poll_options[i] = poll_options[i].replace(/<br\/>/g, "");
        poll_options[i] = poll_options[i].replace(/\[o\]/g, "");
        poll_options[i] = poll_options[i].replace(/\[\*\]/g, "");
        clonePollOptions.push(poll_options[i]);
      }
    }

    if (publish_later == 0)
      publish_later = false;
    else
      publish_later = true;

    if (always_open == 1)
      always_open = true;
    else
      always_open = false;

    if (revote == 1)
      revote = true;
    else
      revote = false;

    if (multiple_selections == 1)
      multiple_selections = true;
    else
      multiple_selections = false;
    if (bypass_email == 1)
      bypass_email = true;

    $("#old_new_post_window").replaceWith(P.old_new_post.template({user:P.old_new_post.user, anon:anon, isInst:(P.old_new_post.user.isInst && !P.old_new_post.network.isGroup),
      network:P.old_new_post.network, hasManyFolders: hasManyFolders, publish_later: publish_later, always_open: always_open, anonymity: anonymity,
      revote: revote, multiple_selections: multiple_selections, bypass_email: bypass_email, show_results: show_results, poll_options: clonePollOptions, is_clone: true}));

    PEM.fire("injectEditor", {
      where: $("#old_new_post_editor"),
      postfix: "old_new_post",
      height: 150,
      text: html,
      cancel: function(){P.old_new_post.hideNewPost(true)},
      noSave: true
    });
    P.old_new_post.initEventHandlers();
    $('#post_summary').focus();
    if (P.old_new_post.network.type != "group")
      $('#post_type_poll').click();
    if (net.mySubgroup) {
      $('#subgroup_dropdown').val(net.mySubgroup);
      P.old_new_post.subGroupChange();
    }
    $("#post_summary").val(title);
    var description = body.split(/\r?\n/)[0];
    if (description.indexOf('[o]') !== -1 || description.indexOf('[*]') !== -1) {
      description = null;
    }

    $("#rich_old_new_post").val(description);
    P.old_new_post.pollChoices = clonePollOptions;

    $("#input_poll_explanation").val(answer);

    if ($('#publish_later').attr('checked') && $('#post_type_poll').attr('checked')) {
      $('#bypassing_email').hide();
      P.old_new_post.postTo = "me";
    }

  },
  subGroupChange: function() {
    if (!P.old_new_post.network.config.class_sections) return;
    if (!$("#subgroup_dropdown").val()) return;
    var sect = $('#subgroup_dropdown').val().toLowerCase() + "_" + P.old_new_post.network.id;
    P.old_new_post.selectedSection = sect;
    P.old_new_post.selectedSectionError = false;
    $('#subgroup_list .error_wrapper').hide();
    var usr = P.old_new_post.user;
    if (usr.config && usr.config.feed_groups && usr.config.feed_groups.exist(sect)) {
      // do nothing here
    } else {
      if (usr.isInst) {
        $('#not-in-section-instructor').show();
      } else {
        if (P.old_new_post.network.config.class_sections.allow_enroll != 1) {
          $('#not-in-section-student').show();
          P.old_new_post.selectedSectionError = true;
        } else {
          $('#not-in-section-can-join').show();
          P.old_new_post.selectedSectionError = true;
        }
      }
    }
  },
  joinSection: function(sect) {
    if (!P.old_new_post.selectedSection || P.old_new_post.selectedSection == "") return false;
    if (P.old_new_post.network.config.class_sections.allow_enroll != 1) return false;
    PA.call_pj("network.manage_users_to_sections", {
      nid: P.old_new_post.network.id,
      section: sect,
      join: 1
    }, null, function(data) {
      if (!PA.user.config) PA.user.config = {};
      if (!PA.user.config.feed_groups) PA.user.config.feed_groups = [];
      PA.user.config.feed_groups.push(sect);
      P.old_new_post.subGroupChange();
      //PD.existingPost_SectionChange();
    }, function(err) {alert(err);});
    return false;
  },
  //initAttachments: function() {
  //  var params = {
  //    containerId: "old_new_post_window",
  //    browse_button: "add_attachment",
  //    listId: "attachment_list",
  //    network: P.old_new_post.network
  //  };
  //  P.modules.loadModule("upload", params, function() {
  //    PEM.fire("setup_attachments", params);
  //  }, null);
  //},

  previewPost: function() {
    P.modules.loadModule("preview_content", {}, function() {
        //console.log("Loaded preview_content.");
        PEM.fire("previewContent",
          {
            summary: $("#post_summary").val(),
            details: $("#post_details").val(),
            type: P.old_new_post.type
          }
        );
      }, null);
  },

  closeNewPost: function() {
    $('#new_post_window').hide();
  },

  minimizeNewPost: function() {
    $('#new_post_window .modal-body').hide();
    $('#new_post_window .modal-footer').hide();
    $('#new_post_window').addClass('minimize');
    $('.modal-header .minimize_new_post').addClass('hide');
    $('.modal-header .maximize_new_post').removeClass('hide');
  },

  maximizeNewPost: function() {
    $('#new_post_window .modal-body').show();
    $('#new_post_window .modal-footer').show();
    $('#new_post_window').removeClass('minimize');
    $('.modal-header .minimize_new_post').removeClass('hide');
    $('.modal-header .maximize_new_post').addClass('hide');
  },

  showIndividualUserInput: function() {
    $('#individual_members').change(function(){
      if ($(this).is(':checked')) {
        $('#member_names').show();
        $('#member_names_message').show();
      }
    });
  },

  showIndividualUserDropdown: function() {
    $('#member_names').keyup(function() {
        var value = $(this).val();
        if(value.length > 2){
          $('.dropdown-menu.user_list').show();
        }else{
          $('.dropdown-menu.user_list').hide();
        }
    });
  },

  hideIndividualUserInput: function() {
    $('#entire_group').change(function(){
      if ($(this).is(':checked')) {
        $('#member_names').hide();
        $('#member_names_message').hide();
      }
    });
  },

  selectTag: function(obj, hash) {
    var tag = $(obj).html();
    if (hash[tag]) {
      delete hash[tag];
      $(obj).removeClass('selected');
    } else {
      hash[tag] = true;
      $(obj).addClass('selected');
      $(".new_post_error.no_folders").removeClass("show");
    }
    return false;
  },
  loadAutocompleteUsers: function(callback) {
    if (P.old_new_post.network.type != "group" && !P.old_new_post.user.isInst) {
      // for students - only add existing instructors
      P.old_new_post.usersAutoComplete = [];
      for (var i = 0; i < P.old_new_post.network.profs.length; i++)
        P.old_new_post.usersAutoComplete.push(P.old_new_post.network.profs[i]);
      P.old_new_post.usersAutoComplete.push({name:"Instructors",id:"instr_" + P.old_new_post.network.id})
      if (callback)
        callback.call();
    } else {
      PA.call_pj("network.get_all_users", {nid: P.old_new_post.network.id}, $(".post_to"), function(data) {
        P.old_new_post.usersAutoComplete = data;
        if (P.old_new_post.network.type != "group")
          P.old_new_post.usersAutoComplete.push({name:"Instructors", id:"instr_" + P.old_new_post.network.id})
        if (callback)
          callback.call();
      });
    }
  },
  sectionTypeChange: function() {
    if ($('#publish_later').attr('checked') && $('#post_type_poll').attr('checked'))
      $('#bypassing_email').hide();
    else if (P.old_new_post.user.isInst)
      $('#posting_options_bypass_email').show();

    $('#announcement_wrapper').hide();
    if ($('#post_type_poll').attr('checked')) {
      if ($('#publish_later').attr('checked')) {
        $("#member_names").hide();
        $("#poll_member_names").hide();
        $("#member_names_message").hide();
        $("#poll_member_names_message").hide();
        $('.selected_user_list').hide();
        $('.poll_selected_user_list').hide();

        $('#subgroup_list').hide();
        P.old_new_post.postTo = "me";

      }
      else if ($('#publish_to_individuals').attr('checked')) {
      if (!P.old_new_post.usersAutoComplete) {
        P.old_new_post.selectedPrivateUsers = {};
        P.old_new_post.loadAutocompleteUsers(function(){
          if (!P.old_new_post.user.isInst && !P.old_new_post.network.isGroup) // auto-select instructors
            P.old_new_post.selectIndividualUserToPost(P.old_new_post.usersAutoComplete.length - 1);
        });
      }
      $("#poll_member_names").show();
      $("#poll_member_names_message").show();
      $('.poll_selected_user_list').show();
      $('#poll_subgroup_list').hide();
      $('#poll_member_names').focus();
      P.old_new_post.postTo = "individual";
      if (!P.old_new_post.user.isInst) {
        $('#post_anonymity_wrapper').hide();
        $('#new_post_anonymity').val('no');
      }
    }
    else if ($('#publish_now').attr('checked')) {
        $("#member_names").hide();
      $("#poll_member_names").hide();
      $("#member_names_message").hide();
      $("#poll_member_names_message").hide();
      $('.selected_user_list').hide();
      $('.poll_selected_user_list').hide();
      $('#subgroup_list').hide();
      if (P.old_new_post.type == "note")
        $('#announcement_wrapper').show();
      $(".new_post_error.no_names").removeClass("show");
      P.old_new_post.postTo = "all";
    }


    }
    else if ($('#entire_group').attr('checked')) {
      $("#member_names").hide();
      $("#poll_member_names").hide();
      $("#poll_member_names_message").hide();
      $("#member_names_message").hide();
      $('.selected_user_list').hide();
      $('.poll_selected_user_list').hide();
      $('#subgroup_list').hide();
      if (P.old_new_post.type == "note")
        $('#announcement_wrapper').show();
      $(".new_post_error.no_names").removeClass("show");
      P.old_new_post.postTo = "all";

      if (!P.old_new_post.user.isInst) $('#post_anonymity_wrapper').show();

    }
    else if ($('#individual_members').attr('checked')){

      if (!P.old_new_post.usersAutoComplete) {
        P.old_new_post.selectedPrivateUsers = {};
        P.old_new_post.loadAutocompleteUsers(function(){
          if (!P.old_new_post.user.isInst && !P.old_new_post.network.isGroup) // auto-select instructors
            P.old_new_post.selectIndividualUserToPost(P.old_new_post.usersAutoComplete.length - 1);
        });
      }
      $("#member_names").show();
      $("#poll_member_names").hide();
      $("#poll_member_names_message").hide();
      $("#member_names_message").show();
      $('.selected_user_list').show();
      $('#subgroup_list').hide();
      $('#member_names').focus();
      P.old_new_post.postTo = "individual";
      if (!P.old_new_post.user.isInst) {
        $('#post_anonymity_wrapper').hide();
        $('#new_post_anonymity').val('no');
      }
    }



    else {
      P.old_new_post.postTo = "all";

      if (!P.old_new_post.user.isInst) $('#post_anonymity_wrapper').show();
    }
    if ($('#class_subgroup').attr('checked')) {
      P.old_new_post.postTo = "section";
      $('#subgroup_list').show();
    }
  },

  performUsersAutocomplete: function() {
    if (!P.old_new_post.usersAutoComplete) {
      P.old_new_post.loadAutocompleteUsers();
      return;
    }
    if ($('#post_type_poll').attr('checked')) {
      var text = $('#poll_member_names').val().toLowerCase();
      var drop = $('#poll_member_names_dropdown_list').empty();
      var resultCount = 0;
      if (text.length > 0) {
        for (var i = 0; i < P.old_new_post.usersAutoComplete.length; i++) {
          var usr = P.old_new_post.usersAutoComplete[i];
          if (usr.us) continue;
          if (!usr.name) continue;
          //if (PD.selectedPrivateUsers[usr.id]) continue;
          if (usr.id == P.old_new_post.user.id) continue;
          if ((usr.name && usr.name.toLowerCase().indexOf(text) >= 0) ||
              (usr.email && usr.email.toLowerCase().indexOf(text) >= 0)) {
            var html = '<li class="clearFix" onclick="P.old_new_post.selectIndividualUserToPost(' + i + ');">';
            if (usr.id == "instr_" + P.old_new_post.network.id)
              html += '<div class="user_image"><div class="user_pic"><div class="white_border"><img title="Instructors" src="https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/default_user.png" onload="onImageLoad(event);" width="32" height="32" style="width: 32px; height: 32px; left: 0px; top: 0px;"></div></div></div>';
            else
              html += '<div class="user_image">' + PA.getUserPic(usr.id) + '</div>';
            html += '<div class="user_details">';
            html += '<div class="user_name">' + usr.name + '</div>';
            //html += '<div class="user_email">' + usr.email + '</div>';
            html += '</div></li>'
            drop.append(html);
            resultCount += 1;
          }
        }
        if (resultCount == 0) {
          drop.append('<li><div class="no_result">User not found</div></li>');
        }
        $('#poll_member_names_dropdown_list').show();
      } else {
        $('#poll_member_names_dropdown_list').hide();
      }

    }
    else {
      var text = $('#member_names').val().toLowerCase();
      var drop = $('#member_names_dropdown_list').empty();
      var resultCount = 0;
      if (text.length > 0) {
        for (var i = 0; i < P.old_new_post.usersAutoComplete.length; i++) {
          var usr = P.old_new_post.usersAutoComplete[i];
          if (usr.us) continue;
          if (!usr.name) continue;
          //if (PD.selectedPrivateUsers[usr.id]) continue;
          if (usr.id == P.old_new_post.user.id) continue;
          if ((usr.name && usr.name.toLowerCase().indexOf(text) >= 0) ||
              (usr.email && usr.email.toLowerCase().indexOf(text) >= 0)) {
            var html = '<li class="clearFix" onclick="P.old_new_post.selectIndividualUserToPost(' + i + ');">';
            if (usr.id == "instr_" + P.old_new_post.network.id)
              html += '<div class="user_image"><div class="user_pic"><div class="white_border"><img title="Instructors" src="https://dvngeac8rg9mb.cloudfront.net/images/dashboard/common/default_user.png" onload="onImageLoad(event);" width="32" height="32" style="width: 32px; height: 32px; left: 0px; top: 0px;"></div></div></div>';
            else
              html += '<div class="user_image">' + PA.getUserPic(usr.id) + '</div>';
            html += '<div class="user_details">';
            html += '<div class="user_name">' + usr.name + '</div>';
            //html += '<div class="user_email">' + usr.email + '</div>';
            html += '</div></li>'
            drop.append(html);
            resultCount += 1;
          }
        }
        if (resultCount == 0) {
          drop.append('<li><div class="no_result">User not found</div></li>');
        }
        $('#member_names_dropdown_list').show();
      } else {
        $('#member_names_dropdown_list').hide();
      }
    }
  },
  selectIndividualUserToPost: function(idx) {
    if ($('#post_type_poll').attr('checked')) {
      if (idx >= 0 && idx < P.old_new_post.usersAutoComplete.length) {
        var usr = P.old_new_post.usersAutoComplete[idx];
        if (!P.old_new_post.selectedPrivateUsers[usr.id]) {
          P.old_new_post.selectedPrivateUsers[usr.id] = 1;
          $('.poll_selected_user_list').append('<li id="individual_' + idx + '">' + P.old_new_post.usersAutoComplete[idx].name + ' <i class="icon-remove" onclick="return P.old_new_post.removeIndividualUserToPost(' + idx + ')"></i></li>');
        }
      }
      $('#poll_member_names').val('');
      return false;
    }
    else {
      if (idx >= 0 && idx < P.old_new_post.usersAutoComplete.length) {
        var usr = P.old_new_post.usersAutoComplete[idx];
        if (!P.old_new_post.selectedPrivateUsers[usr.id]) {
          P.old_new_post.selectedPrivateUsers[usr.id] = 1;
          $('.selected_user_list').append('<li id="individual_' + idx + '">' + P.old_new_post.usersAutoComplete[idx].name + ' <i class="icon-remove" onclick="return P.old_new_post.removeIndividualUserToPost(' + idx + ')"></i></li>');
        }
      }
      $('#member_names').val('');
      return false;
    }
  },
  removeIndividualUserToPost: function(idx) {
    if (idx >= 0 && idx < P.old_new_post.usersAutoComplete.length) {
      var usr = P.old_new_post.usersAutoComplete[idx];
      if (P.old_new_post.selectedPrivateUsers[usr.id]) {
        P.old_new_post.selectedPrivateUsers[usr.id] = false;
        $('#individual_' + idx).remove();
      }
    }
    return false;
  },
  submitPost: function() {
    if (P.old_new_post.submitPost_ValidateForm()) {
      P.old_new_post.submitPost_HandleSubmission();
    } else
      $('.main_panel').scrollTop(0);
    return false;
  },
  submitPost_ValidateForm: function() {
    // Validate the title and details fields.
    var titleIsValid    = P.old_new_post.submitPost_ValidateTitle();
    var tagIsValid      = P.old_new_post.submitPost_ValidateFolders();
    // var detailsAreValid = P.old_new_post.submitPost_ValidateDetails();

    if (P.old_new_post.postTo == "individual") {// check if user selected anything
      var cnt = 0;
      for (var z in P.old_new_post.selectedPrivateUsers)
        if (P.old_new_post.selectedPrivateUsers[z]) {
          cnt += 1;
        }
      if (cnt == 0) {
        $(".new_post_error.no_names").addClass("show");
        $(".new_post_error.too_many_names").removeClass("show");
        return false;
      } else {
        $(".new_post_error.no_names").removeClass("show");
      }
      if (cnt > 10) {
        $(".new_post_error.no_names").removeClass("show");
        $(".new_post_error.too_many_names").addClass("show");
        return false;
      } else {
        $(".new_post_error.too_many_names").removeClass("show");
      }
    }

    if (P.old_new_post.postTo == "section") {
      if (P.old_new_post.selectedSectionError) return false;
    }
    return (titleIsValid && tagIsValid);// && detailsAreValid);
  },
  submitPost_ValidateTitle: function() {

    var $wrapper = $('#post_summary');
    var title = $wrapper.val();

    /* Hide all existing Post Summary error messages. */
    $wrapper.siblings(".new_post_error").removeClass("show");

    var isValid = true;
    if (title.length <= 0) {
      $wrapper.siblings(".new_post_error.no_summary").addClass("show");
      isValid = false;
    } else if (title.length > 100) {
      $wrapper.siblings(".new_post_error.long_summary").addClass("show");
      isValid = false;
    }

    return isValid;

  },
  submitPost_ValidateFolders: function() {
    var isValid = true;
    if (P.old_new_post.network.config.disable_folders) return true;
    var cnt = 0;
    for (var s in P.old_new_post.selectedFolders) cnt += 1;
    if (cnt == 0) {
      $(".new_post_error.no_folders").addClass("show");
      isValid = false;
    } else {
      $(".new_post_error.no_folders").removeClass("show");
    }
    return isValid;
  },
  submitPost_ValidateDetails: function() {

    var text = PEM.callFirst("getEditorText", "old_new_post");

    var isValid = true;
    if (text.length <= 0) {
      $('.new_post_error.no_details').addClass('show');
      isValid = false;
    } else {
      $('.new_post_error.no_details').addClass('hide');
    }

    return isValid;

  },
  submitPost_HandleSubmission: function() {
    var type = P.old_new_post.type;
    var subject = $("#post_summary").val();
    var content = PEM.callFirst("getEditorText", "old_new_post");
    // anonymity
    var anonymity = $("#new_post_anonymity").val();
    if (!anonymity)
      anonymity = "no";
    var status = "active";

    var params = {
      nid:          P.old_new_post.network.id,
      type:         type,
      subject:      subject,
      content:      content,
      anonymous:    anonymity,
      client_time:  (new Date()).format("m/dd/yy h:MM TT"),
      status:       status,
      folders:      []
    };

    // populate folders
    var config = {};
    for (var folder in P.old_new_post.selectedFolders)
      params.folders.push(folder);

    if ($('#posting_options_bypass_email').attr('checked') == 'checked') {
      config.bypass_email = 1;
      params.prof_override = true;
    }
    if (type == "note" && $('#posting_options_announcement').attr('checked')) {
      config.is_announcement = 1;
    }

    // who to post to?
    if (P.old_new_post.postTo == "individual") {
      var feedGroups = "";
      for (var z in P.old_new_post.selectedPrivateUsers)
        if (P.old_new_post.selectedPrivateUsers[z]) {
          feedGroups += (feedGroups.length == 0 ? "" : "," ) + z;
        }
      if (feedGroups == "") return false;
      feedGroups += "," + PA.user.id;
      config.feed_groups = feedGroups;
    }
    if (P.old_new_post.postTo == "me") {
      var feedGroups = "instr_" + P.old_new_post.network.id;
      feedGroups += "," + PA.user.id;
      config.feed_groups = feedGroups;
      config.publish_later = 1;
      config.unpublished = 1;
    }

    if (P.old_new_post.postTo == "section") {
      config.feed_groups = P.old_new_post.selectedSection;
    }
    if ($('#posting_options_no_email').attr('checked')) {
      config.emails_notifications = false;
      config.resolved_followups = true;
    }

    // poll
    if (type == "poll") {
      config.anonymous = "no";
      config.show_results = "av"; //av = after vote; ac = after close; "" = right away; nn = never
      config.close_after = $("#poll_close_date_menu").val();
      config.allow_followups = "yes";
      config.always_open = 0;
      config.revote = 0;
      config.publish_later = 0;
      config.unpublished = 0;
      config.bypass_email = 0;
      config.toggle_visibility_on = 1;

      var explanation = $('#input_poll_explanation').val().trim();
      config.answer = explanation;

      var pollOption = "[o]";
      if ($('#selections_allowed_more').is(':checked')) {
        config.multiple_selections = 1;
        pollOption = "[*]";
      }
      else
        config.multiple_selections = 0;
      var opts = P.old_new_post.pollChoices;
      var optCount = 0;
      for (var q = 0; q < opts.length; q++) {
        if (opts[q].length > 0) {
          content += "\n" + pollOption + " " + opts[q];
          optCount++;
        }
      }
      if (optCount < 1) {
        $(".new_post_error.no_poll_choices").addClass("show");
        $('#appendedInputButton').focus();
        return false;
      } else {
        $(".new_post_error.no_poll_choices").removeClass("show");
      }

      params.content = content;




      if ($("#poll_close_date_never").is(":checked")) config.always_open = 1;
      if ($("#show_poll_results_before_member_votes").is(":checked"))
        config.show_results = "";
      else if ($("#show_poll_results_after_poll_closes").is(":checked"))
        config.show_results = "ac";
      else if ($("#show_poll_results_keep_private").is(":checked"))
        config.show_results = "nn";

      if ($("#poll_anonymity_nobody").is(":checked"))
        config.anonymous = "yes";
      if ($("#poll_anonymity_students").is(":checked"))
        config.anonymous = "stud";

      if ($("#revotes_yes").is(":checked")) {
        config.revote = 1;
      }
      if ($("#revotes_no").is(":checked")) {
        config.revote = 0;
      }


      if ($('#posting_options_bypass_email').attr('checked') == 'checked') {
        config.bypass_email = 1;
        params.prof_override = true;
      }

      if (P.old_new_post.postTo === "me") {
        config.publish_later = 1;
        config.unpublished = 1;
      }
      else {
        config.publish_later = 0;
        config.unpublished = 0;
      }


      }


    params.config = config;

    PA.call_pj('content.create', params, $('#page_center'), function(data) {

    if (type == "poll") {
        var params = {
          cid: data.id,
          action: "set",
          answer: explanation,
        };

    }

      // delete current draft
      PEM.fire("deleteCurrentDraft");
      // hide form
      PEM.fire("cancelOneForce", "old_new_post");
      P.old_new_post.pollChoices = [];
      if ($('#attachment_list').children().length > 0)
        PEM.fire("start_upload", data.id);
      PEM.fire("cleanDashboard");
      data.my_post = true;
      data.default_anonymity = anonymity;
      PEM.fire("content", data);
    }, function(err) {
      alert(err);
    });

    return true;
  },
  setNetwork: function(network) {
    P.old_new_post.network = network;
    P.old_new_post.usersAutoComplete = null; // do not want to auto-load this! expensive on server.
    P.old_new_post.selectedPrivateUsers = {};
    // see if we need to show prepopulated stuff
    if (typeof(AUTO_POST) != 'undefined' && AUTO_POST) {
      if (P.old_new_post.user.resource_note_info && P.old_new_post.user.isInst) {
        P.old_new_post.selectPrepopulatedNote(P.old_new_post.user.resource_note_info);
      } else {
        P.old_new_post.showNewPost();
        $('#posting_options_announcement').attr('checked', true);
        P.old_new_post.isAnnouncement();
      }
      AUTO_POST = false;
    }
  },
  isAnnouncement: function() {
    if ($('#posting_options_announcement').attr('checked'))
      $('#new_post_alert_announcement').show();
    else
      $('#new_post_alert_announcement').hide();
  },
  selectPrepopulatedNote: function(resource_info) {
    var subject = resource_info['title'] + " has been added to class homepage under Resources";

    var url = "";
    if (resource_info['resource_type'] == 'file') {
      url = "http://www.piazza.com/class_profile/get_resource/" + P.old_new_post.network.id + "/" + resource_info['rid'];
    } else if (resource_info['resource_type'] == 'link') {
      url = resource_info['content'];
    }
    if (resource_info['section'] == 'lecture_notes') resource_info['section'] = "lecture notes"

    var school = P.old_new_post.network.school_ext
    var term = P.old_new_post.network.term.toLowerCase().replace(/\s+/g, "") || "other";
    var shortNumber = P.old_new_post.network.short_number;
    var html = "";
    html += "The teaching staff has posted a new " + resource_info['section'] + " resource."
    html += "<br /><br />Title: " + resource_info['title'] + "<br />";
    if (url != "") html += url + "<br />";
    if (resource_info['date']) html += "<br/> Due date: " + resource_info['date'];
    html += "<br /><br />";
    html += 'You can view it on the course page: '
    html += 'https://piazza.com/' + school + '/' + term + '/' + shortNumber + '/resources'
    html += '<br />';
    P.old_new_post.showNewPost(html);
    $('#post_summary').val(subject);
  },
  hideNewPost: function(showHomeScreen) {
    $("#old_new_post_window").hide();
    PEM.fire("hideDrafts");
    if (showHomeScreen)
      PEM.fire("showHomescreen");
  },

  init: function(module) {
    P.old_new_post.template = module.template;
    PEM.addListener("network", P.old_new_post.setNetwork);
    PEM.addListener("show_new_post", P.old_new_post.showNewPostVerify);
    PEM.addListener("clone_new_poll", P.old_new_post.cloneNewPollVerify);
    PEM.addListener("content", function(){P.old_new_post.hideNewPost(false)});
    PEM.addListener("cleanDashboard", P.old_new_post.cleanDashboard);
    if (module.options.user)
      P.old_new_post.user = module.options.user;
    if (module.options.network) {
      P.old_new_post.setNetwork(module.options.network);
    }
  }
};
P.history_slider = {
  network:null,  
  content:null,
  user:null,
  template:null,
  slider:null,
  curHistory:null,
  highlight:null,

  recentActivityTemplates: {update:"updated the %w",
    s_answer: "started off the students' response", i_answer: "started off the instructors' response",
    question_update: "edited the question", note_update: "edited the note",
    attach: "added attachment", dupe: "marked duplicate to this %w",
    s_answer_update: "enhanced the students' response", i_answer_update: "enhanced the instructors' response",
    followup: "asked a follow-up question", feedback: "added a comment to the followup discussion",
    tag_endorse_add: "endorsed the %w", tag_endorse_remove: "un-endorsed the %w",
    tag_flag_add: "flagged the %w", tag_flag_remove: "un-flagged the %w",
    tag_good_add: "thinks this is a good %w", tag_good_remove: "no longer thinks this is a good %w",
    tag_disagree_add: "disagrees with %w", tag_disagree_remove: "no longer disagrees with %w"
  },
  contentTypes: {
  	question: "Question", note: "Note", poll: "Poll",
  	s_answer: "students' response", i_answer: "instructors' response"
  },
  setNetwork: function(network) {
    P.history_slider.network = network;
  },
  setContent: function(content) {
    P.history_slider.content = content;
    if (!content) return;
    var haveHistory = false;
    var max = 0;
    if (content && content.change_log) {
      // first get rid of non-existant followups
      var followupCount = 0;
      var replyCount = 0;
      for (var i = 0; i < content.children.length; i++) {
        var c = content.children[i];
        if (c.type == "followup") {
          followupCount += 1;
          replyCount += c.children.length;
        }
      }
      var cl = content.change_log;
      for (var i = 0; i < cl.length; i++) {
        if (cl[i].type == "followup") {
          if (followupCount > 0)
            followupCount -= 1;
          else {
            cl.splice(i, 1);
            i -= 1;
          }
        }
        if (cl[i].type == "feedback") {
          if (replyCount > 0)
            replyCount -= 1;
          else {
            cl.splice(i, 1);
            i -= 1;
          }
        }
      }
      max = content.change_log.length;
      var contentType = content.type;
      P.history_slider.curHistory = null;
      contentType = contentType.charAt(0).toUpperCase() + contentType.slice(1);
      content.disabledHistory = content.tags.exist("no_history");
      haveHistory = (max > 1) && !content.disabledHistory;
      $('#history_slider_wrapper').html(P.history_slider.template({content:content,haveHistory:haveHistory, type:contentType}));
      if (max > 1) {
        $('.main_panel').css("top", "23px");
        $('#history_slider').show();
      } else {
        $('.main_panel').css("top", "0px");
        $('#history_slider').hide();
      }
    }
    if (haveHistory) {
      var red = 0;
      var feedItem = PEM.callFirst("getSelectedItem");
      if (feedItem) {
        if (feedItem.version && feedItem.main_version) {
          red = feedItem.main_version - feedItem.version;
          if (feedItem.version == 0 || (feedItem.version == 1 && feedItem.main_version > 4)) ret = 0;
        }
        feedItem.version = feedItem.main_version;
      }
      P.history_slider.slider = $('#actual_history_slider').slider({
        tooltip:'hide',
        min:0,
        max:max-1,
        value:max-1,
        red:red
      }).on('slide', function(ev){
        var val = P.history_slider.slider.getValue();
        if (val != P.history_slider.curHistory) {
          P.history_slider.curHistory = val;
          var activity = P.history_slider.content.change_log[val];
          P.history_slider.showActivity(activity);
          P.history_slider.showHistory(val);
        }
      }).on('slideStop', function(ev){
        P.history_slider.curHistory = null;
        if (P.history_slider.removeHistory) clearTimeout(P.history_slider.removeHistory);
        P.history_slider.removeHistory = setTimeout(function(){
          $('#question_history_description_wrapper').fadeOut();
          $('.attachments_item').css("border", "none");
          PEM.fire("hideHistoryHighlight");
        }, 1500);
      }).data('slider');
    }
  },
  toggleHistory: function() {
    var content = P.history_slider.content;
    var params = {cid:content.id};
    if (content.disabledHistory) { //enable
      params.hide = "no";
      content.tags.remove("no_history");
    } else { //disable
      params.hide = "yes";
      content.tags.push("no_history");
    }
    PA.call_pj("content.show_hide_history", params, 1, function(data){
      PEM.fire("content", content);
    });
  },
  showActivity: function(activity) {
    var content = P.history_slider.content;
    var highlight = "question";
    if (activity.to) {
      for (var i = 0; i < content.children.length; i++) {
        if (activity.to == content.children[i].id) {
          content = content.children[i];
          highlight = content.type;
        }
      }
    }
    if (activity["for"]) {
      for (var i = 0; i < content.children.length; i++) {
        if (activity["for"] == content.children[i].type) {
          content = content.children[i];
          highlight = content.type;
        }
      }
    }
    var c_type = content.type;
    if (activity["for"]) c_type = activity["for"];
    var what = P.history_slider.contentTypes[c_type];
    // special case for followup
    var type = activity.type;
    if (activity.action) type = type + "_" + activity.action;
    var tmp = P.history_slider.recentActivityTemplates[type];
    if (type == "followup" || type == "dupe") highlight = "followup";
    if (type == "feedback") highlight = "feedback";
    if (type == "attach") highlight = "attach";
    if (type == "s_answer" || type == "s_answer_update") highlight = "s_answer";
    if (type == "i_answer" || type == "i_answer_update") highlight = "i_answer";
    if (type == 'create') {
      if (content.type == 'question') tmp = 'asked a question';
      if (content.type == 'note') tmp = 'posted a note';
    }
    if (tmp) tmp = tmp.replace(/%w/g, what);
    var pic = "";
    if (type == "attach") {
      tmp = "Anonymous " + tmp;
      pic = PA.getUserPic()
    } else {
      tmp = PA.getUserName(activity.uid) + " " + tmp;
      pic = PA.getUserPic(activity.uid)
    }
    $('#question_history_image').html(pic);
    $('#question_history_timestamp').html(activity.when.toRelativeTime());
    $('#question_history_data').html(tmp + ". ");
    $('#question_history_description_wrapper').show();
    P.history_slider.highlight = highlight;
  },
  showHistory: function(val) {
    var history = {q_idx:0,sa_idx:0,ia_idx:0,hide_followups:0,hide_feedbacks:0,hide_attach:0,
              hide:{},tag_good:{},tag_endorse_i:{},tag_endorse_s:{}};
    // calculate what to hide
    for (var i = val + 1; i < P.history_slider.content.change_log.length; i++) {
      var item = P.history_slider.content.change_log[i];
      if (item.type == "s_answer" || item.type == "s_answer_update") history.sa_idx++;
      if (item.type == "i_answer" || item.type == "i_answer_update") history.ia_idx++;
      if (item.type == "question" || item.type == "update") history.q_idx++;
      if (item.type == "tag_good") history.tag_good[item.uid] = 1;
      if (item.type == "tag_endorse" && item["for"] == "i_answer") history.tag_endorse_i[item.uid] = 1;
      if (item.type == "tag_endorse" && item["for"] == "s_answer") history.tag_endorse_s[item.uid] = 1;
      if (item.type == "followup") history.hide_followups++;
      if (item.type == "feedback") history.hide_feedbacks++;
      if (item.type == "attach") history.hide_attach++;      
    }
    history.highlight = P.history_slider.highlight;
    PEM.fire("history", history);
    // special handing of attachments
    $('.attachments_item').css("border", "none");
    var allAttach = [];
    for (var id in ATTACHMENTS)
      allAttach.push({id:id,u:ATTACHMENTS[id].updated});
    allAttach = allAttach.sort(function(a,b){
      if(a.u > b.u) return -1;
      if(a.u < b.u) return 1;
      return 0;
    });
    // hide unneeded attachments
    $('.attachments_item').show();
    for (var i = 0; i < history.hide_attach; i++)
      $('#attach_' + allAttach[i].id).hide();
    if (history.highlight == "attach") {
      if (history.hide_attach < allAttach.length) {
        $('#attach_' + allAttach[history.hide_attach].id).css("border-top","2px solid #0f0");
        $('#attach_' + allAttach[history.hide_attach].id).css("border-bottom","2px solid #0f0");
        $('.main_panel').scrollTo('#attach_' + allAttach[history.hide_attach].id);
      }
    }
  },
  setUser: function(user) {
    P.history_slider.user = user;
  },
  
  init: function(module) {
    PEM.addListener("network", P.history_slider.setNetwork);
    PEM.addListener("content", P.history_slider.setContent);
    PEM.addListener("toggle_history", P.history_slider.toggleHistory);
    if (module.options.network)
      P.history_slider.network = module.options.network;
    P.history_slider.template = module.template;
  }
}


/*****************************************************************
 *
 *****************************************************************/


!function( $ ) {

	var Slider = function(element, options) {
		this.element = $(element);
    var ticks = "";
    for (var i = 0; i < options.max - 1; i++) {
      var percent = ((i + 1) / options.max) * 100;
      ticks += '<div class="slider-tick" style="left:' + percent + '%"></div>';
    }
    var red = "";
    if (options.red && options.red > 0) {
      // make red
      var left = 100 - (options.red / options.max) * 100;
      var width = 100 - left;
      red = '<div class="slider-red" style="left:' + left + '%;width:' + width + '%"></div>';
    }
		this.picker = $('<div class="slider">'+
							'<div class="slider-track">'+
								'<div class="slider-selection"></div>'+
                red + ticks +
								'<div class="slider-handle"></div>'+
								'<div class="slider-handle"></div>'+
							'</div>'+
							'<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'+
						'</div>')
							.insertBefore(this.element)
							.append(this.element);
		this.id = this.element.data('slider-id')||options.id;
		if (this.id) {
			this.picker[0].id = this.id;
		}

		if (typeof Modernizr !== 'undefined' && Modernizr.touch) {
			this.touchCapable = true;
		}

		var tooltip = this.element.data('slider-tooltip')||options.tooltip;

		this.tooltip = this.picker.find('.tooltip');
		this.tooltipInner = this.tooltip.find('div.tooltip-inner');

		this.orientation = this.element.data('slider-orientation')||options.orientation;
		switch(this.orientation) {
			case 'vertical':
				this.picker.addClass('slider-vertical');
				this.stylePos = 'top';
				this.mousePos = 'pageY';
				this.sizePos = 'offsetHeight';
				this.tooltip.addClass('right')[0].style.left = '100%';
				break;
			default:
				this.picker
					.addClass('slider-horizontal')
					.css('width', this.element.outerWidth());
				this.orientation = 'horizontal';
				this.stylePos = 'left';
				this.mousePos = 'pageX';
				this.sizePos = 'offsetWidth';
				this.tooltip.addClass('top')[0].style.top = -this.tooltip.outerHeight() - 14 + 'px';
				break;
		}

		this.min = this.element.data('slider-min')||options.min;
		this.max = this.element.data('slider-max')||options.max;
		this.step = this.element.data('slider-step')||options.step;
		this.value = this.element.data('slider-value')||options.value;
		if (this.value[1]) {
			this.range = true;
		}

		this.selection = this.element.data('slider-selection')||options.selection;
		this.selectionEl = this.picker.find('.slider-selection');
		if (this.selection === 'none') {
			this.selectionEl.addClass('hide');
		}
		this.selectionElStyle = this.selectionEl[0].style;


		this.handle1 = this.picker.find('.slider-handle:first');
		this.handle1Stype = this.handle1[0].style;
		this.handle2 = this.picker.find('.slider-handle:last');
		this.handle2Stype = this.handle2[0].style;

		var handle = this.element.data('slider-handle')||options.handle;
		switch(handle) {
			case 'round':
				this.handle1.addClass('round');
				this.handle2.addClass('round');
				break
			case 'triangle':
				this.handle1.addClass('triangle');
				this.handle2.addClass('triangle');
				break
		}

		if (this.range) {
			this.value[0] = Math.max(this.min, Math.min(this.max, this.value[0]));
			this.value[1] = Math.max(this.min, Math.min(this.max, this.value[1]));
		} else {
			this.value = [ Math.max(this.min, Math.min(this.max, this.value))];
			this.handle2.addClass('hide');
			if (this.selection == 'after') {
				this.value[1] = this.max;
			} else {
				this.value[1] = this.min;
			}
		}
		this.diff = this.max - this.min;
		this.percentage = [
			(this.value[0]-this.min)*100/this.diff,
			(this.value[1]-this.min)*100/this.diff,
			this.step*100/this.diff
		];

		this.offset = this.picker.offset();
		this.size = this.picker[0][this.sizePos];

		this.formater = options.formater;

		this.layout();

		if (this.touchCapable) {
			// Touch: Bind touch events:
			this.picker.on({
				touchstart: $.proxy(this.mousedown, this)
			});
		} else {
			this.picker.on({
				mousedown: $.proxy(this.mousedown, this)
			});
		}

		if (tooltip === 'show') {
			this.picker.on({
				mouseenter: $.proxy(this.showTooltip, this),
				mouseleave: $.proxy(this.hideTooltip, this)
			});
		} else {
			this.tooltip.addClass('hide');
		}
	};

	Slider.prototype = {
		constructor: Slider,

		over: false,
		inDrag: false,

		showTooltip: function(){
			this.tooltip.addClass('in');
			//var left = Math.round(this.percent*this.width);
			//this.tooltip.css('left', left - this.tooltip.outerWidth()/2);
			this.over = true;
		},

		hideTooltip: function(){
			if (this.inDrag === false) {
				this.tooltip.removeClass('in');
			}
			this.over = false;
		},

		layout: function(){
			this.handle1Stype[this.stylePos] = this.percentage[0]+'%';
			this.handle2Stype[this.stylePos] = this.percentage[1]+'%';
			if (this.orientation == 'vertical') {
				this.selectionElStyle.top = Math.min(this.percentage[0], this.percentage[1]) +'%';
				this.selectionElStyle.height = Math.abs(this.percentage[0] - this.percentage[1]) +'%';
			} else {
				this.selectionElStyle.left = Math.min(this.percentage[0], this.percentage[1]) +'%';
				this.selectionElStyle.width = Math.abs(this.percentage[0] - this.percentage[1]) +'%';
			}
			if (this.range) {
				this.tooltipInner.text(
					this.formater(this.value[0]) +
					' : ' +
					this.formater(this.value[1])
				);
				this.tooltip[0].style[this.stylePos] = this.size * (this.percentage[0] + (this.percentage[1] - this.percentage[0])/2)/100 - (this.orientation === 'vertical' ? this.tooltip.outerHeight()/2 : this.tooltip.outerWidth()/2) +'px';
			} else {
				this.tooltipInner.text(
					this.formater(this.value[0])
				);
				this.tooltip[0].style[this.stylePos] = this.size * this.percentage[0]/100 - (this.orientation === 'vertical' ? this.tooltip.outerHeight()/2 : this.tooltip.outerWidth()/2) +'px';
			}
		},

		mousedown: function(ev) {

			// Touch: Get the original event:
			if (this.touchCapable && ev.type === 'touchstart') {
				ev = ev.originalEvent;
			}

			this.offset = this.picker.offset();
			this.size = this.picker[0][this.sizePos];

			var percentage = this.getPercentage(ev);

			if (this.range) {
				var diff1 = Math.abs(this.percentage[0] - percentage);
				var diff2 = Math.abs(this.percentage[1] - percentage);
				this.dragged = (diff1 < diff2) ? 0 : 1;
			} else {
				this.dragged = 0;
			}

			this.percentage[this.dragged] = percentage;
			this.layout();

			if (this.touchCapable) {
				// Touch: Bind touch events:
				$(document).on({
					touchmove: $.proxy(this.mousemove, this),
					touchend: $.proxy(this.mouseup, this)
				});
			} else {
				$(document).on({
					mousemove: $.proxy(this.mousemove, this),
					mouseup: $.proxy(this.mouseup, this)
				});
			}

			this.inDrag = true;
			var val = this.calculateValue();
			this.element.trigger({
					type: 'slideStart',
					value: val
				}).trigger({
					type: 'slide',
					value: val
				});
			return false;
		},

		mousemove: function(ev) {

			// Touch: Get the original event:
			if (this.touchCapable && ev.type === 'touchmove') {
				ev = ev.originalEvent;
			}

			var percentage = this.getPercentage(ev);
			if (this.range) {
				if (this.dragged === 0 && this.percentage[1] < percentage) {
					this.percentage[0] = this.percentage[1];
					this.dragged = 1;
				} else if (this.dragged === 1 && this.percentage[0] > percentage) {
					this.percentage[1] = this.percentage[0];
					this.dragged = 0;
				}
			}
			this.percentage[this.dragged] = percentage;
			this.layout();
			var val = this.calculateValue();
			this.element
				.trigger({
					type: 'slide',
					value: val
				})
				.data('value', val)
				.prop('value', val);
			return false;
		},

		mouseup: function(ev) {
			if (this.touchCapable) {
				// Touch: Bind touch events:
				$(document).off({
					touchmove: this.mousemove,
					touchend: this.mouseup
				});
			} else {
				$(document).off({
					mousemove: this.mousemove,
					mouseup: this.mouseup
				});
			}

			this.inDrag = false;
			if (this.over == false) {
				this.hideTooltip();
			}
			this.element;
			var val = this.calculateValue();
			this.element
				.trigger({
					type: 'slideStop',
					value: val
				})
				.data('value', val)
				.prop('value', val);
			return false;
		},

		calculateValue: function() {
			var val;
			if (this.range) {
				val = [
					(this.min + Math.round((this.diff * this.percentage[0]/100)/this.step)*this.step),
					(this.min + Math.round((this.diff * this.percentage[1]/100)/this.step)*this.step)
				];
				this.value = val;
			} else {
				val = (this.min + Math.round((this.diff * this.percentage[0]/100)/this.step)*this.step);
				this.value = [val, this.value[1]];
			}
			return val;
		},

		getPercentage: function(ev) {
			if (this.touchCapable) {
				ev = ev.touches[0];
			}
			var percentage = (ev[this.mousePos] - this.offset[this.stylePos])*100/this.size;
			percentage = Math.round(percentage/this.percentage[2])*this.percentage[2];
			return Math.max(0, Math.min(100, percentage));
		},

		getValue: function() {
			if (this.range) {
				return this.value;
			}
			return this.value[0];
		},

		setValue: function(val) {
			this.value = val;

			if (this.range) {
				this.value[0] = Math.max(this.min, Math.min(this.max, this.value[0]));
				this.value[1] = Math.max(this.min, Math.min(this.max, this.value[1]));
			} else {
				this.value = [ Math.max(this.min, Math.min(this.max, this.value))];
				this.handle2.addClass('hide');
				if (this.selection == 'after') {
					this.value[1] = this.max;
				} else {
					this.value[1] = this.min;
				}
			}
			this.diff = this.max - this.min;
			this.percentage = [
				(this.value[0]-this.min)*100/this.diff,
				(this.value[1]-this.min)*100/this.diff,
				this.step*100/this.diff
			];
			this.layout();
		}
	};

	$.fn.slider = function ( option, val ) {
		return this.each(function () {
			var $this = $(this),
				data = $this.data('slider'),
				options = typeof option === 'object' && option;
			if (!data)  {
				$this.data('slider', (data = new Slider(this, $.extend({}, $.fn.slider.defaults,options))));
			}
			if (typeof option == 'string') {
				data[option](val);
			}
		})
	};

	$.fn.slider.defaults = {
		min: 0,
		max: 10,
		step: 1,
		orientation: 'horizontal',
		value: 5,
		selection: 'before',
		tooltip: 'show',
		handle: 'round',
		formater: function(value) {
			return value;
		}
	};

	$.fn.slider.Constructor = Slider;

}( window.jQuery );


;(function($){var h=$.scrollTo=function(a,b,c){$(window).scrollTo(a,b,c)};h.defaults={axis:'xy',duration:parseFloat($.fn.jquery)>=1.3?0:1,limit:true};h.window=function(a){return $(window)._scrollable()};$.fn._scrollable=function(){return this.map(function(){var a=this,isWin=!a.nodeName||$.inArray(a.nodeName.toLowerCase(),['iframe','#document','html','body'])!=-1;if(!isWin)return a;var b=(a.contentWindow||a).document||a.ownerDocument||a;return/webkit/i.test(navigator.userAgent)||b.compatMode=='BackCompat'?b.body:b.documentElement})};$.fn.scrollTo=function(e,f,g){if(typeof f=='object'){g=f;f=0}if(typeof g=='function')g={onAfter:g};if(e=='max')e=9e9;g=$.extend({},h.defaults,g);f=f||g.duration;g.queue=g.queue&&g.axis.length>1;if(g.queue)f/=2;g.offset=both(g.offset);g.over=both(g.over);return this._scrollable().each(function(){if(e==null)return;var d=this,$elem=$(d),targ=e,toff,attr={},win=$elem.is('html,body');switch(typeof targ){case'number':case'string':if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(targ)){targ=both(targ);break}targ=$(targ,this);if(!targ.length)return;case'object':if(targ.is||targ.style)toff=(targ=$(targ)).offset()}$.each(g.axis.split(''),function(i,a){var b=a=='x'?'Left':'Top',pos=b.toLowerCase(),key='scroll'+b,old=d[key],max=h.max(d,a);if(toff){attr[key]=toff[pos]+(win?0:old-$elem.offset()[pos]);if(g.margin){attr[key]-=parseInt(targ.css('margin'+b))||0;attr[key]-=parseInt(targ.css('border'+b+'Width'))||0}attr[key]+=g.offset[pos]||0;if(g.over[pos])attr[key]+=targ[a=='x'?'width':'height']()*g.over[pos]}else{var c=targ[pos];attr[key]=c.slice&&c.slice(-1)=='%'?parseFloat(c)/100*max:c}if(g.limit&&/^\d+$/.test(attr[key]))attr[key]=attr[key]<=0?0:Math.min(attr[key],max);if(!i&&g.queue){if(old!=attr[key])animate(g.onAfterFirst);delete attr[key]}});animate(g.onAfter);function animate(a){$elem.animate(attr,f,g.easing,a&&function(){a.call(this,e,g)})}}).end()};h.max=function(a,b){var c=b=='x'?'Width':'Height',scroll='scroll'+c;if(!$(a).is('html,body'))return a[scroll]-$(a)[c.toLowerCase()]();var d='client'+c,html=a.ownerDocument.documentElement,body=a.ownerDocument.body;return Math.max(html[scroll],body[scroll])-Math.min(html[d],body[d])};function both(a){return typeof a=='object'?a:{top:a,left:a}}})(jQuery);
P.special_mentions = {
  template: null,
  hof: null,
  avg: null,
  users_7: 0,
  online_users: 0,
  user: null,
  isHidden: false,

  initEventHandlers: function() {
    $(".report_bug").unbind().click(function() {
      PEM.fire("showBugReport");
    });
    $(".special_mentions_visibility").unbind().click(function() {
      P.special_mentions.toggleStats();
    });
  },

  setUser: function(user) {
    P.special_mentions.user = user;
  },

  setHof: function(info) {
    P.special_mentions.hof = info.hof;
    P.special_mentions.avg = info.avg;
    P.special_mentions.users_7 = info.users_7;
    P.special_mentions.ensure_users_7();
    P.special_mentions.setSpecialMentions();
  },
  ensure_users_7: function() {
    var online_users = P.special_mentions.online_users;
    var users_7 = P.special_mentions.users_7;
    if (!users_7 || online_users > users_7) {
      if (PA.staticContent)
        online_users += Math.floor(10*Math.random());
      P.special_mentions.users_7 = online_users;
    }
  },
  updateOnlineUsers: function(data) {
    P.special_mentions.online_users = data.users;
    P.special_mentions.ensure_users_7();
    $("#users_online_stat").html(P.special_mentions.online_users);
    $("#users_7_stat").html(P.special_mentions.users_7);
  },
  setSpecialMentions: function() {
    var none = true;
    var contentText = "";
    var ba = null;
    var whoa = false;
    var time = 0;
    var when = null;
    if (P.special_mentions.hof && P.special_mentions.hof.best_answer && P.special_mentions.hof.best_answer.length > 0) {
      for (var i = 0; i < P.special_mentions.hof.best_answer.length && i < 1; i++) {
        ba = P.special_mentions.hof.best_answer[i];
        if (!ba || ba.time < 2) continue;
        none = false;
        if (ba.time < 60) whoa = true;
        var text = ba.text.split(' ');
        if (text.length > 4)
          contentText = text.slice(0,4).join(" ") + "...";
        else
          contentText = ba.text;
        time = showSecs(ba.time);
        if (ba.when && ba.when > 0)
          when = new Date(ba.when * 1000);
      }
    }
    var avg = "N/A";
    if (P.special_mentions.avg) {
      if (P.special_mentions.avg < 60*60*3)
        avg = showSecs(P.special_mentions.avg);
      else
        avg = ">3 hr";
    }
    var params = {
      none: none,
      ba: ba,
      whoa: whoa,
      when: when,
      time: time,
      contentText: contentText,
      online_users: P.special_mentions.online_users,
      users_7: P.special_mentions.users_7,
      avg: avg
    }
    if (P.special_mentions.isHidden) return;
    $("#special_mentions").replaceWith(P.special_mentions.template(params));
    if (P.special_mentions.user.config && P.special_mentions.user.config.hide_stats)
      P.special_mentions.hideStats();
    else
      P.special_mentions.showStats();
    P.special_mentions.initEventHandlers();
  },

  toggleStats: function() {
    if ($('#page_bottom_bar').is(':visible')) {
      P.special_mentions.hideStats();
      PA.call_pj('user.set', {stat:'hide_stats', val:'yes'}, 1);
      PA.user.config.hide_stats = 'yes';
    } else {
      P.special_mentions.showStats();
      PA.call_pj('user.unset', {stat:'hide_stats'}, 1);
      PA.user.config.hide_stats = null;
    }
  },
  hideStats: function() {
    $(".special_mentions_visibility.hide").hide();
    $('#page_bottom_bar').hide();
    $('#page_center').css("bottom", "0px");
    $(".special_mentions_visibility.show").show();
  },
  showStats: function() {
    $(".special_mentions_visibility.show").hide();
    $('#page_bottom_bar').show();
    $('#page_center').css("bottom", "74px");
    $(".special_mentions_visibility.hide").show();
  },
  hideBar: function() {
    P.special_mentions.isHidden = true;
    $('#page_bottom_bar').hide();
    $('#page_center').css("bottom", "0px");
    $(".special_mentions_visibility").hide();
  },
  showBar: function() {
    P.special_mentions.isHidden = false;
    P.special_mentions.setSpecialMentions();
  },
  init: function(module) {
    PEM.addListener("newHof", P.special_mentions.setHof);
    PEM.addListener("online_users", P.special_mentions.updateOnlineUsers);
    PEM.addListener("hideSpecialMentions", P.special_mentions.hideBar);
    PEM.addListener("showSpecialMentions", P.special_mentions.showBar);
    if (module.options.user)
      P.special_mentions.user = module.options.user;
    P.special_mentions.template = module.template;
  }
};

P.careers_nagbar = {
  shown:{},
  initEventHandlers: function(base) {

    base.find('.skip_button').click(function(){
      var test = $(this).closest('.profile_prompt_option').attr('test');
      P.careers_nagbar.profile.skip[test] = true;
      PA.call_pj("user_profile.update_profile", {set:{skip:P.careers_nagbar.profile.skip}, div_id:"nagbar_skip"}, 1);
      P.careers_nagbar.updateNagbar(P.careers_nagbar.profile);
      return false;
    });
    base.find('.next_on_click').click(function(){
      var top = $(this).closest(".nagbar_section");
      top.find('.input_with_button').show();
      top.find('.skip_button').hide();
      top.find('.next_button').show();
    });
    base.find('.next_button').click(function(){
      P.careers_nagbar.saveThis($(this));
    });
    base.find('.clone_parent_button').click(function(){
      P.careers_nagbar.cloneFunction(this);
    });
    $('.upload_resume_link').click(function(){
      $('#upload_form_file').click();
      return false;
    });
    /*
    base.find('input.save_on_click').click(function(){
      P.careers_nagbar.saveThis($(this));
    });
    base.find('input.save_on_enter').keypress(function(e) {
      if (e.which == 13) {
        P.careers_nagbar.saveThis($(this));
      }
    });
    base.find('input.yes_button').click(function(){
      var helper = $(this).closest('.profile_prompt_option').attr('helper');
      if (helper) {
        base.find('#' + helper).show();
        base.find('.profile_content_input').show();
      }
    });
    base.find('.save_and_close').click(function(){
      var top = $(this).closest('.profile_content_input_item_wrapper');
      PEM.fire("saveSection", {top:top, noShow:true});
    });
    base.find('.add_section').click(function(){
      var oldElement = $($(this).closest('.profile_content_input_item_wrapper').find('.profile_content_input_item')[0]);
      var newElement = oldElement.clone();
      newElement.find("input, textarea").each(function(){$(this).val("")});
      $(this).before(newElement);
    });
*/
  },
  cloneFunction: function(element) {
    var oldElement = $(element).parent();
    var newElement = oldElement.clone();
    newElement.find("input").each(function(){$(this).val("")});
    oldElement.find(".clone_parent_button").hide();
    oldElement.after(newElement);
    newElement.find('.clone_parent_button').click(function(){
      P.careers_nagbar.cloneFunction(this);
    });
  },
  saveThis: function(element) {
    var top = element.closest('.profile_prompt_option');
    if (top.length == 0)
      top = element.closest('.profile_content_input_item_wrapper');
    var test = top.attr('test');
    if (test == "noResumeOrLink" || test == "noMajor") {
      P.careers_nagbar.profile.skip[test] = true;
      PA.call_pj("user_profile.update_profile", {set:{skip:P.careers_nagbar.profile.skip}, div_id:"nagbar_skip"}, 1);
    }
    PEM.fire("saveSection", {top:top, noShow:true});
  },
  showNagbar: function(div) {
    if (!div && P.careers_nagbar.div) $(P.careers_nagbar.div).hide();
    P.careers_nagbar.div = div;
    if (!div) {
      $(P.careers_nagbar.div).html('');
      return;
    }
    P.modules.getData("user_profile", null, function(data){
      var pro = PEM.callFirst("loadMyProfile");
      if (pro) P.careers_nagbar.updateNagbar(pro);
    });
  },
  startUpload: function() {
    P.careers_nagbar.uploading = true;
    $.blockUI();
    $('#upload_form').submit();
  },
  onUploadComplete: function() {
    if (!P.careers_nagbar.uploading) return false;
    P.careers_nagbar.uploading = false;
    $.unblockUI();
    var content = $('#hidden-upload-frame').contents().find('body').html();
    P.careers_nagbar.profile.resume = content;
    $('.upload_resume_link').html("File uploaded.");
  },
  setProgram: function(program) {
    $('#main_program_input').val(program);
    $('#main_program').html(program);
    return false;
  },
  updateNagbar: function(profile) {
    if (P.careers_nagbar.div) {
      if (!profile.skip) profile.skip = {};
      P.careers_nagbar.profile = profile;
      profile.profileProgress10 = profile.profileProgress / 10;
      var base = $(P.careers_nagbar.div);
      base.hide();
      base.html(P.careers_nagbar.template({profile:profile}));
      P.careers_nagbar.initEventHandlers(base);
      var found = false;
      var skipped = false;
      var options = base.find(".profile_prompt_option");
      var curStep = 1;
      var optId = "";
      for (var i = 0; i < options.length; i++) {
        var opt = $(options[i]);
        var test = opt.attr("test");
        if (profile[test]) {
          if (profile.skip[test]) {
            skipped = true;
            continue;
          }
          found = true;
          curStep = i + 1;
          opt.show();
          optId = opt.attr("id");
          if (test == "noGradYear") {
            if (!profile.noProgram) {
              opt.find("#main_program").text(profile.academics.program);
            }
          }
          if (test == "noGradYearOrProgram") {
            if (!profile.noGradYear) opt.find("input[value=" + profile.academics.grad_year + "]").attr('checked', true);
            if (!profile.noProgram) {
              opt.find("#main_program").text(profile.academics.program);
            }
            opt.find('.skip_button').hide();
            opt.find('.next_button').show();
          }
          if (test == "noResumeOrLink") {
            if (profile.links.linkedin || profile.contact.website || profile.resume) {
              opt.find('.skip_button').hide();
              opt.find('.next_button').show();
            }
          }
          break;
        }
      }
      if (found) {
        base.show();
        base.find(".progress_number").html(curStep);
        base.find(".progress .bar").css("width", (curStep) * 20 + "%");
        if (optId && !P.careers_nagbar.shown[optId]) {
          var text3 = "careers";
          if (P.top_bar.isDashboard) text3 = "dashboard";
          PA.call_pj("generic.page_event", {type:"nagbar.display",text1:optId, text2:PA.user.id, text3:text3}, 1);
          P.careers_nagbar.shown[optId] = 1;
        }
      }// else {
       // if (skipped) {
       //   profile.skip = {};
       //   PA.call_pj("user_profile.update_profile", {set:{skip:P.careers_nagbar.profile.skip}}, 1);
       //   P.careers_nagbar.updateNagbar(profile);
       // }
      //}
    }
  },

  init: function(module) {
    P.careers_nagbar.template = module.template;
    if (module.options.user)
      P.careers_nagbar.user = module.options.user;
    PEM.addListener("profileChange", P.careers_nagbar.updateNagbar);
    PEM.addListener("showNagbar", P.careers_nagbar.showNagbar);
  }

};

